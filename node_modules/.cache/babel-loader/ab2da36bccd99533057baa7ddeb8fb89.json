{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { remove as e } from \"../arrayUtils.js\";\nimport { makeHandle as t } from \"../handleUtils.js\";\nimport r from \"../Logger.js\";\nimport { isSome as s } from \"../maybe.js\";\nimport { throwIfAborted as i } from \"../promiseUtils.js\";\nimport { open as o } from \"./workers.js\";\nconst h = r.getLogger(\"esri.core.workers.WorkerHandle\");\n\nclass n {\n  constructor(e, t, r, s = {}) {\n    this._mainMethod = t, this._listeners = [], this._promise = o(e, { ...s,\n      schedule: r\n    }).then(e => {\n      if (void 0 === this._thread) {\n        this._thread = e, this._promise = null, s.hasInitialize && this.broadcast({}, \"initialize\");\n\n        for (const e of this._listeners) this._connectListener(e);\n      } else e.close();\n    }), this._promise.catch(t => h.error(`Failed to initialize ${e} worker: ${t}`));\n  }\n\n  on(r, i) {\n    const o = {\n      removed: !1,\n      eventName: r,\n      callback: i,\n      threadHandle: null\n    };\n    return this._listeners.push(o), this._connectListener(o), t(() => {\n      o.removed = !0, e(this._listeners, o), this._thread && s(o.threadHandle) && o.threadHandle.remove();\n    });\n  }\n\n  destroy() {\n    this._thread && (this._thread.close(), this._thread = null), this._promise = null;\n  }\n\n  invoke(e, t) {\n    return this.invokeMethod(this._mainMethod, e, t);\n  }\n\n  invokeMethod(e, t, r) {\n    if (this._thread) {\n      const s = this.getTransferList(t, e);\n      return this._thread.invoke(e, t, {\n        transferList: s,\n        signal: r\n      });\n    }\n\n    return this._promise ? this._promise.then(() => (i(r), this.invokeMethod(e, t, r))) : Promise.reject(null);\n  }\n\n  broadcast(e, t) {\n    return this._thread ? Promise.all(this._thread.broadcast(t, e)).then(() => {}) : this._promise ? this._promise.then(() => this.broadcast(e, t)) : Promise.reject();\n  }\n\n  get promise() {\n    return this._promise;\n  }\n\n  _connectListener(e) {\n    this._thread && this._thread.on(e.eventName, e.callback).then(t => {\n      e.removed || (e.threadHandle = t);\n    });\n  }\n\n}\n\nexport { n as WorkerHandle };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/core/workers/WorkerHandle.js"],"names":["remove","e","makeHandle","t","r","isSome","s","throwIfAborted","i","open","o","h","getLogger","n","constructor","_mainMethod","_listeners","_promise","schedule","then","_thread","hasInitialize","broadcast","_connectListener","close","catch","error","on","removed","eventName","callback","threadHandle","push","destroy","invoke","invokeMethod","getTransferList","transferList","signal","Promise","reject","all","promise","WorkerHandle"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{remove as e}from\"../arrayUtils.js\";import{makeHandle as t}from\"../handleUtils.js\";import r from\"../Logger.js\";import{isSome as s}from\"../maybe.js\";import{throwIfAborted as i}from\"../promiseUtils.js\";import{open as o}from\"./workers.js\";const h=r.getLogger(\"esri.core.workers.WorkerHandle\");class n{constructor(e,t,r,s={}){this._mainMethod=t,this._listeners=[],this._promise=o(e,{...s,schedule:r}).then((e=>{if(void 0===this._thread){this._thread=e,this._promise=null,s.hasInitialize&&this.broadcast({},\"initialize\");for(const e of this._listeners)this._connectListener(e)}else e.close()})),this._promise.catch((t=>h.error(`Failed to initialize ${e} worker: ${t}`)))}on(r,i){const o={removed:!1,eventName:r,callback:i,threadHandle:null};return this._listeners.push(o),this._connectListener(o),t((()=>{o.removed=!0,e(this._listeners,o),this._thread&&s(o.threadHandle)&&o.threadHandle.remove()}))}destroy(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null}invoke(e,t){return this.invokeMethod(this._mainMethod,e,t)}invokeMethod(e,t,r){if(this._thread){const s=this.getTransferList(t,e);return this._thread.invoke(e,t,{transferList:s,signal:r})}return this._promise?this._promise.then((()=>(i(r),this.invokeMethod(e,t,r)))):Promise.reject(null)}broadcast(e,t){return this._thread?Promise.all(this._thread.broadcast(t,e)).then((()=>{})):this._promise?this._promise.then((()=>this.broadcast(e,t))):Promise.reject()}get promise(){return this._promise}_connectListener(e){this._thread&&this._thread.on(e.eventName,e.callback).then((t=>{e.removed||(e.threadHandle=t)}))}}export{n as WorkerHandle};\n"]},"metadata":{},"sourceType":"module"}