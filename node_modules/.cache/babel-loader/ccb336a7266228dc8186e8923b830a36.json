{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../chunks/tslib.es6.js\";\nimport t from \"../../../../core/Error.js\";\nimport o from \"../../../../core/Logger.js\";\nimport { isSome as r, isNone as s } from \"../../../../core/maybe.js\";\nimport { after as n, createResolver as c } from \"../../../../core/promiseUtils.js\";\nimport { property as i } from \"../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../core/has.js\";\nimport \"../../../../core/accessorSupport/ensureType.js\";\nimport { subclass as a } from \"../../../../core/accessorSupport/decorators/subclass.js\";\nimport l from \"./StreamConnection.js\";\nimport { getGeometryZScaler as d } from \"../../../../rest/query/operations/zscale.js\";\nconst h = o.getLogger(\"esri.layers.graphics.sources.connections.WebSocketConnection\");\nvar p;\n!function (e) {\n  e[e.CONNECTING = 0] = \"CONNECTING\", e[e.OPEN = 1] = \"OPEN\", e[e.CLOSING = 2] = \"CLOSING\", e[e.CLOSED = 3] = \"CLOSED\";\n}(p || (p = {}));\nlet u = class extends l {\n  constructor(e) {\n    super(), this.errorString = null;\n    const {\n      geometryType: t,\n      spatialReference: o,\n      sourceSpatialReference: r\n    } = e;\n    this._config = e, this._featureZScaler = d(t, r, o), this._open();\n  }\n\n  async _open() {\n    await this._tryCreateWebSocket(), this.destroyed || (await this._handshake());\n  }\n\n  destroy() {\n    r(this._websocket) && (this._websocket.onopen = null, this._websocket.onclose = null, this._websocket.onerror = null, this._websocket.onmessage = null, this._websocket.close()), this._websocket = null;\n  }\n\n  get connectionStatus() {\n    if (s(this._websocket)) return \"disconnected\";\n\n    switch (this._websocket.readyState) {\n      case p.CONNECTING:\n      case p.OPEN:\n        return \"connected\";\n\n      case p.CLOSING:\n      case p.CLOSED:\n        return \"disconnected\";\n    }\n  }\n\n  async _tryCreateWebSocket(e = this._config.source.path, o = 1e3, r = 0) {\n    try {\n      if (this.destroyed) return;\n      this._websocket = await this._createWebSocket(e), this.notifyChange(\"connectionStatus\");\n    } catch (s) {\n      const c = o / 1e3;\n      return this._config.maxReconnectionAttempts && r >= this._config.maxReconnectionAttempts ? (h.error(new t(\"websocket-connection\", \"Exceeded maxReconnectionAttempts attempts. No further attempts will be made\")), void this.destroy()) : (h.error(new t(\"websocket-connection\", `Failed to connect. Attempting to reconnect in ${c}s`, s)), await n(o), this._tryCreateWebSocket(e, Math.min(1.5 * o, 1e3 * this._config.maxReconnectionInterval), r + 1));\n    }\n  }\n\n  _createWebSocket(e) {\n    const t = new WebSocket(e),\n          o = new Promise((e, o) => {\n      t.onopen = () => e(t), t.onclose = e => o(e);\n    });\n    return o.then(() => {\n      if (this.destroyed) return t.onclose = () => {}, void t.close();\n      t.onclose = e => this._onClose(e), t.onerror = e => this._onError(e), t.onmessage = e => this._onMessage(e);\n    }), o;\n  }\n\n  async _handshake(e = 1e4) {\n    const o = this._websocket;\n    if (s(o)) return;\n    const r = c(),\n          n = o.onmessage,\n          {\n      filter: i,\n      outFields: a,\n      spatialReference: l\n    } = this._config;\n    return r.timeout(e), o.onmessage = e => {\n      var s;\n      let c = null;\n\n      try {\n        c = JSON.parse(e.data);\n      } catch (d) {}\n\n      c && \"object\" == typeof c || (h.error(new t(\"websocket-connection\", \"Protocol violation. Handshake failed - malformed message\", e.data)), r.reject(), this.destroy()), (null == (s = c.spatialReference) ? void 0 : s.wkid) !== (null == l ? void 0 : l.wkid) && (h.error(new t(\"websocket-connection\", `Protocol violation. Handshake failed - expected wkid of ${l.wkid}`, e.data)), r.reject(), this.destroy()), \"json\" !== c.format && (h.error(new t(\"websocket-connection\", \"Protocol violation. Handshake failed - format is not set\", e.data)), r.reject(), this.destroy()), i && c.filter !== i && h.error(new t(\"websocket-connection\", \"Tried to set filter, but server doesn't support it\")), a && c.outFields !== a && h.error(new t(\"websocket-connection\", \"Tried to set outFields, but server doesn't support it\")), o.onmessage = n, r.resolve();\n    }, o.send(JSON.stringify({\n      filter: i,\n      outFields: a,\n      format: \"json\",\n      spatialReference: {\n        wkid: l.wkid\n      }\n    })), r.promise;\n  }\n\n  _onMessage(e) {\n    try {\n      const o = JSON.parse(e.data);\n      if (\"featureResult\" !== o.type) throw new t(\"websocket-connection\", \"Protocol violation - Expected to find message of type 'featureResult'\", o);\n\n      for (const e of o.features) this._featureZScaler && this._featureZScaler(e.geometry), this.onFeature(e);\n    } catch (o) {\n      return h.error(new t(\"websocket-connection\", \"Failed to parse message\", o)), void this.destroy();\n    }\n  }\n\n  _onError(e) {\n    const t = \"Encountered an error over WebSocket connection\";\n    this._set(\"errorString\", t), h.error(\"websocket-connection\", t);\n  }\n\n  _onClose(e) {\n    this._websocket = null, this.notifyChange(\"connectionStatus\"), 1e3 !== e.code && h.error(\"websocket-connection\", `WebSocket closed unexpectedly with error code ${e.code}`), this.destroyed || this._open();\n  }\n\n};\ne([i()], u.prototype, \"connectionStatus\", null), e([i()], u.prototype, \"errorString\", void 0), u = e([a(\"esri.layers.graphics.sources.connections.WebSocketConnection\")], u);\nexport { p as ReadyState, u as WebSocketConnection };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/layers/graphics/sources/connections/WebSocketConnection.js"],"names":["_","e","t","o","isSome","r","isNone","s","after","n","createResolver","c","property","i","subclass","a","l","getGeometryZScaler","d","h","getLogger","p","CONNECTING","OPEN","CLOSING","CLOSED","u","constructor","errorString","geometryType","spatialReference","sourceSpatialReference","_config","_featureZScaler","_open","_tryCreateWebSocket","destroyed","_handshake","destroy","_websocket","onopen","onclose","onerror","onmessage","close","connectionStatus","readyState","source","path","_createWebSocket","notifyChange","maxReconnectionAttempts","error","Math","min","maxReconnectionInterval","WebSocket","Promise","then","_onClose","_onError","_onMessage","filter","outFields","timeout","JSON","parse","data","reject","wkid","format","resolve","send","stringify","promise","type","features","geometry","onFeature","_set","code","prototype","ReadyState","WebSocketConnection"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../chunks/tslib.es6.js\";import t from\"../../../../core/Error.js\";import o from\"../../../../core/Logger.js\";import{isSome as r,isNone as s}from\"../../../../core/maybe.js\";import{after as n,createResolver as c}from\"../../../../core/promiseUtils.js\";import{property as i}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/ensureType.js\";import{subclass as a}from\"../../../../core/accessorSupport/decorators/subclass.js\";import l from\"./StreamConnection.js\";import{getGeometryZScaler as d}from\"../../../../rest/query/operations/zscale.js\";const h=o.getLogger(\"esri.layers.graphics.sources.connections.WebSocketConnection\");var p;!function(e){e[e.CONNECTING=0]=\"CONNECTING\",e[e.OPEN=1]=\"OPEN\",e[e.CLOSING=2]=\"CLOSING\",e[e.CLOSED=3]=\"CLOSED\"}(p||(p={}));let u=class extends l{constructor(e){super(),this.errorString=null;const{geometryType:t,spatialReference:o,sourceSpatialReference:r}=e;this._config=e,this._featureZScaler=d(t,r,o),this._open()}async _open(){await this._tryCreateWebSocket(),this.destroyed||await this._handshake()}destroy(){r(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(s(this._websocket))return\"disconnected\";switch(this._websocket.readyState){case p.CONNECTING:case p.OPEN:return\"connected\";case p.CLOSING:case p.CLOSED:return\"disconnected\"}}async _tryCreateWebSocket(e=this._config.source.path,o=1e3,r=0){try{if(this.destroyed)return;this._websocket=await this._createWebSocket(e),this.notifyChange(\"connectionStatus\")}catch(s){const c=o/1e3;return this._config.maxReconnectionAttempts&&r>=this._config.maxReconnectionAttempts?(h.error(new t(\"websocket-connection\",\"Exceeded maxReconnectionAttempts attempts. No further attempts will be made\")),void this.destroy()):(h.error(new t(\"websocket-connection\",`Failed to connect. Attempting to reconnect in ${c}s`,s)),await n(o),this._tryCreateWebSocket(e,Math.min(1.5*o,1e3*this._config.maxReconnectionInterval),r+1))}}_createWebSocket(e){const t=new WebSocket(e),o=new Promise(((e,o)=>{t.onopen=()=>e(t),t.onclose=e=>o(e)}));return o.then((()=>{if(this.destroyed)return t.onclose=()=>{},void t.close();t.onclose=e=>this._onClose(e),t.onerror=e=>this._onError(e),t.onmessage=e=>this._onMessage(e)})),o}async _handshake(e=1e4){const o=this._websocket;if(s(o))return;const r=c(),n=o.onmessage,{filter:i,outFields:a,spatialReference:l}=this._config;return r.timeout(e),o.onmessage=e=>{var s;let c=null;try{c=JSON.parse(e.data)}catch(d){}c&&\"object\"==typeof c||(h.error(new t(\"websocket-connection\",\"Protocol violation. Handshake failed - malformed message\",e.data)),r.reject(),this.destroy()),(null==(s=c.spatialReference)?void 0:s.wkid)!==(null==l?void 0:l.wkid)&&(h.error(new t(\"websocket-connection\",`Protocol violation. Handshake failed - expected wkid of ${l.wkid}`,e.data)),r.reject(),this.destroy()),\"json\"!==c.format&&(h.error(new t(\"websocket-connection\",\"Protocol violation. Handshake failed - format is not set\",e.data)),r.reject(),this.destroy()),i&&c.filter!==i&&h.error(new t(\"websocket-connection\",\"Tried to set filter, but server doesn't support it\")),a&&c.outFields!==a&&h.error(new t(\"websocket-connection\",\"Tried to set outFields, but server doesn't support it\")),o.onmessage=n,r.resolve()},o.send(JSON.stringify({filter:i,outFields:a,format:\"json\",spatialReference:{wkid:l.wkid}})),r.promise}_onMessage(e){try{const o=JSON.parse(e.data);if(\"featureResult\"!==o.type)throw new t(\"websocket-connection\",\"Protocol violation - Expected to find message of type 'featureResult'\",o);for(const e of o.features)this._featureZScaler&&this._featureZScaler(e.geometry),this.onFeature(e)}catch(o){return h.error(new t(\"websocket-connection\",\"Failed to parse message\",o)),void this.destroy()}}_onError(e){const t=\"Encountered an error over WebSocket connection\";this._set(\"errorString\",t),h.error(\"websocket-connection\",t)}_onClose(e){this._websocket=null,this.notifyChange(\"connectionStatus\"),1e3!==e.code&&h.error(\"websocket-connection\",`WebSocket closed unexpectedly with error code ${e.code}`),this.destroyed||this._open()}};e([i()],u.prototype,\"connectionStatus\",null),e([i()],u.prototype,\"errorString\",void 0),u=e([a(\"esri.layers.graphics.sources.connections.WebSocketConnection\")],u);export{p as ReadyState,u as WebSocketConnection};\n"]},"metadata":{},"sourceType":"module"}