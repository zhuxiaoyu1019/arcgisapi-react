{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../request.js\";\nimport t from \"../core/Logger.js\";\nimport { clamp as s } from \"../core/mathUtils.js\";\nimport { isAbortError as i, createAbortController as r } from \"../core/promiseUtils.js\";\nimport { init as n } from \"../core/watchUtils.js\";\nimport { w as a, n as l, i as o, s as h, a as d, d as c, b as _ } from \"../chunks/vec3.js\";\nimport { c as u } from \"../chunks/vec3f64.js\";\nimport { loadVoxelWASM as g } from \"../libs/vxl/VxlModule.js\";\nimport { IntersectorResult as x } from \"../views/3d/webgl-engine/lib/intersectorUtils.js\";\nconst v = t.getLogger(\" esri.layers.VoxelWasmPerScene\");\n\nclass p {\n  constructor(e) {\n    this._useDepthPass = !1, this._havePreparedWithAllLayers = !1, this._renderPluginContext = null, this._vxl = null, this._pluginIsActive = !1, this._moreToLoad = !1, this._viewportWidth = -1, this._viewportHeight = -1, this._newLayers = [], this._layers = new Map(), this._renderPass = 0, this._renderSlot = 4, this._rctx = null, this._renderTargetToRestore = null, this._dbgFlags = new Set(), this._dbgFlags.add(4), this._view = e, this.initialize();\n  }\n\n  get canRender() {\n    return !!this._vxl && \"local\" === this._view.viewingMode;\n  }\n\n  dbg(e, t) {\n    this._dbgFlags.has(e) && (4 === e ? v.error(t) : v.warn(t));\n  }\n\n  removeRenderPlugin() {\n    this._pluginIsActive && this._view._stage && (this.dbg(1, \"--removeRenderPlugin--\"), this._view._stage.removeRenderPlugin(this)), this._pluginIsActive = !1;\n  }\n\n  initialize() {\n    this.dbg(1, \"--initialize--\"), this._readyWatchHandle = n(this._view, \"ready\", e => {\n      e && \"local\" === this._view.viewingMode ? (this.dbg(1, \"view ready status changed to ready on a local view, calling addRenderPlugin\"), this._view._stage.addRenderPlugin([this._renderSlot], this), this._pluginIsActive = !0) : (this.dbg(1, \"view ready status changed, not ready or not a local view!\"), this.removeRenderPlugin());\n    }), this._qualityWatchHandle = n(this._view, \"qualityProfile\", e => {\n      this.dbg(3, \"qualityProfile changed to \" + e), this._vxl && this._vxl.set_quality(this.toWasmQuality(e));\n    });\n  }\n\n  initializeRenderContext(e) {\n    this.dbg(1, \"--initializeRenderContext--\");\n    const t = e.renderContext.rctx;\n    \"webgl2\" === t.webglVersion ? (this._renderPluginContext = e, this._rctx = e.renderContext.rctx, this.initializeWasm(t.gl)) : this.dbg(4, \"WebGL 1 context only!\");\n  }\n\n  uninitializeRenderContext() {\n    this._renderPluginContext = null, this._rctx = null, this.dbg(1, \"--uninitializeRenderContext--\");\n  }\n\n  restoreFramebuffer() {\n    if (!this._renderTargetToRestore) return;\n    const e = this._renderTargetToRestore.fbo;\n    if (!!!this._rctx) return void this.dbg(4, \"no context in restoreFramebuffer!\");\n\n    this._rctx.bindFramebuffer(e, !0);\n\n    const t = this._renderTargetToRestore.viewport;\n\n    this._rctx.setViewport(t.x, t.y, t.width, t.height);\n  }\n\n  bindPreviousDepthToSlot(e, t) {\n    const s = !!this._rctx,\n          i = !!this._renderTargetToRestore;\n    if (!s || !i) return 0;\n    const r = this._renderTargetToRestore.fbo.depthStencilTexture;\n    return r ? (0 === t ? this._rctx.bindTexture(null, e, !0) : this._rctx.bindTexture(r, e, !0), 1) : (this.dbg(4, \"no depth/stencil texture exists!\"), 0);\n  }\n\n  setBlendState(e, t, s, i) {\n    this._rctx ? (this._rctx.setBlendingEnabled(1 === e), this._rctx.setBlendFunction(t, s), this._rctx.setBlendEquation(i)) : this.dbg(4, \"setBlendState callback has no rendering context!\");\n  }\n\n  setFrontFace(e) {\n    this._rctx ? this._rctx.setFrontFace(e) : this.dbg(4, \"setFrontFace callback has no rendering context!\");\n  }\n\n  setDepthStencilStateFunction(e, t, s) {\n    this._rctx ? (this._rctx.setDepthFunction(s), this._rctx.setDepthTestEnabled(1 === e), this._rctx.setDepthWriteEnabled(1 === t), this._rctx.setStencilTestEnabled(!1), this._rctx.setStencilFunction(519, 0, 255), this._rctx.setStencilOpSeparate(1028, 7680, 7682, 7680), this._rctx.setStencilOpSeparate(1029, 7680, 7683, 7680)) : this.dbg(4, \"setDepthStencilStateFunction callback has no rendering context!\");\n  }\n\n  setRasterizerState(e) {\n    if (this._rctx) switch (e) {\n      case 1:\n        this._rctx.setFaceCullingEnabled(!1);\n\n        break;\n\n      case 3:\n        this._rctx.setCullFace(1029), this._rctx.setFaceCullingEnabled(!0);\n        break;\n\n      case 2:\n        this._rctx.setCullFace(1028), this._rctx.setFaceCullingEnabled(!0);\n    } else this.dbg(4, \"setRasterizerState callback has no rendering context!\");\n  }\n\n  setViewport(e, t, s, i) {\n    this._rctx ? this._rctx.setViewport(e, t, s, i) : this.dbg(4, \"setViewport callback has no rendering context!\");\n  }\n\n  syncRequestsResponses() {\n    this._layers.forEach((t, s) => {\n      const r = [];\n      t.responses.forEach((e, t) => {\n        r.push(t), this.dbg(2, \"responding for requestID:\" + t + \" size:\" + e.size), this._vxl.respond(s, t, e);\n      });\n      const n = t.responses;\n\n      for (const e of r) n.delete(e);\n\n      const a = this._vxl.get_new_requests(s),\n            l = t.abortController.signal;\n\n      for (const o in a) {\n        t.outstandingRequestCount += 1, 1 === t.outstandingRequestCount && t.layerView.updatingFlagChanged();\n        const s = a[o],\n              r = {\n          responseType: \"array-buffer\",\n          signal: l\n        };\n        this.dbg(2, \"making requestID:\" + o + \" url:\" + s.url), e(s.url, r).then(e => {\n          t.outstandingRequestCount -= 1, 0 === t.outstandingRequestCount && t.layerView.updatingFlagChanged(), this.dbg(2, \"have response for requestID:\" + o);\n          let i = 0;\n\n          if (e.data.byteLength > 0) {\n            i = this._vxl._malloc(e.data.byteLength);\n            const t = new Uint8Array(this._vxl.HEAPU8.buffer, i, e.data.byteLength),\n                  s = new Uint8Array(e.data);\n\n            for (let i = 0; i < e.data.byteLength; ++i) t[i] = s[i];\n          }\n\n          n.set(+o, {\n            type: s.type,\n            ptr: i,\n            size: e.data.byteLength,\n            success: !0\n          });\n        }).catch(e => {\n          t.outstandingRequestCount -= 1, 0 === t.outstandingRequestCount && t.layerView.updatingFlagChanged(), i(e) || (this.dbg(4, \"requestID:\" + o + \" failed\"), n.set(+o, {\n            type: s.type,\n            ptr: 0,\n            size: 0,\n            success: !1\n          }));\n        });\n      }\n    });\n  }\n\n  updateWasmCamera(e) {\n    this._vxl.set_projection_matrix.apply(this._vxl, e.projectionMatrix), this._vxl.set_view_matrix.apply(this._vxl, e.viewMatrix), this._vxl.set_near_far(e.near, e.far);\n  }\n\n  isUpdating(e) {\n    return !(this._vxl || !this._vxlPromise) || !!this._layers.has(e) && this._layers.get(e).outstandingRequestCount > 0;\n  }\n\n  setEnabled(e, t) {\n    this._layers.forEach((s, i) => {\n      s.layerView === e && (this._vxl.set_enabled(i, t ? 1 : 0), this._renderPluginContext.requestRender());\n    });\n  }\n\n  addVoxelLayer(e) {\n    if (!this._vxl) {\n      const t = {\n        layerView: e,\n        resolveCallback: \"\",\n        rejectCallback: \"\"\n      },\n            s = new Promise((e, s) => {\n        t.resolveCallback = e, t.rejectCallback = s;\n      });\n      return this._newLayers.push(t), s;\n    }\n\n    const t = this._addVoxelLayer(e);\n\n    return t < 0 ? Promise.reject(-1) : Promise.resolve(t);\n  }\n\n  removeVoxelLayer(e) {\n    if (!this._vxl) {\n      const t = this._newLayers.findIndex(t => e === t.layerView);\n\n      t >= 0 && (this._newLayers[t].resolveCallback(-1), this._newLayers.splice(t, 1));\n      const s = this._newLayers.length;\n      return 0 === s && (this.dbg(1, \" no voxel layers left after removing a layer, removing RenderPlugin and destroying\"), this.destroy()), s;\n    }\n\n    let t = -1;\n    this._layers.forEach((s, i) => {\n      s.layerView === e && (t = i, s.abortController.abort(), this._vxl.remove_layer(t));\n    }), t >= 0 && this._layers.delete(t);\n    const s = this._layers.size;\n    return 0 === s && (this.dbg(1, \" no voxel layers left after removing a layer, removing RenderPlugin and destroying\"), this.destroy()), s;\n  }\n\n  _addVoxelLayer(e) {\n    const t = e.layer;\n    let s = -1;\n    const i = t.layerData;\n\n    if (i && i.data.byteLength > 0) {\n      const e = this._vxl._malloc(i.data.byteLength),\n            r = new Uint8Array(this._vxl.HEAPU8.buffer, e, i.data.byteLength),\n            n = new Uint8Array(i.data);\n\n      for (let t = 0; t < i.data.byteLength; ++t) r[t] = n[t];\n\n      const a = 32662 === this._view.spatialReference.wkid && t.spatialReference.isWGS84 ? 111319.49079327357 : 1;\n      s = this._vxl.add_layer(t.serviceRoot, e, i.data.byteLength, a, a), this._vxl._free(e);\n    }\n\n    if (s >= 0) {\n      const t = r();\n      return this._layers.set(s, {\n        layerView: e,\n        responses: new Map(),\n        outstandingRequestCount: 0,\n        abortController: t\n      }), s;\n    }\n\n    return -1;\n  }\n\n  prepareRender(e) {\n    if (!this._vxl) return;\n    const t = e.viewForward,\n          s = e.eye;\n\n    this._vxl.update_camera_pos_and_direction(s[0], s[1], s[2], t[0], t[1], t[2]);\n\n    const i = this._vxl.cull();\n\n    this.dbg(2, \"missingResourceCount=\" + i), this._moreToLoad = i > 0, this._havePreparedWithAllLayers = 0 === this._newLayers.length;\n  }\n\n  render(e) {\n    if (!this._vxl) return !1;\n\n    for (const s of this._newLayers) {\n      const e = this._addVoxelLayer(s.layerView);\n\n      -1 === e ? s.rejectCallback(-1) : s.resolveCallback(e);\n    }\n\n    if (this._newLayers = [], e.pass !== this._renderPass) return !1;\n    if (e.slot !== this._renderSlot) return !1;\n    if (0 === this._layers.size) return this.dbg(4, \"No voxel layers but RenderPlugin instance is being asked to render!\"), !0;\n    this._renderTargetToRestore = {\n      fbo: this._rctx.getBoundFramebufferObject(),\n      viewport: this._rctx.getViewport()\n    }, this.syncRequestsResponses(), this._vxl.begin_frame();\n    const t = this._renderTargetToRestore.viewport;\n    return t.width === this._viewportWidth && t.height === this._viewportHeight || (this._viewportWidth = t.width, this._viewportHeight = t.height, this._vxl.set_viewport(t.width, t.height)), 0 === t.x && 0 === t.y || this.dbg(4, \"Unsupported viewport parameters detected!\"), this.updateWasmCamera(e.camera), this._vxl.draw(), this._renderTargetToRestore.fbo = null, e.rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(), this._vxl.get_active_texture_unit()), e.rctx.externalVertexArrayObjectUpdate(), e.rctx.externalVertexBufferUpdate(), (this._moreToLoad || !this._havePreparedWithAllLayers && this._layers.size > 0) && this._renderPluginContext.requestRender(), !0;\n  }\n\n  queryDepthRange(e) {\n    this.dbg(1, \"--queryDepthRange--\");\n    const t = e.viewForward,\n          s = e.eye;\n    this._vxl.update_camera_pos_and_direction(s[0], s[1], s[2], t[0], t[1], t[2]), this._vxl.cull();\n    const i = {\n      near: 5,\n      far: 1e4\n    };\n    return i.near = this._vxl.get_near(), i.far = this._vxl.get_far(), i;\n  }\n\n  destroy() {\n    this.dbg(1, \"--destroy--\"), this.removeRenderPlugin(), this._readyWatchHandle && (this._readyWatchHandle.remove(), this._readyWatchHandle = null), this._qualityWatchHandle && (this._qualityWatchHandle.remove(), this._qualityWatchHandle = null), this._vxl && (this._vxl.uninitialize_voxel_wasm(), this._vxl = null);\n  }\n\n  initializeWasm(e) {\n    return this._vxl ? Promise.resolve() : (this._vxlPromise || (this._vxlPromise = g(e).then(e => {\n      if (this._vxl = e, this._vxlPromise = null, this._newLayers.length <= 0) return this.dbg(1, \" no voxel layers left after WASM downloaded, removing RenderPlugin and destroying\"), void this.destroy();\n\n      const t = this._vxl.addFunction(this.restoreFramebuffer.bind(this), \"v\"),\n            s = this._vxl.addFunction(this.setBlendState.bind(this), \"viiii\"),\n            i = this._vxl.addFunction(this.setFrontFace.bind(this), \"vi\"),\n            r = this._vxl.addFunction(this.setRasterizerState.bind(this), \"vi\"),\n            n = this._vxl.addFunction(this.setDepthStencilStateFunction.bind(this), \"viii\"),\n            a = this._vxl.addFunction(this.setViewport.bind(this), \"viiii\"),\n            l = this._vxl.addFunction(this.bindPreviousDepthToSlot.bind(this), \"iii\");\n\n      this._vxl.initialize_voxel_wasm(t, s, i, r, n, a, l), this._vxl.set_quality(this.toWasmQuality(this._view.qualityProfile)), this._renderPluginContext && this._renderPluginContext.requestRender();\n    }).catch(() => {\n      for (const e of this._newLayers) e.rejectCallback(-2);\n\n      this.dbg(4, \" WASM failed to download, removing RenderPlugin and destroying\"), this.destroy();\n    })), this._vxlPromise);\n  }\n\n  get type() {\n    return \"external\";\n  }\n\n  get isGround() {\n    return !1;\n  }\n\n  get slicePlane() {\n    return !1;\n  }\n\n  get intersectionHandlerId() {\n    return \"unj\";\n  }\n\n  intersect(e, t, s, i, r) {\n    if (!this._vxl) return;\n    if (!this._rctx) return;\n    if (0 === this._layers.size) return;\n    if (r[0] < 0 || r[0] > e.camera.viewport[2] || r[1] < 0 || r[1] > e.camera.viewport[3]) return;\n    this._renderTargetToRestore = {\n      fbo: this._rctx.getBoundFramebufferObject(),\n      viewport: this._rctx.getViewport()\n    };\n    const n = e.camera.viewForward,\n          a = e.camera.eye;\n    this._vxl.update_camera_pos_and_direction(a[0], a[1], a[2], n[0], n[1], n[2]), this.updateWasmCamera(e.camera), this._vxl.begin_frame(), this._useDepthPass ? this.intersectDepth(e, t, s, i, r) : this.intersectObject(e, t, s, i, r), this._renderTargetToRestore.fbo = null, this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(), this._vxl.get_active_texture_unit()), this._rctx.externalVertexArrayObjectUpdate(), this._rctx.externalVertexBufferUpdate();\n  }\n\n  intersectObject(e, t, i, r, n) {\n    const g = this._vxl.pick_object(n[0], n[1]);\n\n    if (g.success) {\n      const n = u();\n      a(n, r, i), l(n, n);\n      const v = o(i, r),\n            p = u();\n      h(p, g.worldX, g.worldY, g.worldZ);\n      const y = u();\n      a(y, p, i);\n      const b = u();\n      d(b, n, c(y, n));\n      const w = u();\n\n      _(w, i, b);\n\n      const f = o(i, w),\n            m = s(f / v, 0, 1),\n            R = e => {\n        e.intersector = \"Voxel\", e.dist = m, e.target = {\n          type: \"external\",\n          metadata: {\n            layerUid: this.intersectionHandlerId\n          }\n        };\n      },\n            C = e.results.min;\n\n      (null == C.dist || m < C.dist) && (null == t || t(i, r, m)) && R(C);\n      const P = e.results.max;\n\n      if (0 !== e.options.store && (null == P.dist || m > P.dist) && (null == t || t(i, r, m)) && R(P), 2 === e.options.store) {\n        const t = new x(e.ray);\n        R(t), e.results.all.push(t);\n      }\n    }\n  }\n\n  intersectDepth(e, t, i, r, n) {\n    const g = this._vxl.pick_depth(n[0], n[1]);\n\n    if (g.success) {\n      const n = u();\n      a(n, r, i), l(n, n);\n      const v = o(i, r),\n            p = u();\n      h(p, g.worldX, g.worldY, g.worldZ);\n      const y = u();\n      a(y, p, i);\n      const b = u();\n      d(b, n, c(y, n));\n      const w = u();\n\n      _(w, i, b);\n\n      const f = o(i, w),\n            m = s(f / v, 0, 1),\n            R = e => {\n        e.intersector = \"Voxel\", e.dist = m, e.target = {\n          type: \"external\",\n          metadata: {\n            layerUid: this.intersectionHandlerId\n          }\n        };\n      },\n            C = e.results.min;\n\n      (null == C.dist || m < C.dist) && (null == t || t(i, r, m)) && R(C);\n      const P = e.results.max;\n\n      if (0 !== e.options.store && (null == P.dist || m > P.dist) && (null == t || t(i, r, m)) && R(P), 2 === e.options.store) {\n        const t = new x(e.ray);\n        R(t), e.results.all.push(t);\n      }\n    }\n  }\n\n  toWasmQuality(e) {\n    switch (e) {\n      case \"low\":\n        return 0;\n\n      case \"medium\":\n        return 1;\n\n      case \"high\":\n        return 2;\n    }\n  }\n\n}\n\nexport default p;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/layers/VoxelWasmPerScene.js"],"names":["e","t","clamp","s","isAbortError","i","createAbortController","r","init","n","w","a","l","o","h","d","c","b","_","u","loadVoxelWASM","g","IntersectorResult","x","v","getLogger","p","constructor","_useDepthPass","_havePreparedWithAllLayers","_renderPluginContext","_vxl","_pluginIsActive","_moreToLoad","_viewportWidth","_viewportHeight","_newLayers","_layers","Map","_renderPass","_renderSlot","_rctx","_renderTargetToRestore","_dbgFlags","Set","add","_view","initialize","canRender","viewingMode","dbg","has","error","warn","removeRenderPlugin","_stage","_readyWatchHandle","addRenderPlugin","_qualityWatchHandle","set_quality","toWasmQuality","initializeRenderContext","renderContext","rctx","webglVersion","initializeWasm","gl","uninitializeRenderContext","restoreFramebuffer","fbo","bindFramebuffer","viewport","setViewport","y","width","height","bindPreviousDepthToSlot","depthStencilTexture","bindTexture","setBlendState","setBlendingEnabled","setBlendFunction","setBlendEquation","setFrontFace","setDepthStencilStateFunction","setDepthFunction","setDepthTestEnabled","setDepthWriteEnabled","setStencilTestEnabled","setStencilFunction","setStencilOpSeparate","setRasterizerState","setFaceCullingEnabled","setCullFace","syncRequestsResponses","forEach","responses","push","size","respond","delete","get_new_requests","abortController","signal","outstandingRequestCount","layerView","updatingFlagChanged","responseType","url","then","data","byteLength","_malloc","Uint8Array","HEAPU8","buffer","set","type","ptr","success","catch","updateWasmCamera","set_projection_matrix","apply","projectionMatrix","set_view_matrix","viewMatrix","set_near_far","near","far","isUpdating","_vxlPromise","get","setEnabled","set_enabled","requestRender","addVoxelLayer","resolveCallback","rejectCallback","Promise","_addVoxelLayer","reject","resolve","removeVoxelLayer","findIndex","splice","length","destroy","abort","remove_layer","layer","layerData","spatialReference","wkid","isWGS84","add_layer","serviceRoot","_free","prepareRender","viewForward","eye","update_camera_pos_and_direction","cull","render","pass","slot","getBoundFramebufferObject","getViewport","begin_frame","set_viewport","camera","draw","externalTextureUnitUpdate","get_texture_units_bound_in_frame","get_active_texture_unit","externalVertexArrayObjectUpdate","externalVertexBufferUpdate","queryDepthRange","get_near","get_far","remove","uninitialize_voxel_wasm","addFunction","bind","initialize_voxel_wasm","qualityProfile","isGround","slicePlane","intersectionHandlerId","intersect","intersectDepth","intersectObject","pick_object","worldX","worldY","worldZ","f","m","R","intersector","dist","target","metadata","layerUid","C","results","min","P","max","options","store","ray","all","pick_depth"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../request.js\";import t from\"../core/Logger.js\";import{clamp as s}from\"../core/mathUtils.js\";import{isAbortError as i,createAbortController as r}from\"../core/promiseUtils.js\";import{init as n}from\"../core/watchUtils.js\";import{w as a,n as l,i as o,s as h,a as d,d as c,b as _}from\"../chunks/vec3.js\";import{c as u}from\"../chunks/vec3f64.js\";import{loadVoxelWASM as g}from\"../libs/vxl/VxlModule.js\";import{IntersectorResult as x}from\"../views/3d/webgl-engine/lib/intersectorUtils.js\";const v=t.getLogger(\" esri.layers.VoxelWasmPerScene\");class p{constructor(e){this._useDepthPass=!1,this._havePreparedWithAllLayers=!1,this._renderPluginContext=null,this._vxl=null,this._pluginIsActive=!1,this._moreToLoad=!1,this._viewportWidth=-1,this._viewportHeight=-1,this._newLayers=[],this._layers=new Map,this._renderPass=0,this._renderSlot=4,this._rctx=null,this._renderTargetToRestore=null,this._dbgFlags=new Set,this._dbgFlags.add(4),this._view=e,this.initialize()}get canRender(){return!!this._vxl&&\"local\"===this._view.viewingMode}dbg(e,t){this._dbgFlags.has(e)&&(4===e?v.error(t):v.warn(t))}removeRenderPlugin(){this._pluginIsActive&&this._view._stage&&(this.dbg(1,\"--removeRenderPlugin--\"),this._view._stage.removeRenderPlugin(this)),this._pluginIsActive=!1}initialize(){this.dbg(1,\"--initialize--\"),this._readyWatchHandle=n(this._view,\"ready\",(e=>{e&&\"local\"===this._view.viewingMode?(this.dbg(1,\"view ready status changed to ready on a local view, calling addRenderPlugin\"),this._view._stage.addRenderPlugin([this._renderSlot],this),this._pluginIsActive=!0):(this.dbg(1,\"view ready status changed, not ready or not a local view!\"),this.removeRenderPlugin())})),this._qualityWatchHandle=n(this._view,\"qualityProfile\",(e=>{this.dbg(3,\"qualityProfile changed to \"+e),this._vxl&&this._vxl.set_quality(this.toWasmQuality(e))}))}initializeRenderContext(e){this.dbg(1,\"--initializeRenderContext--\");const t=e.renderContext.rctx;\"webgl2\"===t.webglVersion?(this._renderPluginContext=e,this._rctx=e.renderContext.rctx,this.initializeWasm(t.gl)):this.dbg(4,\"WebGL 1 context only!\")}uninitializeRenderContext(){this._renderPluginContext=null,this._rctx=null,this.dbg(1,\"--uninitializeRenderContext--\")}restoreFramebuffer(){if(!this._renderTargetToRestore)return;const e=this._renderTargetToRestore.fbo;if(!!!this._rctx)return void this.dbg(4,\"no context in restoreFramebuffer!\");this._rctx.bindFramebuffer(e,!0);const t=this._renderTargetToRestore.viewport;this._rctx.setViewport(t.x,t.y,t.width,t.height)}bindPreviousDepthToSlot(e,t){const s=!!this._rctx,i=!!this._renderTargetToRestore;if(!s||!i)return 0;const r=this._renderTargetToRestore.fbo.depthStencilTexture;return r?(0===t?this._rctx.bindTexture(null,e,!0):this._rctx.bindTexture(r,e,!0),1):(this.dbg(4,\"no depth/stencil texture exists!\"),0)}setBlendState(e,t,s,i){this._rctx?(this._rctx.setBlendingEnabled(1===e),this._rctx.setBlendFunction(t,s),this._rctx.setBlendEquation(i)):this.dbg(4,\"setBlendState callback has no rendering context!\")}setFrontFace(e){this._rctx?this._rctx.setFrontFace(e):this.dbg(4,\"setFrontFace callback has no rendering context!\")}setDepthStencilStateFunction(e,t,s){this._rctx?(this._rctx.setDepthFunction(s),this._rctx.setDepthTestEnabled(1===e),this._rctx.setDepthWriteEnabled(1===t),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(519,0,255),this._rctx.setStencilOpSeparate(1028,7680,7682,7680),this._rctx.setStencilOpSeparate(1029,7680,7683,7680)):this.dbg(4,\"setDepthStencilStateFunction callback has no rendering context!\")}setRasterizerState(e){if(this._rctx)switch(e){case 1:this._rctx.setFaceCullingEnabled(!1);break;case 3:this._rctx.setCullFace(1029),this._rctx.setFaceCullingEnabled(!0);break;case 2:this._rctx.setCullFace(1028),this._rctx.setFaceCullingEnabled(!0)}else this.dbg(4,\"setRasterizerState callback has no rendering context!\")}setViewport(e,t,s,i){this._rctx?this._rctx.setViewport(e,t,s,i):this.dbg(4,\"setViewport callback has no rendering context!\")}syncRequestsResponses(){this._layers.forEach(((t,s)=>{const r=[];t.responses.forEach(((e,t)=>{r.push(t),this.dbg(2,\"responding for requestID:\"+t+\" size:\"+e.size),this._vxl.respond(s,t,e)}));const n=t.responses;for(const e of r)n.delete(e);const a=this._vxl.get_new_requests(s),l=t.abortController.signal;for(const o in a){t.outstandingRequestCount+=1,1===t.outstandingRequestCount&&t.layerView.updatingFlagChanged();const s=a[o],r={responseType:\"array-buffer\",signal:l};this.dbg(2,\"making requestID:\"+o+\" url:\"+s.url),e(s.url,r).then((e=>{t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),this.dbg(2,\"have response for requestID:\"+o);let i=0;if(e.data.byteLength>0){i=this._vxl._malloc(e.data.byteLength);const t=new Uint8Array(this._vxl.HEAPU8.buffer,i,e.data.byteLength),s=new Uint8Array(e.data);for(let i=0;i<e.data.byteLength;++i)t[i]=s[i]}n.set(+o,{type:s.type,ptr:i,size:e.data.byteLength,success:!0})})).catch((e=>{t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),i(e)||(this.dbg(4,\"requestID:\"+o+\" failed\"),n.set(+o,{type:s.type,ptr:0,size:0,success:!1}))}))}}))}updateWasmCamera(e){this._vxl.set_projection_matrix.apply(this._vxl,e.projectionMatrix),this._vxl.set_view_matrix.apply(this._vxl,e.viewMatrix),this._vxl.set_near_far(e.near,e.far)}isUpdating(e){return!(this._vxl||!this._vxlPromise)||!!this._layers.has(e)&&this._layers.get(e).outstandingRequestCount>0}setEnabled(e,t){this._layers.forEach(((s,i)=>{s.layerView===e&&(this._vxl.set_enabled(i,t?1:0),this._renderPluginContext.requestRender())}))}addVoxelLayer(e){if(!this._vxl){const t={layerView:e,resolveCallback:\"\",rejectCallback:\"\"},s=new Promise(((e,s)=>{t.resolveCallback=e,t.rejectCallback=s}));return this._newLayers.push(t),s}const t=this._addVoxelLayer(e);return t<0?Promise.reject(-1):Promise.resolve(t)}removeVoxelLayer(e){if(!this._vxl){const t=this._newLayers.findIndex((t=>e===t.layerView));t>=0&&(this._newLayers[t].resolveCallback(-1),this._newLayers.splice(t,1));const s=this._newLayers.length;return 0===s&&(this.dbg(1,\" no voxel layers left after removing a layer, removing RenderPlugin and destroying\"),this.destroy()),s}let t=-1;this._layers.forEach(((s,i)=>{s.layerView===e&&(t=i,s.abortController.abort(),this._vxl.remove_layer(t))})),t>=0&&this._layers.delete(t);const s=this._layers.size;return 0===s&&(this.dbg(1,\" no voxel layers left after removing a layer, removing RenderPlugin and destroying\"),this.destroy()),s}_addVoxelLayer(e){const t=e.layer;let s=-1;const i=t.layerData;if(i&&i.data.byteLength>0){const e=this._vxl._malloc(i.data.byteLength),r=new Uint8Array(this._vxl.HEAPU8.buffer,e,i.data.byteLength),n=new Uint8Array(i.data);for(let t=0;t<i.data.byteLength;++t)r[t]=n[t];const a=32662===this._view.spatialReference.wkid&&t.spatialReference.isWGS84?111319.49079327357:1;s=this._vxl.add_layer(t.serviceRoot,e,i.data.byteLength,a,a),this._vxl._free(e)}if(s>=0){const t=r();return this._layers.set(s,{layerView:e,responses:new Map,outstandingRequestCount:0,abortController:t}),s}return-1}prepareRender(e){if(!this._vxl)return;const t=e.viewForward,s=e.eye;this._vxl.update_camera_pos_and_direction(s[0],s[1],s[2],t[0],t[1],t[2]);const i=this._vxl.cull();this.dbg(2,\"missingResourceCount=\"+i),this._moreToLoad=i>0,this._havePreparedWithAllLayers=0===this._newLayers.length}render(e){if(!this._vxl)return!1;for(const s of this._newLayers){const e=this._addVoxelLayer(s.layerView);-1===e?s.rejectCallback(-1):s.resolveCallback(e)}if(this._newLayers=[],e.pass!==this._renderPass)return!1;if(e.slot!==this._renderSlot)return!1;if(0===this._layers.size)return this.dbg(4,\"No voxel layers but RenderPlugin instance is being asked to render!\"),!0;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()},this.syncRequestsResponses(),this._vxl.begin_frame();const t=this._renderTargetToRestore.viewport;return t.width===this._viewportWidth&&t.height===this._viewportHeight||(this._viewportWidth=t.width,this._viewportHeight=t.height,this._vxl.set_viewport(t.width,t.height)),0===t.x&&0===t.y||this.dbg(4,\"Unsupported viewport parameters detected!\"),this.updateWasmCamera(e.camera),this._vxl.draw(),this._renderTargetToRestore.fbo=null,e.rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),e.rctx.externalVertexArrayObjectUpdate(),e.rctx.externalVertexBufferUpdate(),(this._moreToLoad||!this._havePreparedWithAllLayers&&this._layers.size>0)&&this._renderPluginContext.requestRender(),!0}queryDepthRange(e){this.dbg(1,\"--queryDepthRange--\");const t=e.viewForward,s=e.eye;this._vxl.update_camera_pos_and_direction(s[0],s[1],s[2],t[0],t[1],t[2]),this._vxl.cull();const i={near:5,far:1e4};return i.near=this._vxl.get_near(),i.far=this._vxl.get_far(),i}destroy(){this.dbg(1,\"--destroy--\"),this.removeRenderPlugin(),this._readyWatchHandle&&(this._readyWatchHandle.remove(),this._readyWatchHandle=null),this._qualityWatchHandle&&(this._qualityWatchHandle.remove(),this._qualityWatchHandle=null),this._vxl&&(this._vxl.uninitialize_voxel_wasm(),this._vxl=null)}initializeWasm(e){return this._vxl?Promise.resolve():(this._vxlPromise||(this._vxlPromise=g(e).then((e=>{if(this._vxl=e,this._vxlPromise=null,this._newLayers.length<=0)return this.dbg(1,\" no voxel layers left after WASM downloaded, removing RenderPlugin and destroying\"),void this.destroy();const t=this._vxl.addFunction(this.restoreFramebuffer.bind(this),\"v\"),s=this._vxl.addFunction(this.setBlendState.bind(this),\"viiii\"),i=this._vxl.addFunction(this.setFrontFace.bind(this),\"vi\"),r=this._vxl.addFunction(this.setRasterizerState.bind(this),\"vi\"),n=this._vxl.addFunction(this.setDepthStencilStateFunction.bind(this),\"viii\"),a=this._vxl.addFunction(this.setViewport.bind(this),\"viiii\"),l=this._vxl.addFunction(this.bindPreviousDepthToSlot.bind(this),\"iii\");this._vxl.initialize_voxel_wasm(t,s,i,r,n,a,l),this._vxl.set_quality(this.toWasmQuality(this._view.qualityProfile)),this._renderPluginContext&&this._renderPluginContext.requestRender()})).catch((()=>{for(const e of this._newLayers)e.rejectCallback(-2);this.dbg(4,\" WASM failed to download, removing RenderPlugin and destroying\"),this.destroy()}))),this._vxlPromise)}get type(){return\"external\"}get isGround(){return!1}get slicePlane(){return!1}get intersectionHandlerId(){return\"unj\"}intersect(e,t,s,i,r){if(!this._vxl)return;if(!this._rctx)return;if(0===this._layers.size)return;if(r[0]<0||r[0]>e.camera.viewport[2]||r[1]<0||r[1]>e.camera.viewport[3])return;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()};const n=e.camera.viewForward,a=e.camera.eye;this._vxl.update_camera_pos_and_direction(a[0],a[1],a[2],n[0],n[1],n[2]),this.updateWasmCamera(e.camera),this._vxl.begin_frame(),this._useDepthPass?this.intersectDepth(e,t,s,i,r):this.intersectObject(e,t,s,i,r),this._renderTargetToRestore.fbo=null,this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),this._rctx.externalVertexArrayObjectUpdate(),this._rctx.externalVertexBufferUpdate()}intersectObject(e,t,i,r,n){const g=this._vxl.pick_object(n[0],n[1]);if(g.success){const n=u();a(n,r,i),l(n,n);const v=o(i,r),p=u();h(p,g.worldX,g.worldY,g.worldZ);const y=u();a(y,p,i);const b=u();d(b,n,c(y,n));const w=u();_(w,i,b);const f=o(i,w),m=s(f/v,0,1),R=e=>{e.intersector=\"Voxel\",e.dist=m,e.target={type:\"external\",metadata:{layerUid:this.intersectionHandlerId}}},C=e.results.min;(null==C.dist||m<C.dist)&&(null==t||t(i,r,m))&&R(C);const P=e.results.max;if(0!==e.options.store&&(null==P.dist||m>P.dist)&&(null==t||t(i,r,m))&&R(P),2===e.options.store){const t=new x(e.ray);R(t),e.results.all.push(t)}}}intersectDepth(e,t,i,r,n){const g=this._vxl.pick_depth(n[0],n[1]);if(g.success){const n=u();a(n,r,i),l(n,n);const v=o(i,r),p=u();h(p,g.worldX,g.worldY,g.worldZ);const y=u();a(y,p,i);const b=u();d(b,n,c(y,n));const w=u();_(w,i,b);const f=o(i,w),m=s(f/v,0,1),R=e=>{e.intersector=\"Voxel\",e.dist=m,e.target={type:\"external\",metadata:{layerUid:this.intersectionHandlerId}}},C=e.results.min;(null==C.dist||m<C.dist)&&(null==t||t(i,r,m))&&R(C);const P=e.results.max;if(0!==e.options.store&&(null==P.dist||m>P.dist)&&(null==t||t(i,r,m))&&R(P),2===e.options.store){const t=new x(e.ray);R(t),e.results.all.push(t)}}}toWasmQuality(e){switch(e){case\"low\":return 0;case\"medium\":return 1;case\"high\":return 2}}}export default p;\n"]},"metadata":{},"sourceType":"module"}