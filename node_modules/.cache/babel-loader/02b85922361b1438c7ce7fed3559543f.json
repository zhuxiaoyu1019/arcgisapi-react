{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../chunks/tslib.es6.js\";\nimport t from \"../../../../core/Accessor.js\";\nimport o from \"../../../../core/Evented.js\";\nimport r from \"../../../../core/Handles.js\";\nimport s from \"../../../../core/Logger.js\";\nimport { unwrapOr as i } from \"../../../../core/maybe.js\";\nimport { getMetersPerVerticalUnitForSR as n } from \"../../../../core/unitUtils.js\";\nimport { property as a } from \"../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../core/has.js\";\nimport \"../../../../core/accessorSupport/ensureType.js\";\nimport { subclass as l } from \"../../../../core/accessorSupport/decorators/subclass.js\";\nimport { g as c } from \"../../../../chunks/vec3.js\";\nimport { c as d } from \"../../../../chunks/vec3f64.js\";\nimport { empty as m, toRect as p, expandWithVec3 as h } from \"../../../../geometry/support/aaBoundingBox.js\";\nimport { empty as u } from \"../../../../geometry/support/aaBoundingRect.js\";\nimport { getMetersPerUnit as f } from \"../../../../symbols/support/unitConversionUtils.js\";\nimport { Intersector as v } from \"../../webgl-engine/lib/Intersector.js\";\nconst y = s.getLogger(\"esri.views.3d.layers.support.StageLayerElevationProvider\"),\n      g = 1;\nlet j = class extends o.EventedMixin(t) {\n  constructor(e) {\n    super(e), this.elevationOffset = 0, this._layerHandes = new r();\n  }\n\n  initialize() {\n    this.renderCoordsHelper = this.view.renderCoordsHelper, this.intersectLayers = [this.stageLayer], this.intersector = new v(this.view.state.viewingMode), this.intersector.options.store = 0;\n    const e = this.computeLayerExtent(this.stageLayer);\n    this.zmin = e[2], this.zmax = e[5];\n    const t = this.stageLayer.events;\n\n    this._layerHandes.add([t.on(\"layerObjectAdded\", e => this.objectChanged(e.object)), t.on(\"layerObjectRemoved\", e => this.objectChanged(e.object)), t.on(\"objectGeometryAdded\", e => this.objectChanged(e.object)), t.on(\"objectGeometryRemoved\", e => this.objectChanged(e.object)), t.on(\"vertexAttrsUpdated\", e => this.objectChanged(e.object)), t.on(\"objectTransformation\", e => this.objectChanged(e))]);\n  }\n\n  dispose() {\n    this._layerHandes.destroy();\n  }\n\n  elevationInfoChanged() {\n    const e = null != this.layer ? this.layer.elevationInfo : null;\n\n    if (null != e && \"on-the-ground\" !== e.mode) {\n      const t = n(this.layer.spatialReference),\n            o = f(e.unit);\n      this.elevationOffset = i(e.offset, 0) * o / t;\n    } else this.elevationOffset = 0;\n  }\n\n  getElevation(e, t, o, r) {\n    if (C[0] = e, C[1] = t, C[2] = o, !this.renderCoordsHelper.toRenderCoords(C, r, C)) return y.error(\"could not project point for elevation alignment\"), null;\n    const s = this.elevationOffset,\n          i = this.zmin + s,\n          n = this.zmax + s;\n    this.renderCoordsHelper.setAltitude(B, n, C), this.renderCoordsHelper.setAltitude(R, i, C);\n\n    const a = e => e.metadata && e.metadata.isElevationSource;\n\n    return this.intersector.reset(B, R), this.intersector.intersect(this.intersectLayers, null, null, g, null, a), this.intersector.results.min.getIntersectionPoint(C) ? this.renderCoordsHelper.getAltitude(C) : null;\n  }\n\n  objectChanged(e) {\n    var t;\n    if (null == (t = e.metadata) || !t.isElevationSource || !this.spatialReference) return;\n    m(b), e.metadata.lastValidElevationBB.isEmpty() || this.expandExtent(e.metadata.lastValidElevationBB.min, e.metadata.lastValidElevationBB.max, b);\n    const o = e.boundingVolumeWorldSpace.min,\n          r = e.boundingVolumeWorldSpace.max;\n    this.expandExtent(o, r, b), p(b, x), this.zmin = Math.min(this.zmin, b[2]), this.zmax = Math.max(this.zmax, b[5]), E.extent = x, E.spatialReference = this.spatialReference, this.emit(\"elevation-change\", E), c(e.metadata.lastValidElevationBB.min, o), c(e.metadata.lastValidElevationBB.max, r);\n  }\n\n  computeLayerExtent(e) {\n    return m(b), e.objects.forAll(e => this.expandExtent(e.boundingVolumeWorldSpace.min, e.boundingVolumeWorldSpace.max, b)), b;\n  }\n\n  expandExtent(e, t, o) {\n    for (let r = 0; r < 8; ++r) C[0] = 1 & r ? e[0] : t[0], C[1] = 2 & r ? e[1] : t[1], C[2] = 4 & r ? e[2] : t[2], this.renderCoordsHelper.fromRenderCoords(C, C, this.spatialReference), h(o, C);\n\n    return o;\n  }\n\n};\ne([a({\n  constructOnly: !0\n})], j.prototype, \"layer\", void 0), e([a({\n  constructOnly: !0\n})], j.prototype, \"stageLayer\", void 0), e([a({\n  constructOnly: !0\n})], j.prototype, \"view\", void 0), e([a({\n  readOnly: !0,\n  aliasOf: \"view.spatialReference\"\n})], j.prototype, \"spatialReference\", void 0), j = e([l(\"esri.views.3d.layers.support.StageLayerElevationProvider\")], j);\nconst b = m(),\n      x = u(),\n      E = {\n  spatialReference: null,\n  extent: x,\n  context: \"scene\"\n},\n      C = d(),\n      B = d(),\n      R = d();\nexport { j as StageLayerElevationProvider };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/layers/support/StageLayerElevationProvider.js"],"names":["_","e","t","o","r","s","unwrapOr","i","getMetersPerVerticalUnitForSR","n","property","a","subclass","l","g","c","d","empty","m","toRect","p","expandWithVec3","h","u","getMetersPerUnit","f","Intersector","v","y","getLogger","j","EventedMixin","constructor","elevationOffset","_layerHandes","initialize","renderCoordsHelper","view","intersectLayers","stageLayer","intersector","state","viewingMode","options","store","computeLayerExtent","zmin","zmax","events","add","on","objectChanged","object","dispose","destroy","elevationInfoChanged","layer","elevationInfo","mode","spatialReference","unit","offset","getElevation","C","toRenderCoords","error","setAltitude","B","R","metadata","isElevationSource","reset","intersect","results","min","getIntersectionPoint","getAltitude","b","lastValidElevationBB","isEmpty","expandExtent","max","boundingVolumeWorldSpace","x","Math","E","extent","emit","objects","forAll","fromRenderCoords","constructOnly","prototype","readOnly","aliasOf","context","StageLayerElevationProvider"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../chunks/tslib.es6.js\";import t from\"../../../../core/Accessor.js\";import o from\"../../../../core/Evented.js\";import r from\"../../../../core/Handles.js\";import s from\"../../../../core/Logger.js\";import{unwrapOr as i}from\"../../../../core/maybe.js\";import{getMetersPerVerticalUnitForSR as n}from\"../../../../core/unitUtils.js\";import{property as a}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/ensureType.js\";import{subclass as l}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{g as c}from\"../../../../chunks/vec3.js\";import{c as d}from\"../../../../chunks/vec3f64.js\";import{empty as m,toRect as p,expandWithVec3 as h}from\"../../../../geometry/support/aaBoundingBox.js\";import{empty as u}from\"../../../../geometry/support/aaBoundingRect.js\";import{getMetersPerUnit as f}from\"../../../../symbols/support/unitConversionUtils.js\";import{Intersector as v}from\"../../webgl-engine/lib/Intersector.js\";const y=s.getLogger(\"esri.views.3d.layers.support.StageLayerElevationProvider\"),g=1;let j=class extends(o.EventedMixin(t)){constructor(e){super(e),this.elevationOffset=0,this._layerHandes=new r}initialize(){this.renderCoordsHelper=this.view.renderCoordsHelper,this.intersectLayers=[this.stageLayer],this.intersector=new v(this.view.state.viewingMode),this.intersector.options.store=0;const e=this.computeLayerExtent(this.stageLayer);this.zmin=e[2],this.zmax=e[5];const t=this.stageLayer.events;this._layerHandes.add([t.on(\"layerObjectAdded\",(e=>this.objectChanged(e.object))),t.on(\"layerObjectRemoved\",(e=>this.objectChanged(e.object))),t.on(\"objectGeometryAdded\",(e=>this.objectChanged(e.object))),t.on(\"objectGeometryRemoved\",(e=>this.objectChanged(e.object))),t.on(\"vertexAttrsUpdated\",(e=>this.objectChanged(e.object))),t.on(\"objectTransformation\",(e=>this.objectChanged(e)))])}dispose(){this._layerHandes.destroy()}elevationInfoChanged(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&\"on-the-ground\"!==e.mode){const t=n(this.layer.spatialReference),o=f(e.unit);this.elevationOffset=i(e.offset,0)*o/t}else this.elevationOffset=0}getElevation(e,t,o,r){if(C[0]=e,C[1]=t,C[2]=o,!this.renderCoordsHelper.toRenderCoords(C,r,C))return y.error(\"could not project point for elevation alignment\"),null;const s=this.elevationOffset,i=this.zmin+s,n=this.zmax+s;this.renderCoordsHelper.setAltitude(B,n,C),this.renderCoordsHelper.setAltitude(R,i,C);const a=e=>e.metadata&&e.metadata.isElevationSource;return this.intersector.reset(B,R),this.intersector.intersect(this.intersectLayers,null,null,g,null,a),this.intersector.results.min.getIntersectionPoint(C)?this.renderCoordsHelper.getAltitude(C):null}objectChanged(e){var t;if(null==(t=e.metadata)||!t.isElevationSource||!this.spatialReference)return;m(b),e.metadata.lastValidElevationBB.isEmpty()||this.expandExtent(e.metadata.lastValidElevationBB.min,e.metadata.lastValidElevationBB.max,b);const o=e.boundingVolumeWorldSpace.min,r=e.boundingVolumeWorldSpace.max;this.expandExtent(o,r,b),p(b,x),this.zmin=Math.min(this.zmin,b[2]),this.zmax=Math.max(this.zmax,b[5]),E.extent=x,E.spatialReference=this.spatialReference,this.emit(\"elevation-change\",E),c(e.metadata.lastValidElevationBB.min,o),c(e.metadata.lastValidElevationBB.max,r)}computeLayerExtent(e){return m(b),e.objects.forAll((e=>this.expandExtent(e.boundingVolumeWorldSpace.min,e.boundingVolumeWorldSpace.max,b))),b}expandExtent(e,t,o){for(let r=0;r<8;++r)C[0]=1&r?e[0]:t[0],C[1]=2&r?e[1]:t[1],C[2]=4&r?e[2]:t[2],this.renderCoordsHelper.fromRenderCoords(C,C,this.spatialReference),h(o,C);return o}};e([a({constructOnly:!0})],j.prototype,\"layer\",void 0),e([a({constructOnly:!0})],j.prototype,\"stageLayer\",void 0),e([a({constructOnly:!0})],j.prototype,\"view\",void 0),e([a({readOnly:!0,aliasOf:\"view.spatialReference\"})],j.prototype,\"spatialReference\",void 0),j=e([l(\"esri.views.3d.layers.support.StageLayerElevationProvider\")],j);const b=m(),x=u(),E={spatialReference:null,extent:x,context:\"scene\"},C=d(),B=d(),R=d();export{j as StageLayerElevationProvider};\n"]},"metadata":{},"sourceType":"module"}