{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isNone as t, isSome as e } from \"../../../../../core/maybe.js\";\nimport { VTL_TEXTURE_BINDING_UNIT_SPRITES as i, VTL_HIGH_RES_CUTOFF as a } from \"../definitions.js\";\nimport { WGLDrawPhase as n } from \"../enums.js\";\nimport { u32to4Xu8 as r } from \"../number.js\";\nimport o from \"./WGLBrush.js\";\nconst l = 1 / 65536;\n\nclass s extends o {\n  constructor() {\n    super(...arguments), this._fillProgramOptions = {\n      id: !1,\n      pattern: !1\n    }, this._outlineProgramOptions = {\n      id: !1\n    };\n  }\n\n  dispose() {}\n\n  drawMany(t, e) {\n    const {\n      displayLevel: i,\n      drawPhase: a,\n      renderPass: o,\n      spriteMosaic: l,\n      styleLayerUID: s\n    } = t;\n    let f = !1;\n\n    for (const n of e) if (n.layerData.has(s)) {\n      const t = n.layerData.get(s);\n\n      if (t.fillIndexCount > 0 || t.outlineIndexCount > 0) {\n        f = !0;\n        break;\n      }\n    }\n\n    if (!f) return;\n    const u = t.styleLayer,\n          c = u.getPaintProperty(\"fill-pattern\"),\n          d = void 0 !== c,\n          m = d && c.isDataDriven;\n    let p;\n\n    if (d && !m) {\n      const t = c.getValue(i);\n      p = l.getMosaicItemPosition(t, !0);\n    }\n\n    const y = !d && u.getPaintValue(\"fill-antialias\", i);\n    let g = !0,\n        M = 1;\n\n    if (!d) {\n      const t = u.getPaintProperty(\"fill-color\"),\n            e = u.getPaintProperty(\"fill-opacity\");\n\n      if (!(null != t && t.isDataDriven || null != e && e.isDataDriven)) {\n        const t = u.getPaintValue(\"fill-color\", i);\n        M = u.getPaintValue(\"fill-opacity\", i) * t[3], M >= 1 && (g = !1);\n      }\n    }\n\n    if (g && \"opaque\" === o) return;\n\n    let _;\n\n    a === n.HITTEST && (_ = r(s + 1));\n    const v = u.getPaintValue(\"fill-translate\", i),\n          P = u.getPaintValue(\"fill-translate-anchor\", i);\n    (g || \"translucent\" !== o) && this._drawFill(t, s, u, e, v, P, d, p, m, _);\n    const x = !u.hasDataDrivenOutlineColor && u.outlineUsesFillColor && M < 1;\n    y && \"opaque\" !== o && !x && this._drawOutline(t, s, u, e, v, P, _);\n  }\n\n  _drawFill(r, o, s, f, u, c, d, m, p, y) {\n    if (d && t(m)) return;\n    const {\n      context: g,\n      displayLevel: M,\n      state: _,\n      drawPhase: v,\n      painter: P,\n      pixelRatio: x,\n      spriteMosaic: U\n    } = r,\n          E = s.fillMaterial,\n          h = P.vectorTilesMaterialManager,\n          T = x > a ? 2 : 1,\n          D = v === n.HITTEST,\n          I = this._fillProgramOptions;\n    I.id = D, I.pattern = d;\n    const w = h.getMaterialProgram(g, E, I);\n\n    if (g.useProgram(w), e(m)) {\n      const {\n        page: t\n      } = m,\n            a = U.getPageSize(t);\n      e(a) && (U.bind(g, 9729, t, i), w.setUniform2fv(\"u_mosaicSize\", a), w.setUniform1i(\"u_texture\", i));\n    }\n\n    w.setUniformMatrix3fv(\"u_displayMat3\", 1 === c ? _.displayMat3 : _.displayViewMat3), w.setUniform2fv(\"u_fillTranslation\", u), w.setUniform1f(\"u_depth\", s.z + l), D && w.setUniform4fv(\"u_id\", y);\n    let S = -1;\n\n    for (const a of f) {\n      if (!a.layerData.has(o)) continue;\n      a.key.level !== S && (S = a.key.level, E.setDataUniforms(w, M, s, S, U));\n      const n = a.layerData.get(o);\n      if (!n.fillIndexCount) continue;\n      n.prepareForRendering(g);\n      const r = n.fillVertexArrayObject;\n\n      if (!t(r)) {\n        if (g.bindVAO(r), w.setUniformMatrix3fv(\"u_dvsMat3\", a.transforms.dvs), g.setStencilFunction(514, a.stencilRef, 255), d) {\n          const t = Math.max(2 ** (Math.round(M) - a.key.level), 1),\n                e = a.coordRange[0] / (T * a.size[0] * t);\n          w.setUniform1f(\"u_patternFactor\", e);\n        }\n\n        if (p) {\n          const t = n.patternMap;\n          if (!t) continue;\n\n          for (const [a, n] of t) {\n            const t = U.getPageSize(a);\n            e(t) && (U.bind(g, 9729, a, i), w.setUniform2fv(\"u_mosaicSize\", t), w.setUniform1i(\"u_texture\", i), g.drawElements(4, n[1], 5125, Uint32Array.BYTES_PER_ELEMENT * n[0]));\n          }\n        } else g.drawElements(4, n.fillIndexCount, 5125, Uint32Array.BYTES_PER_ELEMENT * n.fillIndexStart);\n\n        a.triangleCount += n.fillIndexCount / 3;\n      }\n    }\n  }\n\n  _drawOutline(e, i, a, r, o, s, f) {\n    const {\n      context: u,\n      displayLevel: c,\n      state: d,\n      drawPhase: m,\n      painter: p,\n      pixelRatio: y,\n      spriteMosaic: g\n    } = e,\n          M = a.outlineMaterial,\n          _ = p.vectorTilesMaterialManager,\n          v = .75 / y,\n          P = m === n.HITTEST,\n          x = this._outlineProgramOptions;\n    x.id = P;\n\n    const U = _.getMaterialProgram(u, M, x);\n\n    u.useProgram(U), U.setUniformMatrix3fv(\"u_displayMat3\", 1 === s ? d.displayMat3 : d.displayViewMat3), U.setUniform2fv(\"u_fillTranslation\", o), U.setUniform1f(\"u_depth\", a.z + l), U.setUniform1f(\"u_outline_width\", v), P && U.setUniform4fv(\"u_id\", f);\n    let E = -1;\n\n    for (const n of r) {\n      if (!n.layerData.has(i)) continue;\n      n.key.level !== E && (E = n.key.level, M.setDataUniforms(U, c, a, E, g));\n      const e = n.layerData.get(i);\n      if (e.prepareForRendering(u), !e.outlineIndexCount) continue;\n      const r = e.outlineVertexArrayObject;\n      t(r) || (u.bindVAO(r), U.setUniformMatrix3fv(\"u_dvsMat3\", n.transforms.dvs), u.setStencilFunction(514, n.stencilRef, 255), u.drawElements(4, e.outlineIndexCount, 5125, Uint32Array.BYTES_PER_ELEMENT * e.outlineIndexStart), n.triangleCount += e.outlineIndexCount / 3);\n    }\n  }\n\n}\n\nexport { s as WGLBrushVTLFill };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/2d/engine/webgl/brushes/WGLBrushVTLFill.js"],"names":["isNone","t","isSome","e","VTL_TEXTURE_BINDING_UNIT_SPRITES","i","VTL_HIGH_RES_CUTOFF","a","WGLDrawPhase","n","u32to4Xu8","r","o","l","s","constructor","arguments","_fillProgramOptions","id","pattern","_outlineProgramOptions","dispose","drawMany","displayLevel","drawPhase","renderPass","spriteMosaic","styleLayerUID","f","layerData","has","get","fillIndexCount","outlineIndexCount","u","styleLayer","c","getPaintProperty","d","m","isDataDriven","p","getValue","getMosaicItemPosition","y","getPaintValue","g","M","_","HITTEST","v","P","_drawFill","x","hasDataDrivenOutlineColor","outlineUsesFillColor","_drawOutline","context","state","painter","pixelRatio","U","E","fillMaterial","h","vectorTilesMaterialManager","T","D","I","w","getMaterialProgram","useProgram","page","getPageSize","bind","setUniform2fv","setUniform1i","setUniformMatrix3fv","displayMat3","displayViewMat3","setUniform1f","z","setUniform4fv","S","key","level","setDataUniforms","prepareForRendering","fillVertexArrayObject","bindVAO","transforms","dvs","setStencilFunction","stencilRef","Math","max","round","coordRange","size","patternMap","drawElements","Uint32Array","BYTES_PER_ELEMENT","fillIndexStart","triangleCount","outlineMaterial","outlineVertexArrayObject","outlineIndexStart","WGLBrushVTLFill"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isNone as t,isSome as e}from\"../../../../../core/maybe.js\";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as i,VTL_HIGH_RES_CUTOFF as a}from\"../definitions.js\";import{WGLDrawPhase as n}from\"../enums.js\";import{u32to4Xu8 as r}from\"../number.js\";import o from\"./WGLBrush.js\";const l=1/65536;class s extends o{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(t,e){const{displayLevel:i,drawPhase:a,renderPass:o,spriteMosaic:l,styleLayerUID:s}=t;let f=!1;for(const n of e)if(n.layerData.has(s)){const t=n.layerData.get(s);if(t.fillIndexCount>0||t.outlineIndexCount>0){f=!0;break}}if(!f)return;const u=t.styleLayer,c=u.getPaintProperty(\"fill-pattern\"),d=void 0!==c,m=d&&c.isDataDriven;let p;if(d&&!m){const t=c.getValue(i);p=l.getMosaicItemPosition(t,!0)}const y=!d&&u.getPaintValue(\"fill-antialias\",i);let g=!0,M=1;if(!d){const t=u.getPaintProperty(\"fill-color\"),e=u.getPaintProperty(\"fill-opacity\");if(!(null!=t&&t.isDataDriven||null!=e&&e.isDataDriven)){const t=u.getPaintValue(\"fill-color\",i);M=u.getPaintValue(\"fill-opacity\",i)*t[3],M>=1&&(g=!1)}}if(g&&\"opaque\"===o)return;let _;a===n.HITTEST&&(_=r(s+1));const v=u.getPaintValue(\"fill-translate\",i),P=u.getPaintValue(\"fill-translate-anchor\",i);(g||\"translucent\"!==o)&&this._drawFill(t,s,u,e,v,P,d,p,m,_);const x=!u.hasDataDrivenOutlineColor&&u.outlineUsesFillColor&&M<1;y&&\"opaque\"!==o&&!x&&this._drawOutline(t,s,u,e,v,P,_)}_drawFill(r,o,s,f,u,c,d,m,p,y){if(d&&t(m))return;const{context:g,displayLevel:M,state:_,drawPhase:v,painter:P,pixelRatio:x,spriteMosaic:U}=r,E=s.fillMaterial,h=P.vectorTilesMaterialManager,T=x>a?2:1,D=v===n.HITTEST,I=this._fillProgramOptions;I.id=D,I.pattern=d;const w=h.getMaterialProgram(g,E,I);if(g.useProgram(w),e(m)){const{page:t}=m,a=U.getPageSize(t);e(a)&&(U.bind(g,9729,t,i),w.setUniform2fv(\"u_mosaicSize\",a),w.setUniform1i(\"u_texture\",i))}w.setUniformMatrix3fv(\"u_displayMat3\",1===c?_.displayMat3:_.displayViewMat3),w.setUniform2fv(\"u_fillTranslation\",u),w.setUniform1f(\"u_depth\",s.z+l),D&&w.setUniform4fv(\"u_id\",y);let S=-1;for(const a of f){if(!a.layerData.has(o))continue;a.key.level!==S&&(S=a.key.level,E.setDataUniforms(w,M,s,S,U));const n=a.layerData.get(o);if(!n.fillIndexCount)continue;n.prepareForRendering(g);const r=n.fillVertexArrayObject;if(!t(r)){if(g.bindVAO(r),w.setUniformMatrix3fv(\"u_dvsMat3\",a.transforms.dvs),g.setStencilFunction(514,a.stencilRef,255),d){const t=Math.max(2**(Math.round(M)-a.key.level),1),e=a.coordRange[0]/(T*a.size[0]*t);w.setUniform1f(\"u_patternFactor\",e)}if(p){const t=n.patternMap;if(!t)continue;for(const[a,n]of t){const t=U.getPageSize(a);e(t)&&(U.bind(g,9729,a,i),w.setUniform2fv(\"u_mosaicSize\",t),w.setUniform1i(\"u_texture\",i),g.drawElements(4,n[1],5125,Uint32Array.BYTES_PER_ELEMENT*n[0]))}}else g.drawElements(4,n.fillIndexCount,5125,Uint32Array.BYTES_PER_ELEMENT*n.fillIndexStart);a.triangleCount+=n.fillIndexCount/3}}}_drawOutline(e,i,a,r,o,s,f){const{context:u,displayLevel:c,state:d,drawPhase:m,painter:p,pixelRatio:y,spriteMosaic:g}=e,M=a.outlineMaterial,_=p.vectorTilesMaterialManager,v=.75/y,P=m===n.HITTEST,x=this._outlineProgramOptions;x.id=P;const U=_.getMaterialProgram(u,M,x);u.useProgram(U),U.setUniformMatrix3fv(\"u_displayMat3\",1===s?d.displayMat3:d.displayViewMat3),U.setUniform2fv(\"u_fillTranslation\",o),U.setUniform1f(\"u_depth\",a.z+l),U.setUniform1f(\"u_outline_width\",v),P&&U.setUniform4fv(\"u_id\",f);let E=-1;for(const n of r){if(!n.layerData.has(i))continue;n.key.level!==E&&(E=n.key.level,M.setDataUniforms(U,c,a,E,g));const e=n.layerData.get(i);if(e.prepareForRendering(u),!e.outlineIndexCount)continue;const r=e.outlineVertexArrayObject;t(r)||(u.bindVAO(r),U.setUniformMatrix3fv(\"u_dvsMat3\",n.transforms.dvs),u.setStencilFunction(514,n.stencilRef,255),u.drawElements(4,e.outlineIndexCount,5125,Uint32Array.BYTES_PER_ELEMENT*e.outlineIndexStart),n.triangleCount+=e.outlineIndexCount/3)}}}export{s as WGLBrushVTLFill};\n"]},"metadata":{},"sourceType":"module"}