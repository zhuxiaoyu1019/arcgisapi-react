{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport \"../../../../../core/has.js\";\nimport { isSome as e } from \"../../../../../core/maybe.js\";\nimport { r as t } from \"../../../../../chunks/rbush.js\";\nimport { convertFromFeature as s, quantizeOptimizedGeometry as r, quantizeX as o, quantizeY as n } from \"../../../../../layers/graphics/featureConversionUtils.js\";\nimport i from \"../../../../../layers/graphics/OptimizedGeometry.js\";\nimport a from \"../../../../../layers/graphics/data/StreamFeatureManager.js\";\nimport { createConnection as c } from \"../../../../../layers/graphics/sources/connections/createConnection.js\";\nimport { DataTileSource as d } from \"./DataTileSource.js\";\nimport { FeatureSetReaderJSON as u } from \"../support/FeatureSetReaderJSON.js\";\nimport { UpdateToken as h } from \"../support/UpdateToken.js\";\nconst p = 2500;\n\nfunction m(e, t) {\n  const s = e.weakClone(),\n        r = o(t, e.geometry.coords[0]),\n        a = n(t, e.geometry.coords[1]);\n  return s.geometry = new i([], [r, a]), s;\n}\n\nfunction l(e) {\n  switch (e) {\n    case \"esriGeometryPoint\":\n      return m;\n\n    case \"esriGeometryPolygon\":\n    case \"esriGeometryPolyline\":\n    default:\n      return (t, s) => {\n        const o = t.weakClone(),\n              n = new i(),\n              a = !1,\n              c = !1,\n              d = r(n, t.geometry, a, c, e, s, !1, !1);\n        return o.geometry = d, o;\n      };\n  }\n}\n\nfunction _(e) {\n  switch (e) {\n    case \"esriGeometryPoint\":\n      return e => ({\n        minX: e.geometry.coords[0],\n        minY: e.geometry.coords[1],\n        maxX: e.geometry.coords[0],\n        maxY: e.geometry.coords[1]\n      });\n\n    default:\n      return e => {\n        let t = 1 / 0,\n            s = 1 / 0,\n            r = -1 / 0,\n            o = -1 / 0;\n        return e.geometry.forEachVertex((e, n) => {\n          t = Math.min(t, e), s = Math.min(s, n), r = Math.max(r, e), o = Math.max(o, n);\n        }), {\n          minX: t,\n          minY: s,\n          maxX: r,\n          maxY: o\n        };\n      };\n  }\n}\n\nfunction f(e, s) {\n  const r = t(9, _(s));\n  return r.load(e), r;\n}\n\nfunction y(e, t) {\n  return e.search({\n    minX: t.bounds[0],\n    minY: t.bounds[1],\n    maxX: t.bounds[2],\n    maxY: t.bounds[3]\n  });\n}\n\nclass g {\n  constructor(e, t) {\n    this.onUpdate = e, this._geometryType = t, this._objectIdToFeature = new Map();\n  }\n\n  get _features() {\n    const e = [];\n    return this._objectIdToFeature.forEach(t => e.push(t)), e;\n  }\n\n  add(e) {\n    this._objectIdToFeature.set(e.objectId, e), this._index = null;\n  }\n\n  get(e) {\n    return this._objectIdToFeature.has(e) ? this._objectIdToFeature.get(e) : null;\n  }\n\n  forEach(e) {\n    this._objectIdToFeature.forEach(e);\n  }\n\n  search(e) {\n    return this._index || (this._index = f(this._features, this._geometryType)), y(this._index, e);\n  }\n\n  removeById(e) {\n    const t = this._objectIdToFeature.get(e);\n\n    return t ? (this._objectIdToFeature.delete(e), this._index = null, t) : null;\n  }\n\n  update(e, t) {\n    this.onUpdate(e, t);\n  }\n\n  get size() {\n    return this._objectIdToFeature.size;\n  }\n\n}\n\nclass b extends d {\n  constructor(e) {\n    super(e), this.type = \"geoevent\", this._dataReceiveEventEnabled = !1, this._level = 0, this._updateInfo = {\n      websocket: 0,\n      client: 0\n    };\n    const {\n      outSR: t\n    } = e,\n          {\n      geometryType: s,\n      objectIdField: r,\n      timeInfo: o,\n      purgeOptions: n,\n      source: i,\n      spatialReference: d,\n      serviceFilter: u,\n      maxReconnectionAttempts: h,\n      maxReconnectionInterval: m,\n      updateInterval: _\n    } = e.serviceInfo,\n          f = new g(this._onUpdate.bind(this), s),\n          y = new a(f, r, o, n),\n          b = c(i, d, t, s, u, h, m);\n    this._store = f, this._manager = y, this._connection = b, this._quantize = l(s), this._handles = [this._connection.on(\"feature\", e => this._onFeature(e)), this._connection.watch(\"connectionStatus\", e => this.events.emit(\"connectionStatus\", e)), this._connection.watch(\"errorString\", e => this.events.emit(\"errorString\", e))];\n    let v = performance.now();\n    this._updateIntervalId = setInterval(() => {\n      const t = performance.now(),\n            s = t - v;\n\n      if (s > p) {\n        v = t;\n        const e = Math.round(this._updateInfo.client / (s / 1e3)),\n              r = Math.round(this._updateInfo.websocket / (s / 1e3));\n        this._updateInfo.client = 0, this._updateInfo.websocket = 0, this.events.emit(\"updateRate\", {\n          client: e,\n          websocket: r\n        });\n      }\n\n      e.canAcceptRequest() && this._manager.checkForUpdates();\n    }, _);\n  }\n\n  destroy() {\n    super.destroy(), clearInterval(this._updateIntervalId), this._handles.forEach(e => e.remove()), this._connection.destroy();\n  }\n\n  _fetchDataTile() {}\n\n  resume() {}\n\n  enableEvent(e, t) {\n    \"data-received\" === e && (this._dataReceiveEventEnabled = t);\n  }\n\n  get updating() {\n    return !1;\n  }\n\n  subscribe(e) {\n    super.subscribe(e);\n\n    const t = this._subscriptions.get(e.id);\n\n    this._level = e.level;\n\n    const s = this._getTileFeatures(e);\n\n    this._onMessage({\n      type: \"append\",\n      id: e.key.id,\n      addOrUpdate: s,\n      end: !0\n    }), t.didSend = !0;\n  }\n\n  unsubscribe(e) {\n    super.unsubscribe(e);\n  }\n\n  *readers(t) {\n    const s = this._subscriptions.get(t),\n          {\n      tile: r\n    } = s;\n\n    yield this._getTileFeatures(r);\n\n    for (const o of s.requests.stream.entries) e(o) && e(o.addOrUpdate) && (yield o.addOrUpdate);\n  }\n\n  createTileQuery(e) {\n    throw new Error(\"Service does not support tile  queries\");\n  }\n\n  async resend() {\n    this._subscriptions.forEach(e => {\n      const {\n        tile: t\n      } = e,\n            s = {\n        type: \"append\",\n        id: t.id,\n        addOrUpdate: this._getTileFeatures(t),\n        end: !0\n      };\n\n      this._onMessage(s);\n    });\n  }\n\n  _getTileFeatures(e) {\n    const t = this._store.search(e).map(t => this._quantize(t, e.transform));\n\n    return u.fromOptimizedFeatures(t, this._serviceInfo.geometryType, e.transform);\n  }\n\n  _onFeature(e) {\n    this._updateInfo.websocket++;\n\n    try {\n      this._dataReceiveEventEnabled && this.events.emit(\"feature\", e);\n      const t = s(e, this._serviceInfo.geometryType, !1, !1, this._serviceInfo.objectIdField);\n\n      this._manager.add(t);\n    } catch (t) {}\n  }\n\n  _onUpdate(t, s) {\n    e(t) && (this._updateInfo.client += t.length), this._subscriptions.forEach((e, t) => {\n      e.didSend && e.tile.level === this._level && this._onMessage({\n        type: \"append\",\n        id: t,\n        addOrUpdate: null,\n        clear: !0,\n        end: !1\n      });\n    }), this._subscriptions.forEach((e, t) => {\n      if (!e.didSend || e.tile.level !== this._level) return;\n      const s = e.tile,\n            r = {\n        type: \"append\",\n        id: t,\n        addOrUpdate: this._getTileFeatures(s),\n        remove: [],\n        end: !0,\n        status: h.empty()\n      };\n      e.requests.stream.enqueue(r), this._onMessage(r);\n    });\n  }\n\n}\n\nexport { b as GeoEventSource };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/2d/layers/features/sources/GeoEventSource.js"],"names":["isSome","e","r","t","convertFromFeature","s","quantizeOptimizedGeometry","quantizeX","o","quantizeY","n","i","a","createConnection","c","DataTileSource","d","FeatureSetReaderJSON","u","UpdateToken","h","p","m","weakClone","geometry","coords","l","_","minX","minY","maxX","maxY","forEachVertex","Math","min","max","f","load","y","search","bounds","g","constructor","onUpdate","_geometryType","_objectIdToFeature","Map","_features","forEach","push","add","set","objectId","_index","get","has","removeById","delete","update","size","b","type","_dataReceiveEventEnabled","_level","_updateInfo","websocket","client","outSR","geometryType","objectIdField","timeInfo","purgeOptions","source","spatialReference","serviceFilter","maxReconnectionAttempts","maxReconnectionInterval","updateInterval","serviceInfo","_onUpdate","bind","_store","_manager","_connection","_quantize","_handles","on","_onFeature","watch","events","emit","v","performance","now","_updateIntervalId","setInterval","round","canAcceptRequest","checkForUpdates","destroy","clearInterval","remove","_fetchDataTile","resume","enableEvent","updating","subscribe","_subscriptions","id","level","_getTileFeatures","_onMessage","key","addOrUpdate","end","didSend","unsubscribe","readers","tile","requests","stream","entries","createTileQuery","Error","resend","map","transform","fromOptimizedFeatures","_serviceInfo","length","clear","status","empty","enqueue","GeoEventSource"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport\"../../../../../core/has.js\";import{isSome as e}from\"../../../../../core/maybe.js\";import{r as t}from\"../../../../../chunks/rbush.js\";import{convertFromFeature as s,quantizeOptimizedGeometry as r,quantizeX as o,quantizeY as n}from\"../../../../../layers/graphics/featureConversionUtils.js\";import i from\"../../../../../layers/graphics/OptimizedGeometry.js\";import a from\"../../../../../layers/graphics/data/StreamFeatureManager.js\";import{createConnection as c}from\"../../../../../layers/graphics/sources/connections/createConnection.js\";import{DataTileSource as d}from\"./DataTileSource.js\";import{FeatureSetReaderJSON as u}from\"../support/FeatureSetReaderJSON.js\";import{UpdateToken as h}from\"../support/UpdateToken.js\";const p=2500;function m(e,t){const s=e.weakClone(),r=o(t,e.geometry.coords[0]),a=n(t,e.geometry.coords[1]);return s.geometry=new i([],[r,a]),s}function l(e){switch(e){case\"esriGeometryPoint\":return m;case\"esriGeometryPolygon\":case\"esriGeometryPolyline\":default:return(t,s)=>{const o=t.weakClone(),n=new i,a=!1,c=!1,d=r(n,t.geometry,a,c,e,s,!1,!1);return o.geometry=d,o}}}function _(e){switch(e){case\"esriGeometryPoint\":return e=>({minX:e.geometry.coords[0],minY:e.geometry.coords[1],maxX:e.geometry.coords[0],maxY:e.geometry.coords[1]});default:return e=>{let t=1/0,s=1/0,r=-1/0,o=-1/0;return e.geometry.forEachVertex(((e,n)=>{t=Math.min(t,e),s=Math.min(s,n),r=Math.max(r,e),o=Math.max(o,n)})),{minX:t,minY:s,maxX:r,maxY:o}}}}function f(e,s){const r=t(9,_(s));return r.load(e),r}function y(e,t){return e.search({minX:t.bounds[0],minY:t.bounds[1],maxX:t.bounds[2],maxY:t.bounds[3]})}class g{constructor(e,t){this.onUpdate=e,this._geometryType=t,this._objectIdToFeature=new Map}get _features(){const e=[];return this._objectIdToFeature.forEach((t=>e.push(t))),e}add(e){this._objectIdToFeature.set(e.objectId,e),this._index=null}get(e){return this._objectIdToFeature.has(e)?this._objectIdToFeature.get(e):null}forEach(e){this._objectIdToFeature.forEach(e)}search(e){return this._index||(this._index=f(this._features,this._geometryType)),y(this._index,e)}removeById(e){const t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),this._index=null,t):null}update(e,t){this.onUpdate(e,t)}get size(){return this._objectIdToFeature.size}}class b extends d{constructor(e){super(e),this.type=\"geoevent\",this._dataReceiveEventEnabled=!1,this._level=0,this._updateInfo={websocket:0,client:0};const{outSR:t}=e,{geometryType:s,objectIdField:r,timeInfo:o,purgeOptions:n,source:i,spatialReference:d,serviceFilter:u,maxReconnectionAttempts:h,maxReconnectionInterval:m,updateInterval:_}=e.serviceInfo,f=new g(this._onUpdate.bind(this),s),y=new a(f,r,o,n),b=c(i,d,t,s,u,h,m);this._store=f,this._manager=y,this._connection=b,this._quantize=l(s),this._handles=[this._connection.on(\"feature\",(e=>this._onFeature(e))),this._connection.watch(\"connectionStatus\",(e=>this.events.emit(\"connectionStatus\",e))),this._connection.watch(\"errorString\",(e=>this.events.emit(\"errorString\",e)))];let v=performance.now();this._updateIntervalId=setInterval((()=>{const t=performance.now(),s=t-v;if(s>p){v=t;const e=Math.round(this._updateInfo.client/(s/1e3)),r=Math.round(this._updateInfo.websocket/(s/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.events.emit(\"updateRate\",{client:e,websocket:r})}e.canAcceptRequest()&&this._manager.checkForUpdates()}),_)}destroy(){super.destroy(),clearInterval(this._updateIntervalId),this._handles.forEach((e=>e.remove())),this._connection.destroy()}_fetchDataTile(){}resume(){}enableEvent(e,t){\"data-received\"===e&&(this._dataReceiveEventEnabled=t)}get updating(){return!1}subscribe(e){super.subscribe(e);const t=this._subscriptions.get(e.id);this._level=e.level;const s=this._getTileFeatures(e);this._onMessage({type:\"append\",id:e.key.id,addOrUpdate:s,end:!0}),t.didSend=!0}unsubscribe(e){super.unsubscribe(e)}*readers(t){const s=this._subscriptions.get(t),{tile:r}=s;yield this._getTileFeatures(r);for(const o of s.requests.stream.entries)e(o)&&e(o.addOrUpdate)&&(yield o.addOrUpdate)}createTileQuery(e){throw new Error(\"Service does not support tile  queries\")}async resend(){this._subscriptions.forEach((e=>{const{tile:t}=e,s={type:\"append\",id:t.id,addOrUpdate:this._getTileFeatures(t),end:!0};this._onMessage(s)}))}_getTileFeatures(e){const t=this._store.search(e).map((t=>this._quantize(t,e.transform)));return u.fromOptimizedFeatures(t,this._serviceInfo.geometryType,e.transform)}_onFeature(e){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit(\"feature\",e);const t=s(e,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(t)}catch(t){}}_onUpdate(t,s){e(t)&&(this._updateInfo.client+=t.length),this._subscriptions.forEach(((e,t)=>{e.didSend&&e.tile.level===this._level&&this._onMessage({type:\"append\",id:t,addOrUpdate:null,clear:!0,end:!1})})),this._subscriptions.forEach(((e,t)=>{if(!e.didSend||e.tile.level!==this._level)return;const s=e.tile,r={type:\"append\",id:t,addOrUpdate:this._getTileFeatures(s),remove:[],end:!0,status:h.empty()};e.requests.stream.enqueue(r),this._onMessage(r)}))}}export{b as GeoEventSource};\n"]},"metadata":{},"sourceType":"module"}