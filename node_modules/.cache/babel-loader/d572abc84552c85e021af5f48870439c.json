{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../request.js\";\nimport t from \"../../../core/Error.js\";\nimport r from \"../../../core/Logger.js\";\nimport { eachAlways as s } from \"../../../core/promiseUtils.js\";\nimport { isNumericField as i } from \"../../../layers/support/fieldUtils.js\";\nimport o from \"../../../rest/support/Query.js\";\nimport n from \"../../../rest/support/RelationshipQuery.js\";\nimport a from \"../../../rest/support/StatisticDefinition.js\";\nimport l from \"../../../tasks/QueryTask.js\";\nimport { isRelatedField as u } from \"./featureUtils.js\";\nconst c = \"esri.widgets.Feature.support.relatedFeatureUtils\",\n      d = r.getLogger(c),\n      f = new Map();\n\nfunction p(e) {\n  if (!u(e)) return null;\n  const [t, r] = e.split(\"/\").slice(1);\n  return {\n    layerId: t,\n    fieldName: r\n  };\n}\n\nfunction m(e, t) {\n  if (!t.relationships) return null;\n  let r = null;\n  const {\n    relationships: s\n  } = t;\n  return s.some(t => t.id === parseInt(e, 10) && (r = t, !0)), r;\n}\n\nfunction y({\n  originRelationship: e,\n  relationships: t,\n  layerId: r\n}) {\n  let s;\n  return t && t.some(t => (`${t.relatedTableId}` === r && t.id === e.id && (s = t), !!s)), s;\n}\n\nfunction F(e, t) {\n  const r = t.toLowerCase();\n\n  for (const s in e) if (s.toLowerCase() === r) return e[s];\n\n  return null;\n}\n\nfunction h(e, t) {\n  const r = m(e, t);\n  if (!r) return;\n  const s = `${t.url}/${r.relatedTableId}`;\n  return {\n    url: s,\n    queryTask: new l({\n      url: s,\n      sourceSpatialReference: t.spatialReference\n    }),\n    relation: r,\n    relatedFields: [],\n    outStatistics: []\n  };\n}\n\nfunction I(e, t) {\n  if (!t) return;\n  if (!e) return;\n  const {\n    features: r,\n    statsFeatures: s\n  } = e,\n        i = r && r.value;\n  t.relatedFeatures = i ? i.features : [];\n  const o = s && s.value;\n  t.relatedStatsFeatures = o ? o.features : [];\n}\n\nfunction w(e, t, r, s) {\n  const i = new n();\n  return i.outFields = [\"*\"], i.relationshipId = \"number\" == typeof t.id ? t.id : parseInt(t.id, 10), i.objectIds = [e.attributes[r.objectIdField]], r.queryRelatedFeatures(i, s);\n}\n\nfunction b(e, t, r) {\n  let s = 0;\n  const i = [];\n\n  for (; s < t.length;) i.push(`${e} IN (${t.slice(s, r + s)})`), s += r;\n\n  return i.join(\" OR \");\n}\n\nasync function j(e, t, r, n) {\n  const a = r.layerId.toString(),\n        {\n    layerInfo: l,\n    queryTask: u,\n    relation: c,\n    relatedFields: d,\n    outStatistics: f\n  } = t,\n        p = y({\n    originRelationship: c,\n    relationships: l.relationships,\n    layerId: a\n  });\n\n  if (p.relationshipTableId && p.keyFieldInRelationshipTable) {\n    const t = (await w(e, p, r, n))[e.attributes[r.objectIdField]];\n    if (!t) return null;\n    const i = t.features.map(e => e.attributes[l.objectIdField]);\n\n    if ((null == f ? void 0 : f.length) > 0 && l.supportsStatistics) {\n      const e = new o();\n      e.where = b(l.objectIdField, i, 1e3), e.outFields = d, e.outStatistics = f;\n      const r = {\n        features: Promise.resolve(t),\n        statsFeatures: u.execute(e)\n      };\n      return s(r);\n    }\n  }\n\n  const m = null == p ? void 0 : p.keyField;\n\n  if (m) {\n    const r = i(q(l.fields, m)),\n          a = F(e.attributes, c.keyField),\n          d = r ? `${m}=${a}` : `${m}='${a}'`,\n          f = u.execute(new o({\n      where: d,\n      outFields: t.relatedFields\n    }), n),\n          p = t.outStatistics && t.outStatistics.length > 0 && l.supportsStatistics ? u.execute(new o({\n      where: d,\n      outFields: t.relatedFields,\n      outStatistics: t.outStatistics\n    }), n) : null,\n          y = {\n      features: f\n    };\n    return p && (y.statsFeatures = p), s(y);\n  }\n\n  return null;\n}\n\nfunction g(t, r) {\n  return e(t, {\n    query: {\n      f: \"json\"\n    },\n    signal: r && r.signal\n  });\n}\n\nfunction S({\n  relatedInfos: e,\n  layer: r\n}, i) {\n  const o = {};\n  return e.forEach((e, s) => {\n    const {\n      relation: n\n    } = e;\n\n    if (!n) {\n      const e = new t(\"relation-required\", \"A relation is required on a layer to retrieve related records.\");\n      throw d.error(e), e;\n    }\n\n    const {\n      relatedTableId: a\n    } = n;\n\n    if (\"number\" != typeof a) {\n      const e = new t(\"A related table ID is required on a layer to retrieve related records.\");\n      throw d.error(e), e;\n    }\n\n    const l = `${r.url}/${a}`,\n          u = f.get(l),\n          c = u || g(l, i);\n    u || f.set(l, c), o[s] = c;\n  }), s(o);\n}\n\nfunction T({\n  graphic: e,\n  relatedInfos: t,\n  layer: r\n}, i) {\n  const o = {};\n  return t.forEach((t, s) => {\n    t.layerInfo && (o[s] = j(e, t, r, i));\n  }), s(o);\n}\n\nfunction $({\n  relatedInfo: e,\n  fieldName: t,\n  fieldInfo: r\n}) {\n  if (e.relatedFields.push(t), r.statisticType) {\n    const s = new a({\n      statisticType: r.statisticType,\n      onStatisticField: t,\n      outStatisticFieldName: t\n    });\n    e.outStatistics.push(s);\n  }\n}\n\nfunction q(e, t) {\n  if (null != e) {\n    t = t.toLowerCase();\n\n    for (const r of e) if (r && r.name.toLowerCase() === t) return r;\n  }\n\n  return null;\n}\n\nexport { h as createRelatedInfo, y as getDestinationRelation, p as getRelatedFieldInfo, S as queryLayerInfos, T as queryRelatedFeatures, I as setRelatedFeatures, $ as updateRelatedInfo };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/widgets/Feature/support/relatedFeatureUtils.js"],"names":["e","t","r","eachAlways","s","isNumericField","i","o","n","a","l","isRelatedField","u","c","d","getLogger","f","Map","p","split","slice","layerId","fieldName","m","relationships","some","id","parseInt","y","originRelationship","relatedTableId","F","toLowerCase","h","url","queryTask","sourceSpatialReference","spatialReference","relation","relatedFields","outStatistics","I","features","statsFeatures","value","relatedFeatures","relatedStatsFeatures","w","outFields","relationshipId","objectIds","attributes","objectIdField","queryRelatedFeatures","b","length","push","join","j","toString","layerInfo","relationshipTableId","keyFieldInRelationshipTable","map","supportsStatistics","where","Promise","resolve","execute","keyField","q","fields","g","query","signal","S","relatedInfos","layer","forEach","error","get","set","T","graphic","$","relatedInfo","fieldInfo","statisticType","onStatisticField","outStatisticFieldName","name","createRelatedInfo","getDestinationRelation","getRelatedFieldInfo","queryLayerInfos","setRelatedFeatures","updateRelatedInfo"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../request.js\";import t from\"../../../core/Error.js\";import r from\"../../../core/Logger.js\";import{eachAlways as s}from\"../../../core/promiseUtils.js\";import{isNumericField as i}from\"../../../layers/support/fieldUtils.js\";import o from\"../../../rest/support/Query.js\";import n from\"../../../rest/support/RelationshipQuery.js\";import a from\"../../../rest/support/StatisticDefinition.js\";import l from\"../../../tasks/QueryTask.js\";import{isRelatedField as u}from\"./featureUtils.js\";const c=\"esri.widgets.Feature.support.relatedFeatureUtils\",d=r.getLogger(c),f=new Map;function p(e){if(!u(e))return null;const[t,r]=e.split(\"/\").slice(1);return{layerId:t,fieldName:r}}function m(e,t){if(!t.relationships)return null;let r=null;const{relationships:s}=t;return s.some((t=>t.id===parseInt(e,10)&&(r=t,!0))),r}function y({originRelationship:e,relationships:t,layerId:r}){let s;return t&&t.some((t=>(`${t.relatedTableId}`===r&&t.id===e.id&&(s=t),!!s))),s}function F(e,t){const r=t.toLowerCase();for(const s in e)if(s.toLowerCase()===r)return e[s];return null}function h(e,t){const r=m(e,t);if(!r)return;const s=`${t.url}/${r.relatedTableId}`;return{url:s,queryTask:new l({url:s,sourceSpatialReference:t.spatialReference}),relation:r,relatedFields:[],outStatistics:[]}}function I(e,t){if(!t)return;if(!e)return;const{features:r,statsFeatures:s}=e,i=r&&r.value;t.relatedFeatures=i?i.features:[];const o=s&&s.value;t.relatedStatsFeatures=o?o.features:[]}function w(e,t,r,s){const i=new n;return i.outFields=[\"*\"],i.relationshipId=\"number\"==typeof t.id?t.id:parseInt(t.id,10),i.objectIds=[e.attributes[r.objectIdField]],r.queryRelatedFeatures(i,s)}function b(e,t,r){let s=0;const i=[];for(;s<t.length;)i.push(`${e} IN (${t.slice(s,r+s)})`),s+=r;return i.join(\" OR \")}async function j(e,t,r,n){const a=r.layerId.toString(),{layerInfo:l,queryTask:u,relation:c,relatedFields:d,outStatistics:f}=t,p=y({originRelationship:c,relationships:l.relationships,layerId:a});if(p.relationshipTableId&&p.keyFieldInRelationshipTable){const t=(await w(e,p,r,n))[e.attributes[r.objectIdField]];if(!t)return null;const i=t.features.map((e=>e.attributes[l.objectIdField]));if((null==f?void 0:f.length)>0&&l.supportsStatistics){const e=new o;e.where=b(l.objectIdField,i,1e3),e.outFields=d,e.outStatistics=f;const r={features:Promise.resolve(t),statsFeatures:u.execute(e)};return s(r)}}const m=null==p?void 0:p.keyField;if(m){const r=i(q(l.fields,m)),a=F(e.attributes,c.keyField),d=r?`${m}=${a}`:`${m}='${a}'`,f=u.execute(new o({where:d,outFields:t.relatedFields}),n),p=t.outStatistics&&t.outStatistics.length>0&&l.supportsStatistics?u.execute(new o({where:d,outFields:t.relatedFields,outStatistics:t.outStatistics}),n):null,y={features:f};return p&&(y.statsFeatures=p),s(y)}return null}function g(t,r){return e(t,{query:{f:\"json\"},signal:r&&r.signal})}function S({relatedInfos:e,layer:r},i){const o={};return e.forEach(((e,s)=>{const{relation:n}=e;if(!n){const e=new t(\"relation-required\",\"A relation is required on a layer to retrieve related records.\");throw d.error(e),e}const{relatedTableId:a}=n;if(\"number\"!=typeof a){const e=new t(\"A related table ID is required on a layer to retrieve related records.\");throw d.error(e),e}const l=`${r.url}/${a}`,u=f.get(l),c=u||g(l,i);u||f.set(l,c),o[s]=c})),s(o)}function T({graphic:e,relatedInfos:t,layer:r},i){const o={};return t.forEach(((t,s)=>{t.layerInfo&&(o[s]=j(e,t,r,i))})),s(o)}function $({relatedInfo:e,fieldName:t,fieldInfo:r}){if(e.relatedFields.push(t),r.statisticType){const s=new a({statisticType:r.statisticType,onStatisticField:t,outStatisticFieldName:t});e.outStatistics.push(s)}}function q(e,t){if(null!=e){t=t.toLowerCase();for(const r of e)if(r&&r.name.toLowerCase()===t)return r}return null}export{h as createRelatedInfo,y as getDestinationRelation,p as getRelatedFieldInfo,S as queryLayerInfos,T as queryRelatedFeatures,I as setRelatedFeatures,$ as updateRelatedInfo};\n"]},"metadata":{},"sourceType":"module"}