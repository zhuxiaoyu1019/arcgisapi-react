{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isSome as e } from \"../../../../core/maybe.js\";\nimport { b as t, c as s, r as a, d as r } from \"../../../../chunks/mat3.js\";\nimport { c as i } from \"../../../../chunks/mat3f32.js\";\nimport { CircleRenderBucket as o, SymbolRenderBucket as h, LineRenderBucket as n, FillRenderBucket as l } from \"./RenderBucket.js\";\nimport { FADE_DURATION as c } from \"./decluttering/config.js\";\nimport { TiledDisplayObject as y } from \"../webgl/TiledDisplayObject.js\";\n\nclass d extends y {\n  constructor(e, t, s, a, r = null) {\n    super(e, s, a, [4096, 4096]), this._memCache = r, this._referenced = 0, this._hasSymbolBuckets = !1, this._memoryUsedByLayerData = 0, this.layerData = new Map(), this.layerCount = 0, this.status = \"loading\", this.allSymbolsFadingOut = !1, this.lastOpacityUpdate = 0, this.symbols = new Map(), this.isCoverage = !1, this.neededForCoverage = !1, this.decluttered = !1, this.invalidating = !1, this.parentTile = null, this.childrenTiles = new Set(), this._processed = !1, this._referenced = 1, this.styleRepository = t, this.id = e.id, this.transforms.tileUnitsToPixels = i();\n  }\n\n  get hasSymbolBuckets() {\n    return this._hasSymbolBuckets;\n  }\n\n  get isFading() {\n    return this._hasSymbolBuckets && performance.now() - this.lastOpacityUpdate < c;\n  }\n\n  get isHoldingForFade() {\n    return this._hasSymbolBuckets && (!this.allSymbolsFadingOut || performance.now() - this.lastOpacityUpdate < c);\n  }\n\n  get wasRequested() {\n    return \"errored\" === this.status || \"loaded\" === this.status || \"reloading\" === this.status;\n  }\n\n  setData(e) {\n    this.changeDataImpl(e), this.requestRender(), this.ready(), this.invalidating = !1, this._processed = !0;\n  }\n\n  deleteLayerData(t) {\n    let s = !1;\n\n    for (const e of t) if (this.layerData.has(e)) {\n      const t = this.layerData.get(e);\n      this._memoryUsedByLayerData -= t.memoryUsed, 3 === t.type && this.symbols.has(e) && (this.symbols.delete(e), s = !0), t.destroy(), this.layerData.delete(e), this.layerCount--;\n    }\n\n    e(this._memCache) && this._memCache.updateSize(this.key.id, this, this._memoryUsedByLayerData), s && this.emit(\"symbols-changed\"), this.requestRender();\n  }\n\n  processed() {\n    return this._processed;\n  }\n\n  hasData() {\n    return this.layerCount > 0;\n  }\n\n  dispose() {\n    \"unloaded\" !== this.status && (m.delete(this), d._destroyRenderBuckets(this.layerData), this.layerData = null, this.layerCount = 0, this._memoryUsedByLayerData = 0, this.destroy(), this.status = \"unloaded\");\n  }\n\n  release() {\n    return 0 == --this._referenced && (this.dispose(), this.stage = null, !0);\n  }\n\n  retain() {\n    ++this._referenced;\n  }\n\n  get referenced() {\n    return this._referenced;\n  }\n\n  get memoryUsage() {\n    return (this._memoryUsedByLayerData + 256) / (this._referenced || 1);\n  }\n\n  changeDataImpl(t) {\n    let s = !1;\n\n    if (t) {\n      const a = this._createRenderBuckets(t);\n\n      for (const [e, t] of a) {\n        if (this.layerData.has(e)) {\n          const s = this.layerData.get(e);\n          this._memoryUsedByLayerData -= t.memoryUsed, s.destroy(), this.layerData.delete(e), this.layerCount--;\n        }\n\n        3 === t.type && (this.symbols.set(e, t.symbols), s = !0), this._memoryUsedByLayerData += t.memoryUsed, this.layerData.set(e, t), this.layerCount++;\n      }\n\n      e(this._memCache) && this._memCache.updateSize(this.key.id, this, this._memoryUsedByLayerData);\n    }\n\n    this._hasSymbolBuckets = !1;\n\n    for (const [e, a] of this.layerData) 3 === a.type && (this._hasSymbolBuckets = !0);\n\n    s && this.emit(\"symbols-changed\");\n  }\n\n  attachWithContext(e) {\n    this.stage = {\n      context: e,\n\n      trashDisplayObject(e) {\n        e.processDetach();\n      },\n\n      untrashDisplayObject: () => !1\n    };\n  }\n\n  setTransform(e, i) {\n    super.setTransform(e, i);\n    const o = i / (e.resolution * e.pixelRatio),\n          h = this.size[0] / this.coordRange[0] * o,\n          n = this.size[1] / this.coordRange[1] * o,\n          l = [0, 0];\n    e.toScreen(l, this.coords);\n    const c = this.transforms.tileUnitsToPixels;\n    t(c), s(c, c, l), a(c, c, Math.PI * e.rotation / 180), r(c, c, [h, n, 1]);\n  }\n\n  static _destroyRenderBuckets(e) {\n    if (!e) return;\n    const t = new Set();\n    e.forEach(e => {\n      t.has(e) || (e.destroy(), t.add(e));\n    }), e.clear();\n  }\n\n  _createRenderBuckets(e) {\n    const t = new Map(),\n          s = new Map();\n\n    for (const a of e) {\n      const e = this._deserializeBucket(a, s);\n\n      for (const s of e.layerUIDs) t.set(s, e);\n    }\n\n    return t;\n  }\n\n  _deserializeBucket(e, t) {\n    let s = t.get(e);\n    if (s) return s;\n\n    switch (new Uint32Array(e)[0]) {\n      case 1:\n        s = new l(e, this.styleRepository);\n        break;\n\n      case 2:\n        s = new n(e, this.styleRepository);\n        break;\n\n      case 3:\n        s = new h(e, this.styleRepository, this);\n        break;\n\n      case 4:\n        s = new o(e, this.styleRepository);\n    }\n\n    return t.set(e, s), s;\n  }\n\n}\n\nconst m = new Map();\n\nfunction u() {\n  m.forEach((e, t) => {\n    console.log(`\\n${t.key}:`), e[0].forEach(e => console.log(e)), console.log(\"========\"), e[1].forEach(e => console.log(e));\n  });\n}\n\nexport { d as VectorTile, u as printAllocations };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/2d/engine/vectorTiles/VectorTile.js"],"names":["isSome","e","b","t","c","s","r","a","d","i","CircleRenderBucket","o","SymbolRenderBucket","h","LineRenderBucket","n","FillRenderBucket","l","FADE_DURATION","TiledDisplayObject","y","constructor","_memCache","_referenced","_hasSymbolBuckets","_memoryUsedByLayerData","layerData","Map","layerCount","status","allSymbolsFadingOut","lastOpacityUpdate","symbols","isCoverage","neededForCoverage","decluttered","invalidating","parentTile","childrenTiles","Set","_processed","styleRepository","id","transforms","tileUnitsToPixels","hasSymbolBuckets","isFading","performance","now","isHoldingForFade","wasRequested","setData","changeDataImpl","requestRender","ready","deleteLayerData","has","get","memoryUsed","type","delete","destroy","updateSize","key","emit","processed","hasData","dispose","m","_destroyRenderBuckets","release","stage","retain","referenced","memoryUsage","_createRenderBuckets","set","attachWithContext","context","trashDisplayObject","processDetach","untrashDisplayObject","setTransform","resolution","pixelRatio","size","coordRange","toScreen","coords","Math","PI","rotation","forEach","add","clear","_deserializeBucket","layerUIDs","Uint32Array","u","console","log","VectorTile","printAllocations"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isSome as e}from\"../../../../core/maybe.js\";import{b as t,c as s,r as a,d as r}from\"../../../../chunks/mat3.js\";import{c as i}from\"../../../../chunks/mat3f32.js\";import{CircleRenderBucket as o,SymbolRenderBucket as h,LineRenderBucket as n,FillRenderBucket as l}from\"./RenderBucket.js\";import{FADE_DURATION as c}from\"./decluttering/config.js\";import{TiledDisplayObject as y}from\"../webgl/TiledDisplayObject.js\";class d extends y{constructor(e,t,s,a,r=null){super(e,s,a,[4096,4096]),this._memCache=r,this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.layerCount=0,this.status=\"loading\",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.invalidating=!1,this.parentTile=null,this.childrenTiles=new Set,this._processed=!1,this._referenced=1,this.styleRepository=t,this.id=e.id,this.transforms.tileUnitsToPixels=i()}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<c}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<c)}get wasRequested(){return\"errored\"===this.status||\"loaded\"===this.status||\"reloading\"===this.status}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0}deleteLayerData(t){let s=!1;for(const e of t)if(this.layerData.has(e)){const t=this.layerData.get(e);this._memoryUsedByLayerData-=t.memoryUsed,3===t.type&&this.symbols.has(e)&&(this.symbols.delete(e),s=!0),t.destroy(),this.layerData.delete(e),this.layerCount--}e(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData),s&&this.emit(\"symbols-changed\"),this.requestRender()}processed(){return this._processed}hasData(){return this.layerCount>0}dispose(){\"unloaded\"!==this.status&&(m.delete(this),d._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy(),this.status=\"unloaded\")}release(){return 0==--this._referenced&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced}get referenced(){return this._referenced}get memoryUsage(){return(this._memoryUsedByLayerData+256)/(this._referenced||1)}changeDataImpl(t){let s=!1;if(t){const a=this._createRenderBuckets(t);for(const[e,t]of a){if(this.layerData.has(e)){const s=this.layerData.get(e);this._memoryUsedByLayerData-=t.memoryUsed,s.destroy(),this.layerData.delete(e),this.layerCount--}3===t.type&&(this.symbols.set(e,t.symbols),s=!0),this._memoryUsedByLayerData+=t.memoryUsed,this.layerData.set(e,t),this.layerCount++}e(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData)}this._hasSymbolBuckets=!1;for(const[e,a]of this.layerData)3===a.type&&(this._hasSymbolBuckets=!0);s&&this.emit(\"symbols-changed\")}attachWithContext(e){this.stage={context:e,trashDisplayObject(e){e.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e,i){super.setTransform(e,i);const o=i/(e.resolution*e.pixelRatio),h=this.size[0]/this.coordRange[0]*o,n=this.size[1]/this.coordRange[1]*o,l=[0,0];e.toScreen(l,this.coords);const c=this.transforms.tileUnitsToPixels;t(c),s(c,c,l),a(c,c,Math.PI*e.rotation/180),r(c,c,[h,n,1])}static _destroyRenderBuckets(e){if(!e)return;const t=new Set;e.forEach((e=>{t.has(e)||(e.destroy(),t.add(e))})),e.clear()}_createRenderBuckets(e){const t=new Map,s=new Map;for(const a of e){const e=this._deserializeBucket(a,s);for(const s of e.layerUIDs)t.set(s,e)}return t}_deserializeBucket(e,t){let s=t.get(e);if(s)return s;switch(new Uint32Array(e)[0]){case 1:s=new l(e,this.styleRepository);break;case 2:s=new n(e,this.styleRepository);break;case 3:s=new h(e,this.styleRepository,this);break;case 4:s=new o(e,this.styleRepository)}return t.set(e,s),s}}const m=new Map;function u(){m.forEach(((e,t)=>{console.log(`\\n${t.key}:`),e[0].forEach((e=>console.log(e))),console.log(\"========\"),e[1].forEach((e=>console.log(e)))}))}export{d as VectorTile,u as printAllocations};\n"]},"metadata":{},"sourceType":"module"}