{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../chunks/tslib.es6.js\";\nimport r from \"../../../Graphic.js\";\nimport i from \"../../../core/Accessor.js\";\nimport s from \"../../../core/Collection.js\";\nimport { handlesGroup as t } from \"../../../core/handleUtils.js\";\nimport o from \"../../../core/Logger.js\";\nimport { isSome as n, isNone as l } from \"../../../core/maybe.js\";\nimport { createAbortController as a, isAbortError as u } from \"../../../core/promiseUtils.js\";\nimport { init as p } from \"../../../core/watchUtils.js\";\nimport { property as c } from \"../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../core/has.js\";\nimport \"../../../core/accessorSupport/ensureType.js\";\nimport { subclass as h } from \"../../../core/accessorSupport/decorators/subclass.js\";\nimport \"../../../layers/buildingSublayers/BuildingGroupSublayer.js\";\nimport y from \"./BuildingComponentSublayerView3D.js\";\nimport { BuildingSublayerView3DMixin as d } from \"./BuildingSublayerView3D.js\";\nimport { LayerView3D as g } from \"./LayerView3D.js\";\nimport { parseFilterMode as m } from \"./i3s/BuildingFilterUtil.js\";\nimport { checkSpatialReference as f } from \"./i3s/I3SUtil.js\";\nimport { updatingProgress as b } from \"../support/updatingProperties.js\";\nimport w from \"../../layers/BuildingSceneLayerView.js\";\nconst V = o.getLogger(\"esri.views.3d.layers.BuildingSceneLayerView3D\"),\n      j = d(i);\nlet C = class extends g(w) {\n  constructor() {\n    super(...arguments), this.type = \"building-scene-3d\", this.sublayerViews = new s(), this._abortController = a(), this._loadingComponents = 0;\n  }\n\n  get filterExpression() {\n    const e = this.layer.activeFilterId,\n          r = null != e ? this.layer.filters.find(r => r.id === e) : null,\n          i = null != r ? r.filterBlocks.find(e => \"solid\" === e.filterMode.type) : null;\n    return i ? i.filterExpression : null;\n  }\n\n  get filterExpressions() {\n    const e = this.layer.activeFilterId,\n          r = null != e ? this.layer.filters.find(r => r.id === e) : null;\n    return r && r.filterBlocks ? r.filterBlocks.toArray().map(e => [e.filterExpression, m(e)]) : [];\n  }\n\n  get updatingProgressValue() {\n    const e = this.sublayerViews,\n          r = this._loadingComponents + (e ? e.length : 0);\n    return e.reduce((e, r) => e + r.updatingProgress, 0) / r;\n  }\n\n  isUpdating() {\n    return this._loadingComponents > 0 || this.sublayerViews && this.sublayerViews.some(e => e.updating);\n  }\n\n  initialize() {\n    f(this.layer.spatialReference, this.view.spatialReference, this.view.viewingMode), this.initializeSubLayerViews(this.layer.sublayers, this);\n  }\n\n  destroy() {\n    this.sublayerViews && (this.sublayerViews.forEach(e => e.destroy()), this.sublayerViews = null), this._abortController.abort(), this._abortController = null;\n  }\n\n  initializeSubLayerViews(e, r) {\n    const i = this,\n          s = this.view;\n    e.forEach(e => {\n      if (!e.isEmpty) if (\"building-group\" === e.type) {\n        const i = new j({\n          sublayer: e,\n          view: s,\n          parent: r\n        });\n        this.initializeSubLayerViews(e.sublayers, i);\n      } else \"mesh\" === e.geometryType && (this._loadingComponents++, e.load({\n        signal: this._abortController.signal\n      }).then(() => {\n        const t = new y({\n          sublayer: e,\n          layerView: i,\n          view: s,\n          parent: r\n        });\n        this.sublayerViews.push(t), this.handles.add([p(t, \"updating\", () => this.notifyChange(\"updating\"), !0), p(t, \"updatingProgress\", () => this.notifyChange(\"updatingProgressValue\"), !0)]);\n      }).catch(r => {\n        u(r) || V.error(`Error while creating view for sublayer ${e.id}\\nLayer: ${this.layer.url}\\n`, r);\n      }).then(() => {\n        this._loadingComponents--, this.notifyChange(\"updating\"), this.notifyChange(\"updatingProgressValue\");\n      }));\n    });\n  }\n\n  getGraphicFromIntersectorMetadata(e) {\n    for (const r of this.sublayerViews.items) if (r.sublayer.uid === e.sublayerUid) return r.getGraphicFromIntersectorMetadata(e);\n\n    return null;\n  }\n\n  async fetchPopupFeatures(e, r) {\n    if (!n(r) || !r.clientGraphics || 0 === r.clientGraphics.length) return;\n\n    const i = this._findComponent(r.clientGraphics[0].sourceLayer);\n\n    return l(i) ? void 0 : i.fetchPopupFeatures(e, r);\n  }\n\n  whenGraphicBounds(e) {\n    const r = this._findComponent(e.sourceLayer);\n\n    return l(r) ? Promise.reject() : r.whenGraphicBounds(e);\n  }\n\n  _findComponent(e) {\n    return this.sublayerViews.find(r => e === r.sublayer);\n  }\n\n  highlight(e) {\n    e instanceof r ? e = [e] : e instanceof s && (e = e.toArray());\n    const i = [];\n\n    if (Array.isArray(e) && e.length > 0 && e[0] instanceof r) {\n      const r = e,\n            s = new Map();\n\n      for (const e of r) {\n        let r = s.get(e.sourceLayer);\n        null == r && (r = [], s.set(e.sourceLayer, r)), r.push(e);\n      }\n\n      this.sublayerViews.forEach(e => {\n        const r = s.get(e.sublayer);\n        r && i.push(e.highlight(r));\n      });\n    }\n\n    return t(i);\n  }\n\n  getUsedMemory() {\n    return this.sublayerViews.reduce((e, r) => e + r.getUsedMemory(), 0);\n  }\n\n  getUnloadedMemory() {\n    return this.sublayerViews.reduce((e, r) => e + r.getUnloadedMemory(), 0);\n  }\n\n  ignoresMemoryFactor() {\n    return !1;\n  }\n\n};\ne([c()], C.prototype, \"sublayerViews\", void 0), e([c({\n  readOnly: !0\n})], C.prototype, \"filterExpression\", null), e([c({\n  readOnly: !0\n})], C.prototype, \"filterExpressions\", null), e([c(b)], C.prototype, \"updatingProgress\", void 0), e([c({\n  readOnly: !0,\n  dependsOn: []\n})], C.prototype, \"updatingProgressValue\", null), C = e([h(\"esri.views.3d.layers.BuildingSceneLayerView3D\")], C);\nvar v = C;\nexport default v;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/layers/BuildingSceneLayerView3D.js"],"names":["_","e","r","i","s","handlesGroup","t","o","isSome","n","isNone","l","createAbortController","a","isAbortError","u","init","p","property","c","subclass","h","y","BuildingSublayerView3DMixin","d","LayerView3D","g","parseFilterMode","m","checkSpatialReference","f","updatingProgress","b","w","V","getLogger","j","C","constructor","arguments","type","sublayerViews","_abortController","_loadingComponents","filterExpression","layer","activeFilterId","filters","find","id","filterBlocks","filterMode","filterExpressions","toArray","map","updatingProgressValue","length","reduce","isUpdating","some","updating","initialize","spatialReference","view","viewingMode","initializeSubLayerViews","sublayers","destroy","forEach","abort","isEmpty","sublayer","parent","geometryType","load","signal","then","layerView","push","handles","add","notifyChange","catch","error","url","getGraphicFromIntersectorMetadata","items","uid","sublayerUid","fetchPopupFeatures","clientGraphics","_findComponent","sourceLayer","whenGraphicBounds","Promise","reject","highlight","Array","isArray","Map","get","set","getUsedMemory","getUnloadedMemory","ignoresMemoryFactor","prototype","readOnly","dependsOn","v"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import r from\"../../../Graphic.js\";import i from\"../../../core/Accessor.js\";import s from\"../../../core/Collection.js\";import{handlesGroup as t}from\"../../../core/handleUtils.js\";import o from\"../../../core/Logger.js\";import{isSome as n,isNone as l}from\"../../../core/maybe.js\";import{createAbortController as a,isAbortError as u}from\"../../../core/promiseUtils.js\";import{init as p}from\"../../../core/watchUtils.js\";import{property as c}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import{subclass as h}from\"../../../core/accessorSupport/decorators/subclass.js\";import\"../../../layers/buildingSublayers/BuildingGroupSublayer.js\";import y from\"./BuildingComponentSublayerView3D.js\";import{BuildingSublayerView3DMixin as d}from\"./BuildingSublayerView3D.js\";import{LayerView3D as g}from\"./LayerView3D.js\";import{parseFilterMode as m}from\"./i3s/BuildingFilterUtil.js\";import{checkSpatialReference as f}from\"./i3s/I3SUtil.js\";import{updatingProgress as b}from\"../support/updatingProperties.js\";import w from\"../../layers/BuildingSceneLayerView.js\";const V=o.getLogger(\"esri.views.3d.layers.BuildingSceneLayerView3D\"),j=d(i);let C=class extends(g(w)){constructor(){super(...arguments),this.type=\"building-scene-3d\",this.sublayerViews=new s,this._abortController=a(),this._loadingComponents=0}get filterExpression(){const e=this.layer.activeFilterId,r=null!=e?this.layer.filters.find((r=>r.id===e)):null,i=null!=r?r.filterBlocks.find((e=>\"solid\"===e.filterMode.type)):null;return i?i.filterExpression:null}get filterExpressions(){const e=this.layer.activeFilterId,r=null!=e?this.layer.filters.find((r=>r.id===e)):null;return r&&r.filterBlocks?r.filterBlocks.toArray().map((e=>[e.filterExpression,m(e)])):[]}get updatingProgressValue(){const e=this.sublayerViews,r=this._loadingComponents+(e?e.length:0);return e.reduce(((e,r)=>e+r.updatingProgress),0)/r}isUpdating(){return this._loadingComponents>0||this.sublayerViews&&this.sublayerViews.some((e=>e.updating))}initialize(){f(this.layer.spatialReference,this.view.spatialReference,this.view.viewingMode),this.initializeSubLayerViews(this.layer.sublayers,this)}destroy(){this.sublayerViews&&(this.sublayerViews.forEach((e=>e.destroy())),this.sublayerViews=null),this._abortController.abort(),this._abortController=null}initializeSubLayerViews(e,r){const i=this,s=this.view;e.forEach((e=>{if(!e.isEmpty)if(\"building-group\"===e.type){const i=new j({sublayer:e,view:s,parent:r});this.initializeSubLayerViews(e.sublayers,i)}else\"mesh\"===e.geometryType&&(this._loadingComponents++,e.load({signal:this._abortController.signal}).then((()=>{const t=new y({sublayer:e,layerView:i,view:s,parent:r});this.sublayerViews.push(t),this.handles.add([p(t,\"updating\",(()=>this.notifyChange(\"updating\")),!0),p(t,\"updatingProgress\",(()=>this.notifyChange(\"updatingProgressValue\")),!0)])})).catch((r=>{u(r)||V.error(`Error while creating view for sublayer ${e.id}\\nLayer: ${this.layer.url}\\n`,r)})).then((()=>{this._loadingComponents--,this.notifyChange(\"updating\"),this.notifyChange(\"updatingProgressValue\")})))}))}getGraphicFromIntersectorMetadata(e){for(const r of this.sublayerViews.items)if(r.sublayer.uid===e.sublayerUid)return r.getGraphicFromIntersectorMetadata(e);return null}async fetchPopupFeatures(e,r){if(!n(r)||!r.clientGraphics||0===r.clientGraphics.length)return;const i=this._findComponent(r.clientGraphics[0].sourceLayer);return l(i)?void 0:i.fetchPopupFeatures(e,r)}whenGraphicBounds(e){const r=this._findComponent(e.sourceLayer);return l(r)?Promise.reject():r.whenGraphicBounds(e)}_findComponent(e){return this.sublayerViews.find((r=>e===r.sublayer))}highlight(e){e instanceof r?e=[e]:e instanceof s&&(e=e.toArray());const i=[];if(Array.isArray(e)&&e.length>0&&e[0]instanceof r){const r=e,s=new Map;for(const e of r){let r=s.get(e.sourceLayer);null==r&&(r=[],s.set(e.sourceLayer,r)),r.push(e)}this.sublayerViews.forEach((e=>{const r=s.get(e.sublayer);r&&i.push(e.highlight(r))}))}return t(i)}getUsedMemory(){return this.sublayerViews.reduce(((e,r)=>e+r.getUsedMemory()),0)}getUnloadedMemory(){return this.sublayerViews.reduce(((e,r)=>e+r.getUnloadedMemory()),0)}ignoresMemoryFactor(){return!1}};e([c()],C.prototype,\"sublayerViews\",void 0),e([c({readOnly:!0})],C.prototype,\"filterExpression\",null),e([c({readOnly:!0})],C.prototype,\"filterExpressions\",null),e([c(b)],C.prototype,\"updatingProgress\",void 0),e([c({readOnly:!0,dependsOn:[]})],C.prototype,\"updatingProgressValue\",null),C=e([h(\"esri.views.3d.layers.BuildingSceneLayerView3D\")],C);var v=C;export default v;\n"]},"metadata":{},"sourceType":"module"}