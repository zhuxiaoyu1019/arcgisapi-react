{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../chunks/tslib.es6.js\";\nimport t from \"../../../core/Error.js\";\nimport { isSome as r } from \"../../../core/maybe.js\";\nimport { init as s, whenFalse as i } from \"../../../core/watchUtils.js\";\nimport { property as o } from \"../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../core/has.js\";\nimport \"../../../core/accessorSupport/ensureType.js\";\nimport \"../../../core/Logger.js\";\nimport { subclass as a } from \"../../../core/accessorSupport/decorators/subclass.js\";\nimport { hydrateGeometry as l } from \"../../../layers/graphics/hydratedFeatures.js\";\nimport { FeatureTileController3D as u } from \"../../../layers/graphics/controllers/FeatureTileController3D.js\";\nimport { FeatureLikeLayerView3D as n } from \"./FeatureLikeLayerView3D.js\";\nimport { LayerView3D as c } from \"./LayerView3D.js\";\nimport { FeatureTileFetcher3DLayerViewContext as p } from \"./support/FeatureTileFetcher3DLayerViewContext.js\";\nimport { EventedSet as h } from \"../support/EventedSet.js\";\nimport { updatingProgress as m } from \"../support/updatingProperties.js\";\nimport { FeatureLayerView as d } from \"../../layers/FeatureLayerView.js\";\nimport y from \"../../layers/LayerView.js\";\nimport { RefreshableLayerView as g } from \"../../layers/RefreshableLayerView.js\";\nlet f = class extends g(n(d(c(y)))) {\n  constructor(e) {\n    super(e), this._controllerTotal = 0, this._graphicsCoreTotal = 0, this.suspendResumeExtentMode = \"data\";\n  }\n\n  initialize() {\n    this.updatingHandles.add(this, \"view.floors\", () => this.graphics3d.filterVisibility.filterChanged());\n  }\n\n  destroy() {\n    this.fetcherContext && (this.fetcherContext.destroy(), this.fetcherContext = null);\n  }\n\n  get maximumNumberOfFeatures() {\n    var e, t;\n    return null != (e = null == (t = this.controller) ? void 0 : t.maximumNumberOfFeatures) ? e : this._get(\"maximumNumberOfFeatures\");\n  }\n\n  set maximumNumberOfFeatures(e) {\n    this._set(\"maximumNumberOfFeatures\", e), this.controller && (this.controller.maximumNumberOfFeatures = e);\n  }\n\n  get maximumNumberOfFeaturesExceeded() {\n    return !!this.controller && !(this.suspended || !this.controller.maximumNumberOfFeaturesExceeded);\n  }\n\n  get updatingProgressValue() {\n    var e, t, r;\n    let s = 0;\n\n    if (null != (e = this.controller) && e.updating) {\n      const e = this.controller.updatingRemaining,\n            t = Math.max(this.controller.updatingTotal, this._controllerTotal);\n      t > 0 && (s = (t - e) / t, this._controllerTotal = t);\n    }\n\n    let i = 0;\n\n    if (null != (t = this.graphics3d) && null != (r = t.graphicsCore) && r.updating) {\n      const e = this.graphics3d.graphicsCore.updatingRemaining,\n            t = Math.max(e, this._graphicsCoreTotal);\n      t > 0 && (i = (t - e) / t, this._graphicsCoreTotal = t);\n    }\n\n    return .5 * (s + i);\n  }\n\n  get updatePolicy() {\n    if (!this.controller) return 0;\n\n    switch (this.controller.mode) {\n      case \"snapshot\":\n        {\n          const e = F[this.layer.geometryType];\n          return null == e || this.controller.serviceDataCount > e ? 0 : 1;\n        }\n\n      case \"tiles\":\n        return 0;\n    }\n  }\n\n  get hasZ() {\n    const e = this.layer,\n          t = e.capabilities && e.capabilities.data;\n    return !(!t || !t.supportsZ) && (\"returnZ\" in e && null != e.returnZ ? e.returnZ : t.supportsZ);\n  }\n\n  get hasM() {\n    const e = this.layer,\n          t = e.capabilities && e.capabilities.data;\n    return !(!t || !t.supportsM) && \"returnM\" in e && null != e.returnM && e.returnM;\n  }\n\n  async fetchPopupFeatures(e, t) {\n    const r = this.validateFetchPopupFeatures(t);\n    return r ? Promise.reject(r) : this.fetchClientPopupFeatures(t);\n  }\n\n  setVisibility(e, t) {\n    this.graphics3d && this.graphics3d.graphicsCore.setObjectIdVisibility(e, t);\n  }\n\n  createQuery() {\n    return super.createQuery();\n  }\n\n  queryFeatures(e, t) {\n    const r = () => super.queryFeatures(e, t);\n\n    return \"mesh\" === this.layer.geometryType ? this._queryFeaturesMesh(this._ensureQuery(e), r) : r();\n  }\n\n  beforeSetController(e) {\n    e.maximumNumberOfFeatures = this.maximumNumberOfFeatures;\n  }\n\n  createController() {\n    this.fetcherContext = new p({\n      layerView: this,\n      returnZ: this.hasZ,\n      returnM: this.hasM\n    });\n    const e = new u({\n      layerView: this,\n      context: this.fetcherContext,\n      graphics: new h(),\n      extent: this.clippingExtent\n    });\n    return this.updatingHandles.add(e, \"serviceDataExtent\", e => {\n      this.graphics3d && (this.graphics3d.dataExtent = e);\n    }, 2), this.handles.add(s(this, \"suspended\", t => {\n      t ? e.suspend() : e.resume();\n    }, !0)), this.updatingHandles.add(this.graphics3d.graphicsCore, \"displayFeatureLimit\", () => this.updateDisplayFeatureLimit(e), 2), this.handles.add([this.view.resourceController.memoryController.events.on(\"quality-changed\", () => this.updateDisplayFeatureLimit()), i(this, \"updating\", () => {\n      this._controllerTotal = 0, this._graphicsCoreTotal = 0, this.notifyChange(\"updatingProgressValue\");\n    })]), e;\n  }\n\n  async doRefresh() {\n    !this.suspended && this.controller && this.controller.refetch();\n  }\n\n  getUsedMemory() {\n    const e = this.graphics3d && this.graphics3d.graphicsCore;\n    return (e ? e.usedMemory : 0) + (this.controller ? this.controller.memoryForUnusedFeatures : 0);\n  }\n\n  getUnloadedMemory() {\n    const e = this.graphics3d && this.graphics3d.graphicsCore;\n    return (e ? e.unprocessedMemoryEstimate : 0) + (this.controller ? this.controller.expectedFeatureDiff * e.usedMemoryPerGraphic : 0);\n  }\n\n  ignoresMemoryFactor() {\n    return this.controller && this.controller.hasMaximumNumberOfFeaturesOverride;\n  }\n\n  updateDisplayFeatureLimit(e = this.controller) {\n    if (!e || !this.graphics3d || !this.graphics3d.graphicsCore) return;\n    const t = this.graphics3d.graphicsCore.displayFeatureLimit,\n          r = this.view.resourceController.memoryController.memoryFactor;\n    if (1 === r) e.displayFeatureLimit = t;else {\n      const s = Math.ceil(t.maximumNumberOfFeatures * r),\n            i = Math.ceil(t.maximumTotalNumberOfFeatures * r),\n            o = Math.ceil(t.minimumTotalNumberOfFeatures * r);\n      e.displayFeatureLimit = { ...t,\n        maximumNumberOfFeatures: s,\n        maximumTotalNumberOfFeatures: i,\n        minimumTotalNumberOfFeatures: o\n      };\n    }\n  }\n\n  async _queryFeaturesMesh(e, t) {\n    await this._validateQueryFeaturesMesh(e);\n    const r = await t();\n    if (e && e.outStatistics) return r;\n    const s = this.layer.objectIdField,\n          i = this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID,\n          o = [];\n\n    for (const a of r.features) if (a.geometry) {\n      const e = i.get(a.attributes[s]);\n      e && (a.geometry = l(e.graphic.geometry), o.push(a));\n    } else o.push(a);\n\n    return r.features = o, r;\n  }\n\n  async _validateQueryFeaturesMesh(e) {\n    if (!e) return;\n\n    const s = e => {\n      throw new t(\"feature-layer-view:unsupported-query\", `Queries on Mesh feature collection layers do not support '${e}'`);\n    },\n          i = [\"quantizationParameters\", \"geometryPrecision\", \"maxAllowableOffset\"];\n\n    for (const t of i) null != e[t] && s(t);\n\n    \"returnM\" in e && e.returnM && s(\"returnM\"), \"returnCentroid\" in e && e.returnCentroid && s(\"returnCentroid\"), r(e.outSpatialReference) && !e.outSpatialReference.equals(this.view.spatialReference) && s(\"outSpatialReference\");\n  }\n\n  get performanceInfo() {\n    const e = this.controller && this.controller.displayFeatureLimit,\n          t = r(e) && e.averageSymbolComplexity,\n          s = r(t) ? `f:${t.primitivesPerFeature},v:${t.primitivesPerCoordinate}` : \"n/a\",\n          i = { ...this._getResourceInfo(),\n      storedFeatures: 0,\n      totalVertices: 0,\n      partial: this.maximumNumberOfFeaturesExceeded,\n      mode: this.controller ? this.controller.mode : \"n/a\",\n      symbolComplexity: s,\n      nodes: this.controller ? this.controller.tileDescriptors.length : 0\n    };\n\n    if (this.controller && i.displayedNumberOfFeatures) {\n      const e = this.controller.debug;\n      i.storedFeatures = e.storedFeatures, i.totalVertices = e.totalVertices;\n    }\n\n    return i;\n  }\n\n  get test() {\n    return {\n      updatePolicy: this.updatePolicy,\n      controller: this.controller\n    };\n  }\n\n};\ne([o()], f.prototype, \"layer\", void 0), e([o()], f.prototype, \"controller\", void 0), e([o()], f.prototype, \"maximumNumberOfFeatures\", null), e([o()], f.prototype, \"maximumNumberOfFeaturesExceeded\", null), e([o(m)], f.prototype, \"updatingProgress\", void 0), e([o({\n  readOnly: !0,\n  dependsOn: [\"controller.updatingRemaining\", \"controller.updatingTotal\", \"graphics3d.graphicsCore.updatingRemaining\"]\n})], f.prototype, \"updatingProgressValue\", null), e([o({\n  readOnly: !0\n})], f.prototype, \"updatePolicy\", null), e([o({\n  readOnly: !0\n})], f.prototype, \"hasZ\", null), e([o({\n  readOnly: !0\n})], f.prototype, \"hasM\", null), e([o()], f.prototype, \"suspendResumeExtentMode\", void 0), f = e([a(\"esri.views.3d.layers.FeatureLayerViewBase3D\")], f);\nconst F = {\n  point: 5e3,\n  polygon: 500,\n  polyline: 1e3\n};\nvar x = f;\nexport default x;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/layers/FeatureLayerViewBase3D.js"],"names":["_","e","t","isSome","r","init","s","whenFalse","i","property","o","subclass","a","hydrateGeometry","l","FeatureTileController3D","u","FeatureLikeLayerView3D","n","LayerView3D","c","FeatureTileFetcher3DLayerViewContext","p","EventedSet","h","updatingProgress","m","FeatureLayerView","d","y","RefreshableLayerView","g","f","constructor","_controllerTotal","_graphicsCoreTotal","suspendResumeExtentMode","initialize","updatingHandles","add","graphics3d","filterVisibility","filterChanged","destroy","fetcherContext","maximumNumberOfFeatures","controller","_get","_set","maximumNumberOfFeaturesExceeded","suspended","updatingProgressValue","updating","updatingRemaining","Math","max","updatingTotal","graphicsCore","updatePolicy","mode","F","layer","geometryType","serviceDataCount","hasZ","capabilities","data","supportsZ","returnZ","hasM","supportsM","returnM","fetchPopupFeatures","validateFetchPopupFeatures","Promise","reject","fetchClientPopupFeatures","setVisibility","setObjectIdVisibility","createQuery","queryFeatures","_queryFeaturesMesh","_ensureQuery","beforeSetController","createController","layerView","context","graphics","extent","clippingExtent","dataExtent","handles","suspend","resume","updateDisplayFeatureLimit","view","resourceController","memoryController","events","on","notifyChange","doRefresh","refetch","getUsedMemory","usedMemory","memoryForUnusedFeatures","getUnloadedMemory","unprocessedMemoryEstimate","expectedFeatureDiff","usedMemoryPerGraphic","ignoresMemoryFactor","hasMaximumNumberOfFeaturesOverride","displayFeatureLimit","memoryFactor","ceil","maximumTotalNumberOfFeatures","minimumTotalNumberOfFeatures","_validateQueryFeaturesMesh","outStatistics","objectIdField","graphics3DGraphicsByObjectID","features","geometry","get","attributes","graphic","push","returnCentroid","outSpatialReference","equals","spatialReference","performanceInfo","averageSymbolComplexity","primitivesPerFeature","primitivesPerCoordinate","_getResourceInfo","storedFeatures","totalVertices","partial","symbolComplexity","nodes","tileDescriptors","length","displayedNumberOfFeatures","debug","test","prototype","readOnly","dependsOn","point","polygon","polyline","x"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import t from\"../../../core/Error.js\";import{isSome as r}from\"../../../core/maybe.js\";import{init as s,whenFalse as i}from\"../../../core/watchUtils.js\";import{property as o}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import\"../../../core/Logger.js\";import{subclass as a}from\"../../../core/accessorSupport/decorators/subclass.js\";import{hydrateGeometry as l}from\"../../../layers/graphics/hydratedFeatures.js\";import{FeatureTileController3D as u}from\"../../../layers/graphics/controllers/FeatureTileController3D.js\";import{FeatureLikeLayerView3D as n}from\"./FeatureLikeLayerView3D.js\";import{LayerView3D as c}from\"./LayerView3D.js\";import{FeatureTileFetcher3DLayerViewContext as p}from\"./support/FeatureTileFetcher3DLayerViewContext.js\";import{EventedSet as h}from\"../support/EventedSet.js\";import{updatingProgress as m}from\"../support/updatingProperties.js\";import{FeatureLayerView as d}from\"../../layers/FeatureLayerView.js\";import y from\"../../layers/LayerView.js\";import{RefreshableLayerView as g}from\"../../layers/RefreshableLayerView.js\";let f=class extends(g(n(d(c(y))))){constructor(e){super(e),this._controllerTotal=0,this._graphicsCoreTotal=0,this.suspendResumeExtentMode=\"data\"}initialize(){this.updatingHandles.add(this,\"view.floors\",(()=>this.graphics3d.filterVisibility.filterChanged()))}destroy(){this.fetcherContext&&(this.fetcherContext.destroy(),this.fetcherContext=null)}get maximumNumberOfFeatures(){var e,t;return null!=(e=null==(t=this.controller)?void 0:t.maximumNumberOfFeatures)?e:this._get(\"maximumNumberOfFeatures\")}set maximumNumberOfFeatures(e){this._set(\"maximumNumberOfFeatures\",e),this.controller&&(this.controller.maximumNumberOfFeatures=e)}get maximumNumberOfFeaturesExceeded(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)}get updatingProgressValue(){var e,t,r;let s=0;if(null!=(e=this.controller)&&e.updating){const e=this.controller.updatingRemaining,t=Math.max(this.controller.updatingTotal,this._controllerTotal);t>0&&(s=(t-e)/t,this._controllerTotal=t)}let i=0;if(null!=(t=this.graphics3d)&&null!=(r=t.graphicsCore)&&r.updating){const e=this.graphics3d.graphicsCore.updatingRemaining,t=Math.max(e,this._graphicsCoreTotal);t>0&&(i=(t-e)/t,this._graphicsCoreTotal=t)}return.5*(s+i)}get updatePolicy(){if(!this.controller)return 0;switch(this.controller.mode){case\"snapshot\":{const e=F[this.layer.geometryType];return null==e||this.controller.serviceDataCount>e?0:1}case\"tiles\":return 0}}get hasZ(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsZ)&&(\"returnZ\"in e&&null!=e.returnZ?e.returnZ:t.supportsZ)}get hasM(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsM)&&(\"returnM\"in e&&null!=e.returnM&&e.returnM)}async fetchPopupFeatures(e,t){const r=this.validateFetchPopupFeatures(t);return r?Promise.reject(r):this.fetchClientPopupFeatures(t)}setVisibility(e,t){this.graphics3d&&this.graphics3d.graphicsCore.setObjectIdVisibility(e,t)}createQuery(){return super.createQuery()}queryFeatures(e,t){const r=()=>super.queryFeatures(e,t);return\"mesh\"===this.layer.geometryType?this._queryFeaturesMesh(this._ensureQuery(e),r):r()}beforeSetController(e){e.maximumNumberOfFeatures=this.maximumNumberOfFeatures}createController(){this.fetcherContext=new p({layerView:this,returnZ:this.hasZ,returnM:this.hasM});const e=new u({layerView:this,context:this.fetcherContext,graphics:new h,extent:this.clippingExtent});return this.updatingHandles.add(e,\"serviceDataExtent\",(e=>{this.graphics3d&&(this.graphics3d.dataExtent=e)}),2),this.handles.add(s(this,\"suspended\",(t=>{t?e.suspend():e.resume()}),!0)),this.updatingHandles.add(this.graphics3d.graphicsCore,\"displayFeatureLimit\",(()=>this.updateDisplayFeatureLimit(e)),2),this.handles.add([this.view.resourceController.memoryController.events.on(\"quality-changed\",(()=>this.updateDisplayFeatureLimit())),i(this,\"updating\",(()=>{this._controllerTotal=0,this._graphicsCoreTotal=0,this.notifyChange(\"updatingProgressValue\")}))]),e}async doRefresh(){!this.suspended&&this.controller&&this.controller.refetch()}getUsedMemory(){const e=this.graphics3d&&this.graphics3d.graphicsCore;return(e?e.usedMemory:0)+(this.controller?this.controller.memoryForUnusedFeatures:0)}getUnloadedMemory(){const e=this.graphics3d&&this.graphics3d.graphicsCore;return(e?e.unprocessedMemoryEstimate:0)+(this.controller?this.controller.expectedFeatureDiff*e.usedMemoryPerGraphic:0)}ignoresMemoryFactor(){return this.controller&&this.controller.hasMaximumNumberOfFeaturesOverride}updateDisplayFeatureLimit(e=this.controller){if(!e||!this.graphics3d||!this.graphics3d.graphicsCore)return;const t=this.graphics3d.graphicsCore.displayFeatureLimit,r=this.view.resourceController.memoryController.memoryFactor;if(1===r)e.displayFeatureLimit=t;else{const s=Math.ceil(t.maximumNumberOfFeatures*r),i=Math.ceil(t.maximumTotalNumberOfFeatures*r),o=Math.ceil(t.minimumTotalNumberOfFeatures*r);e.displayFeatureLimit={...t,maximumNumberOfFeatures:s,maximumTotalNumberOfFeatures:i,minimumTotalNumberOfFeatures:o}}}async _queryFeaturesMesh(e,t){await this._validateQueryFeaturesMesh(e);const r=await t();if(e&&e.outStatistics)return r;const s=this.layer.objectIdField,i=this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID,o=[];for(const a of r.features)if(a.geometry){const e=i.get(a.attributes[s]);e&&(a.geometry=l(e.graphic.geometry),o.push(a))}else o.push(a);return r.features=o,r}async _validateQueryFeaturesMesh(e){if(!e)return;const s=e=>{throw new t(\"feature-layer-view:unsupported-query\",`Queries on Mesh feature collection layers do not support '${e}'`)},i=[\"quantizationParameters\",\"geometryPrecision\",\"maxAllowableOffset\"];for(const t of i)null!=e[t]&&s(t);\"returnM\"in e&&e.returnM&&s(\"returnM\"),\"returnCentroid\"in e&&e.returnCentroid&&s(\"returnCentroid\"),r(e.outSpatialReference)&&!e.outSpatialReference.equals(this.view.spatialReference)&&s(\"outSpatialReference\")}get performanceInfo(){const e=this.controller&&this.controller.displayFeatureLimit,t=r(e)&&e.averageSymbolComplexity,s=r(t)?`f:${t.primitivesPerFeature},v:${t.primitivesPerCoordinate}`:\"n/a\",i={...this._getResourceInfo(),storedFeatures:0,totalVertices:0,partial:this.maximumNumberOfFeaturesExceeded,mode:this.controller?this.controller.mode:\"n/a\",symbolComplexity:s,nodes:this.controller?this.controller.tileDescriptors.length:0};if(this.controller&&i.displayedNumberOfFeatures){const e=this.controller.debug;i.storedFeatures=e.storedFeatures,i.totalVertices=e.totalVertices}return i}get test(){return{updatePolicy:this.updatePolicy,controller:this.controller}}};e([o()],f.prototype,\"layer\",void 0),e([o()],f.prototype,\"controller\",void 0),e([o()],f.prototype,\"maximumNumberOfFeatures\",null),e([o()],f.prototype,\"maximumNumberOfFeaturesExceeded\",null),e([o(m)],f.prototype,\"updatingProgress\",void 0),e([o({readOnly:!0,dependsOn:[\"controller.updatingRemaining\",\"controller.updatingTotal\",\"graphics3d.graphicsCore.updatingRemaining\"]})],f.prototype,\"updatingProgressValue\",null),e([o({readOnly:!0})],f.prototype,\"updatePolicy\",null),e([o({readOnly:!0})],f.prototype,\"hasZ\",null),e([o({readOnly:!0})],f.prototype,\"hasM\",null),e([o()],f.prototype,\"suspendResumeExtentMode\",void 0),f=e([a(\"esri.views.3d.layers.FeatureLayerViewBase3D\")],f);const F={point:5e3,polygon:500,polyline:1e3};var x=f;export default x;\n"]},"metadata":{},"sourceType":"module"}