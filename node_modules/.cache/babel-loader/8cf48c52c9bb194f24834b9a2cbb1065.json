{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../chunks/tslib.es6.js\";\nimport t from \"../../../Color.js\";\nimport r from \"../../../core/Evented.js\";\nimport i from \"../../../core/Handles.js\";\nimport { isSome as s, isNone as n, mapOr as o } from \"../../../core/maybe.js\";\nimport { after as a } from \"../../../core/promiseUtils.js\";\nimport { init as c } from \"../../../core/watchUtils.js\";\nimport { property as h } from \"../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../core/has.js\";\nimport \"../../../core/accessorSupport/ensureType.js\";\nimport \"../../../core/Logger.js\";\nimport { subclass as d } from \"../../../core/accessorSupport/decorators/subclass.js\";\nimport { s as l, a as p, g as _, e as m } from \"../../../chunks/vec3.js\";\nimport { c as f, f as u } from \"../../../chunks/vec3f64.js\";\nimport { b as P, f as g } from \"../../../chunks/vec4f64.js\";\nimport { canProjectToWGS84ComparableLonLat as v, projectPointToWGS84ComparableLonLat as b } from \"../../../geometry/projection.js\";\nimport { isEarth as C } from \"../../../geometry/support/spatialReferenceUtils.js\";\nimport w from \"./EnvironmentRenderer.js\";\nimport { positionToTimezoneInfo as U } from \"../support/earthUtils.js\";\nimport { computeColorAndIntensity as y, computeDirection as T, computeShadowsEnabled as R } from \"../support/sunUtils.js\";\nimport { MainLight as S, AmbientLight as M, FillLight as H } from \"../webgl-engine/lighting/Lightsources.js\";\nimport G from \"../../../webscene/background/ColorBackground.js\";\nconst L = u(.5773502691896258, -.5773502691896258, .5773502691896258);\nlet W = class extends r.EventedAccessor {\n  constructor(...e) {\n    super(...e), this._referencePointUpdateDelay = 200, this._referencePointUpdateInterval = 3e3, this._referencePointUpdateDistThreshold = 1e6, this._referencePosUpdateQuery = null, this._referencePosMapCoordsRequested = null, this._viewHandles = new i(), this._preserveAbsoluteDateTime = !1, this._trackingEnabled = !1, this._referencePosResetPreserveAbsoluteTime = !1, this.referencePosUpdateTimer = null, this._referencePosMapCoords = null, this._mainLight = new S(), this._ambientLight = new M(), this._moonLight = new H(), this._renderer = null, this._referencePosWGS84Comparable = null, this._resetReferencePosition();\n  }\n\n  destroy() {\n    this.disconnectView(), this._viewHandles.destroy();\n  }\n\n  get updating() {\n    return !!(!this.disableQueries && (this._referencePosUpdateQuery || this._referencePosMapCoordsRequested) || this._renderer && this._renderer.updating);\n  }\n\n  get referencePositionWGS84Comparable() {\n    return this._referencePosWGS84Comparable;\n  }\n\n  connectView(e) {\n    this._renderer || (this._view = e, this._renderer = new w({\n      view: e\n    }), this._viewHandles.add([e.watch(\"environment.lighting.date\", e => this._lightingDateHandler(e), !0), e.watch(\"stationary\", () => this._interactingStationaryHandler()), e.watch([\"environment.lighting.directShadowsEnabled\", \"environment.lighting.ambientOcclusionEnabled\", \"environment.lighting.waterReflectionEnabled\", \"environment.background.color\"], () => this._updateRenderParamsHandler(), !0), e.watch(\"spatialReference\", () => this._resetReferencePosition(!0), !0), c(e, \"viewingMode\", () => this._resetReferencePosition(!0), !0), c(e, \"environment.lighting.cameraTrackingEnabled\", e => this._updateCameraTracking(e), !0), c(e, \"state.camera\", () => this._cameraHandler(null), !0), this.watch(\"disableQueries\", () => this._cameraHandler(null))]), this._updateRenderParamsHandler(), this._updateLightParams(), this._cameraHandler(), this.notifyChange(\"updating\"));\n  }\n\n  disconnectView() {\n    this._renderer && (this._viewHandles.removeAll(), this._resetReferencePosition(), this._renderer.destroy(), this._renderer = null, this._view = null);\n  }\n\n  _updateCameraTracking(e) {\n    if (this._trackingEnabled = e, e) this._cameraHandler();else {\n      const e = this._view.environment.lighting;\n      e && (e.positionTimezoneInfo.autoUpdated = !1);\n    }\n  }\n\n  _lightingDateHandler(e) {\n    if (!e) return;\n    const t = this._view.environment.lighting;\n\n    if (!t.positionTimezoneInfo.autoUpdated) {\n      this._preserveAbsoluteDateTime = !0;\n      const r = this._view.spatialReference;\n\n      if (!v(r)) {\n        const e = this._view.camera.position;\n        if (!this._referencePosMapCoords || !this._referencePosMapCoords.equals(e)) return void this._requestReferencePositionUpdate(e);\n      }\n\n      if (this._preupdateTracking(e), s(this._referencePosWGS84Comparable)) {\n        const e = U(this._referencePosWGS84Comparable, k);\n        s(e) && (t.autoUpdate(null, e), this._trackingEnabled && (t.positionTimezoneInfo.autoUpdated = !0));\n      }\n    }\n\n    this._updateLightParams(e);\n  }\n\n  _preupdateTracking(e) {\n    !this._trackingEnabled && this._view.environment.lighting.cameraTrackingEnabled && this._cameraHandler(e);\n  }\n\n  _cameraHandler(e = null) {\n    if (!this._view.ready) return;\n    const t = this._view.camera;\n    t && (this._cameraHandlerClientSide(t, e) || this._cameraHandlerServerSide(t));\n  }\n\n  _cameraHandlerClientSide(e, t) {\n    const r = C(this._view.spatialReference);\n    if (r && !v(this._view.spatialReference)) return !1;\n    const i = e.position;\n    return n(this._referencePosWGS84Comparable) && (this._referencePosWGS84Comparable = f()), r ? b(i, this._referencePosWGS84Comparable) : l(this._referencePosWGS84Comparable, i.longitude, i.latitude, i.z), this.notifyChange(\"referencePositionWGS84Comparable\"), this._autoUpdateTimezone(this._referencePosWGS84Comparable, t) || this._updateLightParams(t), !0;\n  }\n\n  _cameraHandlerServerSide(e) {\n    const t = e.position;\n    (!this._referencePosMapCoords || this._referencePosMapCoordsRequested || this._exceedsReferencePosDistThreshold(t)) && this._requestReferencePositionUpdate(t, !0), this._view.mapCoordsHelper && this._referencePosWGS84Comparable && (this._referencePosWGS84Comparable[2] = t.z * this._view.mapCoordsHelper.unitInMeters, this._referencePosChanged());\n  }\n\n  _interactingStationaryHandler() {\n    this._view.stationary && this._executePendingReferencePositionUpdate();\n  }\n\n  _updateLightParams(e) {\n    const t = this._view.environment.lighting;\n    e = e || t.date;\n    const r = this._view._stage;\n    let i;\n    s(this._referencePosWGS84Comparable) ? (i = y(e, this._referencePosWGS84Comparable), T(e, this._referencePosWGS84Comparable, this._view.viewingMode, i.diffuse.directionToLightSource)) : i = {\n      diffuse: {\n        color: [1, 1, 1],\n        intensity: .55,\n        directionToLightSource: L\n      },\n      ambient: {\n        color: [1, 1, 1],\n        intensity: .55\n      },\n      noonFactor: .5,\n      globalFactor: 0\n    }, p(this._mainLight.intensity, i.diffuse.color, i.diffuse.intensity * Math.PI), _(this._mainLight.direction, i.diffuse.directionToLightSource), p(this._ambientLight.intensity, i.ambient.color, i.ambient.intensity), m(this._moonLight.intensity, E, D, i.globalFactor);\n    const n = (1 - .5 * i.globalFactor) * (1 - .4 * i.noonFactor * (1 - i.globalFactor));\n    p(this._moonLight.intensity, this._moonLight.intensity, n), _(this._moonLight.direction, i.diffuse.directionToLightSource), r.renderView.updateLightSources([this._mainLight, this._ambientLight, this._moonLight], 1 - i.noonFactor, i.globalFactor), this._updateRenderParamsHandler();\n  }\n\n  _autoUpdateTimezone(e, t = null) {\n    if (!this._view.environment.lighting.cameraTrackingEnabled || n(e)) return !1;\n    const r = j;\n    r.setTime((t || this._view.environment.lighting.date).getTime());\n    const i = U(e, k);\n    if (n(i)) return !1;\n    let s = this._view.environment.lighting.positionTimezoneInfo;\n\n    if (s.autoUpdated) {\n      if (s.hours === i.hours && s.minutes === i.minutes && s.seconds === i.seconds) return !1;\n    } else s = i;\n\n    const o = r.getUTCHours() - (i.hours - s.hours),\n          a = r.getUTCMinutes() - (i.minutes - s.minutes),\n          c = r.getUTCSeconds() - (i.seconds - s.seconds);\n    return r.setUTCHours(o), r.setUTCMinutes(a), r.setUTCSeconds(c), !t && this._view.environment.lighting.autoUpdate(r, i);\n  }\n\n  _updateRenderParamsHandler() {\n    const e = this._view._stage;\n    if (!e) return;\n    const r = o(this._referencePosWGS84Comparable, !0, e => R(e, this._view.viewingMode)),\n          i = this._view.environment.background,\n          s = i instanceof G ? {\n      type: \"color\",\n      color: P(t.toUnitRGBA(i.color))\n    } : {\n      type: \"color\",\n      color: g(0, 0, 0, 1)\n    };\n    e.renderView.setRenderParameters({\n      shadowMap: this._view.environment.lighting.directShadowsEnabled && r,\n      ssao: this._view.environment.lighting.ambientOcclusionEnabled,\n      waterReflectionEnabled: this._view.environment.lighting.waterReflectionEnabled,\n      background: s\n    });\n  }\n\n  _resetReferencePosition(e = !1) {\n    this._cancelReferencePosUpdates(), this._referencePosMapCoords = null, this._referencePosMapCoordsRequested = null, this._referencePosResetPreserveAbsoluteTime = null, this._referencePosWGS84Comparable = null, this.notifyChange(\"updating\"), e && this._cameraHandler(null);\n  }\n\n  _requestReferencePositionUpdate(e, t = !1) {\n    if (!this.disableQueries && (this._referencePosMapCoordsRequested ? this._referencePosMapCoordsRequested.copy(e) : this._referencePosMapCoordsRequested = e.clone(), this._referencePosResetPreserveAbsoluteTime = !!t, !this._referencePosUpdateQuery && !this.referencePosUpdateTimer && this._view.stationary)) {\n      const e = this._referencePosUpdateQuery = a(this._referencePointUpdateDelay).then(() => {\n        if (this._referencePosUpdateQuery === e) {\n          const t = () => this._referencePosUpdateQuery !== e;\n\n          return this._doReferencePositionUpdateQuery(t);\n        }\n      }).catch(e => {\n        \"mapcoordshelper:missing-geometry-service\" === e.name && (this.disableQueries = !0);\n      }).then(() => {\n        this._referencePosUpdateQuery === e && (this._referencePosUpdateQuery = null, this.referencePosUpdateTimer || this._executePendingReferencePositionUpdate(), this.notifyChange(\"updating\"));\n      }),\n            t = this.referencePosUpdateTimer = a(this._referencePointUpdateInterval).then(() => {\n        this.referencePosUpdateTimer === t && (this.referencePosUpdateTimer = null, this._referencePosUpdateQuery || this._executePendingReferencePositionUpdate());\n      });\n      this.notifyChange(\"updating\");\n    }\n  }\n\n  async _doReferencePositionUpdateQuery(e) {\n    this._referencePosResetPreserveAbsoluteTime && (this._preserveAbsoluteDateTime = !1), this._referencePosMapCoords ? this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested) : this._referencePosMapCoords = this._referencePosMapCoordsRequested.clone(), this._referencePosResetPreserveAbsoluteTime = null, this._referencePosMapCoordsRequested = null;\n    const t = await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);\n\n    if (!e() && !isNaN(t[0]) && !isNaN(t[1])) {\n      const e = this._referencePosMapCoords.z * this._view.mapCoordsHelper.unitInMeters;\n      this._referencePosWGS84Comparable ? (this._referencePosWGS84Comparable[0] = t[0], this._referencePosWGS84Comparable[1] = t[1], this._referencePosWGS84Comparable[2] = e) : this._referencePosWGS84Comparable = [t[0], t[1], e], this._referencePosChanged();\n    }\n  }\n\n  _executePendingReferencePositionUpdate() {\n    const e = this._referencePosMapCoordsRequested;\n    e && this._requestReferencePositionUpdate(e, this._referencePosResetPreserveAbsoluteTime);\n  }\n\n  _referencePosChanged() {\n    this._preserveAbsoluteDateTime ? this._updateLightParams() : this._autoUpdateTimezone(this._referencePosWGS84Comparable) || this._updateLightParams(), this.notifyChange(\"referencePositionWGS84Comparable\");\n  }\n\n  _exceedsReferencePosDistThreshold(e) {\n    if (this._referencePosMapCoords) {\n      let t = this._referencePosMapCoords.distance(e);\n\n      return this._view.mapCoordsHelper && (t *= this._view.mapCoordsHelper.unitInMeters), t > this._referencePointUpdateDistThreshold;\n    }\n\n    return !0;\n  }\n\n  _cancelReferencePosUpdates() {\n    const e = !!this._referencePosUpdateQuery;\n    return this._referencePosUpdateQuery = null, this.referencePosUpdateTimer = null, e;\n  }\n\n  get test() {\n    const e = this;\n    return {\n      renderer: this._renderer,\n\n      set referencePointUpdateInterval(t) {\n        e._referencePointUpdateInterval = t;\n      },\n\n      set referencePointUpdateDistThreshold(t) {\n        e._referencePointUpdateDistThreshold = t;\n      },\n\n      set referencePosUpdateTimer(t) {\n        e.referencePosUpdateTimer = t;\n      },\n\n      set referencePointUpdateDelay(t) {\n        e._referencePointUpdateDelay = t;\n      }\n\n    };\n  }\n\n};\nW.FIXED_LIGHT_DIRECTION = L, e([h({\n  type: Boolean,\n  readOnly: !0\n})], W.prototype, \"updating\", null), e([h()], W.prototype, \"disableQueries\", void 0), e([h()], W.prototype, \"referencePositionWGS84Comparable\", null), e([h()], W.prototype, \"_renderer\", void 0), e([h()], W.prototype, \"_referencePosWGS84Comparable\", void 0), W = e([d(\"esri.views.3d.environment.SceneViewEnvironmentManager\")], W);\nconst j = new Date(),\n      k = {\n  hours: 0,\n  minutes: 0,\n  seconds: 0\n},\n      E = u(.22, .22, .33),\n      D = u(.22, .22, .22);\nvar Q = W;\nexport default Q;\nexport { W as SceneViewEnvironmentManager };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/environment/SceneViewEnvironmentManager.js"],"names":["_","e","t","r","i","isSome","s","isNone","n","mapOr","o","after","a","init","c","property","h","subclass","d","l","p","g","m","f","u","b","P","canProjectToWGS84ComparableLonLat","v","projectPointToWGS84ComparableLonLat","isEarth","C","w","positionToTimezoneInfo","U","computeColorAndIntensity","y","computeDirection","T","computeShadowsEnabled","R","MainLight","S","AmbientLight","M","FillLight","H","G","L","W","EventedAccessor","constructor","_referencePointUpdateDelay","_referencePointUpdateInterval","_referencePointUpdateDistThreshold","_referencePosUpdateQuery","_referencePosMapCoordsRequested","_viewHandles","_preserveAbsoluteDateTime","_trackingEnabled","_referencePosResetPreserveAbsoluteTime","referencePosUpdateTimer","_referencePosMapCoords","_mainLight","_ambientLight","_moonLight","_renderer","_referencePosWGS84Comparable","_resetReferencePosition","destroy","disconnectView","updating","disableQueries","referencePositionWGS84Comparable","connectView","_view","view","add","watch","_lightingDateHandler","_interactingStationaryHandler","_updateRenderParamsHandler","_updateCameraTracking","_cameraHandler","_updateLightParams","notifyChange","removeAll","environment","lighting","positionTimezoneInfo","autoUpdated","spatialReference","camera","position","equals","_requestReferencePositionUpdate","_preupdateTracking","k","autoUpdate","cameraTrackingEnabled","ready","_cameraHandlerClientSide","_cameraHandlerServerSide","longitude","latitude","z","_autoUpdateTimezone","_exceedsReferencePosDistThreshold","mapCoordsHelper","unitInMeters","_referencePosChanged","stationary","_executePendingReferencePositionUpdate","date","_stage","viewingMode","diffuse","directionToLightSource","color","intensity","ambient","noonFactor","globalFactor","Math","PI","direction","E","D","renderView","updateLightSources","j","setTime","getTime","hours","minutes","seconds","getUTCHours","getUTCMinutes","getUTCSeconds","setUTCHours","setUTCMinutes","setUTCSeconds","background","type","toUnitRGBA","setRenderParameters","shadowMap","directShadowsEnabled","ssao","ambientOcclusionEnabled","waterReflectionEnabled","_cancelReferencePosUpdates","copy","clone","then","_doReferencePositionUpdateQuery","catch","name","toGeographic","isNaN","distance","test","renderer","referencePointUpdateInterval","referencePointUpdateDistThreshold","referencePointUpdateDelay","FIXED_LIGHT_DIRECTION","Boolean","readOnly","prototype","Date","Q","SceneViewEnvironmentManager"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import t from\"../../../Color.js\";import r from\"../../../core/Evented.js\";import i from\"../../../core/Handles.js\";import{isSome as s,isNone as n,mapOr as o}from\"../../../core/maybe.js\";import{after as a}from\"../../../core/promiseUtils.js\";import{init as c}from\"../../../core/watchUtils.js\";import{property as h}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import\"../../../core/Logger.js\";import{subclass as d}from\"../../../core/accessorSupport/decorators/subclass.js\";import{s as l,a as p,g as _,e as m}from\"../../../chunks/vec3.js\";import{c as f,f as u}from\"../../../chunks/vec3f64.js\";import{b as P,f as g}from\"../../../chunks/vec4f64.js\";import{canProjectToWGS84ComparableLonLat as v,projectPointToWGS84ComparableLonLat as b}from\"../../../geometry/projection.js\";import{isEarth as C}from\"../../../geometry/support/spatialReferenceUtils.js\";import w from\"./EnvironmentRenderer.js\";import{positionToTimezoneInfo as U}from\"../support/earthUtils.js\";import{computeColorAndIntensity as y,computeDirection as T,computeShadowsEnabled as R}from\"../support/sunUtils.js\";import{MainLight as S,AmbientLight as M,FillLight as H}from\"../webgl-engine/lighting/Lightsources.js\";import G from\"../../../webscene/background/ColorBackground.js\";const L=u(.5773502691896258,-.5773502691896258,.5773502691896258);let W=class extends r.EventedAccessor{constructor(...e){super(...e),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new i,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this.referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new S,this._ambientLight=new M,this._moonLight=new H,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView(),this._viewHandles.destroy()}get updating(){return!!(!this.disableQueries&&(this._referencePosUpdateQuery||this._referencePosMapCoordsRequested)||this._renderer&&this._renderer.updating)}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){this._renderer||(this._view=e,this._renderer=new w({view:e}),this._viewHandles.add([e.watch(\"environment.lighting.date\",(e=>this._lightingDateHandler(e)),!0),e.watch(\"stationary\",(()=>this._interactingStationaryHandler())),e.watch([\"environment.lighting.directShadowsEnabled\",\"environment.lighting.ambientOcclusionEnabled\",\"environment.lighting.waterReflectionEnabled\",\"environment.background.color\"],(()=>this._updateRenderParamsHandler()),!0),e.watch(\"spatialReference\",(()=>this._resetReferencePosition(!0)),!0),c(e,\"viewingMode\",(()=>this._resetReferencePosition(!0)),!0),c(e,\"environment.lighting.cameraTrackingEnabled\",(e=>this._updateCameraTracking(e)),!0),c(e,\"state.camera\",(()=>this._cameraHandler(null)),!0),this.watch(\"disableQueries\",(()=>this._cameraHandler(null)))]),this._updateRenderParamsHandler(),this._updateLightParams(),this._cameraHandler(),this.notifyChange(\"updating\"))}disconnectView(){this._renderer&&(this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer.destroy(),this._renderer=null,this._view=null)}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;e&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){if(!e)return;const t=this._view.environment.lighting;if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const r=this._view.spatialReference;if(!v(r)){const e=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(e))return void this._requestReferencePositionUpdate(e)}if(this._preupdateTracking(e),s(this._referencePosWGS84Comparable)){const e=U(this._referencePosWGS84Comparable,k);s(e)&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLightParams(e)}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){if(!this._view.ready)return;const t=this._view.camera;t&&(this._cameraHandlerClientSide(t,e)||this._cameraHandlerServerSide(t))}_cameraHandlerClientSide(e,t){const r=C(this._view.spatialReference);if(r&&!v(this._view.spatialReference))return!1;const i=e.position;return n(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=f()),r?b(i,this._referencePosWGS84Comparable):l(this._referencePosWGS84Comparable,i.longitude,i.latitude,i.z),this.notifyChange(\"referencePositionWGS84Comparable\"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLightParams(t),!0}_cameraHandlerServerSide(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=t.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLightParams(e){const t=this._view.environment.lighting;e=e||t.date;const r=this._view._stage;let i;s(this._referencePosWGS84Comparable)?(i=y(e,this._referencePosWGS84Comparable),T(e,this._referencePosWGS84Comparable,this._view.viewingMode,i.diffuse.directionToLightSource)):i={diffuse:{color:[1,1,1],intensity:.55,directionToLightSource:L},ambient:{color:[1,1,1],intensity:.55},noonFactor:.5,globalFactor:0},p(this._mainLight.intensity,i.diffuse.color,i.diffuse.intensity*Math.PI),_(this._mainLight.direction,i.diffuse.directionToLightSource),p(this._ambientLight.intensity,i.ambient.color,i.ambient.intensity),m(this._moonLight.intensity,E,D,i.globalFactor);const n=(1-.5*i.globalFactor)*(1-.4*i.noonFactor*(1-i.globalFactor));p(this._moonLight.intensity,this._moonLight.intensity,n),_(this._moonLight.direction,i.diffuse.directionToLightSource),r.renderView.updateLightSources([this._mainLight,this._ambientLight,this._moonLight],1-i.noonFactor,i.globalFactor),this._updateRenderParamsHandler()}_autoUpdateTimezone(e,t=null){if(!this._view.environment.lighting.cameraTrackingEnabled||n(e))return!1;const r=j;r.setTime((t||this._view.environment.lighting.date).getTime());const i=U(e,k);if(n(i))return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===i.hours&&s.minutes===i.minutes&&s.seconds===i.seconds)return!1}else s=i;const o=r.getUTCHours()-(i.hours-s.hours),a=r.getUTCMinutes()-(i.minutes-s.minutes),c=r.getUTCSeconds()-(i.seconds-s.seconds);return r.setUTCHours(o),r.setUTCMinutes(a),r.setUTCSeconds(c),!t&&this._view.environment.lighting.autoUpdate(r,i)}_updateRenderParamsHandler(){const e=this._view._stage;if(!e)return;const r=o(this._referencePosWGS84Comparable,!0,(e=>R(e,this._view.viewingMode))),i=this._view.environment.background,s=i instanceof G?{type:\"color\",color:P(t.toUnitRGBA(i.color))}:{type:\"color\",color:g(0,0,0,1)};e.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&r,ssao:this._view.environment.lighting.ambientOcclusionEnabled,waterReflectionEnabled:this._view.environment.lighting.waterReflectionEnabled,background:s})}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange(\"updating\"),e&&this._cameraHandler(null)}_requestReferencePositionUpdate(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this.referencePosUpdateTimer&&this._view.stationary)){const e=this._referencePosUpdateQuery=a(this._referencePointUpdateDelay).then((()=>{if(this._referencePosUpdateQuery===e){const t=()=>this._referencePosUpdateQuery!==e;return this._doReferencePositionUpdateQuery(t)}})).catch((e=>{\"mapcoordshelper:missing-geometry-service\"===e.name&&(this.disableQueries=!0)})).then((()=>{this._referencePosUpdateQuery===e&&(this._referencePosUpdateQuery=null,this.referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange(\"updating\"))})),t=this.referencePosUpdateTimer=a(this._referencePointUpdateInterval).then((()=>{this.referencePosUpdateTimer===t&&(this.referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())}));this.notifyChange(\"updating\")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const e=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=e):this._referencePosWGS84Comparable=[t[0],t[1],e],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLightParams(),this.notifyChange(\"referencePositionWGS84Comparable\")}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this.referencePosUpdateTimer=null,e}get test(){const e=this;return{renderer:this._renderer,set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e.referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t}}}};W.FIXED_LIGHT_DIRECTION=L,e([h({type:Boolean,readOnly:!0})],W.prototype,\"updating\",null),e([h()],W.prototype,\"disableQueries\",void 0),e([h()],W.prototype,\"referencePositionWGS84Comparable\",null),e([h()],W.prototype,\"_renderer\",void 0),e([h()],W.prototype,\"_referencePosWGS84Comparable\",void 0),W=e([d(\"esri.views.3d.environment.SceneViewEnvironmentManager\")],W);const j=new Date,k={hours:0,minutes:0,seconds:0},E=u(.22,.22,.33),D=u(.22,.22,.22);var Q=W;export default Q;export{W as SceneViewEnvironmentManager};\n"]},"metadata":{},"sourceType":"module"}