{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../chunks/tslib.es6.js\";\nimport s from \"../../../../core/Accessor.js\";\nimport t from \"../../../../core/Evented.js\";\nimport r from \"../../../../core/Handles.js\";\nimport { clamp as i } from \"../../../../core/mathUtils.js\";\nimport { isNone as o, isSome as a } from \"../../../../core/maybe.js\";\nimport { createTask as n } from \"../../../../core/promiseUtils.js\";\nimport { createScreenPointArray as m, createRenderScreenPointArray as u, screenPointObjectToArray as l } from \"../../../../core/screenUtils.js\";\nimport { isSVG as p } from \"../../../../core/urlUtils.js\";\nimport { property as c } from \"../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../core/has.js\";\nimport \"../../../../core/accessorSupport/ensureType.js\";\nimport \"../../../../core/Logger.js\";\nimport { subclass as h } from \"../../../../core/accessorSupport/decorators/subclass.js\";\nimport { requestImage as d } from \"../../../../support/requestImageUtils.js\";\nimport \"../../../webgl/BufferObject.js\";\nimport \"../../../webgl/FramebufferObject.js\";\nimport \"../../../webgl/enums.js\";\nimport \"../../../webgl/RenderingContext.js\";\nimport \"../../../../chunks/builtins.js\";\nimport g from \"../../../webgl/Texture.js\";\nimport \"../../../webgl/VertexArrayObject.js\";\nimport { Pos2 as f } from \"./DefaultVertexBufferLayouts.js\";\nimport { createQuadVAO as _ } from \"./glUtil3D.js\";\nimport { Program as k } from \"./Program.js\";\nimport { testWebGLDriver as v } from \"./WebGLDriverTest.js\";\nimport { build as y } from \"../shaders/Magnifier.glsl.js\";\nimport { loadMagnifierResources as b } from \"../../../magnifier/resources.js\";\nimport { makePipelineState as T, simpleBlendingParams as j, defaultColorWriteParams as x } from \"../../../webgl/renderState.js\";\nlet w = class extends s {\n  constructor() {\n    super(...arguments), this._handles = new r(), this._magnifier = null, this._imageSources = null, this._imageLoadTask = null, this._resources = null, this.events = new t(), this.attributeLocations = new Map([[\"position\", 0]]), this.tmpScreenPoint = m(), this.tmpRenderPoint = u();\n  }\n\n  get updating() {\n    return o(this._imageSources) && a(this._imageLoadTask) && !this._imageLoadTask.task.finished;\n  }\n\n  get magnifier() {\n    return this._magnifier;\n  }\n\n  set magnifier(e) {\n    if (e === this._magnifier) return;\n    this._handles.removeAll(), this._magnifier = e;\n\n    const s = () => {\n      this.updateResourceLoading(), this.events.emit(\"request-render\");\n    };\n\n    a(this._magnifier) && this._handles.add(this._magnifier.watch(\"version\", s)), s();\n  }\n\n  get enabled() {\n    return a(this._validMagnifier);\n  }\n\n  get _validMagnifier() {\n    return a(this._magnifier) && this._magnifier.visible && a(this._magnifier.position) && this._magnifier.size > 0 ? this._magnifier : null;\n  }\n\n  get factor() {\n    return a(this._magnifier) && this._magnifier.factor || 1;\n  }\n\n  dispose() {\n    this._magnifier = null, this._handles.destroy(), a(this._imageLoadTask) && (this._imageLoadTask.task.abort(), this._imageLoadTask = null), this.disposeResources();\n  }\n\n  render(e, s) {\n    const t = this._validMagnifier;\n    if (o(t)) return;\n    const r = s.camera.pixelRatio,\n          a = Math.ceil(r * t.size);\n    if (this.updateResources(e, a), o(this._resources)) return;\n    const n = this._resources.program;\n    e.useProgram(n);\n    const m = this._resources.textures,\n          u = Math.ceil(1 / this.factor * a);\n    m.input.resize(u, u);\n    const p = s.camera.fullWidth,\n          c = s.camera.fullHeight;\n    l(t.position, this.tmpScreenPoint);\n    const h = s.camera.screenToRender(this.tmpScreenPoint, this.tmpRenderPoint),\n          d = .5 * u,\n          g = .5 * u;\n    h[0] = i(h[0], d, p - d - 1), h[1] = i(h[1], g, c - g - 1);\n\n    const f = Math.floor(h[0] - d),\n          _ = Math.floor(h[1] - g);\n\n    n.bindTexture(m.input, \"textureInput\"), e.gl.copyTexImage2D(m.input.descriptor.target, 0, m.input.descriptor.pixelFormat, f, _, u, u, 0);\n    const k = t.offset.x * r,\n          v = t.offset.y * r,\n          y = (h[0] + k) / p * 2 - 1,\n          b = (h[1] - v) / c * 2 - 1,\n          T = a / p * 2,\n          j = a / c * 2;\n    e.bindVAO(this._resources.vao), n.bindTexture(m.overlay, \"textureOverlay\"), n.bindTexture(m.mask, \"textureMask\"), n.setUniform4f(\"drawPosition\", y, b, T, j), n.setUniform1i(\"maskEnabled\", t.maskEnabled ? 1 : 0), n.setUniform1i(\"overlayEnabled\", t.overlayEnabled ? 1 : 0), e.setPipelineState(this._resources.pipelineState), e.drawArrays(5, 0, 4);\n  }\n\n  updateResourceLoading() {\n    const e = this._validMagnifier;\n    if (o(e)) return;\n    const s = e.maskUrl,\n          t = e.overlayUrl;\n    !a(this._imageLoadTask) || this._imageLoadTask.maskUrl === s && this._imageLoadTask.overlayUrl === t || (this._imageLoadTask.task.abort(), this._imageLoadTask = null, this._imageSources = null), a(this._imageSources) || a(this._imageLoadTask) || (this._imageLoadTask = {\n      maskUrl: s,\n      overlayUrl: t,\n      task: n(async e => {\n        const r = o(s) || o(t) ? b(e) : null,\n              i = a(s) ? d(s, {\n          signal: e\n        }) : r.then(e => e.mask),\n              n = a(t) ? d(t, {\n          signal: e\n        }) : r.then(e => e.overlay);\n        this._imageSources = {\n          mask: await i,\n          overlay: await n\n        }, this.disposeResources(), this.events.emit(\"request-render\");\n      })\n    }, this._imageLoadTask.task.promise.then(() => this.notifyChange(\"updating\"), () => this.notifyChange(\"updating\")));\n  }\n\n  updateResources(e, s) {\n    if (!this.enabled) return void this.disposeResources();\n\n    if (a(this._resources)) {\n      if (this._resources.textures.size !== s) {\n        const t = this.createTextureResources(e, s);\n        if (o(t)) return void this.disposeResources();\n        this.disposeTextureResources(this._resources.textures), this._resources.textures = t;\n      }\n\n      return;\n    }\n\n    const t = this.createTextureResources(e, s);\n    o(t) || (this._resources = {\n      textures: t,\n      program: this.createProgram(e),\n      vao: _(e, f, this.attributeLocations, 0, 1),\n      pipelineState: T({\n        blending: j(1, 771),\n        depthTest: null,\n        depthWrite: null,\n        colorWrite: x\n      })\n    });\n  }\n\n  disposeResources() {\n    o(this._resources) || (this.disposeTextureResources(this._resources.textures), this._resources.program.dispose(), this._resources.vao.dispose(), this._resources = null);\n  }\n\n  disposeTextureResources(e) {\n    e.mask.dispose(), e.overlay.dispose(), e.input.dispose();\n  }\n\n  createTextureResources(e, s) {\n    if (o(this._imageSources)) return null;\n    this._imageSources.overlay.width = s, this._imageSources.overlay.height = s, this._imageSources.mask.width = s, this._imageSources.mask.height = s;\n    const t = new g(e, {\n      target: 3553,\n      pixelFormat: 6408,\n      internalFormat: 6408,\n      dataType: 5121,\n      wrapMode: 33071,\n      samplingMode: 9729,\n      flipped: !0,\n      preMultiplyAlpha: !p(this._imageSources.overlay.src) || !v(e).svgAlwaysPremultipliesAlpha\n    }, this._imageSources.overlay),\n          r = new g(e, {\n      target: 3553,\n      pixelFormat: 6406,\n      internalFormat: 6406,\n      dataType: 5121,\n      wrapMode: 33071,\n      samplingMode: 9729,\n      flipped: !0\n    }, this._imageSources.mask);\n    return {\n      input: new g(e, {\n        target: 3553,\n        pixelFormat: 6408,\n        internalFormat: 6408,\n        dataType: 5121,\n        wrapMode: 33071,\n        samplingMode: 9729,\n        flipped: !1\n      }),\n      mask: r,\n      overlay: t,\n      size: s\n    };\n  }\n\n  createProgram(e) {\n    const s = y();\n    return new k(e, s, this.attributeLocations);\n  }\n\n};\ne([c()], w.prototype, \"_imageSources\", void 0), e([c()], w.prototype, \"_imageLoadTask\", void 0), e([c({\n  readOnly: !0\n})], w.prototype, \"updating\", null), w = e([h(\"esri/views/3d/webgl-engine/lib/MagnifierHelper\")], w);\nexport { w as MagnifierHelper };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/webgl-engine/lib/MagnifierHelper.js"],"names":["_","e","s","t","r","clamp","i","isNone","o","isSome","a","createTask","n","createScreenPointArray","m","createRenderScreenPointArray","u","screenPointObjectToArray","l","isSVG","p","property","c","subclass","h","requestImage","d","g","Pos2","f","createQuadVAO","Program","k","testWebGLDriver","v","build","y","loadMagnifierResources","b","makePipelineState","T","simpleBlendingParams","j","defaultColorWriteParams","x","w","constructor","arguments","_handles","_magnifier","_imageSources","_imageLoadTask","_resources","events","attributeLocations","Map","tmpScreenPoint","tmpRenderPoint","updating","task","finished","magnifier","removeAll","updateResourceLoading","emit","add","watch","enabled","_validMagnifier","visible","position","size","factor","dispose","destroy","abort","disposeResources","render","camera","pixelRatio","Math","ceil","updateResources","program","useProgram","textures","input","resize","fullWidth","fullHeight","screenToRender","floor","bindTexture","gl","copyTexImage2D","descriptor","target","pixelFormat","offset","bindVAO","vao","overlay","mask","setUniform4f","setUniform1i","maskEnabled","overlayEnabled","setPipelineState","pipelineState","drawArrays","maskUrl","overlayUrl","signal","then","promise","notifyChange","createTextureResources","disposeTextureResources","createProgram","blending","depthTest","depthWrite","colorWrite","width","height","internalFormat","dataType","wrapMode","samplingMode","flipped","preMultiplyAlpha","src","svgAlwaysPremultipliesAlpha","prototype","readOnly","MagnifierHelper"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../chunks/tslib.es6.js\";import s from\"../../../../core/Accessor.js\";import t from\"../../../../core/Evented.js\";import r from\"../../../../core/Handles.js\";import{clamp as i}from\"../../../../core/mathUtils.js\";import{isNone as o,isSome as a}from\"../../../../core/maybe.js\";import{createTask as n}from\"../../../../core/promiseUtils.js\";import{createScreenPointArray as m,createRenderScreenPointArray as u,screenPointObjectToArray as l}from\"../../../../core/screenUtils.js\";import{isSVG as p}from\"../../../../core/urlUtils.js\";import{property as c}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/ensureType.js\";import\"../../../../core/Logger.js\";import{subclass as h}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{requestImage as d}from\"../../../../support/requestImageUtils.js\";import\"../../../webgl/BufferObject.js\";import\"../../../webgl/FramebufferObject.js\";import\"../../../webgl/enums.js\";import\"../../../webgl/RenderingContext.js\";import\"../../../../chunks/builtins.js\";import g from\"../../../webgl/Texture.js\";import\"../../../webgl/VertexArrayObject.js\";import{Pos2 as f}from\"./DefaultVertexBufferLayouts.js\";import{createQuadVAO as _}from\"./glUtil3D.js\";import{Program as k}from\"./Program.js\";import{testWebGLDriver as v}from\"./WebGLDriverTest.js\";import{build as y}from\"../shaders/Magnifier.glsl.js\";import{loadMagnifierResources as b}from\"../../../magnifier/resources.js\";import{makePipelineState as T,simpleBlendingParams as j,defaultColorWriteParams as x}from\"../../../webgl/renderState.js\";let w=class extends s{constructor(){super(...arguments),this._handles=new r,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this.events=new t,this.attributeLocations=new Map([[\"position\",0]]),this.tmpScreenPoint=m(),this.tmpRenderPoint=u()}get updating(){return o(this._imageSources)&&a(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const s=()=>{this.updateResourceLoading(),this.events.emit(\"request-render\")};a(this._magnifier)&&this._handles.add(this._magnifier.watch(\"version\",s)),s()}get enabled(){return a(this._validMagnifier)}get _validMagnifier(){return a(this._magnifier)&&this._magnifier.visible&&a(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get factor(){return a(this._magnifier)&&this._magnifier.factor||1}dispose(){this._magnifier=null,this._handles.destroy(),a(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this.disposeResources()}render(e,s){const t=this._validMagnifier;if(o(t))return;const r=s.camera.pixelRatio,a=Math.ceil(r*t.size);if(this.updateResources(e,a),o(this._resources))return;const n=this._resources.program;e.useProgram(n);const m=this._resources.textures,u=Math.ceil(1/this.factor*a);m.input.resize(u,u);const p=s.camera.fullWidth,c=s.camera.fullHeight;l(t.position,this.tmpScreenPoint);const h=s.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),d=.5*u,g=.5*u;h[0]=i(h[0],d,p-d-1),h[1]=i(h[1],g,c-g-1);const f=Math.floor(h[0]-d),_=Math.floor(h[1]-g);n.bindTexture(m.input,\"textureInput\"),e.gl.copyTexImage2D(m.input.descriptor.target,0,m.input.descriptor.pixelFormat,f,_,u,u,0);const k=t.offset.x*r,v=t.offset.y*r,y=(h[0]+k)/p*2-1,b=(h[1]-v)/c*2-1,T=a/p*2,j=a/c*2;e.bindVAO(this._resources.vao),n.bindTexture(m.overlay,\"textureOverlay\"),n.bindTexture(m.mask,\"textureMask\"),n.setUniform4f(\"drawPosition\",y,b,T,j),n.setUniform1i(\"maskEnabled\",t.maskEnabled?1:0),n.setUniform1i(\"overlayEnabled\",t.overlayEnabled?1:0),e.setPipelineState(this._resources.pipelineState),e.drawArrays(5,0,4)}updateResourceLoading(){const e=this._validMagnifier;if(o(e))return;const s=e.maskUrl,t=e.overlayUrl;!a(this._imageLoadTask)||this._imageLoadTask.maskUrl===s&&this._imageLoadTask.overlayUrl===t||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),a(this._imageSources)||a(this._imageLoadTask)||(this._imageLoadTask={maskUrl:s,overlayUrl:t,task:n((async e=>{const r=o(s)||o(t)?b(e):null,i=a(s)?d(s,{signal:e}):r.then((e=>e.mask)),n=a(t)?d(t,{signal:e}):r.then((e=>e.overlay));this._imageSources={mask:await i,overlay:await n},this.disposeResources(),this.events.emit(\"request-render\")}))},this._imageLoadTask.task.promise.then((()=>this.notifyChange(\"updating\")),(()=>this.notifyChange(\"updating\"))))}updateResources(e,s){if(!this.enabled)return void this.disposeResources();if(a(this._resources)){if(this._resources.textures.size!==s){const t=this.createTextureResources(e,s);if(o(t))return void this.disposeResources();this.disposeTextureResources(this._resources.textures),this._resources.textures=t}return}const t=this.createTextureResources(e,s);o(t)||(this._resources={textures:t,program:this.createProgram(e),vao:_(e,f,this.attributeLocations,0,1),pipelineState:T({blending:j(1,771),depthTest:null,depthWrite:null,colorWrite:x})})}disposeResources(){o(this._resources)||(this.disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}createTextureResources(e,s){if(o(this._imageSources))return null;this._imageSources.overlay.width=s,this._imageSources.overlay.height=s,this._imageSources.mask.width=s,this._imageSources.mask.height=s;const t=new g(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0,preMultiplyAlpha:!p(this._imageSources.overlay.src)||!v(e).svgAlwaysPremultipliesAlpha},this._imageSources.overlay),r=new g(e,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},this._imageSources.mask);return{input:new g(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1}),mask:r,overlay:t,size:s}}createProgram(e){const s=y();return new k(e,s,this.attributeLocations)}};e([c()],w.prototype,\"_imageSources\",void 0),e([c()],w.prototype,\"_imageLoadTask\",void 0),e([c({readOnly:!0})],w.prototype,\"updating\",null),w=e([h(\"esri/views/3d/webgl-engine/lib/MagnifierHelper\")],w);export{w as MagnifierHelper};\n"]},"metadata":{},"sourceType":"module"}