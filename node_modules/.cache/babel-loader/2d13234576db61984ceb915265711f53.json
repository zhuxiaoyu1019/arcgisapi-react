{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../../chunks/tslib.es6.js\";\nimport \"../../../../../core/has.js\";\nimport { isSome as t, andThen as s } from \"../../../../../core/maybe.js\";\nimport \"../../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../../core/accessorSupport/ensureType.js\";\nimport \"../../../../../core/Logger.js\";\nimport { subclass as r } from \"../../../../../core/accessorSupport/decorators/subclass.js\";\nimport { diff as i } from \"../../../../../core/accessorSupport/diffUtils.js\";\nimport { calculateHeatmapIntensityInfoReaders as o } from \"../../../../../renderers/support/heatmapUtils.js\";\nimport { TILE_SIZE as a } from \"../../../engine/webgl/definitions.js\";\nimport n from \"./BaseProcessor.js\";\nimport { getPow2NeighborKey as d } from \"../support/tileUtils.js\";\n\nclass p {\n  constructor(e, t) {\n    this.offset = e, this.extent = t;\n  }\n\n}\n\nfunction c(e) {\n  const t = e.key,\n        s = new Map(),\n        r = 256,\n        i = a,\n        o = e.tileInfoView.tileInfo.isWrappable;\n  return s.set(d(t, -1, -1, o).id, new p([-i, -i], [i - r, i - r, i, i])), s.set(d(t, 0, -1, o).id, new p([0, -i], [0, i - r, i, i])), s.set(d(t, 1, -1, o).id, new p([i, -i], [0, i - r, r, i])), s.set(d(t, -1, 0, o).id, new p([-i, 0], [i - r, 0, i, i])), s.set(d(t, 1, 0, o).id, new p([i, 0], [0, 0, r, i])), s.set(d(t, -1, 1, o).id, new p([-i, i], [i - r, 0, i, r])), s.set(d(t, 0, 1, o).id, new p([0, i], [0, 0, i, r])), s.set(d(t, 1, 1, o).id, new p([i, i], [0, 0, r, r])), s;\n}\n\nlet l = class extends n {\n  constructor() {\n    super(...arguments), this.type = \"heatmap\", this._tileKeyToFeatureSets = new Map();\n  }\n\n  initialize() {\n    this.handles.add([this.tileStore.on(\"update\", this.onTileUpdate.bind(this))]);\n  }\n\n  async update(e, t) {\n    const s = t.schema.processors[0];\n    if (\"heatmap\" !== s.type) return;\n    i(this._schema, s) && (e.mesh = !0, this._schema = s);\n  }\n\n  onTileUpdate(e) {\n    for (const t of e.removed) this._tileKeyToFeatureSets.delete(t.key.id);\n  }\n\n  onTileClear(e) {\n    const t = {\n      clear: !0\n    };\n    return this._tileKeyToFeatureSets.delete(e.key.id), this.remoteClient.invoke(\"tileRenderer.onTileData\", {\n      tileKey: e.id,\n      data: t\n    });\n  }\n\n  async onTileMessage(e, r, i) {\n    this._tileKeyToFeatureSets.has(e.key.id) || this._tileKeyToFeatureSets.set(e.key.id, new Map());\n\n    const a = this._tileKeyToFeatureSets.get(e.key.id);\n\n    if (t(r.addOrUpdate) && r.addOrUpdate.hasFeatures && a.set(r.addOrUpdate.instance, r), r.end) {\n      const t = [],\n            r = c(e);\n\n      this._tileKeyToFeatureSets.forEach((i, o) => {\n        if (o === e.key.id) i.forEach(e => s(e.addOrUpdate, e => t.push(e)));else if (r.has(o)) {\n          const e = r.get(o),\n                [a, n] = e.offset;\n          i.forEach(e => s(e.addOrUpdate, e => {\n            const s = e.transform(a, n, 1, 1);\n            t.push(s);\n          }));\n        }\n      });\n\n      const a = o(t, this._schema.mesh, 512, 512),\n            n = {\n        tileKey: e.key.id,\n        intensityInfo: a\n      },\n            d = [a.matrix];\n      return this.remoteClient.invoke(\"tileRenderer.onTileData\", n, { ...i,\n        transferList: d\n      });\n    }\n  }\n\n  onTileError(e, t, s) {\n    return this.remoteClient.invoke(\"tileRenderer.onTileError\", {\n      tileKey: e.id,\n      error: t\n    }, s);\n  }\n\n};\nl = e([r(\"esri.views.2d.layers.features.processors.HeatmapProcessor\")], l);\nvar h = l;\nexport default h;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/2d/layers/features/processors/HeatmapProcessor.js"],"names":["_","e","isSome","t","andThen","s","subclass","r","diff","i","calculateHeatmapIntensityInfoReaders","o","TILE_SIZE","a","n","getPow2NeighborKey","d","p","constructor","offset","extent","c","key","Map","tileInfoView","tileInfo","isWrappable","set","id","l","arguments","type","_tileKeyToFeatureSets","initialize","handles","add","tileStore","on","onTileUpdate","bind","update","schema","processors","_schema","mesh","removed","delete","onTileClear","clear","remoteClient","invoke","tileKey","data","onTileMessage","has","get","addOrUpdate","hasFeatures","instance","end","forEach","push","transform","intensityInfo","matrix","transferList","onTileError","error","h"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../../chunks/tslib.es6.js\";import\"../../../../../core/has.js\";import{isSome as t,andThen as s}from\"../../../../../core/maybe.js\";import\"../../../../../core/accessorSupport/decorators/property.js\";import\"../../../../../core/accessorSupport/ensureType.js\";import\"../../../../../core/Logger.js\";import{subclass as r}from\"../../../../../core/accessorSupport/decorators/subclass.js\";import{diff as i}from\"../../../../../core/accessorSupport/diffUtils.js\";import{calculateHeatmapIntensityInfoReaders as o}from\"../../../../../renderers/support/heatmapUtils.js\";import{TILE_SIZE as a}from\"../../../engine/webgl/definitions.js\";import n from\"./BaseProcessor.js\";import{getPow2NeighborKey as d}from\"../support/tileUtils.js\";class p{constructor(e,t){this.offset=e,this.extent=t}}function c(e){const t=e.key,s=new Map,r=256,i=a,o=e.tileInfoView.tileInfo.isWrappable;return s.set(d(t,-1,-1,o).id,new p([-i,-i],[i-r,i-r,i,i])),s.set(d(t,0,-1,o).id,new p([0,-i],[0,i-r,i,i])),s.set(d(t,1,-1,o).id,new p([i,-i],[0,i-r,r,i])),s.set(d(t,-1,0,o).id,new p([-i,0],[i-r,0,i,i])),s.set(d(t,1,0,o).id,new p([i,0],[0,0,r,i])),s.set(d(t,-1,1,o).id,new p([-i,i],[i-r,0,i,r])),s.set(d(t,0,1,o).id,new p([0,i],[0,0,i,r])),s.set(d(t,1,1,o).id,new p([i,i],[0,0,r,r])),s}let l=class extends n{constructor(){super(...arguments),this.type=\"heatmap\",this._tileKeyToFeatureSets=new Map}initialize(){this.handles.add([this.tileStore.on(\"update\",this.onTileUpdate.bind(this))])}async update(e,t){const s=t.schema.processors[0];if(\"heatmap\"!==s.type)return;i(this._schema,s)&&(e.mesh=!0,this._schema=s)}onTileUpdate(e){for(const t of e.removed)this._tileKeyToFeatureSets.delete(t.key.id)}onTileClear(e){const t={clear:!0};return this._tileKeyToFeatureSets.delete(e.key.id),this.remoteClient.invoke(\"tileRenderer.onTileData\",{tileKey:e.id,data:t})}async onTileMessage(e,r,i){this._tileKeyToFeatureSets.has(e.key.id)||this._tileKeyToFeatureSets.set(e.key.id,new Map);const a=this._tileKeyToFeatureSets.get(e.key.id);if(t(r.addOrUpdate)&&r.addOrUpdate.hasFeatures&&a.set(r.addOrUpdate.instance,r),r.end){const t=[],r=c(e);this._tileKeyToFeatureSets.forEach(((i,o)=>{if(o===e.key.id)i.forEach((e=>s(e.addOrUpdate,(e=>t.push(e)))));else if(r.has(o)){const e=r.get(o),[a,n]=e.offset;i.forEach((e=>s(e.addOrUpdate,(e=>{const s=e.transform(a,n,1,1);t.push(s)}))))}}));const a=o(t,this._schema.mesh,512,512),n={tileKey:e.key.id,intensityInfo:a},d=[a.matrix];return this.remoteClient.invoke(\"tileRenderer.onTileData\",n,{...i,transferList:d})}}onTileError(e,t,s){return this.remoteClient.invoke(\"tileRenderer.onTileError\",{tileKey:e.id,error:t},s)}};l=e([r(\"esri.views.2d.layers.features.processors.HeatmapProcessor\")],l);var h=l;export default h;\n"]},"metadata":{},"sourceType":"module"}