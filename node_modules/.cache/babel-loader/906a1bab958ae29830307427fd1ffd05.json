{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../core/Error.js\";\nimport { clone as t } from \"../../../core/lang.js\";\nimport { isNone as i, isUndefined as s } from \"../../../core/maybe.js\";\nimport { MemCache as r, MemCacheStorage as a } from \"../../../core/MemCache.js\";\nimport { getMetersPerUnitForSR as n } from \"../../../core/unitUtils.js\";\nimport { set as u, NEGATIVE_INFINITY as o, expandWithAABB as c, create as h } from \"../../../geometry/support/aaBoundingBox.js\";\nimport { fromValues as l, create as p } from \"../../../geometry/support/aaBoundingRect.js\";\nimport { getBoundsXY as m } from \"../../../geometry/support/boundsUtils.js\";\nimport { fromJSON as d, isExtent as y, isPolygon as f } from \"../../../geometry/support/jsonUtils.js\";\nimport { normalizeCentralMeridian as _ } from \"../../../geometry/support/normalizeUtils.js\";\nimport { equals as x, isValid as g } from \"../../../geometry/support/spatialReferenceUtils.js\";\nimport { validateFields as w, validateWhere as S, validateHaving as Q, hasInvalidFieldType as R } from \"./attributeSupport.js\";\nimport { project as I, checkProjectionSupport as F } from \"./projectionSupport.js\";\nimport { queryCapabilities as b } from \"./QueryEngineCapabilities.js\";\nimport j from \"./QueryEngineResult.js\";\nimport { getSpatialQueryOperator as A, canQueryWithRBush as E, checkSpatialQuerySupport as k } from \"./spatialQuerySupport.js\";\nimport { getTimeExtent as C } from \"./timeSupport.js\";\nimport { cleanFromGeometryEngine as T, normalizeQuery as B, QUERY_ENGINE_EMPTY_RESULT as O } from \"./utils.js\";\nimport z from \"../../support/FieldsIndex.js\";\nimport P from \"../../support/PromiseQueue.js\";\nimport { getFieldsList as G } from \"../../../smartMapping/support/utils.js\";\n\nfunction v(e) {\n  return e.every(e => \"exceedslimit\" !== e.statisticType);\n}\n\nconst q = \"feature-store:unsupported-query\";\n\nclass M {\n  constructor(e, t = null, i, s, r) {\n    this.attributes = e, this.geometry = i, this.centroid = s, this.filterFlags = r, this.groupId = -1, this.displayId = t;\n  }\n\n}\n\nconst U = new Set(),\n      N = new a(2e6);\nlet Z = 0;\n\nclass H {\n  constructor(e) {\n    this.capabilities = {\n      query: b\n    }, this.geometryType = e.geometryType, this.hasM = e.hasM, this.hasZ = e.hasZ, this.objectIdField = e.objectIdField, this.spatialReference = e.spatialReference, this.definitionExpression = e.definitionExpression, this.featureStore = e.featureStore, this.aggregateAdapter = e.aggregateAdapter, this._changeHandle = this.featureStore.events.on(\"changed\", () => this.clearCache()), this.timeInfo = e.timeInfo, e.cacheSpatialQueries && (this._geometryQueryCache = new r(Z++ + \"$$\", N)), this.fieldsIndex = new z(e.fields), e.scheduler && e.priority && (this._frameQueue = new P(), this._frameTask = e.scheduler.registerTask(e.priority, this));\n  }\n\n  destroy() {\n    this._frameTask && (this._frameTask.remove(), this._frameTask = null, this._frameQueue.cancelAll(), this._frameQueue = null), this.clearCache(), this._geometryQueryCache && this._geometryQueryCache.destroy(), this._changeHandle && (this._changeHandle.remove(), this._changeHandle = null), this.fieldsIndex.destroy();\n  }\n\n  get featureAdapter() {\n    return this.featureStore.featureAdapter;\n  }\n\n  get fullExtent() {\n    const e = this.featureStore.fullBounds;\n    return e ? {\n      xmin: e[0],\n      ymin: e[1],\n      xmax: e[2],\n      ymax: e[3],\n      spatialReference: T(this.spatialReference)\n    } : null;\n  }\n\n  get timeExtent() {\n    return this.timeInfo ? (this._timeExtent || (this._timeExtent = C(this.timeInfo, this.featureStore)), this._timeExtent) : null;\n  }\n\n  clearCache() {\n    this._geometryQueryCache && this._geometryQueryCache.clear(), this._allItems = null, this._timeExtent = null;\n  }\n\n  async executeQuery(e = {}, i) {\n    let s,\n        r = t(e);\n\n    try {\n      r = await this._schedule(() => B(r, this.definitionExpression, this.spatialReference), i), r = await this._reschedule(() => this._checkQuerySupport(r), i), s = await this._reschedule(() => this._executeGeometryQuery(r, i), i), s = await this._reschedule(() => s.executeAggregateIdsQuery(r), i), s = await this._reschedule(() => s.executeObjectIdsQuery(r), i), s = await this._reschedule(() => s.executeTimeQuery(r), i), s = await this._reschedule(() => s.executeAttributesQuery(r), i);\n    } catch (a) {\n      if (a !== O) throw a;\n      s = new j([], null, this);\n    }\n\n    return s.createQueryResponse(r);\n  }\n\n  async executeQueryForCount(e = {}, i) {\n    let s,\n        r = t(e);\n    r.returnGeometry = !1, r.returnCentroid = !1, r.outSR = null;\n\n    try {\n      r = await this._schedule(() => B(r, this.definitionExpression, this.spatialReference), i), r = await this._reschedule(() => this._checkQuerySupport(r), i), s = await this._reschedule(() => this._executeGeometryQuery(r, i), i), s = await this._reschedule(() => s.executeAggregateIdsQuery(r), i), s = await this._reschedule(() => s.executeObjectIdsQuery(r), i), s = await this._reschedule(() => s.executeTimeQuery(r), i), s = await this._reschedule(() => s.executeAttributesQuery(r), i);\n    } catch (a) {\n      if (a !== O) throw a;\n      return 0;\n    }\n\n    return s.createQueryResponseForCount(r);\n  }\n\n  async executeQueryForExtent(e = {}, i) {\n    let s,\n        r = t(e);\n    const a = r.outSR;\n\n    try {\n      r = await this._schedule(() => B(r, this.definitionExpression, this.spatialReference), i), r = await this._reschedule(() => this._checkQuerySupport(r), i), r.returnGeometry = !0, r.returnCentroid = !1, r.outSR = null, s = await this._reschedule(() => this._executeGeometryQuery(r, i), i), s = await this._reschedule(() => s.executeAggregateIdsQuery(r), i), s = await this._reschedule(() => s.executeObjectIdsQuery(r), i), s = await this._reschedule(() => s.executeTimeQuery(r), i), s = await this._reschedule(() => s.executeAttributesQuery(r), i);\n      const e = s.size;\n      if (!e) return {\n        count: e,\n        extent: null\n      };\n      u(L, o), this.featureStore.forEachBounds(s.items, e => c(L, e), J);\n      const t = {\n        xmin: L[0],\n        ymin: L[1],\n        xmax: L[3],\n        ymax: L[4],\n        spatialReference: T(this.spatialReference)\n      };\n      this.hasZ && isFinite(L[2]) && isFinite(L[5]) && (t.zmin = L[2], t.zmax = L[5]);\n      const h = I(t, s.spatialReference, a);\n\n      if (h.spatialReference = T(a || this.spatialReference), h.xmax - h.xmin == 0) {\n        const e = n(h.spatialReference);\n        h.xmin -= e, h.xmax += e;\n      }\n\n      if (h.ymax - h.ymin == 0) {\n        const e = n(h.spatialReference);\n        h.ymin -= e, h.ymax += e;\n      }\n\n      if (this.hasZ && null != h.zmin && null != h.zmax && h.zmax - h.zmin == 0) {\n        const e = n(h.spatialReference);\n        h.zmin -= e, h.zmax += e;\n      }\n\n      return {\n        count: e,\n        extent: h\n      };\n    } catch (h) {\n      if (h === O) return {\n        count: 0,\n        extent: null\n      };\n      throw h;\n    }\n  }\n\n  async executeQueryForIds(e = {}, t) {\n    return this.executeQueryForIdSet(e, t).then(e => Array.from(e));\n  }\n\n  async executeQueryForIdSet(e = {}, i) {\n    let s,\n        r = t(e);\n    r.returnGeometry = !1, r.returnCentroid = !1, r.outSR = null;\n\n    try {\n      r = await this._schedule(() => B(r, this.definitionExpression, this.spatialReference), i), r = await this._reschedule(() => this._checkQuerySupport(r), i), s = await this._reschedule(() => this._executeGeometryQuery(r, i), i), s = await this._reschedule(() => s.executeAggregateIdsQuery(r), i), s = await this._reschedule(() => s.executeObjectIdsQuery(r), i), s = await this._reschedule(() => s.executeTimeQuery(r), i), s = await this._reschedule(() => s.executeAttributesQuery(r), i);\n      const e = s.items,\n            t = new Set();\n      return await this._reschedule(() => {\n        for (const i of e) t.add(s.featureAdapter.getObjectId(i));\n      }, i), t;\n    } catch (a) {\n      if (a === O) return new Set();\n      throw a;\n    }\n  }\n\n  async executeQueryForSnapping(e, t) {\n    const {\n      point: s,\n      distance: r,\n      types: a\n    } = e;\n    if (0 === a) return {\n      candidates: []\n    };\n    const n = await this._reschedule(() => this._checkQuerySupport(e.query), t),\n          u = !x(s.spatialReference, this.spatialReference);\n    u && (await F(s.spatialReference, this.spatialReference));\n    const o = \"number\" == typeof r ? r : r.x,\n          c = \"number\" == typeof r ? r : r.y,\n          h = {\n      xmin: s.x - o,\n      xmax: s.x + o,\n      ymin: s.y - c,\n      ymax: s.y + c,\n      spatialReference: s.spatialReference\n    },\n          l = u ? I(h, this.spatialReference) : h;\n    if (!l) return {\n      candidates: []\n    };\n    const p = (await _(d(s), null, {\n      signal: t\n    }))[0],\n          m = (await _(d(l), null, {\n      signal: t\n    }))[0];\n    if (i(p) || i(m)) return {\n      candidates: []\n    };\n    let y = new j(this._searchFeatures(this._getQueryBBoxes(m.toJSON())), null, this);\n    y = await this._reschedule(() => y.executeObjectIdsQuery(n), t), y = await this._reschedule(() => y.executeTimeQuery(n), t), y = await this._reschedule(() => y.executeAttributesQuery(n), t);\n    const f = p.toJSON(),\n          g = u ? I(f, this.spatialReference) : f,\n          w = u ? Math.max(l.xmax - l.xmin, l.ymax - l.ymin) / 2 : r;\n    return y.createSnappingResponse({ ...e,\n      point: g,\n      distance: w\n    }, s.spatialReference);\n  }\n\n  async executeQueryForLatestObservations(i = {}, s) {\n    if (!this.timeInfo || !this.timeInfo.trackIdField) throw new e(q, \"Missing timeInfo or timeInfo.trackIdField\", {\n      query: i,\n      timeInfo: this.timeInfo\n    });\n    let r,\n        a = t(i);\n\n    try {\n      a = await this._schedule(() => B(a, this.definitionExpression, this.spatialReference), s), a = await this._reschedule(() => this._checkQuerySupport(a), s), r = await this._reschedule(() => this._executeGeometryQuery(a, s), s), r = await this._reschedule(() => r.executeAggregateIdsQuery(a), s), r = await this._reschedule(() => r.executeObjectIdsQuery(a), s), r = await this._reschedule(() => r.executeTimeQuery(a), s), r = await this._reschedule(() => r.executeAttributesQuery(a), s), r = await this._reschedule(() => r.filterLatest(), s);\n    } catch (n) {\n      if (n !== O) throw n;\n      r = new j([], null, this);\n    }\n\n    return r.createQueryResponse(a);\n  }\n\n  async executeQueryForSummaryStatistics(e = {}, i, s) {\n    let r;\n    e = t(e);\n\n    try {\n      e = await this._schedule(() => B(e, this.definitionExpression, this.spatialReference), s), e = await this._reschedule(() => this._checkSummaryStatisticsSupport(e, i), s), r = await this._reschedule(() => this._executeGeometryQuery(e, s), s), r = await this._reschedule(() => r.executeAggregateIdsQuery(e), s), r = await this._reschedule(() => r.executeObjectIdsQuery(e), s), r = await this._reschedule(() => r.executeTimeQuery(e), s), r = await this._reschedule(() => r.executeAttributesQuery(e), s);\n    } catch (a) {\n      if (a !== O) throw a;\n      r = new j([], null, this);\n    }\n\n    return r.createSummaryStatisticsResponse(e, i);\n  }\n\n  async _schedule(e, t) {\n    return this._frameQueue ? this._frameQueue.push(e, t) : e();\n  }\n\n  async _reschedule(e, t) {\n    return this._frameQueue ? this._frameQueue.unshift(e, t) : e();\n  }\n\n  get running() {\n    return this._frameQueue.length > 0;\n  }\n\n  runTask(e) {\n    for (this._budget = e; !e.done && this._frameQueue && this._frameQueue.process();) e.madeProgress();\n\n    this._budget = null;\n  }\n\n  _getAll() {\n    if (!this._allItems) {\n      const e = [];\n      this.featureStore.forEach(t => e.push(t)), this._allItems = new j(e, null, this);\n    }\n\n    return this._allItems;\n  }\n\n  async _executeGeometryQuery(e, t) {\n    const {\n      geometry: i,\n      outSR: r,\n      spatialRel: a,\n      returnGeometry: n,\n      returnCentroid: u\n    } = e,\n          o = n || u,\n          c = g(r) && !x(this.spatialReference, r),\n          h = this._geometryQueryCache ? c && o ? JSON.stringify({\n      geometry: i,\n      spatialRelationship: a,\n      outSpatialReference: r\n    }) : JSON.stringify({\n      geometry: i,\n      spatialRelationship: a\n    }) : null;\n\n    if (h) {\n      const e = this._geometryQueryCache.get(h);\n\n      if (!s(e)) return e;\n    }\n\n    const l = async e => {\n      if (c && o) {\n        const t = await e.project(r);\n        return h && this._geometryQueryCache.put(h, t, t.size || 1), t;\n      }\n\n      return h && this._geometryQueryCache.put(h, e, e.size || 1), e;\n    };\n\n    if (!i) return l(this._getAll());\n    const p = this.featureAdapter;\n\n    if (\"esriSpatialRelDisjoint\" === a) {\n      const e = this._searchFeatures(this._getQueryBBoxes(i));\n\n      if (!e.length) return l(this._getAll());\n      let s, r;\n      const n = new Set();\n\n      for (const t of e) n.add(p.getObjectId(t));\n\n      await this._reschedule(() => {\n        let e = 0;\n        s = new Array(n.size), this.featureStore.forEach(t => s[e++] = t), r = n;\n      }, t);\n      return l(await this._reschedule(async () => {\n        const e = await A(a, i, this.geometryType, this.hasZ, this.hasM),\n              n = t => !r.has(p.getObjectId(t)) || e(p.getGeometry(t));\n\n        return new j(await this._runSpatialFilter(s, n, t), i, this);\n      }, t));\n    }\n\n    const m = this._searchFeatures(this._getQueryBBoxes(i));\n\n    if (!m.length) {\n      const e = new j([], i, this);\n      return h && this._geometryQueryCache.put(h, e, e.size || 1), e;\n    }\n\n    if (this._canExecuteSoloPass(i, e)) return l(new j(m, i, this));\n    const d = await A(a, i, this.geometryType, this.hasZ, this.hasM),\n          y = await this._runSpatialFilter(m, e => d(p.getGeometry(e)), t);\n    return l(new j(y, i, this));\n  }\n\n  async _runSpatialFilter(e, t, i) {\n    if (!t) return e;\n    if (!this._budget) return e.filter(e => t(e));\n    let s = 0;\n\n    const r = new Array(),\n          a = async () => {\n      for (; s < e.length;) {\n        const n = e[s];\n        t(n) && r.push(n), this._budget.done && (await this._reschedule(() => a(), i)), ++s;\n      }\n    };\n\n    return this._reschedule(() => a(), i).then(() => r);\n  }\n\n  _canExecuteSoloPass(e, t) {\n    const {\n      geometryType: i\n    } = this,\n          {\n      spatialRel: s\n    } = t;\n    return E(e) && (\"esriSpatialRelEnvelopeIntersects\" === s || \"esriGeometryPoint\" === i && (\"esriSpatialRelIntersects\" === s || \"esriSpatialRelContains\" === s || \"esriSpatialRelWithin\" === s));\n  }\n\n  _getQueryBBoxes(e) {\n    if (E(e)) {\n      if (y(e)) return [l(e.xmin, e.ymin, e.xmax, e.ymax)];\n      if (f(e)) return e.rings.map(e => l(Math.min(e[0][0], e[2][0]), Math.min(e[0][1], e[2][1]), Math.max(e[0][0], e[2][0]), Math.max(e[0][1], e[2][1])));\n    }\n\n    return [m(p(), e)];\n  }\n\n  _searchFeatures(e) {\n    for (const s of e) this.featureStore.forEachInBounds(s, e => {\n      U.add(e);\n    });\n\n    const t = new Array(U.size);\n    let i = 0;\n    return U.forEach(e => t[i++] = e), U.clear(), t;\n  }\n\n  async _checkSummaryStatisticsSupport(t, i) {\n    if (t.distance < 0 || null != t.geometryPrecision || t.multipatchOption || t.pixelSize || t.relationParam || t.text || t.outStatistics || t.groupByFieldsForStatistics || t.having || t.orderByFields) throw new e(q, \"Unsupported query options\", {\n      query: t\n    });\n    return Promise.all([this._checkAttributesQuerySupport(t), this._checkSummaryStatisticsParamsSupport(i), k(t, this.geometryType, this.spatialReference), F(this.spatialReference, t.outSR)]).then(() => t);\n  }\n\n  async _checkSummaryStatisticsParamsSupport(t) {\n    const i = await G({\n      field: t.field,\n      normalizationField: t.normalizationField,\n      valueExpression: t.valueExpression\n    });\n    if (!i.length) throw new e(q, \"params should have atleast a field or valueExpression\", {\n      params: t\n    });\n    w(this.fieldsIndex, i, \"params contains missing fields\");\n  }\n\n  async _checkQuerySupport(t) {\n    if (t.distance < 0 || null != t.geometryPrecision || t.multipatchOption || t.pixelSize || t.relationParam || t.text) throw new e(q, \"Unsupported query options\", {\n      query: t\n    });\n    return Promise.all([this._checkAttributesQuerySupport(t), this._checkStatisticsQuerySupport(t), k(t, this.geometryType, this.spatialReference), F(this.spatialReference, t.outSR)]).then(() => t);\n  }\n\n  _checkAttributesQuerySupport(t) {\n    const {\n      outFields: i,\n      orderByFields: s,\n      returnDistinctValues: r,\n      outStatistics: a\n    } = t,\n          n = a ? a.map(e => e.outStatisticFieldName && e.outStatisticFieldName.toLowerCase()) : [];\n\n    if (s && s.length > 0) {\n      const e = \" asc\",\n            t = \" desc\",\n            i = s.map(i => {\n        const s = i.toLowerCase();\n        return s.indexOf(e) > -1 ? s.split(e)[0] : s.indexOf(t) > -1 ? s.split(t)[0] : i;\n      }).filter(e => -1 === n.indexOf(e));\n      w(this.fieldsIndex, i, \"orderByFields contains missing fields\");\n    }\n\n    if (i && i.length > 0) w(this.fieldsIndex, i, \"outFields contains missing fields\");else if (r) throw new e(q, \"outFields should be specified for returnDistinctValues\", {\n      query: t\n    });\n    S(this.fieldsIndex, t.where);\n  }\n\n  async _checkStatisticsQuerySupport(t) {\n    const {\n      outStatistics: i,\n      groupByFieldsForStatistics: s,\n      having: r\n    } = t,\n          a = s && s.length,\n          n = i && i.length;\n\n    if (r) {\n      if (!a || !n) throw new e(q, \"outStatistics and groupByFieldsForStatistics should be specified with having\", {\n        query: t\n      });\n      Q(this.fieldsIndex, r, i);\n    }\n\n    if (n) {\n      if (!v(i)) return;\n      const r = i.map(e => e.onStatisticField);\n      w(this.fieldsIndex, r, \"onStatisticFields contains missing fields\"), a && w(this.fieldsIndex, s, \"groupByFieldsForStatistics contains missing fields\");\n\n      for (const s of i) {\n        const {\n          onStatisticField: i,\n          statisticType: r\n        } = s;\n\n        if ((\"percentile_disc\" === r || \"percentile_cont\" === r) && \"statisticParameters\" in s) {\n          const {\n            statisticParameters: i\n          } = s;\n          if (!i) throw new e(q, \"statisticParamters should be set for percentile type\", {\n            definition: s,\n            query: t\n          });\n        } else if (\"count\" !== r && i && R(i, this.fieldsIndex)) throw new e(q, \"outStatistics contains non-numeric fields\", {\n          definition: s,\n          query: t\n        });\n      }\n    }\n  }\n\n}\n\nconst J = h(),\n      L = h();\nexport default H;\nexport { M as Feature };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/layers/graphics/data/QueryEngine.js"],"names":["e","clone","t","isNone","i","isUndefined","s","MemCache","r","MemCacheStorage","a","getMetersPerUnitForSR","n","set","u","NEGATIVE_INFINITY","o","expandWithAABB","c","create","h","fromValues","l","p","getBoundsXY","m","fromJSON","d","isExtent","y","isPolygon","f","normalizeCentralMeridian","_","equals","x","isValid","g","validateFields","w","validateWhere","S","validateHaving","Q","hasInvalidFieldType","R","project","I","checkProjectionSupport","F","queryCapabilities","b","j","getSpatialQueryOperator","A","canQueryWithRBush","E","checkSpatialQuerySupport","k","getTimeExtent","C","cleanFromGeometryEngine","T","normalizeQuery","B","QUERY_ENGINE_EMPTY_RESULT","O","z","P","getFieldsList","G","v","every","statisticType","q","M","constructor","attributes","geometry","centroid","filterFlags","groupId","displayId","U","Set","N","Z","H","capabilities","query","geometryType","hasM","hasZ","objectIdField","spatialReference","definitionExpression","featureStore","aggregateAdapter","_changeHandle","events","on","clearCache","timeInfo","cacheSpatialQueries","_geometryQueryCache","fieldsIndex","fields","scheduler","priority","_frameQueue","_frameTask","registerTask","destroy","remove","cancelAll","featureAdapter","fullExtent","fullBounds","xmin","ymin","xmax","ymax","timeExtent","_timeExtent","clear","_allItems","executeQuery","_schedule","_reschedule","_checkQuerySupport","_executeGeometryQuery","executeAggregateIdsQuery","executeObjectIdsQuery","executeTimeQuery","executeAttributesQuery","createQueryResponse","executeQueryForCount","returnGeometry","returnCentroid","outSR","createQueryResponseForCount","executeQueryForExtent","size","count","extent","L","forEachBounds","items","J","isFinite","zmin","zmax","executeQueryForIds","executeQueryForIdSet","then","Array","from","add","getObjectId","executeQueryForSnapping","point","distance","types","candidates","signal","_searchFeatures","_getQueryBBoxes","toJSON","Math","max","createSnappingResponse","executeQueryForLatestObservations","trackIdField","filterLatest","executeQueryForSummaryStatistics","_checkSummaryStatisticsSupport","createSummaryStatisticsResponse","push","unshift","running","length","runTask","_budget","done","process","madeProgress","_getAll","forEach","spatialRel","JSON","stringify","spatialRelationship","outSpatialReference","get","put","has","getGeometry","_runSpatialFilter","_canExecuteSoloPass","filter","rings","map","min","forEachInBounds","geometryPrecision","multipatchOption","pixelSize","relationParam","text","outStatistics","groupByFieldsForStatistics","having","orderByFields","Promise","all","_checkAttributesQuerySupport","_checkSummaryStatisticsParamsSupport","field","normalizationField","valueExpression","params","_checkStatisticsQuerySupport","outFields","returnDistinctValues","outStatisticFieldName","toLowerCase","indexOf","split","where","onStatisticField","statisticParameters","definition","Feature"],"mappings":"AAAA;AACA;AACA;AACA;AACA,OAAOA,CAAP,MAAa,wBAAb;AAAsC,SAAOC,KAAK,IAAIC,CAAhB,QAAsB,uBAAtB;AAA8C,SAAOC,MAAM,IAAIC,CAAjB,EAAmBC,WAAW,IAAIC,CAAlC,QAAwC,wBAAxC;AAAiE,SAAOC,QAAQ,IAAIC,CAAnB,EAAqBC,eAAe,IAAIC,CAAxC,QAA8C,2BAA9C;AAA0E,SAAOC,qBAAqB,IAAIC,CAAhC,QAAsC,4BAAtC;AAAmE,SAAOC,GAAG,IAAIC,CAAd,EAAgBC,iBAAiB,IAAIC,CAArC,EAAuCC,cAAc,IAAIC,CAAzD,EAA2DC,MAAM,IAAIC,CAArE,QAA2E,4CAA3E;AAAwH,SAAOC,UAAU,IAAIC,CAArB,EAAuBH,MAAM,IAAII,CAAjC,QAAuC,6CAAvC;AAAqF,SAAOC,WAAW,IAAIC,CAAtB,QAA4B,0CAA5B;AAAuE,SAAOC,QAAQ,IAAIC,CAAnB,EAAqBC,QAAQ,IAAIC,CAAjC,EAAmCC,SAAS,IAAIC,CAAhD,QAAsD,wCAAtD;AAA+F,SAAOC,wBAAwB,IAAIC,CAAnC,QAAyC,6CAAzC;AAAuF,SAAOC,MAAM,IAAIC,CAAjB,EAAmBC,OAAO,IAAIC,CAA9B,QAAoC,oDAApC;AAAyF,SAAOC,cAAc,IAAIC,CAAzB,EAA2BC,aAAa,IAAIC,CAA5C,EAA8CC,cAAc,IAAIC,CAAhE,EAAkEC,mBAAmB,IAAIC,CAAzF,QAA+F,uBAA/F;AAAuH,SAAOC,OAAO,IAAIC,CAAlB,EAAoBC,sBAAsB,IAAIC,CAA9C,QAAoD,wBAApD;AAA6E,SAAOC,iBAAiB,IAAIC,CAA5B,QAAkC,8BAAlC;AAAiE,OAAOC,CAAP,MAAa,wBAAb;AAAsC,SAAOC,uBAAuB,IAAIC,CAAlC,EAAoCC,iBAAiB,IAAIC,CAAzD,EAA2DC,wBAAwB,IAAIC,CAAvF,QAA6F,0BAA7F;AAAwH,SAAOC,aAAa,IAAIC,CAAxB,QAA8B,kBAA9B;AAAiD,SAAOC,uBAAuB,IAAIC,CAAlC,EAAoCC,cAAc,IAAIC,CAAtD,EAAwDC,yBAAyB,IAAIC,CAArF,QAA2F,YAA3F;AAAwG,OAAOC,CAAP,MAAa,8BAAb;AAA4C,OAAOC,CAAP,MAAa,+BAAb;AAA6C,SAAOC,aAAa,IAAIC,CAAxB,QAA8B,wCAA9B;;AAAuE,SAASC,CAAT,CAAWvE,CAAX,EAAa;AAAC,SAAOA,CAAC,CAACwE,KAAF,CAASxE,CAAC,IAAE,mBAAiBA,CAAC,CAACyE,aAA/B,CAAP;AAAsD;;AAAA,MAAMC,CAAC,GAAC,iCAAR;;AAA0C,MAAMC,CAAN,CAAO;AAACC,EAAAA,WAAW,CAAC5E,CAAD,EAAGE,CAAC,GAAC,IAAL,EAAUE,CAAV,EAAYE,CAAZ,EAAcE,CAAd,EAAgB;AAAC,SAAKqE,UAAL,GAAgB7E,CAAhB,EAAkB,KAAK8E,QAAL,GAAc1E,CAAhC,EAAkC,KAAK2E,QAAL,GAAczE,CAAhD,EAAkD,KAAK0E,WAAL,GAAiBxE,CAAnE,EAAqE,KAAKyE,OAAL,GAAa,CAAC,CAAnF,EAAqF,KAAKC,SAAL,GAAehF,CAApG;AAAsG;;AAAnI;;AAAoI,MAAMiF,CAAC,GAAC,IAAIC,GAAJ,EAAR;AAAA,MAAgBC,CAAC,GAAC,IAAI3E,CAAJ,CAAM,GAAN,CAAlB;AAA6B,IAAI4E,CAAC,GAAC,CAAN;;AAAQ,MAAMC,CAAN,CAAO;AAACX,EAAAA,WAAW,CAAC5E,CAAD,EAAG;AAAC,SAAKwF,YAAL,GAAkB;AAACC,MAAAA,KAAK,EAACtC;AAAP,KAAlB,EAA4B,KAAKuC,YAAL,GAAkB1F,CAAC,CAAC0F,YAAhD,EAA6D,KAAKC,IAAL,GAAU3F,CAAC,CAAC2F,IAAzE,EAA8E,KAAKC,IAAL,GAAU5F,CAAC,CAAC4F,IAA1F,EAA+F,KAAKC,aAAL,GAAmB7F,CAAC,CAAC6F,aAApH,EAAkI,KAAKC,gBAAL,GAAsB9F,CAAC,CAAC8F,gBAA1J,EAA2K,KAAKC,oBAAL,GAA0B/F,CAAC,CAAC+F,oBAAvM,EAA4N,KAAKC,YAAL,GAAkBhG,CAAC,CAACgG,YAAhP,EAA6P,KAAKC,gBAAL,GAAsBjG,CAAC,CAACiG,gBAArR,EAAsS,KAAKC,aAAL,GAAmB,KAAKF,YAAL,CAAkBG,MAAlB,CAAyBC,EAAzB,CAA4B,SAA5B,EAAuC,MAAI,KAAKC,UAAL,EAA3C,CAAzT,EAAwX,KAAKC,QAAL,GAActG,CAAC,CAACsG,QAAxY,EAAiZtG,CAAC,CAACuG,mBAAF,KAAwB,KAAKC,mBAAL,GAAyB,IAAIhG,CAAJ,CAAM8E,CAAC,KAAG,IAAV,EAAeD,CAAf,CAAjD,CAAjZ,EAAqd,KAAKoB,WAAL,GAAiB,IAAItC,CAAJ,CAAMnE,CAAC,CAAC0G,MAAR,CAAte,EAAsf1G,CAAC,CAAC2G,SAAF,IAAa3G,CAAC,CAAC4G,QAAf,KAA0B,KAAKC,WAAL,GAAiB,IAAIzC,CAAJ,EAAjB,EAAuB,KAAK0C,UAAL,GAAgB9G,CAAC,CAAC2G,SAAF,CAAYI,YAAZ,CAAyB/G,CAAC,CAAC4G,QAA3B,EAAoC,IAApC,CAAjE,CAAtf;AAAkmB;;AAAAI,EAAAA,OAAO,GAAE;AAAC,SAAKF,UAAL,KAAkB,KAAKA,UAAL,CAAgBG,MAAhB,IAAyB,KAAKH,UAAL,GAAgB,IAAzC,EAA8C,KAAKD,WAAL,CAAiBK,SAAjB,EAA9C,EAA2E,KAAKL,WAAL,GAAiB,IAA9G,GAAoH,KAAKR,UAAL,EAApH,EAAsI,KAAKG,mBAAL,IAA0B,KAAKA,mBAAL,CAAyBQ,OAAzB,EAAhK,EAAmM,KAAKd,aAAL,KAAqB,KAAKA,aAAL,CAAmBe,MAAnB,IAA4B,KAAKf,aAAL,GAAmB,IAApE,CAAnM,EAA6Q,KAAKO,WAAL,CAAiBO,OAAjB,EAA7Q;AAAwS;;AAAkB,MAAdG,cAAc,GAAE;AAAC,WAAO,KAAKnB,YAAL,CAAkBmB,cAAzB;AAAwC;;AAAc,MAAVC,UAAU,GAAE;AAAC,UAAMpH,CAAC,GAAC,KAAKgG,YAAL,CAAkBqB,UAA1B;AAAqC,WAAOrH,CAAC,GAAC;AAACsH,MAAAA,IAAI,EAACtH,CAAC,CAAC,CAAD,CAAP;AAAWuH,MAAAA,IAAI,EAACvH,CAAC,CAAC,CAAD,CAAjB;AAAqBwH,MAAAA,IAAI,EAACxH,CAAC,CAAC,CAAD,CAA3B;AAA+ByH,MAAAA,IAAI,EAACzH,CAAC,CAAC,CAAD,CAArC;AAAyC8F,MAAAA,gBAAgB,EAAChC,CAAC,CAAC,KAAKgC,gBAAN;AAA3D,KAAD,GAAqF,IAA7F;AAAkG;;AAAc,MAAV4B,UAAU,GAAE;AAAC,WAAO,KAAKpB,QAAL,IAAe,KAAKqB,WAAL,KAAmB,KAAKA,WAAL,GAAiB/D,CAAC,CAAC,KAAK0C,QAAN,EAAe,KAAKN,YAApB,CAArC,GAAwE,KAAK2B,WAA5F,IAAyG,IAAhH;AAAqH;;AAAAtB,EAAAA,UAAU,GAAE;AAAC,SAAKG,mBAAL,IAA0B,KAAKA,mBAAL,CAAyBoB,KAAzB,EAA1B,EAA2D,KAAKC,SAAL,GAAe,IAA1E,EAA+E,KAAKF,WAAL,GAAiB,IAAhG;AAAqG;;AAAkB,QAAZG,YAAY,CAAC9H,CAAC,GAAC,EAAH,EAAMI,CAAN,EAAQ;AAAC,QAAIE,CAAJ;AAAA,QAAME,CAAC,GAACN,CAAC,CAACF,CAAD,CAAT;;AAAa,QAAG;AAACQ,MAAAA,CAAC,GAAC,MAAM,KAAKuH,SAAL,CAAgB,MAAI/D,CAAC,CAACxD,CAAD,EAAG,KAAKuF,oBAAR,EAA6B,KAAKD,gBAAlC,CAArB,EAA0E1F,CAA1E,CAAR,EAAqFI,CAAC,GAAC,MAAM,KAAKwH,WAAL,CAAkB,MAAI,KAAKC,kBAAL,CAAwBzH,CAAxB,CAAtB,EAAkDJ,CAAlD,CAA7F,EAAkJE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI,KAAKE,qBAAL,CAA2B1H,CAA3B,EAA6BJ,CAA7B,CAAtB,EAAuDA,CAAvD,CAA1J,EAAoNE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI1H,CAAC,CAAC6H,wBAAF,CAA2B3H,CAA3B,CAAtB,EAAqDJ,CAArD,CAA5N,EAAoRE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI1H,CAAC,CAAC8H,qBAAF,CAAwB5H,CAAxB,CAAtB,EAAkDJ,CAAlD,CAA5R,EAAiVE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI1H,CAAC,CAAC+H,gBAAF,CAAmB7H,CAAnB,CAAtB,EAA6CJ,CAA7C,CAAzV,EAAyYE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI1H,CAAC,CAACgI,sBAAF,CAAyB9H,CAAzB,CAAtB,EAAmDJ,CAAnD,CAAjZ;AAAuc,KAA3c,CAA2c,OAAMM,CAAN,EAAQ;AAAC,UAAGA,CAAC,KAAGwD,CAAP,EAAS,MAAMxD,CAAN;AAAQJ,MAAAA,CAAC,GAAC,IAAI8C,CAAJ,CAAM,EAAN,EAAS,IAAT,EAAc,IAAd,CAAF;AAAsB;;AAAA,WAAO9C,CAAC,CAACiI,mBAAF,CAAsB/H,CAAtB,CAAP;AAAgC;;AAA0B,QAApBgI,oBAAoB,CAACxI,CAAC,GAAC,EAAH,EAAMI,CAAN,EAAQ;AAAC,QAAIE,CAAJ;AAAA,QAAME,CAAC,GAACN,CAAC,CAACF,CAAD,CAAT;AAAaQ,IAAAA,CAAC,CAACiI,cAAF,GAAiB,CAAC,CAAlB,EAAoBjI,CAAC,CAACkI,cAAF,GAAiB,CAAC,CAAtC,EAAwClI,CAAC,CAACmI,KAAF,GAAQ,IAAhD;;AAAqD,QAAG;AAACnI,MAAAA,CAAC,GAAC,MAAM,KAAKuH,SAAL,CAAgB,MAAI/D,CAAC,CAACxD,CAAD,EAAG,KAAKuF,oBAAR,EAA6B,KAAKD,gBAAlC,CAArB,EAA0E1F,CAA1E,CAAR,EAAqFI,CAAC,GAAC,MAAM,KAAKwH,WAAL,CAAkB,MAAI,KAAKC,kBAAL,CAAwBzH,CAAxB,CAAtB,EAAkDJ,CAAlD,CAA7F,EAAkJE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI,KAAKE,qBAAL,CAA2B1H,CAA3B,EAA6BJ,CAA7B,CAAtB,EAAuDA,CAAvD,CAA1J,EAAoNE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI1H,CAAC,CAAC6H,wBAAF,CAA2B3H,CAA3B,CAAtB,EAAqDJ,CAArD,CAA5N,EAAoRE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI1H,CAAC,CAAC8H,qBAAF,CAAwB5H,CAAxB,CAAtB,EAAkDJ,CAAlD,CAA5R,EAAiVE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI1H,CAAC,CAAC+H,gBAAF,CAAmB7H,CAAnB,CAAtB,EAA6CJ,CAA7C,CAAzV,EAAyYE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI1H,CAAC,CAACgI,sBAAF,CAAyB9H,CAAzB,CAAtB,EAAmDJ,CAAnD,CAAjZ;AAAuc,KAA3c,CAA2c,OAAMM,CAAN,EAAQ;AAAC,UAAGA,CAAC,KAAGwD,CAAP,EAAS,MAAMxD,CAAN;AAAQ,aAAO,CAAP;AAAS;;AAAA,WAAOJ,CAAC,CAACsI,2BAAF,CAA8BpI,CAA9B,CAAP;AAAwC;;AAA2B,QAArBqI,qBAAqB,CAAC7I,CAAC,GAAC,EAAH,EAAMI,CAAN,EAAQ;AAAC,QAAIE,CAAJ;AAAA,QAAME,CAAC,GAACN,CAAC,CAACF,CAAD,CAAT;AAAa,UAAMU,CAAC,GAACF,CAAC,CAACmI,KAAV;;AAAgB,QAAG;AAACnI,MAAAA,CAAC,GAAC,MAAM,KAAKuH,SAAL,CAAgB,MAAI/D,CAAC,CAACxD,CAAD,EAAG,KAAKuF,oBAAR,EAA6B,KAAKD,gBAAlC,CAArB,EAA0E1F,CAA1E,CAAR,EAAqFI,CAAC,GAAC,MAAM,KAAKwH,WAAL,CAAkB,MAAI,KAAKC,kBAAL,CAAwBzH,CAAxB,CAAtB,EAAkDJ,CAAlD,CAA7F,EAAkJI,CAAC,CAACiI,cAAF,GAAiB,CAAC,CAApK,EAAsKjI,CAAC,CAACkI,cAAF,GAAiB,CAAC,CAAxL,EAA0LlI,CAAC,CAACmI,KAAF,GAAQ,IAAlM,EAAuMrI,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI,KAAKE,qBAAL,CAA2B1H,CAA3B,EAA6BJ,CAA7B,CAAtB,EAAuDA,CAAvD,CAA/M,EAAyQE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI1H,CAAC,CAAC6H,wBAAF,CAA2B3H,CAA3B,CAAtB,EAAqDJ,CAArD,CAAjR,EAAyUE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI1H,CAAC,CAAC8H,qBAAF,CAAwB5H,CAAxB,CAAtB,EAAkDJ,CAAlD,CAAjV,EAAsYE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI1H,CAAC,CAAC+H,gBAAF,CAAmB7H,CAAnB,CAAtB,EAA6CJ,CAA7C,CAA9Y,EAA8bE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI1H,CAAC,CAACgI,sBAAF,CAAyB9H,CAAzB,CAAtB,EAAmDJ,CAAnD,CAAtc;AAA4f,YAAMJ,CAAC,GAACM,CAAC,CAACwI,IAAV;AAAe,UAAG,CAAC9I,CAAJ,EAAM,OAAM;AAAC+I,QAAAA,KAAK,EAAC/I,CAAP;AAASgJ,QAAAA,MAAM,EAAC;AAAhB,OAAN;AAA4BlI,MAAAA,CAAC,CAACmI,CAAD,EAAGjI,CAAH,CAAD,EAAO,KAAKgF,YAAL,CAAkBkD,aAAlB,CAAgC5I,CAAC,CAAC6I,KAAlC,EAAyCnJ,CAAC,IAAEkB,CAAC,CAAC+H,CAAD,EAAGjJ,CAAH,CAA7C,EAAoDoJ,CAApD,CAAP;AAA8D,YAAMlJ,CAAC,GAAC;AAACoH,QAAAA,IAAI,EAAC2B,CAAC,CAAC,CAAD,CAAP;AAAW1B,QAAAA,IAAI,EAAC0B,CAAC,CAAC,CAAD,CAAjB;AAAqBzB,QAAAA,IAAI,EAACyB,CAAC,CAAC,CAAD,CAA3B;AAA+BxB,QAAAA,IAAI,EAACwB,CAAC,CAAC,CAAD,CAArC;AAAyCnD,QAAAA,gBAAgB,EAAChC,CAAC,CAAC,KAAKgC,gBAAN;AAA3D,OAAR;AAA4F,WAAKF,IAAL,IAAWyD,QAAQ,CAACJ,CAAC,CAAC,CAAD,CAAF,CAAnB,IAA2BI,QAAQ,CAACJ,CAAC,CAAC,CAAD,CAAF,CAAnC,KAA4C/I,CAAC,CAACoJ,IAAF,GAAOL,CAAC,CAAC,CAAD,CAAR,EAAY/I,CAAC,CAACqJ,IAAF,GAAON,CAAC,CAAC,CAAD,CAAhE;AAAqE,YAAM7H,CAAC,GAAC2B,CAAC,CAAC7C,CAAD,EAAGI,CAAC,CAACwF,gBAAL,EAAsBpF,CAAtB,CAAT;;AAAkC,UAAGU,CAAC,CAAC0E,gBAAF,GAAmBhC,CAAC,CAACpD,CAAC,IAAE,KAAKoF,gBAAT,CAApB,EAA+C1E,CAAC,CAACoG,IAAF,GAAOpG,CAAC,CAACkG,IAAT,IAAe,CAAjE,EAAmE;AAAC,cAAMtH,CAAC,GAACY,CAAC,CAACQ,CAAC,CAAC0E,gBAAH,CAAT;AAA8B1E,QAAAA,CAAC,CAACkG,IAAF,IAAQtH,CAAR,EAAUoB,CAAC,CAACoG,IAAF,IAAQxH,CAAlB;AAAoB;;AAAA,UAAGoB,CAAC,CAACqG,IAAF,GAAOrG,CAAC,CAACmG,IAAT,IAAe,CAAlB,EAAoB;AAAC,cAAMvH,CAAC,GAACY,CAAC,CAACQ,CAAC,CAAC0E,gBAAH,CAAT;AAA8B1E,QAAAA,CAAC,CAACmG,IAAF,IAAQvH,CAAR,EAAUoB,CAAC,CAACqG,IAAF,IAAQzH,CAAlB;AAAoB;;AAAA,UAAG,KAAK4F,IAAL,IAAW,QAAMxE,CAAC,CAACkI,IAAnB,IAAyB,QAAMlI,CAAC,CAACmI,IAAjC,IAAuCnI,CAAC,CAACmI,IAAF,GAAOnI,CAAC,CAACkI,IAAT,IAAe,CAAzD,EAA2D;AAAC,cAAMtJ,CAAC,GAACY,CAAC,CAACQ,CAAC,CAAC0E,gBAAH,CAAT;AAA8B1E,QAAAA,CAAC,CAACkI,IAAF,IAAQtJ,CAAR,EAAUoB,CAAC,CAACmI,IAAF,IAAQvJ,CAAlB;AAAoB;;AAAA,aAAM;AAAC+I,QAAAA,KAAK,EAAC/I,CAAP;AAASgJ,QAAAA,MAAM,EAAC5H;AAAhB,OAAN;AAAyB,KAAtnC,CAAsnC,OAAMA,CAAN,EAAQ;AAAC,UAAGA,CAAC,KAAG8C,CAAP,EAAS,OAAM;AAAC6E,QAAAA,KAAK,EAAC,CAAP;AAASC,QAAAA,MAAM,EAAC;AAAhB,OAAN;AAA4B,YAAM5H,CAAN;AAAQ;AAAC;;AAAwB,QAAlBoI,kBAAkB,CAACxJ,CAAC,GAAC,EAAH,EAAME,CAAN,EAAQ;AAAC,WAAO,KAAKuJ,oBAAL,CAA0BzJ,CAA1B,EAA4BE,CAA5B,EAA+BwJ,IAA/B,CAAqC1J,CAAC,IAAE2J,KAAK,CAACC,IAAN,CAAW5J,CAAX,CAAxC,CAAP;AAA+D;;AAA0B,QAApByJ,oBAAoB,CAACzJ,CAAC,GAAC,EAAH,EAAMI,CAAN,EAAQ;AAAC,QAAIE,CAAJ;AAAA,QAAME,CAAC,GAACN,CAAC,CAACF,CAAD,CAAT;AAAaQ,IAAAA,CAAC,CAACiI,cAAF,GAAiB,CAAC,CAAlB,EAAoBjI,CAAC,CAACkI,cAAF,GAAiB,CAAC,CAAtC,EAAwClI,CAAC,CAACmI,KAAF,GAAQ,IAAhD;;AAAqD,QAAG;AAACnI,MAAAA,CAAC,GAAC,MAAM,KAAKuH,SAAL,CAAgB,MAAI/D,CAAC,CAACxD,CAAD,EAAG,KAAKuF,oBAAR,EAA6B,KAAKD,gBAAlC,CAArB,EAA0E1F,CAA1E,CAAR,EAAqFI,CAAC,GAAC,MAAM,KAAKwH,WAAL,CAAkB,MAAI,KAAKC,kBAAL,CAAwBzH,CAAxB,CAAtB,EAAkDJ,CAAlD,CAA7F,EAAkJE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI,KAAKE,qBAAL,CAA2B1H,CAA3B,EAA6BJ,CAA7B,CAAtB,EAAuDA,CAAvD,CAA1J,EAAoNE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI1H,CAAC,CAAC6H,wBAAF,CAA2B3H,CAA3B,CAAtB,EAAqDJ,CAArD,CAA5N,EAAoRE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI1H,CAAC,CAAC8H,qBAAF,CAAwB5H,CAAxB,CAAtB,EAAkDJ,CAAlD,CAA5R,EAAiVE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI1H,CAAC,CAAC+H,gBAAF,CAAmB7H,CAAnB,CAAtB,EAA6CJ,CAA7C,CAAzV,EAAyYE,CAAC,GAAC,MAAM,KAAK0H,WAAL,CAAkB,MAAI1H,CAAC,CAACgI,sBAAF,CAAyB9H,CAAzB,CAAtB,EAAmDJ,CAAnD,CAAjZ;AAAuc,YAAMJ,CAAC,GAACM,CAAC,CAAC6I,KAAV;AAAA,YAAgBjJ,CAAC,GAAC,IAAIkF,GAAJ,EAAlB;AAA0B,aAAO,MAAM,KAAK4C,WAAL,CAAkB,MAAI;AAAC,aAAI,MAAM5H,CAAV,IAAeJ,CAAf,EAAiBE,CAAC,CAAC2J,GAAF,CAAMvJ,CAAC,CAAC6G,cAAF,CAAiB2C,WAAjB,CAA6B1J,CAA7B,CAAN;AAAuC,OAA/E,EAAiFA,CAAjF,CAAN,EAA0FF,CAAjG;AAAmG,KAAxkB,CAAwkB,OAAMQ,CAAN,EAAQ;AAAC,UAAGA,CAAC,KAAGwD,CAAP,EAAS,OAAO,IAAIkB,GAAJ,EAAP;AAAe,YAAM1E,CAAN;AAAQ;AAAC;;AAA6B,QAAvBqJ,uBAAuB,CAAC/J,CAAD,EAAGE,CAAH,EAAK;AAAC,UAAK;AAAC8J,MAAAA,KAAK,EAAC1J,CAAP;AAAS2J,MAAAA,QAAQ,EAACzJ,CAAlB;AAAoB0J,MAAAA,KAAK,EAACxJ;AAA1B,QAA6BV,CAAlC;AAAoC,QAAG,MAAIU,CAAP,EAAS,OAAM;AAACyJ,MAAAA,UAAU,EAAC;AAAZ,KAAN;AAAsB,UAAMvJ,CAAC,GAAC,MAAM,KAAKoH,WAAL,CAAkB,MAAI,KAAKC,kBAAL,CAAwBjI,CAAC,CAACyF,KAA1B,CAAtB,EAAwDvF,CAAxD,CAAd;AAAA,UAAyEY,CAAC,GAAC,CAACqB,CAAC,CAAC7B,CAAC,CAACwF,gBAAH,EAAoB,KAAKA,gBAAzB,CAA7E;AAAwHhF,IAAAA,CAAC,KAAE,MAAMmC,CAAC,CAAC3C,CAAC,CAACwF,gBAAH,EAAoB,KAAKA,gBAAzB,CAAT,CAAD;AAAqD,UAAM9E,CAAC,GAAC,YAAU,OAAOR,CAAjB,GAAmBA,CAAnB,GAAqBA,CAAC,CAAC2B,CAA/B;AAAA,UAAiCjB,CAAC,GAAC,YAAU,OAAOV,CAAjB,GAAmBA,CAAnB,GAAqBA,CAAC,CAACqB,CAA1D;AAAA,UAA4DT,CAAC,GAAC;AAACkG,MAAAA,IAAI,EAAChH,CAAC,CAAC6B,CAAF,GAAInB,CAAV;AAAYwG,MAAAA,IAAI,EAAClH,CAAC,CAAC6B,CAAF,GAAInB,CAArB;AAAuBuG,MAAAA,IAAI,EAACjH,CAAC,CAACuB,CAAF,GAAIX,CAAhC;AAAkCuG,MAAAA,IAAI,EAACnH,CAAC,CAACuB,CAAF,GAAIX,CAA3C;AAA6C4E,MAAAA,gBAAgB,EAACxF,CAAC,CAACwF;AAAhE,KAA9D;AAAA,UAAgJxE,CAAC,GAACR,CAAC,GAACiC,CAAC,CAAC3B,CAAD,EAAG,KAAK0E,gBAAR,CAAF,GAA4B1E,CAA/K;AAAiL,QAAG,CAACE,CAAJ,EAAM,OAAM;AAAC6I,MAAAA,UAAU,EAAC;AAAZ,KAAN;AAAsB,UAAM5I,CAAC,GAAC,CAAC,MAAMU,CAAC,CAACN,CAAC,CAACrB,CAAD,CAAF,EAAM,IAAN,EAAW;AAAC8J,MAAAA,MAAM,EAAClK;AAAR,KAAX,CAAR,EAAgC,CAAhC,CAAR;AAAA,UAA2CuB,CAAC,GAAC,CAAC,MAAMQ,CAAC,CAACN,CAAC,CAACL,CAAD,CAAF,EAAM,IAAN,EAAW;AAAC8I,MAAAA,MAAM,EAAClK;AAAR,KAAX,CAAR,EAAgC,CAAhC,CAA7C;AAAgF,QAAGE,CAAC,CAACmB,CAAD,CAAD,IAAMnB,CAAC,CAACqB,CAAD,CAAV,EAAc,OAAM;AAAC0I,MAAAA,UAAU,EAAC;AAAZ,KAAN;AAAsB,QAAItI,CAAC,GAAC,IAAIuB,CAAJ,CAAM,KAAKiH,eAAL,CAAqB,KAAKC,eAAL,CAAqB7I,CAAC,CAAC8I,MAAF,EAArB,CAArB,CAAN,EAA6D,IAA7D,EAAkE,IAAlE,CAAN;AAA8E1I,IAAAA,CAAC,GAAC,MAAM,KAAKmG,WAAL,CAAkB,MAAInG,CAAC,CAACuG,qBAAF,CAAwBxH,CAAxB,CAAtB,EAAkDV,CAAlD,CAAR,EAA6D2B,CAAC,GAAC,MAAM,KAAKmG,WAAL,CAAkB,MAAInG,CAAC,CAACwG,gBAAF,CAAmBzH,CAAnB,CAAtB,EAA6CV,CAA7C,CAArE,EAAqH2B,CAAC,GAAC,MAAM,KAAKmG,WAAL,CAAkB,MAAInG,CAAC,CAACyG,sBAAF,CAAyB1H,CAAzB,CAAtB,EAAmDV,CAAnD,CAA7H;AAAmL,UAAM6B,CAAC,GAACR,CAAC,CAACgJ,MAAF,EAAR;AAAA,UAAmBlI,CAAC,GAACvB,CAAC,GAACiC,CAAC,CAAChB,CAAD,EAAG,KAAK+D,gBAAR,CAAF,GAA4B/D,CAAlD;AAAA,UAAoDQ,CAAC,GAACzB,CAAC,GAAC0J,IAAI,CAACC,GAAL,CAASnJ,CAAC,CAACkG,IAAF,GAAOlG,CAAC,CAACgG,IAAlB,EAAuBhG,CAAC,CAACmG,IAAF,GAAOnG,CAAC,CAACiG,IAAhC,IAAsC,CAAvC,GAAyC/G,CAAhG;AAAkG,WAAOqB,CAAC,CAAC6I,sBAAF,CAAyB,EAAC,GAAG1K,CAAJ;AAAMgK,MAAAA,KAAK,EAAC3H,CAAZ;AAAc4H,MAAAA,QAAQ,EAAC1H;AAAvB,KAAzB,EAAmDjC,CAAC,CAACwF,gBAArD,CAAP;AAA8E;;AAAuC,QAAjC6E,iCAAiC,CAACvK,CAAC,GAAC,EAAH,EAAME,CAAN,EAAQ;AAAC,QAAG,CAAC,KAAKgG,QAAN,IAAgB,CAAC,KAAKA,QAAL,CAAcsE,YAAlC,EAA+C,MAAM,IAAI5K,CAAJ,CAAM0E,CAAN,EAAQ,2CAAR,EAAoD;AAACe,MAAAA,KAAK,EAACrF,CAAP;AAASkG,MAAAA,QAAQ,EAAC,KAAKA;AAAvB,KAApD,CAAN;AAA4F,QAAI9F,CAAJ;AAAA,QAAME,CAAC,GAACR,CAAC,CAACE,CAAD,CAAT;;AAAa,QAAG;AAACM,MAAAA,CAAC,GAAC,MAAM,KAAKqH,SAAL,CAAgB,MAAI/D,CAAC,CAACtD,CAAD,EAAG,KAAKqF,oBAAR,EAA6B,KAAKD,gBAAlC,CAArB,EAA0ExF,CAA1E,CAAR,EAAqFI,CAAC,GAAC,MAAM,KAAKsH,WAAL,CAAkB,MAAI,KAAKC,kBAAL,CAAwBvH,CAAxB,CAAtB,EAAkDJ,CAAlD,CAA7F,EAAkJE,CAAC,GAAC,MAAM,KAAKwH,WAAL,CAAkB,MAAI,KAAKE,qBAAL,CAA2BxH,CAA3B,EAA6BJ,CAA7B,CAAtB,EAAuDA,CAAvD,CAA1J,EAAoNE,CAAC,GAAC,MAAM,KAAKwH,WAAL,CAAkB,MAAIxH,CAAC,CAAC2H,wBAAF,CAA2BzH,CAA3B,CAAtB,EAAqDJ,CAArD,CAA5N,EAAoRE,CAAC,GAAC,MAAM,KAAKwH,WAAL,CAAkB,MAAIxH,CAAC,CAAC4H,qBAAF,CAAwB1H,CAAxB,CAAtB,EAAkDJ,CAAlD,CAA5R,EAAiVE,CAAC,GAAC,MAAM,KAAKwH,WAAL,CAAkB,MAAIxH,CAAC,CAAC6H,gBAAF,CAAmB3H,CAAnB,CAAtB,EAA6CJ,CAA7C,CAAzV,EAAyYE,CAAC,GAAC,MAAM,KAAKwH,WAAL,CAAkB,MAAIxH,CAAC,CAAC8H,sBAAF,CAAyB5H,CAAzB,CAAtB,EAAmDJ,CAAnD,CAAjZ,EAAucE,CAAC,GAAC,MAAM,KAAKwH,WAAL,CAAkB,MAAIxH,CAAC,CAACqK,YAAF,EAAtB,EAAwCvK,CAAxC,CAA/c;AAA0f,KAA9f,CAA8f,OAAMM,CAAN,EAAQ;AAAC,UAAGA,CAAC,KAAGsD,CAAP,EAAS,MAAMtD,CAAN;AAAQJ,MAAAA,CAAC,GAAC,IAAI4C,CAAJ,CAAM,EAAN,EAAS,IAAT,EAAc,IAAd,CAAF;AAAsB;;AAAA,WAAO5C,CAAC,CAAC+H,mBAAF,CAAsB7H,CAAtB,CAAP;AAAgC;;AAAsC,QAAhCoK,gCAAgC,CAAC9K,CAAC,GAAC,EAAH,EAAMI,CAAN,EAAQE,CAAR,EAAU;AAAC,QAAIE,CAAJ;AAAMR,IAAAA,CAAC,GAACE,CAAC,CAACF,CAAD,CAAH;;AAAO,QAAG;AAACA,MAAAA,CAAC,GAAC,MAAM,KAAK+H,SAAL,CAAgB,MAAI/D,CAAC,CAAChE,CAAD,EAAG,KAAK+F,oBAAR,EAA6B,KAAKD,gBAAlC,CAArB,EAA0ExF,CAA1E,CAAR,EAAqFN,CAAC,GAAC,MAAM,KAAKgI,WAAL,CAAkB,MAAI,KAAK+C,8BAAL,CAAoC/K,CAApC,EAAsCI,CAAtC,CAAtB,EAAgEE,CAAhE,CAA7F,EAAgKE,CAAC,GAAC,MAAM,KAAKwH,WAAL,CAAkB,MAAI,KAAKE,qBAAL,CAA2BlI,CAA3B,EAA6BM,CAA7B,CAAtB,EAAuDA,CAAvD,CAAxK,EAAkOE,CAAC,GAAC,MAAM,KAAKwH,WAAL,CAAkB,MAAIxH,CAAC,CAAC2H,wBAAF,CAA2BnI,CAA3B,CAAtB,EAAqDM,CAArD,CAA1O,EAAkSE,CAAC,GAAC,MAAM,KAAKwH,WAAL,CAAkB,MAAIxH,CAAC,CAAC4H,qBAAF,CAAwBpI,CAAxB,CAAtB,EAAkDM,CAAlD,CAA1S,EAA+VE,CAAC,GAAC,MAAM,KAAKwH,WAAL,CAAkB,MAAIxH,CAAC,CAAC6H,gBAAF,CAAmBrI,CAAnB,CAAtB,EAA6CM,CAA7C,CAAvW,EAAuZE,CAAC,GAAC,MAAM,KAAKwH,WAAL,CAAkB,MAAIxH,CAAC,CAAC8H,sBAAF,CAAyBtI,CAAzB,CAAtB,EAAmDM,CAAnD,CAA/Z;AAAqd,KAAzd,CAAyd,OAAMI,CAAN,EAAQ;AAAC,UAAGA,CAAC,KAAGwD,CAAP,EAAS,MAAMxD,CAAN;AAAQF,MAAAA,CAAC,GAAC,IAAI4C,CAAJ,CAAM,EAAN,EAAS,IAAT,EAAc,IAAd,CAAF;AAAsB;;AAAA,WAAO5C,CAAC,CAACwK,+BAAF,CAAkChL,CAAlC,EAAoCI,CAApC,CAAP;AAA8C;;AAAe,QAAT2H,SAAS,CAAC/H,CAAD,EAAGE,CAAH,EAAK;AAAC,WAAO,KAAK2G,WAAL,GAAiB,KAAKA,WAAL,CAAiBoE,IAAjB,CAAsBjL,CAAtB,EAAwBE,CAAxB,CAAjB,GAA4CF,CAAC,EAApD;AAAuD;;AAAiB,QAAXgI,WAAW,CAAChI,CAAD,EAAGE,CAAH,EAAK;AAAC,WAAO,KAAK2G,WAAL,GAAiB,KAAKA,WAAL,CAAiBqE,OAAjB,CAAyBlL,CAAzB,EAA2BE,CAA3B,CAAjB,GAA+CF,CAAC,EAAvD;AAA0D;;AAAW,MAAPmL,OAAO,GAAE;AAAC,WAAO,KAAKtE,WAAL,CAAiBuE,MAAjB,GAAwB,CAA/B;AAAiC;;AAAAC,EAAAA,OAAO,CAACrL,CAAD,EAAG;AAAC,SAAI,KAAKsL,OAAL,GAAatL,CAAjB,EAAmB,CAACA,CAAC,CAACuL,IAAH,IAAS,KAAK1E,WAAd,IAA2B,KAAKA,WAAL,CAAiB2E,OAAjB,EAA9C,GAA0ExL,CAAC,CAACyL,YAAF;;AAAiB,SAAKH,OAAL,GAAa,IAAb;AAAkB;;AAAAI,EAAAA,OAAO,GAAE;AAAC,QAAG,CAAC,KAAK7D,SAAT,EAAmB;AAAC,YAAM7H,CAAC,GAAC,EAAR;AAAW,WAAKgG,YAAL,CAAkB2F,OAAlB,CAA2BzL,CAAC,IAAEF,CAAC,CAACiL,IAAF,CAAO/K,CAAP,CAA9B,GAA0C,KAAK2H,SAAL,GAAe,IAAIzE,CAAJ,CAAMpD,CAAN,EAAQ,IAAR,EAAa,IAAb,CAAzD;AAA4E;;AAAA,WAAO,KAAK6H,SAAZ;AAAsB;;AAA2B,QAArBK,qBAAqB,CAAClI,CAAD,EAAGE,CAAH,EAAK;AAAC,UAAK;AAAC4E,MAAAA,QAAQ,EAAC1E,CAAV;AAAYuI,MAAAA,KAAK,EAACnI,CAAlB;AAAoBoL,MAAAA,UAAU,EAAClL,CAA/B;AAAiC+H,MAAAA,cAAc,EAAC7H,CAAhD;AAAkD8H,MAAAA,cAAc,EAAC5H;AAAjE,QAAoEd,CAAzE;AAAA,UAA2EgB,CAAC,GAACJ,CAAC,IAAEE,CAAhF;AAAA,UAAkFI,CAAC,GAACmB,CAAC,CAAC7B,CAAD,CAAD,IAAM,CAAC2B,CAAC,CAAC,KAAK2D,gBAAN,EAAuBtF,CAAvB,CAA5F;AAAA,UAAsHY,CAAC,GAAC,KAAKoF,mBAAL,GAAyBtF,CAAC,IAAEF,CAAH,GAAK6K,IAAI,CAACC,SAAL,CAAe;AAAChH,MAAAA,QAAQ,EAAC1E,CAAV;AAAY2L,MAAAA,mBAAmB,EAACrL,CAAhC;AAAkCsL,MAAAA,mBAAmB,EAACxL;AAAtD,KAAf,CAAL,GAA8EqL,IAAI,CAACC,SAAL,CAAe;AAAChH,MAAAA,QAAQ,EAAC1E,CAAV;AAAY2L,MAAAA,mBAAmB,EAACrL;AAAhC,KAAf,CAAvG,GAA0J,IAAlR;;AAAuR,QAAGU,CAAH,EAAK;AAAC,YAAMpB,CAAC,GAAC,KAAKwG,mBAAL,CAAyByF,GAAzB,CAA6B7K,CAA7B,CAAR;;AAAwC,UAAG,CAACd,CAAC,CAACN,CAAD,CAAL,EAAS,OAAOA,CAAP;AAAS;;AAAA,UAAMsB,CAAC,GAAC,MAAMtB,CAAN,IAAS;AAAC,UAAGkB,CAAC,IAAEF,CAAN,EAAQ;AAAC,cAAMd,CAAC,GAAC,MAAMF,CAAC,CAAC8C,OAAF,CAAUtC,CAAV,CAAd;AAA2B,eAAOY,CAAC,IAAE,KAAKoF,mBAAL,CAAyB0F,GAAzB,CAA6B9K,CAA7B,EAA+BlB,CAA/B,EAAiCA,CAAC,CAAC4I,IAAF,IAAQ,CAAzC,CAAH,EAA+C5I,CAAtD;AAAwD;;AAAA,aAAOkB,CAAC,IAAE,KAAKoF,mBAAL,CAAyB0F,GAAzB,CAA6B9K,CAA7B,EAA+BpB,CAA/B,EAAiCA,CAAC,CAAC8I,IAAF,IAAQ,CAAzC,CAAH,EAA+C9I,CAAtD;AAAwD,KAAtK;;AAAuK,QAAG,CAACI,CAAJ,EAAM,OAAOkB,CAAC,CAAC,KAAKoK,OAAL,EAAD,CAAR;AAAyB,UAAMnK,CAAC,GAAC,KAAK4F,cAAb;;AAA4B,QAAG,6BAA2BzG,CAA9B,EAAgC;AAAC,YAAMV,CAAC,GAAC,KAAKqK,eAAL,CAAqB,KAAKC,eAAL,CAAqBlK,CAArB,CAArB,CAAR;;AAAsD,UAAG,CAACJ,CAAC,CAACoL,MAAN,EAAa,OAAO9J,CAAC,CAAC,KAAKoK,OAAL,EAAD,CAAR;AAAyB,UAAIpL,CAAJ,EAAME,CAAN;AAAQ,YAAMI,CAAC,GAAC,IAAIwE,GAAJ,EAAR;;AAAgB,WAAI,MAAMlF,CAAV,IAAeF,CAAf,EAAiBY,CAAC,CAACiJ,GAAF,CAAMtI,CAAC,CAACuI,WAAF,CAAc5J,CAAd,CAAN;;AAAwB,YAAM,KAAK8H,WAAL,CAAkB,MAAI;AAAC,YAAIhI,CAAC,GAAC,CAAN;AAAQM,QAAAA,CAAC,GAAC,IAAIqJ,KAAJ,CAAU/I,CAAC,CAACkI,IAAZ,CAAF,EAAoB,KAAK9C,YAAL,CAAkB2F,OAAlB,CAA2BzL,CAAC,IAAEI,CAAC,CAACN,CAAC,EAAF,CAAD,GAAOE,CAArC,CAApB,EAA6DM,CAAC,GAACI,CAA/D;AAAiE,OAAhG,EAAkGV,CAAlG,CAAN;AAA2G,aAAOoB,CAAC,CAAC,MAAM,KAAK0G,WAAL,CAAkB,YAAS;AAAC,cAAMhI,CAAC,GAAC,MAAMsD,CAAC,CAAC5C,CAAD,EAAGN,CAAH,EAAK,KAAKsF,YAAV,EAAuB,KAAKE,IAA5B,EAAiC,KAAKD,IAAtC,CAAf;AAAA,cAA2D/E,CAAC,GAACV,CAAC,IAAE,CAACM,CAAC,CAAC2L,GAAF,CAAM5K,CAAC,CAACuI,WAAF,CAAc5J,CAAd,CAAN,CAAD,IAA0BF,CAAC,CAACuB,CAAC,CAAC6K,WAAF,CAAclM,CAAd,CAAD,CAA3F;;AAA8G,eAAO,IAAIkD,CAAJ,CAAM,MAAM,KAAKiJ,iBAAL,CAAuB/L,CAAvB,EAAyBM,CAAzB,EAA2BV,CAA3B,CAAZ,EAA0CE,CAA1C,EAA4C,IAA5C,CAAP;AAAyD,OAAnM,EAAqMF,CAArM,CAAP,CAAR;AAAwN;;AAAA,UAAMuB,CAAC,GAAC,KAAK4I,eAAL,CAAqB,KAAKC,eAAL,CAAqBlK,CAArB,CAArB,CAAR;;AAAsD,QAAG,CAACqB,CAAC,CAAC2J,MAAN,EAAa;AAAC,YAAMpL,CAAC,GAAC,IAAIoD,CAAJ,CAAM,EAAN,EAAShD,CAAT,EAAW,IAAX,CAAR;AAAyB,aAAOgB,CAAC,IAAE,KAAKoF,mBAAL,CAAyB0F,GAAzB,CAA6B9K,CAA7B,EAA+BpB,CAA/B,EAAiCA,CAAC,CAAC8I,IAAF,IAAQ,CAAzC,CAAH,EAA+C9I,CAAtD;AAAwD;;AAAA,QAAG,KAAKsM,mBAAL,CAAyBlM,CAAzB,EAA2BJ,CAA3B,CAAH,EAAiC,OAAOsB,CAAC,CAAC,IAAI8B,CAAJ,CAAM3B,CAAN,EAAQrB,CAAR,EAAU,IAAV,CAAD,CAAR;AAA0B,UAAMuB,CAAC,GAAC,MAAM2B,CAAC,CAAC5C,CAAD,EAAGN,CAAH,EAAK,KAAKsF,YAAV,EAAuB,KAAKE,IAA5B,EAAiC,KAAKD,IAAtC,CAAf;AAAA,UAA2D9D,CAAC,GAAC,MAAM,KAAKwK,iBAAL,CAAuB5K,CAAvB,EAA0BzB,CAAC,IAAE2B,CAAC,CAACJ,CAAC,CAAC6K,WAAF,CAAcpM,CAAd,CAAD,CAA9B,EAAkDE,CAAlD,CAAnE;AAAwH,WAAOoB,CAAC,CAAC,IAAI8B,CAAJ,CAAMvB,CAAN,EAAQzB,CAAR,EAAU,IAAV,CAAD,CAAR;AAA0B;;AAAuB,QAAjBiM,iBAAiB,CAACrM,CAAD,EAAGE,CAAH,EAAKE,CAAL,EAAO;AAAC,QAAG,CAACF,CAAJ,EAAM,OAAOF,CAAP;AAAS,QAAG,CAAC,KAAKsL,OAAT,EAAiB,OAAOtL,CAAC,CAACuM,MAAF,CAAUvM,CAAC,IAAEE,CAAC,CAACF,CAAD,CAAd,CAAP;AAA2B,QAAIM,CAAC,GAAC,CAAN;;AAAQ,UAAME,CAAC,GAAC,IAAImJ,KAAJ,EAAR;AAAA,UAAkBjJ,CAAC,GAAC,YAAS;AAAC,aAAKJ,CAAC,GAACN,CAAC,CAACoL,MAAT,GAAiB;AAAC,cAAMxK,CAAC,GAACZ,CAAC,CAACM,CAAD,CAAT;AAAaJ,QAAAA,CAAC,CAACU,CAAD,CAAD,IAAMJ,CAAC,CAACyK,IAAF,CAAOrK,CAAP,CAAN,EAAgB,KAAK0K,OAAL,CAAaC,IAAb,KAAmB,MAAM,KAAKvD,WAAL,CAAkB,MAAItH,CAAC,EAAvB,EAA2BN,CAA3B,CAAzB,CAAhB,EAAuE,EAAEE,CAAzE;AAA2E;AAAC,KAAzI;;AAA0I,WAAO,KAAK0H,WAAL,CAAkB,MAAItH,CAAC,EAAvB,EAA2BN,CAA3B,EAA8BsJ,IAA9B,CAAoC,MAAIlJ,CAAxC,CAAP;AAAmD;;AAAA8L,EAAAA,mBAAmB,CAACtM,CAAD,EAAGE,CAAH,EAAK;AAAC,UAAK;AAACwF,MAAAA,YAAY,EAACtF;AAAd,QAAiB,IAAtB;AAAA,UAA2B;AAACwL,MAAAA,UAAU,EAACtL;AAAZ,QAAeJ,CAA1C;AAA4C,WAAOsD,CAAC,CAACxD,CAAD,CAAD,KAAO,uCAAqCM,CAArC,IAAwC,wBAAsBF,CAAtB,KAA0B,+BAA6BE,CAA7B,IAAgC,6BAA2BA,CAA3D,IAA8D,2BAAyBA,CAAjH,CAA/C,CAAP;AAA2K;;AAAAgK,EAAAA,eAAe,CAACtK,CAAD,EAAG;AAAC,QAAGwD,CAAC,CAACxD,CAAD,CAAJ,EAAQ;AAAC,UAAG6B,CAAC,CAAC7B,CAAD,CAAJ,EAAQ,OAAM,CAACsB,CAAC,CAACtB,CAAC,CAACsH,IAAH,EAAQtH,CAAC,CAACuH,IAAV,EAAevH,CAAC,CAACwH,IAAjB,EAAsBxH,CAAC,CAACyH,IAAxB,CAAF,CAAN;AAAuC,UAAG1F,CAAC,CAAC/B,CAAD,CAAJ,EAAQ,OAAOA,CAAC,CAACwM,KAAF,CAAQC,GAAR,CAAazM,CAAC,IAAEsB,CAAC,CAACkJ,IAAI,CAACkC,GAAL,CAAS1M,CAAC,CAAC,CAAD,CAAD,CAAK,CAAL,CAAT,EAAiBA,CAAC,CAAC,CAAD,CAAD,CAAK,CAAL,CAAjB,CAAD,EAA2BwK,IAAI,CAACkC,GAAL,CAAS1M,CAAC,CAAC,CAAD,CAAD,CAAK,CAAL,CAAT,EAAiBA,CAAC,CAAC,CAAD,CAAD,CAAK,CAAL,CAAjB,CAA3B,EAAqDwK,IAAI,CAACC,GAAL,CAASzK,CAAC,CAAC,CAAD,CAAD,CAAK,CAAL,CAAT,EAAiBA,CAAC,CAAC,CAAD,CAAD,CAAK,CAAL,CAAjB,CAArD,EAA+EwK,IAAI,CAACC,GAAL,CAASzK,CAAC,CAAC,CAAD,CAAD,CAAK,CAAL,CAAT,EAAiBA,CAAC,CAAC,CAAD,CAAD,CAAK,CAAL,CAAjB,CAA/E,CAAjB,CAAP;AAAoI;;AAAA,WAAM,CAACyB,CAAC,CAACF,CAAC,EAAF,EAAKvB,CAAL,CAAF,CAAN;AAAiB;;AAAAqK,EAAAA,eAAe,CAACrK,CAAD,EAAG;AAAC,SAAI,MAAMM,CAAV,IAAeN,CAAf,EAAiB,KAAKgG,YAAL,CAAkB2G,eAAlB,CAAkCrM,CAAlC,EAAqCN,CAAC,IAAE;AAACmF,MAAAA,CAAC,CAAC0E,GAAF,CAAM7J,CAAN;AAAS,KAAlD;;AAAqD,UAAME,CAAC,GAAC,IAAIyJ,KAAJ,CAAUxE,CAAC,CAAC2D,IAAZ,CAAR;AAA0B,QAAI1I,CAAC,GAAC,CAAN;AAAQ,WAAO+E,CAAC,CAACwG,OAAF,CAAW3L,CAAC,IAAEE,CAAC,CAACE,CAAC,EAAF,CAAD,GAAOJ,CAArB,GAAyBmF,CAAC,CAACyC,KAAF,EAAzB,EAAmC1H,CAA1C;AAA4C;;AAAoC,QAA9B6K,8BAA8B,CAAC7K,CAAD,EAAGE,CAAH,EAAK;AAAC,QAAGF,CAAC,CAAC+J,QAAF,GAAW,CAAX,IAAc,QAAM/J,CAAC,CAAC0M,iBAAtB,IAAyC1M,CAAC,CAAC2M,gBAA3C,IAA6D3M,CAAC,CAAC4M,SAA/D,IAA0E5M,CAAC,CAAC6M,aAA5E,IAA2F7M,CAAC,CAAC8M,IAA7F,IAAmG9M,CAAC,CAAC+M,aAArG,IAAoH/M,CAAC,CAACgN,0BAAtH,IAAkJhN,CAAC,CAACiN,MAApJ,IAA4JjN,CAAC,CAACkN,aAAjK,EAA+K,MAAM,IAAIpN,CAAJ,CAAM0E,CAAN,EAAQ,2BAAR,EAAoC;AAACe,MAAAA,KAAK,EAACvF;AAAP,KAApC,CAAN;AAAqD,WAAOmN,OAAO,CAACC,GAAR,CAAY,CAAC,KAAKC,4BAAL,CAAkCrN,CAAlC,CAAD,EAAsC,KAAKsN,oCAAL,CAA0CpN,CAA1C,CAAtC,EAAmFsD,CAAC,CAACxD,CAAD,EAAG,KAAKwF,YAAR,EAAqB,KAAKI,gBAA1B,CAApF,EAAgI7C,CAAC,CAAC,KAAK6C,gBAAN,EAAuB5F,CAAC,CAACyI,KAAzB,CAAjI,CAAZ,EAA+Ke,IAA/K,CAAqL,MAAIxJ,CAAzL,CAAP;AAAoM;;AAA0C,QAApCsN,oCAAoC,CAACtN,CAAD,EAAG;AAAC,UAAME,CAAC,GAAC,MAAMkE,CAAC,CAAC;AAACmJ,MAAAA,KAAK,EAACvN,CAAC,CAACuN,KAAT;AAAeC,MAAAA,kBAAkB,EAACxN,CAAC,CAACwN,kBAApC;AAAuDC,MAAAA,eAAe,EAACzN,CAAC,CAACyN;AAAzE,KAAD,CAAf;AAA2G,QAAG,CAACvN,CAAC,CAACgL,MAAN,EAAa,MAAM,IAAIpL,CAAJ,CAAM0E,CAAN,EAAQ,uDAAR,EAAgE;AAACkJ,MAAAA,MAAM,EAAC1N;AAAR,KAAhE,CAAN;AAAkFqC,IAAAA,CAAC,CAAC,KAAKkE,WAAN,EAAkBrG,CAAlB,EAAoB,gCAApB,CAAD;AAAuD;;AAAwB,QAAlB6H,kBAAkB,CAAC/H,CAAD,EAAG;AAAC,QAAGA,CAAC,CAAC+J,QAAF,GAAW,CAAX,IAAc,QAAM/J,CAAC,CAAC0M,iBAAtB,IAAyC1M,CAAC,CAAC2M,gBAA3C,IAA6D3M,CAAC,CAAC4M,SAA/D,IAA0E5M,CAAC,CAAC6M,aAA5E,IAA2F7M,CAAC,CAAC8M,IAAhG,EAAqG,MAAM,IAAIhN,CAAJ,CAAM0E,CAAN,EAAQ,2BAAR,EAAoC;AAACe,MAAAA,KAAK,EAACvF;AAAP,KAApC,CAAN;AAAqD,WAAOmN,OAAO,CAACC,GAAR,CAAY,CAAC,KAAKC,4BAAL,CAAkCrN,CAAlC,CAAD,EAAsC,KAAK2N,4BAAL,CAAkC3N,CAAlC,CAAtC,EAA2EwD,CAAC,CAACxD,CAAD,EAAG,KAAKwF,YAAR,EAAqB,KAAKI,gBAA1B,CAA5E,EAAwH7C,CAAC,CAAC,KAAK6C,gBAAN,EAAuB5F,CAAC,CAACyI,KAAzB,CAAzH,CAAZ,EAAuKe,IAAvK,CAA6K,MAAIxJ,CAAjL,CAAP;AAA4L;;AAAAqN,EAAAA,4BAA4B,CAACrN,CAAD,EAAG;AAAC,UAAK;AAAC4N,MAAAA,SAAS,EAAC1N,CAAX;AAAagN,MAAAA,aAAa,EAAC9M,CAA3B;AAA6ByN,MAAAA,oBAAoB,EAACvN,CAAlD;AAAoDyM,MAAAA,aAAa,EAACvM;AAAlE,QAAqER,CAA1E;AAAA,UAA4EU,CAAC,GAACF,CAAC,GAACA,CAAC,CAAC+L,GAAF,CAAOzM,CAAC,IAAEA,CAAC,CAACgO,qBAAF,IAAyBhO,CAAC,CAACgO,qBAAF,CAAwBC,WAAxB,EAAnC,CAAD,GAA4E,EAA3J;;AAA8J,QAAG3N,CAAC,IAAEA,CAAC,CAAC8K,MAAF,GAAS,CAAf,EAAiB;AAAC,YAAMpL,CAAC,GAAC,MAAR;AAAA,YAAeE,CAAC,GAAC,OAAjB;AAAA,YAAyBE,CAAC,GAACE,CAAC,CAACmM,GAAF,CAAOrM,CAAC,IAAE;AAAC,cAAME,CAAC,GAACF,CAAC,CAAC6N,WAAF,EAAR;AAAwB,eAAO3N,CAAC,CAAC4N,OAAF,CAAUlO,CAAV,IAAa,CAAC,CAAd,GAAgBM,CAAC,CAAC6N,KAAF,CAAQnO,CAAR,EAAW,CAAX,CAAhB,GAA8BM,CAAC,CAAC4N,OAAF,CAAUhO,CAAV,IAAa,CAAC,CAAd,GAAgBI,CAAC,CAAC6N,KAAF,CAAQjO,CAAR,EAAW,CAAX,CAAhB,GAA8BE,CAAnE;AAAqE,OAAxG,EAA2GmM,MAA3G,CAAmHvM,CAAC,IAAE,CAAC,CAAD,KAAKY,CAAC,CAACsN,OAAF,CAAUlO,CAAV,CAA3H,CAA3B;AAAqKuC,MAAAA,CAAC,CAAC,KAAKkE,WAAN,EAAkBrG,CAAlB,EAAoB,uCAApB,CAAD;AAA8D;;AAAA,QAAGA,CAAC,IAAEA,CAAC,CAACgL,MAAF,GAAS,CAAf,EAAiB7I,CAAC,CAAC,KAAKkE,WAAN,EAAkBrG,CAAlB,EAAoB,mCAApB,CAAD,CAAjB,KAAgF,IAAGI,CAAH,EAAK,MAAM,IAAIR,CAAJ,CAAM0E,CAAN,EAAQ,wDAAR,EAAiE;AAACe,MAAAA,KAAK,EAACvF;AAAP,KAAjE,CAAN;AAAkFuC,IAAAA,CAAC,CAAC,KAAKgE,WAAN,EAAkBvG,CAAC,CAACkO,KAApB,CAAD;AAA4B;;AAAkC,QAA5BP,4BAA4B,CAAC3N,CAAD,EAAG;AAAC,UAAK;AAAC+M,MAAAA,aAAa,EAAC7M,CAAf;AAAiB8M,MAAAA,0BAA0B,EAAC5M,CAA5C;AAA8C6M,MAAAA,MAAM,EAAC3M;AAArD,QAAwDN,CAA7D;AAAA,UAA+DQ,CAAC,GAACJ,CAAC,IAAEA,CAAC,CAAC8K,MAAtE;AAAA,UAA6ExK,CAAC,GAACR,CAAC,IAAEA,CAAC,CAACgL,MAApF;;AAA2F,QAAG5K,CAAH,EAAK;AAAC,UAAG,CAACE,CAAD,IAAI,CAACE,CAAR,EAAU,MAAM,IAAIZ,CAAJ,CAAM0E,CAAN,EAAQ,8EAAR,EAAuF;AAACe,QAAAA,KAAK,EAACvF;AAAP,OAAvF,CAAN;AAAwGyC,MAAAA,CAAC,CAAC,KAAK8D,WAAN,EAAkBjG,CAAlB,EAAoBJ,CAApB,CAAD;AAAwB;;AAAA,QAAGQ,CAAH,EAAK;AAAC,UAAG,CAAC2D,CAAC,CAACnE,CAAD,CAAL,EAAS;AAAO,YAAMI,CAAC,GAACJ,CAAC,CAACqM,GAAF,CAAOzM,CAAC,IAAEA,CAAC,CAACqO,gBAAZ,CAAR;AAAuC9L,MAAAA,CAAC,CAAC,KAAKkE,WAAN,EAAkBjG,CAAlB,EAAoB,2CAApB,CAAD,EAAkEE,CAAC,IAAE6B,CAAC,CAAC,KAAKkE,WAAN,EAAkBnG,CAAlB,EAAoB,oDAApB,CAAtE;;AAAgJ,WAAI,MAAMA,CAAV,IAAeF,CAAf,EAAiB;AAAC,cAAK;AAACiO,UAAAA,gBAAgB,EAACjO,CAAlB;AAAoBqE,UAAAA,aAAa,EAACjE;AAAlC,YAAqCF,CAA1C;;AAA4C,YAAG,CAAC,sBAAoBE,CAApB,IAAuB,sBAAoBA,CAA5C,KAAgD,yBAAwBF,CAA3E,EAA6E;AAAC,gBAAK;AAACgO,YAAAA,mBAAmB,EAAClO;AAArB,cAAwBE,CAA7B;AAA+B,cAAG,CAACF,CAAJ,EAAM,MAAM,IAAIJ,CAAJ,CAAM0E,CAAN,EAAQ,sDAAR,EAA+D;AAAC6J,YAAAA,UAAU,EAACjO,CAAZ;AAAcmF,YAAAA,KAAK,EAACvF;AAApB,WAA/D,CAAN;AAA6F,SAAhN,MAAqN,IAAG,YAAUM,CAAV,IAAaJ,CAAb,IAAgByC,CAAC,CAACzC,CAAD,EAAG,KAAKqG,WAAR,CAApB,EAAyC,MAAM,IAAIzG,CAAJ,CAAM0E,CAAN,EAAQ,2CAAR,EAAoD;AAAC6J,UAAAA,UAAU,EAACjO,CAAZ;AAAcmF,UAAAA,KAAK,EAACvF;AAApB,SAApD,CAAN;AAAkF;AAAC;AAAC;;AAAr2Y;;AAAs2Y,MAAMkJ,CAAC,GAAChI,CAAC,EAAT;AAAA,MAAY6H,CAAC,GAAC7H,CAAC,EAAf;AAAkB,eAAemE,CAAf;AAAiB,SAAOZ,CAAC,IAAI6J,OAAZ","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../core/Error.js\";import{clone as t}from\"../../../core/lang.js\";import{isNone as i,isUndefined as s}from\"../../../core/maybe.js\";import{MemCache as r,MemCacheStorage as a}from\"../../../core/MemCache.js\";import{getMetersPerUnitForSR as n}from\"../../../core/unitUtils.js\";import{set as u,NEGATIVE_INFINITY as o,expandWithAABB as c,create as h}from\"../../../geometry/support/aaBoundingBox.js\";import{fromValues as l,create as p}from\"../../../geometry/support/aaBoundingRect.js\";import{getBoundsXY as m}from\"../../../geometry/support/boundsUtils.js\";import{fromJSON as d,isExtent as y,isPolygon as f}from\"../../../geometry/support/jsonUtils.js\";import{normalizeCentralMeridian as _}from\"../../../geometry/support/normalizeUtils.js\";import{equals as x,isValid as g}from\"../../../geometry/support/spatialReferenceUtils.js\";import{validateFields as w,validateWhere as S,validateHaving as Q,hasInvalidFieldType as R}from\"./attributeSupport.js\";import{project as I,checkProjectionSupport as F}from\"./projectionSupport.js\";import{queryCapabilities as b}from\"./QueryEngineCapabilities.js\";import j from\"./QueryEngineResult.js\";import{getSpatialQueryOperator as A,canQueryWithRBush as E,checkSpatialQuerySupport as k}from\"./spatialQuerySupport.js\";import{getTimeExtent as C}from\"./timeSupport.js\";import{cleanFromGeometryEngine as T,normalizeQuery as B,QUERY_ENGINE_EMPTY_RESULT as O}from\"./utils.js\";import z from\"../../support/FieldsIndex.js\";import P from\"../../support/PromiseQueue.js\";import{getFieldsList as G}from\"../../../smartMapping/support/utils.js\";function v(e){return e.every((e=>\"exceedslimit\"!==e.statisticType))}const q=\"feature-store:unsupported-query\";class M{constructor(e,t=null,i,s,r){this.attributes=e,this.geometry=i,this.centroid=s,this.filterFlags=r,this.groupId=-1,this.displayId=t}}const U=new Set,N=new a(2e6);let Z=0;class H{constructor(e){this.capabilities={query:b},this.geometryType=e.geometryType,this.hasM=e.hasM,this.hasZ=e.hasZ,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.featureStore=e.featureStore,this.aggregateAdapter=e.aggregateAdapter,this._changeHandle=this.featureStore.events.on(\"changed\",(()=>this.clearCache())),this.timeInfo=e.timeInfo,e.cacheSpatialQueries&&(this._geometryQueryCache=new r(Z+++\"$$\",N)),this.fieldsIndex=new z(e.fields),e.scheduler&&e.priority&&(this._frameQueue=new P,this._frameTask=e.scheduler.registerTask(e.priority,this))}destroy(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._frameQueue.cancelAll(),this._frameQueue=null),this.clearCache(),this._geometryQueryCache&&this._geometryQueryCache.destroy(),this._changeHandle&&(this._changeHandle.remove(),this._changeHandle=null),this.fieldsIndex.destroy()}get featureAdapter(){return this.featureStore.featureAdapter}get fullExtent(){const e=this.featureStore.fullBounds;return e?{xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:T(this.spatialReference)}:null}get timeExtent(){return this.timeInfo?(this._timeExtent||(this._timeExtent=C(this.timeInfo,this.featureStore)),this._timeExtent):null}clearCache(){this._geometryQueryCache&&this._geometryQueryCache.clear(),this._allItems=null,this._timeExtent=null}async executeQuery(e={},i){let s,r=t(e);try{r=await this._schedule((()=>B(r,this.definitionExpression,this.spatialReference)),i),r=await this._reschedule((()=>this._checkQuerySupport(r)),i),s=await this._reschedule((()=>this._executeGeometryQuery(r,i)),i),s=await this._reschedule((()=>s.executeAggregateIdsQuery(r)),i),s=await this._reschedule((()=>s.executeObjectIdsQuery(r)),i),s=await this._reschedule((()=>s.executeTimeQuery(r)),i),s=await this._reschedule((()=>s.executeAttributesQuery(r)),i)}catch(a){if(a!==O)throw a;s=new j([],null,this)}return s.createQueryResponse(r)}async executeQueryForCount(e={},i){let s,r=t(e);r.returnGeometry=!1,r.returnCentroid=!1,r.outSR=null;try{r=await this._schedule((()=>B(r,this.definitionExpression,this.spatialReference)),i),r=await this._reschedule((()=>this._checkQuerySupport(r)),i),s=await this._reschedule((()=>this._executeGeometryQuery(r,i)),i),s=await this._reschedule((()=>s.executeAggregateIdsQuery(r)),i),s=await this._reschedule((()=>s.executeObjectIdsQuery(r)),i),s=await this._reschedule((()=>s.executeTimeQuery(r)),i),s=await this._reschedule((()=>s.executeAttributesQuery(r)),i)}catch(a){if(a!==O)throw a;return 0}return s.createQueryResponseForCount(r)}async executeQueryForExtent(e={},i){let s,r=t(e);const a=r.outSR;try{r=await this._schedule((()=>B(r,this.definitionExpression,this.spatialReference)),i),r=await this._reschedule((()=>this._checkQuerySupport(r)),i),r.returnGeometry=!0,r.returnCentroid=!1,r.outSR=null,s=await this._reschedule((()=>this._executeGeometryQuery(r,i)),i),s=await this._reschedule((()=>s.executeAggregateIdsQuery(r)),i),s=await this._reschedule((()=>s.executeObjectIdsQuery(r)),i),s=await this._reschedule((()=>s.executeTimeQuery(r)),i),s=await this._reschedule((()=>s.executeAttributesQuery(r)),i);const e=s.size;if(!e)return{count:e,extent:null};u(L,o),this.featureStore.forEachBounds(s.items,(e=>c(L,e)),J);const t={xmin:L[0],ymin:L[1],xmax:L[3],ymax:L[4],spatialReference:T(this.spatialReference)};this.hasZ&&isFinite(L[2])&&isFinite(L[5])&&(t.zmin=L[2],t.zmax=L[5]);const h=I(t,s.spatialReference,a);if(h.spatialReference=T(a||this.spatialReference),h.xmax-h.xmin==0){const e=n(h.spatialReference);h.xmin-=e,h.xmax+=e}if(h.ymax-h.ymin==0){const e=n(h.spatialReference);h.ymin-=e,h.ymax+=e}if(this.hasZ&&null!=h.zmin&&null!=h.zmax&&h.zmax-h.zmin==0){const e=n(h.spatialReference);h.zmin-=e,h.zmax+=e}return{count:e,extent:h}}catch(h){if(h===O)return{count:0,extent:null};throw h}}async executeQueryForIds(e={},t){return this.executeQueryForIdSet(e,t).then((e=>Array.from(e)))}async executeQueryForIdSet(e={},i){let s,r=t(e);r.returnGeometry=!1,r.returnCentroid=!1,r.outSR=null;try{r=await this._schedule((()=>B(r,this.definitionExpression,this.spatialReference)),i),r=await this._reschedule((()=>this._checkQuerySupport(r)),i),s=await this._reschedule((()=>this._executeGeometryQuery(r,i)),i),s=await this._reschedule((()=>s.executeAggregateIdsQuery(r)),i),s=await this._reschedule((()=>s.executeObjectIdsQuery(r)),i),s=await this._reschedule((()=>s.executeTimeQuery(r)),i),s=await this._reschedule((()=>s.executeAttributesQuery(r)),i);const e=s.items,t=new Set;return await this._reschedule((()=>{for(const i of e)t.add(s.featureAdapter.getObjectId(i))}),i),t}catch(a){if(a===O)return new Set;throw a}}async executeQueryForSnapping(e,t){const{point:s,distance:r,types:a}=e;if(0===a)return{candidates:[]};const n=await this._reschedule((()=>this._checkQuerySupport(e.query)),t),u=!x(s.spatialReference,this.spatialReference);u&&await F(s.spatialReference,this.spatialReference);const o=\"number\"==typeof r?r:r.x,c=\"number\"==typeof r?r:r.y,h={xmin:s.x-o,xmax:s.x+o,ymin:s.y-c,ymax:s.y+c,spatialReference:s.spatialReference},l=u?I(h,this.spatialReference):h;if(!l)return{candidates:[]};const p=(await _(d(s),null,{signal:t}))[0],m=(await _(d(l),null,{signal:t}))[0];if(i(p)||i(m))return{candidates:[]};let y=new j(this._searchFeatures(this._getQueryBBoxes(m.toJSON())),null,this);y=await this._reschedule((()=>y.executeObjectIdsQuery(n)),t),y=await this._reschedule((()=>y.executeTimeQuery(n)),t),y=await this._reschedule((()=>y.executeAttributesQuery(n)),t);const f=p.toJSON(),g=u?I(f,this.spatialReference):f,w=u?Math.max(l.xmax-l.xmin,l.ymax-l.ymin)/2:r;return y.createSnappingResponse({...e,point:g,distance:w},s.spatialReference)}async executeQueryForLatestObservations(i={},s){if(!this.timeInfo||!this.timeInfo.trackIdField)throw new e(q,\"Missing timeInfo or timeInfo.trackIdField\",{query:i,timeInfo:this.timeInfo});let r,a=t(i);try{a=await this._schedule((()=>B(a,this.definitionExpression,this.spatialReference)),s),a=await this._reschedule((()=>this._checkQuerySupport(a)),s),r=await this._reschedule((()=>this._executeGeometryQuery(a,s)),s),r=await this._reschedule((()=>r.executeAggregateIdsQuery(a)),s),r=await this._reschedule((()=>r.executeObjectIdsQuery(a)),s),r=await this._reschedule((()=>r.executeTimeQuery(a)),s),r=await this._reschedule((()=>r.executeAttributesQuery(a)),s),r=await this._reschedule((()=>r.filterLatest()),s)}catch(n){if(n!==O)throw n;r=new j([],null,this)}return r.createQueryResponse(a)}async executeQueryForSummaryStatistics(e={},i,s){let r;e=t(e);try{e=await this._schedule((()=>B(e,this.definitionExpression,this.spatialReference)),s),e=await this._reschedule((()=>this._checkSummaryStatisticsSupport(e,i)),s),r=await this._reschedule((()=>this._executeGeometryQuery(e,s)),s),r=await this._reschedule((()=>r.executeAggregateIdsQuery(e)),s),r=await this._reschedule((()=>r.executeObjectIdsQuery(e)),s),r=await this._reschedule((()=>r.executeTimeQuery(e)),s),r=await this._reschedule((()=>r.executeAttributesQuery(e)),s)}catch(a){if(a!==O)throw a;r=new j([],null,this)}return r.createSummaryStatisticsResponse(e,i)}async _schedule(e,t){return this._frameQueue?this._frameQueue.push(e,t):e()}async _reschedule(e,t){return this._frameQueue?this._frameQueue.unshift(e,t):e()}get running(){return this._frameQueue.length>0}runTask(e){for(this._budget=e;!e.done&&this._frameQueue&&this._frameQueue.process();)e.madeProgress();this._budget=null}_getAll(){if(!this._allItems){const e=[];this.featureStore.forEach((t=>e.push(t))),this._allItems=new j(e,null,this)}return this._allItems}async _executeGeometryQuery(e,t){const{geometry:i,outSR:r,spatialRel:a,returnGeometry:n,returnCentroid:u}=e,o=n||u,c=g(r)&&!x(this.spatialReference,r),h=this._geometryQueryCache?c&&o?JSON.stringify({geometry:i,spatialRelationship:a,outSpatialReference:r}):JSON.stringify({geometry:i,spatialRelationship:a}):null;if(h){const e=this._geometryQueryCache.get(h);if(!s(e))return e}const l=async e=>{if(c&&o){const t=await e.project(r);return h&&this._geometryQueryCache.put(h,t,t.size||1),t}return h&&this._geometryQueryCache.put(h,e,e.size||1),e};if(!i)return l(this._getAll());const p=this.featureAdapter;if(\"esriSpatialRelDisjoint\"===a){const e=this._searchFeatures(this._getQueryBBoxes(i));if(!e.length)return l(this._getAll());let s,r;const n=new Set;for(const t of e)n.add(p.getObjectId(t));await this._reschedule((()=>{let e=0;s=new Array(n.size),this.featureStore.forEach((t=>s[e++]=t)),r=n}),t);return l(await this._reschedule((async()=>{const e=await A(a,i,this.geometryType,this.hasZ,this.hasM),n=t=>!r.has(p.getObjectId(t))||e(p.getGeometry(t));return new j(await this._runSpatialFilter(s,n,t),i,this)}),t))}const m=this._searchFeatures(this._getQueryBBoxes(i));if(!m.length){const e=new j([],i,this);return h&&this._geometryQueryCache.put(h,e,e.size||1),e}if(this._canExecuteSoloPass(i,e))return l(new j(m,i,this));const d=await A(a,i,this.geometryType,this.hasZ,this.hasM),y=await this._runSpatialFilter(m,(e=>d(p.getGeometry(e))),t);return l(new j(y,i,this))}async _runSpatialFilter(e,t,i){if(!t)return e;if(!this._budget)return e.filter((e=>t(e)));let s=0;const r=new Array,a=async()=>{for(;s<e.length;){const n=e[s];t(n)&&r.push(n),this._budget.done&&await this._reschedule((()=>a()),i),++s}};return this._reschedule((()=>a()),i).then((()=>r))}_canExecuteSoloPass(e,t){const{geometryType:i}=this,{spatialRel:s}=t;return E(e)&&(\"esriSpatialRelEnvelopeIntersects\"===s||\"esriGeometryPoint\"===i&&(\"esriSpatialRelIntersects\"===s||\"esriSpatialRelContains\"===s||\"esriSpatialRelWithin\"===s))}_getQueryBBoxes(e){if(E(e)){if(y(e))return[l(e.xmin,e.ymin,e.xmax,e.ymax)];if(f(e))return e.rings.map((e=>l(Math.min(e[0][0],e[2][0]),Math.min(e[0][1],e[2][1]),Math.max(e[0][0],e[2][0]),Math.max(e[0][1],e[2][1]))))}return[m(p(),e)]}_searchFeatures(e){for(const s of e)this.featureStore.forEachInBounds(s,(e=>{U.add(e)}));const t=new Array(U.size);let i=0;return U.forEach((e=>t[i++]=e)),U.clear(),t}async _checkSummaryStatisticsSupport(t,i){if(t.distance<0||null!=t.geometryPrecision||t.multipatchOption||t.pixelSize||t.relationParam||t.text||t.outStatistics||t.groupByFieldsForStatistics||t.having||t.orderByFields)throw new e(q,\"Unsupported query options\",{query:t});return Promise.all([this._checkAttributesQuerySupport(t),this._checkSummaryStatisticsParamsSupport(i),k(t,this.geometryType,this.spatialReference),F(this.spatialReference,t.outSR)]).then((()=>t))}async _checkSummaryStatisticsParamsSupport(t){const i=await G({field:t.field,normalizationField:t.normalizationField,valueExpression:t.valueExpression});if(!i.length)throw new e(q,\"params should have atleast a field or valueExpression\",{params:t});w(this.fieldsIndex,i,\"params contains missing fields\")}async _checkQuerySupport(t){if(t.distance<0||null!=t.geometryPrecision||t.multipatchOption||t.pixelSize||t.relationParam||t.text)throw new e(q,\"Unsupported query options\",{query:t});return Promise.all([this._checkAttributesQuerySupport(t),this._checkStatisticsQuerySupport(t),k(t,this.geometryType,this.spatialReference),F(this.spatialReference,t.outSR)]).then((()=>t))}_checkAttributesQuerySupport(t){const{outFields:i,orderByFields:s,returnDistinctValues:r,outStatistics:a}=t,n=a?a.map((e=>e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase())):[];if(s&&s.length>0){const e=\" asc\",t=\" desc\",i=s.map((i=>{const s=i.toLowerCase();return s.indexOf(e)>-1?s.split(e)[0]:s.indexOf(t)>-1?s.split(t)[0]:i})).filter((e=>-1===n.indexOf(e)));w(this.fieldsIndex,i,\"orderByFields contains missing fields\")}if(i&&i.length>0)w(this.fieldsIndex,i,\"outFields contains missing fields\");else if(r)throw new e(q,\"outFields should be specified for returnDistinctValues\",{query:t});S(this.fieldsIndex,t.where)}async _checkStatisticsQuerySupport(t){const{outStatistics:i,groupByFieldsForStatistics:s,having:r}=t,a=s&&s.length,n=i&&i.length;if(r){if(!a||!n)throw new e(q,\"outStatistics and groupByFieldsForStatistics should be specified with having\",{query:t});Q(this.fieldsIndex,r,i)}if(n){if(!v(i))return;const r=i.map((e=>e.onStatisticField));w(this.fieldsIndex,r,\"onStatisticFields contains missing fields\"),a&&w(this.fieldsIndex,s,\"groupByFieldsForStatistics contains missing fields\");for(const s of i){const{onStatisticField:i,statisticType:r}=s;if((\"percentile_disc\"===r||\"percentile_cont\"===r)&&\"statisticParameters\"in s){const{statisticParameters:i}=s;if(!i)throw new e(q,\"statisticParamters should be set for percentile type\",{definition:s,query:t})}else if(\"count\"!==r&&i&&R(i,this.fieldsIndex))throw new e(q,\"outStatistics contains non-numeric fields\",{definition:s,query:t})}}}}const J=h(),L=h();export default H;export{M as Feature};\n"]},"metadata":{},"sourceType":"module"}