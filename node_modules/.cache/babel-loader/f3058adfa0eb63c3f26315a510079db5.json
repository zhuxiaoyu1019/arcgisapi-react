{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isSome as t } from \"../../../../../core/maybe.js\";\nimport { j as e } from \"../../../../../chunks/quat.js\";\nimport { I as s, b as r } from \"../../../../../chunks/quatf64.js\";\nimport { k as i } from \"../../../../../chunks/vec3.js\";\nimport { Z as a, a as o, O as n } from \"../../../../../chunks/vec3f64.js\";\nimport l from \"../../../MeshMaterialMetallicRoughness.js\";\nimport { ungeoreferenceByTransform as c } from \"../../georeference.js\";\nimport { Buffer as h } from \"./buffer.js\";\nimport { computeOrigin as u, smoothNormalsMesh as f } from \"./geometry.js\";\nimport { BufferOutputType as d, ImageOutputType as m, AttributeType as p, TargetBuffer as g, AlphaMode as x } from \"./types.js\";\nimport { imageToArrayBuffer as b, imageToDataURI as A } from \"./imageutils.js\";\n\nclass v {\n  constructor(t, e, s) {\n    this.params = {}, this.materialMap = new Array(), this.gltf = {\n      asset: {\n        version: \"2.0\",\n        copyright: t.copyright,\n        generator: t.generator\n      },\n      extras: {\n        options: e,\n        binChunkBuffer: null,\n        promises: []\n      }\n    }, s && (this.params = s), this.addScenes(t);\n  }\n\n  addScenes(t) {\n    this.gltf.scene = t.defaultScene;\n    const e = this.gltf.extras.options.bufferOutputType === d.GLB || this.gltf.extras.options.imageOutputType === m.GLB;\n    e && (this.gltf.extras.binChunkBuffer = new h(this.gltf)), t.forEachScene(t => {\n      this.addScene(t);\n    }), e && this.gltf.extras.binChunkBuffer.finalize();\n  }\n\n  addScene(t) {\n    this.gltf.scenes || (this.gltf.scenes = []);\n    const e = {};\n    t.name && (e.name = t.name), t.forEachNode(t => {\n      e.nodes || (e.nodes = []);\n      const s = this.addNode(t);\n      e.nodes.push(s);\n    }), this.gltf.scenes.push(e);\n  }\n\n  addNode(t) {\n    this.gltf.nodes || (this.gltf.nodes = []);\n    const l = {};\n    t.name && (l.name = t.name);\n    const c = t.translation;\n    i(c, a) || (l.translation = o(c));\n    const h = t.rotation;\n    e(h, s) || (l.rotation = r(h));\n    const u = t.scale;\n    i(u, n) || (l.scale = o(u)), t.mesh && t.mesh.vertexAttributes.position ? l.mesh = this.addMesh(t.mesh) : t.forEachNode(t => {\n      l.children || (l.children = []);\n      const e = this.addNode(t);\n      l.children.push(e);\n    });\n    const f = this.gltf.nodes.length;\n    return this.gltf.nodes.push(l), f;\n  }\n\n  addMesh(e) {\n    this.gltf.meshes || (this.gltf.meshes = []);\n    const s = {\n      primitives: []\n    },\n          r = this.gltf.extras.options.bufferOutputType === d.GLB;\n    let i;\n    i = r ? this.gltf.extras.binChunkBuffer : new h(this.gltf);\n    const a = e.clone();\n    this.params.origin || (this.params.origin = u(a)), a.rotate(-90, 0, 0, {\n      origin: this.params.origin\n    }), f(a);\n    const o = c(a.vertexAttributes, a.transform, this.params.origin, {\n      geographic: this.params.geographic,\n      unit: \"meters\"\n    });\n    a.vertexAttributes.position = o.position, a.vertexAttributes.normal = o.normal, a.vertexAttributes.tangent = o.tangent;\n    const n = i.addBufferView(5126, p.VEC3, g.ARRAY_BUFFER);\n    let l, m, x, b;\n    a.vertexAttributes.normal && (l = i.addBufferView(5126, p.VEC3, g.ARRAY_BUFFER)), a.vertexAttributes.uv && (m = i.addBufferView(5126, p.VEC2, g.ARRAY_BUFFER)), a.vertexAttributes.tangent && (x = i.addBufferView(5126, p.VEC4, g.ARRAY_BUFFER)), a.vertexAttributes.color && (b = i.addBufferView(5121, p.VEC4, g.ARRAY_BUFFER)), n.startAccessor(\"POSITION\"), l && l.startAccessor(\"NORMAL\"), m && m.startAccessor(\"TEXCOORD_0\"), x && x.startAccessor(\"TANGENT\"), b && b.startAccessor(\"COLOR_0\");\n    const A = a.vertexAttributes.position.length / 3;\n\n    for (let c = 0; c < A; ++c) n.push(a.vertexAttributes.position[3 * c + 0]), n.push(a.vertexAttributes.position[3 * c + 1]), n.push(a.vertexAttributes.position[3 * c + 2]), l && t(a.vertexAttributes.normal) && (l.push(a.vertexAttributes.normal[3 * c + 0]), l.push(a.vertexAttributes.normal[3 * c + 1]), l.push(a.vertexAttributes.normal[3 * c + 2])), m && t(a.vertexAttributes.uv) && (m.push(a.vertexAttributes.uv[2 * c + 0]), m.push(a.vertexAttributes.uv[2 * c + 1])), x && t(a.vertexAttributes.tangent) && (x.push(a.vertexAttributes.tangent[4 * c + 0]), x.push(a.vertexAttributes.tangent[4 * c + 1]), x.push(a.vertexAttributes.tangent[4 * c + 2]), x.push(a.vertexAttributes.tangent[4 * c + 3])), b && t(a.vertexAttributes.color) && (b.push(a.vertexAttributes.color[4 * c + 0]), b.push(a.vertexAttributes.color[4 * c + 1]), b.push(a.vertexAttributes.color[4 * c + 2]), b.push(a.vertexAttributes.color[4 * c + 3]));\n\n    const v = n.endAccessor(),\n          R = this.addAccessor(n.index, v);\n    let T, M, O, C, E;\n\n    if (l) {\n      const t = l.endAccessor();\n      T = this.addAccessor(l.index, t);\n    }\n\n    if (m) {\n      const t = m.endAccessor();\n      M = this.addAccessor(m.index, t);\n    }\n\n    if (x) {\n      const t = x.endAccessor();\n      O = this.addAccessor(x.index, t);\n    }\n\n    if (b) {\n      const t = b.endAccessor();\n      C = this.addAccessor(b.index, t);\n    }\n\n    a.components && a.components.length > 0 && a.components[0].faces ? (E = i.addBufferView(5125, p.SCALAR, g.ELEMENT_ARRAY_BUFFER), this.addMeshVertexIndexed(E, a.components, s, R, T, M, O, C)) : this.addMeshVertexNonIndexed(a.components, s, R, T, M, O, C), n.finalize(), l && l.finalize(), m && m.finalize(), x && x.finalize(), E && E.finalize(), b && b.finalize(), r || i.finalize();\n    const w = this.gltf.meshes.length;\n    return this.gltf.meshes.push(s), w;\n  }\n\n  addMaterial(e) {\n    if (null === e) return;\n    const s = this.materialMap.indexOf(e);\n    if (-1 !== s) return s;\n    this.gltf.materials || (this.gltf.materials = []);\n    const r = {};\n\n    switch (e.alphaMode) {\n      case \"mask\":\n        r.alphaMode = x.MASK;\n        break;\n\n      case \"auto\":\n      case \"blend\":\n        r.alphaMode = x.BLEND;\n    }\n\n    .5 !== e.alphaCutoff && (r.alphaCutoff = e.alphaCutoff), e.doubleSided && (r.doubleSided = e.doubleSided), r.pbrMetallicRoughness = {};\n\n    const i = t => t ** 2.1,\n          a = t => {\n      const e = t.toRgba();\n      return e[0] = i(e[0] / 255), e[1] = i(e[1] / 255), e[2] = i(e[2] / 255), e;\n    };\n\n    if (t(e.color) && (r.pbrMetallicRoughness.baseColorFactor = a(e.color)), t(e.colorTexture) && (r.pbrMetallicRoughness.baseColorTexture = {\n      index: this.addTexture(e.colorTexture)\n    }), t(e.normalTexture) && (r.normalTexture = {\n      index: this.addTexture(e.normalTexture)\n    }), e instanceof l) {\n      if (t(e.emissiveTexture) && (r.emissiveTexture = {\n        index: this.addTexture(e.emissiveTexture)\n      }), t(e.emissiveColor)) {\n        const t = a(e.emissiveColor);\n        r.emissiveFactor = [t[0], t[1], t[2]];\n      }\n\n      t(e.occlusionTexture) && (r.occlusionTexture = {\n        index: this.addTexture(e.occlusionTexture)\n      }), t(e.metallicRoughnessTexture) && (r.pbrMetallicRoughness.metallicRoughnessTexture = {\n        index: this.addTexture(e.metallicRoughnessTexture)\n      }), r.pbrMetallicRoughness.metallicFactor = e.metallic, r.pbrMetallicRoughness.roughnessFactor = e.roughness;\n    } else r.pbrMetallicRoughness.metallicFactor = 1, r.pbrMetallicRoughness.roughnessFactor = 1;\n\n    const o = this.gltf.materials.length;\n    return this.gltf.materials.push(r), this.materialMap.push(e), o;\n  }\n\n  addTexture(t) {\n    this.gltf.textures || (this.gltf.textures = []);\n    const e = {\n      sampler: this.addSampler(t),\n      source: this.addImage(t)\n    },\n          s = this.gltf.textures.length;\n    return this.gltf.textures.push(e), s;\n  }\n\n  addImage(t) {\n    this.gltf.images || (this.gltf.images = []);\n    const e = {};\n    if (t.url) e.uri = t.url;else {\n      e.extras = t.data;\n\n      for (let e = 0; e < this.gltf.images.length; ++e) if (t.data === this.gltf.images[e].extras) return e;\n\n      switch (this.gltf.extras.options.imageOutputType) {\n        case m.GLB:\n          {\n            const s = this.gltf.extras.binChunkBuffer.addBufferView(5121, p.SCALAR);\n            s.writeAsync(b(t.data)).then(() => {\n              s.finalize();\n            }), e.bufferView = s.index, e.mimeType = \"image/png\";\n            break;\n          }\n\n        case m.DataURI:\n          e.uri = A(t.data);\n          break;\n\n        default:\n          this.gltf.extras.promises.push(b(t.data).then(t => {\n            e.uri = t;\n          }));\n      }\n    }\n    const s = this.gltf.images.length;\n    return this.gltf.images.push(e), s;\n  }\n\n  addSampler(t) {\n    this.gltf.samplers || (this.gltf.samplers = []);\n    let e = 10497,\n        s = 10497;\n    if (\"string\" == typeof t.wrap) switch (t.wrap) {\n      case \"clamp\":\n        e = 33071, s = 33071;\n        break;\n\n      case \"mirror\":\n        e = 33648, s = 33648;\n    } else {\n      switch (t.wrap.vertical) {\n        case \"clamp\":\n          s = 33071;\n          break;\n\n        case \"mirror\":\n          s = 33648;\n      }\n\n      switch (t.wrap.horizontal) {\n        case \"clamp\":\n          e = 33071;\n          break;\n\n        case \"mirror\":\n          e = 33648;\n      }\n    }\n    const r = {\n      wrapS: e,\n      wrapT: s\n    };\n\n    for (let a = 0; a < this.gltf.samplers.length; ++a) if (JSON.stringify(r) === JSON.stringify(this.gltf.samplers[a])) return a;\n\n    const i = this.gltf.samplers.length;\n    return this.gltf.samplers.push(r), i;\n  }\n\n  addAccessor(t, e) {\n    this.gltf.accessors || (this.gltf.accessors = []);\n    const s = {\n      bufferView: t,\n      byteOffset: e.byteOffset,\n      componentType: e.componentType,\n      count: e.count,\n      type: e.type,\n      min: e.min,\n      max: e.max,\n      name: e.name\n    };\n    e.normalized && (s.normalized = !0);\n    const r = this.gltf.accessors.length;\n    return this.gltf.accessors.push(s), r;\n  }\n\n  addMeshVertexIndexed(t, e, s, r, i, a, o, n) {\n    for (const l of e) {\n      t.startAccessor(\"INDICES\");\n\n      for (let s = 0; s < l.faces.length; ++s) t.push(l.faces[s]);\n\n      const e = t.endAccessor(),\n            c = {\n        attributes: {\n          POSITION: r\n        },\n        indices: this.addAccessor(t.index, e),\n        material: this.addMaterial(l.material)\n      };\n      i && \"flat\" !== l.shading && (c.attributes.NORMAL = i), a && (c.attributes.TEXCOORD_0 = a), o && \"flat\" !== l.shading && (c.attributes.TANGENT = o), n && (c.attributes.COLOR_0 = n), s.primitives.push(c);\n    }\n  }\n\n  addMeshVertexNonIndexed(t, e, s, r, i, a, o) {\n    const n = {\n      attributes: {\n        POSITION: s\n      }\n    };\n    r && (n.attributes.NORMAL = r), i && (n.attributes.TEXCOORD_0 = i), a && (n.attributes.TANGENT = a), o && (n.attributes.COLOR_0 = o), t && (n.material = this.addMaterial(t[0].material)), e.primitives.push(n);\n  }\n\n}\n\nexport { v as GLTF };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/geometry/support/meshUtils/exporters/gltf/gltf.js"],"names":["isSome","t","j","e","I","s","b","r","k","i","Z","a","o","O","n","l","ungeoreferenceByTransform","c","Buffer","h","computeOrigin","u","smoothNormalsMesh","f","BufferOutputType","d","ImageOutputType","m","AttributeType","p","TargetBuffer","g","AlphaMode","x","imageToArrayBuffer","imageToDataURI","A","v","constructor","params","materialMap","Array","gltf","asset","version","copyright","generator","extras","options","binChunkBuffer","promises","addScenes","scene","defaultScene","bufferOutputType","GLB","imageOutputType","forEachScene","addScene","finalize","scenes","name","forEachNode","nodes","addNode","push","translation","rotation","scale","mesh","vertexAttributes","position","addMesh","children","length","meshes","primitives","clone","origin","rotate","transform","geographic","unit","normal","tangent","addBufferView","VEC3","ARRAY_BUFFER","uv","VEC2","VEC4","color","startAccessor","endAccessor","R","addAccessor","index","T","M","C","E","components","faces","SCALAR","ELEMENT_ARRAY_BUFFER","addMeshVertexIndexed","addMeshVertexNonIndexed","w","addMaterial","indexOf","materials","alphaMode","MASK","BLEND","alphaCutoff","doubleSided","pbrMetallicRoughness","toRgba","baseColorFactor","colorTexture","baseColorTexture","addTexture","normalTexture","emissiveTexture","emissiveColor","emissiveFactor","occlusionTexture","metallicRoughnessTexture","metallicFactor","metallic","roughnessFactor","roughness","textures","sampler","addSampler","source","addImage","images","url","uri","data","writeAsync","then","bufferView","mimeType","DataURI","samplers","wrap","vertical","horizontal","wrapS","wrapT","JSON","stringify","accessors","byteOffset","componentType","count","type","min","max","normalized","attributes","POSITION","indices","material","shading","NORMAL","TEXCOORD_0","TANGENT","COLOR_0","GLTF"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isSome as t}from\"../../../../../core/maybe.js\";import{j as e}from\"../../../../../chunks/quat.js\";import{I as s,b as r}from\"../../../../../chunks/quatf64.js\";import{k as i}from\"../../../../../chunks/vec3.js\";import{Z as a,a as o,O as n}from\"../../../../../chunks/vec3f64.js\";import l from\"../../../MeshMaterialMetallicRoughness.js\";import{ungeoreferenceByTransform as c}from\"../../georeference.js\";import{Buffer as h}from\"./buffer.js\";import{computeOrigin as u,smoothNormalsMesh as f}from\"./geometry.js\";import{BufferOutputType as d,ImageOutputType as m,AttributeType as p,TargetBuffer as g,AlphaMode as x}from\"./types.js\";import{imageToArrayBuffer as b,imageToDataURI as A}from\"./imageutils.js\";class v{constructor(t,e,s){this.params={},this.materialMap=new Array,this.gltf={asset:{version:\"2.0\",copyright:t.copyright,generator:t.generator},extras:{options:e,binChunkBuffer:null,promises:[]}},s&&(this.params=s),this.addScenes(t)}addScenes(t){this.gltf.scene=t.defaultScene;const e=this.gltf.extras.options.bufferOutputType===d.GLB||this.gltf.extras.options.imageOutputType===m.GLB;e&&(this.gltf.extras.binChunkBuffer=new h(this.gltf)),t.forEachScene((t=>{this.addScene(t)})),e&&this.gltf.extras.binChunkBuffer.finalize()}addScene(t){this.gltf.scenes||(this.gltf.scenes=[]);const e={};t.name&&(e.name=t.name),t.forEachNode((t=>{e.nodes||(e.nodes=[]);const s=this.addNode(t);e.nodes.push(s)})),this.gltf.scenes.push(e)}addNode(t){this.gltf.nodes||(this.gltf.nodes=[]);const l={};t.name&&(l.name=t.name);const c=t.translation;i(c,a)||(l.translation=o(c));const h=t.rotation;e(h,s)||(l.rotation=r(h));const u=t.scale;i(u,n)||(l.scale=o(u)),t.mesh&&t.mesh.vertexAttributes.position?l.mesh=this.addMesh(t.mesh):t.forEachNode((t=>{l.children||(l.children=[]);const e=this.addNode(t);l.children.push(e)}));const f=this.gltf.nodes.length;return this.gltf.nodes.push(l),f}addMesh(e){this.gltf.meshes||(this.gltf.meshes=[]);const s={primitives:[]},r=this.gltf.extras.options.bufferOutputType===d.GLB;let i;i=r?this.gltf.extras.binChunkBuffer:new h(this.gltf);const a=e.clone();this.params.origin||(this.params.origin=u(a)),a.rotate(-90,0,0,{origin:this.params.origin}),f(a);const o=c(a.vertexAttributes,a.transform,this.params.origin,{geographic:this.params.geographic,unit:\"meters\"});a.vertexAttributes.position=o.position,a.vertexAttributes.normal=o.normal,a.vertexAttributes.tangent=o.tangent;const n=i.addBufferView(5126,p.VEC3,g.ARRAY_BUFFER);let l,m,x,b;a.vertexAttributes.normal&&(l=i.addBufferView(5126,p.VEC3,g.ARRAY_BUFFER)),a.vertexAttributes.uv&&(m=i.addBufferView(5126,p.VEC2,g.ARRAY_BUFFER)),a.vertexAttributes.tangent&&(x=i.addBufferView(5126,p.VEC4,g.ARRAY_BUFFER)),a.vertexAttributes.color&&(b=i.addBufferView(5121,p.VEC4,g.ARRAY_BUFFER)),n.startAccessor(\"POSITION\"),l&&l.startAccessor(\"NORMAL\"),m&&m.startAccessor(\"TEXCOORD_0\"),x&&x.startAccessor(\"TANGENT\"),b&&b.startAccessor(\"COLOR_0\");const A=a.vertexAttributes.position.length/3;for(let c=0;c<A;++c)n.push(a.vertexAttributes.position[3*c+0]),n.push(a.vertexAttributes.position[3*c+1]),n.push(a.vertexAttributes.position[3*c+2]),l&&t(a.vertexAttributes.normal)&&(l.push(a.vertexAttributes.normal[3*c+0]),l.push(a.vertexAttributes.normal[3*c+1]),l.push(a.vertexAttributes.normal[3*c+2])),m&&t(a.vertexAttributes.uv)&&(m.push(a.vertexAttributes.uv[2*c+0]),m.push(a.vertexAttributes.uv[2*c+1])),x&&t(a.vertexAttributes.tangent)&&(x.push(a.vertexAttributes.tangent[4*c+0]),x.push(a.vertexAttributes.tangent[4*c+1]),x.push(a.vertexAttributes.tangent[4*c+2]),x.push(a.vertexAttributes.tangent[4*c+3])),b&&t(a.vertexAttributes.color)&&(b.push(a.vertexAttributes.color[4*c+0]),b.push(a.vertexAttributes.color[4*c+1]),b.push(a.vertexAttributes.color[4*c+2]),b.push(a.vertexAttributes.color[4*c+3]));const v=n.endAccessor(),R=this.addAccessor(n.index,v);let T,M,O,C,E;if(l){const t=l.endAccessor();T=this.addAccessor(l.index,t)}if(m){const t=m.endAccessor();M=this.addAccessor(m.index,t)}if(x){const t=x.endAccessor();O=this.addAccessor(x.index,t)}if(b){const t=b.endAccessor();C=this.addAccessor(b.index,t)}a.components&&a.components.length>0&&a.components[0].faces?(E=i.addBufferView(5125,p.SCALAR,g.ELEMENT_ARRAY_BUFFER),this.addMeshVertexIndexed(E,a.components,s,R,T,M,O,C)):this.addMeshVertexNonIndexed(a.components,s,R,T,M,O,C),n.finalize(),l&&l.finalize(),m&&m.finalize(),x&&x.finalize(),E&&E.finalize(),b&&b.finalize(),r||i.finalize();const w=this.gltf.meshes.length;return this.gltf.meshes.push(s),w}addMaterial(e){if(null===e)return;const s=this.materialMap.indexOf(e);if(-1!==s)return s;this.gltf.materials||(this.gltf.materials=[]);const r={};switch(e.alphaMode){case\"mask\":r.alphaMode=x.MASK;break;case\"auto\":case\"blend\":r.alphaMode=x.BLEND}.5!==e.alphaCutoff&&(r.alphaCutoff=e.alphaCutoff),e.doubleSided&&(r.doubleSided=e.doubleSided),r.pbrMetallicRoughness={};const i=t=>t**2.1,a=t=>{const e=t.toRgba();return e[0]=i(e[0]/255),e[1]=i(e[1]/255),e[2]=i(e[2]/255),e};if(t(e.color)&&(r.pbrMetallicRoughness.baseColorFactor=a(e.color)),t(e.colorTexture)&&(r.pbrMetallicRoughness.baseColorTexture={index:this.addTexture(e.colorTexture)}),t(e.normalTexture)&&(r.normalTexture={index:this.addTexture(e.normalTexture)}),e instanceof l){if(t(e.emissiveTexture)&&(r.emissiveTexture={index:this.addTexture(e.emissiveTexture)}),t(e.emissiveColor)){const t=a(e.emissiveColor);r.emissiveFactor=[t[0],t[1],t[2]]}t(e.occlusionTexture)&&(r.occlusionTexture={index:this.addTexture(e.occlusionTexture)}),t(e.metallicRoughnessTexture)&&(r.pbrMetallicRoughness.metallicRoughnessTexture={index:this.addTexture(e.metallicRoughnessTexture)}),r.pbrMetallicRoughness.metallicFactor=e.metallic,r.pbrMetallicRoughness.roughnessFactor=e.roughness}else r.pbrMetallicRoughness.metallicFactor=1,r.pbrMetallicRoughness.roughnessFactor=1;const o=this.gltf.materials.length;return this.gltf.materials.push(r),this.materialMap.push(e),o}addTexture(t){this.gltf.textures||(this.gltf.textures=[]);const e={sampler:this.addSampler(t),source:this.addImage(t)},s=this.gltf.textures.length;return this.gltf.textures.push(e),s}addImage(t){this.gltf.images||(this.gltf.images=[]);const e={};if(t.url)e.uri=t.url;else{e.extras=t.data;for(let e=0;e<this.gltf.images.length;++e)if(t.data===this.gltf.images[e].extras)return e;switch(this.gltf.extras.options.imageOutputType){case m.GLB:{const s=this.gltf.extras.binChunkBuffer.addBufferView(5121,p.SCALAR);s.writeAsync(b(t.data)).then((()=>{s.finalize()})),e.bufferView=s.index,e.mimeType=\"image/png\";break}case m.DataURI:e.uri=A(t.data);break;default:this.gltf.extras.promises.push(b(t.data).then((t=>{e.uri=t})))}}const s=this.gltf.images.length;return this.gltf.images.push(e),s}addSampler(t){this.gltf.samplers||(this.gltf.samplers=[]);let e=10497,s=10497;if(\"string\"==typeof t.wrap)switch(t.wrap){case\"clamp\":e=33071,s=33071;break;case\"mirror\":e=33648,s=33648}else{switch(t.wrap.vertical){case\"clamp\":s=33071;break;case\"mirror\":s=33648}switch(t.wrap.horizontal){case\"clamp\":e=33071;break;case\"mirror\":e=33648}}const r={wrapS:e,wrapT:s};for(let a=0;a<this.gltf.samplers.length;++a)if(JSON.stringify(r)===JSON.stringify(this.gltf.samplers[a]))return a;const i=this.gltf.samplers.length;return this.gltf.samplers.push(r),i}addAccessor(t,e){this.gltf.accessors||(this.gltf.accessors=[]);const s={bufferView:t,byteOffset:e.byteOffset,componentType:e.componentType,count:e.count,type:e.type,min:e.min,max:e.max,name:e.name};e.normalized&&(s.normalized=!0);const r=this.gltf.accessors.length;return this.gltf.accessors.push(s),r}addMeshVertexIndexed(t,e,s,r,i,a,o,n){for(const l of e){t.startAccessor(\"INDICES\");for(let s=0;s<l.faces.length;++s)t.push(l.faces[s]);const e=t.endAccessor(),c={attributes:{POSITION:r},indices:this.addAccessor(t.index,e),material:this.addMaterial(l.material)};i&&\"flat\"!==l.shading&&(c.attributes.NORMAL=i),a&&(c.attributes.TEXCOORD_0=a),o&&\"flat\"!==l.shading&&(c.attributes.TANGENT=o),n&&(c.attributes.COLOR_0=n),s.primitives.push(c)}}addMeshVertexNonIndexed(t,e,s,r,i,a,o){const n={attributes:{POSITION:s}};r&&(n.attributes.NORMAL=r),i&&(n.attributes.TEXCOORD_0=i),a&&(n.attributes.TANGENT=a),o&&(n.attributes.COLOR_0=o),t&&(n.material=this.addMaterial(t[0].material)),e.primitives.push(n)}}export{v as GLTF};\n"]},"metadata":{},"sourceType":"module"}