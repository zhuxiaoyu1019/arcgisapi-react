{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { removeMaybe as e, isSome as s } from \"../../../../core/maybe.js\";\nimport { addFrameTask as o } from \"../../../../core/scheduling.js\";\n\nclass d {\n  constructor() {\n    this.lodCrossfadeSignedDuration = 0;\n  }\n\n}\n\nclass i {\n  constructor(e) {\n    this.view = e, this._preRenderFrameTaskHandle = null, this._currentFrameStartTime = null, this._numFadingNodes = 0;\n  }\n\n  get updating() {\n    return this._numFadingNodes > 0;\n  }\n\n  stopNodeFading(s) {\n    null != s.lodCrossfadeProgress && (this._numFadingNodes--, s.lodCrossfadeProgress = null, 0 === this._numFadingNodes && (null != this._preRenderFrameTaskHandle && (this._preRenderFrameTaskHandle = e(this._preRenderFrameTaskHandle)), this.view.notifyLODUpdate(), this.view.notifyUpdate()));\n  }\n\n  _startNodeFading(e, s, d) {\n    0 === this._numFadingNodes && (this._preRenderFrameTaskHandle = o({\n      preRender: e => this._updateAllNodeFading(e)\n    }), this.view.notifyLODUpdate()), null == e.lodCrossfadeProgress && (this._numFadingNodes++, this.view.notifyUpdate()), e.lodCrossfadeSignedDuration = d, e.lodCrossfadeProgress = s;\n  }\n\n  _updateAllNodeFading(e) {\n    const o = this.view.nodeCrossfadingEnabled;\n    this.view.foreachCrossfadeNode((d, i) => {\n      if (s(i) && s(i.lodCrossfadeProgress)) {\n        const s = i.lodCrossfadeSignedDuration,\n              t = s > 0 ? this.view.fullOpacity : 0,\n              a = e.deltaTime / s,\n              r = i.lodCrossfadeProgress + Math.abs(a),\n              n = !o || r >= 1 || 0 === s,\n              l = t - (n ? 0 : s > 0 ? 1 : -1) * (1 - r);\n        n ? (this.stopNodeFading(i), s < 0 && this.view.markNodeToRemove(d)) : i.lodCrossfadeProgress = r, this.view.setNodeOpacityByIndex(d, l);\n      }\n    }), this.view.removeMarkedNodes();\n  }\n\n  stopAllNodeFading() {\n    this.view.foreachCrossfadeNode((e, o) => {\n      if (s(o) && s(o.lodCrossfadeProgress)) {\n        this.stopNodeFading(o);\n        const s = o.lodCrossfadeSignedDuration;\n        s < 0 && this.view.markNodeToRemove(e);\n        const d = s > 0 ? this.view.fullOpacity : 0;\n        this.view.setNodeOpacityByIndex(e, d);\n      }\n    }), this.view.removeMarkedNodes();\n  }\n\n  fadeNode(e, s, o, d) {\n    null == this._currentFrameStartTime && (this._currentFrameStartTime = Date.now());\n    const i = this.view,\n          a = i.nodeCrossfadingEnabled,\n          r = 0 === o ? i.fullOpacity : 0,\n          n = a ? d ? 0 === o ? i.lodCrossfadeinDuration : i.lodCrossfadeoutDuration : i.lodCrossfadeUncoveredDuration : 0,\n          l = this.view.getNodeOpacityByIndex(e);\n\n    if (a && l !== r && n > 0) {\n      const e = 1 - Math.abs(r - l);\n\n      this._startNodeFading(s, e, t(o) * n);\n    } else this.stopNodeFading(s), this.view.setNodeOpacityByIndex(e, r), 1 === o && this.view.removeNode(e);\n  }\n\n  isNodeFullyFadedIn(e) {\n    const o = this.view.getNodeCrossfadeMetaData(e);\n    return s(o) && null == o.lodCrossfadeProgress && this.view.getNodeOpacityByIndex(e) === this.view.fullOpacity;\n  }\n\n}\n\nfunction t(e) {\n  return 0 === e ? 1 : -1;\n}\n\nexport { i as I3SCrossfadeHelper, d as NodeCrossfadeMetaData };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/layers/i3s/I3SCrossfadeHelper.js"],"names":["removeMaybe","e","isSome","s","addFrameTask","o","d","constructor","lodCrossfadeSignedDuration","i","view","_preRenderFrameTaskHandle","_currentFrameStartTime","_numFadingNodes","updating","stopNodeFading","lodCrossfadeProgress","notifyLODUpdate","notifyUpdate","_startNodeFading","preRender","_updateAllNodeFading","nodeCrossfadingEnabled","foreachCrossfadeNode","t","fullOpacity","a","deltaTime","r","Math","abs","n","l","markNodeToRemove","setNodeOpacityByIndex","removeMarkedNodes","stopAllNodeFading","fadeNode","Date","now","lodCrossfadeinDuration","lodCrossfadeoutDuration","lodCrossfadeUncoveredDuration","getNodeOpacityByIndex","removeNode","isNodeFullyFadedIn","getNodeCrossfadeMetaData","I3SCrossfadeHelper","NodeCrossfadeMetaData"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{removeMaybe as e,isSome as s}from\"../../../../core/maybe.js\";import{addFrameTask as o}from\"../../../../core/scheduling.js\";class d{constructor(){this.lodCrossfadeSignedDuration=0}}class i{constructor(e){this.view=e,this._preRenderFrameTaskHandle=null,this._currentFrameStartTime=null,this._numFadingNodes=0}get updating(){return this._numFadingNodes>0}stopNodeFading(s){null!=s.lodCrossfadeProgress&&(this._numFadingNodes--,s.lodCrossfadeProgress=null,0===this._numFadingNodes&&(null!=this._preRenderFrameTaskHandle&&(this._preRenderFrameTaskHandle=e(this._preRenderFrameTaskHandle)),this.view.notifyLODUpdate(),this.view.notifyUpdate()))}_startNodeFading(e,s,d){0===this._numFadingNodes&&(this._preRenderFrameTaskHandle=o({preRender:e=>this._updateAllNodeFading(e)}),this.view.notifyLODUpdate()),null==e.lodCrossfadeProgress&&(this._numFadingNodes++,this.view.notifyUpdate()),e.lodCrossfadeSignedDuration=d,e.lodCrossfadeProgress=s}_updateAllNodeFading(e){const o=this.view.nodeCrossfadingEnabled;this.view.foreachCrossfadeNode(((d,i)=>{if(s(i)&&s(i.lodCrossfadeProgress)){const s=i.lodCrossfadeSignedDuration,t=s>0?this.view.fullOpacity:0,a=e.deltaTime/s,r=i.lodCrossfadeProgress+Math.abs(a),n=!o||r>=1||0===s,l=t-(n?0:s>0?1:-1)*(1-r);n?(this.stopNodeFading(i),s<0&&this.view.markNodeToRemove(d)):i.lodCrossfadeProgress=r,this.view.setNodeOpacityByIndex(d,l)}})),this.view.removeMarkedNodes()}stopAllNodeFading(){this.view.foreachCrossfadeNode(((e,o)=>{if(s(o)&&s(o.lodCrossfadeProgress)){this.stopNodeFading(o);const s=o.lodCrossfadeSignedDuration;s<0&&this.view.markNodeToRemove(e);const d=s>0?this.view.fullOpacity:0;this.view.setNodeOpacityByIndex(e,d)}})),this.view.removeMarkedNodes()}fadeNode(e,s,o,d){null==this._currentFrameStartTime&&(this._currentFrameStartTime=Date.now());const i=this.view,a=i.nodeCrossfadingEnabled,r=0===o?i.fullOpacity:0,n=a?d?0===o?i.lodCrossfadeinDuration:i.lodCrossfadeoutDuration:i.lodCrossfadeUncoveredDuration:0,l=this.view.getNodeOpacityByIndex(e);if(a&&l!==r&&n>0){const e=1-Math.abs(r-l);this._startNodeFading(s,e,t(o)*n)}else this.stopNodeFading(s),this.view.setNodeOpacityByIndex(e,r),1===o&&this.view.removeNode(e)}isNodeFullyFadedIn(e){const o=this.view.getNodeCrossfadeMetaData(e);return s(o)&&null==o.lodCrossfadeProgress&&this.view.getNodeOpacityByIndex(e)===this.view.fullOpacity}}function t(e){return 0===e?1:-1}export{i as I3SCrossfadeHelper,d as NodeCrossfadeMetaData};\n"]},"metadata":{},"sourceType":"module"}