{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { disposeMaybe as e, isSome as t, isNone as s } from \"../../../../core/maybe.js\";\nimport { a as i } from \"../../../../chunks/vec2f64.js\";\nimport { i as r } from \"../../../../chunks/vec3.js\";\nimport { c as o } from \"../../../../chunks/vec4.js\";\nimport { c as a } from \"../../../../chunks/vec4f64.js\";\nimport { requestImage as h } from \"../../../../support/requestImageUtils.js\";\nimport { createQuadVAO as n } from \"./glUtil3D.js\";\nimport { SSAOTechniqueConfiguration as _, FILTER_RADIUS as u, SSAOTechnique as l } from \"./SSAOTechnique.js\";\nimport { inverseProjectionInfo as m } from \"./Util.js\";\nimport p from \"../../../webgl/FramebufferObject.js\";\nimport d from \"../../../webgl/Texture.js\";\nimport { vertexCount as c } from \"../../../webgl/Util.js\";\n\nclass f {\n  constructor(e, t, s) {\n    this._techniqueRep = e, this._rctx = t, this._requestRender = s, this._enabled = !1, this._ssaoTechniqueConfig = new _(), this.quadVAO = null, this._BLUR_F = 2, this._attenuation = .5, this._radius = 3, this._samples = 16, this._viewportToRestore = a();\n  }\n\n  dispose() {\n    this.quadVAO = e(this.quadVAO);\n  }\n\n  set enabled(e) {\n    e ? this._enable() : this._disable();\n  }\n\n  get enabled() {\n    return this._enabled;\n  }\n\n  set attenuation(e) {\n    this._attenuation = e;\n  }\n\n  get attenuation() {\n    return this._attenuation;\n  }\n\n  set radius(e) {\n    this._radius = e;\n  }\n\n  get radius() {\n    return this._radius;\n  }\n\n  set samples(e) {\n    this._samples = e, this._enabled && this._selectPrograms();\n  }\n\n  get samples() {\n    return this._samples;\n  }\n\n  get ready() {\n    return this.enabled && t(this._noiseTexture) && t(this._ssaoFBO) && t(this._blur0FBO) && t(this._blur1FBO);\n  }\n\n  computeSSAO(e, t, i) {\n    if (!this.enabled || s(this._noiseTexture) || s(this._ssaoFBO) || s(this._blur0FBO) || s(this._blur1FBO)) return;\n    const a = this._rctx,\n          h = e.fullViewport,\n          _ = h[2],\n          l = h[3],\n          p = _ / this._BLUR_F,\n          d = l / this._BLUR_F;\n    this._ssaoFBO.resize(_, l), this._blur0FBO.resize(p, d), this._blur1FBO.resize(p, d);\n    const f = 1,\n          g = 1,\n          T = _ * f,\n          O = l * g;\n    o(this._viewportToRestore, e.fullViewport), a.bindFramebuffer(this._ssaoFBO), a.setViewport(0, 0, _, l);\n    const B = this._ssaoTechnique.program;\n    a.useProgram(B), a.setPipelineState(this._ssaoTechnique.pipeline), B.setUniform2f(\"rnmScale\", _ / this._noiseTexture.descriptor.width, l / this._noiseTexture.descriptor.height), B.setUniform3fv(\"pSphere\", this._samples <= 8 ? this._data.random8 : this._samples <= 16 ? this._data.random16 : this._samples <= 32 ? this._data.random32 : this._data.random64);\n    const x = this._data.minDiscrepancy,\n          U = this._samples < x.length ? x[this._samples] : 5779;\n    B.setUniform1f(\"numSpiralTurns\", U);\n    const w = F,\n          q = b;\n    m(e.projectionMatrix, e.fullWidth, e.fullHeight, w, q), B.setUniform4fv(\"projInfo\", w), B.setUniform2fv(\"zScale\", q), B.setUniform2f(\"nearFar\", e.near, e.far);\n    let R = 1 / e.computeRenderPixelSizeAtDist(1);\n    B.setUniform1f(\"projScale\", R * f), B.setUniform2f(\"screenDimensions\", T, O);\n    const S = r(e.eye, e.center);\n    let A = 20 * e.computeRenderPixelSizeAtDist(S);\n    A = Math.max(.1, A), B.setUniform1f(\"radius\", A), B.setUniform1f(\"intensity\", 4 * this._attenuation / A ** 6), B.bindTexture(this._noiseTexture, \"rnm\"), B.bindTexture(i, \"normalMap\"), B.bindTexture(t, \"depthMap\"), s(this.quadVAO) && (this.quadVAO = n(this._rctx));\n    const j = this.quadVAO;\n    a.bindVAO(j), a.drawArrays(5, 0, c(j, \"geometry\"));\n    const v = (u + 1) / 2,\n          y = 1 / (2 * v * v),\n          M = this._blurTechnique.program;\n    a.useProgram(M), M.bindTexture(this._ssaoFBO.colorTexture, \"tex\"), M.bindTexture(i, \"normalMap\"), M.bindTexture(t, \"depthMap\"), a.setViewport(0, 0, T / this._BLUR_F, O / this._BLUR_F), a.bindFramebuffer(this._blur0FBO), M.setUniform2f(\"screenDimensions\", T, O), M.setUniform2f(\"blurSize\", 0, this._BLUR_F * f / O), M.setUniform1i(\"radius\", u), M.setUniform1f(\"g_BlurFalloff\", y), M.setUniform2f(\"nearFar\", e.near, e.far), S > 5e4 && (R = Math.max(0, R - (S - 5e4))), M.setUniform1f(\"projScale\", R), M.setUniform2f(\"zScale\", 1, 0), a.drawArrays(5, 0, c(j, \"geometry\")), M.setUniform2f(\"blurSize\", this._BLUR_F * g / T, 0), a.bindFramebuffer(this._blur1FBO), M.bindTexture(this._blur0FBO.colorTexture, \"tex\"), a.drawArrays(5, 0, c(j, \"geometry\")), a.setViewport(this._viewportToRestore[0], this._viewportToRestore[1], this._viewportToRestore[2], this._viewportToRestore[3]);\n  }\n\n  bind(e) {\n    this.enabled && t(this._blur1FBO) && t(this._ssaoFBO) ? (e.bindTexture(this._blur1FBO.colorTexture, \"ssaoTex\"), e.setUniform4f(\"viewportPixelSz\", this._viewportToRestore[0], this._viewportToRestore[1], 1 / this._ssaoFBO.width, 1 / this._ssaoFBO.height)) : e.setUniform4f(\"viewportPixelSz\", -1, -1, -1, -1);\n  }\n\n  _selectPrograms() {\n    const e = this._samples <= 8 ? 0 : this._samples <= 16 ? 1 : this._samples <= 32 ? 2 : 3;\n    this._ssaoTechniqueConfig.samples = e, this._ssaoTechniqueConfig.output = 0, this._ssaoTechnique = this._techniqueRep.releaseAndAcquire(l, this._ssaoTechniqueConfig, this._ssaoTechnique), this._ssaoTechniqueConfig.output = 1, this._blurTechnique = this._techniqueRep.releaseAndAcquire(l, this._ssaoTechniqueConfig, this._blurTechnique);\n  }\n\n  _enable() {\n    this.enabled || (this._enabled = !0, this._loadResources(() => {\n      this._enabled && this._initialize();\n    }));\n  }\n\n  _loadResources(e) {\n    this._data ? e() : import(\"./SSAOHelperData.js\").then(t => {\n      this._data = t, e();\n    });\n  }\n\n  _initialize() {\n    const e = {\n      target: 3553,\n      pixelFormat: 6408,\n      dataType: 5121,\n      samplingMode: 9729,\n      wrapMode: 33071,\n      width: 0,\n      height: 0\n    },\n          t = {\n      colorTarget: 0,\n      depthStencilTarget: 0\n    };\n    h(this._data.noiseTexture).then(s => {\n      this._enabled && (this._ssaoFBO = new p(this._rctx, t, e), this._blur0FBO = new p(this._rctx, t, e), this._blur1FBO = new p(this._rctx, t, e), this._noiseTexture = new d(this._rctx, {\n        target: 3553,\n        pixelFormat: 6408,\n        dataType: 5121,\n        hasMipmap: !0,\n        width: s.width,\n        height: s.height\n      }, s), this._requestRender());\n    }), this._selectPrograms();\n  }\n\n  _disable() {\n    this._enabled = !1, this._noiseTexture = e(this._noiseTexture), this._blur1FBO = e(this._blur1FBO), this._blur0FBO = e(this._blur0FBO), this._ssaoFBO = e(this._ssaoFBO);\n  }\n\n  get gpuMemoryUsage() {\n    return (t(this._blur0FBO) ? this._blur0FBO.gpuMemoryUsage : 0) + (t(this._blur1FBO) ? this._blur1FBO.gpuMemoryUsage : 0) + (t(this._ssaoFBO) ? this._ssaoFBO.gpuMemoryUsage : 0);\n  }\n\n  get test() {\n    return {\n      ssao: this._ssaoFBO,\n      blur: this._blur1FBO\n    };\n  }\n\n}\n\nconst b = i(),\n      F = a();\nexport default f;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/webgl-engine/lib/SSAOHelper.js"],"names":["disposeMaybe","e","isSome","t","isNone","s","a","i","r","c","o","requestImage","h","createQuadVAO","n","SSAOTechniqueConfiguration","_","FILTER_RADIUS","u","SSAOTechnique","l","inverseProjectionInfo","m","p","d","vertexCount","f","constructor","_techniqueRep","_rctx","_requestRender","_enabled","_ssaoTechniqueConfig","quadVAO","_BLUR_F","_attenuation","_radius","_samples","_viewportToRestore","dispose","enabled","_enable","_disable","attenuation","radius","samples","_selectPrograms","ready","_noiseTexture","_ssaoFBO","_blur0FBO","_blur1FBO","computeSSAO","fullViewport","resize","g","T","O","bindFramebuffer","setViewport","B","_ssaoTechnique","program","useProgram","setPipelineState","pipeline","setUniform2f","descriptor","width","height","setUniform3fv","_data","random8","random16","random32","random64","x","minDiscrepancy","U","length","setUniform1f","w","F","q","b","projectionMatrix","fullWidth","fullHeight","setUniform4fv","setUniform2fv","near","far","R","computeRenderPixelSizeAtDist","S","eye","center","A","Math","max","bindTexture","j","bindVAO","drawArrays","v","y","M","_blurTechnique","colorTexture","setUniform1i","bind","setUniform4f","output","releaseAndAcquire","_loadResources","_initialize","then","target","pixelFormat","dataType","samplingMode","wrapMode","colorTarget","depthStencilTarget","noiseTexture","hasMipmap","gpuMemoryUsage","test","ssao","blur"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{disposeMaybe as e,isSome as t,isNone as s}from\"../../../../core/maybe.js\";import{a as i}from\"../../../../chunks/vec2f64.js\";import{i as r}from\"../../../../chunks/vec3.js\";import{c as o}from\"../../../../chunks/vec4.js\";import{c as a}from\"../../../../chunks/vec4f64.js\";import{requestImage as h}from\"../../../../support/requestImageUtils.js\";import{createQuadVAO as n}from\"./glUtil3D.js\";import{SSAOTechniqueConfiguration as _,FILTER_RADIUS as u,SSAOTechnique as l}from\"./SSAOTechnique.js\";import{inverseProjectionInfo as m}from\"./Util.js\";import p from\"../../../webgl/FramebufferObject.js\";import d from\"../../../webgl/Texture.js\";import{vertexCount as c}from\"../../../webgl/Util.js\";class f{constructor(e,t,s){this._techniqueRep=e,this._rctx=t,this._requestRender=s,this._enabled=!1,this._ssaoTechniqueConfig=new _,this.quadVAO=null,this._BLUR_F=2,this._attenuation=.5,this._radius=3,this._samples=16,this._viewportToRestore=a()}dispose(){this.quadVAO=e(this.quadVAO)}set enabled(e){e?this._enable():this._disable()}get enabled(){return this._enabled}set attenuation(e){this._attenuation=e}get attenuation(){return this._attenuation}set radius(e){this._radius=e}get radius(){return this._radius}set samples(e){this._samples=e,this._enabled&&this._selectPrograms()}get samples(){return this._samples}get ready(){return this.enabled&&t(this._noiseTexture)&&t(this._ssaoFBO)&&t(this._blur0FBO)&&t(this._blur1FBO)}computeSSAO(e,t,i){if(!this.enabled||s(this._noiseTexture)||s(this._ssaoFBO)||s(this._blur0FBO)||s(this._blur1FBO))return;const a=this._rctx,h=e.fullViewport,_=h[2],l=h[3],p=_/this._BLUR_F,d=l/this._BLUR_F;this._ssaoFBO.resize(_,l),this._blur0FBO.resize(p,d),this._blur1FBO.resize(p,d);const f=1,g=1,T=_*f,O=l*g;o(this._viewportToRestore,e.fullViewport),a.bindFramebuffer(this._ssaoFBO),a.setViewport(0,0,_,l);const B=this._ssaoTechnique.program;a.useProgram(B),a.setPipelineState(this._ssaoTechnique.pipeline),B.setUniform2f(\"rnmScale\",_/this._noiseTexture.descriptor.width,l/this._noiseTexture.descriptor.height),B.setUniform3fv(\"pSphere\",this._samples<=8?this._data.random8:this._samples<=16?this._data.random16:this._samples<=32?this._data.random32:this._data.random64);const x=this._data.minDiscrepancy,U=this._samples<x.length?x[this._samples]:5779;B.setUniform1f(\"numSpiralTurns\",U);const w=F,q=b;m(e.projectionMatrix,e.fullWidth,e.fullHeight,w,q),B.setUniform4fv(\"projInfo\",w),B.setUniform2fv(\"zScale\",q),B.setUniform2f(\"nearFar\",e.near,e.far);let R=1/e.computeRenderPixelSizeAtDist(1);B.setUniform1f(\"projScale\",R*f),B.setUniform2f(\"screenDimensions\",T,O);const S=r(e.eye,e.center);let A=20*e.computeRenderPixelSizeAtDist(S);A=Math.max(.1,A),B.setUniform1f(\"radius\",A),B.setUniform1f(\"intensity\",4*this._attenuation/A**6),B.bindTexture(this._noiseTexture,\"rnm\"),B.bindTexture(i,\"normalMap\"),B.bindTexture(t,\"depthMap\"),s(this.quadVAO)&&(this.quadVAO=n(this._rctx));const j=this.quadVAO;a.bindVAO(j),a.drawArrays(5,0,c(j,\"geometry\"));const v=(u+1)/2,y=1/(2*v*v),M=this._blurTechnique.program;a.useProgram(M),M.bindTexture(this._ssaoFBO.colorTexture,\"tex\"),M.bindTexture(i,\"normalMap\"),M.bindTexture(t,\"depthMap\"),a.setViewport(0,0,T/this._BLUR_F,O/this._BLUR_F),a.bindFramebuffer(this._blur0FBO),M.setUniform2f(\"screenDimensions\",T,O),M.setUniform2f(\"blurSize\",0,this._BLUR_F*f/O),M.setUniform1i(\"radius\",u),M.setUniform1f(\"g_BlurFalloff\",y),M.setUniform2f(\"nearFar\",e.near,e.far),S>5e4&&(R=Math.max(0,R-(S-5e4))),M.setUniform1f(\"projScale\",R),M.setUniform2f(\"zScale\",1,0),a.drawArrays(5,0,c(j,\"geometry\")),M.setUniform2f(\"blurSize\",this._BLUR_F*g/T,0),a.bindFramebuffer(this._blur1FBO),M.bindTexture(this._blur0FBO.colorTexture,\"tex\"),a.drawArrays(5,0,c(j,\"geometry\")),a.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3])}bind(e){this.enabled&&t(this._blur1FBO)&&t(this._ssaoFBO)?(e.bindTexture(this._blur1FBO.colorTexture,\"ssaoTex\"),e.setUniform4f(\"viewportPixelSz\",this._viewportToRestore[0],this._viewportToRestore[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height)):e.setUniform4f(\"viewportPixelSz\",-1,-1,-1,-1)}_selectPrograms(){const e=this._samples<=8?0:this._samples<=16?1:this._samples<=32?2:3;this._ssaoTechniqueConfig.samples=e,this._ssaoTechniqueConfig.output=0,this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(l,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=1,this._blurTechnique=this._techniqueRep.releaseAndAcquire(l,this._ssaoTechniqueConfig,this._blurTechnique)}_enable(){this.enabled||(this._enabled=!0,this._loadResources((()=>{this._enabled&&this._initialize()})))}_loadResources(e){this._data?e():import(\"./SSAOHelperData.js\").then((t=>{this._data=t,e()}))}_initialize(){const e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},t={colorTarget:0,depthStencilTarget:0};h(this._data.noiseTexture).then((s=>{this._enabled&&(this._ssaoFBO=new p(this._rctx,t,e),this._blur0FBO=new p(this._rctx,t,e),this._blur1FBO=new p(this._rctx,t,e),this._noiseTexture=new d(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:s.width,height:s.height},s),this._requestRender())})),this._selectPrograms()}_disable(){this._enabled=!1,this._noiseTexture=e(this._noiseTexture),this._blur1FBO=e(this._blur1FBO),this._blur0FBO=e(this._blur0FBO),this._ssaoFBO=e(this._ssaoFBO)}get gpuMemoryUsage(){return(t(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(t(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(t(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}const b=i(),F=a();export default f;\n"]},"metadata":{},"sourceType":"module"}