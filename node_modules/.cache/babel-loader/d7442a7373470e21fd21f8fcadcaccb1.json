{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from \"../../../../../../core/Error.js\";\nimport e from \"../../../../../../core/Logger.js\";\nimport { unwrapOr as i } from \"../../../../../../core/maybe.js\";\nimport { pt2px as s } from \"../../../../../../core/screenUtils.js\";\nimport { c as r } from \"../../../../../../chunks/mat2df32.js\";\nimport { c as o } from \"../../../../../../chunks/vec2f32.js\";\nimport { premultiplyAlphaRGBA as a } from \"../../color.js\";\nimport { MIN_MAX_ZOOM_PRECISION_FACTOR as h, SPRITE_PADDING as n } from \"../../definitions.js\";\nimport { i1616to32 as c, i8888to32 as m } from \"../../number.js\";\nimport { MarkerMaterialKey as l } from \"../../materialKey/MaterialKey.js\";\nimport { isFunction as f, getMinMaxZoom as _ } from \"./util.js\";\nimport p from \"./WGLBaseMarkerTemplate.js\";\nimport y from \"./WGLDynamicMeshTemplate.js\";\nimport { ok as d } from \"../../util/Result.js\";\nconst M = o(),\n      u = r(),\n      g = e.getLogger(\"esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate\");\n\nclass k extends p(y) {\n  constructor(t, e, r) {\n    if (super(t), this._cimMarkerLayer = t, this._minMaxZoom = c(Math.round(e * h), Math.round(r * h)), f(t.color)) {\n      const e = (e, i, s) => a(t.color(e, i, s));\n\n      this._dynamicPropertyMap.set(\"_fillColor\", e);\n    } else this._fillColor = a(t.color);\n\n    if (f(t.outlineColor)) {\n      const e = (e, i, s) => a(t.outlineColor(e, i, s));\n\n      this._dynamicPropertyMap.set(\"_outlineColor\", e);\n    } else this._outlineColor = a(t.outlineColor);\n\n    if (f(t.size)) {\n      const e = (e, i, r) => s(t.size(e, i, r));\n\n      this._dynamicPropertyMap.set(\"_size\", e);\n    } else this._size = s(t.size);\n\n    if (f(t.scaleX) ? this._dynamicPropertyMap.set(\"_scaleX\", t.scaleX) : this._scaleX = t.scaleX, f(t.offsetX)) {\n      const e = (e, i, r) => s(t.offsetX(e, i, r));\n\n      this._dynamicPropertyMap.set(\"xOffset\", e);\n    } else this.xOffset = s(t.offsetX);\n\n    if (f(t.offsetY)) {\n      const e = (e, i, r) => s(t.offsetY(e, i, r));\n\n      this._dynamicPropertyMap.set(\"yOffset\", e);\n    } else this.yOffset = s(t.offsetY);\n\n    if (f(t.outlineWidth)) {\n      const e = (e, i, r) => s(t.outlineWidth(e, i, r));\n\n      this._dynamicPropertyMap.set(\"_outlineWidth\", e);\n    } else this._outlineWidth = s(t.outlineWidth);\n\n    f(t.rotation) ? this._dynamicPropertyMap.set(\"_angle\", t.rotation) : this._angle = t.rotation, this._scaleFactor = i(t.scaleFactor, 1), this._markerPlacement = t.markerPlacement, this._effects = t.effects, this._bitSet = (1 === t.alignment ? 1 : 0) | (t.colorLocked ? 1 : 0) << 1 | (t.scaleSymbolsProportionally ? 1 : 0) << 3, this._materialKey = t.materialKey;\n  }\n\n  static fromCIMMarker(t, e) {\n    const [i, s] = _(t.scaleInfo, e);\n\n    return new k(t, i, s);\n  }\n\n  bindFeature(e, i, r) {\n    const o = e.readLegacyFeature();\n\n    this._dynamicPropertyMap.forEach((t, e) => {\n      this[e] = t(o, i, r);\n    });\n\n    const a = this._cimMarkerLayer.materialHash,\n          h = \"function\" == typeof a ? a(o, i, r) : a,\n          f = this._materialCache.get(h);\n\n    if (!f || !d(f.spriteMosaicItem) || !f.spriteMosaicItem) return void g.error(new t(\"mapview-cim\", \"Encountered an error when binding feature\"));\n    const _ = f.spriteMosaicItem,\n          p = this._cimMarkerLayer.sizeRatio,\n          y = _.width / _.height * this._scaleX,\n          k = this._cimMarkerLayer.rotateClockwise ? this._angle : -this._angle;\n    let L = this._size,\n        x = L * y;\n    const P = this.xOffset,\n          j = this.yOffset;\n    this.xOffset *= this._scaleFactor, this.yOffset *= this._scaleFactor;\n    const w = this._cimMarkerLayer.scaleSymbolsProportionally && this._cimMarkerLayer.frameHeight ? this._size / s(this._cimMarkerLayer.frameHeight) : 1,\n          z = this._outlineWidth * w,\n          b = s(this._cimMarkerLayer.referenceSize);\n    let O = 0,\n        W = 0;\n    const C = this._cimMarkerLayer.anchorPoint;\n    C && (this._cimMarkerLayer.isAbsoluteAnchorPoint ? this._size && (O = -C.x / (this._size * y), W = C.y / this._size) : (O = C.x, W = C.y)), this._sizeOutlineWidth = m(Math.round(Math.min(Math.sqrt(128 * x), 255)), Math.round(Math.min(Math.sqrt(128 * L), 255)), Math.round(Math.min(Math.sqrt(128 * z), 255)), Math.round(Math.min(Math.sqrt(128 * b), 255))), this.angle = k;\n    const X = Math.round(64 * p);\n    this._bitestAndDistRatio = c(this._bitSet, X);\n    const F = _.rect.x + n,\n          K = _.rect.y + n,\n          B = F + _.width,\n          I = K + _.height;\n    this._texUpperLeft = c(F, K), this._texUpperRight = c(B, K), this._texBottomLeft = c(F, I), this._texBottomRight = c(B, I);\n    const R = l.load(this._materialKey);\n    R.sdf = _.sdf, R.pattern = !0, R.textureBinding = _.textureBinding, this._materialKey = R.data, this._anchorX = .5 - (.5 + O) * _.width / _.width, this._anchorY = .5 - (.5 + W) * _.height / _.height, x *= p, L *= p, x *= this._scaleFactor, L *= this._scaleFactor, x *= _.rect.width / _.width, L *= _.rect.height / _.height, this._computedWidth = x, this._computedHeight = L, this._applyTransformation(u, M), this.xOffset = P, this.yOffset = j;\n  }\n\n}\n\nexport default k;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/2d/engine/webgl/mesh/templates/WGLDynamicMarkerTemplate.js"],"names":["t","e","unwrapOr","i","pt2px","s","c","r","o","premultiplyAlphaRGBA","a","MIN_MAX_ZOOM_PRECISION_FACTOR","h","SPRITE_PADDING","n","i1616to32","i8888to32","m","MarkerMaterialKey","l","isFunction","f","getMinMaxZoom","_","p","y","ok","d","M","u","g","getLogger","k","constructor","_cimMarkerLayer","_minMaxZoom","Math","round","color","_dynamicPropertyMap","set","_fillColor","outlineColor","_outlineColor","size","_size","scaleX","_scaleX","offsetX","xOffset","offsetY","yOffset","outlineWidth","_outlineWidth","rotation","_angle","_scaleFactor","scaleFactor","_markerPlacement","markerPlacement","_effects","effects","_bitSet","alignment","colorLocked","scaleSymbolsProportionally","_materialKey","materialKey","fromCIMMarker","scaleInfo","bindFeature","readLegacyFeature","forEach","materialHash","_materialCache","get","spriteMosaicItem","error","sizeRatio","width","height","rotateClockwise","L","x","P","j","w","frameHeight","z","b","referenceSize","O","W","C","anchorPoint","isAbsoluteAnchorPoint","_sizeOutlineWidth","min","sqrt","angle","X","_bitestAndDistRatio","F","rect","K","B","I","_texUpperLeft","_texUpperRight","_texBottomLeft","_texBottomRight","R","load","sdf","pattern","textureBinding","data","_anchorX","_anchorY","_computedWidth","_computedHeight","_applyTransformation"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from\"../../../../../../core/Error.js\";import e from\"../../../../../../core/Logger.js\";import{unwrapOr as i}from\"../../../../../../core/maybe.js\";import{pt2px as s}from\"../../../../../../core/screenUtils.js\";import{c as r}from\"../../../../../../chunks/mat2df32.js\";import{c as o}from\"../../../../../../chunks/vec2f32.js\";import{premultiplyAlphaRGBA as a}from\"../../color.js\";import{MIN_MAX_ZOOM_PRECISION_FACTOR as h,SPRITE_PADDING as n}from\"../../definitions.js\";import{i1616to32 as c,i8888to32 as m}from\"../../number.js\";import{MarkerMaterialKey as l}from\"../../materialKey/MaterialKey.js\";import{isFunction as f,getMinMaxZoom as _}from\"./util.js\";import p from\"./WGLBaseMarkerTemplate.js\";import y from\"./WGLDynamicMeshTemplate.js\";import{ok as d}from\"../../util/Result.js\";const M=o(),u=r(),g=e.getLogger(\"esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate\");class k extends(p(y)){constructor(t,e,r){if(super(t),this._cimMarkerLayer=t,this._minMaxZoom=c(Math.round(e*h),Math.round(r*h)),f(t.color)){const e=(e,i,s)=>a(t.color(e,i,s));this._dynamicPropertyMap.set(\"_fillColor\",e)}else this._fillColor=a(t.color);if(f(t.outlineColor)){const e=(e,i,s)=>a(t.outlineColor(e,i,s));this._dynamicPropertyMap.set(\"_outlineColor\",e)}else this._outlineColor=a(t.outlineColor);if(f(t.size)){const e=(e,i,r)=>s(t.size(e,i,r));this._dynamicPropertyMap.set(\"_size\",e)}else this._size=s(t.size);if(f(t.scaleX)?this._dynamicPropertyMap.set(\"_scaleX\",t.scaleX):this._scaleX=t.scaleX,f(t.offsetX)){const e=(e,i,r)=>s(t.offsetX(e,i,r));this._dynamicPropertyMap.set(\"xOffset\",e)}else this.xOffset=s(t.offsetX);if(f(t.offsetY)){const e=(e,i,r)=>s(t.offsetY(e,i,r));this._dynamicPropertyMap.set(\"yOffset\",e)}else this.yOffset=s(t.offsetY);if(f(t.outlineWidth)){const e=(e,i,r)=>s(t.outlineWidth(e,i,r));this._dynamicPropertyMap.set(\"_outlineWidth\",e)}else this._outlineWidth=s(t.outlineWidth);f(t.rotation)?this._dynamicPropertyMap.set(\"_angle\",t.rotation):this._angle=t.rotation,this._scaleFactor=i(t.scaleFactor,1),this._markerPlacement=t.markerPlacement,this._effects=t.effects,this._bitSet=(1===t.alignment?1:0)|(t.colorLocked?1:0)<<1|(t.scaleSymbolsProportionally?1:0)<<3,this._materialKey=t.materialKey}static fromCIMMarker(t,e){const[i,s]=_(t.scaleInfo,e);return new k(t,i,s)}bindFeature(e,i,r){const o=e.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,e)=>{this[e]=t(o,i,r)}));const a=this._cimMarkerLayer.materialHash,h=\"function\"==typeof a?a(o,i,r):a,f=this._materialCache.get(h);if(!f||!d(f.spriteMosaicItem)||!f.spriteMosaicItem)return void g.error(new t(\"mapview-cim\",\"Encountered an error when binding feature\"));const _=f.spriteMosaicItem,p=this._cimMarkerLayer.sizeRatio,y=_.width/_.height*this._scaleX,k=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let L=this._size,x=L*y;const P=this.xOffset,j=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const w=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/s(this._cimMarkerLayer.frameHeight):1,z=this._outlineWidth*w,b=s(this._cimMarkerLayer.referenceSize);let O=0,W=0;const C=this._cimMarkerLayer.anchorPoint;C&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(O=-C.x/(this._size*y),W=C.y/this._size):(O=C.x,W=C.y)),this._sizeOutlineWidth=m(Math.round(Math.min(Math.sqrt(128*x),255)),Math.round(Math.min(Math.sqrt(128*L),255)),Math.round(Math.min(Math.sqrt(128*z),255)),Math.round(Math.min(Math.sqrt(128*b),255))),this.angle=k;const X=Math.round(64*p);this._bitestAndDistRatio=c(this._bitSet,X);const F=_.rect.x+n,K=_.rect.y+n,B=F+_.width,I=K+_.height;this._texUpperLeft=c(F,K),this._texUpperRight=c(B,K),this._texBottomLeft=c(F,I),this._texBottomRight=c(B,I);const R=l.load(this._materialKey);R.sdf=_.sdf,R.pattern=!0,R.textureBinding=_.textureBinding,this._materialKey=R.data,this._anchorX=.5-(.5+O)*_.width/_.width,this._anchorY=.5-(.5+W)*_.height/_.height,x*=p,L*=p,x*=this._scaleFactor,L*=this._scaleFactor,x*=_.rect.width/_.width,L*=_.rect.height/_.height,this._computedWidth=x,this._computedHeight=L,this._applyTransformation(u,M),this.xOffset=P,this.yOffset=j}}export default k;\n"]},"metadata":{},"sourceType":"module"}