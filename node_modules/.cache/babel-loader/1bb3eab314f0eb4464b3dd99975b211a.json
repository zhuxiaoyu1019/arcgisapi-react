{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { smoothstep as t, clamp as i } from \"../../../../core/mathUtils.js\";\nimport { isSome as r } from \"../../../../core/maybe.js\";\nimport { t as e, a } from \"../../../../chunks/mat4.js\";\nimport { c as o } from \"../../../../chunks/mat4f64.js\";\nimport { a as s } from \"../../../../chunks/vec2f64.js\";\nimport { n as h, s as n, d as m, m as p } from \"../../../../chunks/vec3.js\";\nimport { c as l } from \"../../../../chunks/vec3f64.js\";\nimport { c } from \"../../../../chunks/vec4f64.js\";\nimport { ReloadableShaderModule as g } from \"../core/shaderTechnique/ReloadableShaderModule.js\";\nimport { ShaderTechnique as d } from \"../core/shaderTechnique/ShaderTechnique.js\";\nimport { Default3D as f } from \"../lib/DefaultVertexAttributeLocations.js\";\nimport { Program as u } from \"../lib/Program.js\";\nimport { inverseProjectionInfo as w } from \"../lib/Util.js\";\nimport { S as v } from \"../../../../chunks/ShadowHighlight.glsl.js\";\nimport { makePipelineState as T, separateBlendingParams as S, defaultColorWriteParams as x } from \"../../../webgl/renderState.js\";\nconst M = 4e4,\n      j = 5e4;\n\nclass b extends d {\n  constructor() {\n    super(...arguments), this.opacityElevation = 1, this.dayNightTerminator = 1, this.highlightShadowMapSlot = 0, this.defaultSnapshotSlot = 1;\n  }\n\n  initializeProgram(t) {\n    const i = b.shader.get();\n    this._viewingMode = t.viewingMode;\n    const r = i.build({\n      highlightedThreshold: .99999,\n      selfShadowThreshold: .025\n    });\n    return new u(t.rctx, r, f);\n  }\n\n  initializePipeline(t) {\n    return T({\n      blending: S(770, 1, 771, 771),\n      colorWrite: x,\n      depthTest: null,\n      depthWrite: null\n    });\n  }\n\n  bindPass(o, s) {\n    this.opacityElevation = 1 - t(M, j, s.camera.relativeElevation);\n    const l = 1 === this._viewingMode ? h(y, s.camera.center) : n(y, 0, 0, 1),\n          c = m(l, s.lighting.lightingMainDirection);\n    this.dayNightTerminator = t(0, 1, i(30 * c, 0, 1)), this.program.bindTexture(s.linearDepthTexture, \"depthMap\"), this.program.bindTexture(s.highlightColorTexture, \"highlightMap\"), p(U, s.lighting.lightingMainDirection, s.camera.viewInverseTransposeMatrix), h(U, U), w(s.camera.projectionMatrix, s.camera.fullWidth, s.camera.fullHeight, k, D), e(z, s.camera.viewMatrix, s.camera.center), a(z, z), this.program.setUniform4fv(\"color\", o.shadowColor), this.program.setUniform1f(\"opacity\", o.shadowOpacity), this.program.setUniform1f(\"occludedOpacity\", o.occludedShadowOpacity), this.program.setUniform1f(\"terminationFactor\", this.opacityElevation * this.dayNightTerminator), this.program.setUniform2fv(\"nearFar\", s.camera.nearFar), this.program.setUniformMatrix4fv(\"inverseView\", z), this.program.setUniform4fv(\"projInfo\", k), this.program.setUniform2fv(\"zScale\", D), this.program.setUniform3fv(\"lightingMainDirectionView\", U), this.program.setUniform2f(\"texelSize\", 1 / s.linearDepthTexture.descriptor.width, 1 / s.linearDepthTexture.descriptor.height), s.shadowMap.bind(this.program), s.shadowMap.bindView(this.program, s.camera.center);\n    let g = s.shadowMap.getSnapshot(this.highlightShadowMapSlot);\n    r(g) && this.program.bindTexture(g, \"highlightDepthTex\"), g = s.shadowMap.getSnapshot(this.defaultSnapshotSlot), r(g) && this.program.bindTexture(g, \"defaultDepthTex\");\n  }\n\n  get primitiveType() {\n    return 5;\n  }\n\n}\n\nb.shader = new g(v, () => import(\"./ShadowHighlight.glsl.js\"));\nconst y = l(),\n      U = l(),\n      D = s(),\n      k = c(),\n      z = o();\nexport { b as ShadowHighlightTechnique };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/webgl-engine/shaders/ShadowHighlightTechnique.js"],"names":["smoothstep","t","clamp","i","isSome","r","e","a","c","o","s","n","h","d","m","p","l","ReloadableShaderModule","g","ShaderTechnique","Default3D","f","Program","u","inverseProjectionInfo","w","S","v","makePipelineState","T","separateBlendingParams","defaultColorWriteParams","x","M","j","b","constructor","arguments","opacityElevation","dayNightTerminator","highlightShadowMapSlot","defaultSnapshotSlot","initializeProgram","shader","get","_viewingMode","viewingMode","build","highlightedThreshold","selfShadowThreshold","rctx","initializePipeline","blending","colorWrite","depthTest","depthWrite","bindPass","camera","relativeElevation","y","center","lighting","lightingMainDirection","program","bindTexture","linearDepthTexture","highlightColorTexture","U","viewInverseTransposeMatrix","projectionMatrix","fullWidth","fullHeight","k","D","z","viewMatrix","setUniform4fv","shadowColor","setUniform1f","shadowOpacity","occludedShadowOpacity","setUniform2fv","nearFar","setUniformMatrix4fv","setUniform3fv","setUniform2f","descriptor","width","height","shadowMap","bind","bindView","getSnapshot","primitiveType","ShadowHighlightTechnique"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{smoothstep as t,clamp as i}from\"../../../../core/mathUtils.js\";import{isSome as r}from\"../../../../core/maybe.js\";import{t as e,a}from\"../../../../chunks/mat4.js\";import{c as o}from\"../../../../chunks/mat4f64.js\";import{a as s}from\"../../../../chunks/vec2f64.js\";import{n as h,s as n,d as m,m as p}from\"../../../../chunks/vec3.js\";import{c as l}from\"../../../../chunks/vec3f64.js\";import{c}from\"../../../../chunks/vec4f64.js\";import{ReloadableShaderModule as g}from\"../core/shaderTechnique/ReloadableShaderModule.js\";import{ShaderTechnique as d}from\"../core/shaderTechnique/ShaderTechnique.js\";import{Default3D as f}from\"../lib/DefaultVertexAttributeLocations.js\";import{Program as u}from\"../lib/Program.js\";import{inverseProjectionInfo as w}from\"../lib/Util.js\";import{S as v}from\"../../../../chunks/ShadowHighlight.glsl.js\";import{makePipelineState as T,separateBlendingParams as S,defaultColorWriteParams as x}from\"../../../webgl/renderState.js\";const M=4e4,j=5e4;class b extends d{constructor(){super(...arguments),this.opacityElevation=1,this.dayNightTerminator=1,this.highlightShadowMapSlot=0,this.defaultSnapshotSlot=1}initializeProgram(t){const i=b.shader.get();this._viewingMode=t.viewingMode;const r=i.build({highlightedThreshold:.99999,selfShadowThreshold:.025});return new u(t.rctx,r,f)}initializePipeline(t){return T({blending:S(770,1,771,771),colorWrite:x,depthTest:null,depthWrite:null})}bindPass(o,s){this.opacityElevation=1-t(M,j,s.camera.relativeElevation);const l=1===this._viewingMode?h(y,s.camera.center):n(y,0,0,1),c=m(l,s.lighting.lightingMainDirection);this.dayNightTerminator=t(0,1,i(30*c,0,1)),this.program.bindTexture(s.linearDepthTexture,\"depthMap\"),this.program.bindTexture(s.highlightColorTexture,\"highlightMap\"),p(U,s.lighting.lightingMainDirection,s.camera.viewInverseTransposeMatrix),h(U,U),w(s.camera.projectionMatrix,s.camera.fullWidth,s.camera.fullHeight,k,D),e(z,s.camera.viewMatrix,s.camera.center),a(z,z),this.program.setUniform4fv(\"color\",o.shadowColor),this.program.setUniform1f(\"opacity\",o.shadowOpacity),this.program.setUniform1f(\"occludedOpacity\",o.occludedShadowOpacity),this.program.setUniform1f(\"terminationFactor\",this.opacityElevation*this.dayNightTerminator),this.program.setUniform2fv(\"nearFar\",s.camera.nearFar),this.program.setUniformMatrix4fv(\"inverseView\",z),this.program.setUniform4fv(\"projInfo\",k),this.program.setUniform2fv(\"zScale\",D),this.program.setUniform3fv(\"lightingMainDirectionView\",U),this.program.setUniform2f(\"texelSize\",1/s.linearDepthTexture.descriptor.width,1/s.linearDepthTexture.descriptor.height),s.shadowMap.bind(this.program),s.shadowMap.bindView(this.program,s.camera.center);let g=s.shadowMap.getSnapshot(this.highlightShadowMapSlot);r(g)&&this.program.bindTexture(g,\"highlightDepthTex\"),g=s.shadowMap.getSnapshot(this.defaultSnapshotSlot),r(g)&&this.program.bindTexture(g,\"defaultDepthTex\")}get primitiveType(){return 5}}b.shader=new g(v,(()=>import(\"./ShadowHighlight.glsl.js\")));const y=l(),U=l(),D=s(),k=c(),z=o();export{b as ShadowHighlightTechnique};\n"]},"metadata":{},"sourceType":"module"}