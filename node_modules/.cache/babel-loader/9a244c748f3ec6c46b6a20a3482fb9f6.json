{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../chunks/tslib.es6.js\";\nimport { forEach as t, result as i } from \"../../../core/asyncUtils.js\";\nimport r from \"../../../core/Logger.js\";\nimport { isSome as a, isNone as s } from \"../../../core/maybe.js\";\nimport { isAbortError as n, eachAlways as o, createAbortController as l, onAbort as h, isAborted as m, createAbortError as d, always as c, throwIfAborted as g } from \"../../../core/promiseUtils.js\";\nimport { whenOnce as u } from \"../../../core/watchUtils.js\";\nimport { property as p } from \"../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../core/has.js\";\nimport \"../../../core/accessorSupport/ensureType.js\";\nimport { subclass as y } from \"../../../core/accessorSupport/decorators/subclass.js\";\nimport f from \"../../../geometry/Extent.js\";\nimport { create as x, equals as w, width as _, height as v, set as R, intersection as b } from \"../../../geometry/support/aaBoundingRect.js\";\nimport { LayerView3D as S } from \"./LayerView3D.js\";\nimport { computeImageExportSize as E, createGeometryForExtent as j, createOuterImageGeometry as I } from \"./support/overlayImageUtils.js\";\nimport { toViewIfLocal as L } from \"./support/projectExtentUtils.js\";\nimport A from \"../support/debugFlags.js\";\nimport { RenderGeometry as C } from \"../webgl-engine/lib/RenderGeometry.js\";\nimport { Texture as D } from \"../webgl-engine/lib/Texture.js\";\nimport { ImageMaterial as M } from \"../webgl-engine/materials/ImageMaterial.js\";\nimport G from \"../../layers/LayerView.js\";\nimport { RefreshableLayerView as T } from \"../../layers/RefreshableLayerView.js\";\nconst H = r.getLogger(\"esri.views.3d.layers.DynamicLayerView3D\");\nlet O = class extends T(S(G)) {\n  constructor() {\n    super(...arguments), this.drapeSourceType = 0, this.updatePolicy = 1, this.fullExtentInLocalViewSpatialReference = null, this.maximumDataResolution = null, this._images = new Array(), this._extents = new Array(), this._overlayExtents = new Array(), this.updateWhenStationary = !0;\n  }\n\n  initialize() {\n    this.addResolvingPromise(L(this).then(e => this._set(\"fullExtentInLocalViewSpatialReference\", e))), this.updatingHandles.add(this, \"suspended\", () => this._suspendedChangeHandler()), this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks(() => {\n      this._isScaleRangeActive() && this.notifyChange(\"suspended\");\n    }, () => {})), this._isScaleRangeLayer() && this.updatingHandles.add(this.layer, \"scaleRangeId\", () => this.notifyChange(\"suspended\")), \"local\" === this.view.viewingMode && this.updatingHandles.add(this.view.basemapTerrain, \"extent\", () => this._overlayExtents.forEach((e, t) => this._updateImageExtent(t)));\n  }\n\n  destroy() {\n    this.clear();\n  }\n\n  setDrapingExtent(e, t) {\n    this._overlayExtents[e.index] = {\n      extent: x(e.extent),\n      spatialReference: t,\n      resolution: e.resolution,\n      renderLocalOrigin: e.renderLocalOrigin,\n      pixelRatio: e.pixelRatio\n    }, this._updateImageExtent(e.index);\n  }\n\n  _updateImageExtent(e) {\n    const t = this._overlayExtents[e],\n          i = this._clippedExtent(t.extent, P),\n          r = E(t.extent, i, t.resolution);\n\n    let a = t.pixelRatio * this.view.pixelRatio;\n\n    if (\"imageMaxWidth\" in this.layer || \"imageMaxHeight\" in this.layer) {\n      const e = this.layer.imageMaxWidth,\n            t = this.layer.imageMaxHeight;\n\n      if (r.width > e) {\n        const t = e / r.width;\n        r.height = Math.floor(r.height * t), r.width = e, a *= t;\n      }\n\n      if (r.height > t) {\n        const e = t / r.height;\n        r.width = Math.floor(r.width * e), r.height = t, a *= e;\n      }\n    }\n\n    const s = this._extents[e];\n    s && w(s.extent, i) && !this._imageSizeDiffers(i, s.imageSize, r) || (this._extents[e] = {\n      extent: x(i),\n      spatialReference: t.spatialReference,\n      imageSize: r,\n      pixelRatio: a\n    }, this.suspended || this._fetch(e).catch(e => {\n      n(e) || H.error(e);\n    }));\n  }\n\n  clear() {\n    for (let e = 0; e < this._images.length; e++) this._clearImage(e);\n  }\n\n  async doRefresh(e) {\n    if (this.suspended) return;\n    const t = [];\n\n    for (let i = 0; i < this._extents.length; i++) this._extents[i] && t.push(this._fetch(i, e));\n\n    await o(t);\n  }\n\n  canResume() {\n    if (!super.canResume()) return !1;\n\n    if (this._isScaleRangeLayer()) {\n      const {\n        minScale: e,\n        maxScale: t\n      } = this.layer;\n\n      if (e > 0 || t > 0) {\n        const i = this.view.scale;\n        if (i < t || e > 0 && i > e) return !1;\n      }\n    }\n\n    return !0;\n  }\n\n  isUpdating() {\n    return this._images.some(e => !!e.loadingPromise);\n  }\n\n  async processResult(e, t, i) {\n    (t instanceof HTMLImageElement || t instanceof HTMLCanvasElement) && (e.image = t);\n  }\n\n  findExtentInfoAt(e) {\n    for (const t of this._extents) {\n      const i = t.extent;\n      if (new f(i[0], i[1], i[2], i[3], t.spatialReference).contains(e)) return t;\n    }\n\n    return null;\n  }\n\n  getFetchOptions() {}\n\n  async redraw(e, i) {\n    await t(this._images, async (t, r) => {\n      t && (await e(t, i), await this._createStageObjects(r, t.image));\n    });\n  }\n\n  _imageSizeDiffers(e, t, i) {\n    if (!this.maximumDataResolution || A.TESTS_DISABLE_UPDATE_THRESHOLDS) return !0;\n    const r = _(e) / this.maximumDataResolution.x,\n          a = v(e) / this.maximumDataResolution.y,\n          s = r / t.width,\n          n = a / t.height,\n          o = r / i.width,\n          l = a / i.height,\n          h = Math.abs(s - o),\n          m = Math.abs(n - l);\n    return h > 1.5 || m > 1.5;\n  }\n\n  async _fetch(e, t) {\n    if (this.suspended) return;\n    const i = this._extents[e],\n          r = i.extent;\n    this._images[e] || (this._images[e] = {\n      texture: null,\n      material: null,\n      renderGeometry: null,\n      loadingPromise: null,\n      loadingAbortController: null,\n      image: null,\n      pixelData: null,\n      renderExtent: x(r)\n    });\n    const a = this._images[e];\n    a.loadingAbortController && (a.loadingAbortController.abort(), a.loadingAbortController = null);\n    const s = new f(r[0], r[1], r[2], r[3], i.spatialReference);\n    if (0 === s.width || 0 === s.height) return void this._clearImage(e);\n    const o = l();\n    a.loadingAbortController = o, h(t, () => o.abort());\n\n    const g = o.signal,\n          u = this._waitFetchReady(g).then(() => {\n      const t = {\n        requestAsImageElement: !0,\n        pixelRatio: this._overlayExtents[e].pixelRatio,\n        ...this.getFetchOptions(),\n        signal: g\n      },\n            {\n        height: r,\n        width: a\n      } = i.imageSize;\n      return t.timestamp = this.refreshTimestamp, this.layer.fetchImage(s, a, r, t);\n    }).then(e => {\n      if (m(g)) throw H.warnOnce(\"A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true.\"), d();\n      return this.processResult(a, e);\n    }).then(() => R(a.renderExtent, r));\n\n    a.loadingPromise = u, c(u, () => {\n      u === a.loadingPromise && (a.loadingPromise = null, a.loadingAbortController = null);\n    });\n    const p = u.then(async () => {\n      await this._createStageObjects(e, a.image), this.notifyChange(\"updating\");\n    }).catch(e => {\n      throw e && !n(e) && H.error(e), this.notifyChange(\"updating\"), e;\n    });\n    this.notifyChange(\"updating\"), await p;\n  }\n\n  _clearImage(e) {\n    const t = this._images[e];\n\n    if (t) {\n      a(t.renderGeometry) && (this.view.basemapTerrain.overlayManager.renderer.removeGeometries([t.renderGeometry], this, 2), t.renderGeometry = null);\n      const e = this.view._stage;\n      e.remove(t.texture), t.texture = null, e.remove(t.material), t.material = null, t.loadingAbortController && (t.loadingAbortController.abort(), t.loadingAbortController = null), t.loadingPromise = null, t.image = null, t.pixelData = null;\n    }\n  }\n\n  async _createStageObjects(e, t) {\n    const r = this.view._stage,\n          n = this._images[e],\n          o = this.view.basemapTerrain.overlayManager.renderer,\n          l = () => {\n      r.remove(n.texture), n.texture = null, a(n.renderGeometry) && (o.removeGeometries([n.renderGeometry], this, 2), n.renderGeometry = null);\n    };\n\n    if (t) {\n      const a = new D(t, {\n        width: t.width,\n        height: t.height,\n        preMultiplyAlpha: !0,\n        wrap: {\n          s: 33071,\n          t: 33071\n        }\n      });\n      let h;\n      if (await i(this._images[0 === e ? 1 : 0].loadingPromise), 0 === e) h = j(n.renderExtent);else {\n        const e = this._images[0].renderExtent;\n        if (!e) return void l();\n        h = I(e, n.renderExtent);\n      }\n      l(), r.add(a), n.texture = a, s(n.material) ? (n.material = new M({\n        transparent: !0,\n        textureId: a.id\n      }), r.add(n.material)) : n.material.setParameterValues({\n        textureId: a.id\n      }), n.renderGeometry = new C(h, n.material), n.renderGeometry.origin = this._overlayExtents[e].renderLocalOrigin, o.addGeometries([n.renderGeometry], this, 2);\n    } else l(), r.remove(n.material), n.material = null;\n  }\n\n  _isScaleRangeLayer() {\n    return \"minScale\" in this.layer && \"maxScale\" in this.layer;\n  }\n\n  _isScaleRangeActive() {\n    return !!this._isScaleRangeLayer() && (this.layer.minScale > 0 || this.layer.maxScale > 0);\n  }\n\n  _clippedExtent(e, t) {\n    if (\"local\" !== this.view.viewingMode) return R(t, e);\n    const i = this.view.basemapTerrain,\n          r = i.extent;\n    return i.ready && r ? b(e, r, t) : R(t, e);\n  }\n\n  _suspendedChangeHandler() {\n    this.suspended ? this.clear() : this.refresh();\n  }\n\n  async _waitFetchReady(e) {\n    await u(this.view, \"stationary\", e), g(e);\n  }\n\n};\ne([p()], O.prototype, \"layer\", void 0), e([p()], O.prototype, \"suspended\", void 0), e([p({\n  readOnly: !0\n})], O.prototype, \"fullExtentInLocalViewSpatialReference\", void 0), e([p()], O.prototype, \"updating\", void 0), O = e([y(\"esri.views.3d.layers.DynamicLayerView3D\")], O);\nconst P = x();\nvar V = O;\nexport default V;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/layers/DynamicLayerView3D.js"],"names":["_","e","forEach","t","result","i","r","isSome","a","isNone","s","isAbortError","n","eachAlways","o","createAbortController","l","onAbort","h","isAborted","m","createAbortError","d","always","c","throwIfAborted","g","whenOnce","u","property","p","subclass","y","f","create","x","equals","w","width","height","v","set","R","intersection","b","LayerView3D","S","computeImageExportSize","E","createGeometryForExtent","j","createOuterImageGeometry","I","toViewIfLocal","L","A","RenderGeometry","C","Texture","D","ImageMaterial","M","G","RefreshableLayerView","T","H","getLogger","O","constructor","arguments","drapeSourceType","updatePolicy","fullExtentInLocalViewSpatialReference","maximumDataResolution","_images","Array","_extents","_overlayExtents","updateWhenStationary","initialize","addResolvingPromise","then","_set","updatingHandles","add","_suspendedChangeHandler","handles","view","resourceController","scheduler","registerIdleStateCallbacks","_isScaleRangeActive","notifyChange","_isScaleRangeLayer","layer","viewingMode","basemapTerrain","_updateImageExtent","destroy","clear","setDrapingExtent","index","extent","spatialReference","resolution","renderLocalOrigin","pixelRatio","_clippedExtent","P","imageMaxWidth","imageMaxHeight","Math","floor","_imageSizeDiffers","imageSize","suspended","_fetch","catch","error","length","_clearImage","doRefresh","push","canResume","minScale","maxScale","scale","isUpdating","some","loadingPromise","processResult","HTMLImageElement","HTMLCanvasElement","image","findExtentInfoAt","contains","getFetchOptions","redraw","_createStageObjects","TESTS_DISABLE_UPDATE_THRESHOLDS","abs","texture","material","renderGeometry","loadingAbortController","pixelData","renderExtent","abort","signal","_waitFetchReady","requestAsImageElement","timestamp","refreshTimestamp","fetchImage","warnOnce","overlayManager","renderer","removeGeometries","_stage","remove","preMultiplyAlpha","wrap","transparent","textureId","id","setParameterValues","origin","addGeometries","ready","refresh","prototype","readOnly","V"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import{forEach as t,result as i}from\"../../../core/asyncUtils.js\";import r from\"../../../core/Logger.js\";import{isSome as a,isNone as s}from\"../../../core/maybe.js\";import{isAbortError as n,eachAlways as o,createAbortController as l,onAbort as h,isAborted as m,createAbortError as d,always as c,throwIfAborted as g}from\"../../../core/promiseUtils.js\";import{whenOnce as u}from\"../../../core/watchUtils.js\";import{property as p}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import{subclass as y}from\"../../../core/accessorSupport/decorators/subclass.js\";import f from\"../../../geometry/Extent.js\";import{create as x,equals as w,width as _,height as v,set as R,intersection as b}from\"../../../geometry/support/aaBoundingRect.js\";import{LayerView3D as S}from\"./LayerView3D.js\";import{computeImageExportSize as E,createGeometryForExtent as j,createOuterImageGeometry as I}from\"./support/overlayImageUtils.js\";import{toViewIfLocal as L}from\"./support/projectExtentUtils.js\";import A from\"../support/debugFlags.js\";import{RenderGeometry as C}from\"../webgl-engine/lib/RenderGeometry.js\";import{Texture as D}from\"../webgl-engine/lib/Texture.js\";import{ImageMaterial as M}from\"../webgl-engine/materials/ImageMaterial.js\";import G from\"../../layers/LayerView.js\";import{RefreshableLayerView as T}from\"../../layers/RefreshableLayerView.js\";const H=r.getLogger(\"esri.views.3d.layers.DynamicLayerView3D\");let O=class extends(T(S(G))){constructor(){super(...arguments),this.drapeSourceType=0,this.updatePolicy=1,this.fullExtentInLocalViewSpatialReference=null,this.maximumDataResolution=null,this._images=new Array,this._extents=new Array,this._overlayExtents=new Array,this.updateWhenStationary=!0}initialize(){this.addResolvingPromise(L(this).then((e=>this._set(\"fullExtentInLocalViewSpatialReference\",e)))),this.updatingHandles.add(this,\"suspended\",(()=>this._suspendedChangeHandler())),this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks((()=>{this._isScaleRangeActive()&&this.notifyChange(\"suspended\")}),(()=>{}))),this._isScaleRangeLayer()&&this.updatingHandles.add(this.layer,\"scaleRangeId\",(()=>this.notifyChange(\"suspended\"))),\"local\"===this.view.viewingMode&&this.updatingHandles.add(this.view.basemapTerrain,\"extent\",(()=>this._overlayExtents.forEach(((e,t)=>this._updateImageExtent(t)))))}destroy(){this.clear()}setDrapingExtent(e,t){this._overlayExtents[e.index]={extent:x(e.extent),spatialReference:t,resolution:e.resolution,renderLocalOrigin:e.renderLocalOrigin,pixelRatio:e.pixelRatio},this._updateImageExtent(e.index)}_updateImageExtent(e){const t=this._overlayExtents[e],i=this._clippedExtent(t.extent,P),r=E(t.extent,i,t.resolution);let a=t.pixelRatio*this.view.pixelRatio;if(\"imageMaxWidth\"in this.layer||\"imageMaxHeight\"in this.layer){const e=this.layer.imageMaxWidth,t=this.layer.imageMaxHeight;if(r.width>e){const t=e/r.width;r.height=Math.floor(r.height*t),r.width=e,a*=t}if(r.height>t){const e=t/r.height;r.width=Math.floor(r.width*e),r.height=t,a*=e}}const s=this._extents[e];s&&w(s.extent,i)&&!this._imageSizeDiffers(i,s.imageSize,r)||(this._extents[e]={extent:x(i),spatialReference:t.spatialReference,imageSize:r,pixelRatio:a},this.suspended||this._fetch(e).catch((e=>{n(e)||H.error(e)})))}clear(){for(let e=0;e<this._images.length;e++)this._clearImage(e)}async doRefresh(e){if(this.suspended)return;const t=[];for(let i=0;i<this._extents.length;i++)this._extents[i]&&t.push(this._fetch(i,e));await o(t)}canResume(){if(!super.canResume())return!1;if(this._isScaleRangeLayer()){const{minScale:e,maxScale:t}=this.layer;if(e>0||t>0){const i=this.view.scale;if(i<t||e>0&&i>e)return!1}}return!0}isUpdating(){return this._images.some((e=>!!e.loadingPromise))}async processResult(e,t,i){(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement)&&(e.image=t)}findExtentInfoAt(e){for(const t of this._extents){const i=t.extent;if(new f(i[0],i[1],i[2],i[3],t.spatialReference).contains(e))return t}return null}getFetchOptions(){}async redraw(e,i){await t(this._images,(async(t,r)=>{t&&(await e(t,i),await this._createStageObjects(r,t.image))}))}_imageSizeDiffers(e,t,i){if(!this.maximumDataResolution||A.TESTS_DISABLE_UPDATE_THRESHOLDS)return!0;const r=_(e)/this.maximumDataResolution.x,a=v(e)/this.maximumDataResolution.y,s=r/t.width,n=a/t.height,o=r/i.width,l=a/i.height,h=Math.abs(s-o),m=Math.abs(n-l);return h>1.5||m>1.5}async _fetch(e,t){if(this.suspended)return;const i=this._extents[e],r=i.extent;this._images[e]||(this._images[e]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:x(r)});const a=this._images[e];a.loadingAbortController&&(a.loadingAbortController.abort(),a.loadingAbortController=null);const s=new f(r[0],r[1],r[2],r[3],i.spatialReference);if(0===s.width||0===s.height)return void this._clearImage(e);const o=l();a.loadingAbortController=o,h(t,(()=>o.abort()));const g=o.signal,u=this._waitFetchReady(g).then((()=>{const t={requestAsImageElement:!0,pixelRatio:this._overlayExtents[e].pixelRatio,...this.getFetchOptions(),signal:g},{height:r,width:a}=i.imageSize;return t.timestamp=this.refreshTimestamp,this.layer.fetchImage(s,a,r,t)})).then((e=>{if(m(g))throw H.warnOnce(\"A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true.\"),d();return this.processResult(a,e)})).then((()=>R(a.renderExtent,r)));a.loadingPromise=u,c(u,(()=>{u===a.loadingPromise&&(a.loadingPromise=null,a.loadingAbortController=null)}));const p=u.then((async()=>{await this._createStageObjects(e,a.image),this.notifyChange(\"updating\")})).catch((e=>{throw e&&!n(e)&&H.error(e),this.notifyChange(\"updating\"),e}));this.notifyChange(\"updating\"),await p}_clearImage(e){const t=this._images[e];if(t){a(t.renderGeometry)&&(this.view.basemapTerrain.overlayManager.renderer.removeGeometries([t.renderGeometry],this,2),t.renderGeometry=null);const e=this.view._stage;e.remove(t.texture),t.texture=null,e.remove(t.material),t.material=null,t.loadingAbortController&&(t.loadingAbortController.abort(),t.loadingAbortController=null),t.loadingPromise=null,t.image=null,t.pixelData=null}}async _createStageObjects(e,t){const r=this.view._stage,n=this._images[e],o=this.view.basemapTerrain.overlayManager.renderer,l=()=>{r.remove(n.texture),n.texture=null,a(n.renderGeometry)&&(o.removeGeometries([n.renderGeometry],this,2),n.renderGeometry=null)};if(t){const a=new D(t,{width:t.width,height:t.height,preMultiplyAlpha:!0,wrap:{s:33071,t:33071}});let h;if(await i(this._images[0===e?1:0].loadingPromise),0===e)h=j(n.renderExtent);else{const e=this._images[0].renderExtent;if(!e)return void l();h=I(e,n.renderExtent)}l(),r.add(a),n.texture=a,s(n.material)?(n.material=new M({transparent:!0,textureId:a.id}),r.add(n.material)):n.material.setParameterValues({textureId:a.id}),n.renderGeometry=new C(h,n.material),n.renderGeometry.origin=this._overlayExtents[e].renderLocalOrigin,o.addGeometries([n.renderGeometry],this,2)}else l(),r.remove(n.material),n.material=null}_isScaleRangeLayer(){return\"minScale\"in this.layer&&\"maxScale\"in this.layer}_isScaleRangeActive(){return!!this._isScaleRangeLayer()&&(this.layer.minScale>0||this.layer.maxScale>0)}_clippedExtent(e,t){if(\"local\"!==this.view.viewingMode)return R(t,e);const i=this.view.basemapTerrain,r=i.extent;return i.ready&&r?b(e,r,t):R(t,e)}_suspendedChangeHandler(){this.suspended?this.clear():this.refresh()}async _waitFetchReady(e){await u(this.view,\"stationary\",e),g(e)}};e([p()],O.prototype,\"layer\",void 0),e([p()],O.prototype,\"suspended\",void 0),e([p({readOnly:!0})],O.prototype,\"fullExtentInLocalViewSpatialReference\",void 0),e([p()],O.prototype,\"updating\",void 0),O=e([y(\"esri.views.3d.layers.DynamicLayerView3D\")],O);const P=x();var V=O;export default V;\n"]},"metadata":{},"sourceType":"module"}