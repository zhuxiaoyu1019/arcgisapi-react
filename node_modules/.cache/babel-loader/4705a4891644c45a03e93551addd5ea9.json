{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { id as t } from \"../../kernel.js\";\nimport r from \"../../request.js\";\nimport { isNone as e, isSome as a } from \"../../core/maybe.js\";\nimport { throwIfAbortError as i } from \"../../core/promiseUtils.js\";\nimport s from \"../FeatureLayer.js\";\nimport n from \"../../portal/Portal.js\";\nimport o from \"../../portal/PortalItem.js\";\n\nclass l {\n  constructor(t, r, e, a) {\n    this.parsedUrl = t, this.portalItem = r, this.apiKey = e, this.signal = a, this.rootDocument = null;\n    const i = this.parsedUrl.path.match(/^(.*)\\/SceneServer\\/layers\\/([\\d]*)\\/?$/i);\n    i && (this.urlParts = {\n      root: i[1],\n      layerId: parseInt(i[2], 10)\n    });\n  }\n\n  async fetch() {\n    var t;\n    if (!this.urlParts) return null;\n    const r = null != (t = this.portalItem) ? t : await this.portalItemFromServiceItemId();\n    if (e(r)) return this.loadFromUrl();\n    const a = await this.findAndLoadRelatedPortalItem(r);\n    return e(a) ? null : this.loadFeatureLayerFromPortalItem(a);\n  }\n\n  async fetchPortalItem() {\n    var t;\n    if (!this.urlParts) return null;\n    const r = null != (t = this.portalItem) ? t : await this.portalItemFromServiceItemId();\n    return e(r) ? null : this.findAndLoadRelatedPortalItem(r);\n  }\n\n  async fetchRootDocument() {\n    if (a(this.rootDocument)) return this.rootDocument;\n    if (e(this.urlParts)) return this.rootDocument = {}, {};\n    const t = {\n      query: {\n        f: \"json\",\n        token: this.apiKey\n      },\n      responseType: \"json\",\n      signal: this.signal\n    },\n          i = `${this.urlParts.root}/SceneServer`;\n\n    try {\n      const e = await r(i, t);\n      this.rootDocument = e.data;\n    } catch {\n      this.rootDocument = {};\n    }\n\n    return this.rootDocument;\n  }\n\n  async fetchServiceOwningPortalUrl() {\n    var e;\n    const a = null == (e = t) ? void 0 : e.findServerInfo(this.parsedUrl.path);\n    if (null != a && a.owningSystemUrl) return a.owningSystemUrl;\n    const s = this.parsedUrl.path.replace(/(.*\\/rest)\\/.*/i, \"$1\") + \"/info\";\n\n    try {\n      const t = (await r(s, {\n        query: {\n          f: \"json\"\n        },\n        responseType: \"json\",\n        signal: this.signal\n      })).data.owningSystemUrl;\n      if (t) return t;\n    } catch (n) {\n      i(n);\n    }\n\n    return null;\n  }\n\n  async findAndLoadRelatedPortalItem(t) {\n    try {\n      return (await t.fetchRelatedItems({\n        relationshipType: \"Service2Service\",\n        direction: \"reverse\"\n      }, {\n        signal: this.signal\n      })).find(t => \"Feature Service\" === t.type) || null;\n    } catch (r) {\n      return i(r), null;\n    }\n  }\n\n  async loadFeatureLayerFromPortalItem(t) {\n    await t.load({\n      signal: this.signal\n    });\n    const r = await this.findMatchingAssociatedSublayerUrl(t.url);\n    return new s({\n      url: r,\n      portalItem: t\n    }).load({\n      signal: this.signal\n    });\n  }\n\n  async loadFromUrl() {\n    const t = await this.findMatchingAssociatedSublayerUrl(`${this.urlParts.root}/FeatureServer`);\n    return new s({\n      url: t\n    }).load({\n      signal: this.signal\n    });\n  }\n\n  async findMatchingAssociatedSublayerUrl(t) {\n    const e = t.replace(/^(.*FeatureServer)(\\/[\\d]*\\/?)?$/i, \"$1\"),\n          a = {\n      query: {\n        f: \"json\"\n      },\n      responseType: \"json\",\n      authMode: \"no-prompt\",\n      signal: this.signal\n    },\n          i = this.urlParts.layerId,\n          s = this.fetchRootDocument(),\n          n = r(e, a),\n          [o, l] = await Promise.all([n, s]),\n          c = l && l.layers,\n          h = o.data && o.data.layers;\n    if (!Array.isArray(h)) throw new Error(\"expected layers array\");\n    if (Array.isArray(c)) for (let r = 0; r < Math.min(c.length, h.length); r++) {\n      if (c[r].id === i) return `${e}/${h[r].id}`;\n    } else if (i < h.length) return `${e}/${h[i].id}`;\n    throw new Error(\"could not find matching associated sublayer\");\n  }\n\n  async portalItemFromServiceItemId() {\n    const t = (await this.fetchRootDocument()).serviceItemId;\n    if (!t) return null;\n    const r = new o({\n      id: t,\n      apiKey: this.apiKey\n    }),\n          e = await this.fetchServiceOwningPortalUrl();\n    a(e) && (r.portal = new n({\n      url: e\n    }));\n\n    try {\n      return r.load({\n        signal: this.signal\n      });\n    } catch (s) {\n      return i(s), null;\n    }\n  }\n\n}\n\nexport { l as FetchAssociatedFeatureLayer };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/layers/support/FetchAssociatedFeatureLayer.js"],"names":["id","t","r","isNone","e","isSome","a","throwIfAbortError","i","s","n","o","l","constructor","parsedUrl","portalItem","apiKey","signal","rootDocument","path","match","urlParts","root","layerId","parseInt","fetch","portalItemFromServiceItemId","loadFromUrl","findAndLoadRelatedPortalItem","loadFeatureLayerFromPortalItem","fetchPortalItem","fetchRootDocument","query","f","token","responseType","data","fetchServiceOwningPortalUrl","findServerInfo","owningSystemUrl","replace","fetchRelatedItems","relationshipType","direction","find","type","load","findMatchingAssociatedSublayerUrl","url","authMode","Promise","all","c","layers","h","Array","isArray","Error","Math","min","length","serviceItemId","portal","FetchAssociatedFeatureLayer"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{id as t}from\"../../kernel.js\";import r from\"../../request.js\";import{isNone as e,isSome as a}from\"../../core/maybe.js\";import{throwIfAbortError as i}from\"../../core/promiseUtils.js\";import s from\"../FeatureLayer.js\";import n from\"../../portal/Portal.js\";import o from\"../../portal/PortalItem.js\";class l{constructor(t,r,e,a){this.parsedUrl=t,this.portalItem=r,this.apiKey=e,this.signal=a,this.rootDocument=null;const i=this.parsedUrl.path.match(/^(.*)\\/SceneServer\\/layers\\/([\\d]*)\\/?$/i);i&&(this.urlParts={root:i[1],layerId:parseInt(i[2],10)})}async fetch(){var t;if(!this.urlParts)return null;const r=null!=(t=this.portalItem)?t:await this.portalItemFromServiceItemId();if(e(r))return this.loadFromUrl();const a=await this.findAndLoadRelatedPortalItem(r);return e(a)?null:this.loadFeatureLayerFromPortalItem(a)}async fetchPortalItem(){var t;if(!this.urlParts)return null;const r=null!=(t=this.portalItem)?t:await this.portalItemFromServiceItemId();return e(r)?null:this.findAndLoadRelatedPortalItem(r)}async fetchRootDocument(){if(a(this.rootDocument))return this.rootDocument;if(e(this.urlParts))return this.rootDocument={},{};const t={query:{f:\"json\",token:this.apiKey},responseType:\"json\",signal:this.signal},i=`${this.urlParts.root}/SceneServer`;try{const e=await r(i,t);this.rootDocument=e.data}catch{this.rootDocument={}}return this.rootDocument}async fetchServiceOwningPortalUrl(){var e;const a=null==(e=t)?void 0:e.findServerInfo(this.parsedUrl.path);if(null!=a&&a.owningSystemUrl)return a.owningSystemUrl;const s=this.parsedUrl.path.replace(/(.*\\/rest)\\/.*/i,\"$1\")+\"/info\";try{const t=(await r(s,{query:{f:\"json\"},responseType:\"json\",signal:this.signal})).data.owningSystemUrl;if(t)return t}catch(n){i(n)}return null}async findAndLoadRelatedPortalItem(t){try{return(await t.fetchRelatedItems({relationshipType:\"Service2Service\",direction:\"reverse\"},{signal:this.signal})).find((t=>\"Feature Service\"===t.type))||null}catch(r){return i(r),null}}async loadFeatureLayerFromPortalItem(t){await t.load({signal:this.signal});const r=await this.findMatchingAssociatedSublayerUrl(t.url);return new s({url:r,portalItem:t}).load({signal:this.signal})}async loadFromUrl(){const t=await this.findMatchingAssociatedSublayerUrl(`${this.urlParts.root}/FeatureServer`);return new s({url:t}).load({signal:this.signal})}async findMatchingAssociatedSublayerUrl(t){const e=t.replace(/^(.*FeatureServer)(\\/[\\d]*\\/?)?$/i,\"$1\"),a={query:{f:\"json\"},responseType:\"json\",authMode:\"no-prompt\",signal:this.signal},i=this.urlParts.layerId,s=this.fetchRootDocument(),n=r(e,a),[o,l]=await Promise.all([n,s]),c=l&&l.layers,h=o.data&&o.data.layers;if(!Array.isArray(h))throw new Error(\"expected layers array\");if(Array.isArray(c))for(let r=0;r<Math.min(c.length,h.length);r++){if(c[r].id===i)return`${e}/${h[r].id}`}else if(i<h.length)return`${e}/${h[i].id}`;throw new Error(\"could not find matching associated sublayer\")}async portalItemFromServiceItemId(){const t=(await this.fetchRootDocument()).serviceItemId;if(!t)return null;const r=new o({id:t,apiKey:this.apiKey}),e=await this.fetchServiceOwningPortalUrl();a(e)&&(r.portal=new n({url:e}));try{return r.load({signal:this.signal})}catch(s){return i(s),null}}}export{l as FetchAssociatedFeatureLayer};\n"]},"metadata":{},"sourceType":"module"}