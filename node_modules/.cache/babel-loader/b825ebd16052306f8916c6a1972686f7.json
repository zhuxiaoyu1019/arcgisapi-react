{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../webgl/FramebufferObject.js\";\nimport t from \"../../../webgl/Renderbuffer.js\";\nimport r from \"../../../webgl/Texture.js\";\nimport { getGpuMemoryUsage as i } from \"../../../webgl/Util.js\";\nconst s = {\n  dataType: 5121,\n  internalFormat: 6408\n},\n      h = {};\n\nclass d {\n  constructor(e) {\n    this.rctx = e, this._activeTargets = new Set(), this._depthTextures = new Map(), this._depthBuffers = new Map(), this._colorTextures = new Map(), this._framebuffers = new Map(), this._nextId = 1, this.depthTextureSupported = e.capabilities.depthTexture;\n  }\n\n  dispose() {\n    this._depthBuffers.forEach(e => e.dispose()), this._depthBuffers.clear(), this._depthTextures.forEach(e => e.dispose()), this._depthTextures.clear(), this._colorTextures.forEach(e => e.dispose()), this._colorTextures.clear(), this._framebuffers.forEach(e => e.dispose()), this._framebuffers.clear();\n  }\n\n  disposeTargetResource(e) {\n    const t = e.id;\n    this._activeTargets.has(t) && (this._activeTargets.delete(t), this.disposeWithFramebuffers(this._depthTextures, t), this.disposeWithFramebuffers(this._depthBuffers, t), this.disposeWithFramebuffers(this._colorTextures, t));\n  }\n\n  disposeWithFramebuffers(e, t) {\n    const r = e.get(t);\n    r && (this._framebuffers.forEach((e, t) => {\n      e.colorAttachment !== r && e.depthStencilAttachment !== r || (e.detachAll(), e.dispose(), this._framebuffers.delete(t));\n    }), r.dispose(), e.delete(t));\n  }\n\n  getDepthTexture(e, t) {\n    if (!this.depthTextureSupported) return;\n\n    let i = this._depthTextures.get(e.id);\n\n    return i && (i.descriptor.width === t.width && i.descriptor.height === t.height || (i.dispose(), i = void 0)), i || (i = new r(this.rctx, {\n      target: 3553,\n      pixelFormat: 34041,\n      dataType: 34042,\n      samplingMode: 9728,\n      wrapMode: 33071,\n      width: t.width,\n      height: t.height\n    }), this._depthTextures.set(e.id, i), this._activeTargets.add(e.id)), i;\n  }\n\n  getAllocatedDepthTexture(e) {\n    return this._depthTextures.get(e.id);\n  }\n\n  getDepthBuffer(e, r) {\n    if (this.depthTextureSupported) return;\n\n    let i = this._depthBuffers.get(e.id);\n\n    return i ? i.descriptor.width === r.width && i.descriptor.height === r.height || i.resize(r.width, r.height) : (i = new t(this.rctx, {\n      internalFormat: 34041,\n      ...r\n    }), this._depthBuffers.set(e.id, i), this._activeTargets.add(e.id)), i;\n  }\n\n  getColorTexture(e, t) {\n    let i = this._colorTextures.get(e.id);\n\n    return i && (i.descriptor.width === t.width && i.descriptor.height === t.height || (i.dispose(), i = void 0)), i || (i = new r(this.rctx, {\n      target: 3553,\n      pixelFormat: 6408,\n      internalFormat: e.internalFormat,\n      dataType: e.dataType,\n      samplingMode: null != e.samplingMode ? e.samplingMode : 9729,\n      wrapMode: 33071,\n      width: t.width,\n      height: t.height\n    }), this._colorTextures.set(e.id, i), this._activeTargets.add(e.id)), i;\n  }\n\n  getAllocatedColorTexture(e) {\n    return this._colorTextures.get(e.id);\n  }\n\n  registerDepthTarget(e = {}) {\n    return {\n      id: this._nextId++,\n      ...h,\n      ...e\n    };\n  }\n\n  registerColorTarget(e = {}) {\n    return {\n      id: this._nextId++,\n      ...s,\n      ...e\n    };\n  }\n\n  getFramebuffer(t, r, i) {\n    const s = this.getKey(r, i);\n\n    let h = this._framebuffers.get(s);\n\n    const d = this.getColorTexture(r, t);\n\n    if (this.depthTextureSupported) {\n      const r = i ? this.getDepthTexture(i, t) : void 0;\n      if (!h) return h = i ? new e(this.rctx, {\n        colorTarget: 0,\n        depthStencilTarget: 4\n      }, d, r) : new e(this.rctx, {\n        colorTarget: 0,\n        depthStencilTarget: 0\n      }, d), this._framebuffers.set(s, h), h;\n      return (h.width !== t.width || h.height !== t.height || h.colorTexture !== d || h.depthStencilTexture !== r) && (h.detachAll(), h.resize(t.width, t.height), h.attachColorTexture(d), h.attachDepthStencilTexture(r)), h;\n    }\n\n    const o = i ? this.getDepthBuffer(i, t) : void 0;\n    if (!h) return h = new e(this.rctx, {\n      colorTarget: 0,\n      depthStencilTarget: i ? 3 : 0\n    }, d, o), this._framebuffers.set(s, h), h;\n    return (h.width !== t.width || h.height !== t.height || h.colorTexture !== d) && (h.detachAll(), h.resize(t.width, t.height), h.attachColorTexture(d), h.attachDepthStencilBuffer(o)), h;\n  }\n\n  getKey(e, t) {\n    return `${e.id}_${t ? t.id : \"X\"}_${e.name}${t ? \"_\" + t.name : \"\"}`;\n  }\n\n  getGpuMemoryUsage() {\n    let e = 0;\n\n    const t = new Set(),\n          r = r => {\n      t.has(r) || (t.add(r), e += i(r));\n    };\n\n    return this._depthTextures.forEach(r), this._colorTextures.forEach(r), this._depthBuffers.forEach(r), e;\n  }\n\n}\n\nexport { d as RenderTargetHelper };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/webgl-engine/lib/RenderTargetHelper.js"],"names":["e","t","r","getGpuMemoryUsage","i","s","dataType","internalFormat","h","d","constructor","rctx","_activeTargets","Set","_depthTextures","Map","_depthBuffers","_colorTextures","_framebuffers","_nextId","depthTextureSupported","capabilities","depthTexture","dispose","forEach","clear","disposeTargetResource","id","has","delete","disposeWithFramebuffers","get","colorAttachment","depthStencilAttachment","detachAll","getDepthTexture","descriptor","width","height","target","pixelFormat","samplingMode","wrapMode","set","add","getAllocatedDepthTexture","getDepthBuffer","resize","getColorTexture","getAllocatedColorTexture","registerDepthTarget","registerColorTarget","getFramebuffer","getKey","colorTarget","depthStencilTarget","colorTexture","depthStencilTexture","attachColorTexture","attachDepthStencilTexture","o","attachDepthStencilBuffer","name","RenderTargetHelper"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../webgl/FramebufferObject.js\";import t from\"../../../webgl/Renderbuffer.js\";import r from\"../../../webgl/Texture.js\";import{getGpuMemoryUsage as i}from\"../../../webgl/Util.js\";const s={dataType:5121,internalFormat:6408},h={};class d{constructor(e){this.rctx=e,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this._nextId=1,this.depthTextureSupported=e.capabilities.depthTexture}dispose(){this._depthBuffers.forEach((e=>e.dispose())),this._depthBuffers.clear(),this._depthTextures.forEach((e=>e.dispose())),this._depthTextures.clear(),this._colorTextures.forEach((e=>e.dispose())),this._colorTextures.clear(),this._framebuffers.forEach((e=>e.dispose())),this._framebuffers.clear()}disposeTargetResource(e){const t=e.id;this._activeTargets.has(t)&&(this._activeTargets.delete(t),this.disposeWithFramebuffers(this._depthTextures,t),this.disposeWithFramebuffers(this._depthBuffers,t),this.disposeWithFramebuffers(this._colorTextures,t))}disposeWithFramebuffers(e,t){const r=e.get(t);r&&(this._framebuffers.forEach(((e,t)=>{e.colorAttachment!==r&&e.depthStencilAttachment!==r||(e.detachAll(),e.dispose(),this._framebuffers.delete(t))})),r.dispose(),e.delete(t))}getDepthTexture(e,t){if(!this.depthTextureSupported)return;let i=this._depthTextures.get(e.id);return i&&(i.descriptor.width===t.width&&i.descriptor.height===t.height||(i.dispose(),i=void 0)),i||(i=new r(this.rctx,{target:3553,pixelFormat:34041,dataType:34042,samplingMode:9728,wrapMode:33071,width:t.width,height:t.height}),this._depthTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedDepthTexture(e){return this._depthTextures.get(e.id)}getDepthBuffer(e,r){if(this.depthTextureSupported)return;let i=this._depthBuffers.get(e.id);return i?i.descriptor.width===r.width&&i.descriptor.height===r.height||i.resize(r.width,r.height):(i=new t(this.rctx,{internalFormat:34041,...r}),this._depthBuffers.set(e.id,i),this._activeTargets.add(e.id)),i}getColorTexture(e,t){let i=this._colorTextures.get(e.id);return i&&(i.descriptor.width===t.width&&i.descriptor.height===t.height||(i.dispose(),i=void 0)),i||(i=new r(this.rctx,{target:3553,pixelFormat:6408,internalFormat:e.internalFormat,dataType:e.dataType,samplingMode:null!=e.samplingMode?e.samplingMode:9729,wrapMode:33071,width:t.width,height:t.height}),this._colorTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedColorTexture(e){return this._colorTextures.get(e.id)}registerDepthTarget(e={}){return{id:this._nextId++,...h,...e}}registerColorTarget(e={}){return{id:this._nextId++,...s,...e}}getFramebuffer(t,r,i){const s=this.getKey(r,i);let h=this._framebuffers.get(s);const d=this.getColorTexture(r,t);if(this.depthTextureSupported){const r=i?this.getDepthTexture(i,t):void 0;if(!h)return h=i?new e(this.rctx,{colorTarget:0,depthStencilTarget:4},d,r):new e(this.rctx,{colorTarget:0,depthStencilTarget:0},d),this._framebuffers.set(s,h),h;return(h.width!==t.width||h.height!==t.height||h.colorTexture!==d||h.depthStencilTexture!==r)&&(h.detachAll(),h.resize(t.width,t.height),h.attachColorTexture(d),h.attachDepthStencilTexture(r)),h}const o=i?this.getDepthBuffer(i,t):void 0;if(!h)return h=new e(this.rctx,{colorTarget:0,depthStencilTarget:i?3:0},d,o),this._framebuffers.set(s,h),h;return(h.width!==t.width||h.height!==t.height||h.colorTexture!==d)&&(h.detachAll(),h.resize(t.width,t.height),h.attachColorTexture(d),h.attachDepthStencilBuffer(o)),h}getKey(e,t){return`${e.id}_${t?t.id:\"X\"}_${e.name}${t?\"_\"+t.name:\"\"}`}getGpuMemoryUsage(){let e=0;const t=new Set,r=r=>{t.has(r)||(t.add(r),e+=i(r))};return this._depthTextures.forEach(r),this._colorTextures.forEach(r),this._depthBuffers.forEach(r),e}}export{d as RenderTargetHelper};\n"]},"metadata":{},"sourceType":"module"}