{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../core/Logger.js\";\nimport { eachAlways as r } from \"../../../core/promiseUtils.js\";\nimport t from \"../../../layers/FeatureLayer.js\";\nimport { applyTextFormattingHTML as a, htmlEntities as s } from \"./featureUtils.js\";\nconst i = [\"$datastore\", \"$map\", \"$layer\", \"$aggregatedfeatures\"],\n      o = \"esri.widgets.Feature.support.arcadeFeatureUtils\",\n      n = e.getLogger(o);\n\nfunction c(e) {\n  return `<ul class=\"esri-widget__list\">${e.map(e => `<li>${\"string\" == typeof e ? a(s(e)) : e}</li>`).join(\"\")}</ul>`;\n}\n\nfunction p(e) {\n  return `<table class=\"esri-widget__table\">${e.keys().map(r => {\n    const t = e.field(r);\n    return `<tr><th>${r}</th><td>${\"string\" == typeof t ? a(s(t)) : t}</td></tr>`;\n  }).join(\"\")}</table>`;\n}\n\nfunction l({\n  aggregatedFeatures: e,\n  arcadeUtils: r,\n  featureSetVars: a,\n  context: s,\n  viewInfo: i,\n  map: o,\n  graphic: n\n}) {\n  a.forEach(a => {\n    const c = a.toLowerCase(),\n          p = {\n      map: o,\n      spatialReference: i.sr\n    };\n\n    if (\"$map\" === c && (s.vars[c] = r.convertMapToFeatureSetCollection(p)), \"$layer\" === c && (s.vars[c] = r.convertFeatureLayerToFeatureSet(n.sourceLayer, i.sr)), \"$datastore\" === c && (s.vars[c] = r.convertServiceUrlToWorkspace(n.sourceLayer.url, i.sr)), \"$aggregatedfeatures\" === c) {\n      const a = n.layer,\n            {\n        fields: o,\n        objectIdField: p,\n        geometryType: l,\n        spatialReference: u,\n        displayField: f\n      } = a,\n            d = new t({\n        fields: o,\n        objectIdField: p,\n        geometryType: l,\n        spatialReference: u,\n        displayField: f,\n        ...(\"feature\" === a.type ? {\n          templates: a.templates,\n          typeIdField: a.typeIdField,\n          types: a.types\n        } : null),\n        source: e\n      });\n      s.vars[c] = r.convertFeatureLayerToFeatureSet(d, i.sr);\n    }\n  });\n}\n\nfunction u() {\n  return import(\"../../../support/arcadeUtils.js\");\n}\n\nasync function f({\n  graphic: e,\n  view: r\n}) {\n  const {\n    isAggregate: t,\n    layer: a\n  } = e;\n  if (!t || !a || \"2d\" !== (null == r ? void 0 : r.type)) return [];\n  const s = await r.whenLayerView(a);\n  if (!s.createQuery || !s.queryFeatures) return [];\n  const i = s.createQuery();\n  i.aggregateIds = [e.getObjectId()];\n  const {\n    features: o\n  } = await s.queryFeatures(i);\n  return o;\n}\n\nasync function d({\n  expressionAttributes: e,\n  info: r,\n  arcadeUtils: t,\n  spatialReference: o,\n  map: u,\n  graphic: d,\n  view: g\n}) {\n  const y = `expression/${r.name}`,\n        m = t.createSyntaxTree(r.expression),\n        w = i.filter(e => t.hasVariable(m, e));\n  await t.loadScriptDependencies(m, !0, w);\n  const F = t.getViewInfo({\n    spatialReference: o\n  }),\n        v = t.createExecContext(d, F);\n  v.useAsync = !0;\n  l({\n    aggregatedFeatures: await f({\n      graphic: d,\n      view: g\n    }),\n    arcadeUtils: t,\n    featureSetVars: w,\n    context: v,\n    viewInfo: F,\n    map: u,\n    graphic: d\n  });\n  const h = t.createFunction(m, v),\n        x = await t.executeAsyncFunction(h, v).catch(e => n.error(\"arcade-execution-error\", {\n    error: e,\n    graphic: d,\n    expressionInfo: r\n  }));\n  e[y] = \"string\" == typeof x ? a(s(x)) : Array.isArray(x) ? c(x) : x && \"esri.arcade.Dictionary\" === x.declaredClass ? p(x) : x;\n}\n\nasync function g({\n  popupTemplate: e,\n  spatialReference: t,\n  graphic: a,\n  map: s,\n  view: i\n}) {\n  const o = e.expressionInfos,\n        n = [],\n        c = {};\n  if (!o || !o.length) return c;\n  const p = await u();\n\n  for (const r of o) n.push(d({\n    expressionAttributes: c,\n    info: r,\n    arcadeUtils: p,\n    spatialReference: t,\n    map: s,\n    graphic: a,\n    view: i\n  }));\n\n  return await r(n), c;\n}\n\nexport { g as createCompiledExpressions };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/widgets/Feature/support/arcadeFeatureUtils.js"],"names":["e","eachAlways","r","t","applyTextFormattingHTML","a","htmlEntities","s","i","o","n","getLogger","c","map","join","p","keys","field","l","aggregatedFeatures","arcadeUtils","featureSetVars","context","viewInfo","graphic","forEach","toLowerCase","spatialReference","sr","vars","convertMapToFeatureSetCollection","convertFeatureLayerToFeatureSet","sourceLayer","convertServiceUrlToWorkspace","url","layer","fields","objectIdField","geometryType","u","displayField","f","d","type","templates","typeIdField","types","source","view","isAggregate","whenLayerView","createQuery","queryFeatures","aggregateIds","getObjectId","features","expressionAttributes","info","g","y","name","m","createSyntaxTree","expression","w","filter","hasVariable","loadScriptDependencies","F","getViewInfo","v","createExecContext","useAsync","h","createFunction","x","executeAsyncFunction","catch","error","expressionInfo","Array","isArray","declaredClass","popupTemplate","expressionInfos","length","push","createCompiledExpressions"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../core/Logger.js\";import{eachAlways as r}from\"../../../core/promiseUtils.js\";import t from\"../../../layers/FeatureLayer.js\";import{applyTextFormattingHTML as a,htmlEntities as s}from\"./featureUtils.js\";const i=[\"$datastore\",\"$map\",\"$layer\",\"$aggregatedfeatures\"],o=\"esri.widgets.Feature.support.arcadeFeatureUtils\",n=e.getLogger(o);function c(e){return`<ul class=\"esri-widget__list\">${e.map((e=>`<li>${\"string\"==typeof e?a(s(e)):e}</li>`)).join(\"\")}</ul>`}function p(e){return`<table class=\"esri-widget__table\">${e.keys().map((r=>{const t=e.field(r);return`<tr><th>${r}</th><td>${\"string\"==typeof t?a(s(t)):t}</td></tr>`})).join(\"\")}</table>`}function l({aggregatedFeatures:e,arcadeUtils:r,featureSetVars:a,context:s,viewInfo:i,map:o,graphic:n}){a.forEach((a=>{const c=a.toLowerCase(),p={map:o,spatialReference:i.sr};if(\"$map\"===c&&(s.vars[c]=r.convertMapToFeatureSetCollection(p)),\"$layer\"===c&&(s.vars[c]=r.convertFeatureLayerToFeatureSet(n.sourceLayer,i.sr)),\"$datastore\"===c&&(s.vars[c]=r.convertServiceUrlToWorkspace(n.sourceLayer.url,i.sr)),\"$aggregatedfeatures\"===c){const a=n.layer,{fields:o,objectIdField:p,geometryType:l,spatialReference:u,displayField:f}=a,d=new t({fields:o,objectIdField:p,geometryType:l,spatialReference:u,displayField:f,...\"feature\"===a.type?{templates:a.templates,typeIdField:a.typeIdField,types:a.types}:null,source:e});s.vars[c]=r.convertFeatureLayerToFeatureSet(d,i.sr)}}))}function u(){return import(\"../../../support/arcadeUtils.js\")}async function f({graphic:e,view:r}){const{isAggregate:t,layer:a}=e;if(!t||!a||\"2d\"!==(null==r?void 0:r.type))return[];const s=await r.whenLayerView(a);if(!s.createQuery||!s.queryFeatures)return[];const i=s.createQuery();i.aggregateIds=[e.getObjectId()];const{features:o}=await s.queryFeatures(i);return o}async function d({expressionAttributes:e,info:r,arcadeUtils:t,spatialReference:o,map:u,graphic:d,view:g}){const y=`expression/${r.name}`,m=t.createSyntaxTree(r.expression),w=i.filter((e=>t.hasVariable(m,e)));await t.loadScriptDependencies(m,!0,w);const F=t.getViewInfo({spatialReference:o}),v=t.createExecContext(d,F);v.useAsync=!0;l({aggregatedFeatures:await f({graphic:d,view:g}),arcadeUtils:t,featureSetVars:w,context:v,viewInfo:F,map:u,graphic:d});const h=t.createFunction(m,v),x=await t.executeAsyncFunction(h,v).catch((e=>n.error(\"arcade-execution-error\",{error:e,graphic:d,expressionInfo:r})));e[y]=\"string\"==typeof x?a(s(x)):Array.isArray(x)?c(x):x&&\"esri.arcade.Dictionary\"===x.declaredClass?p(x):x}async function g({popupTemplate:e,spatialReference:t,graphic:a,map:s,view:i}){const o=e.expressionInfos,n=[],c={};if(!o||!o.length)return c;const p=await u();for(const r of o)n.push(d({expressionAttributes:c,info:r,arcadeUtils:p,spatialReference:t,map:s,graphic:a,view:i}));return await r(n),c}export{g as createCompiledExpressions};\n"]},"metadata":{},"sourceType":"module"}