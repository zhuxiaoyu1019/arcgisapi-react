{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../../../core/CircularArray.js\";\nimport { isSome as t, isNone as s, unwrap as r } from \"../../../../../core/maybe.js\";\nimport { FeatureSetReaderJSON as d } from \"../support/FeatureSetReaderJSON.js\";\nimport { UpdateToken as i } from \"../support/UpdateToken.js\";\n\nclass a {\n  constructor(t) {\n    this.requests = {\n      done: new Array(),\n      stream: new e(10)\n    }, this._edits = null, this._abortController = new AbortController(), this._done = !1, this.didSend = !1, this.tile = t;\n  }\n\n  get signal() {\n    return this._abortController.signal;\n  }\n\n  get options() {\n    return {\n      signal: this._abortController.signal\n    };\n  }\n\n  get empty() {\n    return !this.requests.done.length;\n  }\n\n  get edits() {\n    return this._edits;\n  }\n\n  get done() {\n    return this._done;\n  }\n\n  end() {\n    this._done = !0;\n  }\n\n  clear() {\n    this.requests.done = [];\n  }\n\n  applyUpdate(e) {\n    this.requests.done.forEach(t => t.message.status.unset(e)), t(this._edits) && this._edits.status.unset(e);\n  }\n\n  add(e) {\n    var s;\n    e.message.status = null != (s = e.message.status) ? s : i.empty(), e.message.end && this.requests.done.forEach(e => {\n      t(e.message) && e.message.end && (e.message.end = !1);\n    }), this.requests.done.push(e);\n  }\n\n  edit(e, t) {\n    const a = e.getQuantizationTransform(),\n          o = e.geometryType,\n          n = Array.from(e.features()),\n          h = [...t, ...n.map(e => e.objectId)];\n    if (this.removeIds(h), this._invalidate(), s(this._edits)) return void (this._edits = {\n      type: \"append\",\n      addOrUpdate: d.fromOptimizedFeatures(n, o, r(a)),\n      id: this.tile.id,\n      status: i.empty(),\n      end: !0\n    });\n    this.requests.done.forEach(e => e.message.end = !1);\n    r(this._edits.addOrUpdate).append(e.features());\n  }\n\n  *readers() {\n    for (const {\n      message: e\n    } of this.requests.done) t(e.addOrUpdate) && (yield e.addOrUpdate);\n\n    t(this._edits) && t(this._edits.addOrUpdate) && (yield this._edits.addOrUpdate);\n  }\n\n  _invalidate() {\n    for (const e of this.requests.done) e.message.status = i.empty();\n\n    t(this._edits) && (this._edits.status = i.empty());\n  }\n\n  removeIds(e) {\n    this._invalidate();\n\n    for (const {\n      message: s\n    } of this.requests.done) {\n      const r = s.addOrUpdate;\n      t(r) && (r.removeIds(e), r.isEmpty && (s.addOrUpdate = null));\n    }\n\n    t(this._edits) && t(this._edits.addOrUpdate) && this._edits.addOrUpdate.removeIds(e), this.requests.done = this.requests.done.filter(e => e.message.addOrUpdate || e.message.end);\n  }\n\n  abort() {\n    this._abortController.abort();\n  }\n\n}\n\nexport { a as DataTileSubscription };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/2d/layers/features/sources/DataTileSubscription.js"],"names":["e","isSome","t","isNone","s","unwrap","r","FeatureSetReaderJSON","d","UpdateToken","i","a","constructor","requests","done","Array","stream","_edits","_abortController","AbortController","_done","didSend","tile","signal","options","empty","length","edits","end","clear","applyUpdate","forEach","message","status","unset","add","push","edit","getQuantizationTransform","o","geometryType","n","from","features","h","map","objectId","removeIds","_invalidate","type","addOrUpdate","fromOptimizedFeatures","id","append","readers","isEmpty","filter","abort","DataTileSubscription"],"mappings":"AAAA;AACA;AACA;AACA;AACA,OAAOA,CAAP,MAAa,sCAAb;AAAoD,SAAOC,MAAM,IAAIC,CAAjB,EAAmBC,MAAM,IAAIC,CAA7B,EAA+BC,MAAM,IAAIC,CAAzC,QAA+C,8BAA/C;AAA8E,SAAOC,oBAAoB,IAAIC,CAA/B,QAAqC,oCAArC;AAA0E,SAAOC,WAAW,IAAIC,CAAtB,QAA4B,2BAA5B;;AAAwD,MAAMC,CAAN,CAAO;AAACC,EAAAA,WAAW,CAACV,CAAD,EAAG;AAAC,SAAKW,QAAL,GAAc;AAACC,MAAAA,IAAI,EAAC,IAAIC,KAAJ,EAAN;AAAgBC,MAAAA,MAAM,EAAC,IAAIhB,CAAJ,CAAM,EAAN;AAAvB,KAAd,EAAgD,KAAKiB,MAAL,GAAY,IAA5D,EAAiE,KAAKC,gBAAL,GAAsB,IAAIC,eAAJ,EAAvF,EAA2G,KAAKC,KAAL,GAAW,CAAC,CAAvH,EAAyH,KAAKC,OAAL,GAAa,CAAC,CAAvI,EAAyI,KAAKC,IAAL,GAAUpB,CAAnJ;AAAqJ;;AAAU,MAANqB,MAAM,GAAE;AAAC,WAAO,KAAKL,gBAAL,CAAsBK,MAA7B;AAAoC;;AAAW,MAAPC,OAAO,GAAE;AAAC,WAAM;AAACD,MAAAA,MAAM,EAAC,KAAKL,gBAAL,CAAsBK;AAA9B,KAAN;AAA4C;;AAAS,MAALE,KAAK,GAAE;AAAC,WAAM,CAAC,KAAKZ,QAAL,CAAcC,IAAd,CAAmBY,MAA1B;AAAiC;;AAAS,MAALC,KAAK,GAAE;AAAC,WAAO,KAAKV,MAAZ;AAAmB;;AAAQ,MAAJH,IAAI,GAAE;AAAC,WAAO,KAAKM,KAAZ;AAAkB;;AAAAQ,EAAAA,GAAG,GAAE;AAAC,SAAKR,KAAL,GAAW,CAAC,CAAZ;AAAc;;AAAAS,EAAAA,KAAK,GAAE;AAAC,SAAKhB,QAAL,CAAcC,IAAd,GAAmB,EAAnB;AAAsB;;AAAAgB,EAAAA,WAAW,CAAC9B,CAAD,EAAG;AAAC,SAAKa,QAAL,CAAcC,IAAd,CAAmBiB,OAAnB,CAA4B7B,CAAC,IAAEA,CAAC,CAAC8B,OAAF,CAAUC,MAAV,CAAiBC,KAAjB,CAAuBlC,CAAvB,CAA/B,GAA2DE,CAAC,CAAC,KAAKe,MAAN,CAAD,IAAgB,KAAKA,MAAL,CAAYgB,MAAZ,CAAmBC,KAAnB,CAAyBlC,CAAzB,CAA3E;AAAuG;;AAAAmC,EAAAA,GAAG,CAACnC,CAAD,EAAG;AAAC,QAAII,CAAJ;AAAMJ,IAAAA,CAAC,CAACgC,OAAF,CAAUC,MAAV,GAAiB,SAAO7B,CAAC,GAACJ,CAAC,CAACgC,OAAF,CAAUC,MAAnB,IAA2B7B,CAA3B,GAA6BM,CAAC,CAACe,KAAF,EAA9C,EAAwDzB,CAAC,CAACgC,OAAF,CAAUJ,GAAV,IAAe,KAAKf,QAAL,CAAcC,IAAd,CAAmBiB,OAAnB,CAA4B/B,CAAC,IAAE;AAACE,MAAAA,CAAC,CAACF,CAAC,CAACgC,OAAH,CAAD,IAAchC,CAAC,CAACgC,OAAF,CAAUJ,GAAxB,KAA8B5B,CAAC,CAACgC,OAAF,CAAUJ,GAAV,GAAc,CAAC,CAA7C;AAAgD,KAAhF,CAAvE,EAA0J,KAAKf,QAAL,CAAcC,IAAd,CAAmBsB,IAAnB,CAAwBpC,CAAxB,CAA1J;AAAqL;;AAAAqC,EAAAA,IAAI,CAACrC,CAAD,EAAGE,CAAH,EAAK;AAAC,UAAMS,CAAC,GAACX,CAAC,CAACsC,wBAAF,EAAR;AAAA,UAAqCC,CAAC,GAACvC,CAAC,CAACwC,YAAzC;AAAA,UAAsDC,CAAC,GAAC1B,KAAK,CAAC2B,IAAN,CAAW1C,CAAC,CAAC2C,QAAF,EAAX,CAAxD;AAAA,UAAiFC,CAAC,GAAC,CAAC,GAAG1C,CAAJ,EAAM,GAAGuC,CAAC,CAACI,GAAF,CAAO7C,CAAC,IAAEA,CAAC,CAAC8C,QAAZ,CAAT,CAAnF;AAAoH,QAAG,KAAKC,SAAL,CAAeH,CAAf,GAAkB,KAAKI,WAAL,EAAlB,EAAqC5C,CAAC,CAAC,KAAKa,MAAN,CAAzC,EAAuD,OAAO,MAAK,KAAKA,MAAL,GAAY;AAACgC,MAAAA,IAAI,EAAC,QAAN;AAAeC,MAAAA,WAAW,EAAC1C,CAAC,CAAC2C,qBAAF,CAAwBV,CAAxB,EAA0BF,CAA1B,EAA4BjC,CAAC,CAACK,CAAD,CAA7B,CAA3B;AAA6DyC,MAAAA,EAAE,EAAC,KAAK9B,IAAL,CAAU8B,EAA1E;AAA6EnB,MAAAA,MAAM,EAACvB,CAAC,CAACe,KAAF,EAApF;AAA8FG,MAAAA,GAAG,EAAC,CAAC;AAAnG,KAAjB,CAAP;AAA+H,SAAKf,QAAL,CAAcC,IAAd,CAAmBiB,OAAnB,CAA4B/B,CAAC,IAAEA,CAAC,CAACgC,OAAF,CAAUJ,GAAV,GAAc,CAAC,CAA9C;AAAkDtB,IAAAA,CAAC,CAAC,KAAKW,MAAL,CAAYiC,WAAb,CAAD,CAA2BG,MAA3B,CAAkCrD,CAAC,CAAC2C,QAAF,EAAlC;AAAgD;;AAAQ,GAAPW,OAAO,GAAE;AAAC,SAAI,MAAK;AAACtB,MAAAA,OAAO,EAAChC;AAAT,KAAT,IAAuB,KAAKa,QAAL,CAAcC,IAArC,EAA0CZ,CAAC,CAACF,CAAC,CAACkD,WAAH,CAAD,KAAmB,MAAMlD,CAAC,CAACkD,WAA3B;;AAAwChD,IAAAA,CAAC,CAAC,KAAKe,MAAN,CAAD,IAAgBf,CAAC,CAAC,KAAKe,MAAL,CAAYiC,WAAb,CAAjB,KAA6C,MAAM,KAAKjC,MAAL,CAAYiC,WAA/D;AAA4E;;AAAAF,EAAAA,WAAW,GAAE;AAAC,SAAI,MAAMhD,CAAV,IAAe,KAAKa,QAAL,CAAcC,IAA7B,EAAkCd,CAAC,CAACgC,OAAF,CAAUC,MAAV,GAAiBvB,CAAC,CAACe,KAAF,EAAjB;;AAA2BvB,IAAAA,CAAC,CAAC,KAAKe,MAAN,CAAD,KAAiB,KAAKA,MAAL,CAAYgB,MAAZ,GAAmBvB,CAAC,CAACe,KAAF,EAApC;AAA+C;;AAAAsB,EAAAA,SAAS,CAAC/C,CAAD,EAAG;AAAC,SAAKgD,WAAL;;AAAmB,SAAI,MAAK;AAAChB,MAAAA,OAAO,EAAC5B;AAAT,KAAT,IAAuB,KAAKS,QAAL,CAAcC,IAArC,EAA0C;AAAC,YAAMR,CAAC,GAACF,CAAC,CAAC8C,WAAV;AAAsBhD,MAAAA,CAAC,CAACI,CAAD,CAAD,KAAOA,CAAC,CAACyC,SAAF,CAAY/C,CAAZ,GAAeM,CAAC,CAACiD,OAAF,KAAYnD,CAAC,CAAC8C,WAAF,GAAc,IAA1B,CAAtB;AAAuD;;AAAAhD,IAAAA,CAAC,CAAC,KAAKe,MAAN,CAAD,IAAgBf,CAAC,CAAC,KAAKe,MAAL,CAAYiC,WAAb,CAAjB,IAA4C,KAAKjC,MAAL,CAAYiC,WAAZ,CAAwBH,SAAxB,CAAkC/C,CAAlC,CAA5C,EAAiF,KAAKa,QAAL,CAAcC,IAAd,GAAmB,KAAKD,QAAL,CAAcC,IAAd,CAAmB0C,MAAnB,CAA2BxD,CAAC,IAAEA,CAAC,CAACgC,OAAF,CAAUkB,WAAV,IAAuBlD,CAAC,CAACgC,OAAF,CAAUJ,GAA/D,CAApG;AAAyK;;AAAA6B,EAAAA,KAAK,GAAE;AAAC,SAAKvC,gBAAL,CAAsBuC,KAAtB;AAA8B;;AAAnwD;;AAAowD,SAAO9C,CAAC,IAAI+C,oBAAZ","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../../../core/CircularArray.js\";import{isSome as t,isNone as s,unwrap as r}from\"../../../../../core/maybe.js\";import{FeatureSetReaderJSON as d}from\"../support/FeatureSetReaderJSON.js\";import{UpdateToken as i}from\"../support/UpdateToken.js\";class a{constructor(t){this.requests={done:new Array,stream:new e(10)},this._edits=null,this._abortController=new AbortController,this._done=!1,this.didSend=!1,this.tile=t}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}get empty(){return!this.requests.done.length}get edits(){return this._edits}get done(){return this._done}end(){this._done=!0}clear(){this.requests.done=[]}applyUpdate(e){this.requests.done.forEach((t=>t.message.status.unset(e))),t(this._edits)&&this._edits.status.unset(e)}add(e){var s;e.message.status=null!=(s=e.message.status)?s:i.empty(),e.message.end&&this.requests.done.forEach((e=>{t(e.message)&&e.message.end&&(e.message.end=!1)})),this.requests.done.push(e)}edit(e,t){const a=e.getQuantizationTransform(),o=e.geometryType,n=Array.from(e.features()),h=[...t,...n.map((e=>e.objectId))];if(this.removeIds(h),this._invalidate(),s(this._edits))return void(this._edits={type:\"append\",addOrUpdate:d.fromOptimizedFeatures(n,o,r(a)),id:this.tile.id,status:i.empty(),end:!0});this.requests.done.forEach((e=>e.message.end=!1));r(this._edits.addOrUpdate).append(e.features())}*readers(){for(const{message:e}of this.requests.done)t(e.addOrUpdate)&&(yield e.addOrUpdate);t(this._edits)&&t(this._edits.addOrUpdate)&&(yield this._edits.addOrUpdate)}_invalidate(){for(const e of this.requests.done)e.message.status=i.empty();t(this._edits)&&(this._edits.status=i.empty())}removeIds(e){this._invalidate();for(const{message:s}of this.requests.done){const r=s.addOrUpdate;t(r)&&(r.removeIds(e),r.isEmpty&&(s.addOrUpdate=null))}t(this._edits)&&t(this._edits.addOrUpdate)&&this._edits.addOrUpdate.removeIds(e),this.requests.done=this.requests.done.filter((e=>e.message.addOrUpdate||e.message.end))}abort(){this._abortController.abort()}}export{a as DataTileSubscription};\n"]},"metadata":{},"sourceType":"module"}