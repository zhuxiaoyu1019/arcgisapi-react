{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isNone as e } from \"../../../../../core/maybe.js\";\nimport { c as t, f as a } from \"../../../../../chunks/vec2f32.js\";\nimport { FADE_DURATION as i } from \"../../vectorTiles/decluttering/config.js\";\nimport { VTL_TEXTURE_BINDING_UNIT_SPRITES as r, VTL_TEXTURE_BINDING_UNIT_GLYPHS as s } from \"../definitions.js\";\nimport { WGLDrawPhase as n } from \"../enums.js\";\nimport { degToByte as o } from \"../GeometryUtils.js\";\nimport { u32to4Xu8 as l } from \"../number.js\";\nimport f from \"./WGLBrush.js\";\nconst c = 1 / 65536;\n\nclass p extends f {\n  constructor() {\n    super(...arguments), this._iconProgramOptions = {\n      id: !1,\n      sdf: !1\n    }, this._sdfProgramOptions = {\n      id: !1\n    }, this._spritesTextureSize = t();\n  }\n\n  dispose() {}\n\n  drawMany(e, t) {\n    const {\n      drawPhase: a,\n      styleLayerUID: i\n    } = e,\n          r = e.styleLayer;\n    let s;\n    a === n.HITTEST && (s = l(i + 1)), this._drawIcons(e, r, t, s), this._drawText(e, r, t, s);\n  }\n\n  _drawIcons(t, a, s, l) {\n    const {\n      context: f,\n      displayLevel: c,\n      drawPhase: p,\n      painter: u,\n      spriteMosaic: m,\n      state: g,\n      styleLayerUID: y\n    } = t,\n          d = a.iconMaterial,\n          _ = u.vectorTilesMaterialManager;\n    let h,\n        M = !1;\n\n    for (const e of s) if (e.layerData.has(y) && (h = e.layerData.get(y), h.iconPerPageElementsMap.size > 0)) {\n      M = !0;\n      break;\n    }\n\n    if (!M) return;\n    const U = a.getPaintValue(\"icon-translate\", c),\n          P = a.getPaintValue(\"icon-translate-anchor\", c);\n    let x = a.getLayoutValue(\"icon-rotation-alignment\", c);\n    2 === x && (x = 0 === a.getLayoutValue(\"symbol-placement\", c) ? 1 : 0);\n    const v = 0 === x,\n          T = a.getLayoutValue(\"icon-keep-upright\", c) && v,\n          E = h.isIconSDF,\n          D = p === n.HITTEST,\n          V = this._iconProgramOptions;\n    V.id = D, V.sdf = E;\n\n    const S = _.getMaterialProgram(f, d, V);\n\n    f.useProgram(S), S.setUniformMatrix3fv(\"u_displayViewMat3\", 0 === x ? g.displayViewMat3 : g.displayMat3), S.setUniformMatrix3fv(\"u_displayMat3\", 1 === P ? g.displayMat3 : g.displayViewMat3), S.setUniform2fv(\"u_iconTranslation\", U), S.setUniform1f(\"u_depth\", a.z), S.setUniform1f(\"u_mapRotation\", o(g.rotation)), S.setUniform1f(\"u_keepUpright\", T ? 1 : 0), S.setUniform1f(\"u_level\", 10 * c), S.setUniform1i(\"u_texture\", r), S.setUniform1f(\"u_fadeDuration\", i / 1e3), D && S.setUniform4fv(\"u_id\", l);\n    let w = -1;\n\n    for (const i of s) {\n      if (!i.layerData.has(y)) continue;\n      if (i.key.level !== w && (w = i.key.level, d.setDataUniforms(S, c, a, w, m)), h = i.layerData.get(y), 0 === h.iconPerPageElementsMap.size) continue;\n      h.prepareForRendering(f), h.updateOpacityInfo();\n      const r = h.iconVertexArrayObject;\n\n      if (!e(r)) {\n        f.bindVAO(r), S.setUniformMatrix3fv(\"u_dvsMat3\", i.transforms.dvs), S.setUniform1f(\"u_time\", (performance.now() - h.lastOpacityUpdate) / 1e3);\n\n        for (const [e, a] of h.iconPerPageElementsMap) this._renderIconRange(t, S, a, e, i);\n      }\n    }\n  }\n\n  _renderIconRange(e, t, a, i, s) {\n    const {\n      context: n,\n      spriteMosaic: o\n    } = e;\n    this._spritesTextureSize[0] = o.getWidth(i) / 4, this._spritesTextureSize[1] = o.getHeight(i) / 4, t.setUniform2fv(\"u_mosaicSize\", this._spritesTextureSize), o.bind(n, 9729, i, r), n.setStencilTestEnabled(!0), n.setStencilFunction(516, 255, 255), n.setStencilWriteMask(0), n.drawElements(4, a[1], 5125, Uint32Array.BYTES_PER_ELEMENT * a[0]), s.triangleCount += a[1] / 3;\n  }\n\n  _drawText(t, r, l, f) {\n    const {\n      context: p,\n      displayLevel: u,\n      drawPhase: m,\n      glyphMosaic: g,\n      painter: y,\n      pixelRatio: d,\n      spriteMosaic: _,\n      state: h,\n      styleLayerUID: M\n    } = t,\n          U = r.textMaterial,\n          P = y.vectorTilesMaterialManager;\n    let x,\n        v = !1;\n\n    for (const e of l) if (e.layerData.has(M) && (x = e.layerData.get(M), x.glyphPerPageElementsMap.size > 0)) {\n      v = !0;\n      break;\n    }\n\n    if (!v) return;\n    const T = r.getPaintProperty(\"text-opacity\");\n    if (T && !T.isDataDriven && 0 === T.getValue(u)) return;\n    const E = r.getPaintProperty(\"text-color\"),\n          D = !E || E.isDataDriven || E.getValue(u)[3] > 0,\n          V = r.getPaintProperty(\"text-halo-width\"),\n          S = r.getPaintProperty(\"text-halo-color\"),\n          w = (!V || V.isDataDriven || V.getValue(u) > 0) && (!S || S.isDataDriven || S.getValue(u)[3] > 0);\n    if (!D && !w) return;\n    const L = 24 / 8;\n    let z = r.getLayoutValue(\"text-rotation-alignment\", u);\n    2 === z && (z = 0 === r.getLayoutValue(\"symbol-placement\", u) ? 1 : 0);\n    const b = 0 === z,\n          k = r.getLayoutValue(\"text-keep-upright\", u) && b,\n          I = m === n.HITTEST,\n          O = .8 * L / d;\n    this._glyphTextureSize || (this._glyphTextureSize = a(g.width / 4, g.height / 4));\n    const R = r.getPaintValue(\"text-translate\", u),\n          j = r.getPaintValue(\"text-translate-anchor\", u),\n          A = this._sdfProgramOptions;\n    A.id = I;\n    const F = P.getMaterialProgram(p, U, A);\n    p.useProgram(F), F.setUniformMatrix3fv(\"u_displayViewMat3\", 0 === z ? h.displayViewMat3 : h.displayMat3), F.setUniformMatrix3fv(\"u_displayMat3\", 1 === j ? h.displayMat3 : h.displayViewMat3), F.setUniform2fv(\"u_textTranslation\", R), F.setUniform1f(\"u_depth\", r.z + c), F.setUniform2fv(\"u_mosaicSize\", this._glyphTextureSize), F.setUniform1f(\"u_mapRotation\", o(h.rotation)), F.setUniform1f(\"u_keepUpright\", k ? 1 : 0), F.setUniform1f(\"u_level\", 10 * u), F.setUniform1i(\"u_texture\", s), F.setUniform1f(\"u_antialiasingWidth\", O), F.setUniform1f(\"u_fadeDuration\", i / 1e3), I && F.setUniform4fv(\"u_id\", f);\n    let W = -1;\n\n    for (const a of l) {\n      if (!a.layerData.has(M)) continue;\n      if (a.key.level !== W && (W = a.key.level, U.setDataUniforms(F, u, r, W, _)), x = a.layerData.get(M), 0 === x.glyphPerPageElementsMap.size) continue;\n      x.prepareForRendering(p), x.updateOpacityInfo();\n      const t = x.textVertexArrayObject;\n      if (e(t)) continue;\n      p.bindVAO(t), F.setUniformMatrix3fv(\"u_dvsMat3\", a.transforms.dvs), p.setStencilTestEnabled(!0), p.setStencilFunction(516, 255, 255), p.setStencilWriteMask(0);\n      const i = (performance.now() - x.lastOpacityUpdate) / 1e3;\n      F.setUniform1f(\"u_time\", i), x.glyphPerPageElementsMap.forEach((e, t) => {\n        this._renderGlyphRange(p, e, t, g, F, w, D, a);\n      });\n    }\n  }\n\n  _renderGlyphRange(e, t, a, i, r, n, o, l) {\n    i.bind(e, 9729, a, s), n && (r.setUniform1f(\"u_halo\", 1), e.drawElements(4, t[1], 5125, Uint32Array.BYTES_PER_ELEMENT * t[0]), l.triangleCount += t[1] / 3), o && (r.setUniform1f(\"u_halo\", 0), e.drawElements(4, t[1], 5125, Uint32Array.BYTES_PER_ELEMENT * t[0]), l.triangleCount += t[1] / 3);\n  }\n\n}\n\nexport { p as WGLBrushVTLSymbol };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/2d/engine/webgl/brushes/WGLBrushVTLSymbol.js"],"names":["isNone","e","c","t","f","a","FADE_DURATION","i","VTL_TEXTURE_BINDING_UNIT_SPRITES","r","VTL_TEXTURE_BINDING_UNIT_GLYPHS","s","WGLDrawPhase","n","degToByte","o","u32to4Xu8","l","p","constructor","arguments","_iconProgramOptions","id","sdf","_sdfProgramOptions","_spritesTextureSize","dispose","drawMany","drawPhase","styleLayerUID","styleLayer","HITTEST","_drawIcons","_drawText","context","displayLevel","painter","u","spriteMosaic","m","state","g","y","d","iconMaterial","_","vectorTilesMaterialManager","h","M","layerData","has","get","iconPerPageElementsMap","size","U","getPaintValue","P","x","getLayoutValue","v","T","E","isIconSDF","D","V","S","getMaterialProgram","useProgram","setUniformMatrix3fv","displayViewMat3","displayMat3","setUniform2fv","setUniform1f","z","rotation","setUniform1i","setUniform4fv","w","key","level","setDataUniforms","prepareForRendering","updateOpacityInfo","iconVertexArrayObject","bindVAO","transforms","dvs","performance","now","lastOpacityUpdate","_renderIconRange","getWidth","getHeight","bind","setStencilTestEnabled","setStencilFunction","setStencilWriteMask","drawElements","Uint32Array","BYTES_PER_ELEMENT","triangleCount","glyphMosaic","pixelRatio","textMaterial","glyphPerPageElementsMap","getPaintProperty","isDataDriven","getValue","L","b","k","I","O","_glyphTextureSize","width","height","R","j","A","F","W","textVertexArrayObject","forEach","_renderGlyphRange","WGLBrushVTLSymbol"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isNone as e}from\"../../../../../core/maybe.js\";import{c as t,f as a}from\"../../../../../chunks/vec2f32.js\";import{FADE_DURATION as i}from\"../../vectorTiles/decluttering/config.js\";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as r,VTL_TEXTURE_BINDING_UNIT_GLYPHS as s}from\"../definitions.js\";import{WGLDrawPhase as n}from\"../enums.js\";import{degToByte as o}from\"../GeometryUtils.js\";import{u32to4Xu8 as l}from\"../number.js\";import f from\"./WGLBrush.js\";const c=1/65536;class p extends f{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=t()}dispose(){}drawMany(e,t){const{drawPhase:a,styleLayerUID:i}=e,r=e.styleLayer;let s;a===n.HITTEST&&(s=l(i+1)),this._drawIcons(e,r,t,s),this._drawText(e,r,t,s)}_drawIcons(t,a,s,l){const{context:f,displayLevel:c,drawPhase:p,painter:u,spriteMosaic:m,state:g,styleLayerUID:y}=t,d=a.iconMaterial,_=u.vectorTilesMaterialManager;let h,M=!1;for(const e of s)if(e.layerData.has(y)&&(h=e.layerData.get(y),h.iconPerPageElementsMap.size>0)){M=!0;break}if(!M)return;const U=a.getPaintValue(\"icon-translate\",c),P=a.getPaintValue(\"icon-translate-anchor\",c);let x=a.getLayoutValue(\"icon-rotation-alignment\",c);2===x&&(x=0===a.getLayoutValue(\"symbol-placement\",c)?1:0);const v=0===x,T=a.getLayoutValue(\"icon-keep-upright\",c)&&v,E=h.isIconSDF,D=p===n.HITTEST,V=this._iconProgramOptions;V.id=D,V.sdf=E;const S=_.getMaterialProgram(f,d,V);f.useProgram(S),S.setUniformMatrix3fv(\"u_displayViewMat3\",0===x?g.displayViewMat3:g.displayMat3),S.setUniformMatrix3fv(\"u_displayMat3\",1===P?g.displayMat3:g.displayViewMat3),S.setUniform2fv(\"u_iconTranslation\",U),S.setUniform1f(\"u_depth\",a.z),S.setUniform1f(\"u_mapRotation\",o(g.rotation)),S.setUniform1f(\"u_keepUpright\",T?1:0),S.setUniform1f(\"u_level\",10*c),S.setUniform1i(\"u_texture\",r),S.setUniform1f(\"u_fadeDuration\",i/1e3),D&&S.setUniform4fv(\"u_id\",l);let w=-1;for(const i of s){if(!i.layerData.has(y))continue;if(i.key.level!==w&&(w=i.key.level,d.setDataUniforms(S,c,a,w,m)),h=i.layerData.get(y),0===h.iconPerPageElementsMap.size)continue;h.prepareForRendering(f),h.updateOpacityInfo();const r=h.iconVertexArrayObject;if(!e(r)){f.bindVAO(r),S.setUniformMatrix3fv(\"u_dvsMat3\",i.transforms.dvs),S.setUniform1f(\"u_time\",(performance.now()-h.lastOpacityUpdate)/1e3);for(const[e,a]of h.iconPerPageElementsMap)this._renderIconRange(t,S,a,e,i)}}}_renderIconRange(e,t,a,i,s){const{context:n,spriteMosaic:o}=e;this._spritesTextureSize[0]=o.getWidth(i)/4,this._spritesTextureSize[1]=o.getHeight(i)/4,t.setUniform2fv(\"u_mosaicSize\",this._spritesTextureSize),o.bind(n,9729,i,r),n.setStencilTestEnabled(!0),n.setStencilFunction(516,255,255),n.setStencilWriteMask(0),n.drawElements(4,a[1],5125,Uint32Array.BYTES_PER_ELEMENT*a[0]),s.triangleCount+=a[1]/3}_drawText(t,r,l,f){const{context:p,displayLevel:u,drawPhase:m,glyphMosaic:g,painter:y,pixelRatio:d,spriteMosaic:_,state:h,styleLayerUID:M}=t,U=r.textMaterial,P=y.vectorTilesMaterialManager;let x,v=!1;for(const e of l)if(e.layerData.has(M)&&(x=e.layerData.get(M),x.glyphPerPageElementsMap.size>0)){v=!0;break}if(!v)return;const T=r.getPaintProperty(\"text-opacity\");if(T&&!T.isDataDriven&&0===T.getValue(u))return;const E=r.getPaintProperty(\"text-color\"),D=!E||E.isDataDriven||E.getValue(u)[3]>0,V=r.getPaintProperty(\"text-halo-width\"),S=r.getPaintProperty(\"text-halo-color\"),w=(!V||V.isDataDriven||V.getValue(u)>0)&&(!S||S.isDataDriven||S.getValue(u)[3]>0);if(!D&&!w)return;const L=24/8;let z=r.getLayoutValue(\"text-rotation-alignment\",u);2===z&&(z=0===r.getLayoutValue(\"symbol-placement\",u)?1:0);const b=0===z,k=r.getLayoutValue(\"text-keep-upright\",u)&&b,I=m===n.HITTEST,O=.8*L/d;this._glyphTextureSize||(this._glyphTextureSize=a(g.width/4,g.height/4));const R=r.getPaintValue(\"text-translate\",u),j=r.getPaintValue(\"text-translate-anchor\",u),A=this._sdfProgramOptions;A.id=I;const F=P.getMaterialProgram(p,U,A);p.useProgram(F),F.setUniformMatrix3fv(\"u_displayViewMat3\",0===z?h.displayViewMat3:h.displayMat3),F.setUniformMatrix3fv(\"u_displayMat3\",1===j?h.displayMat3:h.displayViewMat3),F.setUniform2fv(\"u_textTranslation\",R),F.setUniform1f(\"u_depth\",r.z+c),F.setUniform2fv(\"u_mosaicSize\",this._glyphTextureSize),F.setUniform1f(\"u_mapRotation\",o(h.rotation)),F.setUniform1f(\"u_keepUpright\",k?1:0),F.setUniform1f(\"u_level\",10*u),F.setUniform1i(\"u_texture\",s),F.setUniform1f(\"u_antialiasingWidth\",O),F.setUniform1f(\"u_fadeDuration\",i/1e3),I&&F.setUniform4fv(\"u_id\",f);let W=-1;for(const a of l){if(!a.layerData.has(M))continue;if(a.key.level!==W&&(W=a.key.level,U.setDataUniforms(F,u,r,W,_)),x=a.layerData.get(M),0===x.glyphPerPageElementsMap.size)continue;x.prepareForRendering(p),x.updateOpacityInfo();const t=x.textVertexArrayObject;if(e(t))continue;p.bindVAO(t),F.setUniformMatrix3fv(\"u_dvsMat3\",a.transforms.dvs),p.setStencilTestEnabled(!0),p.setStencilFunction(516,255,255),p.setStencilWriteMask(0);const i=(performance.now()-x.lastOpacityUpdate)/1e3;F.setUniform1f(\"u_time\",i),x.glyphPerPageElementsMap.forEach(((e,t)=>{this._renderGlyphRange(p,e,t,g,F,w,D,a)}))}}_renderGlyphRange(e,t,a,i,r,n,o,l){i.bind(e,9729,a,s),n&&(r.setUniform1f(\"u_halo\",1),e.drawElements(4,t[1],5125,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3),o&&(r.setUniform1f(\"u_halo\",0),e.drawElements(4,t[1],5125,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3)}}export{p as WGLBrushVTLSymbol};\n"]},"metadata":{},"sourceType":"module"}