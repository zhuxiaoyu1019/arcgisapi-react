{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { neverReached as e } from \"../../../../core/compilerUtils.js\";\nimport { clamp as t, acosClamped as r, asinClamped as n, deg2rad as i } from \"../../../../core/mathUtils.js\";\nimport { isSome as s } from \"../../../../core/maybe.js\";\nimport { i as a, c } from \"../../../../chunks/mat4.js\";\nimport { c as o } from \"../../../../chunks/mat4f64.js\";\nimport { f as u, m as l, a as m, b as d, i as f, d as p, n as y, l as h, p as C } from \"../../../../chunks/vec3.js\";\nimport { c as M } from \"../../../../chunks/vec3f64.js\";\nimport { getReferenceEllipsoid as I } from \"../../../../geometry/projectionEllipsoid.js\";\nimport { b as S, e as w } from \"../../../../chunks/sphere.js\";\nimport { defaultApplyOptions as A, hasConstraintType as D, adjustRangeForInteraction as j } from \"./common.js\";\nimport { viewAngle as x } from \"../../state/utils/viewUtils.js\";\n\nfunction R(t, r, n = A, i = !0) {\n  Q.eyeCenterDistance = 0, Q.requiresTwoSteps = !1;\n  const s = T(t, r, n, void 0, Q);\n  if (0 === s) return !1;\n\n  switch (a(B), c(B, B, -s, r.viewRight), n.tiltMode) {\n    case 1:\n      l(z, r.viewForward, B), m(z, z, Q.eyeCenterDistance), r.center = d(G, r.eye, z);\n      break;\n\n    case 0:\n      u(z, r.center, r.eye), l(z, z, B), r.eye = u(G, r.center, z);\n      break;\n\n    default:\n      e(n.tiltMode);\n  }\n\n  return r.up = l(G, r.up, B), !Q.requiresTwoSteps || !i || R(t, r, n, !1);\n}\n\nfunction T(e, t, r = A, n = A, i) {\n  if (!e.state.constraints.tilt) return 0;\n  const s = t.distance,\n        a = e.state.constraints.tilt(s, K);\n  return L(e, r, a), 2 === n.interactionType && D(n.selection, 2) && E(e, n.interactionStartCamera, a), 1 === r.tiltMode || 1 === n.tiltMode ? v(e, t, a, i) : P(e, t, a);\n}\n\nfunction P(e, r, n) {\n  const i = x(e.renderCoordsHelper, r.center, r.eye),\n        s = i - t(i, n.min, n.max);\n  return k(s) ? s : 0;\n}\n\nfunction v(t, r, n, i) {\n  switch (i && (i.requiresTwoSteps = !1), t.viewingMode) {\n    case \"global\":\n      return b(t, r, n, i);\n\n    case \"local\":\n      return O(t, r, n, i);\n\n    default:\n      return void e(t.viewingMode);\n  }\n}\n\nfunction O(e, r, n, i) {\n  const s = x(e.renderCoordsHelper, r.center, r.eye),\n        a = t(s, n.min, n.max),\n        c = s - a;\n  if (!k(c)) return 0;\n\n  if (i) {\n    const t = e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,\n          n = e.renderCoordsHelper.getAltitude(r.eye) - t,\n          s = Math.cos(a);\n    Math.abs(s) > 1e-4 ? i.eyeCenterDistance = n / s : i.eyeCenterDistance = r.distance;\n  }\n\n  return c;\n}\n\nfunction b(e, r, n, i) {\n  const s = q(e, r, N),\n        a = t(s.tiltAtCenter, n.min, n.max);\n  if (!k(s.tiltAtCenter - a)) return 0;\n  let c, o;\n  return s.centerIsOnSurface ? (c = H(s), o = F(s, c)) : (c = s.constraints.clampTilt(s.eyeCenterDistance, s.tiltAtCenter), i && c < Math.PI / 2 && (i.requiresTwoSteps = !0, c = Math.PI / 2 - 1e-5), o = U(s, c)), i && (i.eyeCenterDistance = g(s, c)), o;\n}\n\nfunction q(e, t, n) {\n  const i = e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,\n        a = i + I(e.spatialReference).radius,\n        c = e.renderCoordsHelper.intersectManifold(t.ray, i, G);\n  return n.eyeCenterDistance = t.distance, n.centerIsOnSurface = !1, s(c) ? (n.eyeCenterDistance = f(t.eye, c), n.tiltAtCenter = x(e.renderCoordsHelper, c, t.eye), n.centerIsOnSurface = !0) : e.state.isLocal ? n.tiltAtCenter = x(e.renderCoordsHelper, t.center, t.eye) : (S(w(a), t.ray, G), n.eyeCenterDistance = f(t.eye, G), n.tiltAtCenter = r(-p(t.viewForward, y(G, G)))), n.radius = a, n.eyeRadius = h(t.eye), n.constraints = e.state.constraints, n;\n}\n\nfunction k(e) {\n  return Math.abs(e) > 1e-9;\n}\n\nfunction H(e) {\n  const {\n    constraints: t,\n    eyeCenterDistance: r,\n    tiltAtCenter: n\n  } = e;\n  let i = n,\n      s = t.clampTilt(r, n);\n  const a = g(e, s);\n  if (t.clampTilt(a, n) === s) return s;\n  let c = 0;\n\n  for (; c < 10 && k(s - i);) {\n    const r = (i + s) / 2,\n          n = g(e, r);\n    k(t.clampTilt(n, r) - r) ? i = r : s = r, c++;\n  }\n\n  return s;\n}\n\nfunction g(e, r) {\n  if (!e.centerIsOnSurface) return e.eyeCenterDistance;\n  const i = Math.PI - t(r, 0, Math.PI),\n        s = n(e.radius / e.eyeRadius * Math.sin(i)),\n        a = Math.PI - i - s,\n        c = Math.sin(a) / Math.sin(i);\n\n  if (e.eyeRadius < e.radius && c > 1) {\n    const t = Math.PI - s,\n          r = Math.PI - i - t;\n    return Math.sin(r) / Math.sin(i) * e.eyeRadius;\n  }\n\n  return c * e.eyeRadius;\n}\n\nfunction F(e, t) {\n  const r = n(e.radius / e.eyeRadius * Math.sin(e.tiltAtCenter)),\n        i = n(e.radius / e.eyeRadius * Math.sin(t));\n  return e.eyeRadius > e.radius ? r - i : i - r;\n}\n\nfunction U(e, t) {\n  return e.tiltAtCenter - Math.PI / 2 - (t - Math.PI / 2);\n}\n\nfunction L(e, t, r) {\n  if (0 === t.interactionType) return;\n  const {\n    interactionStartCamera: n,\n    interactionFactor: i\n  } = t,\n        {\n    min: s,\n    max: a\n  } = r,\n        c = T(e, n, A, t),\n        o = 0 === c ? 0 : x(e.renderCoordsHelper, n.center, n.eye);\n  r.min = s, r.max = a, 2 === t.interactionType ? (D(t.selection, 2) && E(e, n, r), j(c, o, !0, i, J, r)) : j(c, o, !1, i, J, r);\n}\n\nfunction E(e, t, n) {\n  if (e.state.isLocal) return;\n  const i = e.state.constraints;\n  if (!i.altitude) return;\n  const s = C(t.center),\n        a = Math.sqrt(s),\n        c = t.distance,\n        o = I(e.spatialReference).radius,\n        u = i.altitude.min + o,\n        l = i.altitude.max + o,\n        m = (u * u - c * c - s) / (-2 * a * c),\n        d = (l * l - c * c - s) / (-2 * a * c);\n  n.min = Math.max(n.min, Math.min(Math.PI - r(d), n.max)), n.max = Math.min(n.max, Math.PI - r(m));\n}\n\nconst z = M(),\n      B = o(),\n      G = M(),\n      J = i(5),\n      K = {\n  min: 0,\n  max: 0\n},\n      N = {\n  constraints: null,\n  radius: 0,\n  eyeRadius: 0,\n  centerIsOnSurface: !0,\n  eyeCenterDistance: 0,\n  tiltAtCenter: 0\n},\n      Q = {\n  eyeCenterDistance: 0,\n  requiresTwoSteps: !1\n};\nexport { R as applyTiltConstraint, T as getTiltConstraintError };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/camera/constraintUtils/tilt.js"],"names":["neverReached","e","clamp","t","acosClamped","r","asinClamped","n","deg2rad","i","isSome","s","a","c","o","f","u","m","l","b","d","p","y","h","C","M","getReferenceEllipsoid","I","S","w","defaultApplyOptions","A","hasConstraintType","D","adjustRangeForInteraction","j","viewAngle","x","R","Q","eyeCenterDistance","requiresTwoSteps","T","B","viewRight","tiltMode","z","viewForward","center","G","eye","up","state","constraints","tilt","distance","K","L","interactionType","selection","E","interactionStartCamera","v","P","renderCoordsHelper","min","max","k","viewingMode","O","pointsOfInterest","centerOnSurfaceFrequent","estimatedSurfaceAltitude","getAltitude","Math","cos","abs","q","N","tiltAtCenter","centerIsOnSurface","H","F","clampTilt","PI","U","g","spatialReference","radius","intersectManifold","ray","isLocal","eyeRadius","sin","interactionFactor","J","altitude","sqrt","applyTiltConstraint","getTiltConstraintError"],"mappings":"AAAA;AACA;AACA;AACA;AACA,SAAOA,YAAY,IAAIC,CAAvB,QAA6B,mCAA7B;AAAiE,SAAOC,KAAK,IAAIC,CAAhB,EAAkBC,WAAW,IAAIC,CAAjC,EAAmCC,WAAW,IAAIC,CAAlD,EAAoDC,OAAO,IAAIC,CAA/D,QAAqE,+BAArE;AAAqG,SAAOC,MAAM,IAAIC,CAAjB,QAAuB,2BAAvB;AAAmD,SAAOF,CAAC,IAAIG,CAAZ,EAAcC,CAAd,QAAoB,4BAApB;AAAiD,SAAOA,CAAC,IAAIC,CAAZ,QAAkB,+BAAlB;AAAkD,SAAOC,CAAC,IAAIC,CAAZ,EAAcC,CAAC,IAAIC,CAAnB,EAAqBN,CAAC,IAAIK,CAA1B,EAA4BE,CAAC,IAAIC,CAAjC,EAAmCX,CAAC,IAAIM,CAAxC,EAA0CK,CAAC,IAAIC,CAA/C,EAAiDd,CAAC,IAAIe,CAAtD,EAAwDJ,CAAC,IAAIK,CAA7D,EAA+DF,CAAC,IAAIG,CAApE,QAA0E,4BAA1E;AAAuG,SAAOX,CAAC,IAAIY,CAAZ,QAAkB,+BAAlB;AAAkD,SAAOC,qBAAqB,IAAIC,CAAhC,QAAsC,6CAAtC;AAAoF,SAAOR,CAAC,IAAIS,CAAZ,EAAc3B,CAAC,IAAI4B,CAAnB,QAAyB,8BAAzB;AAAwD,SAAOC,mBAAmB,IAAIC,CAA9B,EAAgCC,iBAAiB,IAAIC,CAArD,EAAuDC,yBAAyB,IAAIC,CAApF,QAA0F,aAA1F;AAAwG,SAAOC,SAAS,IAAIC,CAApB,QAA0B,gCAA1B;;AAA2D,SAASC,CAAT,CAAWnC,CAAX,EAAaE,CAAb,EAAeE,CAAC,GAACwB,CAAjB,EAAmBtB,CAAC,GAAC,CAAC,CAAtB,EAAwB;AAAC8B,EAAAA,CAAC,CAACC,iBAAF,GAAoB,CAApB,EAAsBD,CAAC,CAACE,gBAAF,GAAmB,CAAC,CAA1C;AAA4C,QAAM9B,CAAC,GAAC+B,CAAC,CAACvC,CAAD,EAAGE,CAAH,EAAKE,CAAL,EAAO,KAAK,CAAZ,EAAcgC,CAAd,CAAT;AAA0B,MAAG,MAAI5B,CAAP,EAAS,OAAM,CAAC,CAAP;;AAAS,UAAOC,CAAC,CAAC+B,CAAD,CAAD,EAAK9B,CAAC,CAAC8B,CAAD,EAAGA,CAAH,EAAK,CAAChC,CAAN,EAAQN,CAAC,CAACuC,SAAV,CAAN,EAA2BrC,CAAC,CAACsC,QAApC;AAA8C,SAAK,CAAL;AAAO3B,MAAAA,CAAC,CAAC4B,CAAD,EAAGzC,CAAC,CAAC0C,WAAL,EAAiBJ,CAAjB,CAAD,EAAqB1B,CAAC,CAAC6B,CAAD,EAAGA,CAAH,EAAKP,CAAC,CAACC,iBAAP,CAAtB,EAAgDnC,CAAC,CAAC2C,MAAF,GAAS5B,CAAC,CAAC6B,CAAD,EAAG5C,CAAC,CAAC6C,GAAL,EAASJ,CAAT,CAA1D;AAAsE;;AAAM,SAAK,CAAL;AAAO9B,MAAAA,CAAC,CAAC8B,CAAD,EAAGzC,CAAC,CAAC2C,MAAL,EAAY3C,CAAC,CAAC6C,GAAd,CAAD,EAAoBhC,CAAC,CAAC4B,CAAD,EAAGA,CAAH,EAAKH,CAAL,CAArB,EAA6BtC,CAAC,CAAC6C,GAAF,GAAMlC,CAAC,CAACiC,CAAD,EAAG5C,CAAC,CAAC2C,MAAL,EAAYF,CAAZ,CAApC;AAAmD;;AAAM;AAAQ7C,MAAAA,CAAC,CAACM,CAAC,CAACsC,QAAH,CAAD;AAAzM;;AAAuN,SAAOxC,CAAC,CAAC8C,EAAF,GAAKjC,CAAC,CAAC+B,CAAD,EAAG5C,CAAC,CAAC8C,EAAL,EAAQR,CAAR,CAAN,EAAiB,CAACJ,CAAC,CAACE,gBAAH,IAAqB,CAAChC,CAAtB,IAAyB6B,CAAC,CAACnC,CAAD,EAAGE,CAAH,EAAKE,CAAL,EAAO,CAAC,CAAR,CAAlD;AAA6D;;AAAA,SAASmC,CAAT,CAAWzC,CAAX,EAAaE,CAAb,EAAeE,CAAC,GAAC0B,CAAjB,EAAmBxB,CAAC,GAACwB,CAArB,EAAuBtB,CAAvB,EAAyB;AAAC,MAAG,CAACR,CAAC,CAACmD,KAAF,CAAQC,WAAR,CAAoBC,IAAxB,EAA6B,OAAO,CAAP;AAAS,QAAM3C,CAAC,GAACR,CAAC,CAACoD,QAAV;AAAA,QAAmB3C,CAAC,GAACX,CAAC,CAACmD,KAAF,CAAQC,WAAR,CAAoBC,IAApB,CAAyB3C,CAAzB,EAA2B6C,CAA3B,CAArB;AAAmD,SAAOC,CAAC,CAACxD,CAAD,EAAGI,CAAH,EAAKO,CAAL,CAAD,EAAS,MAAIL,CAAC,CAACmD,eAAN,IAAuBzB,CAAC,CAAC1B,CAAC,CAACoD,SAAH,EAAa,CAAb,CAAxB,IAAyCC,CAAC,CAAC3D,CAAD,EAAGM,CAAC,CAACsD,sBAAL,EAA4BjD,CAA5B,CAAnD,EAAkF,MAAIP,CAAC,CAACwC,QAAN,IAAgB,MAAItC,CAAC,CAACsC,QAAtB,GAA+BiB,CAAC,CAAC7D,CAAD,EAAGE,CAAH,EAAKS,CAAL,EAAOH,CAAP,CAAhC,GAA0CsD,CAAC,CAAC9D,CAAD,EAAGE,CAAH,EAAKS,CAAL,CAApI;AAA4I;;AAAA,SAASmD,CAAT,CAAW9D,CAAX,EAAaI,CAAb,EAAeE,CAAf,EAAiB;AAAC,QAAME,CAAC,GAAC4B,CAAC,CAACpC,CAAC,CAAC+D,kBAAH,EAAsB3D,CAAC,CAAC2C,MAAxB,EAA+B3C,CAAC,CAAC6C,GAAjC,CAAT;AAAA,QAA+CvC,CAAC,GAACF,CAAC,GAACN,CAAC,CAACM,CAAD,EAAGF,CAAC,CAAC0D,GAAL,EAAS1D,CAAC,CAAC2D,GAAX,CAApD;AAAoE,SAAOC,CAAC,CAACxD,CAAD,CAAD,GAAKA,CAAL,GAAO,CAAd;AAAgB;;AAAA,SAASmD,CAAT,CAAW3D,CAAX,EAAaE,CAAb,EAAeE,CAAf,EAAiBE,CAAjB,EAAmB;AAAC,UAAOA,CAAC,KAAGA,CAAC,CAACgC,gBAAF,GAAmB,CAAC,CAAvB,CAAD,EAA2BtC,CAAC,CAACiE,WAApC;AAAiD,SAAI,QAAJ;AAAa,aAAOjD,CAAC,CAAChB,CAAD,EAAGE,CAAH,EAAKE,CAAL,EAAOE,CAAP,CAAR;;AAAkB,SAAI,OAAJ;AAAY,aAAO4D,CAAC,CAAClE,CAAD,EAAGE,CAAH,EAAKE,CAAL,EAAOE,CAAP,CAAR;;AAAkB;AAAQ,aAAO,KAAKR,CAAC,CAACE,CAAC,CAACiE,WAAH,CAAb;AAAtH;AAAoJ;;AAAA,SAASC,CAAT,CAAWpE,CAAX,EAAaI,CAAb,EAAeE,CAAf,EAAiBE,CAAjB,EAAmB;AAAC,QAAME,CAAC,GAAC0B,CAAC,CAACpC,CAAC,CAAC+D,kBAAH,EAAsB3D,CAAC,CAAC2C,MAAxB,EAA+B3C,CAAC,CAAC6C,GAAjC,CAAT;AAAA,QAA+CtC,CAAC,GAACT,CAAC,CAACQ,CAAD,EAAGJ,CAAC,CAAC0D,GAAL,EAAS1D,CAAC,CAAC2D,GAAX,CAAlD;AAAA,QAAkErD,CAAC,GAACF,CAAC,GAACC,CAAtE;AAAwE,MAAG,CAACuD,CAAC,CAACtD,CAAD,CAAL,EAAS,OAAO,CAAP;;AAAS,MAAGJ,CAAH,EAAK;AAAC,UAAMN,CAAC,GAACF,CAAC,CAACqE,gBAAF,CAAmBC,uBAAnB,CAA2CC,wBAAnD;AAAA,UAA4EjE,CAAC,GAACN,CAAC,CAAC+D,kBAAF,CAAqBS,WAArB,CAAiCpE,CAAC,CAAC6C,GAAnC,IAAwC/C,CAAtH;AAAA,UAAwHQ,CAAC,GAAC+D,IAAI,CAACC,GAAL,CAAS/D,CAAT,CAA1H;AAAsI8D,IAAAA,IAAI,CAACE,GAAL,CAASjE,CAAT,IAAY,IAAZ,GAAiBF,CAAC,CAAC+B,iBAAF,GAAoBjC,CAAC,GAACI,CAAvC,GAAyCF,CAAC,CAAC+B,iBAAF,GAAoBnC,CAAC,CAACkD,QAA/D;AAAwE;;AAAA,SAAO1C,CAAP;AAAS;;AAAA,SAASM,CAAT,CAAWlB,CAAX,EAAaI,CAAb,EAAeE,CAAf,EAAiBE,CAAjB,EAAmB;AAAC,QAAME,CAAC,GAACkE,CAAC,CAAC5E,CAAD,EAAGI,CAAH,EAAKyE,CAAL,CAAT;AAAA,QAAiBlE,CAAC,GAACT,CAAC,CAACQ,CAAC,CAACoE,YAAH,EAAgBxE,CAAC,CAAC0D,GAAlB,EAAsB1D,CAAC,CAAC2D,GAAxB,CAApB;AAAiD,MAAG,CAACC,CAAC,CAACxD,CAAC,CAACoE,YAAF,GAAenE,CAAhB,CAAL,EAAwB,OAAO,CAAP;AAAS,MAAIC,CAAJ,EAAMC,CAAN;AAAQ,SAAOH,CAAC,CAACqE,iBAAF,IAAqBnE,CAAC,GAACoE,CAAC,CAACtE,CAAD,CAAH,EAAOG,CAAC,GAACoE,CAAC,CAACvE,CAAD,EAAGE,CAAH,CAA/B,KAAuCA,CAAC,GAACF,CAAC,CAAC0C,WAAF,CAAc8B,SAAd,CAAwBxE,CAAC,CAAC6B,iBAA1B,EAA4C7B,CAAC,CAACoE,YAA9C,CAAF,EAA8DtE,CAAC,IAAEI,CAAC,GAAC6D,IAAI,CAACU,EAAL,GAAQ,CAAb,KAAiB3E,CAAC,CAACgC,gBAAF,GAAmB,CAAC,CAApB,EAAsB5B,CAAC,GAAC6D,IAAI,CAACU,EAAL,GAAQ,CAAR,GAAU,IAAnD,CAA9D,EAAuHtE,CAAC,GAACuE,CAAC,CAAC1E,CAAD,EAAGE,CAAH,CAAjK,GAAwKJ,CAAC,KAAGA,CAAC,CAAC+B,iBAAF,GAAoB8C,CAAC,CAAC3E,CAAD,EAAGE,CAAH,CAAxB,CAAzK,EAAwMC,CAA/M;AAAiN;;AAAA,SAAS+D,CAAT,CAAW5E,CAAX,EAAaE,CAAb,EAAeI,CAAf,EAAiB;AAAC,QAAME,CAAC,GAACR,CAAC,CAACqE,gBAAF,CAAmBC,uBAAnB,CAA2CC,wBAAnD;AAAA,QAA4E5D,CAAC,GAACH,CAAC,GAACkB,CAAC,CAAC1B,CAAC,CAACsF,gBAAH,CAAD,CAAsBC,MAAtG;AAAA,QAA6G3E,CAAC,GAACZ,CAAC,CAAC+D,kBAAF,CAAqByB,iBAArB,CAAuCtF,CAAC,CAACuF,GAAzC,EAA6CjF,CAA7C,EAA+CwC,CAA/C,CAA/G;AAAiK,SAAO1C,CAAC,CAACiC,iBAAF,GAAoBrC,CAAC,CAACoD,QAAtB,EAA+BhD,CAAC,CAACyE,iBAAF,GAAoB,CAAC,CAApD,EAAsDrE,CAAC,CAACE,CAAD,CAAD,IAAMN,CAAC,CAACiC,iBAAF,GAAoBzB,CAAC,CAACZ,CAAC,CAAC+C,GAAH,EAAOrC,CAAP,CAArB,EAA+BN,CAAC,CAACwE,YAAF,GAAe1C,CAAC,CAACpC,CAAC,CAAC+D,kBAAH,EAAsBnD,CAAtB,EAAwBV,CAAC,CAAC+C,GAA1B,CAA/C,EAA8E3C,CAAC,CAACyE,iBAAF,GAAoB,CAAC,CAAzG,IAA4G/E,CAAC,CAACmD,KAAF,CAAQuC,OAAR,GAAgBpF,CAAC,CAACwE,YAAF,GAAe1C,CAAC,CAACpC,CAAC,CAAC+D,kBAAH,EAAsB7D,CAAC,CAAC6C,MAAxB,EAA+B7C,CAAC,CAAC+C,GAAjC,CAAhC,IAAuEtB,CAAC,CAACC,CAAC,CAACjB,CAAD,CAAF,EAAMT,CAAC,CAACuF,GAAR,EAAYzC,CAAZ,CAAD,EAAgB1C,CAAC,CAACiC,iBAAF,GAAoBzB,CAAC,CAACZ,CAAC,CAAC+C,GAAH,EAAOD,CAAP,CAArC,EAA+C1C,CAAC,CAACwE,YAAF,GAAe1E,CAAC,CAAC,CAACgB,CAAC,CAAClB,CAAC,CAAC4C,WAAH,EAAezB,CAAC,CAAC2B,CAAD,EAAGA,CAAH,CAAhB,CAAH,CAAtI,CAAlK,EAAoU1C,CAAC,CAACiF,MAAF,GAAS5E,CAA7U,EAA+UL,CAAC,CAACqF,SAAF,GAAYrE,CAAC,CAACpB,CAAC,CAAC+C,GAAH,CAA5V,EAAoW3C,CAAC,CAAC8C,WAAF,GAAcpD,CAAC,CAACmD,KAAF,CAAQC,WAA1X,EAAsY9C,CAA7Y;AAA+Y;;AAAA,SAAS4D,CAAT,CAAWlE,CAAX,EAAa;AAAC,SAAOyE,IAAI,CAACE,GAAL,CAAS3E,CAAT,IAAY,IAAnB;AAAwB;;AAAA,SAASgF,CAAT,CAAWhF,CAAX,EAAa;AAAC,QAAK;AAACoD,IAAAA,WAAW,EAAClD,CAAb;AAAeqC,IAAAA,iBAAiB,EAACnC,CAAjC;AAAmC0E,IAAAA,YAAY,EAACxE;AAAhD,MAAmDN,CAAxD;AAA0D,MAAIQ,CAAC,GAACF,CAAN;AAAA,MAAQI,CAAC,GAACR,CAAC,CAACgF,SAAF,CAAY9E,CAAZ,EAAcE,CAAd,CAAV;AAA2B,QAAMK,CAAC,GAAC0E,CAAC,CAACrF,CAAD,EAAGU,CAAH,CAAT;AAAe,MAAGR,CAAC,CAACgF,SAAF,CAAYvE,CAAZ,EAAcL,CAAd,MAAmBI,CAAtB,EAAwB,OAAOA,CAAP;AAAS,MAAIE,CAAC,GAAC,CAAN;;AAAQ,SAAKA,CAAC,GAAC,EAAF,IAAMsD,CAAC,CAACxD,CAAC,GAACF,CAAH,CAAZ,GAAmB;AAAC,UAAMJ,CAAC,GAAC,CAACI,CAAC,GAACE,CAAH,IAAM,CAAd;AAAA,UAAgBJ,CAAC,GAAC+E,CAAC,CAACrF,CAAD,EAAGI,CAAH,CAAnB;AAAyB8D,IAAAA,CAAC,CAAChE,CAAC,CAACgF,SAAF,CAAY5E,CAAZ,EAAcF,CAAd,IAAiBA,CAAlB,CAAD,GAAsBI,CAAC,GAACJ,CAAxB,GAA0BM,CAAC,GAACN,CAA5B,EAA8BQ,CAAC,EAA/B;AAAkC;;AAAA,SAAOF,CAAP;AAAS;;AAAA,SAAS2E,CAAT,CAAWrF,CAAX,EAAaI,CAAb,EAAe;AAAC,MAAG,CAACJ,CAAC,CAAC+E,iBAAN,EAAwB,OAAO/E,CAAC,CAACuC,iBAAT;AAA2B,QAAM/B,CAAC,GAACiE,IAAI,CAACU,EAAL,GAAQjF,CAAC,CAACE,CAAD,EAAG,CAAH,EAAKqE,IAAI,CAACU,EAAV,CAAjB;AAAA,QAA+BzE,CAAC,GAACJ,CAAC,CAACN,CAAC,CAACuF,MAAF,GAASvF,CAAC,CAAC2F,SAAX,GAAqBlB,IAAI,CAACmB,GAAL,CAASpF,CAAT,CAAtB,CAAlC;AAAA,QAAqEG,CAAC,GAAC8D,IAAI,CAACU,EAAL,GAAQ3E,CAAR,GAAUE,CAAjF;AAAA,QAAmFE,CAAC,GAAC6D,IAAI,CAACmB,GAAL,CAASjF,CAAT,IAAY8D,IAAI,CAACmB,GAAL,CAASpF,CAAT,CAAjG;;AAA6G,MAAGR,CAAC,CAAC2F,SAAF,GAAY3F,CAAC,CAACuF,MAAd,IAAsB3E,CAAC,GAAC,CAA3B,EAA6B;AAAC,UAAMV,CAAC,GAACuE,IAAI,CAACU,EAAL,GAAQzE,CAAhB;AAAA,UAAkBN,CAAC,GAACqE,IAAI,CAACU,EAAL,GAAQ3E,CAAR,GAAUN,CAA9B;AAAgC,WAAOuE,IAAI,CAACmB,GAAL,CAASxF,CAAT,IAAYqE,IAAI,CAACmB,GAAL,CAASpF,CAAT,CAAZ,GAAwBR,CAAC,CAAC2F,SAAjC;AAA2C;;AAAA,SAAO/E,CAAC,GAACZ,CAAC,CAAC2F,SAAX;AAAqB;;AAAA,SAASV,CAAT,CAAWjF,CAAX,EAAaE,CAAb,EAAe;AAAC,QAAME,CAAC,GAACE,CAAC,CAACN,CAAC,CAACuF,MAAF,GAASvF,CAAC,CAAC2F,SAAX,GAAqBlB,IAAI,CAACmB,GAAL,CAAS5F,CAAC,CAAC8E,YAAX,CAAtB,CAAT;AAAA,QAAyDtE,CAAC,GAACF,CAAC,CAACN,CAAC,CAACuF,MAAF,GAASvF,CAAC,CAAC2F,SAAX,GAAqBlB,IAAI,CAACmB,GAAL,CAAS1F,CAAT,CAAtB,CAA5D;AAA+F,SAAOF,CAAC,CAAC2F,SAAF,GAAY3F,CAAC,CAACuF,MAAd,GAAqBnF,CAAC,GAACI,CAAvB,GAAyBA,CAAC,GAACJ,CAAlC;AAAoC;;AAAA,SAASgF,CAAT,CAAWpF,CAAX,EAAaE,CAAb,EAAe;AAAC,SAAOF,CAAC,CAAC8E,YAAF,GAAeL,IAAI,CAACU,EAAL,GAAQ,CAAvB,IAA0BjF,CAAC,GAACuE,IAAI,CAACU,EAAL,GAAQ,CAApC,CAAP;AAA8C;;AAAA,SAAS3B,CAAT,CAAWxD,CAAX,EAAaE,CAAb,EAAeE,CAAf,EAAiB;AAAC,MAAG,MAAIF,CAAC,CAACuD,eAAT,EAAyB;AAAO,QAAK;AAACG,IAAAA,sBAAsB,EAACtD,CAAxB;AAA0BuF,IAAAA,iBAAiB,EAACrF;AAA5C,MAA+CN,CAApD;AAAA,QAAsD;AAAC8D,IAAAA,GAAG,EAACtD,CAAL;AAAOuD,IAAAA,GAAG,EAACtD;AAAX,MAAcP,CAApE;AAAA,QAAsEQ,CAAC,GAAC6B,CAAC,CAACzC,CAAD,EAAGM,CAAH,EAAKwB,CAAL,EAAO5B,CAAP,CAAzE;AAAA,QAAmFW,CAAC,GAAC,MAAID,CAAJ,GAAM,CAAN,GAAQwB,CAAC,CAACpC,CAAC,CAAC+D,kBAAH,EAAsBzD,CAAC,CAACyC,MAAxB,EAA+BzC,CAAC,CAAC2C,GAAjC,CAA9F;AAAoI7C,EAAAA,CAAC,CAAC4D,GAAF,GAAMtD,CAAN,EAAQN,CAAC,CAAC6D,GAAF,GAAMtD,CAAd,EAAgB,MAAIT,CAAC,CAACuD,eAAN,IAAuBzB,CAAC,CAAC9B,CAAC,CAACwD,SAAH,EAAa,CAAb,CAAD,IAAkBC,CAAC,CAAC3D,CAAD,EAAGM,CAAH,EAAKF,CAAL,CAAnB,EAA2B8B,CAAC,CAACtB,CAAD,EAAGC,CAAH,EAAK,CAAC,CAAN,EAAQL,CAAR,EAAUsF,CAAV,EAAY1F,CAAZ,CAAnD,IAAmE8B,CAAC,CAACtB,CAAD,EAAGC,CAAH,EAAK,CAAC,CAAN,EAAQL,CAAR,EAAUsF,CAAV,EAAY1F,CAAZ,CAApF;AAAmG;;AAAA,SAASuD,CAAT,CAAW3D,CAAX,EAAaE,CAAb,EAAeI,CAAf,EAAiB;AAAC,MAAGN,CAAC,CAACmD,KAAF,CAAQuC,OAAX,EAAmB;AAAO,QAAMlF,CAAC,GAACR,CAAC,CAACmD,KAAF,CAAQC,WAAhB;AAA4B,MAAG,CAAC5C,CAAC,CAACuF,QAAN,EAAe;AAAO,QAAMrF,CAAC,GAACa,CAAC,CAACrB,CAAC,CAAC6C,MAAH,CAAT;AAAA,QAAoBpC,CAAC,GAAC8D,IAAI,CAACuB,IAAL,CAAUtF,CAAV,CAAtB;AAAA,QAAmCE,CAAC,GAACV,CAAC,CAACoD,QAAvC;AAAA,QAAgDzC,CAAC,GAACa,CAAC,CAAC1B,CAAC,CAACsF,gBAAH,CAAD,CAAsBC,MAAxE;AAAA,QAA+ExE,CAAC,GAACP,CAAC,CAACuF,QAAF,CAAW/B,GAAX,GAAenD,CAAhG;AAAA,QAAkGI,CAAC,GAACT,CAAC,CAACuF,QAAF,CAAW9B,GAAX,GAAepD,CAAnH;AAAA,QAAqHG,CAAC,GAAC,CAACD,CAAC,GAACA,CAAF,GAAIH,CAAC,GAACA,CAAN,GAAQF,CAAT,KAAa,CAAC,CAAD,GAAGC,CAAH,GAAKC,CAAlB,CAAvH;AAAA,QAA4IO,CAAC,GAAC,CAACF,CAAC,GAACA,CAAF,GAAIL,CAAC,GAACA,CAAN,GAAQF,CAAT,KAAa,CAAC,CAAD,GAAGC,CAAH,GAAKC,CAAlB,CAA9I;AAAmKN,EAAAA,CAAC,CAAC0D,GAAF,GAAMS,IAAI,CAACR,GAAL,CAAS3D,CAAC,CAAC0D,GAAX,EAAeS,IAAI,CAACT,GAAL,CAASS,IAAI,CAACU,EAAL,GAAQ/E,CAAC,CAACe,CAAD,CAAlB,EAAsBb,CAAC,CAAC2D,GAAxB,CAAf,CAAN,EAAmD3D,CAAC,CAAC2D,GAAF,GAAMQ,IAAI,CAACT,GAAL,CAAS1D,CAAC,CAAC2D,GAAX,EAAeQ,IAAI,CAACU,EAAL,GAAQ/E,CAAC,CAACY,CAAD,CAAxB,CAAzD;AAAsF;;AAAA,MAAM6B,CAAC,GAACrB,CAAC,EAAT;AAAA,MAAYkB,CAAC,GAAC7B,CAAC,EAAf;AAAA,MAAkBmC,CAAC,GAACxB,CAAC,EAArB;AAAA,MAAwBsE,CAAC,GAACtF,CAAC,CAAC,CAAD,CAA3B;AAAA,MAA+B+C,CAAC,GAAC;AAACS,EAAAA,GAAG,EAAC,CAAL;AAAOC,EAAAA,GAAG,EAAC;AAAX,CAAjC;AAAA,MAA+CY,CAAC,GAAC;AAACzB,EAAAA,WAAW,EAAC,IAAb;AAAkBmC,EAAAA,MAAM,EAAC,CAAzB;AAA2BI,EAAAA,SAAS,EAAC,CAArC;AAAuCZ,EAAAA,iBAAiB,EAAC,CAAC,CAA1D;AAA4DxC,EAAAA,iBAAiB,EAAC,CAA9E;AAAgFuC,EAAAA,YAAY,EAAC;AAA7F,CAAjD;AAAA,MAAiJxC,CAAC,GAAC;AAACC,EAAAA,iBAAiB,EAAC,CAAnB;AAAqBC,EAAAA,gBAAgB,EAAC,CAAC;AAAvC,CAAnJ;AAA6L,SAAOH,CAAC,IAAI4D,mBAAZ,EAAgCxD,CAAC,IAAIyD,sBAArC","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{neverReached as e}from\"../../../../core/compilerUtils.js\";import{clamp as t,acosClamped as r,asinClamped as n,deg2rad as i}from\"../../../../core/mathUtils.js\";import{isSome as s}from\"../../../../core/maybe.js\";import{i as a,c}from\"../../../../chunks/mat4.js\";import{c as o}from\"../../../../chunks/mat4f64.js\";import{f as u,m as l,a as m,b as d,i as f,d as p,n as y,l as h,p as C}from\"../../../../chunks/vec3.js\";import{c as M}from\"../../../../chunks/vec3f64.js\";import{getReferenceEllipsoid as I}from\"../../../../geometry/projectionEllipsoid.js\";import{b as S,e as w}from\"../../../../chunks/sphere.js\";import{defaultApplyOptions as A,hasConstraintType as D,adjustRangeForInteraction as j}from\"./common.js\";import{viewAngle as x}from\"../../state/utils/viewUtils.js\";function R(t,r,n=A,i=!0){Q.eyeCenterDistance=0,Q.requiresTwoSteps=!1;const s=T(t,r,n,void 0,Q);if(0===s)return!1;switch(a(B),c(B,B,-s,r.viewRight),n.tiltMode){case 1:l(z,r.viewForward,B),m(z,z,Q.eyeCenterDistance),r.center=d(G,r.eye,z);break;case 0:u(z,r.center,r.eye),l(z,z,B),r.eye=u(G,r.center,z);break;default:e(n.tiltMode)}return r.up=l(G,r.up,B),!Q.requiresTwoSteps||!i||R(t,r,n,!1)}function T(e,t,r=A,n=A,i){if(!e.state.constraints.tilt)return 0;const s=t.distance,a=e.state.constraints.tilt(s,K);return L(e,r,a),2===n.interactionType&&D(n.selection,2)&&E(e,n.interactionStartCamera,a),1===r.tiltMode||1===n.tiltMode?v(e,t,a,i):P(e,t,a)}function P(e,r,n){const i=x(e.renderCoordsHelper,r.center,r.eye),s=i-t(i,n.min,n.max);return k(s)?s:0}function v(t,r,n,i){switch(i&&(i.requiresTwoSteps=!1),t.viewingMode){case\"global\":return b(t,r,n,i);case\"local\":return O(t,r,n,i);default:return void e(t.viewingMode)}}function O(e,r,n,i){const s=x(e.renderCoordsHelper,r.center,r.eye),a=t(s,n.min,n.max),c=s-a;if(!k(c))return 0;if(i){const t=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,n=e.renderCoordsHelper.getAltitude(r.eye)-t,s=Math.cos(a);Math.abs(s)>1e-4?i.eyeCenterDistance=n/s:i.eyeCenterDistance=r.distance}return c}function b(e,r,n,i){const s=q(e,r,N),a=t(s.tiltAtCenter,n.min,n.max);if(!k(s.tiltAtCenter-a))return 0;let c,o;return s.centerIsOnSurface?(c=H(s),o=F(s,c)):(c=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),i&&c<Math.PI/2&&(i.requiresTwoSteps=!0,c=Math.PI/2-1e-5),o=U(s,c)),i&&(i.eyeCenterDistance=g(s,c)),o}function q(e,t,n){const i=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,a=i+I(e.spatialReference).radius,c=e.renderCoordsHelper.intersectManifold(t.ray,i,G);return n.eyeCenterDistance=t.distance,n.centerIsOnSurface=!1,s(c)?(n.eyeCenterDistance=f(t.eye,c),n.tiltAtCenter=x(e.renderCoordsHelper,c,t.eye),n.centerIsOnSurface=!0):e.state.isLocal?n.tiltAtCenter=x(e.renderCoordsHelper,t.center,t.eye):(S(w(a),t.ray,G),n.eyeCenterDistance=f(t.eye,G),n.tiltAtCenter=r(-p(t.viewForward,y(G,G)))),n.radius=a,n.eyeRadius=h(t.eye),n.constraints=e.state.constraints,n}function k(e){return Math.abs(e)>1e-9}function H(e){const{constraints:t,eyeCenterDistance:r,tiltAtCenter:n}=e;let i=n,s=t.clampTilt(r,n);const a=g(e,s);if(t.clampTilt(a,n)===s)return s;let c=0;for(;c<10&&k(s-i);){const r=(i+s)/2,n=g(e,r);k(t.clampTilt(n,r)-r)?i=r:s=r,c++}return s}function g(e,r){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const i=Math.PI-t(r,0,Math.PI),s=n(e.radius/e.eyeRadius*Math.sin(i)),a=Math.PI-i-s,c=Math.sin(a)/Math.sin(i);if(e.eyeRadius<e.radius&&c>1){const t=Math.PI-s,r=Math.PI-i-t;return Math.sin(r)/Math.sin(i)*e.eyeRadius}return c*e.eyeRadius}function F(e,t){const r=n(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),i=n(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?r-i:i-r}function U(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}function L(e,t,r){if(0===t.interactionType)return;const{interactionStartCamera:n,interactionFactor:i}=t,{min:s,max:a}=r,c=T(e,n,A,t),o=0===c?0:x(e.renderCoordsHelper,n.center,n.eye);r.min=s,r.max=a,2===t.interactionType?(D(t.selection,2)&&E(e,n,r),j(c,o,!0,i,J,r)):j(c,o,!1,i,J,r)}function E(e,t,n){if(e.state.isLocal)return;const i=e.state.constraints;if(!i.altitude)return;const s=C(t.center),a=Math.sqrt(s),c=t.distance,o=I(e.spatialReference).radius,u=i.altitude.min+o,l=i.altitude.max+o,m=(u*u-c*c-s)/(-2*a*c),d=(l*l-c*c-s)/(-2*a*c);n.min=Math.max(n.min,Math.min(Math.PI-r(d),n.max)),n.max=Math.min(n.max,Math.PI-r(m))}const z=M(),B=o(),G=M(),J=i(5),K={min:0,max:0},N={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},Q={eyeCenterDistance:0,requiresTwoSteps:!1};export{R as applyTiltConstraint,T as getTiltConstraintError};\n"]},"metadata":{},"sourceType":"module"}