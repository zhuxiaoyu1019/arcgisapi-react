{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../chunks/tslib.es6.js\";\nimport { result as t, forEach as i } from \"../../../core/asyncUtils.js\";\nimport r from \"../../../core/Collection.js\";\nimport s from \"../../../core/Logger.js\";\nimport { unwrapOr as o, isSome as n, isNone as a, mapSome as d } from \"../../../core/maybe.js\";\nimport { createAbortController as l, eachAlways as h, isAbortError as u, eachAlwaysValues as p, throwIfAborted as c } from \"../../../core/promiseUtils.js\";\nimport { pt2px as _ } from \"../../../core/screenUtils.js\";\nimport { estimateSize as m, isArrayBuffer as g } from \"../../../core/typedArrayUtil.js\";\nimport { getMetersPerVerticalUnitForSR as f } from \"../../../core/unitUtils.js\";\nimport { property as y } from \"../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../core/has.js\";\nimport \"../../../core/accessorSupport/ensureType.js\";\nimport { subclass as b } from \"../../../core/accessorSupport/decorators/subclass.js\";\nimport { d as w } from \"../../../chunks/vec3.js\";\nimport { a as N } from \"../../../chunks/vec3f32.js\";\nimport { projectBoundingRect as x } from \"../../../geometry/projection.js\";\nimport { create as P } from \"../../../geometry/support/aaBoundingBox.js\";\nimport { containsPoint as v, create as C } from \"../../../geometry/support/aaBoundingRect.js\";\nimport { create as S, fromNormalAndOffset as I } from \"../../../geometry/support/plane.js\";\nimport { makeDehydratedPoint as A } from \"../../../layers/graphics/dehydratedFeatures.js\";\nimport k from \"../../../layers/support/CodedValue.js\";\nimport \"../../../layers/support/domains.js\";\nimport { unpackFieldNames as V } from \"../../../layers/support/fieldUtils.js\";\nimport R from \"../../../layers/support/PromiseQueue.js\";\nimport { getMetersPerUnit as L } from \"../../../symbols/support/unitConversionUtils.js\";\nimport { LayerView3D as Q } from \"./LayerView3D.js\";\nimport { PointCloudWorkerHandle as U } from \"./PointCloudWorkerHandle.js\";\nimport { checkPointCloudLayerValid as j, checkPointCloudLayerCompatibleWithView as D } from \"./i3s/I3SUtil.js\";\nimport { nodeDiff as F, sortFrontToBack as z, splitWorkEntries as M } from \"./i3s/LoDUtil.js\";\nimport W from \"./i3s/PagedNodeIndex.js\";\nimport { getSplatSizeAlgorithm as O, getFixedSizeAlgorithm as E, getRendererInfo as H, getFilterInfo as B, rendererUsesFixedSizes as G, getAttributeInfo as q } from \"./i3s/PointCloudRendererUtil.js\";\nimport { getAttributeValues as T, readGeometry as $, elevationFromPositions as J } from \"./i3s/PointCloudWorkerUtil.js\";\nimport { PointGraphic as K } from \"./i3s/PointGraphic.js\";\nimport { PointRenderer as Y } from \"./i3s/PointRenderer.js\";\nimport { PopupSceneLayerView as X } from \"./support/PopupSceneLayerView.js\";\nimport { projectToBoundingBox as Z } from \"../support/extentUtils.js\";\nimport { minimumDistancePlane as ee } from \"../support/orientedBoundingBox.js\";\nimport { updatingProgress as te } from \"../support/updatingProperties.js\";\nimport ie from \"../../layers/LayerView.js\";\nimport { extractSafeScaleBounds as re, scaleBoundsPredicate as se } from \"../../support/layerViewUtils.js\";\nimport { TaskPriority as oe } from \"../../support/Scheduler.js\";\nimport ne from \"../../../layers/support/CodedValueDomain.js\";\nconst ae = s.getLogger(\"esri.views.3d.layers.PointCloudLayerView3D\"),\n      de = 8,\n      le = S();\nlet he = class extends X(Q(ie)) {\n  constructor() {\n    super(...arguments), this.type = \"point-cloud-3d\", this.maximumPointCount = 4e6, this.slicePlaneEnabled = !1, this._renderer = null, this._rendererAdded = !1, this._renderedNodes = new Set(), this._nodeScales = new Map(), this._updateViewNeeded = !0, this._lodFactor = 1, this._maxLoggedBoxWarnings = 5, this._pageMultiplier = 1, this._nodeLoadEpoch = 0, this._indexQueue = [], this._workQueue = new Array(), this._idleQueue = new R(), this._indexPagesLoading = new Map(), this._loadingNodes = new Map(), this._recalcWork = !0, this._layerIsVisible = !1, this._codedDomainPopulationPromise = null, this._codedDomainPopulationAbortController = null, this._totalWork = 0, this._index = null, this._loadingInitNodePage = !1, this._nodeIdArray = [];\n  }\n\n  get pointScale() {\n    const e = O(this.layer && this.layer.renderer),\n          t = 1;\n    return e && null != e.scaleFactor ? e.scaleFactor : t;\n  }\n\n  get useRealWorldSymbolSizes() {\n    const e = E(this.layer && this.layer.renderer),\n          t = !1;\n    return e && null != e.useRealWorldSymbolSizes ? e.useRealWorldSymbolSizes : t;\n  }\n\n  get pointSize() {\n    const e = E(this.layer && this.layer.renderer),\n          t = 0;\n    return e && null != e.size ? e.size : t;\n  }\n\n  get inverseDensity() {\n    const e = 96;\n    return this.layer && this.layer.renderer ? 1 * e / this.layer.renderer.pointsPerInch : 5;\n  }\n\n  get availableFields() {\n    const e = H(this.layer),\n          t = new Set();\n    e.primaryAttribute && t.add(e.primaryAttribute.name), e.modulationAttribute && t.add(e.primaryAttribute.name);\n    const i = B(this.layer);\n    if (i) for (const r of i) t.add(r.attributeInfo.name);\n    if (this.layer.outFields) for (const r of V(this.layer.fieldsIndex, this.layer.outFields)) t.add(r);\n    return Array.from(t);\n  }\n\n  get _clippingBox() {\n    if (!this.view || !this.view.clippingArea) return null;\n    const e = P(),\n          t = this.view.renderSpatialReference;\n    return Z(this.view.clippingArea, e, t) ? e : null;\n  }\n\n  get _elevationOffset() {\n    const e = this.layer && this.layer.elevationInfo;\n\n    if (e && \"absolute-height\" === e.mode) {\n      const t = f(this.layer.spatialReference),\n            i = L(e.unit);\n      return o(e.offset, 0) * i / t;\n    }\n\n    return 0;\n  }\n\n  initialize() {\n    const e = this.view.resourceController;\n    this._worker = new U(t => e.schedule(t)), this.addResolvingPromise(this._worker.promise), this._tmpPoint = A(0, 0, 0, this.layer.spatialReference), j(this.layer), D(this.layer, this.view), this._indexRequester = e.createStreamDataRequester(2), this._dataRequester = e.createStreamDataRequester(3), this._initRenderer();\n\n    const t = this._initNodePages(),\n          i = this.view.resourceController.memoryController;\n\n    this._memCache = i.getMemCache(this.layer.uid), this.updatingHandles.add(this, \"_clippingBox\", () => this._setUpdateViewNeeded(), 2), this.updatingHandles.add(this, \"_elevationOffset\", () => this._elevationOffsetChanged(), 2), this.updatingHandles.add(this.layer, \"renderer\", () => this._rendererChanged(), 2), this.updatingHandles.add(this.layer, \"filters\", () => this._reload(), 2), this.updatingHandles.add(this.layer, \"outFields\", () => this._reload(), 2), this.updatingHandles.add(this.layer, \"scaleRangeId\", () => this._setUpdateViewNeeded()), this.updatingHandles.add(this, \"clippingArea\", () => this._setUpdateViewNeeded(), 2), this.updatingHandles.add(this.view.state, \"contentCamera\", () => this._setUpdateViewNeeded()), this.handles.add([this.view.basemapTerrain.on(\"scale-change\", e => this._scaleUpdateHandler(e)), i.events.on(\"quality-changed\", () => this._setUpdateViewNeeded())]), this.addResolvingPromise(t), this.when(() => {\n      this.handles.add([e.scheduler.registerTask(oe.POINT_CLOUD_LAYER, this), e.scheduler.registerIdleStateCallbacks(() => this._idleBegin(), () => this._idleEnd()), this.updatingHandles.add(this, \"suspended\", e => {\n        e ? this._clearNodeState() : this._setUpdateViewNeeded();\n      }, 2)]);\n    }, () => {\n      this.updatingHandles.removeAll(), this.handles.removeAll();\n    });\n  }\n\n  _setUpdateViewNeeded() {\n    this._updateViewNeeded = !0, this._updateLoading();\n  }\n\n  destroy() {\n    this.cancelLoading(), this._worker && (this._worker.destroy(), this._worker = null), this._destroyRenderer(), this._memCache.destroy(), this._memCache = null, this._codedDomainPopulationAbortController && (this._codedDomainPopulationAbortController.abort(), this._codedDomainPopulationAbortController = null), this._codedDomainPopulationPromise = null;\n  }\n\n  _initRenderer() {\n    this._renderer = new Y({\n      createGraphic: (e, t, i) => this._createGraphic(e, t, i)\n    }), this._renderer.layerUid = this.layer.uid, this.updatingHandles.add(this, \"_clippingBox\", e => this._renderer.clippingBox = e, 2), this.updatingHandles.add(this, \"suspended\", e => this._setPointsVisible(!e), 2), this.updatingHandles.add(this, \"pointScale\", e => this._renderer.scaleFactor = e, 2), this._renderer.minSizePx = Math.sqrt(2), this.updatingHandles.add(this, \"useRealWorldSymbolSizes\", e => this._renderer.useRealWorldSymbolSizes = e, 2), this.updatingHandles.add(this, \"pointSize\", e => {\n      const t = _(e);\n\n      this._renderer.size = e, this._renderer.sizePx = t;\n    }, 2), this.updatingHandles.add(this, \"slicePlaneEnabled\", e => this._renderer.slicePlane = e, 2), this.updatingHandles.add(this, \"inverseDensity\", () => this._setUpdateViewNeeded(), 2), this.updatingHandles.add(this, \"maximumPointCount\", () => this._setUpdateViewNeeded(), 2), this.updatingHandles.add(this.view, \"qualitySettings.sceneService.pointCloud.lodFactor\", e => {\n      this._lodFactor = e, this._setUpdateViewNeeded();\n    }, 2);\n  }\n\n  _destroyRenderer() {\n    this._renderer.removeAll(), this._setPointsVisible(!1);\n  }\n\n  _createGraphic(e, t, i) {\n    const r = n(e.pointIdFilterMap) ? e.pointIdFilterMap[t] : t,\n          s = this.view.computeMapPointFromVec3d(i),\n          o = this._createGraphicAttributes(e, r);\n\n    return new K({\n      pointCloudMetadata: {\n        nodeId: e.id,\n        pointIndexInNode: t,\n        attributePointIndexInNode: r,\n        epoch: this._nodeLoadEpoch\n      },\n      geometry: s,\n      attributes: o,\n      layer: this.layer,\n      sourceLayer: this.layer\n    });\n  }\n\n  _createGraphicAttributes(e, t) {\n    const i = {};\n\n    for (const r of e.attributes) this._encodeGraphicAttribute(r.attributeInfo, r.values, t, i);\n\n    return i;\n  }\n\n  _encodeGraphicAttribute(e, t, i, r) {\n    const s = e.storageInfo && e.storageInfo.attributeValues,\n          o = s ? s.valuesPerElement : 1;\n    if (1 === o) r[e.name] = t[i];else if (\"UInt8\" === s.valueType && o <= 4) {\n      let s = 0;\n      const n = i * o;\n\n      for (let e = n; e < n + o; e++) s = (s << 8) + t[e];\n\n      r[e.name] = s;\n    } else r[e.name] = void 0;\n  }\n\n  _setPointsVisible(e) {\n    e && !this._rendererAdded ? (this.view._stage.addRenderPlugin([4], this._renderer), this._rendererAdded = !0) : !e && this._rendererAdded && (this.view._stage.removeRenderPlugin(this._renderer), this._rendererAdded = !1);\n  }\n\n  _rendererChanged() {\n    this._renderer.useFixedSizes = G(this.layer.renderer), this._reload();\n  }\n\n  _reload() {\n    this._clearNodeState(), this._memCache.clear(), this._setUpdateViewNeeded();\n  }\n\n  _elevationOffsetChanged() {\n    this._clearNodeState(), this._memCache.clear(), this._initNodePages();\n  }\n\n  _scaleUpdateHandler(e) {\n    this.layer.minScale || this.layer.maxScale ? x(e.extent, e.spatialReference, pe, this.layer.spatialReference) && (this._nodeScales.forEach((t, i) => {\n      if (!this._renderedNodes.has(i)) return void this._nodeScales.delete(i);\n\n      const r = this._index.getNode(i);\n\n      v(pe, r.obb.center) && this._nodeScales.set(i, e.scale);\n    }), this._setUpdateViewNeeded()) : this._nodeScales.clear();\n  }\n\n  displayNodes(e) {\n    this._workQueue = F([...this._renderedNodes], e, this._index), z(this._workQueue, this.view.state.contentCamera.viewForward, this._index), M(this._workQueue, de, this._index), this._updateQueues(), this._totalWork = this._computeWork(), this._updateLoading(), this._layerIsVisible = e.length > 0 || this._loadingInitNodePage, this.notifyChange(\"suspended\");\n  }\n\n  cancelLoading() {\n    this._cancelNodeLoading(), this._cancelIndexLoading();\n  }\n\n  _cancelNodeLoading() {\n    const e = new Array();\n    this._loadingNodes.forEach(({\n      abortController: t\n    }) => e.push(t)), this._loadingNodes.clear();\n\n    for (const t of e) t.abort();\n\n    this._workQueue = [], this._idleQueue.cancelAll(), this._totalWork = this._computeWork(), this._updateLoading();\n  }\n\n  _updateQueues() {\n    const e = new Set();\n\n    this._workQueue.forEach(t => t.load.forEach(t => e.add(t)));\n\n    const t = new Array(),\n          i = new Map();\n    this._loadingNodes.forEach((r, s) => {\n      e.has(s) ? i.set(s, r) : t.push(r);\n    }), this._loadingNodes = i;\n\n    for (const {\n      abortController: r\n    } of t) r.abort();\n\n    this._workQueue = this._workQueue.filter(e => {\n      for (const t of e.load) if (this._loadingNodes.has(t)) return this._recalcWork = !0, !1;\n\n      return !0;\n    }), this._totalWork = this._computeWork(), this._updateLoading();\n  }\n\n  _cancelIndexLoading() {\n    this._indexQueue = [], this._indexPagesLoading.forEach(({\n      abortController: e\n    }) => e.abort()), this._indexPagesLoading.clear(), this._totalWork = this._computeWork(), this._updateLoading();\n  }\n\n  _clearNodeState() {\n    this._nodeLoadEpoch++, this._renderedNodes.forEach(e => this._removeFromRenderer(e)), this._cancelNodeLoading();\n  }\n\n  _idleBegin() {\n    this._setUpdateViewNeeded();\n  }\n\n  _idleEnd() {\n    this._setUpdateViewNeeded();\n  }\n\n  get running() {\n    return this.suspended ? this._updateViewNeeded : this._updateViewNeeded || this._indexQueue.length > 0 || this._workQueue.length > 0 || this._idleQueue.length > 0;\n  }\n\n  runTask(e) {\n    if (this.suspended) {\n      if (this._updateViewNeeded) {\n        this._updateViewNeeded = !1;\n\n        const e = this._isRootNodeVisible();\n\n        e !== this._layerIsVisible && (this._layerIsVisible = e, this.notifyChange(\"suspended\")), this._updateLoading();\n      }\n    } else {\n      for (e.run(() => this._updateWorkQueues()); this._indexQueue.length > 0 && e.run(() => this._processIndexQueue()););\n\n      for (this._processWorkQueue(e); this._idleQueue.length > 0 && e.run(() => this._idleQueue.process()););\n    }\n  }\n\n  _processIndexQueue() {\n    const e = this._indexQueue.shift(),\n          t = this._loadNodePage(e);\n\n    return this._indexPagesLoading.set(e, t), t.promise.then(t => {\n      this._index.addPage(e, t, this._elevationOffset), this._setUpdateViewNeeded();\n    }).then(() => {\n      this._indexPagesLoading.delete(e);\n    }, () => {\n      this._indexPagesLoading.delete(e);\n    }), !0;\n  }\n\n  _processWorkQueue(e) {\n    for (; !e.done;) {\n      const t = this._scheduleWorkEntry();\n\n      if (a(t)) return;\n      this._processWorkEntry(t), e.madeProgress();\n    }\n  }\n\n  _scheduleWorkEntry() {\n    let e = this._workQueue.length;\n\n    for (; e--;) {\n      const e = this._workQueue.shift();\n\n      if (!e.remove.find(e => !this._renderedNodes.has(e))) return e;\n\n      this._workQueue.push(e);\n    }\n\n    return null;\n  }\n\n  _processWorkEntry(e) {\n    if (0 !== e.load.length) Promise.all(e.load.map(e => {\n      const t = l(),\n            i = this._memCache.pop(e.toString());\n\n      return n(i) ? this._loadingNodes.set(e, {\n        abortController: t,\n        promise: Promise.resolve(i)\n      }) : this._loadingNodes.has(e) || this._loadingNodes.set(e, {\n        abortController: t,\n        promise: this.loadNode(e, t.signal)\n      }), this._loadingNodes.get(e).promise;\n    })).then(t => {\n      for (let i = 0; i < e.load.length; i++) if (t[i]) {\n        const r = this._setupRendererData(e.load[i], t[i]);\n\n        this._addToRenderer(r);\n      }\n\n      for (const i of e.remove) this._removeFromRenderer(i);\n    }).catch(() => {}).then(() => {\n      for (const t of e.load) this._loadingNodes.delete(t);\n\n      this._updateLoading(), this._recalcWork && 0 === this._idleQueue.length && 0 === this._indexQueue.length && 0 === this._loadingNodes.size && (this._recalcWork = !1, this._setUpdateViewNeeded());\n    }), this._updateLoading();else for (const t of e.remove) this._removeFromRenderer(t);\n  }\n\n  async populateClassCodeCodedDomain(e, i) {\n    const r = \"CLASS_CODE\",\n          s = this.layer.fieldsIndex.get(r);\n    if (!s || s.domain) return;\n    if (-1 === e.indexOf(s.name)) return;\n    const o = await t(this.layer.queryCachedStatistics(r, {\n      signal: i\n    }));\n    if (!1 === o.ok) return;\n    const n = o.value,\n          a = n && n.labels && n.labels.labels;\n    a && Array.isArray(a) && (s.domain = new ne({\n      name: \"CLASS_CODE\",\n      codedValues: a.map(e => new k({\n        code: e.value,\n        name: e.label\n      }))\n    }));\n  }\n\n  async prepareFetchPopupFeatures(e) {\n    return this._codedDomainPopulationPromise || (this._codedDomainPopulationAbortController = l(), this._codedDomainPopulationPromise = this.populateClassCodeCodedDomain(e, this._codedDomainPopulationAbortController.signal).then(() => {\n      this._codedDomainPopulationAbortController = null;\n    })), this._codedDomainPopulationPromise;\n  }\n\n  async whenGraphicAttributes(e, t) {\n    const r = this._splitGraphicsPerNode(e),\n          s = this.layer.attributeStorageInfo,\n          o = t.map(e => q(s, e)),\n          n = async (e, t) => {\n      const r = this._index.getNode(t);\n\n      await i(o, async t => {\n        const i = t.useElevation ? await this._loadElevationAttributeFromGeometry(r.resourceId) : await this._loadAndParseAttribute(r, t);\n        if (i) for (const r of e) if (this._isValidPointGraphic(r)) {\n          const e = r.pointCloudMetadata.attributePointIndexInNode;\n\n          this._encodeGraphicAttribute(t, i, e, r.attributes);\n        }\n      });\n    },\n          a = [];\n\n    return r.forEach((e, t) => {\n      a.push(n(e, t));\n    }), await h(a), e;\n  }\n\n  _isValidPointGraphic(e) {\n    return e instanceof K && e.pointCloudMetadata && e.pointCloudMetadata.epoch === this._nodeLoadEpoch;\n  }\n\n  _splitGraphicsPerNode(e) {\n    const t = new Map();\n\n    for (const i of e) {\n      if (!this._isValidPointGraphic(i)) continue;\n      const e = i.pointCloudMetadata,\n            r = t.get(e.nodeId);\n      r ? r.push(i) : t.set(e.nodeId, [i]);\n    }\n\n    return t;\n  }\n\n  async _loadAndParseAttribute(e, t) {\n    const i = await this._loadAttribute(e.resourceId, t, null);\n    return n(i) ? T({\n      attributeInfo: t,\n      buffer: i\n    }, null, e.vertexCount) : null;\n  }\n\n  async _loadElevationAttributeFromGeometry(e) {\n    const t = this.layer.store.defaultGeometrySchema,\n          i = $(t, await this._loadGeometry(e, null));\n    return J(i, i.length / 3);\n  }\n\n  highlight(e) {\n    if (!e) return {\n      remove() {}\n\n    };\n    const t = r.isCollection(e) ? e.toArray() : Array.isArray(e) ? e : [e];\n    return this._renderer.highlight(t.map(e => this._graphicToPointDefinition(e)));\n  }\n\n  _graphicToPointDefinition(e) {\n    if (!this._isValidPointGraphic(e)) return null;\n    const {\n      nodeId: t,\n      pointIndexInNode: i\n    } = e.pointCloudMetadata;\n    return null != t && null != i ? {\n      nodeId: t,\n      pointId: i\n    } : null;\n  }\n\n  _computeWork() {\n    let e = 0;\n\n    for (const t of this._workQueue) e += t.load.length + t.remove.length;\n\n    return e += this._loadingNodes.size, e += (this._indexQueue.length + this._indexPagesLoading.size) * this._index.pageSize, e += this._loadingInitNodePage ? 100 : 0, e += this._updateViewNeeded ? 100 : 0, e;\n  }\n\n  get updatingProgressValue() {\n    if (this.suspended) return this._updateViewNeeded ? 0 : 1;\n\n    const e = this._computeWork();\n\n    return 1 - Math.min(this._totalWork, e) / this._totalWork;\n  }\n\n  _updateLoading() {\n    this.notifyChange(\"updating\"), this.notifyChange(\"updatingProgressValue\");\n  }\n\n  canResume() {\n    return super.canResume() && this._layerIsVisible;\n  }\n\n  isUpdating() {\n    return this.suspended ? this._updateViewNeeded : this._computeWork() > 0;\n  }\n\n  _initNodePages() {\n    const e = this.layer.store.index,\n          t = e.nodesPerPage || e.nodePerIndexBlock;\n    return this._index = new W(this.layer.spatialReference, this.view.renderCoordsHelper.spatialReference, t), this._cancelIndexLoading(), this._traverseVisible = this._index.createVisibilityTraverse(), this._loadingInitNodePage = !0, this._layerIsVisible = !0, this.notifyChange(\"suspended\"), this._updateLoading(), this._pageMultiplier = null != e.nodesPerPage ? 1 : e.nodePerIndexBlock, this._loadNodePage(0).promise.then(e => {\n      this._index.addPage(0, e, this._elevationOffset), this._loadingInitNodePage = !1, this._setUpdateViewNeeded();\n    });\n  }\n\n  _loadNodePage(e) {\n    const t = l(),\n          i = `${this.baseUrl}/nodepages/${e * this._pageMultiplier}`;\n    return {\n      promise: this._requestNodePage(i, t.signal).then(t => t.nodes.map((t, i) => ({\n        resourceId: null != t.resourceId ? t.resourceId : e * this._index.pageSize + i,\n        obb: t.obb,\n        firstChild: t.firstChild,\n        childCount: t.childCount,\n        vertexCount: null != t.vertexCount ? t.vertexCount : t.pointCount,\n        lodThreshold: null != t.lodThreshold ? t.lodThreshold : t.effectiveArea\n      }))),\n      abortController: t\n    };\n  }\n\n  _updateWorkQueues() {\n    if (!this._updateViewNeeded) return !1;\n\n    let e = this.inverseDensity / this._lodFactor * this._getLodMemoryFactor();\n\n    const t = this.maximumPointCount * this._lodFactor * this._getLodMemoryFactor();\n\n    let i = this._computeNodesForMinimumDensity(e),\n        r = this._computePointCount(i),\n        s = Math.sqrt(r / (.75 * t));\n\n    for (; r > t;) e *= s, i = this._computeNodesForMinimumDensity(e), r = this._computePointCount(i), s = Math.sqrt(2);\n\n    return this.displayNodes(i), this._updateViewNeeded = !1, this._updateLoading(), !0;\n  }\n\n  _computePointCount(e) {\n    let t = 0;\n\n    for (let i = 0; i < e.length; i++) {\n      const r = this._index.getNode(e[i]);\n\n      r && (t += r.vertexCount);\n    }\n\n    return t;\n  }\n\n  _getLodMemoryFactor() {\n    return this.view.resourceController.memoryController.memoryFactor;\n  }\n\n  _isRootNodeVisible() {\n    let e = !1;\n    return this._traverseVisible({\n      frustum: this.view.state.contentCamera.frustum,\n      clippingBox: this._clippingBox\n    }, {\n      predicate: (t, i, r) => (e = r, !1),\n      pageMiss: () => {}\n    }), e;\n  }\n\n  _computeNodesForMinimumDensity(e) {\n    const t = this.view.state.contentCamera,\n          i = t.frustum,\n          r = this._clippingBox,\n          s = t.viewForward,\n          o = w(s, t.eye),\n          n = I(s, -o, le),\n          a = t.perScreenPixelRatio / 2,\n          d = e * e,\n          l = this._nodeIdArray;\n    l.length = 0;\n    const {\n      minScale: h,\n      maxScale: u\n    } = re(this.layer),\n          p = 0 === h && 0 === u ? e => l.push(e) : e => {\n      const t = this._getScale(e);\n\n      se(t, h, u) && l.push(e);\n    };\n    return this._traverseVisible({\n      frustum: i,\n      clippingBox: r\n    }, {\n      predicate: (e, t, i) => {\n        if (!i) return !1;\n        if (0 === t.childCount) return p(e), !1;\n\n        const r = this._index.getRenderObb(e);\n\n        return !(this._computeAveragePixelArea(r, t.lodThreshold, t.vertexCount, n, a) <= d) || (p(e), !1);\n      },\n      pageMiss: (e, t) => {\n        p(e), this._indexQueue.indexOf(t) < 0 && this._indexQueue.push(t);\n      }\n    }), l;\n  }\n\n  _getScale(e) {\n    let t = this._nodeScales.get(e);\n\n    if (null == t) {\n      const i = this._index.getNode(e).obb.center;\n\n      this._tmpPoint.x = i[0], this._tmpPoint.y = i[1], this._tmpPoint.z = i[2], t = this.view.basemapTerrain.getScale(this._tmpPoint), this._nodeScales.set(e, t);\n    }\n\n    return t;\n  }\n\n  _computeAveragePixelArea(e, t, i, r, s) {\n    const o = 1e-7,\n          n = Math.max(o, ee(e, r));\n    return t / (n * n) / (4 * s * s) / i;\n  }\n\n  loadNode(e, t) {\n    try {\n      return this.loadNodeAsync(e, t);\n    } catch (i) {\n      throw u(i) || ae.error(i), i;\n    }\n  }\n\n  async loadAdditionalUserAttributes(e, t, i) {\n    const r = this.layer.outFields;\n    if (!r) return [];\n    const s = V(this.layer.fieldsIndex, r),\n          o = new Set(e.map(e => n(e) ? e.name : null)),\n          a = this.layer.attributeStorageInfo,\n          l = [];\n\n    for (const n of s) {\n      if (o.has(n)) continue;\n      const e = q(a, n);\n      e && l.push(t(e));\n    }\n\n    const h = await p(l);\n    return c(i), d(h, e => e);\n  }\n\n  async loadNodeAsync(e, t) {\n    const i = this._index.getNode(e),\n          r = H(this.layer),\n          s = B(this.layer),\n          o = i.resourceId,\n          d = async e => {\n      if (a(e)) return null;\n      if (e.useElevation) return {\n        attributeInfo: e,\n        buffer: null\n      };\n      const i = await this._loadAttribute(o, e, t);\n      return n(i) ? {\n        attributeInfo: e,\n        buffer: i\n      } : null;\n    };\n\n    return this._idleQueue.push(async () => {\n      const i = this._loadGeometry(o, t),\n            {\n        primaryAttribute: n,\n        modulationAttribute: a\n      } = r,\n            l = d(n),\n            h = d(a),\n            u = s.map(e => e.attributeInfo),\n            p = u.map(e => d(e)),\n            _ = this.loadAdditionalUserAttributes([n, a, ...u], d, t),\n            [m, g, f, y, b] = await Promise.all([i, l, h, Promise.all(p), _]);\n\n      c(t);\n      const w = {\n        geometryBuffer: m,\n        primaryAttributeData: g,\n        modulationAttributeData: f,\n        filterAttributesData: y,\n        userAttributesData: b,\n        schema: this.layer.store.defaultGeometrySchema,\n        rendererInfo: r,\n        filterInfo: s,\n        obb: this._index.getRenderObb(e),\n        elevationOffset: this._elevationOffset,\n        inSR: this.layer.spatialReference.toJSON(),\n        outSR: this.view.renderCoordsHelper.spatialReference.toJSON()\n      };\n      return this._worker.invoke(w, t);\n    }, t);\n  }\n\n  async _loadGeometry(e, t) {\n    return this._requestData(`${this.baseUrl}/nodes/${e}/geometries/0`, t);\n  }\n\n  async _loadAttribute(e, t, i) {\n    if (a(t) || !t.storageInfo) return null;\n    const r = t.storageInfo.key;\n    return this._requestData(`${this.baseUrl}/nodes/${e}/attributes/${r}`, i);\n  }\n\n  _requestNodePage(e, t) {\n    const i = {\n      f: \"json\",\n      token: this.layer.apiKey\n    };\n    return this._indexRequester.request(e, \"json\", {\n      query: i,\n      signal: t\n    });\n  }\n\n  _requestData(e, t) {\n    return this._dataRequester.request(e, \"binary\", {\n      query: {\n        token: this.layer.apiKey\n      },\n      signal: t\n    });\n  }\n\n  _removeFromRenderer(e) {\n    if (this._renderedNodes.has(e)) {\n      const t = this._renderer.removeNode(e);\n\n      this._renderedNodes.delete(e), this._nodeScales.delete(e), this._memCache.put(t.id.toString(), t, ue(t));\n    }\n  }\n\n  _addToRenderer(e) {\n    this._renderedNodes.has(e.id) || (this._renderedNodes.add(e.id), this._renderer.addNode(e));\n  }\n\n  _setupRendererData(e, t) {\n    const i = this._index.getNode(e),\n          r = Math.sqrt(i.lodThreshold / i.vertexCount),\n          s = this._index.getRenderObb(e);\n\n    if (Y.isInstanceOfNode(t)) return t.splatSize = r, t.obb = s, t.origin = N(t.obb.center), t;\n    const o = .01 * Math.max(s.halfSize[0], s.halfSize[1], s.halfSize[2]);\n\n    if (t.obb.halfSize[0] > s.halfSize[0] + o || t.obb.halfSize[1] > s.halfSize[1] + o || t.obb.halfSize[2] > s.halfSize[2] + o) {\n      if (this._maxLoggedBoxWarnings > 0) {\n        const i = e => `[${e.halfSize[0]}, ${e.halfSize[1]}, ${e.halfSize[2]}]`;\n\n        ae.warn(`Node ${e} reported bounding box too small. got ${i(s)} but points cover ${i(t.obb)}`), 0 == --this._maxLoggedBoxWarnings && ae.warn(\"  Too many bounding box errors, stopping reporting for this layer.\");\n      }\n\n      this._index.setRenderObb(e, t.obb);\n    }\n\n    return {\n      id: e,\n      coordinates: t.points,\n      origin: N(s.center),\n      rgb: t.rgb,\n      attributes: t.attributes,\n      pointIdFilterMap: t.pointIdFilterMap,\n      highlights: null,\n      splatSize: r,\n      obb: s,\n      isLeaf: 0 === i.childCount\n    };\n  }\n\n  getUsedMemory() {\n    let e = 0;\n    return this._renderer.forEachNode(t => {\n      e += ce, e += m(t.coordinates);\n\n      for (const i of t.attributes) {\n        const t = i.values;\n        g(t.buffer) && (e += m(t));\n      }\n    }), e;\n  }\n\n  getUnloadedMemory() {\n    const e = this._renderedNodes.size;\n    if (e < 4) return 0;\n    const t = [...this._renderedNodes].reduce((e, t) => e + this._index.getNode(t).vertexCount);\n    let i = this._loadingNodes.size;\n\n    for (let r = 0; r < this._workQueue.length; r++) i += this._workQueue[r].load.length, i -= this._workQueue[r].remove.length;\n\n    if (i < 0) return 0;\n    return i * t / e * ((this.getUsedMemory() - e * ce) / t) + i * ce;\n  }\n\n  ignoresMemoryFactor() {\n    return !1;\n  }\n\n  get performanceInfo() {\n    return {\n      nodes: this._renderedNodes.size,\n      displayedNumberOfFeatures: [...this._renderedNodes].reduce((e, t) => e + this._index.getNode(t).vertexCount, 0),\n      maximumNumberOfFeatures: this.maximumPointCount,\n      totalNumberOfFeatures: -1,\n      core: null,\n      \"Loading Nodes\": this._loadingNodes.size,\n      \"Index Queue\": this._indexQueue.length,\n      \"Work Queue\": this._workQueue.length,\n      \"Idle Queue\": this._idleQueue.length\n    };\n  }\n\n  get test() {\n    return {\n      index: this._index,\n      visibleNodes: this._renderedNodes\n    };\n  }\n\n};\n\nfunction ue(e) {\n  return 5 * e.coordinates.length + 128;\n}\n\ne([y()], he.prototype, \"layer\", void 0), e([y({\n  readOnly: !0,\n  aliasOf: \"layer.parsedUrl.path\"\n})], he.prototype, \"baseUrl\", void 0), e([y({\n  readOnly: !0\n})], he.prototype, \"pointScale\", null), e([y({\n  readOnly: !0\n})], he.prototype, \"useRealWorldSymbolSizes\", null), e([y({\n  readOnly: !0\n})], he.prototype, \"pointSize\", null), e([y({\n  readOnly: !0\n})], he.prototype, \"inverseDensity\", null), e([y()], he.prototype, \"maximumPointCount\", void 0), e([y({\n  readOnly: !0\n})], he.prototype, \"availableFields\", null), e([y({\n  readOnly: !0\n})], he.prototype, \"_clippingBox\", null), e([y({\n  readOnly: !0\n})], he.prototype, \"_elevationOffset\", null), e([y({\n  type: Boolean\n})], he.prototype, \"slicePlaneEnabled\", void 0), e([y()], he.prototype, \"updating\", void 0), e([y(te)], he.prototype, \"updatingProgress\", void 0), e([y({\n  readOnly: !0\n})], he.prototype, \"updatingProgressValue\", null), he = e([b(\"esri.views.3d.layers.PointCloudLayerView3D\")], he);\nconst pe = C(),\n      ce = 160;\nvar _e = he;\nexport default _e;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/layers/PointCloudLayerView3D.js"],"names":["_","e","result","t","forEach","i","r","s","unwrapOr","o","isSome","n","isNone","a","mapSome","d","createAbortController","l","eachAlways","h","isAbortError","u","eachAlwaysValues","p","throwIfAborted","c","pt2px","estimateSize","m","isArrayBuffer","g","getMetersPerVerticalUnitForSR","f","property","y","subclass","b","w","N","projectBoundingRect","x","create","P","containsPoint","v","C","S","fromNormalAndOffset","I","makeDehydratedPoint","A","k","unpackFieldNames","V","R","getMetersPerUnit","L","LayerView3D","Q","PointCloudWorkerHandle","U","checkPointCloudLayerValid","j","checkPointCloudLayerCompatibleWithView","D","nodeDiff","F","sortFrontToBack","z","splitWorkEntries","M","W","getSplatSizeAlgorithm","O","getFixedSizeAlgorithm","E","getRendererInfo","H","getFilterInfo","B","rendererUsesFixedSizes","G","getAttributeInfo","q","getAttributeValues","T","readGeometry","$","elevationFromPositions","J","PointGraphic","K","PointRenderer","Y","PopupSceneLayerView","X","projectToBoundingBox","Z","minimumDistancePlane","ee","updatingProgress","te","ie","extractSafeScaleBounds","re","scaleBoundsPredicate","se","TaskPriority","oe","ne","ae","getLogger","de","le","he","constructor","arguments","type","maximumPointCount","slicePlaneEnabled","_renderer","_rendererAdded","_renderedNodes","Set","_nodeScales","Map","_updateViewNeeded","_lodFactor","_maxLoggedBoxWarnings","_pageMultiplier","_nodeLoadEpoch","_indexQueue","_workQueue","Array","_idleQueue","_indexPagesLoading","_loadingNodes","_recalcWork","_layerIsVisible","_codedDomainPopulationPromise","_codedDomainPopulationAbortController","_totalWork","_index","_loadingInitNodePage","_nodeIdArray","pointScale","layer","renderer","scaleFactor","useRealWorldSymbolSizes","pointSize","size","inverseDensity","pointsPerInch","availableFields","primaryAttribute","add","name","modulationAttribute","attributeInfo","outFields","fieldsIndex","from","_clippingBox","view","clippingArea","renderSpatialReference","_elevationOffset","elevationInfo","mode","spatialReference","unit","offset","initialize","resourceController","_worker","schedule","addResolvingPromise","promise","_tmpPoint","_indexRequester","createStreamDataRequester","_dataRequester","_initRenderer","_initNodePages","memoryController","_memCache","getMemCache","uid","updatingHandles","_setUpdateViewNeeded","_elevationOffsetChanged","_rendererChanged","_reload","state","handles","basemapTerrain","on","_scaleUpdateHandler","events","when","scheduler","registerTask","POINT_CLOUD_LAYER","registerIdleStateCallbacks","_idleBegin","_idleEnd","_clearNodeState","removeAll","_updateLoading","destroy","cancelLoading","_destroyRenderer","abort","createGraphic","_createGraphic","layerUid","clippingBox","_setPointsVisible","minSizePx","Math","sqrt","sizePx","slicePlane","pointIdFilterMap","computeMapPointFromVec3d","_createGraphicAttributes","pointCloudMetadata","nodeId","id","pointIndexInNode","attributePointIndexInNode","epoch","geometry","attributes","sourceLayer","_encodeGraphicAttribute","values","storageInfo","attributeValues","valuesPerElement","valueType","_stage","addRenderPlugin","removeRenderPlugin","useFixedSizes","clear","minScale","maxScale","extent","pe","has","delete","getNode","obb","center","set","scale","displayNodes","contentCamera","viewForward","_updateQueues","_computeWork","length","notifyChange","_cancelNodeLoading","_cancelIndexLoading","abortController","push","cancelAll","load","filter","_removeFromRenderer","running","suspended","runTask","_isRootNodeVisible","run","_updateWorkQueues","_processIndexQueue","_processWorkQueue","process","shift","_loadNodePage","then","addPage","done","_scheduleWorkEntry","_processWorkEntry","madeProgress","remove","find","Promise","all","map","pop","toString","resolve","loadNode","signal","get","_setupRendererData","_addToRenderer","catch","populateClassCodeCodedDomain","domain","indexOf","queryCachedStatistics","ok","value","labels","isArray","codedValues","code","label","prepareFetchPopupFeatures","whenGraphicAttributes","_splitGraphicsPerNode","attributeStorageInfo","useElevation","_loadElevationAttributeFromGeometry","resourceId","_loadAndParseAttribute","_isValidPointGraphic","_loadAttribute","buffer","vertexCount","store","defaultGeometrySchema","_loadGeometry","highlight","isCollection","toArray","_graphicToPointDefinition","pointId","pageSize","updatingProgressValue","min","canResume","isUpdating","index","nodesPerPage","nodePerIndexBlock","renderCoordsHelper","_traverseVisible","createVisibilityTraverse","baseUrl","_requestNodePage","nodes","firstChild","childCount","pointCount","lodThreshold","effectiveArea","_getLodMemoryFactor","_computeNodesForMinimumDensity","_computePointCount","memoryFactor","frustum","predicate","pageMiss","eye","perScreenPixelRatio","_getScale","getRenderObb","_computeAveragePixelArea","getScale","max","loadNodeAsync","error","loadAdditionalUserAttributes","geometryBuffer","primaryAttributeData","modulationAttributeData","filterAttributesData","userAttributesData","schema","rendererInfo","filterInfo","elevationOffset","inSR","toJSON","outSR","invoke","_requestData","key","token","apiKey","request","query","removeNode","put","ue","addNode","isInstanceOfNode","splatSize","origin","halfSize","warn","setRenderObb","coordinates","points","rgb","highlights","isLeaf","getUsedMemory","forEachNode","ce","getUnloadedMemory","reduce","ignoresMemoryFactor","performanceInfo","displayedNumberOfFeatures","maximumNumberOfFeatures","totalNumberOfFeatures","core","test","visibleNodes","prototype","readOnly","aliasOf","Boolean","_e"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import{result as t,forEach as i}from\"../../../core/asyncUtils.js\";import r from\"../../../core/Collection.js\";import s from\"../../../core/Logger.js\";import{unwrapOr as o,isSome as n,isNone as a,mapSome as d}from\"../../../core/maybe.js\";import{createAbortController as l,eachAlways as h,isAbortError as u,eachAlwaysValues as p,throwIfAborted as c}from\"../../../core/promiseUtils.js\";import{pt2px as _}from\"../../../core/screenUtils.js\";import{estimateSize as m,isArrayBuffer as g}from\"../../../core/typedArrayUtil.js\";import{getMetersPerVerticalUnitForSR as f}from\"../../../core/unitUtils.js\";import{property as y}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import{subclass as b}from\"../../../core/accessorSupport/decorators/subclass.js\";import{d as w}from\"../../../chunks/vec3.js\";import{a as N}from\"../../../chunks/vec3f32.js\";import{projectBoundingRect as x}from\"../../../geometry/projection.js\";import{create as P}from\"../../../geometry/support/aaBoundingBox.js\";import{containsPoint as v,create as C}from\"../../../geometry/support/aaBoundingRect.js\";import{create as S,fromNormalAndOffset as I}from\"../../../geometry/support/plane.js\";import{makeDehydratedPoint as A}from\"../../../layers/graphics/dehydratedFeatures.js\";import k from\"../../../layers/support/CodedValue.js\";import\"../../../layers/support/domains.js\";import{unpackFieldNames as V}from\"../../../layers/support/fieldUtils.js\";import R from\"../../../layers/support/PromiseQueue.js\";import{getMetersPerUnit as L}from\"../../../symbols/support/unitConversionUtils.js\";import{LayerView3D as Q}from\"./LayerView3D.js\";import{PointCloudWorkerHandle as U}from\"./PointCloudWorkerHandle.js\";import{checkPointCloudLayerValid as j,checkPointCloudLayerCompatibleWithView as D}from\"./i3s/I3SUtil.js\";import{nodeDiff as F,sortFrontToBack as z,splitWorkEntries as M}from\"./i3s/LoDUtil.js\";import W from\"./i3s/PagedNodeIndex.js\";import{getSplatSizeAlgorithm as O,getFixedSizeAlgorithm as E,getRendererInfo as H,getFilterInfo as B,rendererUsesFixedSizes as G,getAttributeInfo as q}from\"./i3s/PointCloudRendererUtil.js\";import{getAttributeValues as T,readGeometry as $,elevationFromPositions as J}from\"./i3s/PointCloudWorkerUtil.js\";import{PointGraphic as K}from\"./i3s/PointGraphic.js\";import{PointRenderer as Y}from\"./i3s/PointRenderer.js\";import{PopupSceneLayerView as X}from\"./support/PopupSceneLayerView.js\";import{projectToBoundingBox as Z}from\"../support/extentUtils.js\";import{minimumDistancePlane as ee}from\"../support/orientedBoundingBox.js\";import{updatingProgress as te}from\"../support/updatingProperties.js\";import ie from\"../../layers/LayerView.js\";import{extractSafeScaleBounds as re,scaleBoundsPredicate as se}from\"../../support/layerViewUtils.js\";import{TaskPriority as oe}from\"../../support/Scheduler.js\";import ne from\"../../../layers/support/CodedValueDomain.js\";const ae=s.getLogger(\"esri.views.3d.layers.PointCloudLayerView3D\"),de=8,le=S();let he=class extends(X(Q(ie))){constructor(){super(...arguments),this.type=\"point-cloud-3d\",this.maximumPointCount=4e6,this.slicePlaneEnabled=!1,this._renderer=null,this._rendererAdded=!1,this._renderedNodes=new Set,this._nodeScales=new Map,this._updateViewNeeded=!0,this._lodFactor=1,this._maxLoggedBoxWarnings=5,this._pageMultiplier=1,this._nodeLoadEpoch=0,this._indexQueue=[],this._workQueue=new Array,this._idleQueue=new R,this._indexPagesLoading=new Map,this._loadingNodes=new Map,this._recalcWork=!0,this._layerIsVisible=!1,this._codedDomainPopulationPromise=null,this._codedDomainPopulationAbortController=null,this._totalWork=0,this._index=null,this._loadingInitNodePage=!1,this._nodeIdArray=[]}get pointScale(){const e=O(this.layer&&this.layer.renderer),t=1;return e&&null!=e.scaleFactor?e.scaleFactor:t}get useRealWorldSymbolSizes(){const e=E(this.layer&&this.layer.renderer),t=!1;return e&&null!=e.useRealWorldSymbolSizes?e.useRealWorldSymbolSizes:t}get pointSize(){const e=E(this.layer&&this.layer.renderer),t=0;return e&&null!=e.size?e.size:t}get inverseDensity(){const e=96;return this.layer&&this.layer.renderer?1*e/this.layer.renderer.pointsPerInch:5}get availableFields(){const e=H(this.layer),t=new Set;e.primaryAttribute&&t.add(e.primaryAttribute.name),e.modulationAttribute&&t.add(e.primaryAttribute.name);const i=B(this.layer);if(i)for(const r of i)t.add(r.attributeInfo.name);if(this.layer.outFields)for(const r of V(this.layer.fieldsIndex,this.layer.outFields))t.add(r);return Array.from(t)}get _clippingBox(){if(!this.view||!this.view.clippingArea)return null;const e=P(),t=this.view.renderSpatialReference;return Z(this.view.clippingArea,e,t)?e:null}get _elevationOffset(){const e=this.layer&&this.layer.elevationInfo;if(e&&\"absolute-height\"===e.mode){const t=f(this.layer.spatialReference),i=L(e.unit);return o(e.offset,0)*i/t}return 0}initialize(){const e=this.view.resourceController;this._worker=new U((t=>e.schedule(t))),this.addResolvingPromise(this._worker.promise),this._tmpPoint=A(0,0,0,this.layer.spatialReference),j(this.layer),D(this.layer,this.view),this._indexRequester=e.createStreamDataRequester(2),this._dataRequester=e.createStreamDataRequester(3),this._initRenderer();const t=this._initNodePages(),i=this.view.resourceController.memoryController;this._memCache=i.getMemCache(this.layer.uid),this.updatingHandles.add(this,\"_clippingBox\",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this,\"_elevationOffset\",(()=>this._elevationOffsetChanged()),2),this.updatingHandles.add(this.layer,\"renderer\",(()=>this._rendererChanged()),2),this.updatingHandles.add(this.layer,\"filters\",(()=>this._reload()),2),this.updatingHandles.add(this.layer,\"outFields\",(()=>this._reload()),2),this.updatingHandles.add(this.layer,\"scaleRangeId\",(()=>this._setUpdateViewNeeded())),this.updatingHandles.add(this,\"clippingArea\",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this.view.state,\"contentCamera\",(()=>this._setUpdateViewNeeded())),this.handles.add([this.view.basemapTerrain.on(\"scale-change\",(e=>this._scaleUpdateHandler(e))),i.events.on(\"quality-changed\",(()=>this._setUpdateViewNeeded()))]),this.addResolvingPromise(t),this.when((()=>{this.handles.add([e.scheduler.registerTask(oe.POINT_CLOUD_LAYER,this),e.scheduler.registerIdleStateCallbacks((()=>this._idleBegin()),(()=>this._idleEnd())),this.updatingHandles.add(this,\"suspended\",(e=>{e?this._clearNodeState():this._setUpdateViewNeeded()}),2)])}),(()=>{this.updatingHandles.removeAll(),this.handles.removeAll()}))}_setUpdateViewNeeded(){this._updateViewNeeded=!0,this._updateLoading()}destroy(){this.cancelLoading(),this._worker&&(this._worker.destroy(),this._worker=null),this._destroyRenderer(),this._memCache.destroy(),this._memCache=null,this._codedDomainPopulationAbortController&&(this._codedDomainPopulationAbortController.abort(),this._codedDomainPopulationAbortController=null),this._codedDomainPopulationPromise=null}_initRenderer(){this._renderer=new Y({createGraphic:(e,t,i)=>this._createGraphic(e,t,i)}),this._renderer.layerUid=this.layer.uid,this.updatingHandles.add(this,\"_clippingBox\",(e=>this._renderer.clippingBox=e),2),this.updatingHandles.add(this,\"suspended\",(e=>this._setPointsVisible(!e)),2),this.updatingHandles.add(this,\"pointScale\",(e=>this._renderer.scaleFactor=e),2),this._renderer.minSizePx=Math.sqrt(2),this.updatingHandles.add(this,\"useRealWorldSymbolSizes\",(e=>this._renderer.useRealWorldSymbolSizes=e),2),this.updatingHandles.add(this,\"pointSize\",(e=>{const t=_(e);this._renderer.size=e,this._renderer.sizePx=t}),2),this.updatingHandles.add(this,\"slicePlaneEnabled\",(e=>this._renderer.slicePlane=e),2),this.updatingHandles.add(this,\"inverseDensity\",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this,\"maximumPointCount\",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this.view,\"qualitySettings.sceneService.pointCloud.lodFactor\",(e=>{this._lodFactor=e,this._setUpdateViewNeeded()}),2)}_destroyRenderer(){this._renderer.removeAll(),this._setPointsVisible(!1)}_createGraphic(e,t,i){const r=n(e.pointIdFilterMap)?e.pointIdFilterMap[t]:t,s=this.view.computeMapPointFromVec3d(i),o=this._createGraphicAttributes(e,r);return new K({pointCloudMetadata:{nodeId:e.id,pointIndexInNode:t,attributePointIndexInNode:r,epoch:this._nodeLoadEpoch},geometry:s,attributes:o,layer:this.layer,sourceLayer:this.layer})}_createGraphicAttributes(e,t){const i={};for(const r of e.attributes)this._encodeGraphicAttribute(r.attributeInfo,r.values,t,i);return i}_encodeGraphicAttribute(e,t,i,r){const s=e.storageInfo&&e.storageInfo.attributeValues,o=s?s.valuesPerElement:1;if(1===o)r[e.name]=t[i];else if(\"UInt8\"===s.valueType&&o<=4){let s=0;const n=i*o;for(let e=n;e<n+o;e++)s=(s<<8)+t[e];r[e.name]=s}else r[e.name]=void 0}_setPointsVisible(e){e&&!this._rendererAdded?(this.view._stage.addRenderPlugin([4],this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)}_rendererChanged(){this._renderer.useFixedSizes=G(this.layer.renderer),this._reload()}_reload(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()}_elevationOffsetChanged(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()}_scaleUpdateHandler(e){this.layer.minScale||this.layer.maxScale?x(e.extent,e.spatialReference,pe,this.layer.spatialReference)&&(this._nodeScales.forEach(((t,i)=>{if(!this._renderedNodes.has(i))return void this._nodeScales.delete(i);const r=this._index.getNode(i);v(pe,r.obb.center)&&this._nodeScales.set(i,e.scale)})),this._setUpdateViewNeeded()):this._nodeScales.clear()}displayNodes(e){this._workQueue=F([...this._renderedNodes],e,this._index),z(this._workQueue,this.view.state.contentCamera.viewForward,this._index),M(this._workQueue,de,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange(\"suspended\")}cancelLoading(){this._cancelNodeLoading(),this._cancelIndexLoading()}_cancelNodeLoading(){const e=new Array;this._loadingNodes.forEach((({abortController:t})=>e.push(t))),this._loadingNodes.clear();for(const t of e)t.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()}_updateQueues(){const e=new Set;this._workQueue.forEach((t=>t.load.forEach((t=>e.add(t)))));const t=new Array,i=new Map;this._loadingNodes.forEach(((r,s)=>{e.has(s)?i.set(s,r):t.push(r)})),this._loadingNodes=i;for(const{abortController:r}of t)r.abort();this._workQueue=this._workQueue.filter((e=>{for(const t of e.load)if(this._loadingNodes.has(t))return this._recalcWork=!0,!1;return!0})),this._totalWork=this._computeWork(),this._updateLoading()}_cancelIndexLoading(){this._indexQueue=[],this._indexPagesLoading.forEach((({abortController:e})=>e.abort())),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()}_clearNodeState(){this._nodeLoadEpoch++,this._renderedNodes.forEach((e=>this._removeFromRenderer(e))),this._cancelNodeLoading()}_idleBegin(){this._setUpdateViewNeeded()}_idleEnd(){this._setUpdateViewNeeded()}get running(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.length>0}runTask(e){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;const e=this._isRootNodeVisible();e!==this._layerIsVisible&&(this._layerIsVisible=e,this.notifyChange(\"suspended\")),this._updateLoading()}}else{for(e.run((()=>this._updateWorkQueues()));this._indexQueue.length>0&&e.run((()=>this._processIndexQueue())););for(this._processWorkQueue(e);this._idleQueue.length>0&&e.run((()=>this._idleQueue.process())););}}_processIndexQueue(){const e=this._indexQueue.shift(),t=this._loadNodePage(e);return this._indexPagesLoading.set(e,t),t.promise.then((t=>{this._index.addPage(e,t,this._elevationOffset),this._setUpdateViewNeeded()})).then((()=>{this._indexPagesLoading.delete(e)}),(()=>{this._indexPagesLoading.delete(e)})),!0}_processWorkQueue(e){for(;!e.done;){const t=this._scheduleWorkEntry();if(a(t))return;this._processWorkEntry(t),e.madeProgress()}}_scheduleWorkEntry(){let e=this._workQueue.length;for(;e--;){const e=this._workQueue.shift();if(!e.remove.find((e=>!this._renderedNodes.has(e))))return e;this._workQueue.push(e)}return null}_processWorkEntry(e){if(0!==e.load.length)Promise.all(e.load.map((e=>{const t=l(),i=this._memCache.pop(e.toString());return n(i)?this._loadingNodes.set(e,{abortController:t,promise:Promise.resolve(i)}):this._loadingNodes.has(e)||this._loadingNodes.set(e,{abortController:t,promise:this.loadNode(e,t.signal)}),this._loadingNodes.get(e).promise}))).then((t=>{for(let i=0;i<e.load.length;i++)if(t[i]){const r=this._setupRendererData(e.load[i],t[i]);this._addToRenderer(r)}for(const i of e.remove)this._removeFromRenderer(i)})).catch((()=>{})).then((()=>{for(const t of e.load)this._loadingNodes.delete(t);this._updateLoading(),this._recalcWork&&0===this._idleQueue.length&&0===this._indexQueue.length&&0===this._loadingNodes.size&&(this._recalcWork=!1,this._setUpdateViewNeeded())})),this._updateLoading();else for(const t of e.remove)this._removeFromRenderer(t)}async populateClassCodeCodedDomain(e,i){const r=\"CLASS_CODE\",s=this.layer.fieldsIndex.get(r);if(!s||s.domain)return;if(-1===e.indexOf(s.name))return;const o=await t(this.layer.queryCachedStatistics(r,{signal:i}));if(!1===o.ok)return;const n=o.value,a=n&&n.labels&&n.labels.labels;a&&Array.isArray(a)&&(s.domain=new ne({name:\"CLASS_CODE\",codedValues:a.map((e=>new k({code:e.value,name:e.label})))}))}async prepareFetchPopupFeatures(e){return this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=l(),this._codedDomainPopulationPromise=this.populateClassCodeCodedDomain(e,this._codedDomainPopulationAbortController.signal).then((()=>{this._codedDomainPopulationAbortController=null}))),this._codedDomainPopulationPromise}async whenGraphicAttributes(e,t){const r=this._splitGraphicsPerNode(e),s=this.layer.attributeStorageInfo,o=t.map((e=>q(s,e))),n=async(e,t)=>{const r=this._index.getNode(t);await i(o,(async t=>{const i=t.useElevation?await this._loadElevationAttributeFromGeometry(r.resourceId):await this._loadAndParseAttribute(r,t);if(i)for(const r of e)if(this._isValidPointGraphic(r)){const e=r.pointCloudMetadata.attributePointIndexInNode;this._encodeGraphicAttribute(t,i,e,r.attributes)}}))},a=[];return r.forEach(((e,t)=>{a.push(n(e,t))})),await h(a),e}_isValidPointGraphic(e){return e instanceof K&&e.pointCloudMetadata&&e.pointCloudMetadata.epoch===this._nodeLoadEpoch}_splitGraphicsPerNode(e){const t=new Map;for(const i of e){if(!this._isValidPointGraphic(i))continue;const e=i.pointCloudMetadata,r=t.get(e.nodeId);r?r.push(i):t.set(e.nodeId,[i])}return t}async _loadAndParseAttribute(e,t){const i=await this._loadAttribute(e.resourceId,t,null);return n(i)?T({attributeInfo:t,buffer:i},null,e.vertexCount):null}async _loadElevationAttributeFromGeometry(e){const t=this.layer.store.defaultGeometrySchema,i=$(t,await this._loadGeometry(e,null));return J(i,i.length/3)}highlight(e){if(!e)return{remove(){}};const t=r.isCollection(e)?e.toArray():Array.isArray(e)?e:[e];return this._renderer.highlight(t.map((e=>this._graphicToPointDefinition(e))))}_graphicToPointDefinition(e){if(!this._isValidPointGraphic(e))return null;const{nodeId:t,pointIndexInNode:i}=e.pointCloudMetadata;return null!=t&&null!=i?{nodeId:t,pointId:i}:null}_computeWork(){let e=0;for(const t of this._workQueue)e+=t.load.length+t.remove.length;return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,e+=this._loadingInitNodePage?100:0,e+=this._updateViewNeeded?100:0,e}get updatingProgressValue(){if(this.suspended)return this._updateViewNeeded?0:1;const e=this._computeWork();return 1-Math.min(this._totalWork,e)/this._totalWork}_updateLoading(){this.notifyChange(\"updating\"),this.notifyChange(\"updatingProgressValue\")}canResume(){return super.canResume()&&this._layerIsVisible}isUpdating(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}_initNodePages(){const e=this.layer.store.index,t=e.nodesPerPage||e.nodePerIndexBlock;return this._index=new W(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,t),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange(\"suspended\"),this._updateLoading(),this._pageMultiplier=null!=e.nodesPerPage?1:e.nodePerIndexBlock,this._loadNodePage(0).promise.then((e=>{this._index.addPage(0,e,this._elevationOffset),this._loadingInitNodePage=!1,this._setUpdateViewNeeded()}))}_loadNodePage(e){const t=l(),i=`${this.baseUrl}/nodepages/${e*this._pageMultiplier}`;return{promise:this._requestNodePage(i,t.signal).then((t=>t.nodes.map(((t,i)=>({resourceId:null!=t.resourceId?t.resourceId:e*this._index.pageSize+i,obb:t.obb,firstChild:t.firstChild,childCount:t.childCount,vertexCount:null!=t.vertexCount?t.vertexCount:t.pointCount,lodThreshold:null!=t.lodThreshold?t.lodThreshold:t.effectiveArea}))))),abortController:t}}_updateWorkQueues(){if(!this._updateViewNeeded)return!1;let e=this.inverseDensity/this._lodFactor*this._getLodMemoryFactor();const t=this.maximumPointCount*this._lodFactor*this._getLodMemoryFactor();let i=this._computeNodesForMinimumDensity(e),r=this._computePointCount(i),s=Math.sqrt(r/(.75*t));for(;r>t;)e*=s,i=this._computeNodesForMinimumDensity(e),r=this._computePointCount(i),s=Math.sqrt(2);return this.displayNodes(i),this._updateViewNeeded=!1,this._updateLoading(),!0}_computePointCount(e){let t=0;for(let i=0;i<e.length;i++){const r=this._index.getNode(e[i]);r&&(t+=r.vertexCount)}return t}_getLodMemoryFactor(){return this.view.resourceController.memoryController.memoryFactor}_isRootNodeVisible(){let e=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:(t,i,r)=>(e=r,!1),pageMiss:()=>{}}),e}_computeNodesForMinimumDensity(e){const t=this.view.state.contentCamera,i=t.frustum,r=this._clippingBox,s=t.viewForward,o=w(s,t.eye),n=I(s,-o,le),a=t.perScreenPixelRatio/2,d=e*e,l=this._nodeIdArray;l.length=0;const{minScale:h,maxScale:u}=re(this.layer),p=0===h&&0===u?e=>l.push(e):e=>{const t=this._getScale(e);se(t,h,u)&&l.push(e)};return this._traverseVisible({frustum:i,clippingBox:r},{predicate:(e,t,i)=>{if(!i)return!1;if(0===t.childCount)return p(e),!1;const r=this._index.getRenderObb(e);return!(this._computeAveragePixelArea(r,t.lodThreshold,t.vertexCount,n,a)<=d)||(p(e),!1)},pageMiss:(e,t)=>{p(e),this._indexQueue.indexOf(t)<0&&this._indexQueue.push(t)}}),l}_getScale(e){let t=this._nodeScales.get(e);if(null==t){const i=this._index.getNode(e).obb.center;this._tmpPoint.x=i[0],this._tmpPoint.y=i[1],this._tmpPoint.z=i[2],t=this.view.basemapTerrain.getScale(this._tmpPoint),this._nodeScales.set(e,t)}return t}_computeAveragePixelArea(e,t,i,r,s){const o=1e-7,n=Math.max(o,ee(e,r));return t/(n*n)/(4*s*s)/i}loadNode(e,t){try{return this.loadNodeAsync(e,t)}catch(i){throw u(i)||ae.error(i),i}}async loadAdditionalUserAttributes(e,t,i){const r=this.layer.outFields;if(!r)return[];const s=V(this.layer.fieldsIndex,r),o=new Set(e.map((e=>n(e)?e.name:null))),a=this.layer.attributeStorageInfo,l=[];for(const n of s){if(o.has(n))continue;const e=q(a,n);e&&l.push(t(e))}const h=await p(l);return c(i),d(h,(e=>e))}async loadNodeAsync(e,t){const i=this._index.getNode(e),r=H(this.layer),s=B(this.layer),o=i.resourceId,d=async e=>{if(a(e))return null;if(e.useElevation)return{attributeInfo:e,buffer:null};const i=await this._loadAttribute(o,e,t);return n(i)?{attributeInfo:e,buffer:i}:null};return this._idleQueue.push((async()=>{const i=this._loadGeometry(o,t),{primaryAttribute:n,modulationAttribute:a}=r,l=d(n),h=d(a),u=s.map((e=>e.attributeInfo)),p=u.map((e=>d(e))),_=this.loadAdditionalUserAttributes([n,a,...u],d,t),[m,g,f,y,b]=await Promise.all([i,l,h,Promise.all(p),_]);c(t);const w={geometryBuffer:m,primaryAttributeData:g,modulationAttributeData:f,filterAttributesData:y,userAttributesData:b,schema:this.layer.store.defaultGeometrySchema,rendererInfo:r,filterInfo:s,obb:this._index.getRenderObb(e),elevationOffset:this._elevationOffset,inSR:this.layer.spatialReference.toJSON(),outSR:this.view.renderCoordsHelper.spatialReference.toJSON()};return this._worker.invoke(w,t)}),t)}async _loadGeometry(e,t){return this._requestData(`${this.baseUrl}/nodes/${e}/geometries/0`,t)}async _loadAttribute(e,t,i){if(a(t)||!t.storageInfo)return null;const r=t.storageInfo.key;return this._requestData(`${this.baseUrl}/nodes/${e}/attributes/${r}`,i)}_requestNodePage(e,t){const i={f:\"json\",token:this.layer.apiKey};return this._indexRequester.request(e,\"json\",{query:i,signal:t})}_requestData(e,t){return this._dataRequester.request(e,\"binary\",{query:{token:this.layer.apiKey},signal:t})}_removeFromRenderer(e){if(this._renderedNodes.has(e)){const t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._nodeScales.delete(e),this._memCache.put(t.id.toString(),t,ue(t))}}_addToRenderer(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e))}_setupRendererData(e,t){const i=this._index.getNode(e),r=Math.sqrt(i.lodThreshold/i.vertexCount),s=this._index.getRenderObb(e);if(Y.isInstanceOfNode(t))return t.splatSize=r,t.obb=s,t.origin=N(t.obb.center),t;const o=.01*Math.max(s.halfSize[0],s.halfSize[1],s.halfSize[2]);if(t.obb.halfSize[0]>s.halfSize[0]+o||t.obb.halfSize[1]>s.halfSize[1]+o||t.obb.halfSize[2]>s.halfSize[2]+o){if(this._maxLoggedBoxWarnings>0){const i=e=>`[${e.halfSize[0]}, ${e.halfSize[1]}, ${e.halfSize[2]}]`;ae.warn(`Node ${e} reported bounding box too small. got ${i(s)} but points cover ${i(t.obb)}`),0==--this._maxLoggedBoxWarnings&&ae.warn(\"  Too many bounding box errors, stopping reporting for this layer.\")}this._index.setRenderObb(e,t.obb)}return{id:e,coordinates:t.points,origin:N(s.center),rgb:t.rgb,attributes:t.attributes,pointIdFilterMap:t.pointIdFilterMap,highlights:null,splatSize:r,obb:s,isLeaf:0===i.childCount}}getUsedMemory(){let e=0;return this._renderer.forEachNode((t=>{e+=ce,e+=m(t.coordinates);for(const i of t.attributes){const t=i.values;g(t.buffer)&&(e+=m(t))}})),e}getUnloadedMemory(){const e=this._renderedNodes.size;if(e<4)return 0;const t=[...this._renderedNodes].reduce(((e,t)=>e+this._index.getNode(t).vertexCount));let i=this._loadingNodes.size;for(let r=0;r<this._workQueue.length;r++)i+=this._workQueue[r].load.length,i-=this._workQueue[r].remove.length;if(i<0)return 0;return i*t/e*((this.getUsedMemory()-e*ce)/t)+i*ce}ignoresMemoryFactor(){return!1}get performanceInfo(){return{nodes:this._renderedNodes.size,displayedNumberOfFeatures:[...this._renderedNodes].reduce(((e,t)=>e+this._index.getNode(t).vertexCount),0),maximumNumberOfFeatures:this.maximumPointCount,totalNumberOfFeatures:-1,core:null,\"Loading Nodes\":this._loadingNodes.size,\"Index Queue\":this._indexQueue.length,\"Work Queue\":this._workQueue.length,\"Idle Queue\":this._idleQueue.length}}get test(){return{index:this._index,visibleNodes:this._renderedNodes}}};function ue(e){return 5*e.coordinates.length+128}e([y()],he.prototype,\"layer\",void 0),e([y({readOnly:!0,aliasOf:\"layer.parsedUrl.path\"})],he.prototype,\"baseUrl\",void 0),e([y({readOnly:!0})],he.prototype,\"pointScale\",null),e([y({readOnly:!0})],he.prototype,\"useRealWorldSymbolSizes\",null),e([y({readOnly:!0})],he.prototype,\"pointSize\",null),e([y({readOnly:!0})],he.prototype,\"inverseDensity\",null),e([y()],he.prototype,\"maximumPointCount\",void 0),e([y({readOnly:!0})],he.prototype,\"availableFields\",null),e([y({readOnly:!0})],he.prototype,\"_clippingBox\",null),e([y({readOnly:!0})],he.prototype,\"_elevationOffset\",null),e([y({type:Boolean})],he.prototype,\"slicePlaneEnabled\",void 0),e([y()],he.prototype,\"updating\",void 0),e([y(te)],he.prototype,\"updatingProgress\",void 0),e([y({readOnly:!0})],he.prototype,\"updatingProgressValue\",null),he=e([b(\"esri.views.3d.layers.PointCloudLayerView3D\")],he);const pe=C(),ce=160;var _e=he;export default _e;\n"]},"metadata":{},"sourceType":"module"}