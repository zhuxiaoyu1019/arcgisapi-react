{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../chunks/tslib.es6.js\";\nimport t from \"../../core/Error.js\";\nimport r from \"../../core/Logger.js\";\nimport { isSome as i, isNone as s } from \"../../core/maybe.js\";\nimport { eachAlways as o } from \"../../core/promiseUtils.js\";\nimport { init as n, on as l } from \"../../core/watchUtils.js\";\nimport { property as a } from \"../../core/accessorSupport/decorators/property.js\";\nimport \"../../core/has.js\";\nimport \"../../core/accessorSupport/ensureType.js\";\nimport { subclass as u } from \"../../core/accessorSupport/decorators/subclass.js\";\nimport { combinedViewLayerTimeExtentProperty as p } from \"../../layers/support/commonProperties.js\";\nimport { fixFields as d, unpackFieldNames as m, collectLabelingFields as c, collectElevationFields as f, collectFilterFields as y, collectFeatureReductionFields as h, collectFields as F, collectField as w, featureHasFields as g } from \"../../layers/support/fieldUtils.js\";\nimport x from \"../../rest/support/Query.js\";\nimport { loadArcade as b } from \"../../support/arcadeOnDemand.js\";\nimport E from \"./support/FeatureEffect.js\";\nimport v from \"./support/FeatureFilter.js\";\nimport { getFetchPopupTemplate as q, getRequiredFields as j } from \"./support/popupUtils.js\";\n\nconst I = r.getLogger(\"esri.views.layers.FeatureLayerView\"),\n      R = r => {\n  let R = class extends r {\n    constructor(...e) {\n      super(...e), this._updatingRequiredFieldsPromise = null, this.effect = null, this.filter = null, this.timeExtent = null, this.layer = null, this.requiredFields = [], this.view = null;\n    }\n\n    initialize() {\n      n(this, [\"layer.renderer\", \"layer.labelingInfo\", \"layer.elevationInfo.featureExpressionInfo\", \"layer.displayField\", \"filter\", \"effect\", \"layer.timeInfo\", \"layer.floorInfo\", \"timeExtent\"], () => this._handleRequiredFieldsChange(), !0), l(this, \"view.floors\", \"change\", () => this._handleRequiredFieldsChange()), l(this, \"layer.sublayer\", \"change\", () => this._handleRequiredFieldsChange());\n    }\n\n    get availableFields() {\n      const {\n        layer: e,\n        layer: {\n          fieldsIndex: t\n        },\n        requiredFields: r\n      } = this;\n      return \"outFields\" in e && e.outFields ? d(t, [...m(t, e.outFields), ...r]) : d(t, r);\n    }\n\n    get maximumNumberOfFeatures() {\n      return 0;\n    }\n\n    set maximumNumberOfFeatures(e) {\n      I.error(\"#maximumNumberOfFeatures=\", \"Setting maximum number of features is not supported\");\n    }\n\n    get maximumNumberOfFeaturesExceeded() {\n      return !1;\n    }\n\n    highlight(e) {\n      throw new Error(\"missing implementation\");\n    }\n\n    createQuery() {\n      const e = {\n        outFields: [\"*\"],\n        returnGeometry: !0,\n        outSpatialReference: this.view.spatialReference\n      },\n            t = i(this.filter) ? this.filter.createQuery(e) : new x(e);\n      return i(this.timeExtent) && (t.timeExtent = i(t.timeExtent) ? t.timeExtent.intersection(this.timeExtent) : this.timeExtent.clone()), t;\n    }\n\n    queryFeatures(e, t) {\n      throw new Error(\"missing implementation\");\n    }\n\n    queryObjectIds(e, t) {\n      throw new Error(\"missing implementation\");\n    }\n\n    queryFeatureCount(e, t) {\n      throw new Error(\"missing implementation\");\n    }\n\n    queryExtent(e, t) {\n      throw new Error(\"missing implementation\");\n    }\n\n    _loadArcadeModules(e) {\n      if (e.get(\"expressionInfos.length\")) return b();\n    }\n\n    _handleRequiredFieldsChange() {\n      const e = this._updateRequiredFields();\n\n      this._set(\"_updatingRequiredFieldsPromise\", e), e.then(() => {\n        this._updatingRequiredFieldsPromise === e && this._set(\"_updatingRequiredFieldsPromise\", null);\n      });\n    }\n\n    async _updateRequiredFields() {\n      if (!this.layer || !this.view) return;\n      const e = \"3d\" === this.view.type,\n            {\n        layer: t,\n        layer: {\n          fieldsIndex: r,\n          objectIdField: s\n        }\n      } = this,\n            n = \"renderer\" in t && t.renderer,\n            l = t.featureReduction,\n            a = new Set(),\n            u = await o([n ? n.collectRequiredFields(a, r) : null, c(a, t), e ? f(a, t) : null, i(this.filter) ? y(a, t, this.filter) : null, this.effect ? y(a, t, this.effect.filter) : null, l ? h(a, t, l) : null]);\n\n      if (t.timeInfo && this.timeExtent && F(a, t.fieldsIndex, [t.timeInfo.startField, t.timeInfo.endField]), \"feature\" === t.type && t.floorInfo && F(a, t.fieldsIndex, [t.floorInfo.floorField]), \"subtype-group\" === t.type) {\n        w(a, r, t.subtypeField);\n        const e = t.sublayers.map(e => {\n          var t;\n          return Promise.all([null == (t = e.renderer) ? void 0 : t.collectRequiredFields(a, r), c(a, e)]);\n        });\n        await o(e);\n      }\n\n      for (const i of u) i.error && I.error(i.error);\n\n      w(a, r, s), e && \"displayField\" in t && t.displayField && w(a, r, t.displayField);\n      const p = Array.from(a).sort();\n\n      this._set(\"requiredFields\", p);\n    }\n\n    validateFetchPopupFeatures(e) {\n      if (s(e)) return null;\n\n      for (const r of e.clientGraphics) {\n        const i = r.layer;\n        if (\"popupEnabled\" in i && !i.popupEnabled) return new t(\"featurelayerview:fetchPopupFeatures\", \"Popups are disabled\", {\n          layer: i\n        });\n\n        if (\"popupTemplate\" in i) {\n          if (!q(i, e)) return new t(\"featurelayerview:fetchPopupFeatures\", \"Layer does not define a popup template\", {\n            layer: i\n          });\n        }\n      }\n    }\n\n    async fetchClientPopupFeatures(e) {\n      const t = i(e) ? e.clientGraphics : null;\n      if (!t || 0 === t.length) return Promise.resolve([]);\n      const r = [],\n            s = [],\n            o = await this.createPopupQuery(e);\n\n      for (const n of t) {\n        const {\n          layer: t\n        } = n;\n        if (!(\"popupEnabled\" in t)) continue;\n        const l = m(this.layer.fieldsIndex, o.outFields),\n              a = q(t, e);\n        if (!i(a)) continue;\n        const u = await this._loadArcadeModules(a);\n        u && u.arcadeUtils.hasGeometryOperations(a) || !g(l, n) ? s.push(n) : r.push(n);\n      }\n\n      return \"stream\" === this.layer.type || 0 === s.length ? Promise.resolve(r) : (o.objectIds = s.map(e => e.attributes[this.layer.objectIdField]), this.layer.queryFeatures(o).then(e => r.concat(e.features)).catch(() => s));\n    }\n\n    async createPopupQuery(e) {\n      const t = this.layer.createQuery(),\n            r = new Set();\n      let s = !1;\n      const o = i(e) && e.clientGraphics ? e.clientGraphics.map(e => e.layer) : [this.layer];\n\n      for (const n of o) {\n        if (!(\"popupEnabled\" in n)) continue;\n        const t = q(n, e);\n        if (!i(t)) continue;\n        const o = await this._loadArcadeModules(t),\n              l = o && o.arcadeUtils.hasGeometryOperations(t);\n        s = !(\"point\" !== this.layer.geometryType && !l);\n        const a = await j(this.layer, t);\n\n        for (const e of a) r.add(e);\n      }\n\n      return t.returnGeometry = s, t.returnZ = s, t.returnM = s, t.outFields = Array.from(r), t.outSpatialReference = this.view.spatialReference, t;\n    }\n\n    canResume() {\n      return !!super.canResume() && (!i(this.timeExtent) || !this.timeExtent.isEmpty);\n    }\n\n  };\n  return e([a()], R.prototype, \"_updatingRequiredFieldsPromise\", void 0), e([a({\n    readOnly: !0\n  })], R.prototype, \"availableFields\", null), e([a({\n    type: E\n  })], R.prototype, \"effect\", void 0), e([a({\n    type: v\n  })], R.prototype, \"filter\", void 0), e([a(p)], R.prototype, \"timeExtent\", void 0), e([a()], R.prototype, \"layer\", void 0), e([a({\n    type: Number\n  })], R.prototype, \"maximumNumberOfFeatures\", null), e([a({\n    readOnly: !0,\n    type: Boolean\n  })], R.prototype, \"maximumNumberOfFeaturesExceeded\", null), e([a({\n    readOnly: !0\n  })], R.prototype, \"requiredFields\", void 0), e([a()], R.prototype, \"suspended\", void 0), e([a()], R.prototype, \"view\", void 0), R = e([u(\"esri.views.layers.FeatureLayerView\")], R), R;\n};\n\nexport default R;\nexport { R as FeatureLayerView };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/layers/FeatureLayerView.js"],"names":["_","e","t","r","isSome","i","isNone","s","eachAlways","o","init","n","on","l","property","a","subclass","u","combinedViewLayerTimeExtentProperty","p","fixFields","d","unpackFieldNames","m","collectLabelingFields","c","collectElevationFields","f","collectFilterFields","y","collectFeatureReductionFields","h","collectFields","F","collectField","w","featureHasFields","g","x","loadArcade","b","E","v","getFetchPopupTemplate","q","getRequiredFields","j","I","getLogger","R","constructor","_updatingRequiredFieldsPromise","effect","filter","timeExtent","layer","requiredFields","view","initialize","_handleRequiredFieldsChange","availableFields","fieldsIndex","outFields","maximumNumberOfFeatures","error","maximumNumberOfFeaturesExceeded","highlight","Error","createQuery","returnGeometry","outSpatialReference","spatialReference","intersection","clone","queryFeatures","queryObjectIds","queryFeatureCount","queryExtent","_loadArcadeModules","get","_updateRequiredFields","_set","then","type","objectIdField","renderer","featureReduction","Set","collectRequiredFields","timeInfo","startField","endField","floorInfo","floorField","subtypeField","sublayers","map","Promise","all","displayField","Array","from","sort","validateFetchPopupFeatures","clientGraphics","popupEnabled","fetchClientPopupFeatures","length","resolve","createPopupQuery","arcadeUtils","hasGeometryOperations","push","objectIds","attributes","concat","features","catch","geometryType","add","returnZ","returnM","canResume","isEmpty","prototype","readOnly","Number","Boolean","FeatureLayerView"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../chunks/tslib.es6.js\";import t from\"../../core/Error.js\";import r from\"../../core/Logger.js\";import{isSome as i,isNone as s}from\"../../core/maybe.js\";import{eachAlways as o}from\"../../core/promiseUtils.js\";import{init as n,on as l}from\"../../core/watchUtils.js\";import{property as a}from\"../../core/accessorSupport/decorators/property.js\";import\"../../core/has.js\";import\"../../core/accessorSupport/ensureType.js\";import{subclass as u}from\"../../core/accessorSupport/decorators/subclass.js\";import{combinedViewLayerTimeExtentProperty as p}from\"../../layers/support/commonProperties.js\";import{fixFields as d,unpackFieldNames as m,collectLabelingFields as c,collectElevationFields as f,collectFilterFields as y,collectFeatureReductionFields as h,collectFields as F,collectField as w,featureHasFields as g}from\"../../layers/support/fieldUtils.js\";import x from\"../../rest/support/Query.js\";import{loadArcade as b}from\"../../support/arcadeOnDemand.js\";import E from\"./support/FeatureEffect.js\";import v from\"./support/FeatureFilter.js\";import{getFetchPopupTemplate as q,getRequiredFields as j}from\"./support/popupUtils.js\";const I=r.getLogger(\"esri.views.layers.FeatureLayerView\"),R=r=>{let R=class extends r{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.effect=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){n(this,[\"layer.renderer\",\"layer.labelingInfo\",\"layer.elevationInfo.featureExpressionInfo\",\"layer.displayField\",\"filter\",\"effect\",\"layer.timeInfo\",\"layer.floorInfo\",\"timeExtent\"],(()=>this._handleRequiredFieldsChange()),!0),l(this,\"view.floors\",\"change\",(()=>this._handleRequiredFieldsChange())),l(this,\"layer.sublayer\",\"change\",(()=>this._handleRequiredFieldsChange()))}get availableFields(){const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return\"outFields\"in e&&e.outFields?d(t,[...m(t,e.outFields),...r]):d(t,r)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){I.error(\"#maximumNumberOfFeatures=\",\"Setting maximum number of features is not supported\")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error(\"missing implementation\")}createQuery(){const e={outFields:[\"*\"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=i(this.filter)?this.filter.createQuery(e):new x(e);return i(this.timeExtent)&&(t.timeExtent=i(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}queryFeatures(e,t){throw new Error(\"missing implementation\")}queryObjectIds(e,t){throw new Error(\"missing implementation\")}queryFeatureCount(e,t){throw new Error(\"missing implementation\")}queryExtent(e,t){throw new Error(\"missing implementation\")}_loadArcadeModules(e){if(e.get(\"expressionInfos.length\"))return b()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set(\"_updatingRequiredFieldsPromise\",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set(\"_updatingRequiredFieldsPromise\",null)}))}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e=\"3d\"===this.view.type,{layer:t,layer:{fieldsIndex:r,objectIdField:s}}=this,n=\"renderer\"in t&&t.renderer,l=t.featureReduction,a=new Set,u=await o([n?n.collectRequiredFields(a,r):null,c(a,t),e?f(a,t):null,i(this.filter)?y(a,t,this.filter):null,this.effect?y(a,t,this.effect.filter):null,l?h(a,t,l):null]);if(t.timeInfo&&this.timeExtent&&F(a,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),\"feature\"===t.type&&t.floorInfo&&F(a,t.fieldsIndex,[t.floorInfo.floorField]),\"subtype-group\"===t.type){w(a,r,t.subtypeField);const e=t.sublayers.map((e=>{var t;return Promise.all([null==(t=e.renderer)?void 0:t.collectRequiredFields(a,r),c(a,e)])}));await o(e)}for(const i of u)i.error&&I.error(i.error);w(a,r,s),e&&\"displayField\"in t&&t.displayField&&w(a,r,t.displayField);const p=Array.from(a).sort();this._set(\"requiredFields\",p)}validateFetchPopupFeatures(e){if(s(e))return null;for(const r of e.clientGraphics){const i=r.layer;if(\"popupEnabled\"in i&&!i.popupEnabled)return new t(\"featurelayerview:fetchPopupFeatures\",\"Popups are disabled\",{layer:i});if(\"popupTemplate\"in i){if(!q(i,e))return new t(\"featurelayerview:fetchPopupFeatures\",\"Layer does not define a popup template\",{layer:i})}}}async fetchClientPopupFeatures(e){const t=i(e)?e.clientGraphics:null;if(!t||0===t.length)return Promise.resolve([]);const r=[],s=[],o=await this.createPopupQuery(e);for(const n of t){const{layer:t}=n;if(!(\"popupEnabled\"in t))continue;const l=m(this.layer.fieldsIndex,o.outFields),a=q(t,e);if(!i(a))continue;const u=await this._loadArcadeModules(a);u&&u.arcadeUtils.hasGeometryOperations(a)||!g(l,n)?s.push(n):r.push(n)}return\"stream\"===this.layer.type||0===s.length?Promise.resolve(r):(o.objectIds=s.map((e=>e.attributes[this.layer.objectIdField])),this.layer.queryFeatures(o).then((e=>r.concat(e.features))).catch((()=>s)))}async createPopupQuery(e){const t=this.layer.createQuery(),r=new Set;let s=!1;const o=i(e)&&e.clientGraphics?e.clientGraphics.map((e=>e.layer)):[this.layer];for(const n of o){if(!(\"popupEnabled\"in n))continue;const t=q(n,e);if(!i(t))continue;const o=await this._loadArcadeModules(t),l=o&&o.arcadeUtils.hasGeometryOperations(t);s=!(\"point\"!==this.layer.geometryType&&!l);const a=await j(this.layer,t);for(const e of a)r.add(e)}return t.returnGeometry=s,t.returnZ=s,t.returnM=s,t.outFields=Array.from(r),t.outSpatialReference=this.view.spatialReference,t}canResume(){return!!super.canResume()&&(!i(this.timeExtent)||!this.timeExtent.isEmpty)}};return e([a()],R.prototype,\"_updatingRequiredFieldsPromise\",void 0),e([a({readOnly:!0})],R.prototype,\"availableFields\",null),e([a({type:E})],R.prototype,\"effect\",void 0),e([a({type:v})],R.prototype,\"filter\",void 0),e([a(p)],R.prototype,\"timeExtent\",void 0),e([a()],R.prototype,\"layer\",void 0),e([a({type:Number})],R.prototype,\"maximumNumberOfFeatures\",null),e([a({readOnly:!0,type:Boolean})],R.prototype,\"maximumNumberOfFeaturesExceeded\",null),e([a({readOnly:!0})],R.prototype,\"requiredFields\",void 0),e([a()],R.prototype,\"suspended\",void 0),e([a()],R.prototype,\"view\",void 0),R=e([u(\"esri.views.layers.FeatureLayerView\")],R),R};export default R;export{R as FeatureLayerView};\n"]},"metadata":{},"sourceType":"module"}