{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { nextPowerOfTwo as t } from \"../../../../../core/mathUtils.js\";\nimport { isSome as r } from \"../../../../../core/maybe.js\";\nimport { c as e } from \"../../../../../chunks/mat3f32.js\";\nimport { f as o } from \"../../../../../chunks/vec4f32.js\";\nimport i from \"../../../../webgl/BufferObject.js\";\nimport \"../../../../webgl/FramebufferObject.js\";\nimport \"../../../../../core/has.js\";\nimport \"../../../../webgl/enums.js\";\nimport \"../../../../webgl/RenderingContext.js\";\nimport \"../../../../../chunks/builtins.js\";\nimport \"../../../../webgl/Texture.js\";\nimport s from \"../../../../webgl/VertexArrayObject.js\";\nimport { VTL_TEXTURE_BINDING_UNIT_SPRITES as a, VTL_HIGH_RES_CUTOFF as n } from \"../definitions.js\";\nimport { WGLDrawPhase as c } from \"../enums.js\";\nimport { u32to4Xu8 as m } from \"../number.js\";\nimport f from \"./WGLBrush.js\";\n\nclass l extends f {\n  constructor() {\n    super(...arguments), this._color = o(1, 0, 0, 1), this._patternMatrix = e(), this._programOptions = {\n      id: !1,\n      pattern: !1\n    };\n  }\n\n  dispose() {\n    this._vao && (this._vao.dispose(), this._vao = null);\n  }\n\n  drawMany(e, o) {\n    const {\n      context: i,\n      painter: s,\n      styleLayerUID: f\n    } = e;\n\n    this._loadWGLResources(e);\n\n    const l = e.displayLevel,\n          u = e.styleLayer,\n          p = u.backgroundMaterial,\n          _ = s.vectorTilesMaterialManager,\n          d = u.getPaintValue(\"background-color\", l),\n          g = u.getPaintValue(\"background-opacity\", l),\n          h = u.getPaintValue(\"background-pattern\", l),\n          b = void 0 !== h,\n          j = d[3] * g,\n          v = 1 | window.devicePixelRatio,\n          x = e.spriteMosaic;\n    let y, M;\n    const w = v > n ? 2 : 1,\n          U = e.drawPhase === c.HITTEST,\n          k = this._programOptions;\n    k.id = U, k.pattern = b;\n\n    const L = _.getMaterialProgram(i, p, k);\n\n    if (i.bindVAO(this._vao), i.useProgram(L), b) {\n      const t = x.getMosaicItemPosition(h, !0);\n\n      if (r(t)) {\n        const {\n          tl: e,\n          br: o,\n          page: s\n        } = t;\n        y = o[0] - e[0], M = o[1] - e[1];\n        const n = x.getPageSize(s);\n        r(n) && (x.bind(i, 9729, s, a), L.setUniform4f(\"u_tlbr\", e[0], e[1], o[0], o[1]), L.setUniform2fv(\"u_mosaicSize\", n), L.setUniform1i(\"u_texture\", a));\n      }\n\n      L.setUniform1f(\"u_opacity\", g);\n    } else this._color[0] = j * d[0], this._color[1] = j * d[1], this._color[2] = j * d[2], this._color[3] = j, L.setUniform4fv(\"u_color\", this._color);\n\n    if (L.setUniform1f(\"u_depth\", u.z || 0), U) {\n      const t = m(f + 1);\n      L.setUniform4fv(\"u_id\", t);\n    }\n\n    for (const r of o) {\n      if (L.setUniform1f(\"u_coord_range\", r.coordRange[0]), L.setUniformMatrix3fv(\"u_dvsMat3\", r.transforms.dvs), b) {\n        const e = Math.max(2 ** (Math.round(l) - r.key.level), 1),\n              o = w * r.size[0] * e,\n              i = o / t(y),\n              s = o / t(M);\n        this._patternMatrix[0] = i, this._patternMatrix[4] = s, L.setUniformMatrix3fv(\"u_pattern_matrix\", this._patternMatrix);\n      }\n\n      i.setStencilFunction(514, r.stencilRef, 255), i.drawArrays(5, 0, 4);\n    }\n  }\n\n  _loadWGLResources(t) {\n    if (this._vao) return;\n    const {\n      context: r,\n      styleLayer: e\n    } = t,\n          o = e.backgroundMaterial,\n          a = new Int8Array([0, 0, 1, 0, 0, 1, 1, 1]),\n          n = i.createVertex(r, 35044, a),\n          c = new s(r, o.getAttributeLocations(), o.getLayoutInfo(), {\n      geometry: n\n    });\n    this._vao = c;\n  }\n\n}\n\nexport { l as WGLBrushVTLBackground };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/2d/engine/webgl/brushes/WGLBrushVTLBackground.js"],"names":["nextPowerOfTwo","t","isSome","r","c","e","f","o","i","s","VTL_TEXTURE_BINDING_UNIT_SPRITES","a","VTL_HIGH_RES_CUTOFF","n","WGLDrawPhase","u32to4Xu8","m","l","constructor","arguments","_color","_patternMatrix","_programOptions","id","pattern","dispose","_vao","drawMany","context","painter","styleLayerUID","_loadWGLResources","displayLevel","u","styleLayer","p","backgroundMaterial","_","vectorTilesMaterialManager","d","getPaintValue","g","h","b","j","v","window","devicePixelRatio","x","spriteMosaic","y","M","w","U","drawPhase","HITTEST","k","L","getMaterialProgram","bindVAO","useProgram","getMosaicItemPosition","tl","br","page","getPageSize","bind","setUniform4f","setUniform2fv","setUniform1i","setUniform1f","setUniform4fv","z","coordRange","setUniformMatrix3fv","transforms","dvs","Math","max","round","key","level","size","setStencilFunction","stencilRef","drawArrays","Int8Array","createVertex","getAttributeLocations","getLayoutInfo","geometry","WGLBrushVTLBackground"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{nextPowerOfTwo as t}from\"../../../../../core/mathUtils.js\";import{isSome as r}from\"../../../../../core/maybe.js\";import{c as e}from\"../../../../../chunks/mat3f32.js\";import{f as o}from\"../../../../../chunks/vec4f32.js\";import i from\"../../../../webgl/BufferObject.js\";import\"../../../../webgl/FramebufferObject.js\";import\"../../../../../core/has.js\";import\"../../../../webgl/enums.js\";import\"../../../../webgl/RenderingContext.js\";import\"../../../../../chunks/builtins.js\";import\"../../../../webgl/Texture.js\";import s from\"../../../../webgl/VertexArrayObject.js\";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as a,VTL_HIGH_RES_CUTOFF as n}from\"../definitions.js\";import{WGLDrawPhase as c}from\"../enums.js\";import{u32to4Xu8 as m}from\"../number.js\";import f from\"./WGLBrush.js\";class l extends f{constructor(){super(...arguments),this._color=o(1,0,0,1),this._patternMatrix=e(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(e,o){const{context:i,painter:s,styleLayerUID:f}=e;this._loadWGLResources(e);const l=e.displayLevel,u=e.styleLayer,p=u.backgroundMaterial,_=s.vectorTilesMaterialManager,d=u.getPaintValue(\"background-color\",l),g=u.getPaintValue(\"background-opacity\",l),h=u.getPaintValue(\"background-pattern\",l),b=void 0!==h,j=d[3]*g,v=1|window.devicePixelRatio,x=e.spriteMosaic;let y,M;const w=v>n?2:1,U=e.drawPhase===c.HITTEST,k=this._programOptions;k.id=U,k.pattern=b;const L=_.getMaterialProgram(i,p,k);if(i.bindVAO(this._vao),i.useProgram(L),b){const t=x.getMosaicItemPosition(h,!0);if(r(t)){const{tl:e,br:o,page:s}=t;y=o[0]-e[0],M=o[1]-e[1];const n=x.getPageSize(s);r(n)&&(x.bind(i,9729,s,a),L.setUniform4f(\"u_tlbr\",e[0],e[1],o[0],o[1]),L.setUniform2fv(\"u_mosaicSize\",n),L.setUniform1i(\"u_texture\",a))}L.setUniform1f(\"u_opacity\",g)}else this._color[0]=j*d[0],this._color[1]=j*d[1],this._color[2]=j*d[2],this._color[3]=j,L.setUniform4fv(\"u_color\",this._color);if(L.setUniform1f(\"u_depth\",u.z||0),U){const t=m(f+1);L.setUniform4fv(\"u_id\",t)}for(const r of o){if(L.setUniform1f(\"u_coord_range\",r.coordRange[0]),L.setUniformMatrix3fv(\"u_dvsMat3\",r.transforms.dvs),b){const e=Math.max(2**(Math.round(l)-r.key.level),1),o=w*r.size[0]*e,i=o/t(y),s=o/t(M);this._patternMatrix[0]=i,this._patternMatrix[4]=s,L.setUniformMatrix3fv(\"u_pattern_matrix\",this._patternMatrix)}i.setStencilFunction(514,r.stencilRef,255),i.drawArrays(5,0,4)}}_loadWGLResources(t){if(this._vao)return;const{context:r,styleLayer:e}=t,o=e.backgroundMaterial,a=new Int8Array([0,0,1,0,0,1,1,1]),n=i.createVertex(r,35044,a),c=new s(r,o.getAttributeLocations(),o.getLayoutInfo(),{geometry:n});this._vao=c}}export{l as WGLBrushVTLBackground};\n"]},"metadata":{},"sourceType":"module"}