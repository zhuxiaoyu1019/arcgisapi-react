{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../chunks/tslib.es6.js\";\nimport i from \"../../../../core/Accessor.js\";\nimport t from \"../../../../core/Handles.js\";\nimport r from \"../../../../core/Logger.js\";\nimport { isNone as s, isSome as h } from \"../../../../core/maybe.js\";\nimport { isAbortError as l } from \"../../../../core/promiseUtils.js\";\nimport { on as o } from \"../../../../core/watchUtils.js\";\nimport { property as n } from \"../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../core/has.js\";\nimport \"../../../../core/accessorSupport/ensureType.js\";\nimport { subclass as a } from \"../../../../core/accessorSupport/decorators/subclass.js\";\nimport u from \"./QueryEngine.js\";\nimport { getFloorFilterClause as c } from \"../support/floorFilterUtils.js\";\nimport y from \"../../../layers/support/FeatureFilter.js\";\nimport { TaskPriority as d } from \"../../../support/Scheduler.js\";\nconst p = r.getLogger(\"esri.views.3d.layers.graphics.Graphics3DFilterVisibility\");\n\nlet _ = class extends i {\n  constructor(...e) {\n    super(...e), this.filter = null, this._dirty = !1, this._querying = !1, this._handles = new t();\n  }\n\n  get updating() {\n    return this._dirty || this._querying || null != this._queryResult;\n  }\n\n  setup(e, i) {\n    this._layerView = e, this._core = i, this._objectIdField = e.layer.objectIdField, this._queryEngine = new u({\n      layerView: this._layerView,\n      priority: d.FILTER_VISIBILITY\n    });\n    const t = this._layerView.view.resourceController.scheduler;\n    this._handles.add(t.registerTask(d.FILTER_VISIBILITY, this)), this._handles.add(o(i.owner, \"loadedGraphics\", \"after-changes\", e => this._graphicsChanged(e), () => this.dirty = !0)), this.filterChanged();\n  }\n\n  destroy() {\n    this._handles.destroy(), this._handles = null, this.clear(), this._layerView = null, this._core = null;\n  }\n\n  clear() {\n    this._queryEngine.clear() && (this._core.modifyGraphics3DGraphicVisibilities(e => e.clearVisibilityFlag(2)), this._queryResult = null, this._querying = !1), this.dirty = !1, this.notifyChange(\"updating\");\n  }\n\n  _graphicsChanged(e) {\n    this._queryEngine && 0 == (1 & e.type) || (this.dirty = !0);\n  }\n\n  updateVisibility(e) {\n    this.active && (e.hasVisibilityFlag(2, 0) || e.setVisibilityFlag(2, !1, 0), this.dirty = !0);\n  }\n\n  filterChanged() {\n    const e = this.recomputeFilter();\n    e !== this.filter && (this.filter = e, this.dirty = !0);\n  }\n\n  get active() {\n    return this.filter && this._core.graphics3DGraphics.size > 0;\n  }\n\n  recomputeFilter() {\n    const e = \"filter\" in this._layerView ? this._layerView.filter : null,\n          i = \"timeExtent\" in this._layerView ? this._layerView.timeExtent : null,\n          t = c(this._layerView);\n    if (s(i) && s(t)) return e;\n    const r = h(e) ? e.clone() : new y();\n\n    if (h(i) && (r.timeExtent = h(r.timeExtent) ? r.timeExtent.intersection(i) : i), h(t)) {\n      const e = null == r.where || \"\" === r.where;\n      r.where = e ? t : `(${r.where}) AND (${t})`;\n    }\n\n    return r;\n  }\n\n  get running() {\n    return this._dirty && !this._querying || null != this._queryResult;\n  }\n\n  runTask(e) {\n    this.active ? (!this._dirty || this._querying || e.done || (this._querying = !0, this.dirty = !1, this._queryEngine.executeQueryForIdSet(this.filter).then(e => {\n      this._queryResult = e, this._querying = !1;\n    }).catch(e => {\n      l(e) || (p.warn(\"FeatureFilter query failed: \" + e, {\n        error: e\n      }), this._queryResult = new Set(), this._core.graphics3DGraphics.forEach(e => this._queryResult.add(this._getFeatureId(e.graphic))), this._querying = !1);\n    }), e.madeProgress()), this._queryResult && !e.done && (this._core.modifyGraphics3DGraphicVisibilities(i => {\n      if (e.done) return !1;\n\n      const t = this._queryResult.has(this._getFeatureId(i.graphic));\n\n      return !!i.setVisibilityFlag(2, t, 0) && (e.madeProgress(), !0);\n    }), e.done || (this._queryResult = null)), this.notifyChange(\"updating\")) : this.clear();\n  }\n\n  _getFeatureId(e) {\n    return null == e.objectId ? e.attributes[this._objectIdField] : e.objectId;\n  }\n\n  set dirty(e) {\n    this._dirty !== e && (this._dirty = e, this.notifyChange(\"updating\"));\n  }\n\n};\n\ne([n({\n  readOnly: !0\n})], _.prototype, \"updating\", null), _ = e([a(\"esri.views.3d.layers.graphics.Graphics3DFilterVisibility\")], _);\nexport { _ as Graphics3DFilterVisibility };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/layers/graphics/Graphics3DFilterVisibility.js"],"names":["_","e","i","t","r","isNone","s","isSome","h","isAbortError","l","on","o","property","n","subclass","a","u","getFloorFilterClause","c","y","TaskPriority","d","p","getLogger","constructor","filter","_dirty","_querying","_handles","updating","_queryResult","setup","_layerView","_core","_objectIdField","layer","objectIdField","_queryEngine","layerView","priority","FILTER_VISIBILITY","view","resourceController","scheduler","add","registerTask","owner","_graphicsChanged","dirty","filterChanged","destroy","clear","modifyGraphics3DGraphicVisibilities","clearVisibilityFlag","notifyChange","type","updateVisibility","active","hasVisibilityFlag","setVisibilityFlag","recomputeFilter","graphics3DGraphics","size","timeExtent","clone","intersection","where","running","runTask","done","executeQueryForIdSet","then","catch","warn","error","Set","forEach","_getFeatureId","graphic","madeProgress","has","objectId","attributes","readOnly","prototype","Graphics3DFilterVisibility"],"mappings":"AAAA;AACA;AACA;AACA;AACA,SAAOA,CAAC,IAAIC,CAAZ,QAAkB,iCAAlB;AAAoD,OAAOC,CAAP,MAAa,8BAAb;AAA4C,OAAOC,CAAP,MAAa,6BAAb;AAA2C,OAAOC,CAAP,MAAa,4BAAb;AAA0C,SAAOC,MAAM,IAAIC,CAAjB,EAAmBC,MAAM,IAAIC,CAA7B,QAAmC,2BAAnC;AAA+D,SAAOC,YAAY,IAAIC,CAAvB,QAA6B,kCAA7B;AAAgE,SAAOC,EAAE,IAAIC,CAAb,QAAmB,gCAAnB;AAAoD,SAAOC,QAAQ,IAAIC,CAAnB,QAAyB,yDAAzB;AAAmF,OAAM,yBAAN;AAAgC,OAAM,gDAAN;AAAuD,SAAOC,QAAQ,IAAIC,CAAnB,QAAyB,yDAAzB;AAAmF,OAAOC,CAAP,MAAa,kBAAb;AAAgC,SAAOC,oBAAoB,IAAIC,CAA/B,QAAqC,gCAArC;AAAsE,OAAOC,CAAP,MAAa,0CAAb;AAAwD,SAAOC,YAAY,IAAIC,CAAvB,QAA6B,+BAA7B;AAA6D,MAAMC,CAAC,GAACnB,CAAC,CAACoB,SAAF,CAAY,0DAAZ,CAAR;;AAAgF,IAAIxB,CAAC,GAAC,cAAcE,CAAd,CAAe;AAACuB,EAAAA,WAAW,CAAC,GAAGxB,CAAJ,EAAM;AAAC,UAAM,GAAGA,CAAT,GAAY,KAAKyB,MAAL,GAAY,IAAxB,EAA6B,KAAKC,MAAL,GAAY,CAAC,CAA1C,EAA4C,KAAKC,SAAL,GAAe,CAAC,CAA5D,EAA8D,KAAKC,QAAL,GAAc,IAAI1B,CAAJ,EAA5E;AAAkF;;AAAY,MAAR2B,QAAQ,GAAE;AAAC,WAAO,KAAKH,MAAL,IAAa,KAAKC,SAAlB,IAA6B,QAAM,KAAKG,YAA/C;AAA4D;;AAAAC,EAAAA,KAAK,CAAC/B,CAAD,EAAGC,CAAH,EAAK;AAAC,SAAK+B,UAAL,GAAgBhC,CAAhB,EAAkB,KAAKiC,KAAL,GAAWhC,CAA7B,EAA+B,KAAKiC,cAAL,GAAoBlC,CAAC,CAACmC,KAAF,CAAQC,aAA3D,EAAyE,KAAKC,YAAL,GAAkB,IAAIrB,CAAJ,CAAM;AAACsB,MAAAA,SAAS,EAAC,KAAKN,UAAhB;AAA2BO,MAAAA,QAAQ,EAAClB,CAAC,CAACmB;AAAtC,KAAN,CAA3F;AAA2J,UAAMtC,CAAC,GAAC,KAAK8B,UAAL,CAAgBS,IAAhB,CAAqBC,kBAArB,CAAwCC,SAAhD;AAA0D,SAAKf,QAAL,CAAcgB,GAAd,CAAkB1C,CAAC,CAAC2C,YAAF,CAAexB,CAAC,CAACmB,iBAAjB,EAAmC,IAAnC,CAAlB,GAA4D,KAAKZ,QAAL,CAAcgB,GAAd,CAAkBjC,CAAC,CAACV,CAAC,CAAC6C,KAAH,EAAS,gBAAT,EAA0B,eAA1B,EAA2C9C,CAAC,IAAE,KAAK+C,gBAAL,CAAsB/C,CAAtB,CAA9C,EAAyE,MAAI,KAAKgD,KAAL,GAAW,CAAC,CAAzF,CAAnB,CAA5D,EAA6K,KAAKC,aAAL,EAA7K;AAAkM;;AAAAC,EAAAA,OAAO,GAAE;AAAC,SAAKtB,QAAL,CAAcsB,OAAd,IAAwB,KAAKtB,QAAL,GAAc,IAAtC,EAA2C,KAAKuB,KAAL,EAA3C,EAAwD,KAAKnB,UAAL,GAAgB,IAAxE,EAA6E,KAAKC,KAAL,GAAW,IAAxF;AAA6F;;AAAAkB,EAAAA,KAAK,GAAE;AAAC,SAAKd,YAAL,CAAkBc,KAAlB,OAA4B,KAAKlB,KAAL,CAAWmB,mCAAX,CAAgDpD,CAAC,IAAEA,CAAC,CAACqD,mBAAF,CAAsB,CAAtB,CAAnD,GAA8E,KAAKvB,YAAL,GAAkB,IAAhG,EAAqG,KAAKH,SAAL,GAAe,CAAC,CAAjJ,GAAoJ,KAAKqB,KAAL,GAAW,CAAC,CAAhK,EAAkK,KAAKM,YAAL,CAAkB,UAAlB,CAAlK;AAAgM;;AAAAP,EAAAA,gBAAgB,CAAC/C,CAAD,EAAG;AAAC,SAAKqC,YAAL,IAAmB,MAAI,IAAErC,CAAC,CAACuD,IAAR,CAAnB,KAAmC,KAAKP,KAAL,GAAW,CAAC,CAA/C;AAAkD;;AAAAQ,EAAAA,gBAAgB,CAACxD,CAAD,EAAG;AAAC,SAAKyD,MAAL,KAAczD,CAAC,CAAC0D,iBAAF,CAAoB,CAApB,EAAsB,CAAtB,KAA0B1D,CAAC,CAAC2D,iBAAF,CAAoB,CAApB,EAAsB,CAAC,CAAvB,EAAyB,CAAzB,CAA1B,EAAsD,KAAKX,KAAL,GAAW,CAAC,CAAhF;AAAmF;;AAAAC,EAAAA,aAAa,GAAE;AAAC,UAAMjD,CAAC,GAAC,KAAK4D,eAAL,EAAR;AAA+B5D,IAAAA,CAAC,KAAG,KAAKyB,MAAT,KAAkB,KAAKA,MAAL,GAAYzB,CAAZ,EAAc,KAAKgD,KAAL,GAAW,CAAC,CAA5C;AAA+C;;AAAU,MAANS,MAAM,GAAE;AAAC,WAAO,KAAKhC,MAAL,IAAa,KAAKQ,KAAL,CAAW4B,kBAAX,CAA8BC,IAA9B,GAAmC,CAAvD;AAAyD;;AAAAF,EAAAA,eAAe,GAAE;AAAC,UAAM5D,CAAC,GAAC,YAAW,KAAKgC,UAAhB,GAA2B,KAAKA,UAAL,CAAgBP,MAA3C,GAAkD,IAA1D;AAAA,UAA+DxB,CAAC,GAAC,gBAAe,KAAK+B,UAApB,GAA+B,KAAKA,UAAL,CAAgB+B,UAA/C,GAA0D,IAA3H;AAAA,UAAgI7D,CAAC,GAACgB,CAAC,CAAC,KAAKc,UAAN,CAAnI;AAAqJ,QAAG3B,CAAC,CAACJ,CAAD,CAAD,IAAMI,CAAC,CAACH,CAAD,CAAV,EAAc,OAAOF,CAAP;AAAS,UAAMG,CAAC,GAACI,CAAC,CAACP,CAAD,CAAD,GAAKA,CAAC,CAACgE,KAAF,EAAL,GAAe,IAAI7C,CAAJ,EAAvB;;AAA6B,QAAGZ,CAAC,CAACN,CAAD,CAAD,KAAOE,CAAC,CAAC4D,UAAF,GAAaxD,CAAC,CAACJ,CAAC,CAAC4D,UAAH,CAAD,GAAgB5D,CAAC,CAAC4D,UAAF,CAAaE,YAAb,CAA0BhE,CAA1B,CAAhB,GAA6CA,CAAjE,GAAoEM,CAAC,CAACL,CAAD,CAAxE,EAA4E;AAAC,YAAMF,CAAC,GAAC,QAAMG,CAAC,CAAC+D,KAAR,IAAe,OAAK/D,CAAC,CAAC+D,KAA9B;AAAoC/D,MAAAA,CAAC,CAAC+D,KAAF,GAAQlE,CAAC,GAACE,CAAD,GAAI,IAAGC,CAAC,CAAC+D,KAAM,UAAShE,CAAE,GAAnC;AAAsC;;AAAA,WAAOC,CAAP;AAAS;;AAAW,MAAPgE,OAAO,GAAE;AAAC,WAAO,KAAKzC,MAAL,IAAa,CAAC,KAAKC,SAAnB,IAA8B,QAAM,KAAKG,YAAhD;AAA6D;;AAAAsC,EAAAA,OAAO,CAACpE,CAAD,EAAG;AAAC,SAAKyD,MAAL,IAAa,CAAC,KAAK/B,MAAN,IAAc,KAAKC,SAAnB,IAA8B3B,CAAC,CAACqE,IAAhC,KAAuC,KAAK1C,SAAL,GAAe,CAAC,CAAhB,EAAkB,KAAKqB,KAAL,GAAW,CAAC,CAA9B,EAAgC,KAAKX,YAAL,CAAkBiC,oBAAlB,CAAuC,KAAK7C,MAA5C,EAAoD8C,IAApD,CAA0DvE,CAAC,IAAE;AAAC,WAAK8B,YAAL,GAAkB9B,CAAlB,EAAoB,KAAK2B,SAAL,GAAe,CAAC,CAApC;AAAsC,KAApG,EAAuG6C,KAAvG,CAA8GxE,CAAC,IAAE;AAACS,MAAAA,CAAC,CAACT,CAAD,CAAD,KAAOsB,CAAC,CAACmD,IAAF,CAAO,iCAA+BzE,CAAtC,EAAwC;AAAC0E,QAAAA,KAAK,EAAC1E;AAAP,OAAxC,GAAmD,KAAK8B,YAAL,GAAkB,IAAI6C,GAAJ,EAArE,EAA6E,KAAK1C,KAAL,CAAW4B,kBAAX,CAA8Be,OAA9B,CAAuC5E,CAAC,IAAE,KAAK8B,YAAL,CAAkBc,GAAlB,CAAsB,KAAKiC,aAAL,CAAmB7E,CAAC,CAAC8E,OAArB,CAAtB,CAA1C,CAA7E,EAA8K,KAAKnD,SAAL,GAAe,CAAC,CAArM;AAAwM,KAA1T,CAAhC,EAA6V3B,CAAC,CAAC+E,YAAF,EAApY,GAAsZ,KAAKjD,YAAL,IAAmB,CAAC9B,CAAC,CAACqE,IAAtB,KAA6B,KAAKpC,KAAL,CAAWmB,mCAAX,CAAgDnD,CAAC,IAAE;AAAC,UAAGD,CAAC,CAACqE,IAAL,EAAU,OAAM,CAAC,CAAP;;AAAS,YAAMnE,CAAC,GAAC,KAAK4B,YAAL,CAAkBkD,GAAlB,CAAsB,KAAKH,aAAL,CAAmB5E,CAAC,CAAC6E,OAArB,CAAtB,CAAR;;AAA6D,aAAM,CAAC,CAAC7E,CAAC,CAAC0D,iBAAF,CAAoB,CAApB,EAAsBzD,CAAtB,EAAwB,CAAxB,CAAF,KAA+BF,CAAC,CAAC+E,YAAF,IAAiB,CAAC,CAAjD,CAAN;AAA0D,KAA9L,GAAiM/E,CAAC,CAACqE,IAAF,KAAS,KAAKvC,YAAL,GAAkB,IAA3B,CAA9N,CAAtZ,EAAspB,KAAKwB,YAAL,CAAkB,UAAlB,CAAnqB,IAAksB,KAAKH,KAAL,EAAlsB;AAA+sB;;AAAA0B,EAAAA,aAAa,CAAC7E,CAAD,EAAG;AAAC,WAAO,QAAMA,CAAC,CAACiF,QAAR,GAAiBjF,CAAC,CAACkF,UAAF,CAAa,KAAKhD,cAAlB,CAAjB,GAAmDlC,CAAC,CAACiF,QAA5D;AAAqE;;AAAS,MAALjC,KAAK,CAAChD,CAAD,EAAG;AAAC,SAAK0B,MAAL,KAAc1B,CAAd,KAAkB,KAAK0B,MAAL,GAAY1B,CAAZ,EAAc,KAAKsD,YAAL,CAAkB,UAAlB,CAAhC;AAA+D;;AAAphF,CAArB;;AAA2iFtD,CAAC,CAAC,CAACa,CAAC,CAAC;AAACsE,EAAAA,QAAQ,EAAC,CAAC;AAAX,CAAD,CAAF,CAAD,EAAoBpF,CAAC,CAACqF,SAAtB,EAAgC,UAAhC,EAA2C,IAA3C,CAAD,EAAkDrF,CAAC,GAACC,CAAC,CAAC,CAACe,CAAC,CAAC,0DAAD,CAAF,CAAD,EAAiEhB,CAAjE,CAArD;AAAyH,SAAOA,CAAC,IAAIsF,0BAAZ","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../chunks/tslib.es6.js\";import i from\"../../../../core/Accessor.js\";import t from\"../../../../core/Handles.js\";import r from\"../../../../core/Logger.js\";import{isNone as s,isSome as h}from\"../../../../core/maybe.js\";import{isAbortError as l}from\"../../../../core/promiseUtils.js\";import{on as o}from\"../../../../core/watchUtils.js\";import{property as n}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/ensureType.js\";import{subclass as a}from\"../../../../core/accessorSupport/decorators/subclass.js\";import u from\"./QueryEngine.js\";import{getFloorFilterClause as c}from\"../support/floorFilterUtils.js\";import y from\"../../../layers/support/FeatureFilter.js\";import{TaskPriority as d}from\"../../../support/Scheduler.js\";const p=r.getLogger(\"esri.views.3d.layers.graphics.Graphics3DFilterVisibility\");let _=class extends i{constructor(...e){super(...e),this.filter=null,this._dirty=!1,this._querying=!1,this._handles=new t}get updating(){return this._dirty||this._querying||null!=this._queryResult}setup(e,i){this._layerView=e,this._core=i,this._objectIdField=e.layer.objectIdField,this._queryEngine=new u({layerView:this._layerView,priority:d.FILTER_VISIBILITY});const t=this._layerView.view.resourceController.scheduler;this._handles.add(t.registerTask(d.FILTER_VISIBILITY,this)),this._handles.add(o(i.owner,\"loadedGraphics\",\"after-changes\",(e=>this._graphicsChanged(e)),(()=>this.dirty=!0))),this.filterChanged()}destroy(){this._handles.destroy(),this._handles=null,this.clear(),this._layerView=null,this._core=null}clear(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(2))),this._queryResult=null,this._querying=!1),this.dirty=!1,this.notifyChange(\"updating\")}_graphicsChanged(e){this._queryEngine&&0==(1&e.type)||(this.dirty=!0)}updateVisibility(e){this.active&&(e.hasVisibilityFlag(2,0)||e.setVisibilityFlag(2,!1,0),this.dirty=!0)}filterChanged(){const e=this.recomputeFilter();e!==this.filter&&(this.filter=e,this.dirty=!0)}get active(){return this.filter&&this._core.graphics3DGraphics.size>0}recomputeFilter(){const e=\"filter\"in this._layerView?this._layerView.filter:null,i=\"timeExtent\"in this._layerView?this._layerView.timeExtent:null,t=c(this._layerView);if(s(i)&&s(t))return e;const r=h(e)?e.clone():new y;if(h(i)&&(r.timeExtent=h(r.timeExtent)?r.timeExtent.intersection(i):i),h(t)){const e=null==r.where||\"\"===r.where;r.where=e?t:`(${r.where}) AND (${t})`}return r}get running(){return this._dirty&&!this._querying||null!=this._queryResult}runTask(e){this.active?(!this._dirty||this._querying||e.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this.filter).then((e=>{this._queryResult=e,this._querying=!1})).catch((e=>{l(e)||(p.warn(\"FeatureFilter query failed: \"+e,{error:e}),this._queryResult=new Set,this._core.graphics3DGraphics.forEach((e=>this._queryResult.add(this._getFeatureId(e.graphic)))),this._querying=!1)})),e.madeProgress()),this._queryResult&&!e.done&&(this._core.modifyGraphics3DGraphicVisibilities((i=>{if(e.done)return!1;const t=this._queryResult.has(this._getFeatureId(i.graphic));return!!i.setVisibilityFlag(2,t,0)&&(e.madeProgress(),!0)})),e.done||(this._queryResult=null)),this.notifyChange(\"updating\")):this.clear()}_getFeatureId(e){return null==e.objectId?e.attributes[this._objectIdField]:e.objectId}set dirty(e){this._dirty!==e&&(this._dirty=e,this.notifyChange(\"updating\"))}};e([n({readOnly:!0})],_.prototype,\"updating\",null),_=e([a(\"esri.views.3d.layers.graphics.Graphics3DFilterVisibility\")],_);export{_ as Graphics3DFilterVisibility};\n"]},"metadata":{},"sourceType":"module"}