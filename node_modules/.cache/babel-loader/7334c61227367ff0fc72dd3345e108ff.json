{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isSome as e, get as t, isNone as s } from \"../../../core/maybe.js\";\nimport { PROGRESSIVE_LOADING_MODULO as i } from \"./TerrainConst.js\";\nimport { getLayerWithExtentRange as l } from \"./terrainUtils.js\";\nimport { fallsWithinLayer as a } from \"./tileUtils.js\";\n\nclass r {\n  get updating() {\n    return !!this._tileRequested;\n  }\n\n  init(e, t, s, i) {\n    this.tile = e, this._layerIdx = t, this._layerClass = s, this._suspended = i, this._tileLayerInfo = e.getLayerInfo(t, s), this._tileRequested = null;\n\n    const l = this._findAncestorWithData();\n\n    this._setUpsampleTile(l);\n  }\n\n  startLoading() {\n    return this._requestNext();\n  }\n\n  dispose() {\n    this._tileRequested && (this._tileRequested.unrequestLayerData(this._layerIdx, this._layerClass, this), this._tileRequested = null), this.tile = null, this._tileLayerInfo = null;\n  }\n\n  setSuspension(e) {\n    e !== this._suspended && (this._suspended = e, e ? this._tileRequested && (this._tileRequested.unrequestLayerData(this._layerIdx, this._layerClass, this), this._tileRequested = null) : this._tileLayerInfo.data || this.update());\n  }\n\n  update() {\n    const e = this._findAncestorWithData();\n\n    return this._setUpsampleTile(e), this._requestNext();\n  }\n\n  dataArrived(e) {\n    this._setUpsampleTile(e), this._tileRequested = null, e === this.tile ? this.tile.updateRenderData(this._layerClass) : this._requestNext();\n  }\n\n  dataMissing() {\n    this._tileRequested = null, this._tileLayerInfo.data = null, this._requestNext();\n  }\n\n  _agentDone() {\n    this.tile.agentDone(this._layerIdx, this._layerClass), this.dispose();\n  }\n\n  _requestNext() {\n    if (this._suspended) return !0;\n\n    const t = this._findNextDownload();\n\n    if (this._tileRequested) {\n      if (t === this._tileRequested) return !0;\n      this._tileRequested.unrequestLayerData(this._layerIdx, this._layerClass, this), this._tileRequested = null;\n    }\n\n    return e(t) ? t.requestLayerData(this._layerIdx, this._layerClass, this) && (this._tileRequested = t) : this._agentDone(), !!this._tileRequested;\n  }\n\n  _findNextDownload() {\n    const r = this._layerIdx,\n          n = this._layerClass,\n          h = this.tile.surface.layerViewByIndex(r, n),\n          d = l(h),\n          {\n      minLevel: _,\n      maxLevel: o\n    } = h.dataLevelRange,\n          u = this._desiredMinLevelDelta,\n          p = this._progressiveLevelModulo + u,\n          y = this._scaleRangeEnabled ? a : () => !0;\n    let f = this.tile;\n    const q = f.level;\n    let v;\n    const I = this._tileLayerInfo.upsampleInfo,\n          L = I ? I.tile.level : -1,\n          m = t(d, \"tilemapCache\");\n\n    for (; f && y(f, d, !1) && f.level >= _;) {\n      const e = f.level,\n            t = q - e,\n            l = f.layerInfo[n][r];\n\n      if (l.data && t >= u) {\n        e > L && this._setUpsampleTile(f), l.dataInvalidated && (v = f);\n        break;\n      }\n\n      if ((s(m) || \"unavailable\" !== m.getAvailability(f.lij[0], f.lij[1], f.lij[2])) && e <= o && !l.data && !l.dataMissing && ((s(v) || f.level === _ || e % i == 0 || q - v.level < u) && (v = f), t >= p)) break;\n      f = f.parent;\n    }\n\n    return e(v) && q - v.level < u && this._tileLayerInfo.upsampleInfo && (v = null), v;\n  }\n\n  _findAncestorWithData() {\n    const e = this.tile.vlevel,\n          t = this._desiredMinLevelDelta;\n    let s;\n\n    for (let i = this.tile; i; i = i.parent) if (i.hasLayerData(this._layerIdx, this._layerClass)) {\n      if (e - i.level >= t) return i;\n      s = i;\n    }\n\n    return s;\n  }\n\n  _setUpsampleTile(e) {\n    this._tileLayerInfo.setUpsampleInfo(this.tile, e), this.tile.updateRenderData(this._layerClass);\n  }\n\n  get test() {\n    return {\n      findNextDownload: () => this._findNextDownload(),\n      tileLayerInfo: this._tileLayerInfo\n    };\n  }\n\n}\n\nclass n extends r {\n  get _desiredMinLevelDelta() {\n    throw h;\n  }\n\n  get _progressiveLevelModulo() {\n    throw h;\n  }\n\n  dispose() {}\n\n}\n\nconst h = new Error(\"Abstract method called on TileAgent\"),\n      d = new n();\nexport { d as TILE_AGENT_DONE, r as TileAgent };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/terrain/TileAgent.js"],"names":["isSome","e","get","t","isNone","s","PROGRESSIVE_LOADING_MODULO","i","getLayerWithExtentRange","l","fallsWithinLayer","a","r","updating","_tileRequested","init","tile","_layerIdx","_layerClass","_suspended","_tileLayerInfo","getLayerInfo","_findAncestorWithData","_setUpsampleTile","startLoading","_requestNext","dispose","unrequestLayerData","setSuspension","data","update","dataArrived","updateRenderData","dataMissing","_agentDone","agentDone","_findNextDownload","requestLayerData","n","h","surface","layerViewByIndex","d","minLevel","_","maxLevel","o","dataLevelRange","u","_desiredMinLevelDelta","p","_progressiveLevelModulo","y","_scaleRangeEnabled","f","q","level","v","I","upsampleInfo","L","m","layerInfo","dataInvalidated","getAvailability","lij","parent","vlevel","hasLayerData","setUpsampleInfo","test","findNextDownload","tileLayerInfo","Error","TILE_AGENT_DONE","TileAgent"],"mappings":"AAAA;AACA;AACA;AACA;AACA,SAAOA,MAAM,IAAIC,CAAjB,EAAmBC,GAAG,IAAIC,CAA1B,EAA4BC,MAAM,IAAIC,CAAtC,QAA4C,wBAA5C;AAAqE,SAAOC,0BAA0B,IAAIC,CAArC,QAA2C,mBAA3C;AAA+D,SAAOC,uBAAuB,IAAIC,CAAlC,QAAwC,mBAAxC;AAA4D,SAAOC,gBAAgB,IAAIC,CAA3B,QAAiC,gBAAjC;;AAAkD,MAAMC,CAAN,CAAO;AAAa,MAARC,QAAQ,GAAE;AAAC,WAAM,CAAC,CAAC,KAAKC,cAAb;AAA4B;;AAAAC,EAAAA,IAAI,CAACd,CAAD,EAAGE,CAAH,EAAKE,CAAL,EAAOE,CAAP,EAAS;AAAC,SAAKS,IAAL,GAAUf,CAAV,EAAY,KAAKgB,SAAL,GAAed,CAA3B,EAA6B,KAAKe,WAAL,GAAiBb,CAA9C,EAAgD,KAAKc,UAAL,GAAgBZ,CAAhE,EAAkE,KAAKa,cAAL,GAAoBnB,CAAC,CAACoB,YAAF,CAAelB,CAAf,EAAiBE,CAAjB,CAAtF,EAA0G,KAAKS,cAAL,GAAoB,IAA9H;;AAAmI,UAAML,CAAC,GAAC,KAAKa,qBAAL,EAAR;;AAAqC,SAAKC,gBAAL,CAAsBd,CAAtB;AAAyB;;AAAAe,EAAAA,YAAY,GAAE;AAAC,WAAO,KAAKC,YAAL,EAAP;AAA2B;;AAAAC,EAAAA,OAAO,GAAE;AAAC,SAAKZ,cAAL,KAAsB,KAAKA,cAAL,CAAoBa,kBAApB,CAAuC,KAAKV,SAA5C,EAAsD,KAAKC,WAA3D,EAAuE,IAAvE,GAA6E,KAAKJ,cAAL,GAAoB,IAAvH,GAA6H,KAAKE,IAAL,GAAU,IAAvI,EAA4I,KAAKI,cAAL,GAAoB,IAAhK;AAAqK;;AAAAQ,EAAAA,aAAa,CAAC3B,CAAD,EAAG;AAACA,IAAAA,CAAC,KAAG,KAAKkB,UAAT,KAAsB,KAAKA,UAAL,GAAgBlB,CAAhB,EAAkBA,CAAC,GAAC,KAAKa,cAAL,KAAsB,KAAKA,cAAL,CAAoBa,kBAApB,CAAuC,KAAKV,SAA5C,EAAsD,KAAKC,WAA3D,EAAuE,IAAvE,GAA6E,KAAKJ,cAAL,GAAoB,IAAvH,CAAD,GAA8H,KAAKM,cAAL,CAAoBS,IAApB,IAA0B,KAAKC,MAAL,EAAjM;AAAgN;;AAAAA,EAAAA,MAAM,GAAE;AAAC,UAAM7B,CAAC,GAAC,KAAKqB,qBAAL,EAAR;;AAAqC,WAAO,KAAKC,gBAAL,CAAsBtB,CAAtB,GAAyB,KAAKwB,YAAL,EAAhC;AAAoD;;AAAAM,EAAAA,WAAW,CAAC9B,CAAD,EAAG;AAAC,SAAKsB,gBAAL,CAAsBtB,CAAtB,GAAyB,KAAKa,cAAL,GAAoB,IAA7C,EAAkDb,CAAC,KAAG,KAAKe,IAAT,GAAc,KAAKA,IAAL,CAAUgB,gBAAV,CAA2B,KAAKd,WAAhC,CAAd,GAA2D,KAAKO,YAAL,EAA7G;AAAiI;;AAAAQ,EAAAA,WAAW,GAAE;AAAC,SAAKnB,cAAL,GAAoB,IAApB,EAAyB,KAAKM,cAAL,CAAoBS,IAApB,GAAyB,IAAlD,EAAuD,KAAKJ,YAAL,EAAvD;AAA2E;;AAAAS,EAAAA,UAAU,GAAE;AAAC,SAAKlB,IAAL,CAAUmB,SAAV,CAAoB,KAAKlB,SAAzB,EAAmC,KAAKC,WAAxC,GAAqD,KAAKQ,OAAL,EAArD;AAAoE;;AAAAD,EAAAA,YAAY,GAAE;AAAC,QAAG,KAAKN,UAAR,EAAmB,OAAM,CAAC,CAAP;;AAAS,UAAMhB,CAAC,GAAC,KAAKiC,iBAAL,EAAR;;AAAiC,QAAG,KAAKtB,cAAR,EAAuB;AAAC,UAAGX,CAAC,KAAG,KAAKW,cAAZ,EAA2B,OAAM,CAAC,CAAP;AAAS,WAAKA,cAAL,CAAoBa,kBAApB,CAAuC,KAAKV,SAA5C,EAAsD,KAAKC,WAA3D,EAAuE,IAAvE,GAA6E,KAAKJ,cAAL,GAAoB,IAAjG;AAAsG;;AAAA,WAAOb,CAAC,CAACE,CAAD,CAAD,GAAKA,CAAC,CAACkC,gBAAF,CAAmB,KAAKpB,SAAxB,EAAkC,KAAKC,WAAvC,EAAmD,IAAnD,MAA2D,KAAKJ,cAAL,GAAoBX,CAA/E,CAAL,GAAuF,KAAK+B,UAAL,EAAvF,EAAyG,CAAC,CAAC,KAAKpB,cAAvH;AAAsI;;AAAAsB,EAAAA,iBAAiB,GAAE;AAAC,UAAMxB,CAAC,GAAC,KAAKK,SAAb;AAAA,UAAuBqB,CAAC,GAAC,KAAKpB,WAA9B;AAAA,UAA0CqB,CAAC,GAAC,KAAKvB,IAAL,CAAUwB,OAAV,CAAkBC,gBAAlB,CAAmC7B,CAAnC,EAAqC0B,CAArC,CAA5C;AAAA,UAAoFI,CAAC,GAACjC,CAAC,CAAC8B,CAAD,CAAvF;AAAA,UAA2F;AAACI,MAAAA,QAAQ,EAACC,CAAV;AAAYC,MAAAA,QAAQ,EAACC;AAArB,QAAwBP,CAAC,CAACQ,cAArH;AAAA,UAAoIC,CAAC,GAAC,KAAKC,qBAA3I;AAAA,UAAiKC,CAAC,GAAC,KAAKC,uBAAL,GAA6BH,CAAhM;AAAA,UAAkMI,CAAC,GAAC,KAAKC,kBAAL,GAAwB1C,CAAxB,GAA0B,MAAI,CAAC,CAAnO;AAAqO,QAAI2C,CAAC,GAAC,KAAKtC,IAAX;AAAgB,UAAMuC,CAAC,GAACD,CAAC,CAACE,KAAV;AAAgB,QAAIC,CAAJ;AAAM,UAAMC,CAAC,GAAC,KAAKtC,cAAL,CAAoBuC,YAA5B;AAAA,UAAyCC,CAAC,GAACF,CAAC,GAACA,CAAC,CAAC1C,IAAF,CAAOwC,KAAR,GAAc,CAAC,CAA3D;AAAA,UAA6DK,CAAC,GAAC1D,CAAC,CAACuC,CAAD,EAAG,cAAH,CAAhE;;AAAmF,WAAKY,CAAC,IAAEF,CAAC,CAACE,CAAD,EAAGZ,CAAH,EAAK,CAAC,CAAN,CAAJ,IAAcY,CAAC,CAACE,KAAF,IAASZ,CAA5B,GAA+B;AAAC,YAAM3C,CAAC,GAACqD,CAAC,CAACE,KAAV;AAAA,YAAgBrD,CAAC,GAACoD,CAAC,GAACtD,CAApB;AAAA,YAAsBQ,CAAC,GAAC6C,CAAC,CAACQ,SAAF,CAAYxB,CAAZ,EAAe1B,CAAf,CAAxB;;AAA0C,UAAGH,CAAC,CAACoB,IAAF,IAAQ1B,CAAC,IAAE6C,CAAd,EAAgB;AAAC/C,QAAAA,CAAC,GAAC2D,CAAF,IAAK,KAAKrC,gBAAL,CAAsB+B,CAAtB,CAAL,EAA8B7C,CAAC,CAACsD,eAAF,KAAoBN,CAAC,GAACH,CAAtB,CAA9B;AAAuD;AAAM;;AAAA,UAAG,CAACjD,CAAC,CAACwD,CAAD,CAAD,IAAM,kBAAgBA,CAAC,CAACG,eAAF,CAAkBV,CAAC,CAACW,GAAF,CAAM,CAAN,CAAlB,EAA2BX,CAAC,CAACW,GAAF,CAAM,CAAN,CAA3B,EAAoCX,CAAC,CAACW,GAAF,CAAM,CAAN,CAApC,CAAvB,KAAuEhE,CAAC,IAAE6C,CAA1E,IAA6E,CAACrC,CAAC,CAACoB,IAAhF,IAAsF,CAACpB,CAAC,CAACwB,WAAzF,KAAuG,CAAC5B,CAAC,CAACoD,CAAD,CAAD,IAAMH,CAAC,CAACE,KAAF,KAAUZ,CAAhB,IAAmB3C,CAAC,GAACM,CAAF,IAAK,CAAxB,IAA2BgD,CAAC,GAACE,CAAC,CAACD,KAAJ,GAAUR,CAAtC,MAA2CS,CAAC,GAACH,CAA7C,GAAgDnD,CAAC,IAAE+C,CAA1J,CAAH,EAAgK;AAAMI,MAAAA,CAAC,GAACA,CAAC,CAACY,MAAJ;AAAW;;AAAA,WAAOjE,CAAC,CAACwD,CAAD,CAAD,IAAMF,CAAC,GAACE,CAAC,CAACD,KAAJ,GAAUR,CAAhB,IAAmB,KAAK5B,cAAL,CAAoBuC,YAAvC,KAAsDF,CAAC,GAAC,IAAxD,GAA8DA,CAArE;AAAuE;;AAAAnC,EAAAA,qBAAqB,GAAE;AAAC,UAAMrB,CAAC,GAAC,KAAKe,IAAL,CAAUmD,MAAlB;AAAA,UAAyBhE,CAAC,GAAC,KAAK8C,qBAAhC;AAAsD,QAAI5C,CAAJ;;AAAM,SAAI,IAAIE,CAAC,GAAC,KAAKS,IAAf,EAAoBT,CAApB,EAAsBA,CAAC,GAACA,CAAC,CAAC2D,MAA1B,EAAiC,IAAG3D,CAAC,CAAC6D,YAAF,CAAe,KAAKnD,SAApB,EAA8B,KAAKC,WAAnC,CAAH,EAAmD;AAAC,UAAGjB,CAAC,GAACM,CAAC,CAACiD,KAAJ,IAAWrD,CAAd,EAAgB,OAAOI,CAAP;AAASF,MAAAA,CAAC,GAACE,CAAF;AAAI;;AAAA,WAAOF,CAAP;AAAS;;AAAAkB,EAAAA,gBAAgB,CAACtB,CAAD,EAAG;AAAC,SAAKmB,cAAL,CAAoBiD,eAApB,CAAoC,KAAKrD,IAAzC,EAA8Cf,CAA9C,GAAiD,KAAKe,IAAL,CAAUgB,gBAAV,CAA2B,KAAKd,WAAhC,CAAjD;AAA8F;;AAAQ,MAAJoD,IAAI,GAAE;AAAC,WAAM;AAACC,MAAAA,gBAAgB,EAAC,MAAI,KAAKnC,iBAAL,EAAtB;AAA+CoC,MAAAA,aAAa,EAAC,KAAKpD;AAAlE,KAAN;AAAwF;;AAA3mF;;AAA4mF,MAAMkB,CAAN,SAAgB1B,CAAhB,CAAiB;AAA0B,MAArBqC,qBAAqB,GAAE;AAAC,UAAMV,CAAN;AAAQ;;AAA2B,MAAvBY,uBAAuB,GAAE;AAAC,UAAMZ,CAAN;AAAQ;;AAAAb,EAAAA,OAAO,GAAE,CAAE;;AAAtF;;AAAuF,MAAMa,CAAC,GAAC,IAAIkC,KAAJ,CAAU,qCAAV,CAAR;AAAA,MAAyD/B,CAAC,GAAC,IAAIJ,CAAJ,EAA3D;AAAiE,SAAOI,CAAC,IAAIgC,eAAZ,EAA4B9D,CAAC,IAAI+D,SAAjC","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isSome as e,get as t,isNone as s}from\"../../../core/maybe.js\";import{PROGRESSIVE_LOADING_MODULO as i}from\"./TerrainConst.js\";import{getLayerWithExtentRange as l}from\"./terrainUtils.js\";import{fallsWithinLayer as a}from\"./tileUtils.js\";class r{get updating(){return!!this._tileRequested}init(e,t,s,i){this.tile=e,this._layerIdx=t,this._layerClass=s,this._suspended=i,this._tileLayerInfo=e.getLayerInfo(t,s),this._tileRequested=null;const l=this._findAncestorWithData();this._setUpsampleTile(l)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const t=this._findNextDownload();if(this._tileRequested){if(t===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return e(t)?t.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=t):this._agentDone(),!!this._tileRequested}_findNextDownload(){const r=this._layerIdx,n=this._layerClass,h=this.tile.surface.layerViewByIndex(r,n),d=l(h),{minLevel:_,maxLevel:o}=h.dataLevelRange,u=this._desiredMinLevelDelta,p=this._progressiveLevelModulo+u,y=this._scaleRangeEnabled?a:()=>!0;let f=this.tile;const q=f.level;let v;const I=this._tileLayerInfo.upsampleInfo,L=I?I.tile.level:-1,m=t(d,\"tilemapCache\");for(;f&&y(f,d,!1)&&f.level>=_;){const e=f.level,t=q-e,l=f.layerInfo[n][r];if(l.data&&t>=u){e>L&&this._setUpsampleTile(f),l.dataInvalidated&&(v=f);break}if((s(m)||\"unavailable\"!==m.getAvailability(f.lij[0],f.lij[1],f.lij[2]))&&e<=o&&!l.data&&!l.dataMissing&&((s(v)||f.level===_||e%i==0||q-v.level<u)&&(v=f),t>=p))break;f=f.parent}return e(v)&&q-v.level<u&&this._tileLayerInfo.upsampleInfo&&(v=null),v}_findAncestorWithData(){const e=this.tile.vlevel,t=this._desiredMinLevelDelta;let s;for(let i=this.tile;i;i=i.parent)if(i.hasLayerData(this._layerIdx,this._layerClass)){if(e-i.level>=t)return i;s=i}return s}_setUpsampleTile(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}class n extends r{get _desiredMinLevelDelta(){throw h}get _progressiveLevelModulo(){throw h}dispose(){}}const h=new Error(\"Abstract method called on TileAgent\"),d=new n;export{d as TILE_AGENT_DONE,r as TileAgent};\n"]},"metadata":{},"sourceType":"module"}