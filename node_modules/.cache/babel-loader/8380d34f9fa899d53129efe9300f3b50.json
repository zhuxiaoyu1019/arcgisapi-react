{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../../../../core/has.js\";\nimport { isSome as t, unwrap as r } from \"../../../../../../core/maybe.js\";\nimport { openWithPorts as s } from \"../../../../../../core/workers/workers.js\";\nimport { toQuantizationTransform as i } from \"../../../../../../geometry/support/quantizationUtils.js\";\nimport { convertFromFeatureSet as a, quantizeOptimizedFeatureSet as o } from \"../../../../../../layers/graphics/featureConversionUtils.js\";\nimport { queryOptimizedFeatureSet as n } from \"../../../../../../layers/ogc/ogcFeatureUtils.js\";\nimport { executeQueryPBFBuffer as u, executeQuery as c } from \"../../../../../../rest/query/operations/query.js\";\nimport { FeatureSetReaderJSON as l } from \"../../support/FeatureSetReaderJSON.js\";\nimport { FeatureSetReaderPBF as m } from \"../../support/FeatureSetReaderPBF.js\";\n\nclass p {\n  constructor(e) {\n    this.service = e;\n  }\n\n  destroy() {}\n\n}\n\nfunction y(e) {\n  return Array.isArray(e.source);\n}\n\nfunction f(e) {\n  return e && e.capabilities && e.collection && e.layerDefinition;\n}\n\nfunction d(t) {\n  const {\n    capabilities: r\n  } = t;\n  return f(t.source) ? new F(t) : y(t) ? new h(t) : r.query.supportsFormatPBF && e(\"featurelayer-pbf\") ? new q(t) : new v(t);\n}\n\nclass h extends p {\n  constructor(e) {\n    super(e), this._portsOpen = s(e.source).then(e => this.client = e);\n  }\n\n  destroy() {\n    this.client.close(), this.client = null;\n  }\n\n  async executeQuery(e, t) {\n    await this._portsOpen;\n    const r = await this.client.invoke(\"queryFeatures\", e.toJSON(), t);\n    return l.fromFeatureSet(r, this.service.objectIdField);\n  }\n\n}\n\nclass q extends p {\n  async executeQuery(e, t) {\n    const {\n      data: r\n    } = await u(this.service.source, e, {\n      signal: null == t ? void 0 : t.signal,\n      query: { ...(null == t ? void 0 : t.query),\n        ...this.service.customParameters\n      }\n    }),\n          s = !e.quantizationParameters;\n    return m.fromBuffer(r, this.service.geometryType, s);\n  }\n\n}\n\nclass v extends p {\n  async executeQuery(e, s) {\n    const {\n      source: n,\n      capabilities: u,\n      spatialReference: m,\n      objectIdField: p\n    } = this.service;\n\n    if (t(e.quantizationParameters) && !u.query.supportsQuantization) {\n      const t = e.clone(),\n            u = i(r(t.quantizationParameters));\n      t.quantizationParameters = null;\n      const {\n        data: y\n      } = await c(n, t, m, {\n        signal: null == s ? void 0 : s.signal,\n        query: { ...(null == s ? void 0 : s.query),\n          ...this.service.customParameters\n        }\n      }),\n            f = a(y, p);\n      return o(u, f), l.fromOptimizedFeatureSet(f);\n    }\n\n    const {\n      data: y\n    } = await c(n, e, this.service.spatialReference, { ...s,\n      query: { ...(null == s ? void 0 : s.query),\n        ...this.service.customParameters\n      }\n    });\n    return l.fromFeatureSet(y, this.service.objectIdField);\n  }\n\n}\n\nclass F extends p {\n  async executeQuery(e, t) {\n    const {\n      capabilities: s\n    } = this.service;\n\n    if (e.quantizationParameters && !s.query.supportsQuantization) {\n      const s = e.clone(),\n            a = i(r(s.quantizationParameters));\n      s.quantizationParameters = null;\n      const u = await n(this.service.source, e, t);\n      return o(a, u), l.fromOptimizedFeatureSet(u);\n    }\n\n    const a = await n(this.service.source, e, t);\n    return l.fromOptimizedFeatureSet(a);\n  }\n\n}\n\nexport { p as SourceAdapter, d as createSourceAdapter };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/2d/layers/features/controllers/support/sourceAdapters.js"],"names":["e","isSome","t","unwrap","r","openWithPorts","s","toQuantizationTransform","i","convertFromFeatureSet","a","quantizeOptimizedFeatureSet","o","queryOptimizedFeatureSet","n","executeQueryPBFBuffer","u","executeQuery","c","FeatureSetReaderJSON","l","FeatureSetReaderPBF","m","p","constructor","service","destroy","y","Array","isArray","source","f","capabilities","collection","layerDefinition","d","F","h","query","supportsFormatPBF","q","v","_portsOpen","then","client","close","invoke","toJSON","fromFeatureSet","objectIdField","data","signal","customParameters","quantizationParameters","fromBuffer","geometryType","spatialReference","supportsQuantization","clone","fromOptimizedFeatureSet","SourceAdapter","createSourceAdapter"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../../../../core/has.js\";import{isSome as t,unwrap as r}from\"../../../../../../core/maybe.js\";import{openWithPorts as s}from\"../../../../../../core/workers/workers.js\";import{toQuantizationTransform as i}from\"../../../../../../geometry/support/quantizationUtils.js\";import{convertFromFeatureSet as a,quantizeOptimizedFeatureSet as o}from\"../../../../../../layers/graphics/featureConversionUtils.js\";import{queryOptimizedFeatureSet as n}from\"../../../../../../layers/ogc/ogcFeatureUtils.js\";import{executeQueryPBFBuffer as u,executeQuery as c}from\"../../../../../../rest/query/operations/query.js\";import{FeatureSetReaderJSON as l}from\"../../support/FeatureSetReaderJSON.js\";import{FeatureSetReaderPBF as m}from\"../../support/FeatureSetReaderPBF.js\";class p{constructor(e){this.service=e}destroy(){}}function y(e){return Array.isArray(e.source)}function f(e){return e&&e.capabilities&&e.collection&&e.layerDefinition}function d(t){const{capabilities:r}=t;return f(t.source)?new F(t):y(t)?new h(t):r.query.supportsFormatPBF&&e(\"featurelayer-pbf\")?new q(t):new v(t)}class h extends p{constructor(e){super(e),this._portsOpen=s(e.source).then((e=>this.client=e))}destroy(){this.client.close(),this.client=null}async executeQuery(e,t){await this._portsOpen;const r=await this.client.invoke(\"queryFeatures\",e.toJSON(),t);return l.fromFeatureSet(r,this.service.objectIdField)}}class q extends p{async executeQuery(e,t){const{data:r}=await u(this.service.source,e,{signal:null==t?void 0:t.signal,query:{...null==t?void 0:t.query,...this.service.customParameters}}),s=!e.quantizationParameters;return m.fromBuffer(r,this.service.geometryType,s)}}class v extends p{async executeQuery(e,s){const{source:n,capabilities:u,spatialReference:m,objectIdField:p}=this.service;if(t(e.quantizationParameters)&&!u.query.supportsQuantization){const t=e.clone(),u=i(r(t.quantizationParameters));t.quantizationParameters=null;const{data:y}=await c(n,t,m,{signal:null==s?void 0:s.signal,query:{...null==s?void 0:s.query,...this.service.customParameters}}),f=a(y,p);return o(u,f),l.fromOptimizedFeatureSet(f)}const{data:y}=await c(n,e,this.service.spatialReference,{...s,query:{...null==s?void 0:s.query,...this.service.customParameters}});return l.fromFeatureSet(y,this.service.objectIdField)}}class F extends p{async executeQuery(e,t){const{capabilities:s}=this.service;if(e.quantizationParameters&&!s.query.supportsQuantization){const s=e.clone(),a=i(r(s.quantizationParameters));s.quantizationParameters=null;const u=await n(this.service.source,e,t);return o(a,u),l.fromOptimizedFeatureSet(u)}const a=await n(this.service.source,e,t);return l.fromOptimizedFeatureSet(a)}}export{p as SourceAdapter,d as createSourceAdapter};\n"]},"metadata":{},"sourceType":"module"}