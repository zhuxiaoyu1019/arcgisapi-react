{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { all as e } from \"../../../../../core/promiseUtils.js\";\nimport { c as t } from \"../../../../../chunks/mat4f64.js\";\nimport { a as s } from \"../../../../../chunks/vec2f64.js\";\nimport { f as a, d as n, m as i } from \"../../../../../chunks/vec3.js\";\nimport { c as r } from \"../../../../../chunks/vec3f64.js\";\nimport { c as l } from \"../../../../../chunks/vec4f64.js\";\nimport o from \"../../../support/debugFlags.js\";\nimport { glLayout as c } from \"../../../support/buffer/glUtil.js\";\nimport { bindOutputHighlight as h } from \"../../core/shaderLibrary/output/OutputHighlight.glsl.js\";\nimport d from \"../Camera.js\";\nimport { Default3D as u } from \"../DefaultVertexAttributeLocations.js\";\nimport { assert as p } from \"../Util.js\";\nimport { InstanceData as m, StateFlags as _ } from \"./InstanceData.js\";\nimport { InstanceOctree as f } from \"./InstanceOctree.js\";\nimport { LevelSelector as g } from \"./LevelSelector.js\";\nimport { LodLevel as I } from \"./LodLevel.js\";\nimport { RenderInstanceData as y } from \"./RenderInstanceData.js\";\nimport { DefaultMaterial as D } from \"../../materials/DefaultMaterial.js\";\nimport { colorMixModes as v } from \"../../materials/internal/MaterialUtil.js\";\nimport { encodeDoubleVec3 as b } from \"../../materials/renderers/utils.js\";\nimport { bindVertexBufferLayout as C, unbindVertexBufferLayout as R } from \"../../../../webgl/Util.js\";\n\nlet E = function (e) {\n  const t = e.baseBoundingSphere.radius,\n        s = e.levels.map(e => e.minScreenSpaceRadius);\n  return new g(t, s);\n};\n\nfunction T(e) {\n  E = e;\n}\n\nclass L {\n  constructor(e, t, a, n) {\n    this.type = \"Lod\", this.isGround = !1, this._inverseViewport = s(), this._levels = [], this._defaultRenderInstanceData = [], this._highlightRenderInstanceData = [], this._instanceIndex = 0, this._slicePlane = !1, this._enableLevelSelection = !0, this._lastCamera = new d(), this._updateCyclesWithStaticCamera = -1, this._needFullCycle = !1, this.canRender = !0, this._symbol = e, this._optionalFields = t, this._metadata = a, this._instanceBufferLayout = D.getInstanceBufferLayout({\n      instancedDoublePrecision: !0,\n      instanced: t\n    }), this._glInstanceBufferLayout = c(this._instanceBufferLayout, 1), this._instanceData = new m(this._optionalFields, n), this._instanceData.on(\"instance-added\", () => {\n      this.requestUpdateCycle();\n    }), this._instanceData.on(\"instance-removed\", () => {\n      this.requestUpdateCycle();\n    }), this._instanceData.on(\"instance-transform-changed\", e => {\n      this.requestUpdateCycle(), this._metadata.notifyGraphicGeometryChanged(e.index);\n    }), this._instanceData.on(\"instance-visibility-changed\", e => {\n      this.requestUpdateCycle(!0), this._metadata.notifyGraphicVisibilityChanged(e.index);\n    }), this._instanceData.on(\"instance-highlight-changed\", () => {\n      this.requestUpdateCycle(!0);\n    }), this._enableLevelSelection = this._symbol.levels.length > 1;\n  }\n\n  get levels() {\n    return this._levels;\n  }\n\n  get baseBoundingBox() {\n    return this._levels[this._levels.length - 1].boundingBox;\n  }\n\n  get baseBoundingSphere() {\n    return this._levels[this._levels.length - 1].boundingSphere;\n  }\n\n  get baseMaterial() {\n    return this._levels[this._levels.length - 1].components[0].material;\n  }\n\n  get slicePlane() {\n    return this._slicePlane;\n  }\n\n  set slicePlane(e) {\n    this._slicePlane = e;\n  }\n\n  get intersectionHandlerId() {\n    return this._metadata.layerUid;\n  }\n\n  get instanceData() {\n    return this._instanceData;\n  }\n\n  get memoryUsage() {\n    const e = {\n      cpu: 0,\n      gpu: 0\n    };\n    return this._defaultRenderInstanceData.forEach(t => {\n      const s = t.memoryUsage;\n      e.cpu += s.cpu, e.gpu += s.gpu;\n    }), this._highlightRenderInstanceData.forEach(t => {\n      const s = t.memoryUsage;\n      e.cpu += s.cpu, e.gpu += s.gpu;\n    }), e;\n  }\n\n  get renderStats() {\n    const e = this._instanceData.size,\n          t = [];\n    return this._levels.forEach((e, s) => {\n      const a = this._defaultRenderInstanceData[s],\n            n = this._highlightRenderInstanceData[s],\n            i = a.size + n.size,\n            r = e.triangleCount;\n      t.push({\n        renderedInstances: i,\n        renderedTriangles: i * r,\n        trianglesPerInstance: r\n      });\n    }), {\n      totalInstances: e,\n      renderedInstances: t.reduce((e, t) => e + t.renderedInstances, 0),\n      renderedTriangles: t.reduce((e, t) => e + t.renderedTriangles, 0),\n      levels: t\n    };\n  }\n\n  async initializeRenderContext(t, s) {\n    this._context = t;\n    const a = t.renderContext.rctx;\n    this._levels = await e(this._symbol.levels.map(e => (this._defaultRenderInstanceData.push(new y(a, this._instanceBufferLayout)), this._highlightRenderInstanceData.push(new y(a, this._instanceBufferLayout)), I.create(t, e, s)))), this._levelSelector = E(this);\n  }\n\n  uninitializeRenderContext() {\n    this.invalidateOctree(), this._levels.forEach(e => e.destroy()), this._defaultRenderInstanceData.forEach(e => e.destroy()), this._highlightRenderInstanceData.forEach(e => e.destroy());\n  }\n\n  get slots() {\n    return [4, 6];\n  }\n\n  get needsHighlight() {\n    return this._highlightRenderInstanceData.reduce((e, t) => e + t.size, 0) > 0;\n  }\n\n  prepareRender(e, t) {\n    if (o.LOD_INSTANCE_RENDERER_DISABLE_UPDATES) return;\n\n    if (this._enableLevelSelection) {\n      const e = t.equals(this._lastCamera);\n      this._lastCamera.copyFrom(t), e || this.requestUpdateCycle();\n    }\n\n    const s = this._needFullCycle ? this._instanceData.size : 2e3;\n    this._needFullCycle = !1, this.updateInstances(t, s), this.needsUpdates && this._context.requestRender();\n  }\n\n  render(e) {\n    const t = e.rctx,\n          s = 4 === e.slot ? 3 : 6 === e.slot ? 5 : null;\n    if (!s) return;\n    if (!this.baseMaterial.isVisible() || !this.baseMaterial.isVisibleInPass(e.pass)) return !1;\n    const a = e.camera;\n    this._inverseViewport[0] = 1 / a.fullViewport[2], this._inverseViewport[1] = 1 / a.fullViewport[3];\n    const n = {\n      slot: s,\n      origin: [0, 0, 0],\n      camera: a,\n      inverseViewport: this._inverseViewport,\n      shadowMap: e.shadowMap,\n      shadowMappingEnabled: e.shadowMap.enabled,\n      ssaoHelper: e.ssaoHelper,\n      ssaoEnabled: e.ssaoHelper.enabled,\n      screenToWorldRatio: null,\n      screenToWorldRatioGlobalWM: null,\n      slicePlane: e.sliceHelper && e.sliceHelper.plane,\n      hudVisibilityTexture: e.offscreenRenderingHelper ? e.offscreenRenderingHelper.hudVisibilityTexture : null,\n      highlightDepthTexture: e.offscreenRenderingHelper ? e.offscreenRenderingHelper.depthTexture : null,\n      hasOccludees: !1,\n      linearDepthTexture: null,\n      lastFrameColorTexture: null,\n      reprojectionMat: null,\n      ssrEnabled: !1,\n      lighting: e.scenelightingData,\n      transparencyPassType: e.transparencyPassType,\n      terrainLinearDepthTexture: e.multipassTerrainParams.terrainLinearDepthTexture,\n      geometryLinearDepthTexture: e.multipassGeometryParams.geometryLinearDepthTexture,\n      multipassTerrainEnabled: e.multipassTerrainParams.multipassTerrainEnabled,\n      cullAboveGround: e.multipassTerrainParams.cullAboveGround,\n      multipassGeometryEnabled: e.multipassGeometryParams.multipassGeometryEnabled,\n      highlightColorTexture: null\n    };\n    t.bindVAO();\n    const i = 5 !== e.pass && 7 !== e.pass,\n          r = 6 !== e.pass;\n    return i && this._renderComponents(e, s, n, this._defaultRenderInstanceData), r && this._renderComponents(e, s, n, this._highlightRenderInstanceData), !0;\n  }\n\n  intersect(e, t, s, n) {\n    if (!this.baseMaterial.isVisible()) return;\n    const l = r();\n    a(l, n, s);\n\n    const o = a => {\n      this._instanceData.getCombinedModelTransform(a, V), e.transform.set(V), i(w, s, e.transform.inverse), i(H, n, e.transform.inverse);\n\n      const r = this._instanceData.getState(a),\n            l = this._instanceData.getLodLevel(a);\n\n      p(r & _.ACTIVE, \"invalid instance state\"), p(l >= 0 && l < this._levels.length, \"invaid lod level\"), this._levels[l].intersect(e, t, w, H, a, this._metadata);\n    };\n\n    this.baseMaterial.params.verticalOffset ? this.octree.forEach(o) : this.octree.forEachAlongRay(s, l, o);\n  }\n\n  queryDepthRange(e) {\n    return this.queryDepthRangeOctree(e);\n  }\n\n  notifyShaderTransformationChanged() {\n    this.invalidateOctree();\n  }\n\n  requestUpdateCycle(e = !1) {\n    this._updateCyclesWithStaticCamera = -1, e && (this._needFullCycle = !0), this.needsUpdates && this._context.requestRender();\n  }\n\n  get needsUpdates() {\n    return this._instanceData.size > 0 && this._updateCyclesWithStaticCamera < 1;\n  }\n\n  get octree() {\n    return this._octree || (this._octree = this.buildOctree()), this._octree;\n  }\n\n  invalidateOctree() {\n    this._octree && (this._octree.destroy(), this._octree = null);\n  }\n\n  buildOctree() {\n    const e = new f(this._instanceData, this.baseBoundingSphere),\n          t = this._instanceData,\n          s = t.view ? t.view.state : null;\n\n    for (let a = 0; a < this._instanceData.capacity; ++a) {\n      s.get(a) & _.ACTIVE && e.addInstance(a);\n    }\n\n    return e;\n  }\n\n  queryDepthRangeOctree(e) {\n    const t = e.eye,\n          s = e.viewForward,\n          i = this.octree.findClosest(s, 1, e.frustum),\n          r = this.octree.findClosest(s, -1, e.frustum);\n\n    if (null != i && null != r) {\n      this._instanceData.view.boundingSphere.getVec(i, U), a(U, U, t);\n      const l = n(U, s) - U[3];\n      this._instanceData.view.boundingSphere.getVec(r, U), a(U, U, t);\n      const o = n(U, s) + U[3];\n      return {\n        near: Math.max(e.near, l),\n        far: Math.min(e.far, o)\n      };\n    }\n\n    return {\n      near: 1 / 0,\n      far: -1 / 0\n    };\n  }\n\n  startUpdateCycle() {\n    this._updateCyclesWithStaticCamera++, this._defaultRenderInstanceData.forEach(e => {\n      e.startUpdateCylce();\n    }), this._highlightRenderInstanceData.forEach(e => {\n      e.startUpdateCylce();\n    }), this.needsUpdates && this._context.requestRender();\n  }\n\n  updateInstances(e, t) {\n    const s = this._enableLevelSelection,\n          a = this._levelSelector;\n    a.updateCamera(e), this._defaultRenderInstanceData.forEach(e => {\n      e.beginUpdate();\n    }), this._highlightRenderInstanceData.forEach(e => {\n      e.beginUpdate();\n    });\n    const n = this._instanceData,\n          i = this._instanceData.view,\n          r = n.size,\n          l = n.capacity;\n    let o = this._instanceIndex;\n    t = Math.min(r, t);\n\n    for (let c = 0; c < t; ++c) {\n      0 === o && this.startUpdateCycle();\n      const e = i.state.get(o);\n      let r = 0;\n\n      if (!(e & _.ALLOCATED)) {\n        o = (o + 1) % l, t++;\n        continue;\n      }\n\n      const c = i.lodLevel.get(o);\n      if (e & _.DEFAULT_ACTIVE && this._defaultRenderInstanceData[c].freeTail(), e & _.HIGHLIGHT_ACTIVE && this._highlightRenderInstanceData[c].freeTail(), e & _.REMOVE) n.freeInstance(o);else if (e & _.VISIBLE) {\n        let t = 0;\n        s && (i.modelOrigin.getVec(o, S), t = a.selectLevel(S, n.getCombinedMedianScaleFactor(o))), r = e & ~(_.ACTIVE | _.TRANSFORM_CHANGED), t >= 0 && (e & _.HIGHLIGHT ? (x(this._highlightRenderInstanceData[t], i, o), r |= _.HIGHLIGHT_ACTIVE) : (x(this._defaultRenderInstanceData[t], i, o), r |= _.DEFAULT_ACTIVE)), i.state.set(o, r), i.lodLevel.set(o, t);\n      } else r = e & ~(_.ACTIVE | _.TRANSFORM_CHANGED), i.state.set(o, r);\n\n      if (this._octree) {\n        const t = !!(e & _.ACTIVE),\n              s = !!(r & _.ACTIVE);\n        !t && s ? this._octree.addInstance(o) : t && !s ? this._octree.removeInstance(o) : t && s && e & _.TRANSFORM_CHANGED && (this._octree.removeInstance(o), this._octree.addInstance(o));\n      }\n\n      o = (o + 1) % l;\n    }\n\n    this._instanceIndex = o, this._defaultRenderInstanceData.forEach(e => {\n      e.endUpdate();\n    }), this._highlightRenderInstanceData.forEach(e => {\n      e.endUpdate();\n    });\n  }\n\n  _renderComponents(e, t, s, a) {\n    this.levels.forEach((n, i) => {\n      n.components.forEach(n => {\n        this._renderComponent(e, t, s, a[i], n, i);\n      });\n    });\n  }\n\n  _renderComponent(e, t, s, a, n, i) {\n    const r = n.glMaterials.get(e.pass);\n    if (!r || !r.beginSlot(t) || 0 === a.size) return;\n    const l = e.rctx,\n          c = l.capabilities.instancing;\n    r.ensureParameters(s);\n\n    const d = r.technique,\n          m = d.program,\n          _ = r.getPipelineState(t);\n\n    l.setPipelineState(_), l.useProgram(m), r.bind(s), l.bindVAO(n.vao), d.ensureAttributeLocations(n.vao), e.isHighlightPass && h(m, s), d.bindDraw(s, {}, {}), o.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL && 0 === e.pass && (m.setUniform4fv(\"externalColor\", O[Math.min(i, O.length - 1)]), m.setUniform1i(\"colorMixMode\", v.replace));\n\n    const f = a.capacity,\n          g = a.headIndex,\n          I = a.tailIndex,\n          y = a.firstIndex,\n          D = this._glInstanceBufferLayout,\n          b = (e, t) => {\n      C(l, u, a.buffer, D, e), c.drawArraysInstanced(d.primitiveType, 0, n.vertexCount, t - e), R(l, u, a.buffer, D);\n    };\n\n    n.material.params.transparent && null != y ? g > I ? (p(y >= I && y <= g, \"invalid firstIndex\"), b(y, g), b(I, y)) : g < I && (y <= g ? (p(y >= 0 && y <= g, \"invalid firstIndex\"), b(y, g), b(I, f), b(0, y)) : (p(y >= I && y <= f, \"invalid firstIndex\"), b(y, f), b(0, g), b(I, y))) : g > I ? b(I, g) : g < I && (b(0, g), b(I, f)), l.bindVAO(null);\n  }\n\n}\n\nfunction x(e, t, s) {\n  const a = e.allocateHead();\n  A(t, s, e.view, a);\n}\n\nfunction A(e, t, s, a) {\n  b(e.modelOrigin, t, s.modelOriginHi, s.modelOriginLo, a), s.model.copyFrom(a, e.model, t), s.modelNormal.copyFrom(a, e.modelNormal, t), e.color && s.color && s.color.copyFrom(a, e.color, t), e.featureAttribute && s.featureAttribute && s.featureAttribute.copyFrom(a, e.featureAttribute, t);\n}\n\nconst S = r(),\n      U = l(),\n      V = t(),\n      w = r(),\n      H = r(),\n      O = [[1, 0, 1, 1], [0, 0, 1, 1], [0, 1, 0, 1], [1, 1, 0, 1], [1, 0, 0, 1]];\nexport { L as LodRenderer, T as setLevelSelectorFactory };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/webgl-engine/lib/lodRendering/LodRenderer.js"],"names":["all","e","c","t","a","s","f","d","n","m","i","r","l","o","glLayout","bindOutputHighlight","h","Default3D","u","assert","p","InstanceData","StateFlags","_","InstanceOctree","LevelSelector","g","LodLevel","I","RenderInstanceData","y","DefaultMaterial","D","colorMixModes","v","encodeDoubleVec3","b","bindVertexBufferLayout","C","unbindVertexBufferLayout","R","E","baseBoundingSphere","radius","levels","map","minScreenSpaceRadius","T","L","constructor","type","isGround","_inverseViewport","_levels","_defaultRenderInstanceData","_highlightRenderInstanceData","_instanceIndex","_slicePlane","_enableLevelSelection","_lastCamera","_updateCyclesWithStaticCamera","_needFullCycle","canRender","_symbol","_optionalFields","_metadata","_instanceBufferLayout","getInstanceBufferLayout","instancedDoublePrecision","instanced","_glInstanceBufferLayout","_instanceData","on","requestUpdateCycle","notifyGraphicGeometryChanged","index","notifyGraphicVisibilityChanged","length","baseBoundingBox","boundingBox","boundingSphere","baseMaterial","components","material","slicePlane","intersectionHandlerId","layerUid","instanceData","memoryUsage","cpu","gpu","forEach","renderStats","size","triangleCount","push","renderedInstances","renderedTriangles","trianglesPerInstance","totalInstances","reduce","initializeRenderContext","_context","renderContext","rctx","create","_levelSelector","uninitializeRenderContext","invalidateOctree","destroy","slots","needsHighlight","prepareRender","LOD_INSTANCE_RENDERER_DISABLE_UPDATES","equals","copyFrom","updateInstances","needsUpdates","requestRender","render","slot","isVisible","isVisibleInPass","pass","camera","fullViewport","origin","inverseViewport","shadowMap","shadowMappingEnabled","enabled","ssaoHelper","ssaoEnabled","screenToWorldRatio","screenToWorldRatioGlobalWM","sliceHelper","plane","hudVisibilityTexture","offscreenRenderingHelper","highlightDepthTexture","depthTexture","hasOccludees","linearDepthTexture","lastFrameColorTexture","reprojectionMat","ssrEnabled","lighting","scenelightingData","transparencyPassType","terrainLinearDepthTexture","multipassTerrainParams","geometryLinearDepthTexture","multipassGeometryParams","multipassTerrainEnabled","cullAboveGround","multipassGeometryEnabled","highlightColorTexture","bindVAO","_renderComponents","intersect","getCombinedModelTransform","V","transform","set","w","inverse","H","getState","getLodLevel","ACTIVE","params","verticalOffset","octree","forEachAlongRay","queryDepthRange","queryDepthRangeOctree","notifyShaderTransformationChanged","_octree","buildOctree","view","state","capacity","get","addInstance","eye","viewForward","findClosest","frustum","getVec","U","near","Math","max","far","min","startUpdateCycle","startUpdateCylce","updateCamera","beginUpdate","ALLOCATED","lodLevel","DEFAULT_ACTIVE","freeTail","HIGHLIGHT_ACTIVE","REMOVE","freeInstance","VISIBLE","modelOrigin","S","selectLevel","getCombinedMedianScaleFactor","TRANSFORM_CHANGED","HIGHLIGHT","x","removeInstance","endUpdate","_renderComponent","glMaterials","beginSlot","capabilities","instancing","ensureParameters","technique","program","getPipelineState","setPipelineState","useProgram","bind","vao","ensureAttributeLocations","isHighlightPass","bindDraw","LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL","setUniform4fv","O","setUniform1i","replace","headIndex","tailIndex","firstIndex","buffer","drawArraysInstanced","primitiveType","vertexCount","transparent","allocateHead","A","modelOriginHi","modelOriginLo","model","modelNormal","color","featureAttribute","LodRenderer","setLevelSelectorFactory"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{all as e}from\"../../../../../core/promiseUtils.js\";import{c as t}from\"../../../../../chunks/mat4f64.js\";import{a as s}from\"../../../../../chunks/vec2f64.js\";import{f as a,d as n,m as i}from\"../../../../../chunks/vec3.js\";import{c as r}from\"../../../../../chunks/vec3f64.js\";import{c as l}from\"../../../../../chunks/vec4f64.js\";import o from\"../../../support/debugFlags.js\";import{glLayout as c}from\"../../../support/buffer/glUtil.js\";import{bindOutputHighlight as h}from\"../../core/shaderLibrary/output/OutputHighlight.glsl.js\";import d from\"../Camera.js\";import{Default3D as u}from\"../DefaultVertexAttributeLocations.js\";import{assert as p}from\"../Util.js\";import{InstanceData as m,StateFlags as _}from\"./InstanceData.js\";import{InstanceOctree as f}from\"./InstanceOctree.js\";import{LevelSelector as g}from\"./LevelSelector.js\";import{LodLevel as I}from\"./LodLevel.js\";import{RenderInstanceData as y}from\"./RenderInstanceData.js\";import{DefaultMaterial as D}from\"../../materials/DefaultMaterial.js\";import{colorMixModes as v}from\"../../materials/internal/MaterialUtil.js\";import{encodeDoubleVec3 as b}from\"../../materials/renderers/utils.js\";import{bindVertexBufferLayout as C,unbindVertexBufferLayout as R}from\"../../../../webgl/Util.js\";let E=function(e){const t=e.baseBoundingSphere.radius,s=e.levels.map((e=>e.minScreenSpaceRadius));return new g(t,s)};function T(e){E=e}class L{constructor(e,t,a,n){this.type=\"Lod\",this.isGround=!1,this._inverseViewport=s(),this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new d,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.canRender=!0,this._symbol=e,this._optionalFields=t,this._metadata=a,this._instanceBufferLayout=D.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:t}),this._glInstanceBufferLayout=c(this._instanceBufferLayout,1),this._instanceData=new m(this._optionalFields,n),this._instanceData.on(\"instance-added\",(()=>{this.requestUpdateCycle()})),this._instanceData.on(\"instance-removed\",(()=>{this.requestUpdateCycle()})),this._instanceData.on(\"instance-transform-changed\",(e=>{this.requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(e.index)})),this._instanceData.on(\"instance-visibility-changed\",(e=>{this.requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(e.index)})),this._instanceData.on(\"instance-highlight-changed\",(()=>{this.requestUpdateCycle(!0)})),this._enableLevelSelection=this._symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlane(){return this._slicePlane}set slicePlane(e){this._slicePlane=e}get intersectionHandlerId(){return this._metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach((t=>{const s=t.memoryUsage;e.cpu+=s.cpu,e.gpu+=s.gpu})),this._highlightRenderInstanceData.forEach((t=>{const s=t.memoryUsage;e.cpu+=s.cpu,e.gpu+=s.gpu})),e}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,s)=>{const a=this._defaultRenderInstanceData[s],n=this._highlightRenderInstanceData[s],i=a.size+n.size,r=e.triangleCount;t.push({renderedInstances:i,renderedTriangles:i*r,trianglesPerInstance:r})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}async initializeRenderContext(t,s){this._context=t;const a=t.renderContext.rctx;this._levels=await e(this._symbol.levels.map((e=>(this._defaultRenderInstanceData.push(new y(a,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new y(a,this._instanceBufferLayout)),I.create(t,e,s))))),this._levelSelector=E(this)}uninitializeRenderContext(){this.invalidateOctree(),this._levels.forEach((e=>e.destroy())),this._defaultRenderInstanceData.forEach((e=>e.destroy())),this._highlightRenderInstanceData.forEach((e=>e.destroy()))}get slots(){return[4,6]}get needsHighlight(){return this._highlightRenderInstanceData.reduce(((e,t)=>e+t.size),0)>0}prepareRender(e,t){if(o.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const e=t.equals(this._lastCamera);this._lastCamera.copyFrom(t),e||this.requestUpdateCycle()}const s=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this.updateInstances(t,s),this.needsUpdates&&this._context.requestRender()}render(e){const t=e.rctx,s=4===e.slot?3:6===e.slot?5:null;if(!s)return;if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(e.pass))return!1;const a=e.camera;this._inverseViewport[0]=1/a.fullViewport[2],this._inverseViewport[1]=1/a.fullViewport[3];const n={slot:s,origin:[0,0,0],camera:a,inverseViewport:this._inverseViewport,shadowMap:e.shadowMap,shadowMappingEnabled:e.shadowMap.enabled,ssaoHelper:e.ssaoHelper,ssaoEnabled:e.ssaoHelper.enabled,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:e.sliceHelper&&e.sliceHelper.plane,hudVisibilityTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.hudVisibilityTexture:null,highlightDepthTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.depthTexture:null,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1,lighting:e.scenelightingData,transparencyPassType:e.transparencyPassType,terrainLinearDepthTexture:e.multipassTerrainParams.terrainLinearDepthTexture,geometryLinearDepthTexture:e.multipassGeometryParams.geometryLinearDepthTexture,multipassTerrainEnabled:e.multipassTerrainParams.multipassTerrainEnabled,cullAboveGround:e.multipassTerrainParams.cullAboveGround,multipassGeometryEnabled:e.multipassGeometryParams.multipassGeometryEnabled,highlightColorTexture:null};t.bindVAO();const i=5!==e.pass&&7!==e.pass,r=6!==e.pass;return i&&this._renderComponents(e,s,n,this._defaultRenderInstanceData),r&&this._renderComponents(e,s,n,this._highlightRenderInstanceData),!0}intersect(e,t,s,n){if(!this.baseMaterial.isVisible())return;const l=r();a(l,n,s);const o=a=>{this._instanceData.getCombinedModelTransform(a,V),e.transform.set(V),i(w,s,e.transform.inverse),i(H,n,e.transform.inverse);const r=this._instanceData.getState(a),l=this._instanceData.getLodLevel(a);p(r&_.ACTIVE,\"invalid instance state\"),p(l>=0&&l<this._levels.length,\"invaid lod level\"),this._levels[l].intersect(e,t,w,H,a,this._metadata)};this.baseMaterial.params.verticalOffset?this.octree.forEach(o):this.octree.forEachAlongRay(s,l,o)}queryDepthRange(e){return this.queryDepthRangeOctree(e)}notifyShaderTransformationChanged(){this.invalidateOctree()}requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this.needsUpdates&&this._context.requestRender()}get needsUpdates(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}get octree(){return this._octree||(this._octree=this.buildOctree()),this._octree}invalidateOctree(){this._octree&&(this._octree.destroy(),this._octree=null)}buildOctree(){const e=new f(this._instanceData,this.baseBoundingSphere),t=this._instanceData,s=t.view?t.view.state:null;for(let a=0;a<this._instanceData.capacity;++a){s.get(a)&_.ACTIVE&&e.addInstance(a)}return e}queryDepthRangeOctree(e){const t=e.eye,s=e.viewForward,i=this.octree.findClosest(s,1,e.frustum),r=this.octree.findClosest(s,-1,e.frustum);if(null!=i&&null!=r){this._instanceData.view.boundingSphere.getVec(i,U),a(U,U,t);const l=n(U,s)-U[3];this._instanceData.view.boundingSphere.getVec(r,U),a(U,U,t);const o=n(U,s)+U[3];return{near:Math.max(e.near,l),far:Math.min(e.far,o)}}return{near:1/0,far:-1/0}}startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this._highlightRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this.needsUpdates&&this._context.requestRender()}updateInstances(e,t){const s=this._enableLevelSelection,a=this._levelSelector;a.updateCamera(e),this._defaultRenderInstanceData.forEach((e=>{e.beginUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.beginUpdate()}));const n=this._instanceData,i=this._instanceData.view,r=n.size,l=n.capacity;let o=this._instanceIndex;t=Math.min(r,t);for(let c=0;c<t;++c){0===o&&this.startUpdateCycle();const e=i.state.get(o);let r=0;if(!(e&_.ALLOCATED)){o=(o+1)%l,t++;continue}const c=i.lodLevel.get(o);if(e&_.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[c].freeTail(),e&_.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[c].freeTail(),e&_.REMOVE)n.freeInstance(o);else if(e&_.VISIBLE){let t=0;s&&(i.modelOrigin.getVec(o,S),t=a.selectLevel(S,n.getCombinedMedianScaleFactor(o))),r=e&~(_.ACTIVE|_.TRANSFORM_CHANGED),t>=0&&(e&_.HIGHLIGHT?(x(this._highlightRenderInstanceData[t],i,o),r|=_.HIGHLIGHT_ACTIVE):(x(this._defaultRenderInstanceData[t],i,o),r|=_.DEFAULT_ACTIVE)),i.state.set(o,r),i.lodLevel.set(o,t)}else r=e&~(_.ACTIVE|_.TRANSFORM_CHANGED),i.state.set(o,r);if(this._octree){const t=!!(e&_.ACTIVE),s=!!(r&_.ACTIVE);!t&&s?this._octree.addInstance(o):t&&!s?this._octree.removeInstance(o):t&&s&&e&_.TRANSFORM_CHANGED&&(this._octree.removeInstance(o),this._octree.addInstance(o))}o=(o+1)%l}this._instanceIndex=o,this._defaultRenderInstanceData.forEach((e=>{e.endUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.endUpdate()}))}_renderComponents(e,t,s,a){this.levels.forEach(((n,i)=>{n.components.forEach((n=>{this._renderComponent(e,t,s,a[i],n,i)}))}))}_renderComponent(e,t,s,a,n,i){const r=n.glMaterials.get(e.pass);if(!r||!r.beginSlot(t)||0===a.size)return;const l=e.rctx,c=l.capabilities.instancing;r.ensureParameters(s);const d=r.technique,m=d.program,_=r.getPipelineState(t);l.setPipelineState(_),l.useProgram(m),r.bind(s),l.bindVAO(n.vao),d.ensureAttributeLocations(n.vao),e.isHighlightPass&&h(m,s),d.bindDraw(s,{},{}),o.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===e.pass&&(m.setUniform4fv(\"externalColor\",O[Math.min(i,O.length-1)]),m.setUniform1i(\"colorMixMode\",v.replace));const f=a.capacity,g=a.headIndex,I=a.tailIndex,y=a.firstIndex,D=this._glInstanceBufferLayout,b=(e,t)=>{C(l,u,a.buffer,D,e),c.drawArraysInstanced(d.primitiveType,0,n.vertexCount,t-e),R(l,u,a.buffer,D)};n.material.params.transparent&&null!=y?g>I?(p(y>=I&&y<=g,\"invalid firstIndex\"),b(y,g),b(I,y)):g<I&&(y<=g?(p(y>=0&&y<=g,\"invalid firstIndex\"),b(y,g),b(I,f),b(0,y)):(p(y>=I&&y<=f,\"invalid firstIndex\"),b(y,f),b(0,g),b(I,y))):g>I?b(I,g):g<I&&(b(0,g),b(I,f)),l.bindVAO(null)}}function x(e,t,s){const a=e.allocateHead();A(t,s,e.view,a)}function A(e,t,s,a){b(e.modelOrigin,t,s.modelOriginHi,s.modelOriginLo,a),s.model.copyFrom(a,e.model,t),s.modelNormal.copyFrom(a,e.modelNormal,t),e.color&&s.color&&s.color.copyFrom(a,e.color,t),e.featureAttribute&&s.featureAttribute&&s.featureAttribute.copyFrom(a,e.featureAttribute,t)}const S=r(),U=l(),V=t(),w=r(),H=r(),O=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]];export{L as LodRenderer,T as setLevelSelectorFactory};\n"]},"metadata":{},"sourceType":"module"}