{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isSome as e, isNone as t, unwrap as i } from \"../../../../core/maybe.js\";\nimport s from \"../../../../core/PooledArray.js\";\nimport { isAbortError as r } from \"../../../../core/promiseUtils.js\";\nimport { l as n } from \"../../../../chunks/vec3.js\";\nimport { b as o } from \"../../../../chunks/vec4f64.js\";\nimport { NodeBase as a, Node as d, NodeTraversalState as l } from \"./I3SNode.js\";\nimport { addWraparound as h } from \"./I3SUtil.js\";\nimport { clone as u } from \"../../support/orientedBoundingBox.js\";\n\nclass c {\n  constructor(e, t, i, s, r) {\n    this.childOffset = e, this.childCount = t, this.visibilityCache = i, this.ref = s, this.node = r, this.useAsHole = 0, this.filterImpact = 2;\n  }\n\n}\n\nclass g {\n  constructor(e, t, i, r, n, o, a, d, l, h, u, c, g, m) {\n    this.streamDataController = i, this.viewportQueries = r, this.logger = n, this.holeFilling = o, this._isLoaded = a, this._isReloading = d, this._isSelected = l, this._enable = h, this._needsUpdate = u, this._canRequest = c, this._computeVisibilityObb = g, this._computeNodeFiltering = m, this._dirty = !0, this._nodePages = [], this.nodeCount = 0, this.nodesPerPage = 0, this.rootIndex = 0, this.lodMetric = 0, this.lodConversion = e => e, this.urlPrefix = \"\", this._loading = new Set(), this._failedNodes = new Set(), this._failedPages = new Set(), this._indexMissing = 1, this._maxUnloadedPrio = Number.NEGATIVE_INFINITY, this._maxProcessingPrio = Number.POSITIVE_INFINITY, this._nodeTraversalState = new Map(), this._version = b(0), this._visibilityCacheVersion = b(0), this._maxLevel = 1, this._featureEstimate = {\n      estimate: 0,\n      leavesReached: !1\n    }, this._unloadedMemoryEstimate = 0, this._missing = new s({\n      deallocator: null\n    }), this._prefetch = new s({\n      deallocator: null\n    }), this._updates = new f(), this._imModificationUncategorized = new s({\n      deallocator: null\n    }), this.ignoreServiceObb = !1, this.progressiveLoadPenalty = 0, this.layerHasModifications = !1, this._layerHasFilter = !1, this.logLayer = e, e.serviceUpdateTimeStamp && e.serviceUpdateTimeStamp.lastUpdate && (this.lastUpdate = `${e.serviceUpdateTimeStamp.lastUpdate}`), this._maxLodLevel = this.viewportQueries ? this.viewportQueries.maxLodLevel : 1, this.init(t);\n  }\n\n  init(e) {\n    if (\"page\" === e.type) {\n      switch (this.urlPrefix = e.urlPrefix, this.nodesPerPage = e.pageSize, this.rootIndex = e.rootIndex, e.lodMetric) {\n        case \"maxScreenThreshold\":\n          this.lodMetric = 1;\n          break;\n\n        case \"maxScreenThresholdSQ\":\n          this.lodMetric = 1, this.lodConversion = M;\n      }\n\n      this.addPage(N(this.rootIndex, this.nodesPerPage), e.rootPage);\n    } else if (\"node\" === e.type) {\n      this.urlPrefix = e.urlPrefix, this._nodePages.push({\n        nodes: [],\n        children: [],\n        parents: []\n      }), this.makeRefNode(new a(e.rootNode.id, null), -1);\n\n      const t = this._validateNode(e.rootNode.id, e.rootNode);\n\n      t && this.addNode(t, 0);\n    }\n  }\n\n  loadPage(e) {\n    this._loading.add(e);\n\n    const t = this.urlPrefix + e;\n    this.streamDataController.request(t, \"json\").then(t => {\n      this._loading.delete(e), this.addPage(e, t);\n    }).catch(t => {\n      this._loading.delete(e), r(t) || (this._failedPages.add(e), this.logger.error(\"#loadPage()\", this.logLayer, `Error when loading page ${e}`, t));\n    });\n  }\n\n  addPage(e, t) {\n    for (let n = this._nodePages.length; n < e; n++) this._nodePages[n] = null;\n\n    const i = [],\n          s = [],\n          r = t.nodes.map((t, r) => {\n      const a = i.length,\n            l = t.children ? t.children.length : 0;\n      s.push(-1);\n\n      for (let e = 0; e < l; e++) i.push(t.children[e]);\n\n      const h = `${t.index}`,\n            g = u(t.obb),\n            m = o([g.center[0], g.center[1], g.center[2], n(g.halfSize)]),\n            f = t.mesh && t.mesh.attribute,\n            _ = t.mesh && t.mesh.geometry,\n            b = t.mesh && t.mesh.material,\n            p = {\n        hasSharedResource: !1,\n        hasFeatureData: !!_,\n        attributes: f && null != f.resource ? `${f.resource}` : null,\n        geometry: _ && null != _.resource ? `${_.resource}` : null,\n        texture: b && null != b.resource ? `${b.resource}` : null,\n        geometryDefinition: _ ? _.definition : -1,\n        materialDefinition: b ? b.definition : -1\n      },\n            y = new d(h, e * this.nodesPerPage + r, m, l, 0, p, this.lastUpdate, this.lodMetric, this.lodConversion(t.lodThreshold), _ ? _.featureCount : null);\n\n      return y.serviceObb = g, y.visibilityObb = this._computeVisibilityObb(y), y.vertexCount = _ ? _.vertexCount : 0, new c(a, l, v(this._visibilityCacheVersion), null, y);\n    });\n    this._nodePages[e] = {\n      nodes: r,\n      children: i,\n      parents: s\n    }, this.nodeCount += r.length, this.updateParentsAndLevel();\n  }\n\n  updateParentsAndLevel() {\n    const t = new Array(),\n          i = (i, s, r) => {\n      const n = this.getPage(i);\n\n      if (e(n)) {\n        const o = x(i, this.nodesPerPage);\n        n.parents[o] = s;\n        const a = n.nodes[o].node;\n        e(a) && (a.level = r, t.push(i));\n      }\n    };\n\n    for (i(this.rootIndex, -1, 0); t.length;) {\n      const s = t.pop(),\n            r = this.getNode(s);\n      if (e(r)) for (let e = 0; e < r.childCount; e++) {\n        i(this.getChildIndex(r, e), s, r.level + 1), this._maxLevel = Math.max(this._maxLevel, r.level + 1);\n      }\n    }\n  }\n\n  getPage(e) {\n    return this._nodePages[N(e, this.nodesPerPage)];\n  }\n\n  getNodeInternal(e) {\n    const i = this.getPage(e);\n    return t(i) ? null : i.nodes[x(e, this.nodesPerPage)];\n  }\n\n  addNode(t, s) {\n    null != t.children && this.populateChildren(s, t.children);\n    const r = this.getParent(s),\n          n = e(r) ? r.level + 1 : 0;\n    this._maxLevel = Math.max(this._maxLevel, t.children ? n + 1 : n);\n    const {\n      lodMetric: a,\n      maxError: l\n    } = w(t.lodSelection),\n          h = i(this.getNodeInternal(s));\n    return h.node = new d(t.id, s, o(t.mbs), h.childCount, n, t.resources, t.version, a, l, t.numFeatures), t.obb && (h.node.serviceObb = u(t.obb)), h.node.visibilityObb = this._computeVisibilityObb(h.node), e(h.ref) && (null == h.ref.mbs && (h.ref.mbs = t.mbs), h.node.renderMbs = h.ref.renderMbs, h.node.serviceObbInRenderSR = h.ref.serviceObbInRenderSR, h.ref.visibilityObb = h.node.visibilityObb), h.node;\n  }\n\n  makeRefNode(t, i) {\n    const s = this._nodePages[0],\n          r = s.nodes.length;\n    return s.nodes.push(new c(0, 0, v(this._visibilityCacheVersion), t, null)), this.nodeCount++, s.parents.push(i), t.renderMbs[3] = -1, e(t.serviceObbInRenderSR) && (t.serviceObbInRenderSR.halfSize[0] = -1), r;\n  }\n\n  populateChildren(e, t) {\n    const s = i(this.getNodeInternal(e)),\n          r = i(this.getPage(e));\n    s.childOffset = r.children.length, s.childCount = t.length;\n\n    for (let i = 0; i < t.length; i++) {\n      const s = this.makeRefNode(t[i], e);\n      r.children.push(s);\n    }\n  }\n\n  getNode(t) {\n    const i = this.getNodeInternal(t);\n    return e(i) ? i.node : null;\n  }\n\n  getIndexById(t) {\n    let i;\n    return this.forAllNodes((s, r) => {\n      (e(s.node) && s.node.id === t || e(s.ref) && s.ref.id === t) && (i = r);\n    }), i;\n  }\n\n  getNodeById(e) {\n    const t = this.getIndexById(e);\n    return t >= 0 ? this.getNode(t) : null;\n  }\n\n  getChildIndex(e, i) {\n    const s = this.getPage(e.index);\n    if (t(s)) return -1;\n    const r = s.nodes[x(e.index, this.nodesPerPage)];\n    return s.children[r.childOffset + i];\n  }\n\n  getParentIndex(t) {\n    const i = this.getPage(t);\n    return e(i) ? i.parents[x(t, this.nodesPerPage)] : -1;\n  }\n\n  getParent(e) {\n    return (e = this.getParentIndex(e)) >= 0 ? this.getNode(e) : null;\n  }\n\n  isLeaf(t) {\n    const i = this.getNodeInternal(t);\n    return e(i) && 0 === i.childCount;\n  }\n\n  get rootNode() {\n    return this.getNode(this.rootIndex);\n  }\n\n  get size() {\n    return this.nodeCount;\n  }\n\n  invalidateVisibilityCache() {\n    this._visibilityCacheVersion = b(this._visibilityCacheVersion);\n  }\n\n  invalidateNodeVisibilityCache(t) {\n    const i = this.getNodeInternal(t);\n    e(i) && this.invalidateNodeVisibilityCacheInternal(i);\n  }\n\n  invalidateNodeVisibilityCacheInternal(e) {\n    e.visibilityCache = v(this._visibilityCacheVersion);\n  }\n\n  invalidateBoundingVolumeCache(t) {\n    const i = this.getNodeInternal(t);\n    e(i) && (_(i), this.invalidateNodeVisibilityCacheInternal(i));\n  }\n\n  invalidateGeometryVisibility(t) {\n    const i = this.getNodeInternal(t);\n    e(i) && e(i.node) && (i.node.geometryObb = null, i.node.renderMbs[3] = -1, e(i.node.serviceObbInRenderSR) && (i.node.serviceObbInRenderSR.halfSize[0] = -1));\n  }\n\n  invalidateVisibilityObbs() {\n    t(this.rootNode) || this.traverse(this.rootNode, e => (e.visibilityObb = this._computeVisibilityObb(e), e.geometryObb = null, !0));\n  }\n\n  isNodeVisible(i) {\n    const s = this.getNodeInternal(i);\n    if (t(s) || e(s.ref) && !s.ref.mbs) return !0;\n\n    if (!y(s.visibilityCache, this._visibilityCacheVersion)) {\n      const i = s.node,\n            r = e(i) && (t(s.ref) || e(i.visibilityObb)) ? i : e(s.ref) ? s.ref : null;\n\n      if (this._layerHasFilter && this._computeNodeFiltering && (e(i) || e(s.ref)) && 2 === s.filterImpact) {\n        const t = e(i) ? i.mbs : e(s.ref) ? s.ref.mbs : null;\n        s.filterImpact = null != t ? this._computeNodeFiltering(t) : 0;\n      }\n\n      const n = e(i) && 1 === s.filterImpact,\n            o = !(e(i) && 2 === i.imModificationImpact) && (!r || this.viewportQueries.isNodeVisible(r)) && !n;\n      return s.visibilityCache = p(o, this._visibilityCacheVersion), o;\n    }\n\n    return P(s.visibilityCache);\n  }\n\n  isGeometryVisible(t) {\n    if (!this.isNodeVisible(t)) return !1;\n    const i = this.getNodeInternal(t);\n    return !(e(i) && e(i.node) && e(i.node.geometryObb) && (!this.layerHasModifications || 4 !== i.node.imModificationImpact)) || this.viewportQueries.isGeometryVisible(i.node);\n  }\n\n  _traverseCoverage(s, r, n, o, a) {\n    const d = this.getPage(s);\n    if (t(d) || 0 === r.childCount) return;\n    const l = r.childOffset + r.childCount,\n          h = new Array();\n\n    for (let t = r.childOffset; t < l; ++t) {\n      const i = d.children[t],\n            s = this.getNodeInternal(i);\n      e(s) && e(s.node) && this.isGeometryVisible(i) && h.push(s);\n    }\n\n    o /= h.length;\n\n    for (const e of h) {\n      const t = i(e.node).index;\n      this._isLoaded(t) || this._isReloading(t) ? (a.delta = Math.max(a.delta, n), a.coverage += o) : this._traverseCoverage(t, e, n + 1, o, a);\n    }\n  }\n\n  useNodeAsHole(e) {\n    if (\"off\" === this.holeFilling) return !1;\n    const i = this.getNodeInternal(e);\n    if (t(i)) return !1;\n    if (\"always\" === this.holeFilling) return !0;\n    if (y(i.useAsHole, this._version)) return P(i.useAsHole);\n    const s = {\n      delta: 0,\n      coverage: 0\n    };\n\n    this._traverseCoverage(e, i, 0, 1, s);\n\n    const r = s.delta * s.coverage <= .5;\n    return i.useAsHole = p(r, this._version), r;\n  }\n\n  get maxLevel() {\n    return this._maxLevel;\n  }\n\n  get dirty() {\n    return this._dirty;\n  }\n\n  destroy() {\n    this._updates.add.prune(), this._updates.update.prune();\n  }\n\n  requestUpdate() {\n    this._dirty = !0, this._indexMissing = 1, this._version = b(this._version);\n  }\n\n  imModificationsChanged(t) {\n    this.layerHasModifications = t, this.forAllNodes(({\n      node: t\n    }) => {\n      e(t) && (t.imModificationImpact = 4, t.visibilityObb = this._computeVisibilityObb(t), t.hasModifications && this.invalidateGeometryVisibility(t.index));\n    }), this.invalidateVisibilityCache();\n  }\n\n  layerFilterChanged(t) {\n    this._layerHasFilter = t, this.forAllNodes(t => {\n      if (e(t)) {\n        t.filterImpact = 2;\n        const i = t.node;\n        e(i) && this.invalidateNodeVisibilityCache(i.index);\n      }\n    }), this.invalidateVisibilityCache();\n  }\n\n  update(s, r, n) {\n    if (!this._dirty) return;\n    this._maxUnloadedPrio = Number.NEGATIVE_INFINITY, this._maxProcessingPrio = Number.NEGATIVE_INFINITY, this._missing.clear(), this._prefetch.clear(), this._updates.reset(s, this._missing), m.clear();\n    let o = !0;\n    const a = new C(),\n          d = new C(),\n          l = this._imModificationUncategorized;\n    l.clear();\n\n    const h = new Set(),\n          u = (u, c, g) => {\n      if (t(c)) {\n        let e = this.entryPriority(u);\n        e === 1 / 0 && (e = this.entryPriority(g));\n        const t = N(u, this.nodesPerPage);\n        return m.set(t, Math.max(e, m.get(t) || 0)), this._loading.has(t) || this._failedPages.has(t) || this._missing.push(t), void (this._maxProcessingPrio = Math.max(this._maxProcessingPrio, e));\n      }\n\n      const f = c.node;\n\n      if (this._updateNodeFeatureEstimate(f, d), t(f)) {\n        const e = this.entryPriority(u);\n        return this._loading.has(u) || this._failedNodes.has(u) || (this._missing.push(u), m.set(u, e)), void (this._maxProcessingPrio = Math.max(this._maxProcessingPrio, e));\n      }\n\n      const _ = i(this.getPage(u));\n\n      if (0 === this._missing.length && 0 === this.nodesPerPage) for (let t = 0; t < c.childCount; t++) {\n        const i = _.children[c.childOffset + t],\n              s = this.getNodeInternal(i);\n        !e(s) || s.node || this._loading.has(i) || this._failedNodes.has(i) || (m.set(i, this.entryPriority(i)), this._prefetch.push(i));\n      }\n      if (f.failed || !f.resources.hasFeatureData) return;\n\n      if (h.add(f.id), this._isLoaded(u)) {\n        if (a.known += f.memory, ++a.knownNodes, this._isSelected(f) ? c.childCount > 0 && (o = !1) : (a.unremoved += f.memory, o = !1), this._needsUpdate(f)) {\n          const e = this.entryPriority(u);\n          m.set(u, e), this._maxProcessingPrio = Math.max(this._maxProcessingPrio, e), this._updates.update.push(u);\n        }\n\n        return;\n      }\n\n      if (f.memory && (a.known += f.memory, ++a.knownNodes), !this._isSelected(f)) return void (this._isReloading(u) && this._updates.remove.push(u));\n      if (c.childCount > 0 && (o = !1), f.memory ? (a.missing += f.memory, a.known += f.memory, ++a.knownNodes) : ++a.missingNodes, s.indexOf(f.index) >= 0) return this._maxProcessingPrio = Math.max(this._maxProcessingPrio, this.entryPriority(u)), void (this._updates.cancel = this._updates.cancel.filter(e => e !== f.index));\n      if (!r.done && this._enable(f)) return void r.madeProgress();\n      const v = this.entryPriority(u);\n      m.set(u, v), this._maxProcessingPrio = Math.max(this._maxProcessingPrio, v), this._updates.add.push(u), this.layerHasModifications && n && e(f) && 4 === f.imModificationImpact && l.push(u);\n    };\n\n    this.traverseVisible(u);\n    const c = this._updates.add;\n    c.length > 0 && this.layerHasModifications && (l.length > 0 && n(l), c.filterInPlace(e => {\n      const i = this.getNodeInternal(e),\n            s = t(i) || t(i.node) || 2 !== i.node.imModificationImpact;\n      return s || this.invalidateNodeVisibilityCache(e), s;\n    })), this._unloadedMemoryEstimate = a.missing - a.unremoved, a.knownNodes > 3 && a.missingNodes > 0 && (this._unloadedMemoryEstimate += a.known / a.knownNodes * a.missingNodes), this._unloadedMemoryEstimate = .8 * Math.max(0, this._unloadedMemoryEstimate), this._featureEstimate.estimate = this._computeFeatureEstimate(d), this._featureEstimate.leavesReached = o, this._missing.sort((e, t) => e - t), this._missing.filterInPlace((e, t) => t < 1 || this._missing.data[t - 1] !== e), this._missing.sort((e, t) => m.get(e) - m.get(t)), this._missing.length > 0 && (this._maxUnloadedPrio = m.get(this._missing.back()), this._prefetch.clear()), this._updates.add.filterInPlace(e => m.get(e) >= this._maxUnloadedPrio).sort((e, t) => m.get(e) - m.get(t)), this._updates.update.sort((e, t) => m.get(e) - m.get(t)), this._indexMissing = this._loading.size + this._missing.length, this._dirty = this._indexMissing > 0, m.clear();\n  }\n\n  checkFeatureTarget(e, t) {\n    const i = this.viewportQueries.updateScreenSpaceErrorBias(t);\n    let s = t,\n        r = t,\n        n = i,\n        o = 10;\n\n    for (; o--;) {\n      const i = new C();\n\n      this._updateFeatureEstimate(s, i);\n\n      if (this._computeFeatureEstimate(i) <= e) {\n        if (s >= t || i.missingNodes > 0 || 0 === o) break;\n        n = s, s = .5 * (s + r);\n      } else r = s, s = .5 * (s + n);\n    }\n\n    return this._version = b(this._version), this.viewportQueries.updateScreenSpaceErrorBias(i), Math.min(t, s);\n  }\n\n  _updateFeatureEstimate(t, i) {\n    this._version = b(this._version), this.viewportQueries.updateScreenSpaceErrorBias(t), this.traverseVisible((t, s) => this._updateNodeFeatureEstimate(e(s) && s.node, i));\n  }\n\n  _updateNodeFeatureEstimate(i, s) {\n    if (!(t(i) || i.failed || t(i.numFeatures))) return this._isLoaded(i.index) ? (s.known += i.numFeatures, ++s.knownNodes, void (this._isSelected(i) || (s.unremoved += i.numFeatures))) : void (this._isSelected(i) && (e(i.numFeatures) ? (s.missing += i.numFeatures, s.known += i.numFeatures, ++s.knownNodes) : ++s.missingNodes));\n  }\n\n  _computeFeatureEstimate(e) {\n    let t = e.known - e.unremoved;\n    return e.knownNodes > 3 && e.missingNodes > 0 && (t += e.known / e.knownNodes * e.missingNodes), Math.max(0, t);\n  }\n\n  load() {\n    return this._load(this._missing);\n  }\n\n  prefetch() {\n    return this._prefetch.sort((e, t) => m.get(e) - m.get(t)), this._load(this._prefetch);\n  }\n\n  _load(e) {\n    if (0 === e.length || !this._canRequest()) return !1;\n\n    for (; e.length > 0 && this._canRequest();) 0 === this.nodesPerPage ? this._loadNode(e.pop()) : this.loadPage(e.pop());\n\n    return !0;\n  }\n\n  isLoading() {\n    return this._indexMissing > 0;\n  }\n\n  getIndexLoading() {\n    return this._loading.size;\n  }\n\n  getIndexMissing() {\n    return this._indexMissing;\n  }\n\n  getUnloadedMemoryEstimate() {\n    return this._unloadedMemoryEstimate;\n  }\n\n  get updates() {\n    return this._updates;\n  }\n\n  get featureEstimate() {\n    return this._featureEstimate;\n  }\n\n  nodeTraversalState(e) {\n    if (t(e)) return null;\n\n    let i = this._nodeTraversalState.get(e.index);\n\n    if (i && y(i.version, this._version)) return i;\n    const s = this.viewportQueries.getLodLevel(e),\n          r = this.viewportQueries.hasLOD(e);\n    let n = !0;\n\n    if (r) {\n      const t = this.getParentIndex(e.index);\n\n      if (t >= 0) {\n        const e = this._nodeTraversalState.get(t);\n\n        n = e && s > e.lodLevel;\n      } else n = s > 0;\n    } else n = 0 === e.childCount;\n\n    return i ? (i.lodLevel = s, i.isChosen = n, i.version = p(!0, this._version), i) : (i = new l(r, n, s, p(!0, this._version)), this._nodeTraversalState.set(e.index, i), i);\n  }\n\n  _loadNode(e) {\n    this._loading.add(e);\n\n    const s = i(this.getNodeInternal(e)).ref;\n    if (t(s)) return void this._failedNodes.add(e);\n\n    const n = s.id,\n          o = this.urlPrefix + n,\n          a = () => {\n      this._loading.delete(e), 0 === this._missing.length && 0 === this._loading.size && this.requestUpdate();\n    };\n\n    this.streamDataController.request(o, \"json\").then(t => {\n      a();\n\n      const i = this._validateNode(n, t);\n\n      if (null == i) return;\n      i.obb && this.invalidateNodeVisibilityCache(e);\n      const s = this.addNode(i, e);\n      this.nodeTraversalState(s);\n    }, t => {\n      a(), r(t) || (this.logger.error(\"#loadNode()\", this.logLayer, \"Error loading node: \" + o), this._failedNodes.add(e));\n    });\n  }\n\n  _validateNode(e, t) {\n    if (null == t || \"object\" != typeof t || t.id !== e) return this.logger.error(\"#validateNode()\", this.logLayer, `Invalid node. Wrong type or wrong id \"${e}\"`), null;\n    if (!Array.isArray(t.mbs)) return this.logger.error(\"#validateNode()\", this.logLayer, `Invalid bounding volume on node ${e}.`), null;\n    t.sharedResource && \"./shared\" !== t.sharedResource.href && \"./shared/\" !== t.sharedResource.href && this.logger.warn(\"#validateNode()\", this.logLayer, `Invalid shared resource href on node \"${e}\"`), null == t.geometryData || Array.isArray(t.geometryData) && 1 === t.geometryData.length && \"./geometries/0\" === t.geometryData[0].href || this.logger.warn(\"#validateNode()\", this.logLayer, `Invalid geometry data on node \"${e}\"`), null == t.attributeData || Array.isArray(t.attributeData) && !t.attributeData.some((e, t) => e.href !== `./attributes/f_${t}/0`) || this.logger.warn(\"#validateNode()\", this.logLayer, `Invalid attribute data on node \"${e}\"`), t.featureData && t.featureData.length > 1 && this.logger.warn(\"#validateNode()\", this.logLayer, `Node ${e} has ${t.featureData.length} bundles. Only the first bundle will be loaded.`);\n\n    const i = t.hasOwnProperty(\"obb\") && !this.ignoreServiceObb ? t.obb : null,\n          s = t.featureData && 1 === t.featureData.length && t.featureData[0].featureRange ? t.featureData[0].featureRange[1] - t.featureData[0].featureRange[0] + 1 : null,\n          r = t => {\n      if (null == t) return null;\n\n      const i = t => this.logger.error(\"#validateNode()\", this.logLayer, `Invalid node reference on node ${e}: ${t}`);\n\n      if (\"number\" == typeof t.id) i(`id ${t.id} is a number instead of a string.`);else if (\"string\" != typeof t.id || !Array.isArray(t.mbs)) return i(\"Missing or invalid id.\"), null;\n      if (!Array.isArray(t.mbs)) return i(`Invalid bounding volume on reference ${t.id}.`), null;\n      t.href && t.href !== \"../\" + t.id && this.logger.error(\"#validateNode()\", this.logLayer, `Invalid node href on node \"${e}\"`);\n      const s = t.hasOwnProperty(\"obb\") && !this.ignoreServiceObb ? t.obb : null,\n            r = new a(`${t.id}`, t.mbs);\n      return r.serviceObb = s, r.visibilityObb = this._computeVisibilityObb(r), r;\n    },\n          n = Array.isArray(t.children) ? t.children.map(r).filter(e => null != e) : null;\n\n    return {\n      id: e,\n      mbs: t.mbs,\n      obb: i,\n      children: n,\n      resources: {\n        hasFeatureData: t.featureData && t.featureData.length > 0,\n        hasSharedResource: null != t.sharedResource,\n        attributes: t.attributeData ? e : null,\n        texture: t.textureData && t.textureData.length > 0 ? e : null,\n        geometry: null != t.geometryData ? e : null\n      },\n      version: \"string\" == typeof t.version ? t.version : null,\n      lodSelection: Array.isArray(t.lodSelection) ? t.lodSelection : null,\n      numFeatures: s\n    };\n  }\n\n  resetFailedNodes() {\n    this._failedNodes.clear(), this._failedPages.clear(), this.forAllNodes(t => {\n      e(t.node) && (t.node.failed = !1);\n    });\n  }\n\n  entryPriority(i) {\n    const s = this.getNodeInternal(i),\n          r = this.getParentIndex(i);\n    if (t(s) || r < 0 && null == s.node) return r < 0 ? 1 / 0 : this.entryPriority(r);\n    let n = 0;\n\n    if (s.node && r >= 0) {\n      const e = this._nodeTraversalState.get(r);\n\n      null != e && (n = e.lodLevel);\n    }\n\n    let o = this.progressiveLoadPenalty;\n\n    for (let e = i; e >= 0; e = this.getParentIndex(e)) if (this._isLoaded(e)) {\n      o = 0;\n      break;\n    }\n\n    const a = e(s.ref) ? this.viewportQueries.distToPOI(s.ref) : e(s.node) ? this.viewportQueries.distToPOI(s.node) : 0;\n    return -a - n * (a + this.progressiveLoadPenalty) + o;\n  }\n\n  traverseVisible(e) {\n    const i = this.getNodeInternal(this.rootIndex);\n    t(i) ? e(this.rootIndex, null, null) : this._traverseVisible(this.rootIndex, -1, i, e);\n  }\n\n  _traverseVisible(t, s, r, n) {\n    if (r.node && 0 === r.childCount) return void (this.isGeometryVisible(t) && n(t, r, s));\n    if (!this.isNodeVisible(t)) return;\n    if (n(t, r, s), null == r.node) return;\n    const o = this.nodeTraversalState(r.node);\n    if (o.nodeHasLOD && o.lodLevel === this._maxLodLevel) return;\n    const a = i(this.getPage(t));\n\n    for (let i = 0; i < r.childCount; i++) {\n      const s = a.children[r.childOffset + i],\n            o = this.getNodeInternal(s);\n      e(o) ? this._traverseVisible(s, t, o, n) : n(s, null, t);\n    }\n  }\n\n  traverse(e, t) {\n    t(e) && this.traverseChildren(e, t);\n  }\n\n  traverseChildren(t, i) {\n    const s = t.index,\n          r = this.getNodeInternal(s);\n    e(r) && this._traverseChildren(s, r, i);\n  }\n\n  _traverseChildren(i, s, r) {\n    const n = this.getPage(i);\n    if (t(n)) return;\n    const o = s.childOffset + s.childCount;\n\n    for (let t = s.childOffset; t < o; ++t) {\n      const i = n.children[t],\n            s = this.getNodeInternal(i);\n      e(s) && e(s.node) && r(s.node) && this._traverseChildren(i, s, r);\n    }\n  }\n\n  updateStats(e) {\n    if (this._updates.add.length > 0 && (e.nodes += \" + \" + this._updates.add.length), (this._indexMissing || this._prefetch.length > 0) && (e.index += \" + \" + this._indexMissing || this._prefetch.length), e.prio = this._maxProcessingPrio, this._featureEstimate.estimate) {\n      const t = this._featureEstimate.estimate - e.features;\n      t > 0 ? e.features += \" + \" + t : t < 0 && (e.features += \" - \" + -t);\n    }\n  }\n\n  getPriority() {\n    return Math.max(this._maxProcessingPrio, this._maxUnloadedPrio);\n  }\n\n  updateElevationInfo(e) {\n    this.forAllNodes(_), this.viewportQueries.updateElevationInfo(e);\n  }\n\n  forAllNodes(e) {\n    for (let t = 0; t < this._nodePages.length; t++) {\n      const i = this._nodePages[t];\n\n      if (i) {\n        const s = t * this.nodesPerPage;\n\n        for (let t = 0; t < i.nodes.length; t++) e(i.nodes[t], s + t);\n      }\n    }\n  }\n\n  get test() {\n    return {\n      addNode: (e, t) => this.addNode(e, t)\n    };\n  }\n\n}\n\nconst m = new Map();\n\nclass f {\n  constructor() {\n    this.update = new s({\n      deallocator: null\n    }), this.add = new s({\n      deallocator: null\n    }), this.remove = new s({\n      deallocator: null\n    }), this.cancel = [];\n  }\n\n  reset(e, t) {\n    this.add.clear(), this.update.clear(), this.cancel = e, this.missing = t;\n  }\n\n}\n\nfunction _(t) {\n  e(t.node) && (t.node.renderMbs[3] = -1, e(t.node.serviceObbInRenderSR) && (t.node.serviceObbInRenderSR.halfSize[0] = -1)), e(t.ref) && (t.ref.renderMbs[3] = -1, e(t.ref.serviceObbInRenderSR) && (t.ref.serviceObbInRenderSR.halfSize[0] = -1));\n}\n\nfunction v(e) {\n  return h(e, -2);\n}\n\nfunction b(e) {\n  return h(e, 2);\n}\n\nfunction p(e, t) {\n  return t + (e ? 1 : 0);\n}\n\nfunction y(e, t) {\n  return (-2 & e) === t;\n}\n\nfunction P(e) {\n  return 1 == (1 & e);\n}\n\nfunction N(e, t) {\n  return 0 === t ? 0 : e / t | 0;\n}\n\nfunction x(e, t) {\n  return 0 === t ? e : e % t;\n}\n\nconst I = [[\"maxScreenThreshold\", 1], [\"screenSpaceRelative\", 2], [\"removedFeatureDiameter\", 3], [\"distanceRangeFromDefaultCamera\", 4]];\n\nfunction w(e) {\n  if (e) for (let t = 0; t < e.length; t++) for (const i of I) if (i[0] === e[t].metricType) return {\n    lodMetric: i[1],\n    maxError: e[t].maxError\n  };\n  return {\n    lodMetric: 0,\n    maxError: 0\n  };\n}\n\nclass C {\n  constructor() {\n    this.known = 0, this.knownNodes = 0, this.missing = 0, this.missingNodes = 0, this.unremoved = 0;\n  }\n\n}\n\nfunction M(e) {\n  return Math.sqrt(e * (4 / Math.PI));\n}\n\nexport { g as I3SIndex, w as selectErrorMetric };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/layers/i3s/I3SIndex.js"],"names":["isSome","e","isNone","t","unwrap","i","s","isAbortError","r","l","n","b","o","NodeBase","a","Node","d","NodeTraversalState","addWraparound","h","clone","u","c","constructor","childOffset","childCount","visibilityCache","ref","node","useAsHole","filterImpact","g","m","streamDataController","viewportQueries","logger","holeFilling","_isLoaded","_isReloading","_isSelected","_enable","_needsUpdate","_canRequest","_computeVisibilityObb","_computeNodeFiltering","_dirty","_nodePages","nodeCount","nodesPerPage","rootIndex","lodMetric","lodConversion","urlPrefix","_loading","Set","_failedNodes","_failedPages","_indexMissing","_maxUnloadedPrio","Number","NEGATIVE_INFINITY","_maxProcessingPrio","POSITIVE_INFINITY","_nodeTraversalState","Map","_version","_visibilityCacheVersion","_maxLevel","_featureEstimate","estimate","leavesReached","_unloadedMemoryEstimate","_missing","deallocator","_prefetch","_updates","f","_imModificationUncategorized","ignoreServiceObb","progressiveLoadPenalty","layerHasModifications","_layerHasFilter","logLayer","serviceUpdateTimeStamp","lastUpdate","_maxLodLevel","maxLodLevel","init","type","pageSize","M","addPage","N","rootPage","push","nodes","children","parents","makeRefNode","rootNode","id","_validateNode","addNode","loadPage","add","request","then","delete","catch","error","length","map","index","obb","center","halfSize","mesh","attribute","_","geometry","material","p","hasSharedResource","hasFeatureData","attributes","resource","texture","geometryDefinition","definition","materialDefinition","y","lodThreshold","featureCount","serviceObb","visibilityObb","vertexCount","v","updateParentsAndLevel","Array","getPage","x","level","pop","getNode","getChildIndex","Math","max","getNodeInternal","populateChildren","getParent","maxError","w","lodSelection","mbs","resources","version","numFeatures","renderMbs","serviceObbInRenderSR","getIndexById","forAllNodes","getNodeById","getParentIndex","isLeaf","size","invalidateVisibilityCache","invalidateNodeVisibilityCache","invalidateNodeVisibilityCacheInternal","invalidateBoundingVolumeCache","invalidateGeometryVisibility","geometryObb","invalidateVisibilityObbs","traverse","isNodeVisible","imModificationImpact","P","isGeometryVisible","_traverseCoverage","delta","coverage","useNodeAsHole","maxLevel","dirty","destroy","prune","update","requestUpdate","imModificationsChanged","hasModifications","layerFilterChanged","clear","reset","C","entryPriority","set","get","has","_updateNodeFeatureEstimate","failed","known","memory","knownNodes","unremoved","remove","missing","missingNodes","indexOf","cancel","filter","done","madeProgress","traverseVisible","filterInPlace","_computeFeatureEstimate","sort","data","back","checkFeatureTarget","updateScreenSpaceErrorBias","_updateFeatureEstimate","min","load","_load","prefetch","_loadNode","isLoading","getIndexLoading","getIndexMissing","getUnloadedMemoryEstimate","updates","featureEstimate","nodeTraversalState","getLodLevel","hasLOD","lodLevel","isChosen","isArray","sharedResource","href","warn","geometryData","attributeData","some","featureData","hasOwnProperty","featureRange","textureData","resetFailedNodes","distToPOI","_traverseVisible","nodeHasLOD","traverseChildren","_traverseChildren","updateStats","prio","features","getPriority","updateElevationInfo","test","I","metricType","sqrt","PI","I3SIndex","selectErrorMetric"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isSome as e,isNone as t,unwrap as i}from\"../../../../core/maybe.js\";import s from\"../../../../core/PooledArray.js\";import{isAbortError as r}from\"../../../../core/promiseUtils.js\";import{l as n}from\"../../../../chunks/vec3.js\";import{b as o}from\"../../../../chunks/vec4f64.js\";import{NodeBase as a,Node as d,NodeTraversalState as l}from\"./I3SNode.js\";import{addWraparound as h}from\"./I3SUtil.js\";import{clone as u}from\"../../support/orientedBoundingBox.js\";class c{constructor(e,t,i,s,r){this.childOffset=e,this.childCount=t,this.visibilityCache=i,this.ref=s,this.node=r,this.useAsHole=0,this.filterImpact=2}}class g{constructor(e,t,i,r,n,o,a,d,l,h,u,c,g,m){this.streamDataController=i,this.viewportQueries=r,this.logger=n,this.holeFilling=o,this._isLoaded=a,this._isReloading=d,this._isSelected=l,this._enable=h,this._needsUpdate=u,this._canRequest=c,this._computeVisibilityObb=g,this._computeNodeFiltering=m,this._dirty=!0,this._nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=0,this.lodConversion=e=>e,this.urlPrefix=\"\",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=b(0),this._visibilityCacheVersion=b(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new s({deallocator:null}),this._prefetch=new s({deallocator:null}),this._updates=new f,this._imModificationUncategorized=new s({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this.layerHasModifications=!1,this._layerHasFilter=!1,this.logLayer=e,e.serviceUpdateTimeStamp&&e.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate=`${e.serviceUpdateTimeStamp.lastUpdate}`),this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this.init(t)}init(e){if(\"page\"===e.type){switch(this.urlPrefix=e.urlPrefix,this.nodesPerPage=e.pageSize,this.rootIndex=e.rootIndex,e.lodMetric){case\"maxScreenThreshold\":this.lodMetric=1;break;case\"maxScreenThresholdSQ\":this.lodMetric=1,this.lodConversion=M}this.addPage(N(this.rootIndex,this.nodesPerPage),e.rootPage)}else if(\"node\"===e.type){this.urlPrefix=e.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this.makeRefNode(new a(e.rootNode.id,null),-1);const t=this._validateNode(e.rootNode.id,e.rootNode);t&&this.addNode(t,0)}}loadPage(e){this._loading.add(e);const t=this.urlPrefix+e;this.streamDataController.request(t,\"json\").then((t=>{this._loading.delete(e),this.addPage(e,t)})).catch((t=>{this._loading.delete(e),r(t)||(this._failedPages.add(e),this.logger.error(\"#loadPage()\",this.logLayer,`Error when loading page ${e}`,t))}))}addPage(e,t){for(let n=this._nodePages.length;n<e;n++)this._nodePages[n]=null;const i=[],s=[],r=t.nodes.map(((t,r)=>{const a=i.length,l=t.children?t.children.length:0;s.push(-1);for(let e=0;e<l;e++)i.push(t.children[e]);const h=`${t.index}`,g=u(t.obb),m=o([g.center[0],g.center[1],g.center[2],n(g.halfSize)]),f=t.mesh&&t.mesh.attribute,_=t.mesh&&t.mesh.geometry,b=t.mesh&&t.mesh.material,p={hasSharedResource:!1,hasFeatureData:!!_,attributes:f&&null!=f.resource?`${f.resource}`:null,geometry:_&&null!=_.resource?`${_.resource}`:null,texture:b&&null!=b.resource?`${b.resource}`:null,geometryDefinition:_?_.definition:-1,materialDefinition:b?b.definition:-1},y=new d(h,e*this.nodesPerPage+r,m,l,0,p,this.lastUpdate,this.lodMetric,this.lodConversion(t.lodThreshold),_?_.featureCount:null);return y.serviceObb=g,y.visibilityObb=this._computeVisibilityObb(y),y.vertexCount=_?_.vertexCount:0,new c(a,l,v(this._visibilityCacheVersion),null,y)}));this._nodePages[e]={nodes:r,children:i,parents:s},this.nodeCount+=r.length,this.updateParentsAndLevel()}updateParentsAndLevel(){const t=new Array,i=(i,s,r)=>{const n=this.getPage(i);if(e(n)){const o=x(i,this.nodesPerPage);n.parents[o]=s;const a=n.nodes[o].node;e(a)&&(a.level=r,t.push(i))}};for(i(this.rootIndex,-1,0);t.length;){const s=t.pop(),r=this.getNode(s);if(e(r))for(let e=0;e<r.childCount;e++){i(this.getChildIndex(r,e),s,r.level+1),this._maxLevel=Math.max(this._maxLevel,r.level+1)}}}getPage(e){return this._nodePages[N(e,this.nodesPerPage)]}getNodeInternal(e){const i=this.getPage(e);return t(i)?null:i.nodes[x(e,this.nodesPerPage)]}addNode(t,s){null!=t.children&&this.populateChildren(s,t.children);const r=this.getParent(s),n=e(r)?r.level+1:0;this._maxLevel=Math.max(this._maxLevel,t.children?n+1:n);const{lodMetric:a,maxError:l}=w(t.lodSelection),h=i(this.getNodeInternal(s));return h.node=new d(t.id,s,o(t.mbs),h.childCount,n,t.resources,t.version,a,l,t.numFeatures),t.obb&&(h.node.serviceObb=u(t.obb)),h.node.visibilityObb=this._computeVisibilityObb(h.node),e(h.ref)&&(null==h.ref.mbs&&(h.ref.mbs=t.mbs),h.node.renderMbs=h.ref.renderMbs,h.node.serviceObbInRenderSR=h.ref.serviceObbInRenderSR,h.ref.visibilityObb=h.node.visibilityObb),h.node}makeRefNode(t,i){const s=this._nodePages[0],r=s.nodes.length;return s.nodes.push(new c(0,0,v(this._visibilityCacheVersion),t,null)),this.nodeCount++,s.parents.push(i),t.renderMbs[3]=-1,e(t.serviceObbInRenderSR)&&(t.serviceObbInRenderSR.halfSize[0]=-1),r}populateChildren(e,t){const s=i(this.getNodeInternal(e)),r=i(this.getPage(e));s.childOffset=r.children.length,s.childCount=t.length;for(let i=0;i<t.length;i++){const s=this.makeRefNode(t[i],e);r.children.push(s)}}getNode(t){const i=this.getNodeInternal(t);return e(i)?i.node:null}getIndexById(t){let i;return this.forAllNodes(((s,r)=>{(e(s.node)&&s.node.id===t||e(s.ref)&&s.ref.id===t)&&(i=r)})),i}getNodeById(e){const t=this.getIndexById(e);return t>=0?this.getNode(t):null}getChildIndex(e,i){const s=this.getPage(e.index);if(t(s))return-1;const r=s.nodes[x(e.index,this.nodesPerPage)];return s.children[r.childOffset+i]}getParentIndex(t){const i=this.getPage(t);return e(i)?i.parents[x(t,this.nodesPerPage)]:-1}getParent(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null}isLeaf(t){const i=this.getNodeInternal(t);return e(i)&&0===i.childCount}get rootNode(){return this.getNode(this.rootIndex)}get size(){return this.nodeCount}invalidateVisibilityCache(){this._visibilityCacheVersion=b(this._visibilityCacheVersion)}invalidateNodeVisibilityCache(t){const i=this.getNodeInternal(t);e(i)&&this.invalidateNodeVisibilityCacheInternal(i)}invalidateNodeVisibilityCacheInternal(e){e.visibilityCache=v(this._visibilityCacheVersion)}invalidateBoundingVolumeCache(t){const i=this.getNodeInternal(t);e(i)&&(_(i),this.invalidateNodeVisibilityCacheInternal(i))}invalidateGeometryVisibility(t){const i=this.getNodeInternal(t);e(i)&&e(i.node)&&(i.node.geometryObb=null,i.node.renderMbs[3]=-1,e(i.node.serviceObbInRenderSR)&&(i.node.serviceObbInRenderSR.halfSize[0]=-1))}invalidateVisibilityObbs(){t(this.rootNode)||this.traverse(this.rootNode,(e=>(e.visibilityObb=this._computeVisibilityObb(e),e.geometryObb=null,!0)))}isNodeVisible(i){const s=this.getNodeInternal(i);if(t(s)||e(s.ref)&&!s.ref.mbs)return!0;if(!y(s.visibilityCache,this._visibilityCacheVersion)){const i=s.node,r=e(i)&&(t(s.ref)||e(i.visibilityObb))?i:e(s.ref)?s.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&(e(i)||e(s.ref))&&2===s.filterImpact){const t=e(i)?i.mbs:e(s.ref)?s.ref.mbs:null;s.filterImpact=null!=t?this._computeNodeFiltering(t):0}const n=e(i)&&1===s.filterImpact,o=!(e(i)&&2===i.imModificationImpact)&&(!r||this.viewportQueries.isNodeVisible(r))&&!n;return s.visibilityCache=p(o,this._visibilityCacheVersion),o}return P(s.visibilityCache)}isGeometryVisible(t){if(!this.isNodeVisible(t))return!1;const i=this.getNodeInternal(t);return!(e(i)&&e(i.node)&&e(i.node.geometryObb)&&(!this.layerHasModifications||4!==i.node.imModificationImpact))||this.viewportQueries.isGeometryVisible(i.node)}_traverseCoverage(s,r,n,o,a){const d=this.getPage(s);if(t(d)||0===r.childCount)return;const l=r.childOffset+r.childCount,h=new Array;for(let t=r.childOffset;t<l;++t){const i=d.children[t],s=this.getNodeInternal(i);e(s)&&e(s.node)&&this.isGeometryVisible(i)&&h.push(s)}o/=h.length;for(const e of h){const t=i(e.node).index;this._isLoaded(t)||this._isReloading(t)?(a.delta=Math.max(a.delta,n),a.coverage+=o):this._traverseCoverage(t,e,n+1,o,a)}}useNodeAsHole(e){if(\"off\"===this.holeFilling)return!1;const i=this.getNodeInternal(e);if(t(i))return!1;if(\"always\"===this.holeFilling)return!0;if(y(i.useAsHole,this._version))return P(i.useAsHole);const s={delta:0,coverage:0};this._traverseCoverage(e,i,0,1,s);const r=s.delta*s.coverage<=.5;return i.useAsHole=p(r,this._version),r}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.add.prune(),this._updates.update.prune()}requestUpdate(){this._dirty=!0,this._indexMissing=1,this._version=b(this._version)}imModificationsChanged(t){this.layerHasModifications=t,this.forAllNodes((({node:t})=>{e(t)&&(t.imModificationImpact=4,t.visibilityObb=this._computeVisibilityObb(t),t.hasModifications&&this.invalidateGeometryVisibility(t.index))})),this.invalidateVisibilityCache()}layerFilterChanged(t){this._layerHasFilter=t,this.forAllNodes((t=>{if(e(t)){t.filterImpact=2;const i=t.node;e(i)&&this.invalidateNodeVisibilityCache(i.index)}})),this.invalidateVisibilityCache()}update(s,r,n){if(!this._dirty)return;this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(s,this._missing),m.clear();let o=!0;const a=new C,d=new C,l=this._imModificationUncategorized;l.clear();const h=new Set,u=(u,c,g)=>{if(t(c)){let e=this.entryPriority(u);e===1/0&&(e=this.entryPriority(g));const t=N(u,this.nodesPerPage);return m.set(t,Math.max(e,m.get(t)||0)),this._loading.has(t)||this._failedPages.has(t)||this._missing.push(t),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const f=c.node;if(this._updateNodeFeatureEstimate(f,d),t(f)){const e=this.entryPriority(u);return this._loading.has(u)||this._failedNodes.has(u)||(this._missing.push(u),m.set(u,e)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const _=i(this.getPage(u));if(0===this._missing.length&&0===this.nodesPerPage)for(let t=0;t<c.childCount;t++){const i=_.children[c.childOffset+t],s=this.getNodeInternal(i);!e(s)||s.node||this._loading.has(i)||this._failedNodes.has(i)||(m.set(i,this.entryPriority(i)),this._prefetch.push(i))}if(f.failed||!f.resources.hasFeatureData)return;if(h.add(f.id),this._isLoaded(u)){if(a.known+=f.memory,++a.knownNodes,this._isSelected(f)?c.childCount>0&&(o=!1):(a.unremoved+=f.memory,o=!1),this._needsUpdate(f)){const e=this.entryPriority(u);m.set(u,e),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e),this._updates.update.push(u)}return}if(f.memory&&(a.known+=f.memory,++a.knownNodes),!this._isSelected(f))return void(this._isReloading(u)&&this._updates.remove.push(u));if(c.childCount>0&&(o=!1),f.memory?(a.missing+=f.memory,a.known+=f.memory,++a.knownNodes):++a.missingNodes,s.indexOf(f.index)>=0)return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this.entryPriority(u)),void(this._updates.cancel=this._updates.cancel.filter((e=>e!==f.index)));if(!r.done&&this._enable(f))return void r.madeProgress();const v=this.entryPriority(u);m.set(u,v),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,v),this._updates.add.push(u),this.layerHasModifications&&n&&e(f)&&4===f.imModificationImpact&&l.push(u)};this.traverseVisible(u);const c=this._updates.add;c.length>0&&this.layerHasModifications&&(l.length>0&&n(l),c.filterInPlace((e=>{const i=this.getNodeInternal(e),s=t(i)||t(i.node)||2!==i.node.imModificationImpact;return s||this.invalidateNodeVisibilityCache(e),s}))),this._unloadedMemoryEstimate=a.missing-a.unremoved,a.knownNodes>3&&a.missingNodes>0&&(this._unloadedMemoryEstimate+=a.known/a.knownNodes*a.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(d),this._featureEstimate.leavesReached=o,this._missing.sort(((e,t)=>e-t)),this._missing.filterInPlace(((e,t)=>t<1||this._missing.data[t-1]!==e)),this._missing.sort(((e,t)=>m.get(e)-m.get(t))),this._missing.length>0&&(this._maxUnloadedPrio=m.get(this._missing.back()),this._prefetch.clear()),this._updates.add.filterInPlace((e=>m.get(e)>=this._maxUnloadedPrio)).sort(((e,t)=>m.get(e)-m.get(t))),this._updates.update.sort(((e,t)=>m.get(e)-m.get(t))),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,m.clear()}checkFeatureTarget(e,t){const i=this.viewportQueries.updateScreenSpaceErrorBias(t);let s=t,r=t,n=i,o=10;for(;o--;){const i=new C;this._updateFeatureEstimate(s,i);if(this._computeFeatureEstimate(i)<=e){if(s>=t||i.missingNodes>0||0===o)break;n=s,s=.5*(s+r)}else r=s,s=.5*(s+n)}return this._version=b(this._version),this.viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,s)}_updateFeatureEstimate(t,i){this._version=b(this._version),this.viewportQueries.updateScreenSpaceErrorBias(t),this.traverseVisible(((t,s)=>this._updateNodeFeatureEstimate(e(s)&&s.node,i)))}_updateNodeFeatureEstimate(i,s){if(!(t(i)||i.failed||t(i.numFeatures)))return this._isLoaded(i.index)?(s.known+=i.numFeatures,++s.knownNodes,void(this._isSelected(i)||(s.unremoved+=i.numFeatures))):void(this._isSelected(i)&&(e(i.numFeatures)?(s.missing+=i.numFeatures,s.known+=i.numFeatures,++s.knownNodes):++s.missingNodes))}_computeFeatureEstimate(e){let t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}load(){return this._load(this._missing)}prefetch(){return this._prefetch.sort(((e,t)=>m.get(e)-m.get(t))),this._load(this._prefetch)}_load(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this.nodesPerPage?this._loadNode(e.pop()):this.loadPage(e.pop());return!0}isLoading(){return this._indexMissing>0}getIndexLoading(){return this._loading.size}getIndexMissing(){return this._indexMissing}getUnloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}nodeTraversalState(e){if(t(e))return null;let i=this._nodeTraversalState.get(e.index);if(i&&y(i.version,this._version))return i;const s=this.viewportQueries.getLodLevel(e),r=this.viewportQueries.hasLOD(e);let n=!0;if(r){const t=this.getParentIndex(e.index);if(t>=0){const e=this._nodeTraversalState.get(t);n=e&&s>e.lodLevel}else n=s>0}else n=0===e.childCount;return i?(i.lodLevel=s,i.isChosen=n,i.version=p(!0,this._version),i):(i=new l(r,n,s,p(!0,this._version)),this._nodeTraversalState.set(e.index,i),i)}_loadNode(e){this._loading.add(e);const s=i(this.getNodeInternal(e)).ref;if(t(s))return void this._failedNodes.add(e);const n=s.id,o=this.urlPrefix+n,a=()=>{this._loading.delete(e),0===this._missing.length&&0===this._loading.size&&this.requestUpdate()};this.streamDataController.request(o,\"json\").then((t=>{a();const i=this._validateNode(n,t);if(null==i)return;i.obb&&this.invalidateNodeVisibilityCache(e);const s=this.addNode(i,e);this.nodeTraversalState(s)}),(t=>{a(),r(t)||(this.logger.error(\"#loadNode()\",this.logLayer,\"Error loading node: \"+o),this._failedNodes.add(e))}))}_validateNode(e,t){if(null==t||\"object\"!=typeof t||t.id!==e)return this.logger.error(\"#validateNode()\",this.logLayer,`Invalid node. Wrong type or wrong id \"${e}\"`),null;if(!Array.isArray(t.mbs))return this.logger.error(\"#validateNode()\",this.logLayer,`Invalid bounding volume on node ${e}.`),null;t.sharedResource&&\"./shared\"!==t.sharedResource.href&&\"./shared/\"!==t.sharedResource.href&&this.logger.warn(\"#validateNode()\",this.logLayer,`Invalid shared resource href on node \"${e}\"`),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&\"./geometries/0\"===t.geometryData[0].href||this.logger.warn(\"#validateNode()\",this.logLayer,`Invalid geometry data on node \"${e}\"`),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some(((e,t)=>e.href!==`./attributes/f_${t}/0`))||this.logger.warn(\"#validateNode()\",this.logLayer,`Invalid attribute data on node \"${e}\"`),t.featureData&&t.featureData.length>1&&this.logger.warn(\"#validateNode()\",this.logLayer,`Node ${e} has ${t.featureData.length} bundles. Only the first bundle will be loaded.`);const i=t.hasOwnProperty(\"obb\")&&!this.ignoreServiceObb?t.obb:null,s=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,r=t=>{if(null==t)return null;const i=t=>this.logger.error(\"#validateNode()\",this.logLayer,`Invalid node reference on node ${e}: ${t}`);if(\"number\"==typeof t.id)i(`id ${t.id} is a number instead of a string.`);else if(\"string\"!=typeof t.id||!Array.isArray(t.mbs))return i(\"Missing or invalid id.\"),null;if(!Array.isArray(t.mbs))return i(`Invalid bounding volume on reference ${t.id}.`),null;t.href&&t.href!==\"../\"+t.id&&this.logger.error(\"#validateNode()\",this.logLayer,`Invalid node href on node \"${e}\"`);const s=t.hasOwnProperty(\"obb\")&&!this.ignoreServiceObb?t.obb:null,r=new a(`${t.id}`,t.mbs);return r.serviceObb=s,r.visibilityObb=this._computeVisibilityObb(r),r},n=Array.isArray(t.children)?t.children.map(r).filter((e=>null!=e)):null;return{id:e,mbs:t.mbs,obb:i,children:n,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:\"string\"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:s}}resetFailedNodes(){this._failedNodes.clear(),this._failedPages.clear(),this.forAllNodes((t=>{e(t.node)&&(t.node.failed=!1)}))}entryPriority(i){const s=this.getNodeInternal(i),r=this.getParentIndex(i);if(t(s)||r<0&&null==s.node)return r<0?1/0:this.entryPriority(r);let n=0;if(s.node&&r>=0){const e=this._nodeTraversalState.get(r);null!=e&&(n=e.lodLevel)}let o=this.progressiveLoadPenalty;for(let e=i;e>=0;e=this.getParentIndex(e))if(this._isLoaded(e)){o=0;break}const a=e(s.ref)?this.viewportQueries.distToPOI(s.ref):e(s.node)?this.viewportQueries.distToPOI(s.node):0;return-a-n*(a+this.progressiveLoadPenalty)+o}traverseVisible(e){const i=this.getNodeInternal(this.rootIndex);t(i)?e(this.rootIndex,null,null):this._traverseVisible(this.rootIndex,-1,i,e)}_traverseVisible(t,s,r,n){if(r.node&&0===r.childCount)return void(this.isGeometryVisible(t)&&n(t,r,s));if(!this.isNodeVisible(t))return;if(n(t,r,s),null==r.node)return;const o=this.nodeTraversalState(r.node);if(o.nodeHasLOD&&o.lodLevel===this._maxLodLevel)return;const a=i(this.getPage(t));for(let i=0;i<r.childCount;i++){const s=a.children[r.childOffset+i],o=this.getNodeInternal(s);e(o)?this._traverseVisible(s,t,o,n):n(s,null,t)}}traverse(e,t){t(e)&&this.traverseChildren(e,t)}traverseChildren(t,i){const s=t.index,r=this.getNodeInternal(s);e(r)&&this._traverseChildren(s,r,i)}_traverseChildren(i,s,r){const n=this.getPage(i);if(t(n))return;const o=s.childOffset+s.childCount;for(let t=s.childOffset;t<o;++t){const i=n.children[t],s=this.getNodeInternal(i);e(s)&&e(s.node)&&r(s.node)&&this._traverseChildren(i,s,r)}}updateStats(e){if(this._updates.add.length>0&&(e.nodes+=\" + \"+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=\" + \"+this._indexMissing||this._prefetch.length),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){const t=this._featureEstimate.estimate-e.features;t>0?e.features+=\" + \"+t:t<0&&(e.features+=\" - \"+-t)}}getPriority(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}updateElevationInfo(e){this.forAllNodes(_),this.viewportQueries.updateElevationInfo(e)}forAllNodes(e){for(let t=0;t<this._nodePages.length;t++){const i=this._nodePages[t];if(i){const s=t*this.nodesPerPage;for(let t=0;t<i.nodes.length;t++)e(i.nodes[t],s+t)}}}get test(){return{addNode:(e,t)=>this.addNode(e,t)}}}const m=new Map;class f{constructor(){this.update=new s({deallocator:null}),this.add=new s({deallocator:null}),this.remove=new s({deallocator:null}),this.cancel=[]}reset(e,t){this.add.clear(),this.update.clear(),this.cancel=e,this.missing=t}}function _(t){e(t.node)&&(t.node.renderMbs[3]=-1,e(t.node.serviceObbInRenderSR)&&(t.node.serviceObbInRenderSR.halfSize[0]=-1)),e(t.ref)&&(t.ref.renderMbs[3]=-1,e(t.ref.serviceObbInRenderSR)&&(t.ref.serviceObbInRenderSR.halfSize[0]=-1))}function v(e){return h(e,-2)}function b(e){return h(e,2)}function p(e,t){return t+(e?1:0)}function y(e,t){return(-2&e)===t}function P(e){return 1==(1&e)}function N(e,t){return 0===t?0:e/t|0}function x(e,t){return 0===t?e:e%t}const I=[[\"maxScreenThreshold\",1],[\"screenSpaceRelative\",2],[\"removedFeatureDiameter\",3],[\"distanceRangeFromDefaultCamera\",4]];function w(e){if(e)for(let t=0;t<e.length;t++)for(const i of I)if(i[0]===e[t].metricType)return{lodMetric:i[1],maxError:e[t].maxError};return{lodMetric:0,maxError:0}}class C{constructor(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}function M(e){return Math.sqrt(e*(4/Math.PI))}export{g as I3SIndex,w as selectErrorMetric};\n"]},"metadata":{},"sourceType":"module"}