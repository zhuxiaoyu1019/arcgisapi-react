{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../chunks/tslib.es6.js\";\nimport t from \"../../../../core/Accessor.js\";\nimport i from \"../../../../core/Collection.js\";\nimport s from \"../../../../core/Handles.js\";\nimport r from \"../../../../core/Logger.js\";\nimport { removeMaybe as n, destroyMaybe as o, isSome as l } from \"../../../../core/maybe.js\";\nimport h from \"../../../../core/PooledArray.js\";\nimport { init as a } from \"../../../../core/watchUtils.js\";\nimport { property as c } from \"../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../core/has.js\";\nimport \"../../../../core/accessorSupport/ensureType.js\";\nimport { subclass as d } from \"../../../../core/accessorSupport/decorators/subclass.js\";\nimport { create as p, empty as u, expand as m, height as _, intersects as f } from \"../../../../geometry/support/aaBoundingRect.js\";\nimport { FeatureTileDescriptor3D as g } from \"./FeatureTileDescriptor3D.js\";\nimport { FeatureTileMeasurements3D as T } from \"./FeatureTileMeasurements3D.js\";\nimport { toBoundingRect as y } from \"../../support/extentUtils.js\";\nimport { TaskPriority as S, noBudget as v } from \"../../../support/Scheduler.js\";\nconst E = r.getLogger(\"esri.views.3d.layers.support.FeatureTileTree3D\");\nlet w = class extends t {\n  constructor(e) {\n    super(e), this.tiles = new i(), this.tileSize = 512, this._idToTile = new Map(), this._handles = new s(), this._clients = new Set(), this._dirty = !1, this._newTiles = new h();\n  }\n\n  get tilingScheme() {\n    const e = this.tilingSchemeOwner.tilingScheme;\n    if (!e) return null;\n    return e.clone();\n  }\n\n  set filterExtent(e) {\n    if (e && !e.spatialReference.equals(this.viewState.spatialReference)) return void E.error(\"#extent\", \"extent spatial reference needs to be in the same spatial reference as the view\");\n\n    const t = this._get(\"filterExtent\");\n\n    if (t === e || t && e && t.equals(e)) return;\n    const i = e ? e.clone() : null;\n    this._set(\"filterExtent\", i), this._setDirty();\n  }\n\n  get filterExtentRect() {\n    if (!this.filterExtent || !this.tilingScheme) return null;\n    const e = p();\n    return y(this.filterExtent, e, this.tilingScheme.spatialReference), e;\n  }\n\n  get rootTileIds() {\n    return this.filterExtentRect ? this.tilingScheme.rootTilesInExtent(this.filterExtentRect) : [[0, 0, 0]];\n  }\n\n  set suspended(e) {\n    e !== this._get(\"suspended\") && (this._set(\"suspended\", e), this._setDirty());\n  }\n\n  get updating() {\n    return this._dirty || !!this._pendingTiles;\n  }\n\n  initialize() {\n    this._handles.add(this.watch([\"tilingScheme\", \"tileSize\"], () => this._reset(), !0)), this._handles.add(a(this, [\"tileSize\", \"cameraOnSurface.location\", \"tilingScheme\", \"viewState.contentCamera\", \"focus.location\"], () => this._setDirty(), !0)), this.scheduler && (this._frameWorker = this.scheduler.registerTask(S.FEATURE_TILE_TREE, this));\n  }\n\n  destroy() {\n    this._frameWorker = n(this._frameWorker), this._handles = o(this._handles);\n  }\n\n  addClient() {\n    const e = R();\n    return this._clients.add(e), 1 === this._clients.size && this._setDirty(), {\n      remove: () => this._removeClient(e)\n    };\n  }\n\n  _removeClient(e) {\n    this._clients.delete(e), this._hasClients || this._clear();\n  }\n\n  get _hasClients() {\n    return this._clients.size > 0;\n  }\n\n  _setDirty() {\n    !this._hasClients || this.suspended || this._dirty || (this._frameWorker ? (this._dirty = !0, this.notifyChange(\"updating\")) : this.runTask(v));\n  }\n\n  _clear() {\n    this.tiles.removeAll(), this._idToTile.clear(), this._reset(), this._dirty = !1, this.notifyChange(\"updating\");\n  }\n\n  get running() {\n    return this.updating;\n  }\n\n  runTask(e) {\n    this._dirty = !1, this._pendingTiles || (this._startUpdate(), l(this._frameWorker) && (this._frameWorker.priority = S.FEATURE_TILE_TREE_ACTIVE)), this._subdivideTilesForView(e), !this._pendingTiles && l(this._frameWorker) && (this._frameWorker.priority = S.FEATURE_TILE_TREE), this.notifyChange(\"updating\");\n  }\n\n  _startUpdate() {\n    if (this.suspended) return;\n    if (!this.tilingScheme) return void this._clear();\n    this._tileMeasurements || (this._tileMeasurements = new T({\n      renderCoordsHelper: this.renderCoordsHelper,\n      tilingScheme: this.tilingScheme,\n      tileSize: this.tileSize\n    }));\n    const e = this.viewState.contentCamera;\n    this._tileMeasurements.begin(e, this.focus.location, this.cameraOnSurface.location.z), this._pendingTiles = this._getRootTiles();\n  }\n\n  _reset() {\n    this._newTiles.clear(), this._tileMeasurements = null, this._pendingTiles = null, this._setDirty();\n  }\n\n  _getRootTiles() {\n    return this.rootTileIds.map(e => new g(e[0], e[1], e[2], this.tilingScheme));\n  }\n\n  _purgeHorizonTiles(e) {\n    e.sort((e, t) => {\n      const i = e.measures.screenRect,\n            s = t.measures.screenRect;\n      return i[1] + i[3] - (s[1] + s[3]);\n    }), u(C);\n\n    for (let t = 0; t < e.length; t++) if (m(C, e.data[t].measures.screenRect), _(C) > j) return e.data.slice(t, e.length);\n\n    return [];\n  }\n\n  _subdivideTilesForView(e) {\n    if (this._pendingTiles) {\n      for (; this._pendingTiles.length > 0 && !e.done;) {\n        const t = this._pendingTiles.pop();\n\n        e.madeProgress(), this.filterExtentRect && !f(this.filterExtentRect, t.extent) || (this._tileMeasurements.updateTile(t), 0 !== t.measures.visibility && (t.measures.shouldSplit ? (this.tilingScheme.ensureMaxLod(t.lij[0] + 1), this._pendingTiles.push(...t.getChildren())) : this._newTiles.push(t)));\n      }\n\n      0 === this._pendingTiles.length && (this._updateTiles(this._purgeHorizonTiles(this._newTiles)), this._newTiles.clear(), this._tileMeasurements.end(), this._pendingTiles = null);\n    }\n  }\n\n  _updateTiles(e) {\n    for (const s of this.tiles.items) s.used = !1;\n\n    const t = e.filter(e => {\n      const t = this._idToTile.get(e.id);\n\n      return t ? (t.copyMeasurementsFrom(e), t.used = !0) : this._idToTile.set(e.id, e), !t;\n    }),\n          i = this.tiles.items.filter(e => !e.used && (this._idToTile.delete(e.id), !0));\n    this.tiles.removeMany(i), this.tiles.addMany(t), this.sortTiles();\n  }\n\n  sortTiles() {\n    this.viewState.fixedContentCamera || this.tiles.sort((e, t) => e.measures.visibility !== t.measures.visibility ? 2 === e.measures.visibility ? -1 : 1 : e.measures.distance - t.measures.distance), this.tiles.forEach((e, t) => e.loadPriority = t);\n  }\n\n};\ne([c({\n  constructOnly: !0\n})], w.prototype, \"scheduler\", void 0), e([c({\n  constructOnly: !0\n})], w.prototype, \"renderCoordsHelper\", void 0), e([c({\n  constructOnly: !0\n})], w.prototype, \"tilingSchemeOwner\", void 0), e([c({\n  constructOnly: !0\n})], w.prototype, \"cameraOnSurface\", void 0), e([c({\n  constructOnly: !0\n})], w.prototype, \"focus\", void 0), e([c({\n  constructOnly: !0\n})], w.prototype, \"viewState\", void 0), e([c({\n  constructOnly: !0\n})], w.prototype, \"terrain\", void 0), e([c()], w.prototype, \"tiles\", void 0), e([c()], w.prototype, \"tileSize\", void 0), e([c({\n  readOnly: !0\n})], w.prototype, \"tilingScheme\", null), e([c()], w.prototype, \"filterExtent\", null), e([c({\n  readOnly: !0\n})], w.prototype, \"filterExtentRect\", null), e([c({\n  readOnly: !0\n})], w.prototype, \"rootTileIds\", null), e([c({\n  value: !1\n})], w.prototype, \"suspended\", null), e([c({\n  readOnly: !0\n})], w.prototype, \"updating\", null), w = e([d(\"esri.views.3d.layers.support.FeatureTileTree3D\")], w);\nlet x = 0;\n\nfunction R() {\n  return x++;\n}\n\nconst C = p(),\n      j = 10;\nvar O = w;\nexport default O;\nexport { w as FeatureTileTree3D };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/layers/support/FeatureTileTree3D.js"],"names":["_","e","t","i","s","r","removeMaybe","n","destroyMaybe","o","isSome","l","h","init","a","property","c","subclass","d","create","p","empty","u","expand","m","height","intersects","f","FeatureTileDescriptor3D","g","FeatureTileMeasurements3D","T","toBoundingRect","y","TaskPriority","S","noBudget","v","E","getLogger","w","constructor","tiles","tileSize","_idToTile","Map","_handles","_clients","Set","_dirty","_newTiles","tilingScheme","tilingSchemeOwner","clone","filterExtent","spatialReference","equals","viewState","error","_get","_set","_setDirty","filterExtentRect","rootTileIds","rootTilesInExtent","suspended","updating","_pendingTiles","initialize","add","watch","_reset","scheduler","_frameWorker","registerTask","FEATURE_TILE_TREE","destroy","addClient","R","size","remove","_removeClient","delete","_hasClients","_clear","notifyChange","runTask","removeAll","clear","running","_startUpdate","priority","FEATURE_TILE_TREE_ACTIVE","_subdivideTilesForView","_tileMeasurements","renderCoordsHelper","contentCamera","begin","focus","location","cameraOnSurface","z","_getRootTiles","map","_purgeHorizonTiles","sort","measures","screenRect","C","length","data","j","slice","done","pop","madeProgress","extent","updateTile","visibility","shouldSplit","ensureMaxLod","lij","push","getChildren","_updateTiles","end","items","used","filter","get","id","copyMeasurementsFrom","set","removeMany","addMany","sortTiles","fixedContentCamera","distance","forEach","loadPriority","constructOnly","prototype","readOnly","value","x","O","FeatureTileTree3D"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../chunks/tslib.es6.js\";import t from\"../../../../core/Accessor.js\";import i from\"../../../../core/Collection.js\";import s from\"../../../../core/Handles.js\";import r from\"../../../../core/Logger.js\";import{removeMaybe as n,destroyMaybe as o,isSome as l}from\"../../../../core/maybe.js\";import h from\"../../../../core/PooledArray.js\";import{init as a}from\"../../../../core/watchUtils.js\";import{property as c}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/ensureType.js\";import{subclass as d}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{create as p,empty as u,expand as m,height as _,intersects as f}from\"../../../../geometry/support/aaBoundingRect.js\";import{FeatureTileDescriptor3D as g}from\"./FeatureTileDescriptor3D.js\";import{FeatureTileMeasurements3D as T}from\"./FeatureTileMeasurements3D.js\";import{toBoundingRect as y}from\"../../support/extentUtils.js\";import{TaskPriority as S,noBudget as v}from\"../../../support/Scheduler.js\";const E=r.getLogger(\"esri.views.3d.layers.support.FeatureTileTree3D\");let w=class extends t{constructor(e){super(e),this.tiles=new i,this.tileSize=512,this._idToTile=new Map,this._handles=new s,this._clients=new Set,this._dirty=!1,this._newTiles=new h}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;if(!e)return null;return e.clone()}set filterExtent(e){if(e&&!e.spatialReference.equals(this.viewState.spatialReference))return void E.error(\"#extent\",\"extent spatial reference needs to be in the same spatial reference as the view\");const t=this._get(\"filterExtent\");if(t===e||t&&e&&t.equals(e))return;const i=e?e.clone():null;this._set(\"filterExtent\",i),this._setDirty()}get filterExtentRect(){if(!this.filterExtent||!this.tilingScheme)return null;const e=p();return y(this.filterExtent,e,this.tilingScheme.spatialReference),e}get rootTileIds(){return this.filterExtentRect?this.tilingScheme.rootTilesInExtent(this.filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get(\"suspended\")&&(this._set(\"suspended\",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}initialize(){this._handles.add(this.watch([\"tilingScheme\",\"tileSize\"],(()=>this._reset()),!0)),this._handles.add(a(this,[\"tileSize\",\"cameraOnSurface.location\",\"tilingScheme\",\"viewState.contentCamera\",\"focus.location\"],(()=>this._setDirty()),!0)),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(S.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=n(this._frameWorker),this._handles=o(this._handles)}addClient(){const e=R();return this._clients.add(e),1===this._clients.size&&this._setDirty(),{remove:()=>this._removeClient(e)}}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange(\"updating\")):this.runTask(v))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange(\"updating\")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),l(this._frameWorker)&&(this._frameWorker.priority=S.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&l(this._frameWorker)&&(this._frameWorker.priority=S.FEATURE_TILE_TREE),this.notifyChange(\"updating\")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new T({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){return this.rootTileIds.map((e=>new g(e[0],e[1],e[2],this.tilingScheme)))}_purgeHorizonTiles(e){e.sort(((e,t)=>{const i=e.measures.screenRect,s=t.measures.screenRect;return i[1]+i[3]-(s[1]+s[3])})),u(C);for(let t=0;t<e.length;t++)if(m(C,e.data[t].measures.screenRect),_(C)>j)return e.data.slice(t,e.length);return[]}_subdivideTilesForView(e){if(this._pendingTiles){for(;this._pendingTiles.length>0&&!e.done;){const t=this._pendingTiles.pop();e.madeProgress(),this.filterExtentRect&&!f(this.filterExtentRect,t.extent)||(this._tileMeasurements.updateTile(t),0!==t.measures.visibility&&(t.measures.shouldSplit?(this.tilingScheme.ensureMaxLod(t.lij[0]+1),this._pendingTiles.push(...t.getChildren())):this._newTiles.push(t)))}0===this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}}_updateTiles(e){for(const s of this.tiles.items)s.used=!1;const t=e.filter((e=>{const t=this._idToTile.get(e.id);return t?(t.copyMeasurementsFrom(e),t.used=!0):this._idToTile.set(e.id,e),!t})),i=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(t),this.sortTiles()}sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort(((e,t)=>e.measures.visibility!==t.measures.visibility?2===e.measures.visibility?-1:1:e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t))}};e([c({constructOnly:!0})],w.prototype,\"scheduler\",void 0),e([c({constructOnly:!0})],w.prototype,\"renderCoordsHelper\",void 0),e([c({constructOnly:!0})],w.prototype,\"tilingSchemeOwner\",void 0),e([c({constructOnly:!0})],w.prototype,\"cameraOnSurface\",void 0),e([c({constructOnly:!0})],w.prototype,\"focus\",void 0),e([c({constructOnly:!0})],w.prototype,\"viewState\",void 0),e([c({constructOnly:!0})],w.prototype,\"terrain\",void 0),e([c()],w.prototype,\"tiles\",void 0),e([c()],w.prototype,\"tileSize\",void 0),e([c({readOnly:!0})],w.prototype,\"tilingScheme\",null),e([c()],w.prototype,\"filterExtent\",null),e([c({readOnly:!0})],w.prototype,\"filterExtentRect\",null),e([c({readOnly:!0})],w.prototype,\"rootTileIds\",null),e([c({value:!1})],w.prototype,\"suspended\",null),e([c({readOnly:!0})],w.prototype,\"updating\",null),w=e([d(\"esri.views.3d.layers.support.FeatureTileTree3D\")],w);let x=0;function R(){return x++}const C=p(),j=10;var O=w;export default O;export{w as FeatureTileTree3D};\n"]},"metadata":{},"sourceType":"module"}