{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { flatten as i, equals as t } from \"../../../../core/arrayUtils.js\";\nimport { disposeMaybe as e } from \"../../../../core/maybe.js\";\nimport { f as s } from \"../../../../chunks/vec4f64.js\";\nimport \"../../../webgl/BufferObject.js\";\nimport \"../../../webgl/FramebufferObject.js\";\nimport \"../../../../core/has.js\";\nimport \"../../../webgl/enums.js\";\nimport \"../../../webgl/RenderingContext.js\";\nimport \"../../../../chunks/builtins.js\";\nimport a from \"../../../webgl/Texture.js\";\nimport \"../../../webgl/VertexArrayObject.js\";\nimport { createQuadVAO as o } from \"./glUtil3D.js\";\nimport { ShadowAccumulationTechniqueConfiguration as n, ShadowAccumulationTechnique as r } from \"../shaders/ShadowAccumulationTechnique.js\";\nimport { vertexCount as l } from \"../../../webgl/Util.js\";\n\nconst u = [s(.01, 0, .25, 0), s(.01, 0, .25, 1)],\n      h = 4e4,\n      c = 5e4,\n      _ = 1 / 512;\n\nclass m {\n  constructor(t, e, l, h) {\n    this._techniqueRep = t, this._rctx = e, this._shadowAccumulator = l, this._requestRender = h, this._enabled = !1, this._vao = o(e), this._visualizationConfig = new n(), this._visualizationConfig.pass = 1, this._visualizationConfig.visualization = 0, this._visualizeAccumulationTechnique = t.acquire(r, this._visualizationConfig);\n    const c = {\n      target: 3553,\n      pixelFormat: 6408,\n      dataType: 5121,\n      samplingMode: 9729,\n      wrapMode: 33071,\n      width: u.length,\n      height: 1\n    };\n    this._colorRampTexture = new a(this._rctx, c, d(u)), this._visualizationParams = {\n      shadowAccumulationMap: this._accumulationTexture,\n      sampleScale: 0,\n      colorRamp: this._colorRampTexture,\n      rampSize: c.width,\n      threshold: .5,\n      bandSize: .1,\n      colors: i([s(0, 1, 0, .5), s(1, 0, 0, .5)]),\n      opacityFromElevation: 1\n    };\n  }\n\n  dispose() {\n    this._stop(), this._vao = e(this._vao), this._visualizeAccumulationTechnique = e(this._visualizeAccumulationTechnique), this._colorRampTexture = e(this._colorRampTexture), this._shadowAccumulator = null;\n  }\n\n  render() {\n    this._isRenderingVisualization && (this._sampleScale = 1 / this._computedSamples, this._rctx.bindVAO(this._vao), this._rctx.useProgram(this._visualizeAccumulationTechnique.program), this._visualizeAccumulationTechnique.bindPipelineState(this._rctx), this._visualizeAccumulationTechnique.bindPass(this._visualizationParams), this._rctx.drawArrays(this._visualizeAccumulationTechnique.primitiveType, 0, l(this._vao, \"geometry\")));\n  }\n\n  setOptions(i) {\n    void 0 !== i.enabled && this._setEnabled(i.enabled), void 0 !== i.gradientColorRamp && this._setColorRamp(i.gradientColorRamp), void 0 !== i.threshold && (this._threshold = i.threshold), void 0 !== i.thresholdColors && this._setThresholdColors(i.thresholdColors), void 0 !== i.visualization && (this._visualization = i.visualization), void 0 !== i.bandSize && (this._bandSize = i.bandSize), void 0 !== i.bandsEnabled && (this._bandsEnabled = i.bandsEnabled);\n  }\n\n  get opacityFromElevation() {\n    return this._visualizationParams.opacityFromElevation;\n  }\n\n  set opacityFromElevation(i) {\n    this._visualizationParams.opacityFromElevation = i;\n  }\n\n  get _isRenderingVisualization() {\n    return this._enabled && this._computedSamples > 0 && this.opacityFromElevation > _;\n  }\n\n  get _computedSamples() {\n    return this._shadowAccumulator.computedSamples;\n  }\n\n  get _accumulationTexture() {\n    return this._shadowAccumulator.accumulationTexture;\n  }\n\n  get _sampleScale() {\n    return this._visualizationParams.sampleScale;\n  }\n\n  set _sampleScale(i) {\n    this._visualizationParams.sampleScale = i;\n  }\n\n  get _threshold() {\n    return this._visualizationParams.threshold;\n  }\n\n  set _threshold(i) {\n    this._threshold !== i && (this._visualizationParams.threshold = i, this._requestRenderIfRunning());\n  }\n\n  get _visualization() {\n    return this._visualizationConfig.visualization;\n  }\n\n  set _visualization(i) {\n    if (i === this._visualization) return;\n    const t = this._visualizationConfig;\n    t.visualization = i, this._visualizeAccumulationTechnique = this._techniqueRep.releaseAndAcquire(r, t, this._visualizeAccumulationTechnique), this._requestRenderIfRunning();\n  }\n\n  get _bandSize() {\n    return this._visualizationParams.bandSize;\n  }\n\n  set _bandSize(i) {\n    i !== this._bandSize && (this._visualizationParams.bandSize = i, this._requestRenderIfRunning());\n  }\n\n  get _bandsEnabled() {\n    return this._visualizationConfig.bandsEnabled;\n  }\n\n  set _bandsEnabled(i) {\n    if (i === this._bandsEnabled) return;\n    const t = this._visualizationConfig;\n    t.bandsEnabled = i, this._visualizeAccumulationTechnique = this._techniqueRep.releaseAndAcquire(r, t, this._visualizeAccumulationTechnique), this._requestRenderIfRunning();\n  }\n\n  _setColorRamp(i) {\n    const t = i.length,\n          e = d(i);\n    this._colorRampTexture.resize(t, 1), this._colorRampTexture.setData(e), this._visualizationParams.rampSize = t, this._requestRenderIfRunning();\n  }\n\n  _setThresholdColors(e) {\n    const s = this._visualizationParams.colors,\n          a = i(e);\n    t(s, a) || (this._visualizationParams.colors = a, this._requestRenderIfRunning());\n  }\n\n  _setEnabled(i) {\n    i !== this._enabled && (i ? this._start() : this._stop());\n  }\n\n  _requestRenderIfRunning() {\n    this._enabled && this._requestRender();\n  }\n\n  _start() {\n    this._enabled = !0, this._requestRender();\n  }\n\n  _stop() {\n    this._enabled = !1, this._requestRender();\n  }\n\n}\n\nfunction d(i) {\n  const t = i.length,\n        e = new Uint8Array(4 * t);\n\n  for (let s = 0; s < t; ++s) {\n    const t = i[s];\n    e[4 * s + 0] = 255 * t[0], e[4 * s + 1] = 255 * t[1], e[4 * s + 2] = 255 * t[2], e[4 * s + 3] = 255 * t[3];\n  }\n\n  return e;\n}\n\nexport { m as ShadowAccumulationRenderer, c as shadowAccumulationDisableElevationMax, h as shadowAccumulationDisableElevationMin, _ as shadowAccumulationDisabledElevationThreshold };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/webgl-engine/lib/ShadowAccumulationRenderer.js"],"names":["flatten","i","equals","t","disposeMaybe","e","f","s","a","createQuadVAO","o","ShadowAccumulationTechniqueConfiguration","n","ShadowAccumulationTechnique","r","vertexCount","l","u","h","c","_","m","constructor","_techniqueRep","_rctx","_shadowAccumulator","_requestRender","_enabled","_vao","_visualizationConfig","pass","visualization","_visualizeAccumulationTechnique","acquire","target","pixelFormat","dataType","samplingMode","wrapMode","width","length","height","_colorRampTexture","d","_visualizationParams","shadowAccumulationMap","_accumulationTexture","sampleScale","colorRamp","rampSize","threshold","bandSize","colors","opacityFromElevation","dispose","_stop","render","_isRenderingVisualization","_sampleScale","_computedSamples","bindVAO","useProgram","program","bindPipelineState","bindPass","drawArrays","primitiveType","setOptions","enabled","_setEnabled","gradientColorRamp","_setColorRamp","_threshold","thresholdColors","_setThresholdColors","_visualization","_bandSize","bandsEnabled","_bandsEnabled","computedSamples","accumulationTexture","_requestRenderIfRunning","releaseAndAcquire","resize","setData","_start","Uint8Array","ShadowAccumulationRenderer","shadowAccumulationDisableElevationMax","shadowAccumulationDisableElevationMin","shadowAccumulationDisabledElevationThreshold"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{flatten as i,equals as t}from\"../../../../core/arrayUtils.js\";import{disposeMaybe as e}from\"../../../../core/maybe.js\";import{f as s}from\"../../../../chunks/vec4f64.js\";import\"../../../webgl/BufferObject.js\";import\"../../../webgl/FramebufferObject.js\";import\"../../../../core/has.js\";import\"../../../webgl/enums.js\";import\"../../../webgl/RenderingContext.js\";import\"../../../../chunks/builtins.js\";import a from\"../../../webgl/Texture.js\";import\"../../../webgl/VertexArrayObject.js\";import{createQuadVAO as o}from\"./glUtil3D.js\";import{ShadowAccumulationTechniqueConfiguration as n,ShadowAccumulationTechnique as r}from\"../shaders/ShadowAccumulationTechnique.js\";import{vertexCount as l}from\"../../../webgl/Util.js\";const u=[s(.01,0,.25,0),s(.01,0,.25,1)],h=4e4,c=5e4,_=1/512;class m{constructor(t,e,l,h){this._techniqueRep=t,this._rctx=e,this._shadowAccumulator=l,this._requestRender=h,this._enabled=!1,this._vao=o(e),this._visualizationConfig=new n,this._visualizationConfig.pass=1,this._visualizationConfig.visualization=0,this._visualizeAccumulationTechnique=t.acquire(r,this._visualizationConfig);const c={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:u.length,height:1};this._colorRampTexture=new a(this._rctx,c,d(u)),this._visualizationParams={shadowAccumulationMap:this._accumulationTexture,sampleScale:0,colorRamp:this._colorRampTexture,rampSize:c.width,threshold:.5,bandSize:.1,colors:i([s(0,1,0,.5),s(1,0,0,.5)]),opacityFromElevation:1}}dispose(){this._stop(),this._vao=e(this._vao),this._visualizeAccumulationTechnique=e(this._visualizeAccumulationTechnique),this._colorRampTexture=e(this._colorRampTexture),this._shadowAccumulator=null}render(){this._isRenderingVisualization&&(this._sampleScale=1/this._computedSamples,this._rctx.bindVAO(this._vao),this._rctx.useProgram(this._visualizeAccumulationTechnique.program),this._visualizeAccumulationTechnique.bindPipelineState(this._rctx),this._visualizeAccumulationTechnique.bindPass(this._visualizationParams),this._rctx.drawArrays(this._visualizeAccumulationTechnique.primitiveType,0,l(this._vao,\"geometry\")))}setOptions(i){void 0!==i.enabled&&this._setEnabled(i.enabled),void 0!==i.gradientColorRamp&&this._setColorRamp(i.gradientColorRamp),void 0!==i.threshold&&(this._threshold=i.threshold),void 0!==i.thresholdColors&&this._setThresholdColors(i.thresholdColors),void 0!==i.visualization&&(this._visualization=i.visualization),void 0!==i.bandSize&&(this._bandSize=i.bandSize),void 0!==i.bandsEnabled&&(this._bandsEnabled=i.bandsEnabled)}get opacityFromElevation(){return this._visualizationParams.opacityFromElevation}set opacityFromElevation(i){this._visualizationParams.opacityFromElevation=i}get _isRenderingVisualization(){return this._enabled&&this._computedSamples>0&&this.opacityFromElevation>_}get _computedSamples(){return this._shadowAccumulator.computedSamples}get _accumulationTexture(){return this._shadowAccumulator.accumulationTexture}get _sampleScale(){return this._visualizationParams.sampleScale}set _sampleScale(i){this._visualizationParams.sampleScale=i}get _threshold(){return this._visualizationParams.threshold}set _threshold(i){this._threshold!==i&&(this._visualizationParams.threshold=i,this._requestRenderIfRunning())}get _visualization(){return this._visualizationConfig.visualization}set _visualization(i){if(i===this._visualization)return;const t=this._visualizationConfig;t.visualization=i,this._visualizeAccumulationTechnique=this._techniqueRep.releaseAndAcquire(r,t,this._visualizeAccumulationTechnique),this._requestRenderIfRunning()}get _bandSize(){return this._visualizationParams.bandSize}set _bandSize(i){i!==this._bandSize&&(this._visualizationParams.bandSize=i,this._requestRenderIfRunning())}get _bandsEnabled(){return this._visualizationConfig.bandsEnabled}set _bandsEnabled(i){if(i===this._bandsEnabled)return;const t=this._visualizationConfig;t.bandsEnabled=i,this._visualizeAccumulationTechnique=this._techniqueRep.releaseAndAcquire(r,t,this._visualizeAccumulationTechnique),this._requestRenderIfRunning()}_setColorRamp(i){const t=i.length,e=d(i);this._colorRampTexture.resize(t,1),this._colorRampTexture.setData(e),this._visualizationParams.rampSize=t,this._requestRenderIfRunning()}_setThresholdColors(e){const s=this._visualizationParams.colors,a=i(e);t(s,a)||(this._visualizationParams.colors=a,this._requestRenderIfRunning())}_setEnabled(i){i!==this._enabled&&(i?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}}function d(i){const t=i.length,e=new Uint8Array(4*t);for(let s=0;s<t;++s){const t=i[s];e[4*s+0]=255*t[0],e[4*s+1]=255*t[1],e[4*s+2]=255*t[2],e[4*s+3]=255*t[3]}return e}export{m as ShadowAccumulationRenderer,c as shadowAccumulationDisableElevationMax,h as shadowAccumulationDisableElevationMin,_ as shadowAccumulationDisabledElevationThreshold};\n"]},"metadata":{},"sourceType":"module"}