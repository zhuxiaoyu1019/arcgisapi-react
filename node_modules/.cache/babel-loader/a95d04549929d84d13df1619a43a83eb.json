{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../chunks/tslib.es6.js\";\nimport s from \"../Color.js\";\nimport t from \"../request.js\";\nimport r from \"../core/Error.js\";\nimport { clone as i } from \"../core/lang.js\";\nimport o from \"../core/Logger.js\";\nimport n from \"../core/LRUCache.js\";\nimport { isSome as a } from \"../core/maybe.js\";\nimport { isAbortError as l } from \"../core/promiseUtils.js\";\nimport { numericHash as c } from \"../core/string.js\";\nimport { property as p } from \"../core/accessorSupport/decorators/property.js\";\nimport \"../core/accessorSupport/ensureType.js\";\nimport \"../core/has.js\";\nimport { subclass as m } from \"../core/accessorSupport/decorators/subclass.js\";\nimport { writer as u } from \"../core/accessorSupport/decorators/writer.js\";\nimport { collectArcadeFieldNames as h } from \"../layers/support/fieldUtils.js\";\nimport f from \"./Renderer.js\";\nimport { VisualVariablesMixin as y } from \"./mixins/VisualVariablesMixin.js\";\nimport { loadArcade as d, createDictionaryExpression as g } from \"../support/arcadeOnDemand.js\";\nimport b from \"../symbols/CIMSymbol.js\";\n\nvar _;\n\nconst j = o.getLogger(\"esri.renderers.DictionaryRenderer\"),\n      w = {\n  type: \"CIMSimpleLineCallout\",\n  lineSymbol: {\n    type: \"CIMLineSymbol\",\n    symbolLayers: [{\n      type: \"CIMSolidStroke\",\n      width: .5,\n      color: [0, 0, 0, 255]\n    }]\n  }\n};\nlet S = _ = class extends y(f) {\n  constructor(e) {\n    super(e), this._ongoingRequests = new Map(), this._symbolCache = new n(100), this.config = null, this.fieldMap = null, this.scaleExpression = null, this.scaleExpressionTitle = null, this.url = null, this.type = \"dictionary\";\n  }\n\n  writeData(e, s) {\n    e && (s.scalingExpressionInfo = {\n      expression: e,\n      returnType: \"number\"\n    });\n  }\n\n  writeVisualVariables(e, s, t, r) {\n    null != r && r.origin || super.writeVisualVariables(e, s, t, r);\n  }\n\n  clone() {\n    return new _({\n      config: i(this.config),\n      scaleExpression: this.scaleExpression,\n      scaleExpressionTitle: this.scaleExpressionTitle,\n      fieldMap: i(this.fieldMap),\n      url: i(this.url),\n      visualVariables: i(this.visualVariables)\n    });\n  }\n\n  async getSymbolAsync(e, t) {\n    let r;\n    this._dictionaryPromise || (this._dictionaryPromise = this.fetchResources(t));\n\n    try {\n      r = await this._dictionaryPromise;\n    } catch (d) {\n      if (l(d)) return this._dictionaryPromise = null, null;\n    }\n\n    const i = {};\n    if (this.fieldMap) for (const s of this._symbolFields) {\n      const t = this.fieldMap[s];\n\n      if (t && null !== e.attributes[t] && void 0 !== e.attributes[t]) {\n        const r = \"\" + e.attributes[t];\n        i[s] = r;\n      } else i[s] = \"\";\n    }\n    const o = r(i, t);\n    if (!o || \"string\" != typeof o) return null;\n\n    const n = c(o).toString(),\n          p = this._symbolCache.get(n);\n\n    if (p) return p.catch(() => {\n      this._symbolCache.pop(n);\n    }), p;\n    const m = o.split(\";\"),\n          u = [],\n          h = [];\n\n    for (const a of m) if (a && 0 !== a.length) if (-1 === a.indexOf(\"po:\")) {\n      if (-1 !== a.indexOf(\"|\")) for (const e of a.split(\"|\")) this._itemNames.has(e) && u.push(e);else this._itemNames.has(a) && u.push(a);\n    } else {\n      const e = a.substr(3).split(\"|\");\n\n      if (3 === e.length) {\n        const t = e[0],\n              r = e[1];\n        let i = e[2];\n        if (\"DashTemplate\" === r) i = i.split(\" \").map(e => Number(e));else if (\"Color\" === r) {\n          const e = new s(i).toRgba();\n          i = [e[0], e[1], e[2], 255 * e[3]];\n        } else i = Number(i);\n        h.push({\n          primitiveName: t,\n          propertyName: r,\n          value: i\n        });\n      }\n    }\n\n    const f = !a(e.geometry) || !e.geometry.hasZ && \"point\" === e.geometry.type,\n          y = this._cimPartsToCIMSymbol(u, h, f, t);\n\n    return this._symbolCache.put(n, y, 1), y;\n  }\n\n  async collectRequiredFields(e, s) {\n    await this.collectVVRequiredFields(e, s), this.scaleExpression && (await h(e, s, this.scaleExpression));\n\n    for (const t in this.fieldMap) {\n      const r = this.fieldMap[t];\n      s.has(r) && e.add(r);\n    }\n  }\n\n  get arcadeRequired() {\n    return !0;\n  }\n\n  async fetchResources(e) {\n    if (this._dictionaryPromise) return this._dictionaryPromise;\n    if (!this.url) return void j.error(\"no valid URL!\");\n    const s = a(e) ? e.abortOptions : null,\n          i = t(this.url + \"/resources/styles/dictionary-info.json\", {\n      responseType: \"json\",\n      query: {\n        f: \"json\"\n      },\n      ...s\n    }),\n          [{\n      data: o\n    }] = await Promise.all([i, d()]);\n    if (!o) throw this._dictionaryPromise = null, new r(\"esri.renderers.DictionaryRenderer\", \"Bad dictionary data!\");\n    const n = o.expression,\n          l = o.authoringInfo;\n    this._refSymbolUrlTemplate = this.url + \"/\" + o.cimRefTemplateUrl, this._itemNames = new Set(o.itemsNames), this._symbolFields = l.symbol;\n    const c = {};\n\n    if (this.config) {\n      const e = this.config;\n\n      for (const s in e) c[s] = e[s];\n    }\n\n    if (l.configuration) for (const t of l.configuration) c.hasOwnProperty(t.name) || (c[t.name] = t.value);\n    const p = [];\n    if (a(e) && e.fields && this.fieldMap) for (const t of this._symbolFields) {\n      const s = this.fieldMap[t],\n            r = e.fields.filter(e => e.name === s);\n      r.length > 0 && p.push({ ...r[0],\n        name: t\n      });\n    }\n    return this._dictionaryPromise = g(n, a(e) ? e.spatialReference : null, p, c).then(e => {\n      const s = {\n        scale: 0\n      };\n      return (t, r) => {\n        const i = e.repurposeFeature({\n          geometry: null,\n          attributes: t\n        });\n        return s.scale = a(r) ? r.scale : void 0, e.evaluate({\n          $feature: i,\n          $view: s\n        });\n      };\n    }).catch(e => (j.error(\"Creating dictinoary expression failed:\", e), null)), this._dictionaryPromise;\n  }\n\n  getSymbol() {\n    return null;\n  }\n\n  getSymbols() {\n    return [];\n  }\n\n  getAttributeHash() {\n    return this.visualVariables && this.visualVariables.reduce((e, s) => e + s.getAttributeHash(), \"\");\n  }\n\n  getMeshHash() {\n    return `${this.url}-${JSON.stringify(this.fieldMap)}`;\n  }\n\n  getSymbolFields() {\n    return this._symbolFields;\n  }\n\n  async _getSymbolPart(e, s) {\n    if (this._ongoingRequests.has(e)) return this._ongoingRequests.get(e).then(e => e.data);\n\n    const r = this._refSymbolUrlTemplate.replace(/\\{itemName\\}/gi, e),\n          i = t(r, {\n      responseType: \"json\",\n      query: {\n        f: \"json\"\n      },\n      ...s\n    });\n\n    this._ongoingRequests.set(e, i);\n\n    try {\n      return (await i).data;\n    } catch (o) {\n      return this._ongoingRequests.delete(e), Promise.reject(o);\n    }\n  }\n\n  _combineSymbolParts(e, s, t) {\n    if (!e || 0 === e.length) return null;\n    const r = { ...e[0]\n    };\n\n    if (e.length > 1) {\n      r.symbolLayers = [];\n\n      for (const s of e) {\n        const e = s;\n        r.symbolLayers.unshift(...e.symbolLayers);\n      }\n    }\n\n    return t && (r.callout = w), {\n      type: \"CIMSymbolReference\",\n      symbol: r,\n      primitiveOverrides: s\n    };\n  }\n\n  async _cimPartsToCIMSymbol(e, s, t, r) {\n    const i = new Array(e.length);\n\n    for (let n = 0; n < e.length; n++) i[n] = this._getSymbolPart(e[n], r);\n\n    const o = await Promise.all(i);\n    return new b({\n      data: this._combineSymbolParts(o, s, t)\n    });\n  }\n\n};\ne([p({\n  type: Object,\n  json: {\n    read: {\n      source: \"configuration\"\n    },\n    write: {\n      target: \"configuration\"\n    }\n  }\n})], S.prototype, \"config\", void 0), e([p({\n  type: Object,\n  json: {\n    write: !0\n  }\n})], S.prototype, \"fieldMap\", void 0), e([p({\n  type: String,\n  json: {\n    read: {\n      source: \"scalingExpressionInfo.expression\"\n    },\n    write: !0\n  }\n})], S.prototype, \"scaleExpression\", void 0), e([u(\"scaleExpression\")], S.prototype, \"writeData\", null), e([p({\n  type: String,\n  json: {\n    read: {\n      source: \"scalingExpressionInfo.title\"\n    },\n    write: {\n      target: \"scalingExpressionInfo.title\",\n\n      overridePolicy(e) {\n        return {\n          enabled: !!e && !!this.scaleExpression\n        };\n      }\n\n    }\n  }\n})], S.prototype, \"scaleExpressionTitle\", void 0), e([p({\n  type: String,\n  json: {\n    write: !0\n  }\n})], S.prototype, \"url\", void 0), e([u(\"visualVariables\")], S.prototype, \"writeVisualVariables\", null), S = _ = e([m(\"esri.renderers.DictionaryRenderer\")], S);\nvar x = S;\nexport default x;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/renderers/DictionaryRenderer.js"],"names":["_","e","s","t","r","clone","i","o","n","isSome","a","isAbortError","l","numericHash","c","property","p","subclass","m","writer","u","collectArcadeFieldNames","h","f","VisualVariablesMixin","y","loadArcade","d","createDictionaryExpression","g","b","j","getLogger","w","type","lineSymbol","symbolLayers","width","color","S","constructor","_ongoingRequests","Map","_symbolCache","config","fieldMap","scaleExpression","scaleExpressionTitle","url","writeData","scalingExpressionInfo","expression","returnType","writeVisualVariables","origin","visualVariables","getSymbolAsync","_dictionaryPromise","fetchResources","_symbolFields","attributes","toString","get","catch","pop","split","length","indexOf","_itemNames","has","push","substr","map","Number","toRgba","primitiveName","propertyName","value","geometry","hasZ","_cimPartsToCIMSymbol","put","collectRequiredFields","collectVVRequiredFields","add","arcadeRequired","error","abortOptions","responseType","query","data","Promise","all","authoringInfo","_refSymbolUrlTemplate","cimRefTemplateUrl","Set","itemsNames","symbol","configuration","hasOwnProperty","name","fields","filter","spatialReference","then","scale","repurposeFeature","evaluate","$feature","$view","getSymbol","getSymbols","getAttributeHash","reduce","getMeshHash","JSON","stringify","getSymbolFields","_getSymbolPart","replace","set","delete","reject","_combineSymbolParts","unshift","callout","primitiveOverrides","Array","Object","json","read","source","write","target","prototype","String","overridePolicy","enabled","x"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../chunks/tslib.es6.js\";import s from\"../Color.js\";import t from\"../request.js\";import r from\"../core/Error.js\";import{clone as i}from\"../core/lang.js\";import o from\"../core/Logger.js\";import n from\"../core/LRUCache.js\";import{isSome as a}from\"../core/maybe.js\";import{isAbortError as l}from\"../core/promiseUtils.js\";import{numericHash as c}from\"../core/string.js\";import{property as p}from\"../core/accessorSupport/decorators/property.js\";import\"../core/accessorSupport/ensureType.js\";import\"../core/has.js\";import{subclass as m}from\"../core/accessorSupport/decorators/subclass.js\";import{writer as u}from\"../core/accessorSupport/decorators/writer.js\";import{collectArcadeFieldNames as h}from\"../layers/support/fieldUtils.js\";import f from\"./Renderer.js\";import{VisualVariablesMixin as y}from\"./mixins/VisualVariablesMixin.js\";import{loadArcade as d,createDictionaryExpression as g}from\"../support/arcadeOnDemand.js\";import b from\"../symbols/CIMSymbol.js\";var _;const j=o.getLogger(\"esri.renderers.DictionaryRenderer\"),w={type:\"CIMSimpleLineCallout\",lineSymbol:{type:\"CIMLineSymbol\",symbolLayers:[{type:\"CIMSolidStroke\",width:.5,color:[0,0,0,255]}]}};let S=_=class extends(y(f)){constructor(e){super(e),this._ongoingRequests=new Map,this._symbolCache=new n(100),this.config=null,this.fieldMap=null,this.scaleExpression=null,this.scaleExpressionTitle=null,this.url=null,this.type=\"dictionary\"}writeData(e,s){e&&(s.scalingExpressionInfo={expression:e,returnType:\"number\"})}writeVisualVariables(e,s,t,r){null!=r&&r.origin||super.writeVisualVariables(e,s,t,r)}clone(){return new _({config:i(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:i(this.fieldMap),url:i(this.url),visualVariables:i(this.visualVariables)})}async getSymbolAsync(e,t){let r;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(t));try{r=await this._dictionaryPromise}catch(d){if(l(d))return this._dictionaryPromise=null,null}const i={};if(this.fieldMap)for(const s of this._symbolFields){const t=this.fieldMap[s];if(t&&null!==e.attributes[t]&&void 0!==e.attributes[t]){const r=\"\"+e.attributes[t];i[s]=r}else i[s]=\"\"}const o=r(i,t);if(!o||\"string\"!=typeof o)return null;const n=c(o).toString(),p=this._symbolCache.get(n);if(p)return p.catch((()=>{this._symbolCache.pop(n)})),p;const m=o.split(\";\"),u=[],h=[];for(const a of m)if(a&&0!==a.length)if(-1===a.indexOf(\"po:\"))if(-1!==a.indexOf(\"|\"))for(const e of a.split(\"|\"))this._itemNames.has(e)&&u.push(e);else this._itemNames.has(a)&&u.push(a);else{const e=a.substr(3).split(\"|\");if(3===e.length){const t=e[0],r=e[1];let i=e[2];if(\"DashTemplate\"===r)i=i.split(\" \").map((e=>Number(e)));else if(\"Color\"===r){const e=new s(i).toRgba();i=[e[0],e[1],e[2],255*e[3]]}else i=Number(i);h.push({primitiveName:t,propertyName:r,value:i})}}const f=!a(e.geometry)||!e.geometry.hasZ&&\"point\"===e.geometry.type,y=this._cimPartsToCIMSymbol(u,h,f,t);return this._symbolCache.put(n,y,1),y}async collectRequiredFields(e,s){await this.collectVVRequiredFields(e,s),this.scaleExpression&&await h(e,s,this.scaleExpression);for(const t in this.fieldMap){const r=this.fieldMap[t];s.has(r)&&e.add(r)}}get arcadeRequired(){return!0}async fetchResources(e){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void j.error(\"no valid URL!\");const s=a(e)?e.abortOptions:null,i=t(this.url+\"/resources/styles/dictionary-info.json\",{responseType:\"json\",query:{f:\"json\"},...s}),[{data:o}]=await Promise.all([i,d()]);if(!o)throw this._dictionaryPromise=null,new r(\"esri.renderers.DictionaryRenderer\",\"Bad dictionary data!\");const n=o.expression,l=o.authoringInfo;this._refSymbolUrlTemplate=this.url+\"/\"+o.cimRefTemplateUrl,this._itemNames=new Set(o.itemsNames),this._symbolFields=l.symbol;const c={};if(this.config){const e=this.config;for(const s in e)c[s]=e[s]}if(l.configuration)for(const t of l.configuration)c.hasOwnProperty(t.name)||(c[t.name]=t.value);const p=[];if(a(e)&&e.fields&&this.fieldMap)for(const t of this._symbolFields){const s=this.fieldMap[t],r=e.fields.filter((e=>e.name===s));r.length>0&&p.push({...r[0],name:t})}return this._dictionaryPromise=g(n,a(e)?e.spatialReference:null,p,c).then((e=>{const s={scale:0};return(t,r)=>{const i=e.repurposeFeature({geometry:null,attributes:t});return s.scale=a(r)?r.scale:void 0,e.evaluate({$feature:i,$view:s})}})).catch((e=>(j.error(\"Creating dictinoary expression failed:\",e),null))),this._dictionaryPromise}getSymbol(){return null}getSymbols(){return[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce(((e,s)=>e+s.getAttributeHash()),\"\")}getMeshHash(){return`${this.url}-${JSON.stringify(this.fieldMap)}`}getSymbolFields(){return this._symbolFields}async _getSymbolPart(e,s){if(this._ongoingRequests.has(e))return this._ongoingRequests.get(e).then((e=>e.data));const r=this._refSymbolUrlTemplate.replace(/\\{itemName\\}/gi,e),i=t(r,{responseType:\"json\",query:{f:\"json\"},...s});this._ongoingRequests.set(e,i);try{return(await i).data}catch(o){return this._ongoingRequests.delete(e),Promise.reject(o)}}_combineSymbolParts(e,s,t){if(!e||0===e.length)return null;const r={...e[0]};if(e.length>1){r.symbolLayers=[];for(const s of e){const e=s;r.symbolLayers.unshift(...e.symbolLayers)}}return t&&(r.callout=w),{type:\"CIMSymbolReference\",symbol:r,primitiveOverrides:s}}async _cimPartsToCIMSymbol(e,s,t,r){const i=new Array(e.length);for(let n=0;n<e.length;n++)i[n]=this._getSymbolPart(e[n],r);const o=await Promise.all(i);return new b({data:this._combineSymbolParts(o,s,t)})}};e([p({type:Object,json:{read:{source:\"configuration\"},write:{target:\"configuration\"}}})],S.prototype,\"config\",void 0),e([p({type:Object,json:{write:!0}})],S.prototype,\"fieldMap\",void 0),e([p({type:String,json:{read:{source:\"scalingExpressionInfo.expression\"},write:!0}})],S.prototype,\"scaleExpression\",void 0),e([u(\"scaleExpression\")],S.prototype,\"writeData\",null),e([p({type:String,json:{read:{source:\"scalingExpressionInfo.title\"},write:{target:\"scalingExpressionInfo.title\",overridePolicy(e){return{enabled:!!e&&!!this.scaleExpression}}}}})],S.prototype,\"scaleExpressionTitle\",void 0),e([p({type:String,json:{write:!0}})],S.prototype,\"url\",void 0),e([u(\"visualVariables\")],S.prototype,\"writeVisualVariables\",null),S=_=e([m(\"esri.renderers.DictionaryRenderer\")],S);var x=S;export default x;\n"]},"metadata":{},"sourceType":"module"}