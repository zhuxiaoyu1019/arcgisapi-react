{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../../../TimeExtent.js\";\nimport t from \"../../../../../core/Evented.js\";\nimport s from \"../../../../../core/has.js\";\nimport { isSome as i } from \"../../../../../core/maybe.js\";\nimport { createResolver as r, eachAlwaysValues as o, eachAlways as n } from \"../../../../../core/promiseUtils.js\";\nimport { diff as u, hasDiff as c, hasDiffAny as h } from \"../../../../../core/accessorSupport/diffUtils.js\";\nimport a from \"../../../../../rest/support/Query.js\";\nimport { DataTileSubscription as d } from \"./DataTileSubscription.js\";\n\nfunction l(e, t) {\n  const s = new Set();\n  return e && e.forEach(e => s.add(e)), t && t.forEach(e => s.add(e)), s.has(\"*\") ? [\"*\"] : Array.from(s);\n}\n\nclass p {\n  constructor(e) {\n    this.events = new t(), this._resolver = r(), this._didEdit = !1, this._subscriptions = new Map(), this._outSR = e.outSR, this._serviceInfo = e.serviceInfo, this._onTileUpdateMessage = e.onMessage;\n  }\n\n  destroy() {}\n\n  async _onMessage(e) {\n    var t;\n\n    const s = this._subscriptions.get(e.id);\n\n    if (!s) return;\n    const i = { ...e,\n      remove: null != (t = e.remove) ? t : [],\n      status: e.status\n    };\n    return this._onTileUpdateMessage(i, s.options);\n  }\n\n  update(t, i) {\n    var r;\n    const o = i.fields.length;\n    i.outFields = l(null == (r = this._schema) ? void 0 : r.outFields, i.outFields), i.outFields = i.outFields.length >= .75 * o ? [\"*\"] : i.outFields, i.outFields.sort();\n    const n = u(this._schema, i);\n    if (!n) return;\n    s(\"esri-2d-update-debug\") && console.debug(\"Applying Update - Source:\", n);\n    const a = {\n      returnCentroid: s(\"esri-2d-query-centroid-enabled\") && \"esriGeometryPolygon\" === this._serviceInfo.geometryType,\n      returnGeometry: !0,\n      outFields: i.outFields,\n      outSpatialReference: this._outSR,\n      orderByFields: [`${this._serviceInfo.objectIdField} ASC`],\n      where: i.definitionExpression || \"1=1\",\n      gdbVersion: i.gdbVersion,\n      historicMoment: i.historicMoment,\n      timeExtent: e.fromJSON(i.timeExtent)\n    },\n          d = this._schema && c(n, \"outFields\");\n    this._schema && h(n, [\"timeExtent\", \"definitionExpression\", \"gdbVersion\", \"historicMoment\"]) && (t.why.mesh.push(\"Layer filter changed\"), t.why.source.push(\"Layer filter changed\"), t.mesh = !0, t.source = !0, t.queryFilter = !0), d && (t.why.source.push(\"Layer required fields changed\"), t.source = !0), u(a, this._queryInfo) && (this._queryInfo = a), this._schema = i, this._resolver.resolve();\n  }\n\n  whenInitialized() {\n    return this._resolver.promise;\n  }\n\n  async applyUpdate(e) {\n    if (e.queryFilter || e.source && this._didEdit) return this.refresh(), void (this._didEdit = !1);\n    this._subscriptions.forEach(t => t.applyUpdate(e)), await this.resend();\n  }\n\n  refresh() {\n    for (const e of this._tiles()) this.unsubscribe(e), this.subscribe(e);\n  }\n\n  subscribe(e) {\n    const t = new d(e);\n\n    this._subscriptions.set(e.id, t);\n  }\n\n  unsubscribe(e) {\n    const t = this.get(e.id);\n    i(t) && t.abort(), this._subscriptions.delete(e.id);\n  }\n\n  createQuery(e = {}) {\n    const t = this._queryInfo.historicMoment ? new Date(this._queryInfo.historicMoment) : null;\n    return new a({ ...this._queryInfo,\n      historicMoment: t,\n      ...e\n    });\n  }\n\n  get(e) {\n    return this._subscriptions.has(e) ? this._subscriptions.get(e) : null;\n  }\n\n  async queryLastEditDate() {\n    throw new Error(\"Service does not support query type\");\n  }\n\n  async query(e) {\n    throw new Error(\"Service does not support query\");\n  }\n\n  *_tiles() {\n    const e = Array.from(this._subscriptions.values());\n\n    for (const t of e) yield t.tile;\n  }\n\n  async edit(e, t) {\n    const s = Array.from(this._subscriptions.values()),\n          i = s.map(({\n      tile: e\n    }) => e);\n\n    for (const r of s) r.removeIds(t);\n\n    if (e.length) {\n      const s = i.map(t => {\n        const s = this.createTileQuery(t);\n        return s.objectIds = e, {\n          tile: t,\n          query: s\n        };\n      }).map(async ({\n        tile: e,\n        query: t\n      }) => ({\n        tile: e,\n        result: await this.query(t),\n        query: t\n      })),\n            r = (await o(s)).map(async ({\n        tile: s,\n        result: i\n      }) => {\n        if (!i.hasFeatures && !t.length && !e.length) return;\n\n        const r = this._subscriptions.get(s.key.id);\n\n        r && r.edit(i, e);\n      });\n      await n(r);\n    }\n\n    this._didEdit = !0;\n  }\n\n}\n\nexport { p as DataTileSource };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/2d/layers/features/sources/DataTileSource.js"],"names":["e","t","s","isSome","i","createResolver","r","eachAlwaysValues","o","eachAlways","n","diff","u","hasDiff","c","hasDiffAny","h","a","DataTileSubscription","d","l","Set","forEach","add","has","Array","from","p","constructor","events","_resolver","_didEdit","_subscriptions","Map","_outSR","outSR","_serviceInfo","serviceInfo","_onTileUpdateMessage","onMessage","destroy","_onMessage","get","id","remove","status","options","update","fields","length","outFields","_schema","sort","console","debug","returnCentroid","geometryType","returnGeometry","outSpatialReference","orderByFields","objectIdField","where","definitionExpression","gdbVersion","historicMoment","timeExtent","fromJSON","why","mesh","push","source","queryFilter","_queryInfo","resolve","whenInitialized","promise","applyUpdate","refresh","resend","_tiles","unsubscribe","subscribe","set","abort","delete","createQuery","Date","queryLastEditDate","Error","query","values","tile","edit","map","removeIds","createTileQuery","objectIds","result","hasFeatures","key","DataTileSource"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../../../TimeExtent.js\";import t from\"../../../../../core/Evented.js\";import s from\"../../../../../core/has.js\";import{isSome as i}from\"../../../../../core/maybe.js\";import{createResolver as r,eachAlwaysValues as o,eachAlways as n}from\"../../../../../core/promiseUtils.js\";import{diff as u,hasDiff as c,hasDiffAny as h}from\"../../../../../core/accessorSupport/diffUtils.js\";import a from\"../../../../../rest/support/Query.js\";import{DataTileSubscription as d}from\"./DataTileSubscription.js\";function l(e,t){const s=new Set;return e&&e.forEach((e=>s.add(e))),t&&t.forEach((e=>s.add(e))),s.has(\"*\")?[\"*\"]:Array.from(s)}class p{constructor(e){this.events=new t,this._resolver=r(),this._didEdit=!1,this._subscriptions=new Map,this._outSR=e.outSR,this._serviceInfo=e.serviceInfo,this._onTileUpdateMessage=e.onMessage}destroy(){}async _onMessage(e){var t;const s=this._subscriptions.get(e.id);if(!s)return;const i={...e,remove:null!=(t=e.remove)?t:[],status:e.status};return this._onTileUpdateMessage(i,s.options)}update(t,i){var r;const o=i.fields.length;i.outFields=l(null==(r=this._schema)?void 0:r.outFields,i.outFields),i.outFields=i.outFields.length>=.75*o?[\"*\"]:i.outFields,i.outFields.sort();const n=u(this._schema,i);if(!n)return;s(\"esri-2d-update-debug\")&&console.debug(\"Applying Update - Source:\",n);const a={returnCentroid:s(\"esri-2d-query-centroid-enabled\")&&\"esriGeometryPolygon\"===this._serviceInfo.geometryType,returnGeometry:!0,outFields:i.outFields,outSpatialReference:this._outSR,orderByFields:[`${this._serviceInfo.objectIdField} ASC`],where:i.definitionExpression||\"1=1\",gdbVersion:i.gdbVersion,historicMoment:i.historicMoment,timeExtent:e.fromJSON(i.timeExtent)},d=this._schema&&c(n,\"outFields\");this._schema&&h(n,[\"timeExtent\",\"definitionExpression\",\"gdbVersion\",\"historicMoment\"])&&(t.why.mesh.push(\"Layer filter changed\"),t.why.source.push(\"Layer filter changed\"),t.mesh=!0,t.source=!0,t.queryFilter=!0),d&&(t.why.source.push(\"Layer required fields changed\"),t.source=!0),u(a,this._queryInfo)&&(this._queryInfo=a),this._schema=i,this._resolver.resolve()}whenInitialized(){return this._resolver.promise}async applyUpdate(e){if(e.queryFilter||e.source&&this._didEdit)return this.refresh(),void(this._didEdit=!1);this._subscriptions.forEach((t=>t.applyUpdate(e))),await this.resend()}refresh(){for(const e of this._tiles())this.unsubscribe(e),this.subscribe(e)}subscribe(e){const t=new d(e);this._subscriptions.set(e.id,t)}unsubscribe(e){const t=this.get(e.id);i(t)&&t.abort(),this._subscriptions.delete(e.id)}createQuery(e={}){const t=this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null;return new a({...this._queryInfo,historicMoment:t,...e})}get(e){return this._subscriptions.has(e)?this._subscriptions.get(e):null}async queryLastEditDate(){throw new Error(\"Service does not support query type\")}async query(e){throw new Error(\"Service does not support query\")}*_tiles(){const e=Array.from(this._subscriptions.values());for(const t of e)yield t.tile}async edit(e,t){const s=Array.from(this._subscriptions.values()),i=s.map((({tile:e})=>e));for(const r of s)r.removeIds(t);if(e.length){const s=i.map((t=>{const s=this.createTileQuery(t);return s.objectIds=e,{tile:t,query:s}})).map((async({tile:e,query:t})=>({tile:e,result:await this.query(t),query:t}))),r=(await o(s)).map((async({tile:s,result:i})=>{if(!i.hasFeatures&&!t.length&&!e.length)return;const r=this._subscriptions.get(s.key.id);r&&r.edit(i,e)}));await n(r)}this._didEdit=!0}}export{p as DataTileSource};\n"]},"metadata":{},"sourceType":"module"}