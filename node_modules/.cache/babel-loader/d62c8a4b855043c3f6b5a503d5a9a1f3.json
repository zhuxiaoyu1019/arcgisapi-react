{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from \"../../../Color.js\";\nimport e from \"../../../request.js\";\nimport { unwrap as r, applySome as o, isSome as n } from \"../../../core/maybe.js\";\nimport { a as s } from \"../../../chunks/mat3.js\";\nimport { c as a } from \"../../../chunks/mat3f64.js\";\nimport { f as i } from \"../../../chunks/vec3f64.js\";\nimport { f as u } from \"../../../chunks/vec4f64.js\";\nimport l from \"../MeshComponent.js\";\nimport c from \"../MeshMaterialMetallicRoughness.js\";\nimport f from \"../MeshTexture.js\";\nimport m from \"../MeshVertexAttributes.js\";\nimport { BufferViewVec3f64 as p, BufferViewVec3f as d, BufferViewVec4f as g, BufferViewVec4u8 as x, BufferViewVec2f as b, BufferViewVec4u16 as h, BufferViewVec3u8 as v, BufferViewVec3u16 as w } from \"../buffer/BufferView.js\";\nimport { t as j, a as y, s as C, b as M } from \"../../../chunks/vec32.js\";\nimport { t as A, s as T, a as k } from \"../../../chunks/vec42.js\";\nimport { createBuffer as B } from \"../buffer/utils.js\";\nimport { georeferenceByTransform as F } from \"./georeference.js\";\nimport { DefaultLoadingContext as I } from \"../../../views/3d/glTF/DefaultLoadingContext.js\";\nimport { load as R } from \"../../../views/3d/glTF/loader.js\";\nimport { triangleFanToTriangles as E, triangleStripToTriangles as S, trianglesToTriangles as D } from \"../../../views/3d/glTF/internal/indexUtils.js\";\nimport { generateIndexArray as O } from \"../../../views/3d/webgl-engine/lib/geometryDataUtils.js\";\nimport { COLOR_GAMMA as q } from \"../../../views/3d/webgl-engine/materials/DefaultMaterial_COLOR_GAMMA.js\";\nimport { f as L, c as N } from \"../../../chunks/vec33.js\";\nimport { f as U, c as V } from \"../../../chunks/vec43.js\";\nimport { n as _, f as z } from \"../../../chunks/vec22.js\";\n\nasync function G(t, e, r) {\n  const o = new I(K(r)),\n        s = (await R(o, e, r, !0)).model,\n        a = s.lods.shift(),\n        i = new Map(),\n        u = new Map();\n  s.textures.forEach((t, e) => i.set(e, Q(t))), s.materials.forEach((t, e) => u.set(e, H(t, i)));\n  const l = P(a);\n\n  for (const n of a.parts) J(l, n, u);\n\n  const {\n    position: c,\n    normal: f,\n    tangent: p,\n    color: d,\n    texCoord0: g\n  } = l.vertexAttributes,\n        x = {\n    position: c.typedBuffer,\n    normal: n(f) ? f.typedBuffer : null,\n    tangent: n(p) ? p.typedBuffer : null,\n    uv: n(g) ? g.typedBuffer : null,\n    color: n(d) ? d.typedBuffer : null\n  },\n        b = F(x, t, r);\n  return {\n    transform: b.transform,\n    components: l.components,\n    spatialReference: t.spatialReference,\n    vertexAttributes: new m({\n      position: b.vertexAttributes.position,\n      normal: b.vertexAttributes.normal,\n      tangent: b.vertexAttributes.tangent,\n      color: x.color,\n      uv: x.uv\n    })\n  };\n}\n\nfunction K(t) {\n  return null != t && t.resolveFile ? {\n    busy: !1,\n    request: async (r, o, s) => {\n      const a = t.resolveFile(r),\n            i = \"image\" === o ? \"image\" : \"binary\" === o ? \"array-buffer\" : \"json\";\n      return (await e(a, {\n        responseType: i,\n        signal: n(s) ? s.signal : null\n      })).data;\n    }\n  } : null;\n}\n\nfunction P(t) {\n  let e = 0;\n  const r = {\n    color: !1,\n    tangent: !1,\n    normal: !1,\n    texCoord0: !1\n  };\n\n  for (const {\n    attributes: {\n      position: o,\n      normal: n,\n      color: s,\n      tangent: a,\n      texCoord0: i\n    }\n  } of t.parts) e += o.count, n && (r.normal = !0), s && (r.color = !0), a && (r.tangent = !0), i && (r.texCoord0 = !0);\n\n  return {\n    writeIndex: 0,\n    vertexAttributes: {\n      position: B(p, e),\n      normal: r.normal ? B(d, e) : null,\n      tangent: r.tangent ? B(g, e) : null,\n      color: r.color ? B(x, e) : null,\n      texCoord0: r.texCoord0 ? B(b, e) : null\n    },\n    components: []\n  };\n}\n\nfunction Q(t) {\n  return new f({\n    data: t.data,\n    wrap: Y(t.parameters.wrap)\n  });\n}\n\nfunction H(e, n) {\n  const s = new t(tt(e.color, e.opacity)),\n        a = e.emissiveFactor ? new t(et(e.emissiveFactor)) : null;\n  return new c({\n    color: s,\n    colorTexture: r(o(e.textureColor, t => n.get(t))),\n    normalTexture: r(o(e.textureNormal, t => n.get(t))),\n    emissiveColor: a,\n    emissiveTexture: r(o(e.textureEmissive, t => n.get(t))),\n    occlusionTexture: r(o(e.textureOcclusion, t => n.get(t))),\n    alphaMode: X(e.alphaMode),\n    alphaCutoff: e.alphaCutoff,\n    doubleSided: e.doubleSided,\n    metallic: e.metallicFactor,\n    roughness: e.roughnessFactor,\n    metallicRoughnessTexture: r(o(e.textureMetallicRoughness, t => n.get(t)))\n  });\n}\n\nfunction J(t, e, r) {\n  const {\n    position: o,\n    normal: i,\n    tangent: u,\n    color: c,\n    texCoord0: f\n  } = t.vertexAttributes,\n        m = t.writeIndex,\n        p = e.attributes.position.count;\n\n  if (j(o.slice(m, p), e.attributes.position, e.transform), n(e.attributes.normal) && n(i)) {\n    const t = s(a(), e.transform);\n    y(i.slice(m, p), e.attributes.normal, t);\n  } else n(i) && L(i, 0, 0, 1, {\n    dstIndex: m,\n    count: p\n  });\n\n  if (n(e.attributes.tangent) && n(u)) {\n    const t = s(a(), e.transform);\n    A(u.slice(m, p), e.attributes.tangent, t);\n  } else n(u) && U(u, 0, 0, 1, 1, {\n    dstIndex: m,\n    count: p\n  });\n\n  if (n(e.attributes.texCoord0) && n(f) ? _(f.slice(m, p), e.attributes.texCoord0) : n(f) && z(f, 0, 0, {\n    dstIndex: m,\n    count: p\n  }), n(e.attributes.color) && n(c)) {\n    const t = e.attributes.color,\n          r = c.slice(m, p);\n    if (4 === t.elementCount) t instanceof g ? T(r, t, 255) : t instanceof x ? V(r, t) : t instanceof h && k(r, t, 8);else {\n      U(r, 255, 255, 255, 255);\n      const e = v.fromTypedArray(r.typedBuffer, r.typedBufferStride);\n      t instanceof d ? C(e, t, 255) : t instanceof v ? N(e, t) : t instanceof w && M(e, t, 8);\n    }\n  } else n(c) && U(c.slice(m, p), 255, 255, 255, 255);\n\n  const b = W(e.indices || p, e.primitiveType);\n  if (m) for (let n = 0; n < b.length; n++) b[n] += m;\n  t.components.push(new l({\n    faces: b,\n    material: r.get(e.material).clone(),\n    trustSourceNormals: !0\n  })), t.writeIndex += p;\n}\n\nfunction W(t, e) {\n  switch (e) {\n    case 4:\n      return D(t, O);\n\n    case 5:\n      return S(t);\n\n    case 6:\n      return E(t);\n  }\n}\n\nfunction X(t) {\n  switch (t) {\n    case \"OPAQUE\":\n      return \"opaque\";\n\n    case \"MASK\":\n      return \"mask\";\n\n    case \"BLEND\":\n      return \"blend\";\n  }\n}\n\nfunction Y(t) {\n  return {\n    horizontal: Z(t.s),\n    vertical: Z(t.t)\n  };\n}\n\nfunction Z(t) {\n  switch (t) {\n    case 33071:\n      return \"clamp\";\n\n    case 33648:\n      return \"mirror\";\n\n    case 10497:\n      return \"repeat\";\n  }\n}\n\nfunction $(t) {\n  return t ** (1 / q) * 255;\n}\n\nfunction tt(t, e) {\n  return u($(t[0]), $(t[1]), $(t[2]), e);\n}\n\nfunction et(t) {\n  return i($(t[0]), $(t[1]), $(t[2]));\n}\n\nexport { G as loadGLTFMesh };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/geometry/support/meshUtils/loadGLTFMesh.js"],"names":["t","e","unwrap","r","applySome","o","isSome","n","a","s","c","f","i","u","l","m","BufferViewVec3f64","p","BufferViewVec3f","d","BufferViewVec4f","g","BufferViewVec4u8","x","BufferViewVec2f","b","BufferViewVec4u16","h","BufferViewVec3u8","v","BufferViewVec3u16","w","j","y","C","M","A","T","k","createBuffer","B","georeferenceByTransform","F","DefaultLoadingContext","I","load","R","triangleFanToTriangles","E","triangleStripToTriangles","S","trianglesToTriangles","D","generateIndexArray","O","COLOR_GAMMA","q","L","N","U","V","_","z","G","K","model","lods","shift","Map","textures","forEach","set","Q","materials","H","P","parts","J","position","normal","tangent","color","texCoord0","vertexAttributes","typedBuffer","uv","transform","components","spatialReference","resolveFile","busy","request","responseType","signal","data","attributes","count","writeIndex","wrap","Y","parameters","tt","opacity","emissiveFactor","et","colorTexture","textureColor","get","normalTexture","textureNormal","emissiveColor","emissiveTexture","textureEmissive","occlusionTexture","textureOcclusion","alphaMode","X","alphaCutoff","doubleSided","metallic","metallicFactor","roughness","roughnessFactor","metallicRoughnessTexture","textureMetallicRoughness","slice","dstIndex","elementCount","fromTypedArray","typedBufferStride","W","indices","primitiveType","length","push","faces","material","clone","trustSourceNormals","horizontal","Z","vertical","$","loadGLTFMesh"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from\"../../../Color.js\";import e from\"../../../request.js\";import{unwrap as r,applySome as o,isSome as n}from\"../../../core/maybe.js\";import{a as s}from\"../../../chunks/mat3.js\";import{c as a}from\"../../../chunks/mat3f64.js\";import{f as i}from\"../../../chunks/vec3f64.js\";import{f as u}from\"../../../chunks/vec4f64.js\";import l from\"../MeshComponent.js\";import c from\"../MeshMaterialMetallicRoughness.js\";import f from\"../MeshTexture.js\";import m from\"../MeshVertexAttributes.js\";import{BufferViewVec3f64 as p,BufferViewVec3f as d,BufferViewVec4f as g,BufferViewVec4u8 as x,BufferViewVec2f as b,BufferViewVec4u16 as h,BufferViewVec3u8 as v,BufferViewVec3u16 as w}from\"../buffer/BufferView.js\";import{t as j,a as y,s as C,b as M}from\"../../../chunks/vec32.js\";import{t as A,s as T,a as k}from\"../../../chunks/vec42.js\";import{createBuffer as B}from\"../buffer/utils.js\";import{georeferenceByTransform as F}from\"./georeference.js\";import{DefaultLoadingContext as I}from\"../../../views/3d/glTF/DefaultLoadingContext.js\";import{load as R}from\"../../../views/3d/glTF/loader.js\";import{triangleFanToTriangles as E,triangleStripToTriangles as S,trianglesToTriangles as D}from\"../../../views/3d/glTF/internal/indexUtils.js\";import{generateIndexArray as O}from\"../../../views/3d/webgl-engine/lib/geometryDataUtils.js\";import{COLOR_GAMMA as q}from\"../../../views/3d/webgl-engine/materials/DefaultMaterial_COLOR_GAMMA.js\";import{f as L,c as N}from\"../../../chunks/vec33.js\";import{f as U,c as V}from\"../../../chunks/vec43.js\";import{n as _,f as z}from\"../../../chunks/vec22.js\";async function G(t,e,r){const o=new I(K(r)),s=(await R(o,e,r,!0)).model,a=s.lods.shift(),i=new Map,u=new Map;s.textures.forEach(((t,e)=>i.set(e,Q(t)))),s.materials.forEach(((t,e)=>u.set(e,H(t,i))));const l=P(a);for(const n of a.parts)J(l,n,u);const{position:c,normal:f,tangent:p,color:d,texCoord0:g}=l.vertexAttributes,x={position:c.typedBuffer,normal:n(f)?f.typedBuffer:null,tangent:n(p)?p.typedBuffer:null,uv:n(g)?g.typedBuffer:null,color:n(d)?d.typedBuffer:null},b=F(x,t,r);return{transform:b.transform,components:l.components,spatialReference:t.spatialReference,vertexAttributes:new m({position:b.vertexAttributes.position,normal:b.vertexAttributes.normal,tangent:b.vertexAttributes.tangent,color:x.color,uv:x.uv})}}function K(t){return null!=t&&t.resolveFile?{busy:!1,request:async(r,o,s)=>{const a=t.resolveFile(r),i=\"image\"===o?\"image\":\"binary\"===o?\"array-buffer\":\"json\";return(await e(a,{responseType:i,signal:n(s)?s.signal:null})).data}}:null}function P(t){let e=0;const r={color:!1,tangent:!1,normal:!1,texCoord0:!1};for(const{attributes:{position:o,normal:n,color:s,tangent:a,texCoord0:i}}of t.parts)e+=o.count,n&&(r.normal=!0),s&&(r.color=!0),a&&(r.tangent=!0),i&&(r.texCoord0=!0);return{writeIndex:0,vertexAttributes:{position:B(p,e),normal:r.normal?B(d,e):null,tangent:r.tangent?B(g,e):null,color:r.color?B(x,e):null,texCoord0:r.texCoord0?B(b,e):null},components:[]}}function Q(t){return new f({data:t.data,wrap:Y(t.parameters.wrap)})}function H(e,n){const s=new t(tt(e.color,e.opacity)),a=e.emissiveFactor?new t(et(e.emissiveFactor)):null;return new c({color:s,colorTexture:r(o(e.textureColor,(t=>n.get(t)))),normalTexture:r(o(e.textureNormal,(t=>n.get(t)))),emissiveColor:a,emissiveTexture:r(o(e.textureEmissive,(t=>n.get(t)))),occlusionTexture:r(o(e.textureOcclusion,(t=>n.get(t)))),alphaMode:X(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:r(o(e.textureMetallicRoughness,(t=>n.get(t))))})}function J(t,e,r){const{position:o,normal:i,tangent:u,color:c,texCoord0:f}=t.vertexAttributes,m=t.writeIndex,p=e.attributes.position.count;if(j(o.slice(m,p),e.attributes.position,e.transform),n(e.attributes.normal)&&n(i)){const t=s(a(),e.transform);y(i.slice(m,p),e.attributes.normal,t)}else n(i)&&L(i,0,0,1,{dstIndex:m,count:p});if(n(e.attributes.tangent)&&n(u)){const t=s(a(),e.transform);A(u.slice(m,p),e.attributes.tangent,t)}else n(u)&&U(u,0,0,1,1,{dstIndex:m,count:p});if(n(e.attributes.texCoord0)&&n(f)?_(f.slice(m,p),e.attributes.texCoord0):n(f)&&z(f,0,0,{dstIndex:m,count:p}),n(e.attributes.color)&&n(c)){const t=e.attributes.color,r=c.slice(m,p);if(4===t.elementCount)t instanceof g?T(r,t,255):t instanceof x?V(r,t):t instanceof h&&k(r,t,8);else{U(r,255,255,255,255);const e=v.fromTypedArray(r.typedBuffer,r.typedBufferStride);t instanceof d?C(e,t,255):t instanceof v?N(e,t):t instanceof w&&M(e,t,8)}}else n(c)&&U(c.slice(m,p),255,255,255,255);const b=W(e.indices||p,e.primitiveType);if(m)for(let n=0;n<b.length;n++)b[n]+=m;t.components.push(new l({faces:b,material:r.get(e.material).clone(),trustSourceNormals:!0})),t.writeIndex+=p}function W(t,e){switch(e){case 4:return D(t,O);case 5:return S(t);case 6:return E(t)}}function X(t){switch(t){case\"OPAQUE\":return\"opaque\";case\"MASK\":return\"mask\";case\"BLEND\":return\"blend\"}}function Y(t){return{horizontal:Z(t.s),vertical:Z(t.t)}}function Z(t){switch(t){case 33071:return\"clamp\";case 33648:return\"mirror\";case 10497:return\"repeat\"}}function $(t){return t**(1/q)*255}function tt(t,e){return u($(t[0]),$(t[1]),$(t[2]),e)}function et(t){return i($(t[0]),$(t[1]),$(t[2]))}export{G as loadGLTFMesh};\n"]},"metadata":{},"sourceType":"module"}