{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { acosClamped as e } from \"../../../../core/mathUtils.js\";\nimport t from \"../../../../core/ObjectPool.js\";\nimport { f as i, a as s, b as r, o as n, d as o } from \"../../../../chunks/vec3.js\";\nimport { c as a } from \"../../../../chunks/vec3f64.js\";\nimport { getReferenceEllipsoid as u } from \"../../../../geometry/projectionEllipsoid.js\";\nimport { projectVector as l, fromPoints as d, normal as c, create as h } from \"../../../../geometry/support/plane.js\";\nimport { wrap as m } from \"../../../../geometry/support/ray.js\";\nimport { FeatureTileDescriptor3D as p } from \"./FeatureTileDescriptor3D.js\";\nimport { Frustum as f } from \"../../state/Frustum.js\";\nimport { FrustumExtentIntersection as g } from \"../../support/FrustumExtentIntersection.js\";\n\nclass F {\n  constructor(e) {\n    this.renderCoordsHelper = e, this.surfaceElevation = 0, this.cache = new Map(), this.frustum = new f(e), this.extendedFrustum = new f(e), this.intersector = new g({\n      renderCoordsHelper: e\n    }), this.renderCoordsHelper = e;\n  }\n\n  begin(e, t) {\n    this.surfaceElevation = t, this.aboveGround = this.renderCoordsHelper.getAltitude(e.eye) > t, this.frustum.update(e), this.shortenFrustumFarPlane(this.frustum), this.updateExtendedFrustum(e);\n  }\n\n  end() {\n    this.cache.clear();\n  }\n\n  calculate(e) {\n    if (this.allTilesInvisible) return 0;\n    const t = 1 === this.renderCoordsHelper.viewingMode && e.lij[0] >= b && e.lij[0] < v,\n          i = this.getOrCalculateSingleTileVisibility(e, !t);\n    return 0 !== i && t ? this.calculateAggregatedChildrenVisibility(e) : i;\n  }\n\n  shortenFrustumFarPlane(e) {\n    const t = f.nearFarLineIndices,\n          n = e.mutablePoints;\n\n    for (const o of t) {\n      const [e, t] = o,\n            a = n[e],\n            u = n[t];\n      i(w, u, a), s(w, w, P), r(n[t], a, w);\n    }\n\n    e.updatePoints(n);\n  }\n\n  calculateAggregatedChildrenVisibility(e) {\n    let t = 0;\n    const i = this.cache.get(e.id);\n    if (null != i) return i;\n    const s = A.acquire();\n    e.getChildren(s);\n\n    for (const r of s) {\n      const e = this.calculate(r);\n      if (0 !== e && (t = e, 2 === e)) break;\n    }\n\n    return A.release(s), this.cache.set(e.id, t), t;\n  }\n\n  getOrCalculateSingleTileVisibility(e, t) {\n    const i = this.cache.get(e.id);\n    if (null != i) return i;\n    const s = this.calculateSingleTileVisibility(e);\n    return t && this.cache.set(e.id, s), s;\n  }\n\n  calculateSingleTileVisibility(e) {\n    if (!this.aboveGround && 1 === this.renderCoordsHelper.viewingMode && e.lij[0] < x) {\n      return 0 === this.calculateSingleTileVisibilitySided(e, !1) ? this.calculateSingleTileVisibilitySided(e, !0) : void 0;\n    }\n\n    return this.calculateSingleTileVisibilitySided(e, this.aboveGround);\n  }\n\n  calculateSingleTileVisibilitySided(e, t) {\n    this.intersector.update(e.extent, e.tilingScheme.spatialReference, this.surfaceElevation, t);\n    const i = u(e.tilingScheme.spatialReference).radius;\n    return this.intersector.isVisibleInFrustum(this.extendedFrustum, i) ? this.intersector.isVisibleInFrustum(this.frustum, i, !0) ? 2 : 1 : 0;\n  }\n\n  updateExtendedFrustum(t) {\n    this.extendedFrustum.update(t), this.shortenFrustumFarPlane(this.extendedFrustum);\n    const i = this.renderCoordsHelper.worldUpAtPosition(t.eye, w);\n    this.aboveGround || n(i, i);\n    const r = e(-o(i, t.viewForward));\n    if (this.allTilesInvisible = r > (Math.PI + t.fovY) / 2, this.allTilesInvisible) return;\n    if (this.hasExtendedFrustum = r > t.fovY / 2, !this.hasExtendedFrustum) return;\n    const a = this.extendedFrustumParameters(),\n          u = this.extendedFrustum.mutablePoints;\n\n    for (let e = 0; e < 4; e++) {\n      const t = a.pointIndices[e],\n            i = u[t],\n            r = this.renderCoordsHelper.getAltitude(i);\n\n      if (a.needsAltitudeAdjustment(r)) {\n        switch (this.renderCoordsHelper.worldUpAtPosition(i, w), t) {\n          case 4:\n          case 7:\n          case 0:\n          case 3:\n            l(this.extendedFrustum.planes[0], w, w);\n            break;\n\n          case 5:\n          case 6:\n          case 1:\n          case 2:\n            l(this.extendedFrustum.planes[1], w, w);\n        }\n\n        s(w, w, a.direction), this.renderCoordsHelper.intersectInfiniteManifold(m(i, w), a.zWithMargin, i);\n      }\n    }\n\n    if (this.extendedFrustum.updatePoints(u), d(u[0], u[1], u[2], S), d(u[1], u[2], u[3], y), o(c(S), c(y)) < 0) {\n      const e = this.extendedFrustum.mutablePoints;\n      this.aboveGround ? [e[0], e[1]] = [e[1], e[0]] : [e[3], e[2]] = [e[2], e[3]], this.extendedFrustum.updatePoints(e);\n    }\n  }\n\n  extendedFrustumParameters() {\n    return this.aboveGround ? this.extendedFrustumParametersAboveSurface() : this.extendedFrustumParametersBelowSurface();\n  }\n\n  extendedFrustumParametersAboveSurface() {\n    const e = this.surfaceElevation - j;\n    return {\n      zWithMargin: e,\n      pointIndices: f.planePointIndices.bottom,\n      direction: -1,\n      needsAltitudeAdjustment: t => t > e\n    };\n  }\n\n  extendedFrustumParametersBelowSurface() {\n    const e = this.surfaceElevation + j;\n    return {\n      zWithMargin: e,\n      pointIndices: f.planePointIndices.top,\n      direction: 1,\n      needsAltitudeAdjustment: t => t < e\n    };\n  }\n\n}\n\nconst b = 2,\n      v = 6,\n      x = 12,\n      P = .95,\n      j = 1,\n      w = a(),\n      S = h(),\n      y = h(),\n      A = new t(Array, e => {\n  4 !== e.length && (e[0] = new p(), e[1] = new p(), e[2] = new p(), e[3] = new p());\n}, e => {\n  e[0].release(), e[1].release(), e[2].release(), e[3].release();\n});\nexport { F as FeatureTileVisibility3D };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/layers/support/FeatureTileVisibility3D.js"],"names":["acosClamped","e","t","f","i","a","s","b","r","o","n","d","c","getReferenceEllipsoid","u","projectVector","l","fromPoints","normal","create","h","wrap","m","FeatureTileDescriptor3D","p","Frustum","FrustumExtentIntersection","g","F","constructor","renderCoordsHelper","surfaceElevation","cache","Map","frustum","extendedFrustum","intersector","begin","aboveGround","getAltitude","eye","update","shortenFrustumFarPlane","updateExtendedFrustum","end","clear","calculate","allTilesInvisible","viewingMode","lij","v","getOrCalculateSingleTileVisibility","calculateAggregatedChildrenVisibility","nearFarLineIndices","mutablePoints","w","P","updatePoints","get","id","A","acquire","getChildren","release","set","calculateSingleTileVisibility","x","calculateSingleTileVisibilitySided","extent","tilingScheme","spatialReference","radius","isVisibleInFrustum","worldUpAtPosition","viewForward","Math","PI","fovY","hasExtendedFrustum","extendedFrustumParameters","pointIndices","needsAltitudeAdjustment","planes","direction","intersectInfiniteManifold","zWithMargin","S","y","extendedFrustumParametersAboveSurface","extendedFrustumParametersBelowSurface","j","planePointIndices","bottom","top","Array","length","FeatureTileVisibility3D"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{acosClamped as e}from\"../../../../core/mathUtils.js\";import t from\"../../../../core/ObjectPool.js\";import{f as i,a as s,b as r,o as n,d as o}from\"../../../../chunks/vec3.js\";import{c as a}from\"../../../../chunks/vec3f64.js\";import{getReferenceEllipsoid as u}from\"../../../../geometry/projectionEllipsoid.js\";import{projectVector as l,fromPoints as d,normal as c,create as h}from\"../../../../geometry/support/plane.js\";import{wrap as m}from\"../../../../geometry/support/ray.js\";import{FeatureTileDescriptor3D as p}from\"./FeatureTileDescriptor3D.js\";import{Frustum as f}from\"../../state/Frustum.js\";import{FrustumExtentIntersection as g}from\"../../support/FrustumExtentIntersection.js\";class F{constructor(e){this.renderCoordsHelper=e,this.surfaceElevation=0,this.cache=new Map,this.frustum=new f(e),this.extendedFrustum=new f(e),this.intersector=new g({renderCoordsHelper:e}),this.renderCoordsHelper=e}begin(e,t){this.surfaceElevation=t,this.aboveGround=this.renderCoordsHelper.getAltitude(e.eye)>t,this.frustum.update(e),this.shortenFrustumFarPlane(this.frustum),this.updateExtendedFrustum(e)}end(){this.cache.clear()}calculate(e){if(this.allTilesInvisible)return 0;const t=1===this.renderCoordsHelper.viewingMode&&e.lij[0]>=b&&e.lij[0]<v,i=this.getOrCalculateSingleTileVisibility(e,!t);return 0!==i&&t?this.calculateAggregatedChildrenVisibility(e):i}shortenFrustumFarPlane(e){const t=f.nearFarLineIndices,n=e.mutablePoints;for(const o of t){const[e,t]=o,a=n[e],u=n[t];i(w,u,a),s(w,w,P),r(n[t],a,w)}e.updatePoints(n)}calculateAggregatedChildrenVisibility(e){let t=0;const i=this.cache.get(e.id);if(null!=i)return i;const s=A.acquire();e.getChildren(s);for(const r of s){const e=this.calculate(r);if(0!==e&&(t=e,2===e))break}return A.release(s),this.cache.set(e.id,t),t}getOrCalculateSingleTileVisibility(e,t){const i=this.cache.get(e.id);if(null!=i)return i;const s=this.calculateSingleTileVisibility(e);return t&&this.cache.set(e.id,s),s}calculateSingleTileVisibility(e){if(!this.aboveGround&&1===this.renderCoordsHelper.viewingMode&&e.lij[0]<x){return 0===this.calculateSingleTileVisibilitySided(e,!1)?this.calculateSingleTileVisibilitySided(e,!0):void 0}return this.calculateSingleTileVisibilitySided(e,this.aboveGround)}calculateSingleTileVisibilitySided(e,t){this.intersector.update(e.extent,e.tilingScheme.spatialReference,this.surfaceElevation,t);const i=u(e.tilingScheme.spatialReference).radius;return this.intersector.isVisibleInFrustum(this.extendedFrustum,i)?this.intersector.isVisibleInFrustum(this.frustum,i,!0)?2:1:0}updateExtendedFrustum(t){this.extendedFrustum.update(t),this.shortenFrustumFarPlane(this.extendedFrustum);const i=this.renderCoordsHelper.worldUpAtPosition(t.eye,w);this.aboveGround||n(i,i);const r=e(-o(i,t.viewForward));if(this.allTilesInvisible=r>(Math.PI+t.fovY)/2,this.allTilesInvisible)return;if(this.hasExtendedFrustum=r>t.fovY/2,!this.hasExtendedFrustum)return;const a=this.extendedFrustumParameters(),u=this.extendedFrustum.mutablePoints;for(let e=0;e<4;e++){const t=a.pointIndices[e],i=u[t],r=this.renderCoordsHelper.getAltitude(i);if(a.needsAltitudeAdjustment(r)){switch(this.renderCoordsHelper.worldUpAtPosition(i,w),t){case 4:case 7:case 0:case 3:l(this.extendedFrustum.planes[0],w,w);break;case 5:case 6:case 1:case 2:l(this.extendedFrustum.planes[1],w,w)}s(w,w,a.direction),this.renderCoordsHelper.intersectInfiniteManifold(m(i,w),a.zWithMargin,i)}}if(this.extendedFrustum.updatePoints(u),d(u[0],u[1],u[2],S),d(u[1],u[2],u[3],y),o(c(S),c(y))<0){const e=this.extendedFrustum.mutablePoints;this.aboveGround?[e[0],e[1]]=[e[1],e[0]]:[e[3],e[2]]=[e[2],e[3]],this.extendedFrustum.updatePoints(e)}}extendedFrustumParameters(){return this.aboveGround?this.extendedFrustumParametersAboveSurface():this.extendedFrustumParametersBelowSurface()}extendedFrustumParametersAboveSurface(){const e=this.surfaceElevation-j;return{zWithMargin:e,pointIndices:f.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}}extendedFrustumParametersBelowSurface(){const e=this.surfaceElevation+j;return{zWithMargin:e,pointIndices:f.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}}}const b=2,v=6,x=12,P=.95,j=1,w=a(),S=h(),y=h(),A=new t(Array,(e=>{4!==e.length&&(e[0]=new p,e[1]=new p,e[2]=new p,e[3]=new p)}),(e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release()}));export{F as FeatureTileVisibility3D};\n"]},"metadata":{},"sourceType":"module"}