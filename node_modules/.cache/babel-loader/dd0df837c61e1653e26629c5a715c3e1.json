{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../../core/Error.js\";\nimport { getJsonType as t, isPoint as i } from \"../../../../geometry/support/jsonUtils.js\";\nimport { WGS84 as s } from \"../../../../geometry/support/spatialReferenceUtils.js\";\nimport { convertFromFeatures as r, convertToFeature as n, convertFromFeature as a } from \"../../featureConversionUtils.js\";\nimport { initialObjectId as l, findLastObjectIdFromFeatures as o } from \"../../objectIdUtils.js\";\nimport d from \"../../data/FeatureStore.js\";\nimport { checkProjectionSupport as u, project as p } from \"../../data/projectionSupport.js\";\nimport f from \"../../data/QueryEngine.js\";\nimport { createDefaultAttributesFunction as y, createDrawingInfo as c, createDefaultTemplate as m } from \"./clientSideDefaults.js\";\nimport { loadGeometryEngineForSimplify as h, createFeatureEditErrorResult as g, mixAttributes as I, createFeatureEditSuccessResult as b, simplify as F } from \"./sourceUtils.js\";\nimport _ from \"../../../support/FieldsIndex.js\";\nimport { kebabDict as j } from \"../../../support/fieldType.js\";\nimport { getFieldDefaultValue as E } from \"../../../support/fieldUtils.js\";\nconst x = s,\n      T = {\n  xmin: -180,\n  ymin: -90,\n  xmax: 180,\n  ymax: 90,\n  spatialReference: s\n},\n      q = {\n  hasAttachments: !1,\n  capabilities: \"query, editing, create, delete, update\",\n  useStandardizedQueries: !0,\n  supportsCoordinatesQuantization: !0,\n  supportsReturningQueryGeometry: !0,\n  advancedQueryCapabilities: {\n    supportsQueryAttachments: !1,\n    supportsStatistics: !0,\n    supportsPercentileStatistics: !0,\n    supportsReturningGeometryCentroid: !0,\n    supportsQueryWithDistance: !0,\n    supportsDistinct: !0,\n    supportsReturningQueryExtent: !0,\n    supportsReturningGeometryProperties: !1,\n    supportsHavingClause: !0,\n    supportsOrderBy: !0,\n    supportsPagination: !0,\n    supportsQueryWithResultType: !1,\n    supportsSqlExpression: !0,\n    supportsDisjointSpatialRel: !0\n  }\n};\n\nfunction R(e) {\n  return i(e) ? null != e.z : !!e.hasZ;\n}\n\nfunction D(e) {\n  return i(e) ? null != e.m : !!e.hasM;\n}\n\nclass O {\n  constructor() {\n    this._queryEngine = null, this._nextObjectId = null;\n  }\n\n  destroy() {\n    this._queryEngine && this._queryEngine && this._queryEngine.destroy(), this._queryEngine = this._requiredFields = this._fieldsIndex = this._createDefaultAttributes = null;\n  }\n\n  async load(t) {\n    const i = [],\n          {\n      features: s\n    } = t,\n          r = this._inferLayerProperties(s, t.fields),\n          n = t.fields || [],\n          a = null != t.hasM ? t.hasM : r.hasM,\n          p = null != t.hasZ ? t.hasZ : r.hasZ,\n          h = !t.spatialReference && !r.spatialReference,\n          g = h ? x : t.spatialReference || r.spatialReference,\n          I = h ? T : null,\n          b = t.geometryType || r.geometryType,\n          F = !b;\n\n    let R = t.objectIdField || r.objectIdField,\n        D = t.timeInfo;\n    if (!F && (h && i.push({\n      name: \"feature-layer:spatial-reference-not-found\",\n      message: \"Spatial reference not provided or found in features. Defaults to WGS84\"\n    }), !b)) throw new e(\"feature-layer:missing-property\", \"geometryType not set and couldn't be inferred from the provided features\");\n    if (!R) throw new e(\"feature-layer:missing-property\", \"objectIdField not set and couldn't be found in the provided fields\");\n\n    if (r.objectIdField && R !== r.objectIdField && (i.push({\n      name: \"feature-layer:duplicated-oid-field\",\n      message: `Provided objectIdField \"${R}\" doesn't match the field name \"${r.objectIdField}\", found in the provided fields`\n    }), R = r.objectIdField), R && !r.objectIdField) {\n      let e = null;\n      n.some(t => t.name === R && (e = t, !0)) ? (e.type = \"esriFieldTypeOID\", e.editable = !1, e.nullable = !1) : n.unshift({\n        alias: R,\n        name: R,\n        type: \"esriFieldTypeOID\",\n        editable: !1,\n        nullable: !1\n      });\n    }\n\n    for (const l of n) {\n      if (null == l.name && (l.name = l.alias), null == l.alias && (l.alias = l.name), !l.name) throw new e(\"feature-layer:invalid-field-name\", \"field name is missing\", {\n        field: l\n      });\n      if (l.name === R && (l.type = \"esriFieldTypeOID\"), -1 === j.jsonValues.indexOf(l.type)) throw new e(\"feature-layer:invalid-field-type\", `invalid type for field \"${l.name}\"`, {\n        field: l\n      });\n    }\n\n    const O = {};\n    this._requiredFields = [];\n\n    for (const e of n) if (\"esriFieldTypeOID\" !== e.type && \"esriFieldTypeGlobalID\" !== e.type) {\n      e.editable = null == e.editable || !!e.editable, e.nullable = null == e.nullable || !!e.nullable;\n      const t = E(e);\n      e.nullable || void 0 !== t ? O[e.name] = t : this._requiredFields.push(e);\n    }\n\n    if (this._fieldsIndex = new _(n), this._createDefaultAttributes = y(O, R), D) {\n      if (D.startTimeField) {\n        const e = this._fieldsIndex.get(D.startTimeField);\n\n        e ? (D.startTimeField = e.name, e.type = \"esriFieldTypeDate\") : D.startTimeField = null;\n      }\n\n      if (D.endTimeField) {\n        const e = this._fieldsIndex.get(D.endTimeField);\n\n        e ? (D.endTimeField = e.name, e.type = \"esriFieldTypeDate\") : D.endTimeField = null;\n      }\n\n      if (D.trackIdField) {\n        const e = this._fieldsIndex.get(D.trackIdField);\n\n        e ? D.trackIdField = e.name : (D.trackIdField = null, i.push({\n          name: \"feature-layer:invalid-timeInfo-trackIdField\",\n          message: \"trackIdField is missing\",\n          details: {\n            timeInfo: D\n          }\n        }));\n      }\n\n      D.startTimeField || D.endTimeField || (i.push({\n        name: \"feature-layer:invalid-timeInfo\",\n        message: \"startTimeField and endTimeField are missing or invalid\",\n        details: {\n          timeInfo: D\n        }\n      }), D = null);\n    }\n\n    const w = {\n      warnings: i,\n      featureErrors: [],\n      layerDefinition: { ...q,\n        drawingInfo: c(b),\n        templates: m(O),\n        extent: I,\n        geometryType: b,\n        objectIdField: R,\n        fields: n,\n        hasZ: !!p,\n        hasM: !!a,\n        timeInfo: D\n      },\n      assignedObjectIds: {}\n    };\n    if (this._queryEngine = new f({\n      fields: n,\n      geometryType: b,\n      hasM: a,\n      hasZ: p,\n      objectIdField: R,\n      spatialReference: g,\n      featureStore: new d({\n        geometryType: b,\n        hasM: a,\n        hasZ: p\n      }),\n      timeInfo: D,\n      cacheSpatialQueries: !0\n    }), !s || !s.length) return this._nextObjectId = l, w;\n    const S = o(R, s);\n    return this._nextObjectId = S + 1, await u(s, g), this._loadInitialFeatures(w, s);\n  }\n\n  async applyEdits(e) {\n    const {\n      spatialReference: t,\n      geometryType: i\n    } = this._queryEngine;\n    return await Promise.all([h(t, i), u(e.adds, t), u(e.updates, t)]), this._applyEdits(e);\n  }\n\n  queryFeatures(e, t = {}) {\n    return this._queryEngine.executeQuery(e, t.signal);\n  }\n\n  queryFeatureCount(e, t = {}) {\n    return this._queryEngine.executeQueryForCount(e, t.signal);\n  }\n\n  queryObjectIds(e, t = {}) {\n    return this._queryEngine.executeQueryForIds(e, t.signal);\n  }\n\n  queryExtent(e, t = {}) {\n    return this._queryEngine.executeQueryForExtent(e, t.signal);\n  }\n\n  querySnapping(e, t = {}) {\n    return this._queryEngine.executeQueryForSnapping(e, t.signal);\n  }\n\n  _inferLayerProperties(e, i) {\n    let s,\n        r,\n        n = null,\n        a = null,\n        l = null;\n\n    for (const o of e) {\n      const e = o.geometry;\n      if (e && (n || (n = t(e)), a || (a = e.spatialReference), null == s && (s = R(e)), null == r && (r = D(e)), n && a && null != s && null != r)) break;\n    }\n\n    if (i && i.length) {\n      let e = null;\n      i.some(t => {\n        const i = \"esriFieldTypeOID\" === t.type,\n              s = !t.type && t.name && \"objectid\" === t.name.toLowerCase();\n        return e = t, i || s;\n      }) && (l = e.name);\n    }\n\n    return {\n      geometryType: n,\n      spatialReference: a,\n      objectIdField: l,\n      hasM: r,\n      hasZ: s\n    };\n  }\n\n  _loadInitialFeatures(e, i) {\n    const {\n      geometryType: s,\n      hasM: n,\n      hasZ: a,\n      objectIdField: l,\n      spatialReference: o,\n      featureStore: d\n    } = this._queryEngine,\n          u = [];\n\n    for (const r of i) {\n      if (null != r.uid && (e.assignedObjectIds[r.uid] = -1), r.geometry && s !== t(r.geometry)) {\n        e.featureErrors.push(g(\"Incorrect geometry type.\"));\n        continue;\n      }\n\n      const i = this._createDefaultAttributes(),\n            n = I(this._fieldsIndex, i, r.attributes, this._requiredFields, !0, e.warnings);\n\n      n ? e.featureErrors.push(n) : (this._assignObjectId(i, r.attributes, !0), r.attributes = i, null != r.uid && (e.assignedObjectIds[r.uid] = r.attributes[l]), r.geometry && (r.geometry = p(r.geometry, r.geometry.spatialReference, o)), u.push(r));\n    }\n\n    if (d.addMany(r([], u, s, a, n, l)), e.layerDefinition.extent = this._queryEngine.fullExtent, e.layerDefinition.timeInfo) {\n      const {\n        start: t,\n        end: i\n      } = this._queryEngine.timeExtent;\n      e.layerDefinition.timeInfo.timeExtent = [t, i];\n    }\n\n    return e;\n  }\n\n  _applyEdits(e) {\n    const {\n      adds: t,\n      updates: i,\n      deletes: s\n    } = e,\n          r = {\n      addResults: [],\n      deleteResults: [],\n      updateResults: [],\n      uidToObjectId: {}\n    };\n\n    if (t && t.length && this._applyAddEdits(r, t), i && i.length && this._applyUpdateEdits(r, i), s && s.length) {\n      for (const e of s) r.deleteResults.push(b(e));\n\n      this._queryEngine.featureStore.removeManyById(s);\n    }\n\n    return {\n      fullExtent: this._queryEngine.fullExtent,\n      featureEditResults: r\n    };\n  }\n\n  _applyAddEdits(e, i) {\n    const {\n      addResults: s\n    } = e,\n          {\n      geometryType: n,\n      hasM: a,\n      hasZ: l,\n      objectIdField: o,\n      spatialReference: d,\n      featureStore: u\n    } = this._queryEngine,\n          f = [];\n\n    for (const r of i) {\n      if (r.geometry && n !== t(r.geometry)) {\n        s.push(g(\"Incorrect geometry type.\"));\n        continue;\n      }\n\n      const i = this._createDefaultAttributes(),\n            a = I(this._fieldsIndex, i, r.attributes, this._requiredFields);\n\n      if (a) s.push(a);else {\n        if (this._assignObjectId(i, r.attributes), r.attributes = i, null != r.uid) {\n          const t = r.attributes[o];\n          e.uidToObjectId[r.uid] = t;\n        }\n\n        r.geometry && (r.geometry = p(F(r.geometry, d), r.geometry.spatialReference, d)), f.push(r), s.push(b(r.attributes[o]));\n      }\n    }\n\n    u.addMany(r([], f, n, l, a, o));\n  }\n\n  _applyUpdateEdits({\n    updateResults: e\n  }, i) {\n    const {\n      geometryType: s,\n      hasM: r,\n      hasZ: l,\n      objectIdField: o,\n      spatialReference: d,\n      featureStore: u\n    } = this._queryEngine;\n\n    for (const f of i) {\n      const {\n        attributes: i,\n        geometry: y\n      } = f,\n            c = i && i[o];\n\n      if (null == c) {\n        e.push(g(`Identifier field ${o} missing`));\n        continue;\n      }\n\n      if (!u.has(c)) {\n        e.push(g(`Feature with object id ${c} missing`));\n        continue;\n      }\n\n      const m = n(u.getFeature(c), s, l, r);\n\n      if (y) {\n        if (s !== t(y)) {\n          e.push(g(\"Incorrect geometry type.\"));\n          continue;\n        }\n\n        m.geometry = p(F(y, d), y.spatialReference, d);\n      }\n\n      if (i) {\n        const t = I(this._fieldsIndex, m.attributes, i, this._requiredFields);\n\n        if (t) {\n          e.push(t);\n          continue;\n        }\n      }\n\n      u.add(a(m, s, l, r, o)), e.push(b(c));\n    }\n  }\n\n  _assignObjectId(e, t, i = !1) {\n    const s = this._queryEngine.objectIdField;\n    i && t && isFinite(t[s]) ? e[s] = t[s] : e[s] = this._nextObjectId++;\n  }\n\n}\n\nexport default O;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/layers/graphics/sources/support/MemorySourceWorker.js"],"names":["e","getJsonType","t","isPoint","i","WGS84","s","convertFromFeatures","r","convertToFeature","n","convertFromFeature","a","initialObjectId","l","findLastObjectIdFromFeatures","o","d","checkProjectionSupport","u","project","p","f","createDefaultAttributesFunction","y","createDrawingInfo","c","createDefaultTemplate","m","loadGeometryEngineForSimplify","h","createFeatureEditErrorResult","g","mixAttributes","I","createFeatureEditSuccessResult","b","simplify","F","_","kebabDict","j","getFieldDefaultValue","E","x","T","xmin","ymin","xmax","ymax","spatialReference","q","hasAttachments","capabilities","useStandardizedQueries","supportsCoordinatesQuantization","supportsReturningQueryGeometry","advancedQueryCapabilities","supportsQueryAttachments","supportsStatistics","supportsPercentileStatistics","supportsReturningGeometryCentroid","supportsQueryWithDistance","supportsDistinct","supportsReturningQueryExtent","supportsReturningGeometryProperties","supportsHavingClause","supportsOrderBy","supportsPagination","supportsQueryWithResultType","supportsSqlExpression","supportsDisjointSpatialRel","R","z","hasZ","D","hasM","O","constructor","_queryEngine","_nextObjectId","destroy","_requiredFields","_fieldsIndex","_createDefaultAttributes","load","features","_inferLayerProperties","fields","geometryType","objectIdField","timeInfo","push","name","message","some","type","editable","nullable","unshift","alias","field","jsonValues","indexOf","startTimeField","get","endTimeField","trackIdField","details","w","warnings","featureErrors","layerDefinition","drawingInfo","templates","extent","assignedObjectIds","featureStore","cacheSpatialQueries","length","S","_loadInitialFeatures","applyEdits","Promise","all","adds","updates","_applyEdits","queryFeatures","executeQuery","signal","queryFeatureCount","executeQueryForCount","queryObjectIds","executeQueryForIds","queryExtent","executeQueryForExtent","querySnapping","executeQueryForSnapping","geometry","toLowerCase","uid","attributes","_assignObjectId","addMany","fullExtent","start","end","timeExtent","deletes","addResults","deleteResults","updateResults","uidToObjectId","_applyAddEdits","_applyUpdateEdits","removeManyById","featureEditResults","has","getFeature","add","isFinite"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../../core/Error.js\";import{getJsonType as t,isPoint as i}from\"../../../../geometry/support/jsonUtils.js\";import{WGS84 as s}from\"../../../../geometry/support/spatialReferenceUtils.js\";import{convertFromFeatures as r,convertToFeature as n,convertFromFeature as a}from\"../../featureConversionUtils.js\";import{initialObjectId as l,findLastObjectIdFromFeatures as o}from\"../../objectIdUtils.js\";import d from\"../../data/FeatureStore.js\";import{checkProjectionSupport as u,project as p}from\"../../data/projectionSupport.js\";import f from\"../../data/QueryEngine.js\";import{createDefaultAttributesFunction as y,createDrawingInfo as c,createDefaultTemplate as m}from\"./clientSideDefaults.js\";import{loadGeometryEngineForSimplify as h,createFeatureEditErrorResult as g,mixAttributes as I,createFeatureEditSuccessResult as b,simplify as F}from\"./sourceUtils.js\";import _ from\"../../../support/FieldsIndex.js\";import{kebabDict as j}from\"../../../support/fieldType.js\";import{getFieldDefaultValue as E}from\"../../../support/fieldUtils.js\";const x=s,T={xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:s},q={hasAttachments:!1,capabilities:\"query, editing, create, delete, update\",useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsStatistics:!0,supportsPercentileStatistics:!0,supportsReturningGeometryCentroid:!0,supportsQueryWithDistance:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQueryWithResultType:!1,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0}};function R(e){return i(e)?null!=e.z:!!e.hasZ}function D(e){return i(e)?null!=e.m:!!e.hasM}class O{constructor(){this._queryEngine=null,this._nextObjectId=null}destroy(){this._queryEngine&&this._queryEngine&&this._queryEngine.destroy(),this._queryEngine=this._requiredFields=this._fieldsIndex=this._createDefaultAttributes=null}async load(t){const i=[],{features:s}=t,r=this._inferLayerProperties(s,t.fields),n=t.fields||[],a=null!=t.hasM?t.hasM:r.hasM,p=null!=t.hasZ?t.hasZ:r.hasZ,h=!t.spatialReference&&!r.spatialReference,g=h?x:t.spatialReference||r.spatialReference,I=h?T:null,b=t.geometryType||r.geometryType,F=!b;let R=t.objectIdField||r.objectIdField,D=t.timeInfo;if(!F&&(h&&i.push({name:\"feature-layer:spatial-reference-not-found\",message:\"Spatial reference not provided or found in features. Defaults to WGS84\"}),!b))throw new e(\"feature-layer:missing-property\",\"geometryType not set and couldn't be inferred from the provided features\");if(!R)throw new e(\"feature-layer:missing-property\",\"objectIdField not set and couldn't be found in the provided fields\");if(r.objectIdField&&R!==r.objectIdField&&(i.push({name:\"feature-layer:duplicated-oid-field\",message:`Provided objectIdField \"${R}\" doesn't match the field name \"${r.objectIdField}\", found in the provided fields`}),R=r.objectIdField),R&&!r.objectIdField){let e=null;n.some((t=>t.name===R&&(e=t,!0)))?(e.type=\"esriFieldTypeOID\",e.editable=!1,e.nullable=!1):n.unshift({alias:R,name:R,type:\"esriFieldTypeOID\",editable:!1,nullable:!1})}for(const l of n){if(null==l.name&&(l.name=l.alias),null==l.alias&&(l.alias=l.name),!l.name)throw new e(\"feature-layer:invalid-field-name\",\"field name is missing\",{field:l});if(l.name===R&&(l.type=\"esriFieldTypeOID\"),-1===j.jsonValues.indexOf(l.type))throw new e(\"feature-layer:invalid-field-type\",`invalid type for field \"${l.name}\"`,{field:l})}const O={};this._requiredFields=[];for(const e of n)if(\"esriFieldTypeOID\"!==e.type&&\"esriFieldTypeGlobalID\"!==e.type){e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable;const t=E(e);e.nullable||void 0!==t?O[e.name]=t:this._requiredFields.push(e)}if(this._fieldsIndex=new _(n),this._createDefaultAttributes=y(O,R),D){if(D.startTimeField){const e=this._fieldsIndex.get(D.startTimeField);e?(D.startTimeField=e.name,e.type=\"esriFieldTypeDate\"):D.startTimeField=null}if(D.endTimeField){const e=this._fieldsIndex.get(D.endTimeField);e?(D.endTimeField=e.name,e.type=\"esriFieldTypeDate\"):D.endTimeField=null}if(D.trackIdField){const e=this._fieldsIndex.get(D.trackIdField);e?D.trackIdField=e.name:(D.trackIdField=null,i.push({name:\"feature-layer:invalid-timeInfo-trackIdField\",message:\"trackIdField is missing\",details:{timeInfo:D}}))}D.startTimeField||D.endTimeField||(i.push({name:\"feature-layer:invalid-timeInfo\",message:\"startTimeField and endTimeField are missing or invalid\",details:{timeInfo:D}}),D=null)}const w={warnings:i,featureErrors:[],layerDefinition:{...q,drawingInfo:c(b),templates:m(O),extent:I,geometryType:b,objectIdField:R,fields:n,hasZ:!!p,hasM:!!a,timeInfo:D},assignedObjectIds:{}};if(this._queryEngine=new f({fields:n,geometryType:b,hasM:a,hasZ:p,objectIdField:R,spatialReference:g,featureStore:new d({geometryType:b,hasM:a,hasZ:p}),timeInfo:D,cacheSpatialQueries:!0}),!s||!s.length)return this._nextObjectId=l,w;const S=o(R,s);return this._nextObjectId=S+1,await u(s,g),this._loadInitialFeatures(w,s)}async applyEdits(e){const{spatialReference:t,geometryType:i}=this._queryEngine;return await Promise.all([h(t,i),u(e.adds,t),u(e.updates,t)]),this._applyEdits(e)}queryFeatures(e,t={}){return this._queryEngine.executeQuery(e,t.signal)}queryFeatureCount(e,t={}){return this._queryEngine.executeQueryForCount(e,t.signal)}queryObjectIds(e,t={}){return this._queryEngine.executeQueryForIds(e,t.signal)}queryExtent(e,t={}){return this._queryEngine.executeQueryForExtent(e,t.signal)}querySnapping(e,t={}){return this._queryEngine.executeQueryForSnapping(e,t.signal)}_inferLayerProperties(e,i){let s,r,n=null,a=null,l=null;for(const o of e){const e=o.geometry;if(e&&(n||(n=t(e)),a||(a=e.spatialReference),null==s&&(s=R(e)),null==r&&(r=D(e)),n&&a&&null!=s&&null!=r))break}if(i&&i.length){let e=null;i.some((t=>{const i=\"esriFieldTypeOID\"===t.type,s=!t.type&&t.name&&\"objectid\"===t.name.toLowerCase();return e=t,i||s}))&&(l=e.name)}return{geometryType:n,spatialReference:a,objectIdField:l,hasM:r,hasZ:s}}_loadInitialFeatures(e,i){const{geometryType:s,hasM:n,hasZ:a,objectIdField:l,spatialReference:o,featureStore:d}=this._queryEngine,u=[];for(const r of i){if(null!=r.uid&&(e.assignedObjectIds[r.uid]=-1),r.geometry&&s!==t(r.geometry)){e.featureErrors.push(g(\"Incorrect geometry type.\"));continue}const i=this._createDefaultAttributes(),n=I(this._fieldsIndex,i,r.attributes,this._requiredFields,!0,e.warnings);n?e.featureErrors.push(n):(this._assignObjectId(i,r.attributes,!0),r.attributes=i,null!=r.uid&&(e.assignedObjectIds[r.uid]=r.attributes[l]),r.geometry&&(r.geometry=p(r.geometry,r.geometry.spatialReference,o)),u.push(r))}if(d.addMany(r([],u,s,a,n,l)),e.layerDefinition.extent=this._queryEngine.fullExtent,e.layerDefinition.timeInfo){const{start:t,end:i}=this._queryEngine.timeExtent;e.layerDefinition.timeInfo.timeExtent=[t,i]}return e}_applyEdits(e){const{adds:t,updates:i,deletes:s}=e,r={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t&&t.length&&this._applyAddEdits(r,t),i&&i.length&&this._applyUpdateEdits(r,i),s&&s.length){for(const e of s)r.deleteResults.push(b(e));this._queryEngine.featureStore.removeManyById(s)}return{fullExtent:this._queryEngine.fullExtent,featureEditResults:r}}_applyAddEdits(e,i){const{addResults:s}=e,{geometryType:n,hasM:a,hasZ:l,objectIdField:o,spatialReference:d,featureStore:u}=this._queryEngine,f=[];for(const r of i){if(r.geometry&&n!==t(r.geometry)){s.push(g(\"Incorrect geometry type.\"));continue}const i=this._createDefaultAttributes(),a=I(this._fieldsIndex,i,r.attributes,this._requiredFields);if(a)s.push(a);else{if(this._assignObjectId(i,r.attributes),r.attributes=i,null!=r.uid){const t=r.attributes[o];e.uidToObjectId[r.uid]=t}r.geometry&&(r.geometry=p(F(r.geometry,d),r.geometry.spatialReference,d)),f.push(r),s.push(b(r.attributes[o]))}}u.addMany(r([],f,n,l,a,o))}_applyUpdateEdits({updateResults:e},i){const{geometryType:s,hasM:r,hasZ:l,objectIdField:o,spatialReference:d,featureStore:u}=this._queryEngine;for(const f of i){const{attributes:i,geometry:y}=f,c=i&&i[o];if(null==c){e.push(g(`Identifier field ${o} missing`));continue}if(!u.has(c)){e.push(g(`Feature with object id ${c} missing`));continue}const m=n(u.getFeature(c),s,l,r);if(y){if(s!==t(y)){e.push(g(\"Incorrect geometry type.\"));continue}m.geometry=p(F(y,d),y.spatialReference,d)}if(i){const t=I(this._fieldsIndex,m.attributes,i,this._requiredFields);if(t){e.push(t);continue}}u.add(a(m,s,l,r,o)),e.push(b(c))}}_assignObjectId(e,t,i=!1){const s=this._queryEngine.objectIdField;i&&t&&isFinite(t[s])?e[s]=t[s]:e[s]=this._nextObjectId++}}export default O;\n"]},"metadata":{},"sourceType":"module"}