{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { nextHighestPowerOfTwo as e } from \"../../../core/mathUtils.js\";\nimport { disposeMaybe as t, releaseMaybe as r, isSome as a, isNone as s } from \"../../../core/maybe.js\";\nimport { s as i, c as o } from \"../../../chunks/vec2.js\";\nimport { Z as n } from \"../../../chunks/vec2f64.js\";\nimport { f as l } from \"../../../chunks/vec4f64.js\";\nimport { isBaseLayer as c } from \"../../../layers/support/layerUtils.js\";\nimport \"../../webgl/BufferObject.js\";\nimport \"../../webgl/FramebufferObject.js\";\nimport \"../../../core/has.js\";\nimport \"../../webgl/enums.js\";\nimport \"../../webgl/RenderingContext.js\";\nimport \"../../../chunks/builtins.js\";\nimport u from \"../../webgl/Texture.js\";\nimport \"../../webgl/VertexArrayObject.js\";\nimport { VectorTileRendererHelper3D as h } from \"../../2d/engine/vectorTiles/VectorTileRendererHelper3D.js\";\nimport { ImageWithType as d } from \"../support/StreamDataLoader.js\";\nimport { BlendLayersTechniqueConfiguration as f, BlendLayersTechnique as p } from \"./BlendLayersTechnique.js\";\nimport { RasterColorizerTechniqueConfiguration as _, RasterColorizerTechnique as m } from \"./RasterColorizerTechnique.js\";\nimport { isVectorTileLayerView as T, isVectorTileRenderInfo as x, isImageryTileRenderInfo as b, isRasterTileRenderInfo as y, isTextureTileRenderInfo as g } from \"./terrainUtils.js\";\nimport w from \"./TileTexture.js\";\nimport { FBOPool as D } from \"./support/FBOPool.js\";\nimport { Pos2Tex as I } from \"../webgl-engine/lib/DefaultVertexBufferLayouts.js\";\nimport { createQuadVAO as k, createColorTexture as L, createEmptyTexture as O } from \"../webgl-engine/lib/glUtil3D.js\";\nimport { vertexCount as C } from \"../../webgl/Util.js\";\n\nclass R {\n  constructor(e, t, r) {\n    this._rctx = e, this.tileSize = t, this._backgroundIsGrid = !1, this._backgroundTexture = null, this._backgroundColor = null, this._blackTex = null, this._vectorTileHelper = new h(), this._maxAnisotropy = this._rctx.parameters.maxMaxAnisotropy, this._vaoQuad = k(this._rctx, I);\n    const a = new f();\n    a.mode = 2, this._blendLayersTechnique = r.acquire(p, a), a.mode = 1, this._applyOpacityTechnique = r.acquire(p, a), this._techniqueRep = r, this._blackTex = new w(L(this._rctx, [0, 0, 0, 1])), this._fboPool = new D(this._rctx);\n  }\n\n  dispose() {\n    this._fboPool && (this._fboPool.clear(), this._fboPool = null), this._vaoQuad = t(this._vaoQuad), this._backgroundTexture = r(this._backgroundTexture), this._blackTex = r(this._blackTex), this._blendLayersTechnique = t(this._blendLayersTechnique), this._applyOpacityTechnique = t(this._applyOpacityTechnique), this._vectorTileHelper = t(this._vectorTileHelper);\n  }\n\n  updateTileTexture(e) {\n    const t = e.layerInfo[1];\n\n    for (const a of t) a.pendingUpdates &= -65;\n\n    if (!e.renderData) return;\n    const r = e.surface,\n          i = r.baseOpacity;\n    let o = 0,\n        n = 0,\n        l = this.tileSize,\n        u = !1;\n    const h = r.view.pixelRatio;\n    let d = t.length,\n        f = 0;\n\n    for (; f < t.length && !u; f++) {\n      const s = r.layerViewByIndex(f, 1),\n            p = s.fullOpacity;\n      if (P[f] = p, c(s.layer) && d >= t.length && (d = f), 0 === p) continue;\n      ++n;\n\n      const _ = q(e, f, U);\n\n      _ && (T(s) ? l = Math.max(l, this.tileSize * h) : 1 === i && 1 === p && (s.isOpaque || this._dataToTexture(_) && a(_.sourceLayerInfo.data) && _.sourceLayerInfo.data.descriptor.isOpaque) && (u = !0), ++o);\n    }\n\n    this._cleanupFBOPool(h, t.length), l = j(l);\n\n    const p = l / this.tileSize,\n          _ = f - 1;\n\n    if (0 === o) {\n      let t = 0;\n      return (e.surface.view.layerViewManager.updating || n > 0) && (t = 5e3), this._backgroundTexture && s(e.renderData.textureReference) && (t = 0), void this._useBackgroundTexture(e, t);\n    }\n\n    1 === o && (u || this._backgroundIsGrid || a(this._backgroundColor)) && this._useLayerTexture(e, _, d, P[_]) || this._composeMapLayers(e, _, d, u, P, l, p);\n  }\n\n  setBackground(e, t) {\n    r(this._backgroundTexture), this._backgroundIsGrid = t, e instanceof HTMLImageElement ? (this._backgroundTexture = this._buildTexture(e), this._backgroundColor = null) : (this._backgroundTexture = new w(L(this._rctx, e)), this._backgroundColor = l(e[0] || 0, e[1] || 0, e[2] || 0, e[3] || 0));\n  }\n\n  get backgroundIsGrid() {\n    return this._backgroundIsGrid;\n  }\n\n  get backgroundColor() {\n    return this._backgroundColor;\n  }\n\n  _buildTexture(e, t = 9987) {\n    if (s(e)) return null;\n    const r = {\n      target: 3553,\n      pixelFormat: 6408,\n      dataType: 5121,\n      wrapMode: 33071,\n      samplingMode: t,\n      maxAnisotropy: this._maxAnisotropy,\n      flipped: !0,\n      hasMipmap: !0\n    },\n          a = this._rctx;\n    let i;\n    if (\"number\" == typeof e) r.width = r.height = e, i = new w(new u(a, r));else if (e instanceof d) r.isOpaque = e.isOpaque, i = new w(new u(a, r, e.image)), e.release();else try {\n      i = new w(new u(a, r, e));\n    } catch (n) {\n      i = new w(O(a)), console.warn(\"TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.\");\n    }\n    const o = a.bindTexture(i.texture, u.TEXTURE_UNIT_FOR_UPDATES);\n    return i.generateMipmap(), a.bindTexture(o, u.TEXTURE_UNIT_FOR_UPDATES), i;\n  }\n\n  _drawQuad(e) {\n    this._rctx.bindVAO(this._vaoQuad), e.assertCompatibleVertexAttributeLocations(this._vaoQuad), this._rctx.drawArrays(5, 0, C(this._vaoQuad, \"geometry\"));\n  }\n\n  _drawRasterData(e, t, r, a, i = 1) {\n    if (s(t)) return;\n    const o = this._rctx,\n          n = e.program;\n    o.setPipelineState(e.pipeline), o.useProgram(n), n.bindTexture(t, \"tex\"), n.setUniform1f(\"scale\", r), n.setUniform2f(\"offset\", a[0], a[1]), n.setUniform1f(\"opacity\", i), this._drawQuad(n);\n  }\n\n  hasNearestInterpolation(e) {\n    const t = e.sourceLayerInfo.data;\n    return !(s(t) || !t.source) && \"nearest\" === t.interpolation;\n  }\n\n  _drawImageryTileData(e, t = 1) {\n    const r = e.sourceLayerInfo.data;\n    if (s(r) || !r.source) return;\n    e.tile.surface.layerViewByIndex(e.layerIndex, 1).ensureSymbolizerParameters(r);\n\n    const a = this._getRasterColorizerTechnique(r.symbolizerParameters.type, !!r.symbolizerParameters.colormap),\n          i = this._rctx,\n          o = a.program;\n\n    if (i.setPipelineState(a.pipeline), i.useProgram(o), !r.bind(i)) return;\n    r.opacity = t, r.scale = e.scale, r.offset = e.offset;\n    const {\n      names: n,\n      textures: l\n    } = r.getTextures();\n    n.forEach((e, t) => o.bindTexture(l[t], e)), a.bindPass(r.getUniforms()), this._drawQuad(o), i.bindVAO();\n  }\n\n  _getRasterColorizerTechnique(e, t) {\n    const r = [\"stretch\", \"lut\", \"hillshade\"].indexOf(e);\n    return this._rasterColorizerConfig || (this._rasterColorizerConfig = new _(), this._rctx.gl.getExtension(\"WEBGL_color_buffer_float\"), this._rctx.gl.getExtension(\"OES_texture_float\")), this._rasterColorizerConfig.colorizerType = r, this._rasterColorizerConfig.applyColormap = t, this._rasterColorizerTechnique = this._techniqueRep.releaseAndAcquire(m, this._rasterColorizerConfig, this._rasterColorizerTechnique), this._rasterColorizerTechnique;\n  }\n\n  _drawVectorData(e, t, r, i, o, n, l) {\n    const c = t.sourceLayerInfo.data;\n    if (s(c)) return l;\n    const u = this._rctx,\n          h = t.tile.surface.layerViewByIndex(t.layerIndex, 1);\n    let d;\n    return u.setPipelineState(e.pipeline), i < 1 ? (d = this._fboPool.acquire(o), u.bindFramebuffer(d), u.setClearColor(1, 1, 1, 0), u.clearSafe(16640)) : l && u.clearSafe(256), this._vectorTileHelper.render(u, t.sourceLod, c, h.painter, h.layer.styleRepository, h.schemaHelper, Math.round(1 / t.scale), t.offset, this.tileSize, r), !a(d) || (u.bindFramebuffer(n), this._drawRasterData(e, d.colorTexture, 1, [0, 0], i), this._fboPool.release(d), l);\n  }\n\n  _useBackgroundTexture(e, t) {\n    e.renderData.opacity = e.surface.baseOpacity, e.renderData.compositeBackgroundInShader = !1, e.renderData.layerOpacity = 1, e.renderData.baseOpacity = 1, e.renderData.setTextureReference(this._backgroundTexture, 0, 0, 1, t);\n  }\n\n  _useLayerTexture(e, t, r, a) {\n    const s = t < r;\n    e.renderData.opacity = s ? 1 : e.surface.baseOpacity, e.renderData.compositeBackgroundInShader = !0, e.renderData.layerOpacity = a, e.renderData.baseOpacity = s ? e.surface.baseOpacity : 1;\n    const i = q(e, t, U);\n\n    if (this._dataToTexture(i)) {\n      const t = i.offset;\n      return e.renderData.setTextureReference(i.sourceLayerInfo.data, t[0], t[1], i.scale), !0;\n    }\n\n    return !1;\n  }\n\n  _composeMapLayers(e, t, r, s, i, o, l) {\n    const c = this._rctx,\n          h = this._fboPool.acquire(o);\n\n    c.bindFramebuffer(h), c.setViewport(0, 0, o, o), c.setClearColor(0, 0, 0, 0), c.setClearDepth(1), c.clearSafe(16640);\n    let d = !1;\n    !s && a(this._backgroundTexture) && this._drawRasterData(this._blendLayersTechnique, this._backgroundTexture.texture, 1, n);\n    const f = e.surface.baseOpacity;\n    let p = !1,\n        _ = 9987;\n\n    for (let u = t; u >= 0; u--) {\n      const t = q(e, u, U);\n      t && (u < r && f < 1 && !p && (this._drawRasterData(this._applyOpacityTechnique, this._blackTex.texture, 1, n, f), p = !0), 0 !== i[u] && (x(t) ? d = this._drawVectorData(this._blendLayersTechnique, t, l, i[u], o, h, d) : b(t) ? (this._drawImageryTileData(t, i[u]), this.hasNearestInterpolation(t) && (_ = 9728)) : this._dataToTexture(t) && a(t.sourceLayerInfo.data) && this._drawRasterData(this._blendLayersTechnique, t.sourceLayerInfo.data.texture, t.scale, t.offset, i[u])));\n    }\n\n    const m = e.renderData.ensureTexture(o, () => this._buildTexture(o, _)),\n          T = c.bindTexture(m.texture, u.TEXTURE_UNIT_FOR_UPDATES),\n          y = m.descriptor;\n    c.gl.copyTexImage2D(c.gl.TEXTURE_2D, 0, y.pixelFormat, 0, 0, y.width, y.height, 0), m.generateMipmap(), c.bindTexture(T, u.TEXTURE_UNIT_FOR_UPDATES), c.bindFramebuffer(null), this._fboPool.release(h), e.renderData.opacity = p ? 1 : f, e.renderData.compositeBackgroundInShader = !1, e.renderData.layerOpacity = 1, e.renderData.baseOpacity = 1, e.renderData.setTextureReference(m, 0, 0, 1);\n  }\n\n  _dataToTexture(e) {\n    return y(e) && this._rasterDataToTexture(e), g(e);\n  }\n\n  _rasterDataToTexture(e) {\n    const t = e.sourceLayerInfo;\n    t.data = this._buildTexture(t.data), e.tile.setMemoryDirty();\n  }\n\n  _cleanupFBOPool(e, t) {\n    e === this._lastPixelRatio && t === this._lastNumLayers || (this._fboPool.clear(), this._lastPixelRatio = e, this._lastNumLayers = t);\n  }\n\n  get test() {\n    return {\n      backgroundTexture: this._backgroundTexture\n    };\n  }\n\n}\n\nfunction j(t) {\n  const r = e(t),\n        a = r * r,\n        s = t * t;\n  if (a === s) return t;\n  const i = r / 2;\n  return a - s < s - i * i ? r : i;\n}\n\nfunction q(e, t, r) {\n  r.layerIndex = t;\n  const a = e.layerInfo[1][t];\n  if (a.data) return i(r.offset, 0, 0), r.tile = e, r.scale = 1, r.sourceLod = e.lij, r.sourceLayerInfo = a, r;\n  const s = a.upsampleInfo;\n\n  if (s) {\n    const e = s.tile.layerInfo[1][t];\n    return r.tile = s.tile, o(r.offset, s.offset), r.scale = s.scale, r.sourceLod = s.tile.lij, r.sourceLayerInfo = e, r;\n  }\n\n  return null;\n}\n\nconst P = new Array(),\n      U = {\n  tile: null,\n  sourceLayerInfo: null,\n  sourceLod: null,\n  offset: [0, 0],\n  scale: 1,\n  layerIndex: 0\n};\nexport { R as TileRenderer };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/terrain/TileRenderer.js"],"names":["nextHighestPowerOfTwo","e","disposeMaybe","t","releaseMaybe","r","isSome","a","isNone","s","i","c","o","Z","n","f","l","isBaseLayer","u","VectorTileRendererHelper3D","h","ImageWithType","d","BlendLayersTechniqueConfiguration","BlendLayersTechnique","p","RasterColorizerTechniqueConfiguration","_","RasterColorizerTechnique","m","isVectorTileLayerView","T","isVectorTileRenderInfo","x","isImageryTileRenderInfo","b","isRasterTileRenderInfo","y","isTextureTileRenderInfo","g","w","FBOPool","D","Pos2Tex","I","createQuadVAO","k","createColorTexture","L","createEmptyTexture","O","vertexCount","C","R","constructor","_rctx","tileSize","_backgroundIsGrid","_backgroundTexture","_backgroundColor","_blackTex","_vectorTileHelper","_maxAnisotropy","parameters","maxMaxAnisotropy","_vaoQuad","mode","_blendLayersTechnique","acquire","_applyOpacityTechnique","_techniqueRep","_fboPool","dispose","clear","updateTileTexture","layerInfo","pendingUpdates","renderData","surface","baseOpacity","view","pixelRatio","length","layerViewByIndex","fullOpacity","P","layer","q","U","Math","max","isOpaque","_dataToTexture","sourceLayerInfo","data","descriptor","_cleanupFBOPool","j","layerViewManager","updating","textureReference","_useBackgroundTexture","_useLayerTexture","_composeMapLayers","setBackground","HTMLImageElement","_buildTexture","backgroundIsGrid","backgroundColor","target","pixelFormat","dataType","wrapMode","samplingMode","maxAnisotropy","flipped","hasMipmap","width","height","image","release","console","warn","bindTexture","texture","TEXTURE_UNIT_FOR_UPDATES","generateMipmap","_drawQuad","bindVAO","assertCompatibleVertexAttributeLocations","drawArrays","_drawRasterData","program","setPipelineState","pipeline","useProgram","setUniform1f","setUniform2f","hasNearestInterpolation","source","interpolation","_drawImageryTileData","tile","layerIndex","ensureSymbolizerParameters","_getRasterColorizerTechnique","symbolizerParameters","type","colormap","bind","opacity","scale","offset","names","textures","getTextures","forEach","bindPass","getUniforms","indexOf","_rasterColorizerConfig","gl","getExtension","colorizerType","applyColormap","_rasterColorizerTechnique","releaseAndAcquire","_drawVectorData","bindFramebuffer","setClearColor","clearSafe","render","sourceLod","painter","styleRepository","schemaHelper","round","colorTexture","compositeBackgroundInShader","layerOpacity","setTextureReference","setViewport","setClearDepth","ensureTexture","copyTexImage2D","TEXTURE_2D","_rasterDataToTexture","setMemoryDirty","_lastPixelRatio","_lastNumLayers","test","backgroundTexture","lij","upsampleInfo","Array","TileRenderer"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{nextHighestPowerOfTwo as e}from\"../../../core/mathUtils.js\";import{disposeMaybe as t,releaseMaybe as r,isSome as a,isNone as s}from\"../../../core/maybe.js\";import{s as i,c as o}from\"../../../chunks/vec2.js\";import{Z as n}from\"../../../chunks/vec2f64.js\";import{f as l}from\"../../../chunks/vec4f64.js\";import{isBaseLayer as c}from\"../../../layers/support/layerUtils.js\";import\"../../webgl/BufferObject.js\";import\"../../webgl/FramebufferObject.js\";import\"../../../core/has.js\";import\"../../webgl/enums.js\";import\"../../webgl/RenderingContext.js\";import\"../../../chunks/builtins.js\";import u from\"../../webgl/Texture.js\";import\"../../webgl/VertexArrayObject.js\";import{VectorTileRendererHelper3D as h}from\"../../2d/engine/vectorTiles/VectorTileRendererHelper3D.js\";import{ImageWithType as d}from\"../support/StreamDataLoader.js\";import{BlendLayersTechniqueConfiguration as f,BlendLayersTechnique as p}from\"./BlendLayersTechnique.js\";import{RasterColorizerTechniqueConfiguration as _,RasterColorizerTechnique as m}from\"./RasterColorizerTechnique.js\";import{isVectorTileLayerView as T,isVectorTileRenderInfo as x,isImageryTileRenderInfo as b,isRasterTileRenderInfo as y,isTextureTileRenderInfo as g}from\"./terrainUtils.js\";import w from\"./TileTexture.js\";import{FBOPool as D}from\"./support/FBOPool.js\";import{Pos2Tex as I}from\"../webgl-engine/lib/DefaultVertexBufferLayouts.js\";import{createQuadVAO as k,createColorTexture as L,createEmptyTexture as O}from\"../webgl-engine/lib/glUtil3D.js\";import{vertexCount as C}from\"../../webgl/Util.js\";class R{constructor(e,t,r){this._rctx=e,this.tileSize=t,this._backgroundIsGrid=!1,this._backgroundTexture=null,this._backgroundColor=null,this._blackTex=null,this._vectorTileHelper=new h,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._vaoQuad=k(this._rctx,I);const a=new f;a.mode=2,this._blendLayersTechnique=r.acquire(p,a),a.mode=1,this._applyOpacityTechnique=r.acquire(p,a),this._techniqueRep=r,this._blackTex=new w(L(this._rctx,[0,0,0,1])),this._fboPool=new D(this._rctx)}dispose(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad=t(this._vaoQuad),this._backgroundTexture=r(this._backgroundTexture),this._blackTex=r(this._blackTex),this._blendLayersTechnique=t(this._blendLayersTechnique),this._applyOpacityTechnique=t(this._applyOpacityTechnique),this._vectorTileHelper=t(this._vectorTileHelper)}updateTileTexture(e){const t=e.layerInfo[1];for(const a of t)a.pendingUpdates&=-65;if(!e.renderData)return;const r=e.surface,i=r.baseOpacity;let o=0,n=0,l=this.tileSize,u=!1;const h=r.view.pixelRatio;let d=t.length,f=0;for(;f<t.length&&!u;f++){const s=r.layerViewByIndex(f,1),p=s.fullOpacity;if(P[f]=p,c(s.layer)&&d>=t.length&&(d=f),0===p)continue;++n;const _=q(e,f,U);_&&(T(s)?l=Math.max(l,this.tileSize*h):1===i&&1===p&&(s.isOpaque||this._dataToTexture(_)&&a(_.sourceLayerInfo.data)&&_.sourceLayerInfo.data.descriptor.isOpaque)&&(u=!0),++o)}this._cleanupFBOPool(h,t.length),l=j(l);const p=l/this.tileSize,_=f-1;if(0===o){let t=0;return(e.surface.view.layerViewManager.updating||n>0)&&(t=5e3),this._backgroundTexture&&s(e.renderData.textureReference)&&(t=0),void this._useBackgroundTexture(e,t)}1===o&&(u||this._backgroundIsGrid||a(this._backgroundColor))&&this._useLayerTexture(e,_,d,P[_])||this._composeMapLayers(e,_,d,u,P,l,p)}setBackground(e,t){r(this._backgroundTexture),this._backgroundIsGrid=t,e instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(e),this._backgroundColor=null):(this._backgroundTexture=new w(L(this._rctx,e)),this._backgroundColor=l(e[0]||0,e[1]||0,e[2]||0,e[3]||0))}get backgroundIsGrid(){return this._backgroundIsGrid}get backgroundColor(){return this._backgroundColor}_buildTexture(e,t=9987){if(s(e))return null;const r={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:t,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},a=this._rctx;let i;if(\"number\"==typeof e)r.width=r.height=e,i=new w(new u(a,r));else if(e instanceof d)r.isOpaque=e.isOpaque,i=new w(new u(a,r,e.image)),e.release();else try{i=new w(new u(a,r,e))}catch(n){i=new w(O(a)),console.warn(\"TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.\")}const o=a.bindTexture(i.texture,u.TEXTURE_UNIT_FOR_UPDATES);return i.generateMipmap(),a.bindTexture(o,u.TEXTURE_UNIT_FOR_UPDATES),i}_drawQuad(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(5,0,C(this._vaoQuad,\"geometry\"))}_drawRasterData(e,t,r,a,i=1){if(s(t))return;const o=this._rctx,n=e.program;o.setPipelineState(e.pipeline),o.useProgram(n),n.bindTexture(t,\"tex\"),n.setUniform1f(\"scale\",r),n.setUniform2f(\"offset\",a[0],a[1]),n.setUniform1f(\"opacity\",i),this._drawQuad(n)}hasNearestInterpolation(e){const t=e.sourceLayerInfo.data;return!(s(t)||!t.source)&&\"nearest\"===t.interpolation}_drawImageryTileData(e,t=1){const r=e.sourceLayerInfo.data;if(s(r)||!r.source)return;e.tile.surface.layerViewByIndex(e.layerIndex,1).ensureSymbolizerParameters(r);const a=this._getRasterColorizerTechnique(r.symbolizerParameters.type,!!r.symbolizerParameters.colormap),i=this._rctx,o=a.program;if(i.setPipelineState(a.pipeline),i.useProgram(o),!r.bind(i))return;r.opacity=t,r.scale=e.scale,r.offset=e.offset;const{names:n,textures:l}=r.getTextures();n.forEach(((e,t)=>o.bindTexture(l[t],e))),a.bindPass(r.getUniforms()),this._drawQuad(o),i.bindVAO()}_getRasterColorizerTechnique(e,t){const r=[\"stretch\",\"lut\",\"hillshade\"].indexOf(e);return this._rasterColorizerConfig||(this._rasterColorizerConfig=new _,this._rctx.gl.getExtension(\"WEBGL_color_buffer_float\"),this._rctx.gl.getExtension(\"OES_texture_float\")),this._rasterColorizerConfig.colorizerType=r,this._rasterColorizerConfig.applyColormap=t,this._rasterColorizerTechnique=this._techniqueRep.releaseAndAcquire(m,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}_drawVectorData(e,t,r,i,o,n,l){const c=t.sourceLayerInfo.data;if(s(c))return l;const u=this._rctx,h=t.tile.surface.layerViewByIndex(t.layerIndex,1);let d;return u.setPipelineState(e.pipeline),i<1?(d=this._fboPool.acquire(o),u.bindFramebuffer(d),u.setClearColor(1,1,1,0),u.clearSafe(16640)):l&&u.clearSafe(256),this._vectorTileHelper.render(u,t.sourceLod,c,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/t.scale),t.offset,this.tileSize,r),!a(d)||(u.bindFramebuffer(n),this._drawRasterData(e,d.colorTexture,1,[0,0],i),this._fboPool.release(d),l)}_useBackgroundTexture(e,t){e.renderData.opacity=e.surface.baseOpacity,e.renderData.compositeBackgroundInShader=!1,e.renderData.layerOpacity=1,e.renderData.baseOpacity=1,e.renderData.setTextureReference(this._backgroundTexture,0,0,1,t)}_useLayerTexture(e,t,r,a){const s=t<r;e.renderData.opacity=s?1:e.surface.baseOpacity,e.renderData.compositeBackgroundInShader=!0,e.renderData.layerOpacity=a,e.renderData.baseOpacity=s?e.surface.baseOpacity:1;const i=q(e,t,U);if(this._dataToTexture(i)){const t=i.offset;return e.renderData.setTextureReference(i.sourceLayerInfo.data,t[0],t[1],i.scale),!0}return!1}_composeMapLayers(e,t,r,s,i,o,l){const c=this._rctx,h=this._fboPool.acquire(o);c.bindFramebuffer(h),c.setViewport(0,0,o,o),c.setClearColor(0,0,0,0),c.setClearDepth(1),c.clearSafe(16640);let d=!1;!s&&a(this._backgroundTexture)&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture.texture,1,n);const f=e.surface.baseOpacity;let p=!1,_=9987;for(let u=t;u>=0;u--){const t=q(e,u,U);t&&(u<r&&f<1&&!p&&(this._drawRasterData(this._applyOpacityTechnique,this._blackTex.texture,1,n,f),p=!0),0!==i[u]&&(x(t)?d=this._drawVectorData(this._blendLayersTechnique,t,l,i[u],o,h,d):b(t)?(this._drawImageryTileData(t,i[u]),this.hasNearestInterpolation(t)&&(_=9728)):this._dataToTexture(t)&&a(t.sourceLayerInfo.data)&&this._drawRasterData(this._blendLayersTechnique,t.sourceLayerInfo.data.texture,t.scale,t.offset,i[u])))}const m=e.renderData.ensureTexture(o,(()=>this._buildTexture(o,_))),T=c.bindTexture(m.texture,u.TEXTURE_UNIT_FOR_UPDATES),y=m.descriptor;c.gl.copyTexImage2D(c.gl.TEXTURE_2D,0,y.pixelFormat,0,0,y.width,y.height,0),m.generateMipmap(),c.bindTexture(T,u.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(null),this._fboPool.release(h),e.renderData.opacity=p?1:f,e.renderData.compositeBackgroundInShader=!1,e.renderData.layerOpacity=1,e.renderData.baseOpacity=1,e.renderData.setTextureReference(m,0,0,1)}_dataToTexture(e){return y(e)&&this._rasterDataToTexture(e),g(e)}_rasterDataToTexture(e){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}_cleanupFBOPool(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t)}get test(){return{backgroundTexture:this._backgroundTexture}}}function j(t){const r=e(t),a=r*r,s=t*t;if(a===s)return t;const i=r/2;return a-s<s-i*i?r:i}function q(e,t,r){r.layerIndex=t;const a=e.layerInfo[1][t];if(a.data)return i(r.offset,0,0),r.tile=e,r.scale=1,r.sourceLod=e.lij,r.sourceLayerInfo=a,r;const s=a.upsampleInfo;if(s){const e=s.tile.layerInfo[1][t];return r.tile=s.tile,o(r.offset,s.offset),r.scale=s.scale,r.sourceLod=s.tile.lij,r.sourceLayerInfo=e,r}return null}const P=new Array,U={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};export{R as TileRenderer};\n"]},"metadata":{},"sourceType":"module"}