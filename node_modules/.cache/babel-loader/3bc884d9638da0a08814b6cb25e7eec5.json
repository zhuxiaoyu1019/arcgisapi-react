{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from \"../../../core/CircularArray.js\";\nimport { clamp as e } from \"../../../core/mathUtils.js\";\nimport { isNone as s, isSome as i, unwrap as r } from \"../../../core/maybe.js\";\nconst o = \"__esri_stream_id__\",\n      d = \"__esri_timestamp__\",\n      a = 1e3;\n\nclass h {\n  constructor(t, e, s, i, r = 128) {\n    this._trackIdToObservations = new Map(), this._idCounter = 0, this._lastPurge = performance.now(), this._addOrUpdated = new Map(), this._removed = [], this._maxAge = 0, this._timeInfo = s, this._purgeOptions = i, this.store = t, this.objectIdField = e, this.purgeInterval = r, this._useGeneratedIds = this.objectIdField === o;\n  }\n\n  add(r) {\n    if (this._useGeneratedIds) {\n      const t = this._nextId();\n\n      r.attributes[this.objectIdField] = t, r.objectId = t;\n    } else r.objectId = r.attributes[this.objectIdField];\n\n    if (this._addOrUpdated.set(r.objectId, r), this._maxAge = Math.max(this._maxAge, r.attributes[this._timeInfo.startTimeField]), !this._timeInfo.trackIdField) return s(this._trackIdLessObservations) && (this._trackIdLessObservations = new t(1e5)), void this._trackIdLessObservations.enqueue(r.objectId);\n    const o = r.attributes[this._timeInfo.trackIdField];\n\n    if (!this._trackIdToObservations.has(o)) {\n      const s = i(this._purgeOptions) && null != this._purgeOptions.maxObservations ? this._purgeOptions.maxObservations : a,\n            r = e(s, 0, a);\n\n      this._trackIdToObservations.set(o, new t(r));\n    }\n\n    const d = this._trackIdToObservations.get(o).enqueue(r.objectId);\n\n    i(d) && (this._addOrUpdated.has(d) ? this._addOrUpdated.delete(d) : this._removed.push(d));\n  }\n\n  checkForUpdates() {\n    const t = this._getToAdd(),\n          e = this._getToRemove(),\n          s = performance.now();\n\n    s - this._lastPurge >= this.purgeInterval && (this._purge(s), this._lastPurge = s);\n    const r = [];\n    if (i(e)) for (const o of e) {\n      const t = this.store.removeById(o);\n      i(t) && r.push(t);\n    }\n    if (i(t)) for (const i of t) i.attributes[d] = s, this.store.add(i);\n    (t || r) && this.store.update(t, r);\n  }\n\n  _getToAdd() {\n    if (!this._addOrUpdated.size) return null;\n    const t = new Array(this._addOrUpdated.size);\n    let e = 0;\n    return this._addOrUpdated.forEach(s => t[e++] = s), this._addOrUpdated.clear(), t;\n  }\n\n  _getToRemove() {\n    const t = this._removed;\n    return this._removed.length ? (this._removed = [], t) : null;\n  }\n\n  _nextId() {\n    const t = this._idCounter;\n    return this._idCounter = (this._idCounter + 1) % 4294967294 + 1, t;\n  }\n\n  _purge(t) {\n    const e = this._purgeOptions;\n    i(e) && (this._purgeSomeByDisplayCount(e), this._purgeByAge(e), this._purgeByAgeReceived(t, e), this._purgeTracks());\n  }\n\n  _purgeSomeByDisplayCount(t) {\n    if (!t.displayCount) return;\n    let e = this.store.size;\n\n    if (e > t.displayCount) {\n      if (this._timeInfo.trackIdField) for (const s of this._trackIdToObservations.values()) if (e > t.displayCount && s.size) {\n        const t = r(s.dequeue());\n        this._removed.push(t), e--;\n      }\n\n      if (i(this._trackIdLessObservations)) {\n        let s = e - t.displayCount;\n\n        for (; s-- > 0;) {\n          const t = this._trackIdLessObservations.dequeue();\n\n          i(t) && this._removed.push(t);\n        }\n      }\n    }\n  }\n\n  _purgeByAge(t) {\n    var e;\n    if (!t.age || null == (e = this._timeInfo) || !e.startTimeField) return;\n    const s = 60 * t.age * 1e3,\n          i = this._maxAge - s;\n    this.store.forEach(t => {\n      t.attributes[this._timeInfo.startTimeField] < i && this._removed.push(t.objectId);\n    });\n  }\n\n  _purgeByAgeReceived(t, e) {\n    if (!e.ageReceived) return;\n    const s = t - 60 * e.ageReceived * 1e3;\n    this.store.forEach(t => {\n      t.attributes[d] < s && this._removed.push(t.objectId);\n    });\n  }\n\n  _purgeTracks() {\n    this._trackIdToObservations.forEach((t, e) => {\n      0 === t.size && this._trackIdToObservations.delete(e);\n    });\n  }\n\n}\n\nexport default h;\nexport { o as DEFAULT_STREAM_ID_FIELD, d as ESRI_TIMESTAMP };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/layers/graphics/data/StreamFeatureManager.js"],"names":["t","clamp","e","isNone","s","isSome","i","unwrap","r","o","d","a","h","constructor","_trackIdToObservations","Map","_idCounter","_lastPurge","performance","now","_addOrUpdated","_removed","_maxAge","_timeInfo","_purgeOptions","store","objectIdField","purgeInterval","_useGeneratedIds","add","_nextId","attributes","objectId","set","Math","max","startTimeField","trackIdField","_trackIdLessObservations","enqueue","has","maxObservations","get","delete","push","checkForUpdates","_getToAdd","_getToRemove","_purge","removeById","update","size","Array","forEach","clear","length","_purgeSomeByDisplayCount","_purgeByAge","_purgeByAgeReceived","_purgeTracks","displayCount","values","dequeue","age","ageReceived","DEFAULT_STREAM_ID_FIELD","ESRI_TIMESTAMP"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from\"../../../core/CircularArray.js\";import{clamp as e}from\"../../../core/mathUtils.js\";import{isNone as s,isSome as i,unwrap as r}from\"../../../core/maybe.js\";const o=\"__esri_stream_id__\",d=\"__esri_timestamp__\",a=1e3;class h{constructor(t,e,s,i,r=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=s,this._purgeOptions=i,this.store=t,this.objectIdField=e,this.purgeInterval=r,this._useGeneratedIds=this.objectIdField===o}add(r){if(this._useGeneratedIds){const t=this._nextId();r.attributes[this.objectIdField]=t,r.objectId=t}else r.objectId=r.attributes[this.objectIdField];if(this._addOrUpdated.set(r.objectId,r),this._maxAge=Math.max(this._maxAge,r.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return s(this._trackIdLessObservations)&&(this._trackIdLessObservations=new t(1e5)),void this._trackIdLessObservations.enqueue(r.objectId);const o=r.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(o)){const s=i(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:a,r=e(s,0,a);this._trackIdToObservations.set(o,new t(r))}const d=this._trackIdToObservations.get(o).enqueue(r.objectId);i(d)&&(this._addOrUpdated.has(d)?this._addOrUpdated.delete(d):this._removed.push(d))}checkForUpdates(){const t=this._getToAdd(),e=this._getToRemove(),s=performance.now();s-this._lastPurge>=this.purgeInterval&&(this._purge(s),this._lastPurge=s);const r=[];if(i(e))for(const o of e){const t=this.store.removeById(o);i(t)&&r.push(t)}if(i(t))for(const i of t)i.attributes[d]=s,this.store.add(i);(t||r)&&this.store.update(t,r)}_getToAdd(){if(!this._addOrUpdated.size)return null;const t=new Array(this._addOrUpdated.size);let e=0;return this._addOrUpdated.forEach((s=>t[e++]=s)),this._addOrUpdated.clear(),t}_getToRemove(){const t=this._removed;return this._removed.length?(this._removed=[],t):null}_nextId(){const t=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,t}_purge(t){const e=this._purgeOptions;i(e)&&(this._purgeSomeByDisplayCount(e),this._purgeByAge(e),this._purgeByAgeReceived(t,e),this._purgeTracks())}_purgeSomeByDisplayCount(t){if(!t.displayCount)return;let e=this.store.size;if(e>t.displayCount){if(this._timeInfo.trackIdField)for(const s of this._trackIdToObservations.values())if(e>t.displayCount&&s.size){const t=r(s.dequeue());this._removed.push(t),e--}if(i(this._trackIdLessObservations)){let s=e-t.displayCount;for(;s-- >0;){const t=this._trackIdLessObservations.dequeue();i(t)&&this._removed.push(t)}}}}_purgeByAge(t){var e;if(!t.age||null==(e=this._timeInfo)||!e.startTimeField)return;const s=60*t.age*1e3,i=this._maxAge-s;this.store.forEach((t=>{t.attributes[this._timeInfo.startTimeField]<i&&this._removed.push(t.objectId)}))}_purgeByAgeReceived(t,e){if(!e.ageReceived)return;const s=t-60*e.ageReceived*1e3;this.store.forEach((t=>{t.attributes[d]<s&&this._removed.push(t.objectId)}))}_purgeTracks(){this._trackIdToObservations.forEach(((t,e)=>{0===t.size&&this._trackIdToObservations.delete(e)}))}}export default h;export{o as DEFAULT_STREAM_ID_FIELD,d as ESRI_TIMESTAMP};\n"]},"metadata":{},"sourceType":"module"}