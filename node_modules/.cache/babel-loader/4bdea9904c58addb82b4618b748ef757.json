{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { clone as t } from \"../../../../core/lang.js\";\nimport { isSome as e, isNone as n } from \"../../../../core/maybe.js\";\nimport { attributeLookup as r } from \"../support/attributeUtils.js\";\nconst o = {\n  setAttribute() {},\n\n  rollback() {},\n\n  commit() {}\n\n};\n\nfunction s(e, r) {\n  const s = r.attributes[e.objectIdField],\n        i = e.sessions.get(s);\n  if (i) return i;\n  const a = t(r.attributes),\n        u = new Set();\n  if (null == s) return o;\n\n  const c = e.attributeOverrides.createInteractiveEditSession(s),\n        f = new Map(),\n        l = (t, e) => {\n    const n = f.get(t);\n\n    if (null == n) {\n      const n = e.indexOf(s);\n      return f.set(t, n), n;\n    }\n\n    return n;\n  };\n\n  let d = 0;\n  const b = {\n    setAttribute(t, o) {\n      if (0 !== d) return;\n      const s = e.fieldsIndex.get(t);\n      if (n(s)) return;\n      const i = e.attributeStorageInfo.findIndex(t => t.name === s.name);\n      if (i < 0) return;\n      c.set(i, o);\n      const a = e.attributeStorageInfo[i];\n      let f = !1;\n      u.add(t), e.forEachNode((t, n) => {\n        const s = l(t, n);\n        if (-1 === s) return;\n        const i = e.getAttributeData(t.index);\n\n        if (i) {\n          const n = i[a.name];\n          n && (n[s] = o, e.setAttributeData(t.index, i, r), f = !0);\n        }\n      }), f && e.clearMemCache();\n    },\n\n    rollback() {\n      if (0 === d) {\n        for (const t of u) this.setAttribute(t, a[t]);\n\n        c.rollback(), d = 1, e.sessions.delete(s);\n      }\n    },\n\n    commit() {\n      0 === d && (c.commit(), d = 2, e.sessions.delete(s));\n    }\n\n  };\n  return e.sessions.set(s, b), b;\n}\n\nfunction i(t, n) {\n  const r = a(t, n);\n  if (0 === r.size) return;\n  const o = new Map();\n\n  for (let e = 0; e < t.attributeStorageInfo.length; e++) o.set(t.attributeStorageInfo[e].name, e);\n\n  let s = !1;\n  r.forEach((n, r) => {\n    const i = t.getAttributeData(r);\n    let a = !1;\n    n.forEach((n, r) => {\n      const u = e(i) ? i[r] : null,\n            c = o.get(r);\n\n      for (const {\n        featureIndex: e,\n        value: o,\n        featureId: i\n      } of n) u && (u[e] = o, a = !0, s = !0), t.attributeOverrides.updateValue(i, c, o);\n    }), a && t.setAttributeData(r, i, null);\n  }), s && t.clearMemCache();\n}\n\nfunction a(t, e) {\n  const n = e.edits.updateFeatures;\n  if (!n || 0 === n.length) return new d();\n  const o = f(e),\n        s = new d(),\n        i = new Map();\n\n  for (let r = 0; r < t.attributeStorageInfo.length; r++) i.set(t.attributeStorageInfo[r].name, r);\n\n  const a = t.fieldsIndex,\n        c = t.objectIdField,\n        l = n.filter(t => {\n    const e = r(a, t.attributes, c);\n    return o.has(e);\n  });\n  return t.forEachNode((e, n) => {\n    const o = new Set(n);\n\n    for (const i of l) {\n      const f = r(a, i.attributes, c);\n      if (!o.has(f)) continue;\n      const l = n.indexOf(f);\n\n      for (const n in i.attributes) {\n        const r = t.fieldsIndex.normalizeFieldName(n),\n              o = u(s, e.index, r),\n              a = i.attributes[n];\n        o.push({\n          featureIndex: l,\n          featureId: f,\n          value: a\n        });\n      }\n    }\n  }), s;\n}\n\nfunction u(t, e, n) {\n  const r = c(t, e),\n        o = r.get(n);\n  if (o) return o;\n  const s = new Array();\n  return r.set(n, s), s;\n}\n\nfunction c(t, e) {\n  const n = t.get(e);\n  if (n) return n;\n  const r = new l();\n  return t.set(e, r), r;\n}\n\nfunction f(t) {\n  const e = new Set();\n  if (!t.updatedFeatures) return e;\n\n  for (const n of t.updatedFeatures) null != n.objectId && null == n.error && e.add(n.objectId);\n\n  return e;\n}\n\nconst l = Map,\n      d = Map;\nexport { s as createInteractiveEditSession, i as processAttributeEdits };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/layers/i3s/attributeEditing.js"],"names":["clone","t","isSome","e","isNone","n","attributeLookup","r","o","setAttribute","rollback","commit","s","attributes","objectIdField","i","sessions","get","a","u","Set","c","attributeOverrides","createInteractiveEditSession","f","Map","l","indexOf","set","d","b","fieldsIndex","attributeStorageInfo","findIndex","name","add","forEachNode","getAttributeData","index","setAttributeData","clearMemCache","delete","size","length","forEach","featureIndex","value","featureId","updateValue","edits","updateFeatures","filter","has","normalizeFieldName","push","Array","updatedFeatures","objectId","error","processAttributeEdits"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{clone as t}from\"../../../../core/lang.js\";import{isSome as e,isNone as n}from\"../../../../core/maybe.js\";import{attributeLookup as r}from\"../support/attributeUtils.js\";const o={setAttribute(){},rollback(){},commit(){}};function s(e,r){const s=r.attributes[e.objectIdField],i=e.sessions.get(s);if(i)return i;const a=t(r.attributes),u=new Set;if(null==s)return o;const c=e.attributeOverrides.createInteractiveEditSession(s),f=new Map,l=(t,e)=>{const n=f.get(t);if(null==n){const n=e.indexOf(s);return f.set(t,n),n}return n};let d=0;const b={setAttribute(t,o){if(0!==d)return;const s=e.fieldsIndex.get(t);if(n(s))return;const i=e.attributeStorageInfo.findIndex((t=>t.name===s.name));if(i<0)return;c.set(i,o);const a=e.attributeStorageInfo[i];let f=!1;u.add(t),e.forEachNode(((t,n)=>{const s=l(t,n);if(-1===s)return;const i=e.getAttributeData(t.index);if(i){const n=i[a.name];n&&(n[s]=o,e.setAttributeData(t.index,i,r),f=!0)}})),f&&e.clearMemCache()},rollback(){if(0===d){for(const t of u)this.setAttribute(t,a[t]);c.rollback(),d=1,e.sessions.delete(s)}},commit(){0===d&&(c.commit(),d=2,e.sessions.delete(s))}};return e.sessions.set(s,b),b}function i(t,n){const r=a(t,n);if(0===r.size)return;const o=new Map;for(let e=0;e<t.attributeStorageInfo.length;e++)o.set(t.attributeStorageInfo[e].name,e);let s=!1;r.forEach(((n,r)=>{const i=t.getAttributeData(r);let a=!1;n.forEach(((n,r)=>{const u=e(i)?i[r]:null,c=o.get(r);for(const{featureIndex:e,value:o,featureId:i}of n)u&&(u[e]=o,a=!0,s=!0),t.attributeOverrides.updateValue(i,c,o)})),a&&t.setAttributeData(r,i,null)})),s&&t.clearMemCache()}function a(t,e){const n=e.edits.updateFeatures;if(!n||0===n.length)return new d;const o=f(e),s=new d,i=new Map;for(let r=0;r<t.attributeStorageInfo.length;r++)i.set(t.attributeStorageInfo[r].name,r);const a=t.fieldsIndex,c=t.objectIdField,l=n.filter((t=>{const e=r(a,t.attributes,c);return o.has(e)}));return t.forEachNode(((e,n)=>{const o=new Set(n);for(const i of l){const f=r(a,i.attributes,c);if(!o.has(f))continue;const l=n.indexOf(f);for(const n in i.attributes){const r=t.fieldsIndex.normalizeFieldName(n),o=u(s,e.index,r),a=i.attributes[n];o.push({featureIndex:l,featureId:f,value:a})}}})),s}function u(t,e,n){const r=c(t,e),o=r.get(n);if(o)return o;const s=new Array;return r.set(n,s),s}function c(t,e){const n=t.get(e);if(n)return n;const r=new l;return t.set(e,r),r}function f(t){const e=new Set;if(!t.updatedFeatures)return e;for(const n of t.updatedFeatures)null!=n.objectId&&null==n.error&&e.add(n.objectId);return e}const l=Map,d=Map;export{s as createInteractiveEditSession,i as processAttributeEdits};\n"]},"metadata":{},"sourceType":"module"}