{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../support/FeatureSet.js\";\nimport t from \"../support/IdSet.js\";\nimport { layerGeometryEsriConstants as s, IdState as i } from \"../support/shared.js\";\nimport { combine as r } from \"../support/sqlUtils.js\";\nimport { resolve as n, isPromiseLike as a, reject as l, all as h } from \"../../../core/promiseUtils.js\";\nimport { WhereClause as u } from \"../../../core/sql/WhereClause.js\";\nimport c from \"../../../geometry/SpatialReference.js\";\n\nclass _ extends e {\n  constructor(e) {\n    super(e), this.declaredClass = \"esri.arcade.featureset.actions.AttributeFilter\", this._maxProcessing = 1e3, this._parent = e.parentfeatureset, e.whereclause instanceof u ? (this._whereclause = e.whereclause, this._whereClauseFunction = null) : (this._whereClauseFunction = e.whereclause, this._whereclause = null);\n  }\n\n  _initialiseFeatureSet() {\n    null !== this._parent ? (this.fields = this._parent.fields.slice(0), this.geometryType = this._parent.geometryType, this.objectIdField = this._parent.objectIdField, this.globalIdField = this._parent.globalIdField, this.spatialReference = this._parent.spatialReference, this.hasM = this._parent.hasM, this.hasZ = this._parent.hasZ, this.typeIdField = this._parent.typeIdField, this.types = this._parent.types) : (this.fields = [], this.typeIdField = \"\", this.objectIdField = \"\", this.globalIdField = \"\", this.spatialReference = new c({\n      wkid: 4326\n    }), this.geometryType = s.point);\n  }\n\n  _getSet(e) {\n    return null === this._wset ? this._ensureLoaded().then(() => this._parent._getFilteredSet(\"\", null, this._whereclause, null, e)).then(s => (this._checkCancelled(e), null !== this._whereClauseFunction ? this._wset = new t(s._candidates.slice(0).concat(s._known.slice(0)), [], s._ordered, this._clonePageDefinition(s.pagesDefinition)) : this._wset = new t(s._candidates.slice(0), s._known.slice(0), s._ordered, this._clonePageDefinition(s.pagesDefinition)), this._wset)) : n(this._wset);\n  }\n\n  _isInFeatureSet(e) {\n    let t = this._parent._isInFeatureSet(e);\n\n    return t === i.NotInFeatureSet ? t : (t = this._idstates[e], void 0 === t ? i.Unknown : t);\n  }\n\n  _getFeature(e, t, s) {\n    return this._parent._getFeature(e, t, s);\n  }\n\n  _getFeatures(e, t, s, i) {\n    return this._parent._getFeatures(e, t, s, i);\n  }\n\n  _featureFromCache(e) {\n    return this._parent._featureFromCache(e);\n  }\n\n  executeWhereClause(e) {\n    return this._whereclause.testFeature(e);\n  }\n\n  executeWhereClauseDeferred(e) {\n    if (null !== this._whereClauseFunction) try {\n      const t = this._whereClauseFunction(e);\n\n      return a(t) ? t : n(t);\n    } catch (t) {\n      return l(t);\n    }\n    return n(this.executeWhereClause(e));\n  }\n\n  _fetchAndRefineFeatures(e, s, r) {\n    const n = new t([], e, !1, null),\n          a = Math.min(s, e.length);\n    return this._parent._getFeatures(n, -1, a, r).then(() => {\n      if (this._checkCancelled(r), null == this._whereClauseFunction) {\n        for (let t = 0; t < a; t++) {\n          const s = this._parent._featureFromCache(e[t]);\n\n          !0 === this.executeWhereClause(s) ? this._idstates[e[t]] = i.InFeatureSet : this._idstates[e[t]] = i.NotInFeatureSet;\n        }\n\n        return \"success\";\n      }\n\n      const t = [];\n\n      for (let s = 0; s < a; s++) {\n        const i = this._parent._featureFromCache(e[s]);\n\n        t.push(this.executeWhereClauseDeferred(i));\n      }\n\n      return h(t).then(t => {\n        for (let r = 0; r < s; r++) !0 === t[r] ? this._idstates[e[r]] = i.InFeatureSet : this._idstates[e[r]] = i.NotInFeatureSet;\n\n        return \"success\";\n      });\n    });\n  }\n\n  _getFilteredSet(e, s, i, n, a) {\n    return null !== this._whereClauseFunction || (null !== i ? null !== this._whereclause && (i = r(this._whereclause, i)) : i = this._whereclause), this._ensureLoaded().then(() => this._parent._getFilteredSet(e, s, i, n, a)).then(e => {\n      let s;\n      return this._checkCancelled(a), s = null !== this._whereClauseFunction ? new t(e._candidates.slice(0).concat(e._known.slice(0)), [], e._ordered, this._clonePageDefinition(e.pagesDefinition)) : new t(e._candidates.slice(0), e._known.slice(0), e._ordered, this._clonePageDefinition(e.pagesDefinition)), s;\n    });\n  }\n\n  _stat(e, t, s, i, a, l, h) {\n    if (null !== this._whereClauseFunction) return null === a && \"\" === s && null === i ? this._manualStat(e, t, l, h) : n({\n      calculated: !1\n    });\n    let u = this._whereclause;\n    return null !== a && null !== this._whereclause && (u = r(this._whereclause, a)), this._parent._stat(e, t, s, i, u, l, h).then(r => !1 === r.calculated ? null === a && \"\" === s && null === i ? this._manualStat(e, t, l, h) : {\n      calculated: !1\n    } : r);\n  }\n\n  _canDoAggregates(e, t, s, i, a) {\n    return null !== this._whereClauseFunction ? n(!1) : (null !== a ? null !== this._whereclause && (a = r(this._whereclause, a)) : a = this._whereclause, null === this._parent ? n(!1) : this._parent._canDoAggregates(e, t, s, i, a));\n  }\n\n  _getAggregatePagesDataSourceDefinition(e, t, s, i, n, a, h) {\n    return null === this._parent ? l(new Error(\"Should never be called\")) : (null !== n ? null !== this._whereclause && (n = r(this._whereclause, n)) : n = this._whereclause, this._parent._getAggregatePagesDataSourceDefinition(e, t, s, i, n, a, h));\n  }\n\n  static registerAction() {\n    e._featuresetFunctions.filter = function (e) {\n      if (\"function\" == typeof e) return new _({\n        parentfeatureset: this,\n        whereclause: e\n      });\n      let t = null;\n      return e instanceof u && (t = e), new _({\n        parentfeatureset: this,\n        whereclause: t\n      });\n    };\n  }\n\n}\n\nexport default _;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/arcade/featureset/actions/AttributeFilter.js"],"names":["e","t","layerGeometryEsriConstants","s","IdState","i","combine","r","resolve","n","isPromiseLike","a","reject","l","all","h","WhereClause","u","c","_","constructor","declaredClass","_maxProcessing","_parent","parentfeatureset","whereclause","_whereclause","_whereClauseFunction","_initialiseFeatureSet","fields","slice","geometryType","objectIdField","globalIdField","spatialReference","hasM","hasZ","typeIdField","types","wkid","point","_getSet","_wset","_ensureLoaded","then","_getFilteredSet","_checkCancelled","_candidates","concat","_known","_ordered","_clonePageDefinition","pagesDefinition","_isInFeatureSet","NotInFeatureSet","_idstates","Unknown","_getFeature","_getFeatures","_featureFromCache","executeWhereClause","testFeature","executeWhereClauseDeferred","_fetchAndRefineFeatures","Math","min","length","InFeatureSet","push","_stat","_manualStat","calculated","_canDoAggregates","_getAggregatePagesDataSourceDefinition","Error","registerAction","_featuresetFunctions","filter"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../support/FeatureSet.js\";import t from\"../support/IdSet.js\";import{layerGeometryEsriConstants as s,IdState as i}from\"../support/shared.js\";import{combine as r}from\"../support/sqlUtils.js\";import{resolve as n,isPromiseLike as a,reject as l,all as h}from\"../../../core/promiseUtils.js\";import{WhereClause as u}from\"../../../core/sql/WhereClause.js\";import c from\"../../../geometry/SpatialReference.js\";class _ extends e{constructor(e){super(e),this.declaredClass=\"esri.arcade.featureset.actions.AttributeFilter\",this._maxProcessing=1e3,this._parent=e.parentfeatureset,e.whereclause instanceof u?(this._whereclause=e.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=e.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField=\"\",this.objectIdField=\"\",this.globalIdField=\"\",this.spatialReference=new c({wkid:4326}),this.geometryType=s.point)}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._parent._getFilteredSet(\"\",null,this._whereclause,null,e))).then((s=>(this._checkCancelled(e),null!==this._whereClauseFunction?this._wset=new t(s._candidates.slice(0).concat(s._known.slice(0)),[],s._ordered,this._clonePageDefinition(s.pagesDefinition)):this._wset=new t(s._candidates.slice(0),s._known.slice(0),s._ordered,this._clonePageDefinition(s.pagesDefinition)),this._wset))):n(this._wset)}_isInFeatureSet(e){let t=this._parent._isInFeatureSet(e);return t===i.NotInFeatureSet?t:(t=this._idstates[e],void 0===t?i.Unknown:t)}_getFeature(e,t,s){return this._parent._getFeature(e,t,s)}_getFeatures(e,t,s,i){return this._parent._getFeatures(e,t,s,i)}_featureFromCache(e){return this._parent._featureFromCache(e)}executeWhereClause(e){return this._whereclause.testFeature(e)}executeWhereClauseDeferred(e){if(null!==this._whereClauseFunction)try{const t=this._whereClauseFunction(e);return a(t)?t:n(t)}catch(t){return l(t)}return n(this.executeWhereClause(e))}_fetchAndRefineFeatures(e,s,r){const n=new t([],e,!1,null),a=Math.min(s,e.length);return this._parent._getFeatures(n,-1,a,r).then((()=>{if(this._checkCancelled(r),null==this._whereClauseFunction){for(let t=0;t<a;t++){const s=this._parent._featureFromCache(e[t]);!0===this.executeWhereClause(s)?this._idstates[e[t]]=i.InFeatureSet:this._idstates[e[t]]=i.NotInFeatureSet}return\"success\"}const t=[];for(let s=0;s<a;s++){const i=this._parent._featureFromCache(e[s]);t.push(this.executeWhereClauseDeferred(i))}return h(t).then((t=>{for(let r=0;r<s;r++)!0===t[r]?this._idstates[e[r]]=i.InFeatureSet:this._idstates[e[r]]=i.NotInFeatureSet;return\"success\"}))}))}_getFilteredSet(e,s,i,n,a){return null!==this._whereClauseFunction||(null!==i?null!==this._whereclause&&(i=r(this._whereclause,i)):i=this._whereclause),this._ensureLoaded().then((()=>this._parent._getFilteredSet(e,s,i,n,a))).then((e=>{let s;return this._checkCancelled(a),s=null!==this._whereClauseFunction?new t(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,this._clonePageDefinition(e.pagesDefinition)):new t(e._candidates.slice(0),e._known.slice(0),e._ordered,this._clonePageDefinition(e.pagesDefinition)),s}))}_stat(e,t,s,i,a,l,h){if(null!==this._whereClauseFunction)return null===a&&\"\"===s&&null===i?this._manualStat(e,t,l,h):n({calculated:!1});let u=this._whereclause;return null!==a&&null!==this._whereclause&&(u=r(this._whereclause,a)),this._parent._stat(e,t,s,i,u,l,h).then((r=>!1===r.calculated?null===a&&\"\"===s&&null===i?this._manualStat(e,t,l,h):{calculated:!1}:r))}_canDoAggregates(e,t,s,i,a){return null!==this._whereClauseFunction?n(!1):(null!==a?null!==this._whereclause&&(a=r(this._whereclause,a)):a=this._whereclause,null===this._parent?n(!1):this._parent._canDoAggregates(e,t,s,i,a))}_getAggregatePagesDataSourceDefinition(e,t,s,i,n,a,h){return null===this._parent?l(new Error(\"Should never be called\")):(null!==n?null!==this._whereclause&&(n=r(this._whereclause,n)):n=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(e,t,s,i,n,a,h))}static registerAction(){e._featuresetFunctions.filter=function(e){if(\"function\"==typeof e)return new _({parentfeatureset:this,whereclause:e});let t=null;return e instanceof u&&(t=e),new _({parentfeatureset:this,whereclause:t})}}}export default _;\n"]},"metadata":{},"sourceType":"module"}