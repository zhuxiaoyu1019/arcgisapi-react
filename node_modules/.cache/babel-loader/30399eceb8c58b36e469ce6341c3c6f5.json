{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../../chunks/tslib.es6.js\";\nimport t from \"../../../../../core/Accessor.js\";\nimport { equals as r } from \"../../../../../core/arrayUtils.js\";\nimport s from \"../../../../../core/Logger.js\";\nimport { clamp as o } from \"../../../../../core/mathUtils.js\";\nimport { disposeMaybe as i, destroyMaybe as n, isNone as a, isSome as c } from \"../../../../../core/maybe.js\";\nimport { createAbortController as d } from \"../../../../../core/promiseUtils.js\";\nimport { isUint16Array as l } from \"../../../../../core/typedArrayUtil.js\";\nimport { property as m } from \"../../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../../core/has.js\";\nimport \"../../../../../core/accessorSupport/ensureType.js\";\nimport { subclass as g } from \"../../../../../core/accessorSupport/decorators/subclass.js\";\nimport { f as u, t as h, e as p } from \"../../../../../chunks/mat3.js\";\nimport { c as f } from \"../../../../../chunks/mat3f64.js\";\nimport { d as b } from \"../../../../../chunks/mat4.js\";\nimport { c as y } from \"../../../../../chunks/mat4f64.js\";\nimport { s as j, g as v, i as w } from \"../../../../../chunks/vec3.js\";\nimport { c as O } from \"../../../../../chunks/vec3f64.js\";\nimport { g as E } from \"../../../../../chunks/sphere.js\";\nimport { c as x } from \"../../../../../chunks/vec33.js\";\nimport { VertexPosition as R } from \"../../core/shaderLibrary/attributes/VertexPosition.glsl.js\";\nimport { TwoVectorPosition as M } from \"../../core/util/TwoVectorPosition.js\";\nimport { GridLocalOriginFactory as T } from \"../GridLocalOriginFactory.js\";\nimport { applyToModelMatrix as C } from \"../localOriginHelper.js\";\nimport { LocalOriginManager as k } from \"../LocalOriginManager.js\";\nimport { Object3D as P } from \"../Object3D.js\";\nimport { VertexLayout as B, EdgeShaderAttributeLocations as D, glVertexLayout as L, EdgeInputBufferLayout as V } from \"./bufferLayouts.js\";\nimport { RegularEdgeBufferWriter as A, SilhouetteEdgeBufferWriter as U } from \"./edgeBufferWriters.js\";\nimport { EdgeRenderer as S, LINE_WIDTH_FRACTION_FACTOR as H, EXTENSION_LENGTH_OFFSET as I } from \"./EdgeRenderer.js\";\nimport z from \"./EdgeWorkerHandle.js\";\nimport { generateStrokesTexture as F } from \"./strokes.js\";\nimport { determineRendererType as _, estimateLengthAtDistance as G, determineEdgeTransparency as K, determineObjectTransparency as q, fillComponenBufferIndices as N, computeEdgeCount as W } from \"./util.js\";\nimport { BufferManager as Y } from \"../TextureBackedBuffer/BufferManager.js\";\nimport { WatchUpdatingTracking as J } from \"../../../../support/WatchUpdatingTracking.js\";\nimport Q from \"../../../../webgl/BufferObject.js\";\nimport X from \"../../../../webgl/VertexArrayObject.js\";\nconst Z = s.getLogger(\"esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView\");\nlet $ = class extends t {\n  constructor(e) {\n    super(e), this.updatingHandles = new J(), this.perObjectData = new Map(), this.renderers = new Map(), this.numberOfRenderedEdges = 0, this.gpuMemoryUsage = 0, this.workerAbort = d(), this.tmpModelPosition = O(), this.tmpCameraPosition = O(), this.localOrigins = new k(new T(e.renderSR));\n  }\n\n  initialize() {\n    this.worker = new z(this.schedule), this.componentColorManager = new Y(this.rctx, 2);\n    const e = B.createBuffer(4);\n\n    for (let t = 0; t < 4; t++) e.sideness.set(t, 0, 0 === t || 3 === t ? 0 : 1), e.sideness.set(t, 1, 0 === t || 1 === t ? 0 : 1);\n\n    this.verticesBufferObject = Q.createVertex(this.rctx, 35044, e.buffer);\n  }\n\n  destroy() {\n    this.destroyed || (this.perObjectData.forEach(e => this._discardObjectEntry(e)), this.perObjectData.clear(), this.strokesTexture = i(this.strokesTexture), this.componentColorManager = n(this.componentColorManager), this.workerAbort.abort(), this.worker.destroy(), this.verticesBufferObject = i(this.verticesBufferObject), this.renderers.clear(), this.updatingHandles.destroy());\n  }\n\n  get updating() {\n    return this.updatingHandles.updating;\n  }\n\n  get usedMemory() {\n    return this.gpuMemoryUsage;\n  }\n\n  get numberOfRenderedPrimitives() {\n    return this.numberOfRenderedEdges;\n  }\n\n  shouldRender() {\n    return this.renderers.size > 0;\n  }\n\n  async addComponentObject(e, t, r, s, o, i, n, a) {\n    if (this.hasObject(e)) return;\n    let c;\n    const d = new re(new Promise(e => c = e), r);\n    this.perObjectData.set(e, d), await this.updatingHandles.addPromise(this.addComponentGeometry(t, d, s, o, i, n, a)), this.setNeedsRender(), c();\n  }\n\n  async addOrUpdateObject3D(e, t, r, s) {\n    if (this.destroyed) return void Z.warn(\"Attempt to add an object to a destroyed instance\");\n    const o = this.perObjectData.get(e);\n    let i;\n    const n = new re(new Promise(e => i = e));\n    this.perObjectData.set(e, n);\n    const a = new Array();\n    if (r.mergeGeometries && e.geometries.length > 1 && te(e)) a.push(this.addObjectMergedGeometries(e, n, t, r, s));else for (let c = 0; c < e.geometries.length; c++) {\n      const o = e.geometries[c],\n            i = e.geometryRecords[c];\n      i.material.supportsEdges && a.push(this.addGeometry(e, n, o, i, t[0], r, s));\n    }\n    await this.updatingHandles.addPromise(Promise.all(a)), this._discardObjectEntry(o), this.setNeedsRender(), i();\n  }\n\n  _discardObjectEntry(e) {\n    e && (e.renderables.length && (e.renderables.forEach(e => this.removeRenderable(e)), this.setNeedsRender()), e.loaded = null);\n  }\n\n  hasObject(e) {\n    return this.perObjectData.has(e);\n  }\n\n  async updateAllComponentOpacities(e, t) {\n    const r = t instanceof Array ? e => t[e] : () => t;\n    (await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach(e => {\n      const t = e.components.meta.length;\n\n      for (let s = 0; s < t; s++) {\n        const t = r(s),\n              o = e.components.meta[s],\n              i = o.index;\n        o.material.opacity = t, e.components.buffer.textureBuffer.setDataElement(i, 1, 3, 255 * t);\n      }\n\n      this.updateTransparency(e);\n    }), this.setNeedsRender();\n  }\n\n  async updateAllComponentMaterials(e, t, r, s) {\n    const o = e instanceof P,\n          i = !!r.slicePlaneEnabled,\n          n = _(t),\n          a = S.getKey(n, i, o);\n\n    (await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach(e => {\n      if (a !== e.rendererKey) {\n        const t = this.renderers.get(e.rendererKey),\n              r = this.acquireRenderer(n, i, o);\n        t.removeRenderable(e), t.refCount.decrement(), e.rendererKey = a, r.addRenderable(e);\n      }\n\n      for (let r = 0; r < t.length; r++) e.components.meta[r].material = t[r];\n\n      s && this.updateComponentBuffer(e.components), this.updateTransparency(e);\n    }), this.setNeedsRender();\n  }\n\n  async updateObjectVisibility(e, t) {\n    (await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach(e => e.visible = t), this.setNeedsRender();\n  }\n\n  removeObject(e) {\n    const t = this.perObjectData.get(e);\n    t && (this.perObjectData.delete(e), this._discardObjectEntry(t));\n  }\n\n  async getObjectEntry(e) {\n    const t = this.perObjectData.get(e);\n    if (!t) throw \"no object\";\n    return await t.loaded, t;\n  }\n\n  removeAll() {\n    this.perObjectData.forEach((e, t) => this.removeObject(t));\n  }\n\n  render(e, t) {\n    if (a(this.componentColorManager)) return;\n    this.localOrigins.updateViewMatrices(e.camera.viewMatrix);\n    const r = e.camera.viewInverseTransposeMatrix,\n          s = O(),\n          o = new M(),\n          i = new R.ViewProjectionTransform(),\n          n = f();\n    j(s, r[3], r[7], r[11]), o.set(s), v(i.worldFromView_TH, o.high), v(i.worldFromView_TL, o.low), u(i.viewFromCameraRelative_RS, e.camera.viewMatrix), b(i.projFromView, e.camera.projectionMatrix);\n    const c = f();\n    h(c, i.viewFromCameraRelative_RS), p(n, c);\n    let d = 0,\n        l = 0;\n    if (this.renderers.forEach(e => {\n      0 === e.refCount.value ? (this.renderers.delete(e.key), e.dispose()) : e.forEachRenderable(e => {\n        d += e.statistics.averageEdgeLength, l++;\n      }, t);\n    }), this.componentColorManager.garbageCollect(), this.componentColorManager.updateTextures(), 0 === l) return;\n    const m = {\n      distanceFalloffFactor: 40 * d / l,\n      minimumEdgeLength: G(e.camera.fullViewport[3], e.camera.fovY, 1, 3.5 * e.camera.pixelRatio),\n      transparency: t,\n      viewProjectionTransform: i,\n      transformNormal_ViewFromGlobal: n\n    };\n    this.updateObjectCameraDistances(e), this.numberOfRenderedEdges = 0, this.renderers.forEach(t => {\n      this.renderRegularEdges(t, e, m), this.renderSilhouetteEdges(t, e, m);\n    });\n  }\n\n  updateTransparency(e) {\n    const t = K(e.components.meta),\n          r = q(e.components.meta);\n    t === e.edgeTransparency && r === e.objectTransparency || (e.edgeTransparency = t, e.objectTransparency = r, this.renderers.get(e.rendererKey).setRenderablesDirty());\n  }\n\n  computeModelTransformWithLocalOrigin(e, t, r) {\n    if (e.getCombinedStaticTransformation(t, r), c(t.origin)) this.localOrigins.register(t.origin);else {\n      const e = j(this.tmpModelPosition, r[12], r[13], r[14]);\n      t.origin = this.localOrigins.acquire(e);\n    }\n    return C(t.origin.vec3, r), t.origin;\n  }\n\n  updateComponentBuffer(e) {\n    const {\n      meta: t,\n      buffer: r\n    } = e;\n\n    for (let s = 0; s < t.length; s++) {\n      const e = t[s].material,\n            i = t[s].index,\n            n = o(Math.round(e.size * H), 0, 255),\n            a = o(e.extensionLength, -I, 255 - I) + I,\n            c = \"solid\" === e.type ? 0 : 1,\n            d = 255 * e.opacity,\n            l = e.color,\n            m = 255 * l[0],\n            g = 255 * l[1],\n            u = 255 * l[2],\n            h = 255 * l[3];\n      r.textureBuffer.setData(i, 0, m, g, u, h), r.textureBuffer.setData(i, 1, n, a, c, d);\n    }\n  }\n\n  createComponentBuffers(e) {\n    if (a(this.componentColorManager)) return null;\n    const t = new Array(),\n          r = this.componentColorManager.getBuffer(e.length);\n\n    for (let o = 0; o < e.length; o++) {\n      const s = e[o],\n            i = r.acquireIndex();\n      t.push({\n        index: i,\n        material: s\n      });\n    }\n\n    const s = {\n      meta: t,\n      buffer: r\n    };\n    return this.updateComponentBuffer(s), s;\n  }\n\n  extractEdges(e, t, r, s, o, i = o.length) {\n    return this.worker.process({\n      data: t,\n      indices: o,\n      indicesLength: i,\n      writerSettings: e,\n      skipDeduplicate: r\n    }, this.workerAbort.signal, s);\n  }\n\n  createEdgeResources(e) {\n    const t = {};\n    if (a(this.verticesBufferObject)) return t;\n\n    if (e.regular.lodInfo.lengths.length > 0) {\n      const r = new X(this.rctx, D, {\n        vertices: L,\n        instances: A.glLayout\n      }, {\n        vertices: this.verticesBufferObject,\n        instances: Q.createVertex(this.rctx, 35044, e.regular.instancesData.buffer)\n      });\n      t.regular = {\n        vao: r,\n        lod: e.regular.lodInfo\n      };\n    }\n\n    if (e.silhouette.lodInfo.lengths.length > 0) {\n      const r = new X(this.rctx, D, {\n        vertices: L,\n        instances: U.glLayout\n      }, {\n        vertices: this.verticesBufferObject,\n        instances: Q.createVertex(this.rctx, 35044, e.silhouette.instancesData.buffer)\n      });\n      t.silhouette = {\n        vao: r,\n        lod: e.silhouette.lodInfo\n      };\n    }\n\n    return t;\n  }\n\n  async addGeometry(e, t, r, s, o, i, n) {\n    const a = r.vertexAttributes.get(\"position\"),\n          c = r.indices.get(\"position\"),\n          d = y(),\n          l = {\n      position: a,\n      indices: c,\n      modelTransform: d,\n      origin: this.computeModelTransformWithLocalOrigin(e, s, d)\n    };\n    return this.addPositionData(t, l, r.edgeIndicesLength, o, i, n);\n  }\n\n  async addPositionData(e, t, r, s, o, i = !1) {\n    if (null == e.loaded) return;\n    const n = this.createComponentBuffers([s]);\n    if (a(n) || r <= 0) return;\n    const c = this.acquireRenderer(s.type, !!o.slicePlaneEnabled),\n          {\n      modelTransform: d,\n      origin: l\n    } = t,\n          m = t.indices,\n          g = t.position,\n          u = g.data.length / g.size,\n          h = V.createBuffer(u);\n\n    for (let a = 0; a < u; a++) h.position.set(a, 0, g.data[a * g.size + 0]), h.position.set(a, 1, g.data[a * g.size + 1]), h.position.set(a, 2, g.data[a * g.size + 2]);\n\n    N(n.meta, [0, h.componentIndex.count], h.componentIndex);\n    const p = await this.updatingHandles.addPromise(this.extractEdges(c.writerSettings, h, !1, i, m, r));\n    if (null == e.loaded) return;\n    const {\n      regular: f,\n      silhouette: b\n    } = this.createEdgeResources(p),\n          y = (f ? f.vao.size : 0) + (b ? b.vao.size : 0),\n          j = {\n      regular: f,\n      silhouette: b,\n      transform: {\n        modelMatrix: d,\n        origin: l\n      },\n      statistics: {\n        gpuMemoryUsage: y,\n        averageEdgeLength: p.averageEdgeLength\n      },\n      components: n,\n      visible: !0,\n      edgeTransparency: K(n.meta),\n      objectTransparency: q(n.meta),\n      distanceToCamera: 0,\n      rendererKey: c.key\n    };\n    e.renderables.push(j), c.addRenderable(j), this.gpuMemoryUsage += y;\n  }\n\n  async addComponentGeometry(e, t, r, s, o, i, n) {\n    if (null == t.loaded) return;\n    const c = this.createComponentBuffers(i);\n    if (a(c)) return;\n\n    const d = _(i),\n          l = this.acquireRenderer(d, n.slicePlaneEnabled || !1, !1),\n          m = V.createBuffer(r.count);\n\n    x(m.position, r), N(c.meta, o, m.componentIndex, s);\n    const g = !0,\n          u = l.writerSettings,\n          h = await this.updatingHandles.addPromise(this.extractEdges(u, m, g, !1, s));\n    if (null == t.loaded) return;\n    const {\n      regular: p,\n      silhouette: f\n    } = this.createEdgeResources(h),\n          b = (p ? p.vao.size : 0) + (f ? f.vao.size : 0),\n          y = {\n      regular: p,\n      silhouette: f,\n      transform: e,\n      statistics: {\n        gpuMemoryUsage: b,\n        averageEdgeLength: h.averageEdgeLength\n      },\n      components: c,\n      visible: !0,\n      edgeTransparency: K(c.meta),\n      objectTransparency: q(c.meta),\n      distanceToCamera: 0,\n      rendererKey: l.key\n    };\n    t.renderables.push(y), l.addRenderable(y), this.gpuMemoryUsage += b;\n  }\n\n  async addObjectMergedGeometries(e, t, r, s, o) {\n    const i = new Map();\n    let n = 0,\n        a = null,\n        c = null;\n\n    for (let b = 0; b < e.geometries.length; b++) {\n      const t = e.geometries[b],\n            r = e.geometryRecords[b];\n      if (!r.material.supportsEdges) continue;\n      !c && r.origin && (c = r);\n      const s = t.indices.get(\"position\");\n      n += t.edgeIndicesLength, null != a && a !== Uint16Array || (a = l(s) ? Uint16Array : Uint32Array);\n    }\n\n    const d = n ? new a(n) : null,\n          m = [];\n    let g = 0;\n\n    for (let l = 0; l < e.geometries.length; l++) {\n      const t = e.geometries[l];\n      if (!e.geometryRecords[l].material.supportsEdges) continue;\n      const r = t.vertexAttributes.get(\"position\"),\n            s = t.indices.get(\"position\");\n      let o = i.get(r.data);\n\n      if (null == o) {\n        o = m.length / 3;\n\n        for (let e = 0; e < r.data.length; e += r.size) m.push(r.data[e + 0]), m.push(r.data[e + 1]), m.push(r.data[e + 2]);\n\n        i.set(r.data, o);\n      }\n\n      if (s) for (let e = 0; e < t.edgeIndicesLength; e++) d[g++] = o + s[e];\n    }\n\n    const u = c || e.geometryRecords[0],\n          h = y(),\n          p = this.computeModelTransformWithLocalOrigin(e, u, h);\n\n    for (let l = 0; l < e.geometryRecords.length; l++) e.geometryRecords[l].origin = p;\n\n    const f = {\n      position: {\n        data: m,\n        size: 3\n      },\n      indices: d,\n      modelTransform: h,\n      origin: p\n    };\n    await this.updatingHandles.addPromise(this.addPositionData(t, f, d.length, r[0], s, o));\n  }\n\n  acquireRenderer(e, t, r = !0) {\n    const s = S.getKey(e, t, r);\n    let o = this.renderers.get(s);\n    return a(this.strokesTexture) && (this.strokesTexture = F(this.rctx)), o || (o = new S(this.rctx, this.techniqueRepository, {\n      type: e,\n      slicePlaneEnabled: t,\n      strokesTexture: this.strokesTexture,\n      legacy: r\n    }), this.renderers.set(s, o)), o.refCount.increment(), o;\n  }\n\n  removeRenderable(e) {\n    ee(e);\n    const t = this.renderers.get(e.rendererKey);\n\n    if (t) {\n      t.removeRenderable(e), t.refCount.decrement(), \"origin\" in e.transform && this.localOrigins.release(e.transform.origin), this.gpuMemoryUsage -= e.statistics.gpuMemoryUsage;\n\n      for (const t of e.components.meta) e.components.buffer.releaseIndex(t.index);\n    }\n  }\n\n  updateObjectCameraDistances(e) {\n    const t = e.camera.viewInverseTransposeMatrix;\n    j(this.tmpCameraPosition, t[3], t[7], t[11]), this.perObjectData.forEach((e, t) => {\n      const r = c(e.center) ? e.center : E(t.boundingVolumeWorldSpace.bounds),\n            s = w(r, this.tmpCameraPosition);\n      e.renderables.forEach(e => e.distanceToCamera = s);\n    });\n  }\n\n  renderRegularEdges(e, t, r) {\n    e.bindRegularEdges(t, r);\n    const s = r.transparency;\n    e.forEachRenderable(s => {\n      if (!s.visible || !s.regular) return;\n      const o = W(s.regular.lod.lengths, s.distanceToCamera, r);\n      \"origin\" in s.transform && (t.localViewMatrixForEdges = this.localOrigins.getViewMatrix(s.transform.origin)), e.renderRegularEdges(s, t, o), this.numberOfRenderedEdges += o;\n    }, s);\n  }\n\n  renderSilhouetteEdges(e, t, r) {\n    e.bindSilhouetteEdges(t, r);\n    const s = r.transparency;\n    e.forEachRenderable(s => {\n      if (!s.visible || !s.silhouette) return;\n      const o = W(s.silhouette.lod.lengths, s.distanceToCamera, r);\n      \"origin\" in s.transform && (t.localViewMatrixForEdges = this.localOrigins.getViewMatrix(s.transform.origin)), e.renderSilhouetteEdges(s, t, o), this.numberOfRenderedEdges += o;\n    }, s);\n  }\n\n};\n\nfunction ee(e) {\n  e.regular && (e.regular.vao.vertexBuffers.instances.dispose(), e.regular.vao.dispose(!1), e.regular.vao = null), e.silhouette && (e.silhouette.vao.vertexBuffers.instances.dispose(), e.silhouette.vao.dispose(!1), e.silhouette.vao = null);\n}\n\nfunction te(e) {\n  let t = null,\n      s = null;\n\n  for (let i = 0; i < e.geometries.length; i++) {\n    var o;\n    const n = e.geometryRecords[i];\n\n    if (n.material.supportsEdges) {\n      if (t) {\n        if (!r(t, n.transformation)) return !1;\n      } else t = n.transformation;\n\n      if (!s && c(n.origin)) s = n;else if (c(null == (o = s) ? void 0 : o.origin) && c(n.origin) && s.origin.id !== n.origin.id) return !1;\n    }\n  }\n\n  return !0;\n}\n\ne([m({\n  constructOnly: !0\n})], $.prototype, \"rctx\", void 0), e([m({\n  constructOnly: !0\n})], $.prototype, \"renderSR\", void 0), e([m({\n  constructOnly: !0\n})], $.prototype, \"techniqueRepository\", void 0), e([m({\n  constructOnly: !0\n})], $.prototype, \"setNeedsRender\", void 0), e([m({\n  constructOnly: !0\n})], $.prototype, \"schedule\", void 0), e([m({\n  readOnly: !0\n})], $.prototype, \"updatingHandles\", void 0), e([m({\n  readOnly: !0\n})], $.prototype, \"updating\", null), $ = e([g(\"esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView\")], $);\n\nclass re {\n  constructor(e, t = null) {\n    this.center = t, this.renderables = new Array(), this.loaded = e, this.loaded.then(() => {\n      null != this.loaded && (this.loaded = !0);\n    });\n  }\n\n}\n\nexport { $ as EdgeView };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/webgl-engine/lib/edgeRendering/EdgeView.js"],"names":["_","e","t","equals","r","s","clamp","o","disposeMaybe","i","destroyMaybe","n","isNone","a","isSome","c","createAbortController","d","isUint16Array","l","property","m","subclass","g","f","u","h","p","b","y","j","v","w","O","E","x","VertexPosition","R","TwoVectorPosition","M","GridLocalOriginFactory","T","applyToModelMatrix","C","LocalOriginManager","k","Object3D","P","VertexLayout","B","EdgeShaderAttributeLocations","D","glVertexLayout","L","EdgeInputBufferLayout","V","RegularEdgeBufferWriter","A","SilhouetteEdgeBufferWriter","U","EdgeRenderer","S","LINE_WIDTH_FRACTION_FACTOR","H","EXTENSION_LENGTH_OFFSET","I","z","generateStrokesTexture","F","determineRendererType","estimateLengthAtDistance","G","determineEdgeTransparency","K","determineObjectTransparency","q","fillComponenBufferIndices","N","computeEdgeCount","W","BufferManager","Y","WatchUpdatingTracking","J","Q","X","Z","getLogger","$","constructor","updatingHandles","perObjectData","Map","renderers","numberOfRenderedEdges","gpuMemoryUsage","workerAbort","tmpModelPosition","tmpCameraPosition","localOrigins","renderSR","initialize","worker","schedule","componentColorManager","rctx","createBuffer","sideness","set","verticesBufferObject","createVertex","buffer","destroy","destroyed","forEach","_discardObjectEntry","clear","strokesTexture","abort","updating","usedMemory","numberOfRenderedPrimitives","shouldRender","size","addComponentObject","hasObject","re","Promise","addPromise","addComponentGeometry","setNeedsRender","addOrUpdateObject3D","warn","get","Array","mergeGeometries","geometries","length","te","push","addObjectMergedGeometries","geometryRecords","material","supportsEdges","addGeometry","all","renderables","removeRenderable","loaded","has","updateAllComponentOpacities","getObjectEntry","components","meta","index","opacity","textureBuffer","setDataElement","updateTransparency","updateAllComponentMaterials","slicePlaneEnabled","getKey","rendererKey","acquireRenderer","refCount","decrement","addRenderable","updateComponentBuffer","updateObjectVisibility","visible","removeObject","delete","removeAll","render","updateViewMatrices","camera","viewMatrix","viewInverseTransposeMatrix","ViewProjectionTransform","worldFromView_TH","high","worldFromView_TL","low","viewFromCameraRelative_RS","projFromView","projectionMatrix","value","key","dispose","forEachRenderable","statistics","averageEdgeLength","garbageCollect","updateTextures","distanceFalloffFactor","minimumEdgeLength","fullViewport","fovY","pixelRatio","transparency","viewProjectionTransform","transformNormal_ViewFromGlobal","updateObjectCameraDistances","renderRegularEdges","renderSilhouetteEdges","edgeTransparency","objectTransparency","setRenderablesDirty","computeModelTransformWithLocalOrigin","getCombinedStaticTransformation","origin","register","acquire","vec3","Math","round","extensionLength","type","color","setData","createComponentBuffers","getBuffer","acquireIndex","extractEdges","process","data","indices","indicesLength","writerSettings","skipDeduplicate","signal","createEdgeResources","regular","lodInfo","lengths","vertices","instances","glLayout","instancesData","vao","lod","silhouette","vertexAttributes","position","modelTransform","addPositionData","edgeIndicesLength","componentIndex","count","transform","modelMatrix","distanceToCamera","Uint16Array","Uint32Array","techniqueRepository","legacy","increment","ee","release","releaseIndex","center","boundingVolumeWorldSpace","bounds","bindRegularEdges","localViewMatrixForEdges","getViewMatrix","bindSilhouetteEdges","vertexBuffers","transformation","id","constructOnly","prototype","readOnly","then","EdgeView"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../../chunks/tslib.es6.js\";import t from\"../../../../../core/Accessor.js\";import{equals as r}from\"../../../../../core/arrayUtils.js\";import s from\"../../../../../core/Logger.js\";import{clamp as o}from\"../../../../../core/mathUtils.js\";import{disposeMaybe as i,destroyMaybe as n,isNone as a,isSome as c}from\"../../../../../core/maybe.js\";import{createAbortController as d}from\"../../../../../core/promiseUtils.js\";import{isUint16Array as l}from\"../../../../../core/typedArrayUtil.js\";import{property as m}from\"../../../../../core/accessorSupport/decorators/property.js\";import\"../../../../../core/has.js\";import\"../../../../../core/accessorSupport/ensureType.js\";import{subclass as g}from\"../../../../../core/accessorSupport/decorators/subclass.js\";import{f as u,t as h,e as p}from\"../../../../../chunks/mat3.js\";import{c as f}from\"../../../../../chunks/mat3f64.js\";import{d as b}from\"../../../../../chunks/mat4.js\";import{c as y}from\"../../../../../chunks/mat4f64.js\";import{s as j,g as v,i as w}from\"../../../../../chunks/vec3.js\";import{c as O}from\"../../../../../chunks/vec3f64.js\";import{g as E}from\"../../../../../chunks/sphere.js\";import{c as x}from\"../../../../../chunks/vec33.js\";import{VertexPosition as R}from\"../../core/shaderLibrary/attributes/VertexPosition.glsl.js\";import{TwoVectorPosition as M}from\"../../core/util/TwoVectorPosition.js\";import{GridLocalOriginFactory as T}from\"../GridLocalOriginFactory.js\";import{applyToModelMatrix as C}from\"../localOriginHelper.js\";import{LocalOriginManager as k}from\"../LocalOriginManager.js\";import{Object3D as P}from\"../Object3D.js\";import{VertexLayout as B,EdgeShaderAttributeLocations as D,glVertexLayout as L,EdgeInputBufferLayout as V}from\"./bufferLayouts.js\";import{RegularEdgeBufferWriter as A,SilhouetteEdgeBufferWriter as U}from\"./edgeBufferWriters.js\";import{EdgeRenderer as S,LINE_WIDTH_FRACTION_FACTOR as H,EXTENSION_LENGTH_OFFSET as I}from\"./EdgeRenderer.js\";import z from\"./EdgeWorkerHandle.js\";import{generateStrokesTexture as F}from\"./strokes.js\";import{determineRendererType as _,estimateLengthAtDistance as G,determineEdgeTransparency as K,determineObjectTransparency as q,fillComponenBufferIndices as N,computeEdgeCount as W}from\"./util.js\";import{BufferManager as Y}from\"../TextureBackedBuffer/BufferManager.js\";import{WatchUpdatingTracking as J}from\"../../../../support/WatchUpdatingTracking.js\";import Q from\"../../../../webgl/BufferObject.js\";import X from\"../../../../webgl/VertexArrayObject.js\";const Z=s.getLogger(\"esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView\");let $=class extends t{constructor(e){super(e),this.updatingHandles=new J,this.perObjectData=new Map,this.renderers=new Map,this.numberOfRenderedEdges=0,this.gpuMemoryUsage=0,this.workerAbort=d(),this.tmpModelPosition=O(),this.tmpCameraPosition=O(),this.localOrigins=new k(new T(e.renderSR))}initialize(){this.worker=new z(this.schedule),this.componentColorManager=new Y(this.rctx,2);const e=B.createBuffer(4);for(let t=0;t<4;t++)e.sideness.set(t,0,0===t||3===t?0:1),e.sideness.set(t,1,0===t||1===t?0:1);this.verticesBufferObject=Q.createVertex(this.rctx,35044,e.buffer)}destroy(){this.destroyed||(this.perObjectData.forEach((e=>this._discardObjectEntry(e))),this.perObjectData.clear(),this.strokesTexture=i(this.strokesTexture),this.componentColorManager=n(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=i(this.verticesBufferObject),this.renderers.clear(),this.updatingHandles.destroy())}get updating(){return this.updatingHandles.updating}get usedMemory(){return this.gpuMemoryUsage}get numberOfRenderedPrimitives(){return this.numberOfRenderedEdges}shouldRender(){return this.renderers.size>0}async addComponentObject(e,t,r,s,o,i,n,a){if(this.hasObject(e))return;let c;const d=new re(new Promise((e=>c=e)),r);this.perObjectData.set(e,d),await this.updatingHandles.addPromise(this.addComponentGeometry(t,d,s,o,i,n,a)),this.setNeedsRender(),c()}async addOrUpdateObject3D(e,t,r,s){if(this.destroyed)return void Z.warn(\"Attempt to add an object to a destroyed instance\");const o=this.perObjectData.get(e);let i;const n=new re(new Promise((e=>i=e)));this.perObjectData.set(e,n);const a=new Array;if(r.mergeGeometries&&e.geometries.length>1&&te(e))a.push(this.addObjectMergedGeometries(e,n,t,r,s));else for(let c=0;c<e.geometries.length;c++){const o=e.geometries[c],i=e.geometryRecords[c];i.material.supportsEdges&&a.push(this.addGeometry(e,n,o,i,t[0],r,s))}await this.updatingHandles.addPromise(Promise.all(a)),this._discardObjectEntry(o),this.setNeedsRender(),i()}_discardObjectEntry(e){e&&(e.renderables.length&&(e.renderables.forEach((e=>this.removeRenderable(e))),this.setNeedsRender()),e.loaded=null)}hasObject(e){return this.perObjectData.has(e)}async updateAllComponentOpacities(e,t){const r=t instanceof Array?e=>t[e]:()=>t;(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>{const t=e.components.meta.length;for(let s=0;s<t;s++){const t=r(s),o=e.components.meta[s],i=o.index;o.material.opacity=t,e.components.buffer.textureBuffer.setDataElement(i,1,3,255*t)}this.updateTransparency(e)})),this.setNeedsRender()}async updateAllComponentMaterials(e,t,r,s){const o=e instanceof P,i=!!r.slicePlaneEnabled,n=_(t),a=S.getKey(n,i,o);(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>{if(a!==e.rendererKey){const t=this.renderers.get(e.rendererKey),r=this.acquireRenderer(n,i,o);t.removeRenderable(e),t.refCount.decrement(),e.rendererKey=a,r.addRenderable(e)}for(let r=0;r<t.length;r++)e.components.meta[r].material=t[r];s&&this.updateComponentBuffer(e.components),this.updateTransparency(e)})),this.setNeedsRender()}async updateObjectVisibility(e,t){(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>e.visible=t)),this.setNeedsRender()}removeObject(e){const t=this.perObjectData.get(e);t&&(this.perObjectData.delete(e),this._discardObjectEntry(t))}async getObjectEntry(e){const t=this.perObjectData.get(e);if(!t)throw\"no object\";return await t.loaded,t}removeAll(){this.perObjectData.forEach(((e,t)=>this.removeObject(t)))}render(e,t){if(a(this.componentColorManager))return;this.localOrigins.updateViewMatrices(e.camera.viewMatrix);const r=e.camera.viewInverseTransposeMatrix,s=O(),o=new M,i=new R.ViewProjectionTransform,n=f();j(s,r[3],r[7],r[11]),o.set(s),v(i.worldFromView_TH,o.high),v(i.worldFromView_TL,o.low),u(i.viewFromCameraRelative_RS,e.camera.viewMatrix),b(i.projFromView,e.camera.projectionMatrix);const c=f();h(c,i.viewFromCameraRelative_RS),p(n,c);let d=0,l=0;if(this.renderers.forEach((e=>{0===e.refCount.value?(this.renderers.delete(e.key),e.dispose()):e.forEachRenderable((e=>{d+=e.statistics.averageEdgeLength,l++}),t)})),this.componentColorManager.garbageCollect(),this.componentColorManager.updateTextures(),0===l)return;const m={distanceFalloffFactor:40*d/l,minimumEdgeLength:G(e.camera.fullViewport[3],e.camera.fovY,1,3.5*e.camera.pixelRatio),transparency:t,viewProjectionTransform:i,transformNormal_ViewFromGlobal:n};this.updateObjectCameraDistances(e),this.numberOfRenderedEdges=0,this.renderers.forEach((t=>{this.renderRegularEdges(t,e,m),this.renderSilhouetteEdges(t,e,m)}))}updateTransparency(e){const t=K(e.components.meta),r=q(e.components.meta);t===e.edgeTransparency&&r===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=r,this.renderers.get(e.rendererKey).setRenderablesDirty())}computeModelTransformWithLocalOrigin(e,t,r){if(e.getCombinedStaticTransformation(t,r),c(t.origin))this.localOrigins.register(t.origin);else{const e=j(this.tmpModelPosition,r[12],r[13],r[14]);t.origin=this.localOrigins.acquire(e)}return C(t.origin.vec3,r),t.origin}updateComponentBuffer(e){const{meta:t,buffer:r}=e;for(let s=0;s<t.length;s++){const e=t[s].material,i=t[s].index,n=o(Math.round(e.size*H),0,255),a=o(e.extensionLength,-I,255-I)+I,c=\"solid\"===e.type?0:1,d=255*e.opacity,l=e.color,m=255*l[0],g=255*l[1],u=255*l[2],h=255*l[3];r.textureBuffer.setData(i,0,m,g,u,h),r.textureBuffer.setData(i,1,n,a,c,d)}}createComponentBuffers(e){if(a(this.componentColorManager))return null;const t=new Array,r=this.componentColorManager.getBuffer(e.length);for(let o=0;o<e.length;o++){const s=e[o],i=r.acquireIndex();t.push({index:i,material:s})}const s={meta:t,buffer:r};return this.updateComponentBuffer(s),s}extractEdges(e,t,r,s,o,i=o.length){return this.worker.process({data:t,indices:o,indicesLength:i,writerSettings:e,skipDeduplicate:r},this.workerAbort.signal,s)}createEdgeResources(e){const t={};if(a(this.verticesBufferObject))return t;if(e.regular.lodInfo.lengths.length>0){const r=new X(this.rctx,D,{vertices:L,instances:A.glLayout},{vertices:this.verticesBufferObject,instances:Q.createVertex(this.rctx,35044,e.regular.instancesData.buffer)});t.regular={vao:r,lod:e.regular.lodInfo}}if(e.silhouette.lodInfo.lengths.length>0){const r=new X(this.rctx,D,{vertices:L,instances:U.glLayout},{vertices:this.verticesBufferObject,instances:Q.createVertex(this.rctx,35044,e.silhouette.instancesData.buffer)});t.silhouette={vao:r,lod:e.silhouette.lodInfo}}return t}async addGeometry(e,t,r,s,o,i,n){const a=r.vertexAttributes.get(\"position\"),c=r.indices.get(\"position\"),d=y(),l={position:a,indices:c,modelTransform:d,origin:this.computeModelTransformWithLocalOrigin(e,s,d)};return this.addPositionData(t,l,r.edgeIndicesLength,o,i,n)}async addPositionData(e,t,r,s,o,i=!1){if(null==e.loaded)return;const n=this.createComponentBuffers([s]);if(a(n)||r<=0)return;const c=this.acquireRenderer(s.type,!!o.slicePlaneEnabled),{modelTransform:d,origin:l}=t,m=t.indices,g=t.position,u=g.data.length/g.size,h=V.createBuffer(u);for(let a=0;a<u;a++)h.position.set(a,0,g.data[a*g.size+0]),h.position.set(a,1,g.data[a*g.size+1]),h.position.set(a,2,g.data[a*g.size+2]);N(n.meta,[0,h.componentIndex.count],h.componentIndex);const p=await this.updatingHandles.addPromise(this.extractEdges(c.writerSettings,h,!1,i,m,r));if(null==e.loaded)return;const{regular:f,silhouette:b}=this.createEdgeResources(p),y=(f?f.vao.size:0)+(b?b.vao.size:0),j={regular:f,silhouette:b,transform:{modelMatrix:d,origin:l},statistics:{gpuMemoryUsage:y,averageEdgeLength:p.averageEdgeLength},components:n,visible:!0,edgeTransparency:K(n.meta),objectTransparency:q(n.meta),distanceToCamera:0,rendererKey:c.key};e.renderables.push(j),c.addRenderable(j),this.gpuMemoryUsage+=y}async addComponentGeometry(e,t,r,s,o,i,n){if(null==t.loaded)return;const c=this.createComponentBuffers(i);if(a(c))return;const d=_(i),l=this.acquireRenderer(d,n.slicePlaneEnabled||!1,!1),m=V.createBuffer(r.count);x(m.position,r),N(c.meta,o,m.componentIndex,s);const g=!0,u=l.writerSettings,h=await this.updatingHandles.addPromise(this.extractEdges(u,m,g,!1,s));if(null==t.loaded)return;const{regular:p,silhouette:f}=this.createEdgeResources(h),b=(p?p.vao.size:0)+(f?f.vao.size:0),y={regular:p,silhouette:f,transform:e,statistics:{gpuMemoryUsage:b,averageEdgeLength:h.averageEdgeLength},components:c,visible:!0,edgeTransparency:K(c.meta),objectTransparency:q(c.meta),distanceToCamera:0,rendererKey:l.key};t.renderables.push(y),l.addRenderable(y),this.gpuMemoryUsage+=b}async addObjectMergedGeometries(e,t,r,s,o){const i=new Map;let n=0,a=null,c=null;for(let b=0;b<e.geometries.length;b++){const t=e.geometries[b],r=e.geometryRecords[b];if(!r.material.supportsEdges)continue;!c&&r.origin&&(c=r);const s=t.indices.get(\"position\");n+=t.edgeIndicesLength,null!=a&&a!==Uint16Array||(a=l(s)?Uint16Array:Uint32Array)}const d=n?new a(n):null,m=[];let g=0;for(let l=0;l<e.geometries.length;l++){const t=e.geometries[l];if(!e.geometryRecords[l].material.supportsEdges)continue;const r=t.vertexAttributes.get(\"position\"),s=t.indices.get(\"position\");let o=i.get(r.data);if(null==o){o=m.length/3;for(let e=0;e<r.data.length;e+=r.size)m.push(r.data[e+0]),m.push(r.data[e+1]),m.push(r.data[e+2]);i.set(r.data,o)}if(s)for(let e=0;e<t.edgeIndicesLength;e++)d[g++]=o+s[e]}const u=c||e.geometryRecords[0],h=y(),p=this.computeModelTransformWithLocalOrigin(e,u,h);for(let l=0;l<e.geometryRecords.length;l++)e.geometryRecords[l].origin=p;const f={position:{data:m,size:3},indices:d,modelTransform:h,origin:p};await this.updatingHandles.addPromise(this.addPositionData(t,f,d.length,r[0],s,o))}acquireRenderer(e,t,r=!0){const s=S.getKey(e,t,r);let o=this.renderers.get(s);return a(this.strokesTexture)&&(this.strokesTexture=F(this.rctx)),o||(o=new S(this.rctx,this.techniqueRepository,{type:e,slicePlaneEnabled:t,strokesTexture:this.strokesTexture,legacy:r}),this.renderers.set(s,o)),o.refCount.increment(),o}removeRenderable(e){ee(e);const t=this.renderers.get(e.rendererKey);if(t){t.removeRenderable(e),t.refCount.decrement(),\"origin\"in e.transform&&this.localOrigins.release(e.transform.origin),this.gpuMemoryUsage-=e.statistics.gpuMemoryUsage;for(const t of e.components.meta)e.components.buffer.releaseIndex(t.index)}}updateObjectCameraDistances(e){const t=e.camera.viewInverseTransposeMatrix;j(this.tmpCameraPosition,t[3],t[7],t[11]),this.perObjectData.forEach(((e,t)=>{const r=c(e.center)?e.center:E(t.boundingVolumeWorldSpace.bounds),s=w(r,this.tmpCameraPosition);e.renderables.forEach((e=>e.distanceToCamera=s))}))}renderRegularEdges(e,t,r){e.bindRegularEdges(t,r);const s=r.transparency;e.forEachRenderable((s=>{if(!s.visible||!s.regular)return;const o=W(s.regular.lod.lengths,s.distanceToCamera,r);\"origin\"in s.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(s.transform.origin)),e.renderRegularEdges(s,t,o),this.numberOfRenderedEdges+=o}),s)}renderSilhouetteEdges(e,t,r){e.bindSilhouetteEdges(t,r);const s=r.transparency;e.forEachRenderable((s=>{if(!s.visible||!s.silhouette)return;const o=W(s.silhouette.lod.lengths,s.distanceToCamera,r);\"origin\"in s.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(s.transform.origin)),e.renderSilhouetteEdges(s,t,o),this.numberOfRenderedEdges+=o}),s)}};function ee(e){e.regular&&(e.regular.vao.vertexBuffers.instances.dispose(),e.regular.vao.dispose(!1),e.regular.vao=null),e.silhouette&&(e.silhouette.vao.vertexBuffers.instances.dispose(),e.silhouette.vao.dispose(!1),e.silhouette.vao=null)}function te(e){let t=null,s=null;for(let i=0;i<e.geometries.length;i++){var o;const n=e.geometryRecords[i];if(n.material.supportsEdges){if(t){if(!r(t,n.transformation))return!1}else t=n.transformation;if(!s&&c(n.origin))s=n;else if(c(null==(o=s)?void 0:o.origin)&&c(n.origin)&&s.origin.id!==n.origin.id)return!1}}return!0}e([m({constructOnly:!0})],$.prototype,\"rctx\",void 0),e([m({constructOnly:!0})],$.prototype,\"renderSR\",void 0),e([m({constructOnly:!0})],$.prototype,\"techniqueRepository\",void 0),e([m({constructOnly:!0})],$.prototype,\"setNeedsRender\",void 0),e([m({constructOnly:!0})],$.prototype,\"schedule\",void 0),e([m({readOnly:!0})],$.prototype,\"updatingHandles\",void 0),e([m({readOnly:!0})],$.prototype,\"updating\",null),$=e([g(\"esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView\")],$);class re{constructor(e,t=null){this.center=t,this.renderables=new Array,this.loaded=e,this.loaded.then((()=>{null!=this.loaded&&(this.loaded=!0)}))}}export{$ as EdgeView};\n"]},"metadata":{},"sourceType":"module"}