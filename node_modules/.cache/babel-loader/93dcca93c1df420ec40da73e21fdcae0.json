{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../chunks/tslib.es6.js\";\nimport r from \"../../../core/Accessor.js\";\nimport t from \"../../../core/Handles.js\";\nimport s from \"../../../core/Logger.js\";\nimport { someMap as i } from \"../../../core/MapUtils.js\";\nimport { releaseMaybe as a, disposeMaybe as n, isSome as o, unwrapOr as h, isNone as l, unwrap as d } from \"../../../core/maybe.js\";\nimport u from \"../../../core/PooledArray.js\";\nimport { someSet as g } from \"../../../core/SetUtils.js\";\nimport { init as c } from \"../../../core/watchUtils.js\";\nimport { property as p } from \"../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../core/has.js\";\nimport \"../../../core/accessorSupport/ensureType.js\";\nimport { subclass as y } from \"../../../core/accessorSupport/decorators/subclass.js\";\nimport { o as m, i as _, t as f } from \"../../../chunks/mat4.js\";\nimport { a as R } from \"../../../chunks/vec2f64.js\";\nimport { f as T, c as b } from \"../../../chunks/vec3f64.js\";\nimport w from \"../support/debugFlags.js\";\nimport { Overlay as x } from \"./Overlay.js\";\nimport { OverlayFramebufferObject as v } from \"./OverlayFramebufferObject.js\";\nimport { OverlayRenderTarget as O } from \"./OverlayRenderTarget.js\";\nimport { ShaderTechniqueRepository as C } from \"../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository.js\";\nimport { AutoDisposableMixin as j, autoDispose as L } from \"../webgl-engine/lib/AutoDisposable.js\";\nimport S from \"../webgl-engine/lib/Camera.js\";\nimport G from \"../webgl-engine/lib/GLMaterialRep.js\";\nimport { createEmptyDepthTexture as V, createQuadVAO as D } from \"../webgl-engine/lib/glUtil3D.js\";\nimport { GridLocalOriginFactory as P } from \"../webgl-engine/lib/GridLocalOriginFactory.js\";\nimport { IntersectorResult as M } from \"../webgl-engine/lib/intersectorUtils.js\";\nimport { OverlayRenderContext as A } from \"../webgl-engine/lib/RenderContext.js\";\nimport { SortedRenderGeometryRenderer as E } from \"../webgl-engine/lib/SortedRenderGeometryRenderer.js\";\nimport { TextureTechniqueConfiguration as U, TextureTechnique as W } from \"../webgl-engine/lib/TextureTechnique.js\";\nimport { AmbientLight as H } from \"../webgl-engine/lighting/Lightsources.js\";\nimport { SceneLighting as q } from \"../webgl-engine/lighting/SceneLighting.js\";\nimport { StippleTextureRepository as F } from \"../webgl-engine/materials/StippleTextureRepository.js\";\nimport { TaskPriority as B, noBudget as k } from \"../../support/Scheduler.js\";\nimport z from \"../../webgl/Texture.js\";\nimport { vertexCount as I } from \"../../webgl/Util.js\";\nconst X = s.getLogger(\"esri.views.3d.webgl-engine.lib.OverlayRenderer\");\nlet Y = class extends j(r) {\n  constructor(e) {\n    super(e), this._overlays = null, this._overlayRenderTarget = null, this._hasHighlights = !1, this._rendersOccluded = !1, this._hasWater = !1, this._lighting = new q(), this._handles = new t(), this._layerRenderers = new Map(), this._sortedLayerRenderersDirty = !1, this._sortedLayerRenderers = new u(), this._geometries = new Map(), this.globalUnitScale = 1, this.longitudeCyclical = null;\n  }\n\n  initialize() {\n    const e = this.view._stage.renderView;\n    this._rctx = e.renderingContext, this._renderContext = new A(this._rctx);\n    const r = e.waterTextureRepository;\n    this._stippleTextureRepository = new F(e.renderingContext), this._shaderTechniqueRepository = new C({\n      rctx: this._rctx,\n      viewingMode: 2,\n      stippleTextureRepository: this._stippleTextureRepository,\n      waterTextureRepository: r\n    }), this._handles.add([c(r, \"loadingState\", () => this.emitContentChanged()), c(this, \"spatialReference\", e => this._localOrigins = new P(e))]), this._materialRepository = new G(e.textureRepository, this._shaderTechniqueRepository), this._materialRepository.onMaterialChanged = e => {\n      (e.renderOccluded & ee) > 0 !== this._rendersOccluded && this.updateRendersOccluded(), this.emitContentChanged(), this.notifyChange(\"updating\");\n    }, this._lighting.groundLightingFactor = 1, this._lighting.globalFactor = 0, this._lighting.set([new H(T(1, 1, 1))]), this._bindParameters = {\n      slot: null,\n      highlightDepthTexture: V(this._rctx),\n      camera: N,\n      inverseViewport: R(),\n      origin: null,\n      screenToWorldRatio: null,\n      screenToWorldRatioGlobalWM: null,\n      shadowMappingEnabled: !1,\n      slicePlane: null,\n      ssaoEnabled: !1,\n      hasOccludees: !1,\n      linearDepthTexture: null,\n      lastFrameColorTexture: null,\n      reprojectionMat: null,\n      ssrEnabled: !1,\n      lighting: this._lighting,\n      transparencyPassType: 3,\n      terrainLinearDepthTexture: null,\n      geometryLinearDepthTexture: null,\n      multipassTerrainEnabled: !1,\n      cullAboveGround: !1,\n      multipassGeometryEnabled: !1,\n      highlightColorTexture: null\n    }, this._handles.add(this.view.resourceController.scheduler.registerTask(B.STAGE, this));\n  }\n\n  dispose() {\n    this._handles.destroy(), this._layerRenderers.forEach(e => e.dispose()), this._layerRenderers.clear(), this._debugTextureTechnique = a(this._debugTextureTechnique), this._debugPatternTexture = n(this._debugPatternTexture), this._bindParameters.highlightDepthTexture = n(this._bindParameters.highlightDepthTexture), this._shaderTechniqueRepository = n(this._shaderTechniqueRepository), this._temporaryFBO = n(this._temporaryFBO), this._quadVAO = n(this._quadVAO), this._overlayRenderTarget = n(this._overlayRenderTarget);\n  }\n\n  get updating() {\n    return this._sortedLayerRenderersDirty || i(this._layerRenderers, e => e.updating);\n  }\n\n  get hasOverlays() {\n    return o(this._overlays) && o(this._overlayRenderTarget);\n  }\n\n  get gpuMemoryUsage() {\n    return o(this._overlayRenderTarget) ? this._overlayRenderTarget.gpuMemoryUsage : 0;\n  }\n\n  collectUnusedRenderTargetMemory(e) {\n    let r = !1;\n    if (o(this._overlayRenderTarget)) for (const t of this._overlayRenderTarget.renderTargets) {\n      const s = this.overlays[0].validTargets[t.type] || !this.overlays[1].validTargets[t.type];\n      r = this._overlayRenderTarget.validateUsageForTarget(s, t, e) || r;\n    }\n    return r;\n  }\n\n  get overlays() {\n    return h(this._overlays, []);\n  }\n\n  ensureDrapeTargets(e) {\n    o(this._overlays) && this._overlays.forEach(r => {\n      r.hasTargetWithoutRasterImage = g(e, e => 1 === e.drapeTargetType);\n    });\n  }\n\n  ensureDrapeSources(e) {\n    o(this._overlays) && this._overlays.forEach(r => {\n      r.hasDrapedFeatureSource = i(e, (e, r) => 1 === r.drapeSourceType), r.hasDrapedRasterSource = i(e, (e, r) => 0 === r.drapeSourceType);\n    });\n  }\n\n  ensureOverlays(e, r) {\n    l(this._overlays) && (this._overlayRenderTarget = new O(this._rctx), this._overlays = [new x(0, this._overlayRenderTarget), new x(1, this._overlayRenderTarget)]), this.ensureDrapeTargets(e), this.ensureDrapeSources(r);\n  }\n\n  disposeOverlays() {\n    o(this._overlayRenderTarget) && this._overlayRenderTarget.disposeRenderTargetMemory();\n  }\n\n  get running() {\n    return this.updating;\n  }\n\n  runTask(e, r = () => !0) {\n    let t = !1;\n\n    for (const [s, i] of this._layerRenderers) {\n      if (e.done) break;\n      r(s) && (i.commitChanges() && (t = !0, e.madeProgress()), i.isEmpty && (this._sortedLayerRenderersDirty = !0, this._layerRenderers.delete(s), this._handles.remove(s)));\n    }\n\n    this._sortedLayerRenderersDirty && (this.updateSortedLayerRenderers(), t = !0), t && (o(this._overlays) && 0 === this._layerRenderers.size && this.disposeOverlays(), this.notifyChange(\"updating\"), this.emitContentChanged(), this.updateHasHighlights(), this.updateRendersOccluded(), this.updateHasWater());\n  }\n\n  processSyncLayers() {\n    this.runTask(k, e => 1 === e.updatePolicy);\n  }\n\n  addGeometries(e, r, t) {\n    for (const s of e) l(s.origin) && (s.origin = this._localOrigins.getOrigin(s.boundingSphere)), this._geometries.set(s.id, s);\n\n    this.ensureLayerRenderer(r).add(e), 2 === t && this.notifyGraphicGeometryChanged(e, r);\n  }\n\n  removeGeometries(e, r, t) {\n    for (const i of e) this._geometries.delete(d(i.id));\n\n    const s = this._layerRenderers.get(r);\n\n    s && (s.remove(e), 2 === t && this.notifyGraphicGeometryChanged(e, r));\n  }\n\n  updateGeometries(e, r, t) {\n    const s = this._layerRenderers.get(r);\n\n    if (s) switch (s.modify(e, t), t) {\n      case 4:\n      case 2:\n        return this.notifyGraphicGeometryChanged(e, r);\n\n      case 1:\n        return this.notifyGraphicVisibilityChanged(e, r);\n    } else X.warn(\"Attempted to update geometry for nonexistent layer\");\n  }\n\n  notifyGraphicGeometryChanged(e, r) {\n    if (l(r.notifyGraphicGeometryChanged)) return;\n    let t;\n\n    for (const s of e) {\n      const e = s.graphicUid;\n      o(e) && e !== t && (r.notifyGraphicGeometryChanged(e), t = e);\n    }\n  }\n\n  notifyGraphicVisibilityChanged(e, r) {\n    if (l(r.notifyGraphicVisibilityChanged)) return;\n    let t;\n\n    for (const s of e) {\n      const e = s.graphicUid;\n      o(e) && e !== t && (r.notifyGraphicVisibilityChanged(e), t = e);\n    }\n  }\n\n  updateHighlights(e, r) {\n    const t = this._layerRenderers.get(r);\n\n    t ? t.modify(e, 8) : X.warn(\"Attempted to update highlights for nonexistent layer\");\n  }\n\n  isEmpty() {\n    return 0 === this._geometries.size && !w.OVERLAY_DRAW_DEBUG_TEXTURE;\n  }\n\n  get hasHighlights() {\n    return this._hasHighlights;\n  }\n\n  get hasWater() {\n    return this._hasWater;\n  }\n\n  get rendersOccluded() {\n    return this._rendersOccluded;\n  }\n\n  updateLogic(e) {\n    let r = !1;\n    return this._layerRenderers.forEach(t => {\n      t.updateLogic(e) && (r = !0);\n    }), r;\n  }\n\n  updateLayerOrder() {\n    this._sortedLayerRenderersDirty = !0;\n  }\n\n  drawTarget(e, r, t) {\n    const s = e.canvasGeometries;\n    if (0 === s.numViews) return !1;\n    const i = e.pixelRatio * t;\n    this._screenToWorldRatio = i * Math.abs(s.extents[0][2] - s.extents[0][0]) / Math.abs(e.viewport[2] - e.viewport[0]);\n    const a = r.renderPass;\n    if (this.isEmpty() || 5 === a && !this.hasHighlights || 3 === a && !this.hasWater) return !1;\n    if (!e.hasSomeSizedView()) return !1;\n    const n = r.fbo,\n          h = 2 * e.resolution,\n          l = e.resolution,\n          u = 1 === r.type ? 2 : 4 === r.type ? 1 : 0;\n    if (!n.isValid()) return !1;\n    n.resize(h, l);\n    const g = this._rctx;\n    if (N.pixelRatio = i || 1, this._renderContext.pass = a, this._bindParameters.screenToWorldRatio = this._screenToWorldRatio, this._bindParameters.screenToWorldRatioGlobalWM = this._screenToWorldRatio * this.globalUnitScale, e.applyViewport(this._rctx), n.bind(g), 0 === e.index && (g.setClearColor(0, 0, 0, 0), g.clearSafe(16384)), 1 === u && (this._renderContext.renderOccludedMask = ee), w.OVERLAY_DRAW_DEBUG_TEXTURE && 1 !== u) for (let o = 0; o < s.numViews; o++) this.setViewParameters(s.extents[o], e, N), this.drawDebugTexture(e.resolution, K[e.index % K.length]);\n    return this._layerRenderers.size > 0 && this._sortedLayerRenderers.forAll(({\n      layerView: r,\n      renderer: t\n    }) => {\n      if (2 === u && o(r) && 0 === r.drapeSourceType) return;\n      const i = o(r) && o(r.fullOpacity) && r.fullOpacity < 1 && 0 === a;\n      i && (this.bindTemporaryFramebuffer(this._rctx, h, l), g.clearSafe(16384));\n\n      for (let a = 0; a < s.numViews; a++) this.setViewParameters(s.extents[a], e, N), t.render(this._renderContext, this._bindParameters);\n\n      i && o(this._temporaryFBO) && (n.bind(g), this.view._stage.renderView.compositingHelper.composite(this._temporaryFBO.getTexture(), 2, d(d(r).fullOpacity), 3, e.index));\n    }), g.bindFramebuffer(null), n.generateMipMap(), this._renderContext.resetRenderOccludedMask(), !0;\n  }\n\n  bindTemporaryFramebuffer(e, r, t) {\n    l(this._temporaryFBO) && (this._temporaryFBO = new v(e, !1)), this._temporaryFBO.resize(r, t), this._temporaryFBO.bind(e);\n  }\n\n  async reloadShaders() {\n    await this._shaderTechniqueRepository.hotReload();\n  }\n\n  intersect(e, r, t) {\n    let s = 0;\n\n    this._geometries.forEach(i => {\n      if (t && !t(i)) return;\n      this.intersectRenderGeometry(i, r, 0, e, s);\n      const a = this.longitudeCyclical;\n      a && (i.boundingSphere[0] - i.boundingSphere[3] < a.min && this.intersectRenderGeometry(i, r, a.range, e, s), i.boundingSphere[0] + i.boundingSphere[3] > a.max && this.intersectRenderGeometry(i, r, -a.range, e, s)), s++;\n    });\n  }\n\n  intersectRenderGeometry(e, r, t, s, i) {\n    if (!e.instanceParameters.visible) return;\n    let a = 0;\n    o(e.transformation) && (t += e.transformation[12], a = e.transformation[13]), Q[0] = r[0] - t, Q[1] = r[1] - a, Q[2] = 1, Z[0] = r[0] - t, Z[1] = r[1] - a, Z[2] = 0, e.screenToWorldRatio = this._screenToWorldRatio, e.material.intersect(e, null, e.getShaderTransformation(), s, Q, Z, (r, t, a) => {\n      this.addIntersectionResult(a, e.material.renderPriority, i, s, e.layerUid, e.graphicUid);\n    }, e.calculateShaderTransformation, !0);\n  }\n\n  addIntersectionResult(e, r, t, s, i, a) {\n    const n = {\n      type: \"external\",\n      metadata: {\n        layerUid: i,\n        graphicUid: a\n      }\n    },\n          o = i => {\n      i.set(n, null, s.results.ground.dist, s.results.ground.normal, s.results.ground.transformation, r, null, null, e, t), i.intersector = \"OverlayRenderer\";\n    };\n\n    if ((null == s.results.min.drapedLayerOrder || r >= s.results.min.drapedLayerOrder) && (null == s.results.min.dist || s.results.ground.dist <= s.results.min.dist) && o(s.results.min), 0 !== s.options.store && (null == s.results.max.drapedLayerOrder || r < s.results.max.drapedLayerOrder) && (null == s.results.max.dist || s.results.ground.dist > s.results.max.dist) && o(s.results.max), 2 === s.options.store) {\n      const e = new M(s.ray);\n      o(e), s.results.all.push(e);\n    }\n  }\n\n  stopAnimationsAtTime(e) {\n    this._sortedLayerRenderers.forAll(r => r.renderer.stopAnimationsAtTime(e));\n  }\n\n  ensureLayerRenderer(e) {\n    let r = this._layerRenderers.get(e);\n\n    return r || (r = new E({\n      rctx: this._rctx,\n      materialRepository: this._materialRepository\n    }), this._layerRenderers.set(e, r), this._sortedLayerRenderersDirty = !0, \"fullOpacity\" in e && this._handles.add(e.watch(\"fullOpacity\", () => this.emitContentChanged()), e), this._handles.add(c(r, \"updating\", () => this.notifyChange(\"updating\")), e)), r;\n  }\n\n  updateSortedLayerRenderers() {\n    if (!this._sortedLayerRenderersDirty) return;\n    if (this._sortedLayerRenderersDirty = !1, this._sortedLayerRenderers.clear(), 0 === this._layerRenderers.size) return;\n    const e = new Set(this._layerRenderers.values());\n    this.view.allLayerViews.forEach(r => {\n      const t = r,\n            s = this._layerRenderers.get(t);\n\n      s && (this._sortedLayerRenderers.push(new J(t, s)), e.delete(s));\n    }), e.forEach(e => this._sortedLayerRenderers.push(new J(null, e)));\n  }\n\n  setViewParameters(e, r, t) {\n    t.viewport = r.viewport, m(t.projectionMatrix, 0, e[2] - e[0], 0, e[3] - e[1], t.near, t.far), _(t.viewMatrix), f(t.viewMatrix, t.viewMatrix, [-e[0], -e[1], 0]), this._renderContext.camera = t, this._bindParameters.camera = t, this._bindParameters.inverseViewport[0] = 1 / t.fullViewport[2], this._bindParameters.inverseViewport[1] = 1 / t.fullViewport[3];\n  }\n\n  emitContentChanged() {\n    this.onContentChanged && this.onContentChanged();\n  }\n\n  updateHasWater() {\n    const e = i(this._layerRenderers, e => e.hasWater);\n    e !== this._hasWater && (this._hasWater = e, this.onHasWaterChanged && this.onHasWaterChanged(e));\n  }\n\n  updateHasHighlights() {\n    const e = i(this._layerRenderers, e => e.hasHighlights);\n    e !== this._hasHighlights && (this._hasHighlights = e, this.onHasHighlightsChanged && this.onHasHighlightsChanged(this._hasHighlights));\n  }\n\n  updateRendersOccluded() {\n    const e = i(this._layerRenderers, e => e.rendersOccluded);\n    e !== this._rendersOccluded && (this._rendersOccluded = e, this.onRendersOccludedChanged && this.onRendersOccludedChanged(this.rendersOccluded));\n  }\n\n  drawDebugTexture(e, r) {\n    const t = this._rctx;\n    this.ensureDebugPatternResources(e, e);\n    const s = this._debugTextureTechnique.program;\n    t.useProgram(s), t.setPipelineState(this._debugTextureTechnique.pipeline), s.setUniform4f(\"color\", r[0], r[1], r[2], 1), s.bindTexture(this._debugPatternTexture, \"tex\"), t.bindVAO(this._quadVAO), t.drawArrays(5, 0, I(this._quadVAO, \"geometry\"));\n  }\n\n  ensureDebugPatternResources(e, r) {\n    if (this._debugPatternTexture) return;\n    const t = new Uint8Array(e * r * 4);\n    let s = 0;\n\n    for (let a = 0; a < r; a++) for (let i = 0; i < e; i++) {\n      const n = Math.floor(i / 10),\n            o = Math.floor(a / 10);\n      n < 2 || o < 2 || 10 * n > e - 20 || 10 * o > r - 20 ? (t[s++] = 255, t[s++] = 255, t[s++] = 255, t[s++] = 255) : (t[s++] = 255, t[s++] = 255, t[s++] = 255, t[s++] = 1 & n && 1 & o ? 1 & i ^ 1 & a ? 0 : 255 : 1 & n ^ 1 & o ? 0 : 128);\n    }\n\n    this._debugPatternTexture = new z(this._rctx, {\n      target: 3553,\n      pixelFormat: 6408,\n      dataType: 5121,\n      samplingMode: 9728,\n      width: e,\n      height: r\n    }, t);\n    const i = new U();\n    i.hasAlpha = !0, this._debugTextureTechnique = this._shaderTechniqueRepository.acquire(W, i), this._quadVAO = D(this._rctx);\n  }\n\n  get test() {\n    return {\n      layerRenderers: this._layerRenderers\n    };\n  }\n\n};\ne([L()], Y.prototype, \"_shaderTechniqueRepository\", void 0), e([L()], Y.prototype, \"_stippleTextureRepository\", void 0), e([p({\n  constructOnly: !0\n})], Y.prototype, \"view\", void 0), e([p()], Y.prototype, \"globalUnitScale\", void 0), e([p()], Y.prototype, \"spatialReference\", void 0), e([p({\n  type: Boolean,\n  readOnly: !0\n})], Y.prototype, \"updating\", null), Y = e([y(\"esri.views.3d.terrain.OverlayRenderer\")], Y);\n\nclass J {\n  constructor(e, r) {\n    this.layerView = e, this.renderer = r;\n  }\n\n}\n\nconst K = [[1, .5, .5], [.5, .5, 1], [.5, 1, .5]],\n      N = new S();\nN.near = 1, N.far = 1e4, N.relativeElevation = null;\nconst Q = b(),\n      Z = b(),\n      $ = -2,\n      ee = 4;\nexport { $ as DRAPED_Z, Y as OverlayRenderer, ee as overlayRenderOccludedFlag };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/terrain/OverlayRenderer.js"],"names":["_","e","r","t","s","someMap","i","releaseMaybe","a","disposeMaybe","n","isSome","o","unwrapOr","h","isNone","l","unwrap","d","u","someSet","g","init","c","property","p","subclass","y","m","f","R","T","b","w","Overlay","x","OverlayFramebufferObject","v","OverlayRenderTarget","O","ShaderTechniqueRepository","C","AutoDisposableMixin","j","autoDispose","L","S","G","createEmptyDepthTexture","V","createQuadVAO","D","GridLocalOriginFactory","P","IntersectorResult","M","OverlayRenderContext","A","SortedRenderGeometryRenderer","E","TextureTechniqueConfiguration","U","TextureTechnique","W","AmbientLight","H","SceneLighting","q","StippleTextureRepository","F","TaskPriority","B","noBudget","k","z","vertexCount","I","X","getLogger","Y","constructor","_overlays","_overlayRenderTarget","_hasHighlights","_rendersOccluded","_hasWater","_lighting","_handles","_layerRenderers","Map","_sortedLayerRenderersDirty","_sortedLayerRenderers","_geometries","globalUnitScale","longitudeCyclical","initialize","view","_stage","renderView","_rctx","renderingContext","_renderContext","waterTextureRepository","_stippleTextureRepository","_shaderTechniqueRepository","rctx","viewingMode","stippleTextureRepository","add","emitContentChanged","_localOrigins","_materialRepository","textureRepository","onMaterialChanged","renderOccluded","ee","updateRendersOccluded","notifyChange","groundLightingFactor","globalFactor","set","_bindParameters","slot","highlightDepthTexture","camera","N","inverseViewport","origin","screenToWorldRatio","screenToWorldRatioGlobalWM","shadowMappingEnabled","slicePlane","ssaoEnabled","hasOccludees","linearDepthTexture","lastFrameColorTexture","reprojectionMat","ssrEnabled","lighting","transparencyPassType","terrainLinearDepthTexture","geometryLinearDepthTexture","multipassTerrainEnabled","cullAboveGround","multipassGeometryEnabled","highlightColorTexture","resourceController","scheduler","registerTask","STAGE","dispose","destroy","forEach","clear","_debugTextureTechnique","_debugPatternTexture","_temporaryFBO","_quadVAO","updating","hasOverlays","gpuMemoryUsage","collectUnusedRenderTargetMemory","renderTargets","overlays","validTargets","type","validateUsageForTarget","ensureDrapeTargets","hasTargetWithoutRasterImage","drapeTargetType","ensureDrapeSources","hasDrapedFeatureSource","drapeSourceType","hasDrapedRasterSource","ensureOverlays","disposeOverlays","disposeRenderTargetMemory","running","runTask","done","commitChanges","madeProgress","isEmpty","delete","remove","updateSortedLayerRenderers","size","updateHasHighlights","updateHasWater","processSyncLayers","updatePolicy","addGeometries","getOrigin","boundingSphere","id","ensureLayerRenderer","notifyGraphicGeometryChanged","removeGeometries","get","updateGeometries","modify","notifyGraphicVisibilityChanged","warn","graphicUid","updateHighlights","OVERLAY_DRAW_DEBUG_TEXTURE","hasHighlights","hasWater","rendersOccluded","updateLogic","updateLayerOrder","drawTarget","canvasGeometries","numViews","pixelRatio","_screenToWorldRatio","Math","abs","extents","viewport","renderPass","hasSomeSizedView","fbo","resolution","isValid","resize","pass","applyViewport","bind","index","setClearColor","clearSafe","renderOccludedMask","setViewParameters","drawDebugTexture","K","length","forAll","layerView","renderer","fullOpacity","bindTemporaryFramebuffer","render","compositingHelper","composite","getTexture","bindFramebuffer","generateMipMap","resetRenderOccludedMask","reloadShaders","hotReload","intersect","intersectRenderGeometry","min","range","max","instanceParameters","visible","transformation","Q","Z","material","getShaderTransformation","addIntersectionResult","renderPriority","layerUid","calculateShaderTransformation","metadata","results","ground","dist","normal","intersector","drapedLayerOrder","options","store","ray","all","push","stopAnimationsAtTime","materialRepository","watch","Set","values","allLayerViews","J","projectionMatrix","near","far","viewMatrix","fullViewport","onContentChanged","onHasWaterChanged","onHasHighlightsChanged","onRendersOccludedChanged","ensureDebugPatternResources","program","useProgram","setPipelineState","pipeline","setUniform4f","bindTexture","bindVAO","drawArrays","Uint8Array","floor","target","pixelFormat","dataType","samplingMode","width","height","hasAlpha","acquire","test","layerRenderers","prototype","constructOnly","Boolean","readOnly","relativeElevation","$","DRAPED_Z","OverlayRenderer","overlayRenderOccludedFlag"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import r from\"../../../core/Accessor.js\";import t from\"../../../core/Handles.js\";import s from\"../../../core/Logger.js\";import{someMap as i}from\"../../../core/MapUtils.js\";import{releaseMaybe as a,disposeMaybe as n,isSome as o,unwrapOr as h,isNone as l,unwrap as d}from\"../../../core/maybe.js\";import u from\"../../../core/PooledArray.js\";import{someSet as g}from\"../../../core/SetUtils.js\";import{init as c}from\"../../../core/watchUtils.js\";import{property as p}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import{subclass as y}from\"../../../core/accessorSupport/decorators/subclass.js\";import{o as m,i as _,t as f}from\"../../../chunks/mat4.js\";import{a as R}from\"../../../chunks/vec2f64.js\";import{f as T,c as b}from\"../../../chunks/vec3f64.js\";import w from\"../support/debugFlags.js\";import{Overlay as x}from\"./Overlay.js\";import{OverlayFramebufferObject as v}from\"./OverlayFramebufferObject.js\";import{OverlayRenderTarget as O}from\"./OverlayRenderTarget.js\";import{ShaderTechniqueRepository as C}from\"../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository.js\";import{AutoDisposableMixin as j,autoDispose as L}from\"../webgl-engine/lib/AutoDisposable.js\";import S from\"../webgl-engine/lib/Camera.js\";import G from\"../webgl-engine/lib/GLMaterialRep.js\";import{createEmptyDepthTexture as V,createQuadVAO as D}from\"../webgl-engine/lib/glUtil3D.js\";import{GridLocalOriginFactory as P}from\"../webgl-engine/lib/GridLocalOriginFactory.js\";import{IntersectorResult as M}from\"../webgl-engine/lib/intersectorUtils.js\";import{OverlayRenderContext as A}from\"../webgl-engine/lib/RenderContext.js\";import{SortedRenderGeometryRenderer as E}from\"../webgl-engine/lib/SortedRenderGeometryRenderer.js\";import{TextureTechniqueConfiguration as U,TextureTechnique as W}from\"../webgl-engine/lib/TextureTechnique.js\";import{AmbientLight as H}from\"../webgl-engine/lighting/Lightsources.js\";import{SceneLighting as q}from\"../webgl-engine/lighting/SceneLighting.js\";import{StippleTextureRepository as F}from\"../webgl-engine/materials/StippleTextureRepository.js\";import{TaskPriority as B,noBudget as k}from\"../../support/Scheduler.js\";import z from\"../../webgl/Texture.js\";import{vertexCount as I}from\"../../webgl/Util.js\";const X=s.getLogger(\"esri.views.3d.webgl-engine.lib.OverlayRenderer\");let Y=class extends(j(r)){constructor(e){super(e),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._lighting=new q,this._handles=new t,this._layerRenderers=new Map,this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers=new u,this._geometries=new Map,this.globalUnitScale=1,this.longitudeCyclical=null}initialize(){const e=this.view._stage.renderView;this._rctx=e.renderingContext,this._renderContext=new A(this._rctx);const r=e.waterTextureRepository;this._stippleTextureRepository=new F(e.renderingContext),this._shaderTechniqueRepository=new C({rctx:this._rctx,viewingMode:2,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:r}),this._handles.add([c(r,\"loadingState\",(()=>this.emitContentChanged())),c(this,\"spatialReference\",(e=>this._localOrigins=new P(e)))]),this._materialRepository=new G(e.textureRepository,this._shaderTechniqueRepository),this._materialRepository.onMaterialChanged=e=>{(e.renderOccluded&ee)>0!==this._rendersOccluded&&this.updateRendersOccluded(),this.emitContentChanged(),this.notifyChange(\"updating\")},this._lighting.groundLightingFactor=1,this._lighting.globalFactor=0,this._lighting.set([new H(T(1,1,1))]),this._bindParameters={slot:null,highlightDepthTexture:V(this._rctx),camera:N,inverseViewport:R(),origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!1,multipassGeometryEnabled:!1,highlightColorTexture:null},this._handles.add(this.view.resourceController.scheduler.registerTask(B.STAGE,this))}dispose(){this._handles.destroy(),this._layerRenderers.forEach((e=>e.dispose())),this._layerRenderers.clear(),this._debugTextureTechnique=a(this._debugTextureTechnique),this._debugPatternTexture=n(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=n(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=n(this._shaderTechniqueRepository),this._temporaryFBO=n(this._temporaryFBO),this._quadVAO=n(this._quadVAO),this._overlayRenderTarget=n(this._overlayRenderTarget)}get updating(){return this._sortedLayerRenderersDirty||i(this._layerRenderers,(e=>e.updating))}get hasOverlays(){return o(this._overlays)&&o(this._overlayRenderTarget)}get gpuMemoryUsage(){return o(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}collectUnusedRenderTargetMemory(e){let r=!1;if(o(this._overlayRenderTarget))for(const t of this._overlayRenderTarget.renderTargets){const s=this.overlays[0].validTargets[t.type]||!this.overlays[1].validTargets[t.type];r=this._overlayRenderTarget.validateUsageForTarget(s,t,e)||r}return r}get overlays(){return h(this._overlays,[])}ensureDrapeTargets(e){o(this._overlays)&&this._overlays.forEach((r=>{r.hasTargetWithoutRasterImage=g(e,(e=>1===e.drapeTargetType))}))}ensureDrapeSources(e){o(this._overlays)&&this._overlays.forEach((r=>{r.hasDrapedFeatureSource=i(e,((e,r)=>1===r.drapeSourceType)),r.hasDrapedRasterSource=i(e,((e,r)=>0===r.drapeSourceType))}))}ensureOverlays(e,r){l(this._overlays)&&(this._overlayRenderTarget=new O(this._rctx),this._overlays=[new x(0,this._overlayRenderTarget),new x(1,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(r)}disposeOverlays(){o(this._overlayRenderTarget)&&this._overlayRenderTarget.disposeRenderTargetMemory()}get running(){return this.updating}runTask(e,r=(()=>!0)){let t=!1;for(const[s,i]of this._layerRenderers){if(e.done)break;r(s)&&(i.commitChanges()&&(t=!0,e.madeProgress()),i.isEmpty&&(this._sortedLayerRenderersDirty=!0,this._layerRenderers.delete(s),this._handles.remove(s)))}this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),t=!0),t&&(o(this._overlays)&&0===this._layerRenderers.size&&this.disposeOverlays(),this.notifyChange(\"updating\"),this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())}processSyncLayers(){this.runTask(k,(e=>1===e.updatePolicy))}addGeometries(e,r,t){for(const s of e)l(s.origin)&&(s.origin=this._localOrigins.getOrigin(s.boundingSphere)),this._geometries.set(s.id,s);this.ensureLayerRenderer(r).add(e),2===t&&this.notifyGraphicGeometryChanged(e,r)}removeGeometries(e,r,t){for(const i of e)this._geometries.delete(d(i.id));const s=this._layerRenderers.get(r);s&&(s.remove(e),2===t&&this.notifyGraphicGeometryChanged(e,r))}updateGeometries(e,r,t){const s=this._layerRenderers.get(r);if(s)switch(s.modify(e,t),t){case 4:case 2:return this.notifyGraphicGeometryChanged(e,r);case 1:return this.notifyGraphicVisibilityChanged(e,r)}else X.warn(\"Attempted to update geometry for nonexistent layer\")}notifyGraphicGeometryChanged(e,r){if(l(r.notifyGraphicGeometryChanged))return;let t;for(const s of e){const e=s.graphicUid;o(e)&&e!==t&&(r.notifyGraphicGeometryChanged(e),t=e)}}notifyGraphicVisibilityChanged(e,r){if(l(r.notifyGraphicVisibilityChanged))return;let t;for(const s of e){const e=s.graphicUid;o(e)&&e!==t&&(r.notifyGraphicVisibilityChanged(e),t=e)}}updateHighlights(e,r){const t=this._layerRenderers.get(r);t?t.modify(e,8):X.warn(\"Attempted to update highlights for nonexistent layer\")}isEmpty(){return 0===this._geometries.size&&!w.OVERLAY_DRAW_DEBUG_TEXTURE}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateLogic(e){let r=!1;return this._layerRenderers.forEach((t=>{t.updateLogic(e)&&(r=!0)})),r}updateLayerOrder(){this._sortedLayerRenderersDirty=!0}drawTarget(e,r,t){const s=e.canvasGeometries;if(0===s.numViews)return!1;const i=e.pixelRatio*t;this._screenToWorldRatio=i*Math.abs(s.extents[0][2]-s.extents[0][0])/Math.abs(e.viewport[2]-e.viewport[0]);const a=r.renderPass;if(this.isEmpty()||5===a&&!this.hasHighlights||3===a&&!this.hasWater)return!1;if(!e.hasSomeSizedView())return!1;const n=r.fbo,h=2*e.resolution,l=e.resolution,u=1===r.type?2:4===r.type?1:0;if(!n.isValid())return!1;n.resize(h,l);const g=this._rctx;if(N.pixelRatio=i||1,this._renderContext.pass=a,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToWorldRatioGlobalWM=this._screenToWorldRatio*this.globalUnitScale,e.applyViewport(this._rctx),n.bind(g),0===e.index&&(g.setClearColor(0,0,0,0),g.clearSafe(16384)),1===u&&(this._renderContext.renderOccludedMask=ee),w.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==u)for(let o=0;o<s.numViews;o++)this.setViewParameters(s.extents[o],e,N),this.drawDebugTexture(e.resolution,K[e.index%K.length]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((({layerView:r,renderer:t})=>{if(2===u&&o(r)&&0===r.drapeSourceType)return;const i=o(r)&&o(r.fullOpacity)&&r.fullOpacity<1&&0===a;i&&(this.bindTemporaryFramebuffer(this._rctx,h,l),g.clearSafe(16384));for(let a=0;a<s.numViews;a++)this.setViewParameters(s.extents[a],e,N),t.render(this._renderContext,this._bindParameters);i&&o(this._temporaryFBO)&&(n.bind(g),this.view._stage.renderView.compositingHelper.composite(this._temporaryFBO.getTexture(),2,d(d(r).fullOpacity),3,e.index))})),g.bindFramebuffer(null),n.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,r,t){l(this._temporaryFBO)&&(this._temporaryFBO=new v(e,!1)),this._temporaryFBO.resize(r,t),this._temporaryFBO.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.hotReload()}intersect(e,r,t){let s=0;this._geometries.forEach((i=>{if(t&&!t(i))return;this.intersectRenderGeometry(i,r,0,e,s);const a=this.longitudeCyclical;a&&(i.boundingSphere[0]-i.boundingSphere[3]<a.min&&this.intersectRenderGeometry(i,r,a.range,e,s),i.boundingSphere[0]+i.boundingSphere[3]>a.max&&this.intersectRenderGeometry(i,r,-a.range,e,s)),s++}))}intersectRenderGeometry(e,r,t,s,i){if(!e.instanceParameters.visible)return;let a=0;o(e.transformation)&&(t+=e.transformation[12],a=e.transformation[13]),Q[0]=r[0]-t,Q[1]=r[1]-a,Q[2]=1,Z[0]=r[0]-t,Z[1]=r[1]-a,Z[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),s,Q,Z,((r,t,a)=>{this.addIntersectionResult(a,e.material.renderPriority,i,s,e.layerUid,e.graphicUid)}),e.calculateShaderTransformation,!0)}addIntersectionResult(e,r,t,s,i,a){const n={type:\"external\",metadata:{layerUid:i,graphicUid:a}},o=i=>{i.set(n,null,s.results.ground.dist,s.results.ground.normal,s.results.ground.transformation,r,null,null,e,t),i.intersector=\"OverlayRenderer\"};if((null==s.results.min.drapedLayerOrder||r>=s.results.min.drapedLayerOrder)&&(null==s.results.min.dist||s.results.ground.dist<=s.results.min.dist)&&o(s.results.min),0!==s.options.store&&(null==s.results.max.drapedLayerOrder||r<s.results.max.drapedLayerOrder)&&(null==s.results.max.dist||s.results.ground.dist>s.results.max.dist)&&o(s.results.max),2===s.options.store){const e=new M(s.ray);o(e),s.results.all.push(e)}}stopAnimationsAtTime(e){this._sortedLayerRenderers.forAll((r=>r.renderer.stopAnimationsAtTime(e)))}ensureLayerRenderer(e){let r=this._layerRenderers.get(e);return r||(r=new E({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,r),this._sortedLayerRenderersDirty=!0,\"fullOpacity\"in e&&this._handles.add(e.watch(\"fullOpacity\",(()=>this.emitContentChanged())),e),this._handles.add(c(r,\"updating\",(()=>this.notifyChange(\"updating\"))),e)),r}updateSortedLayerRenderers(){if(!this._sortedLayerRenderersDirty)return;if(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0===this._layerRenderers.size)return;const e=new Set(this._layerRenderers.values());this.view.allLayerViews.forEach((r=>{const t=r,s=this._layerRenderers.get(t);s&&(this._sortedLayerRenderers.push(new J(t,s)),e.delete(s))})),e.forEach((e=>this._sortedLayerRenderers.push(new J(null,e))))}setViewParameters(e,r,t){t.viewport=r.viewport,m(t.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],t.near,t.far),_(t.viewMatrix),f(t.viewMatrix,t.viewMatrix,[-e[0],-e[1],0]),this._renderContext.camera=t,this._bindParameters.camera=t,this._bindParameters.inverseViewport[0]=1/t.fullViewport[2],this._bindParameters.inverseViewport[1]=1/t.fullViewport[3]}emitContentChanged(){this.onContentChanged&&this.onContentChanged()}updateHasWater(){const e=i(this._layerRenderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.onHasWaterChanged&&this.onHasWaterChanged(e))}updateHasHighlights(){const e=i(this._layerRenderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this._hasHighlights))}updateRendersOccluded(){const e=i(this._layerRenderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.onRendersOccludedChanged&&this.onRendersOccludedChanged(this.rendersOccluded))}drawDebugTexture(e,r){const t=this._rctx;this.ensureDebugPatternResources(e,e);const s=this._debugTextureTechnique.program;t.useProgram(s),t.setPipelineState(this._debugTextureTechnique.pipeline),s.setUniform4f(\"color\",r[0],r[1],r[2],1),s.bindTexture(this._debugPatternTexture,\"tex\"),t.bindVAO(this._quadVAO),t.drawArrays(5,0,I(this._quadVAO,\"geometry\"))}ensureDebugPatternResources(e,r){if(this._debugPatternTexture)return;const t=new Uint8Array(e*r*4);let s=0;for(let a=0;a<r;a++)for(let i=0;i<e;i++){const n=Math.floor(i/10),o=Math.floor(a/10);n<2||o<2||10*n>e-20||10*o>r-20?(t[s++]=255,t[s++]=255,t[s++]=255,t[s++]=255):(t[s++]=255,t[s++]=255,t[s++]=255,t[s++]=1&n&&1&o?1&i^1&a?0:255:1&n^1&o?0:128)}this._debugPatternTexture=new z(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:r},t);const i=new U;i.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(W,i),this._quadVAO=D(this._rctx)}get test(){return{layerRenderers:this._layerRenderers}}};e([L()],Y.prototype,\"_shaderTechniqueRepository\",void 0),e([L()],Y.prototype,\"_stippleTextureRepository\",void 0),e([p({constructOnly:!0})],Y.prototype,\"view\",void 0),e([p()],Y.prototype,\"globalUnitScale\",void 0),e([p()],Y.prototype,\"spatialReference\",void 0),e([p({type:Boolean,readOnly:!0})],Y.prototype,\"updating\",null),Y=e([y(\"esri.views.3d.terrain.OverlayRenderer\")],Y);class J{constructor(e,r){this.layerView=e,this.renderer=r}}const K=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],N=new S;N.near=1,N.far=1e4,N.relativeElevation=null;const Q=b(),Z=b(),$=-2,ee=4;export{$ as DRAPED_Z,Y as OverlayRenderer,ee as overlayRenderOccludedFlag};\n"]},"metadata":{},"sourceType":"module"}