{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../chunks/tslib.es6.js\";\nimport t from \"../../../core/Accessor.js\";\nimport r from \"../../../core/Handles.js\";\nimport { isNone as s, isSome as o, applySome as i } from \"../../../core/maybe.js\";\nimport n from \"../../../core/PooledArray.js\";\nimport { isPromise as d } from \"../../../core/promiseUtils.js\";\nimport { property as a } from \"../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../core/has.js\";\nimport \"../../../core/accessorSupport/ensureType.js\";\nimport \"../../../core/Logger.js\";\nimport { subclass as l } from \"../../../core/accessorSupport/decorators/subclass.js\";\nimport { isIntersectionHandler as c } from \"../state/helpers/SceneIntersectionHelper.js\";\nimport { AutoDisposableMixin as h, autoDispose as m } from \"./lib/AutoDisposable.js\";\nimport { ChangeSet as y } from \"./lib/ChangeSet.js\";\nimport { GeometryRecord as p } from \"./lib/GeometryRecord.js\";\nimport { isWebGLLayer as _ } from \"./lib/WebGLLayer.js\";\nimport { Model as g } from \"./parts/Model.js\";\nimport { RenderView as u } from \"./parts/RenderView.js\";\nimport { TaskPriority as S } from \"../../support/Scheduler.js\";\nvar f;\nlet w = f = class extends h(t) {\n  constructor(e) {\n    super(e), this._handles = new r(), this._model = new g(), this._layers = new n(), this._changeSet = new y(), this._layerSyncSet = new Set();\n  }\n\n  initialize() {\n    this._set(\"renderView\", new u(this)), this._frameTask = this.resourceController.scheduler.registerTask(S.STAGE, this), this._handles.add(this._frameTask);\n  }\n\n  destroy() {\n    p.pool.prune(0), this._handles.destroy(), this.dispose();\n  }\n\n  get viewingMode() {\n    return this.state.viewingMode;\n  }\n\n  get updating() {\n    return this._model.dirtySet.dirty || this.renderView.updating;\n  }\n\n  add(e) {\n    this._model.add(e), _(e) && (e.attachStage(this), this._addLayer(e)), this.renderView.setNeedsRender();\n  }\n\n  remove(e) {\n    s(e) || (this.renderView.setNeedsRender(), this._model.remove(e), _(e) && (this._removeLayer(e), e.detachStage()));\n  }\n\n  addMany(e) {\n    o(e) && (this._model.addMany(e), this.renderView.setNeedsRender());\n  }\n\n  removeMany(e) {\n    o(e) && (this._model.removeMany(e), this.renderView.setNeedsRender());\n  }\n\n  forEachOfType(e, t) {\n    this._model.forEachOfType(e, t);\n  }\n\n  handleEvent(e, t) {\n    this.destroyed || (this._model.dirtySet[e](t), this.renderView.setNeedsRender());\n  }\n\n  get running() {\n    return this._model.dirtySet.dirty;\n  }\n\n  runTask(e) {\n    this._frameTask.processQueue(e), e.done || this._commit();\n  }\n\n  _commit() {\n    const e = this._model.dirtySet;\n    f.DebugSettings.logDirtySet && console.log(\"Dirty set: \" + e.formatDebugInfo()), e.commit(this._changeSet), f.DebugSettings.logDirtySet && (console.log(\"RGs add: \" + this._changeSet.adds.map(e => e.id)), console.log(\"RGs remove: \" + this._changeSet.removes.map(e => e.id))), this._layerSyncSet.clear(), this.renderView.modify(this._changeSet), this.renderView.setNeedsRender();\n  }\n\n  schedule(e, t) {\n    return this._frameTask.schedule(e, t);\n  }\n\n  syncLayer(e) {\n    this._layerSyncSet.add(e), this.renderView.setNeedsRender();\n  }\n\n  processSyncLayers() {\n    const e = this._model.dirtySet;\n\n    this._layers.forAll(t => {\n      (this._layerSyncSet.has(t.id) || 1 === t.updatePolicy) && (e.commitLayer(t.id, this._changeSet), this._layerSyncSet.delete(t.id));\n    });\n\n    for (const t of this._layerSyncSet) e.commitLayer(t, this._changeSet);\n\n    this._layerSyncSet.clear(), this.renderView.modify(this._changeSet);\n  }\n\n  getObject(e) {\n    return this._model.getObject(e);\n  }\n\n  get layers() {\n    return this._layers;\n  }\n\n  _addLayer(e) {\n    this._layers.some(t => t === e) || this._layers.push(e);\n  }\n\n  _removeLayer(e) {\n    this._commit(), null != this._layers.removeUnordered(e) && (this._model.dirtySet.getResidentRenderGeometries(e.id, this._changeSet.removes), this.renderView.modify(this._changeSet));\n  }\n\n  addRenderPlugin(e, t, r) {\n    const s = this.renderView.renderPlugins.add(e, t, r),\n          o = () => {\n      c(t) && this.sceneIntersectionHelper.addIntersectionHandler(t);\n    };\n\n    if (d(s)) return s.then(o);\n    o();\n  }\n\n  removeRenderPlugin(e) {\n    c(e) && this.sceneIntersectionHelper.removeIntersectionHandler(e), this.renderView.renderPlugins.remove(e);\n  }\n\n  get performanceInfo() {\n    return {\n      renderView: this.renderView.performanceInfo,\n      model: this._model.getStats()\n    };\n  }\n\n  get test() {\n    const e = this;\n    return {\n      getCount: t => e._model.test.content.filter(e => e.type === t).length,\n      stopAnimations: t => e._model.test.content.filter(e => 3 === e.type).forEach(e => i(e.animation, e => e.stopAtTime(t))),\n      model: e._model\n    };\n  }\n\n};\nw.DebugSettings = {\n  endFrameContentValidation: !1,\n  logDirtySet: !1\n}, e([a({\n  constructOnly: !0\n})], w.prototype, \"resourceController\", void 0), e([a({\n  constructOnly: !0\n})], w.prototype, \"options\", void 0), e([a({\n  constructOnly: !0\n})], w.prototype, \"state\", void 0), e([a({\n  constructOnly: !0\n})], w.prototype, \"sceneIntersectionHelper\", void 0), e([a({\n  readOnly: !0\n})], w.prototype, \"viewingMode\", null), e([a({\n  constructOnly: !0\n})], w.prototype, \"container\", void 0), e([a({\n  constructOnly: !0\n})], w.prototype, \"renderSR\", void 0), e([a({\n  constructOnly: !0\n})], w.prototype, \"_handles\", void 0), e([a({\n  readOnly: !0\n})], w.prototype, \"updating\", null), e([a({\n  constructOnly: !0\n})], w.prototype, \"_model\", void 0), e([m(), a()], w.prototype, \"renderView\", void 0), w = f = e([l(\"esri.views.3d.webgl-engine.Stage\")], w);\nexport { w as Stage };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/webgl-engine/Stage.js"],"names":["_","e","t","r","isNone","s","isSome","o","applySome","i","n","isPromise","d","property","a","subclass","l","isIntersectionHandler","c","AutoDisposableMixin","h","autoDispose","m","ChangeSet","y","GeometryRecord","p","isWebGLLayer","Model","g","RenderView","u","TaskPriority","S","f","w","constructor","_handles","_model","_layers","_changeSet","_layerSyncSet","Set","initialize","_set","_frameTask","resourceController","scheduler","registerTask","STAGE","add","destroy","pool","prune","dispose","viewingMode","state","updating","dirtySet","dirty","renderView","attachStage","_addLayer","setNeedsRender","remove","_removeLayer","detachStage","addMany","removeMany","forEachOfType","handleEvent","destroyed","running","runTask","processQueue","done","_commit","DebugSettings","logDirtySet","console","log","formatDebugInfo","commit","adds","map","id","removes","clear","modify","schedule","syncLayer","processSyncLayers","forAll","has","updatePolicy","commitLayer","delete","getObject","layers","some","push","removeUnordered","getResidentRenderGeometries","addRenderPlugin","renderPlugins","sceneIntersectionHelper","addIntersectionHandler","then","removeRenderPlugin","removeIntersectionHandler","performanceInfo","model","getStats","test","getCount","content","filter","type","length","stopAnimations","forEach","animation","stopAtTime","endFrameContentValidation","constructOnly","prototype","readOnly","Stage"],"mappings":"AAAA;AACA;AACA;AACA;AACA,SAAOA,CAAC,IAAIC,CAAZ,QAAkB,8BAAlB;AAAiD,OAAOC,CAAP,MAAa,2BAAb;AAAyC,OAAOC,CAAP,MAAa,0BAAb;AAAwC,SAAOC,MAAM,IAAIC,CAAjB,EAAmBC,MAAM,IAAIC,CAA7B,EAA+BC,SAAS,IAAIC,CAA5C,QAAkD,wBAAlD;AAA2E,OAAOC,CAAP,MAAa,8BAAb;AAA4C,SAAOC,SAAS,IAAIC,CAApB,QAA0B,+BAA1B;AAA0D,SAAOC,QAAQ,IAAIC,CAAnB,QAAyB,sDAAzB;AAAgF,OAAM,sBAAN;AAA6B,OAAM,6CAAN;AAAoD,OAAM,yBAAN;AAAgC,SAAOC,QAAQ,IAAIC,CAAnB,QAAyB,sDAAzB;AAAgF,SAAOC,qBAAqB,IAAIC,CAAhC,QAAsC,6CAAtC;AAAoF,SAAOC,mBAAmB,IAAIC,CAA9B,EAAgCC,WAAW,IAAIC,CAA/C,QAAqD,yBAArD;AAA+E,SAAOC,SAAS,IAAIC,CAApB,QAA0B,oBAA1B;AAA+C,SAAOC,cAAc,IAAIC,CAAzB,QAA+B,yBAA/B;AAAyD,SAAOC,YAAY,IAAI3B,CAAvB,QAA6B,qBAA7B;AAAmD,SAAO4B,KAAK,IAAIC,CAAhB,QAAsB,kBAAtB;AAAyC,SAAOC,UAAU,IAAIC,CAArB,QAA2B,uBAA3B;AAAmD,SAAOC,YAAY,IAAIC,CAAvB,QAA6B,4BAA7B;AAA0D,IAAIC,CAAJ;AAAM,IAAIC,CAAC,GAACD,CAAC,GAAC,cAAcd,CAAC,CAAClB,CAAD,CAAf,CAAmB;AAACkC,EAAAA,WAAW,CAACnC,CAAD,EAAG;AAAC,UAAMA,CAAN,GAAS,KAAKoC,QAAL,GAAc,IAAIlC,CAAJ,EAAvB,EAA6B,KAAKmC,MAAL,GAAY,IAAIT,CAAJ,EAAzC,EAA+C,KAAKU,OAAL,GAAa,IAAI7B,CAAJ,EAA5D,EAAkE,KAAK8B,UAAL,GAAgB,IAAIhB,CAAJ,EAAlF,EAAwF,KAAKiB,aAAL,GAAmB,IAAIC,GAAJ,EAA3G;AAAmH;;AAAAC,EAAAA,UAAU,GAAE;AAAC,SAAKC,IAAL,CAAU,YAAV,EAAuB,IAAIb,CAAJ,CAAM,IAAN,CAAvB,GAAoC,KAAKc,UAAL,GAAgB,KAAKC,kBAAL,CAAwBC,SAAxB,CAAkCC,YAAlC,CAA+Cf,CAAC,CAACgB,KAAjD,EAAuD,IAAvD,CAApD,EAAiH,KAAKZ,QAAL,CAAca,GAAd,CAAkB,KAAKL,UAAvB,CAAjH;AAAoJ;;AAAAM,EAAAA,OAAO,GAAE;AAACzB,IAAAA,CAAC,CAAC0B,IAAF,CAAOC,KAAP,CAAa,CAAb,GAAgB,KAAKhB,QAAL,CAAcc,OAAd,EAAhB,EAAwC,KAAKG,OAAL,EAAxC;AAAuD;;AAAe,MAAXC,WAAW,GAAE;AAAC,WAAO,KAAKC,KAAL,CAAWD,WAAlB;AAA8B;;AAAY,MAARE,QAAQ,GAAE;AAAC,WAAO,KAAKnB,MAAL,CAAYoB,QAAZ,CAAqBC,KAArB,IAA4B,KAAKC,UAAL,CAAgBH,QAAnD;AAA4D;;AAAAP,EAAAA,GAAG,CAACjD,CAAD,EAAG;AAAC,SAAKqC,MAAL,CAAYY,GAAZ,CAAgBjD,CAAhB,GAAmBD,CAAC,CAACC,CAAD,CAAD,KAAOA,CAAC,CAAC4D,WAAF,CAAc,IAAd,GAAoB,KAAKC,SAAL,CAAe7D,CAAf,CAA3B,CAAnB,EAAiE,KAAK2D,UAAL,CAAgBG,cAAhB,EAAjE;AAAkG;;AAAAC,EAAAA,MAAM,CAAC/D,CAAD,EAAG;AAACI,IAAAA,CAAC,CAACJ,CAAD,CAAD,KAAO,KAAK2D,UAAL,CAAgBG,cAAhB,IAAiC,KAAKzB,MAAL,CAAY0B,MAAZ,CAAmB/D,CAAnB,CAAjC,EAAuDD,CAAC,CAACC,CAAD,CAAD,KAAO,KAAKgE,YAAL,CAAkBhE,CAAlB,GAAqBA,CAAC,CAACiE,WAAF,EAA5B,CAA9D;AAA4G;;AAAAC,EAAAA,OAAO,CAAClE,CAAD,EAAG;AAACM,IAAAA,CAAC,CAACN,CAAD,CAAD,KAAO,KAAKqC,MAAL,CAAY6B,OAAZ,CAAoBlE,CAApB,GAAuB,KAAK2D,UAAL,CAAgBG,cAAhB,EAA9B;AAAgE;;AAAAK,EAAAA,UAAU,CAACnE,CAAD,EAAG;AAACM,IAAAA,CAAC,CAACN,CAAD,CAAD,KAAO,KAAKqC,MAAL,CAAY8B,UAAZ,CAAuBnE,CAAvB,GAA0B,KAAK2D,UAAL,CAAgBG,cAAhB,EAAjC;AAAmE;;AAAAM,EAAAA,aAAa,CAACpE,CAAD,EAAGC,CAAH,EAAK;AAAC,SAAKoC,MAAL,CAAY+B,aAAZ,CAA0BpE,CAA1B,EAA4BC,CAA5B;AAA+B;;AAAAoE,EAAAA,WAAW,CAACrE,CAAD,EAAGC,CAAH,EAAK;AAAC,SAAKqE,SAAL,KAAiB,KAAKjC,MAAL,CAAYoB,QAAZ,CAAqBzD,CAArB,EAAwBC,CAAxB,GAA2B,KAAK0D,UAAL,CAAgBG,cAAhB,EAA5C;AAA8E;;AAAW,MAAPS,OAAO,GAAE;AAAC,WAAO,KAAKlC,MAAL,CAAYoB,QAAZ,CAAqBC,KAA5B;AAAkC;;AAAAc,EAAAA,OAAO,CAACxE,CAAD,EAAG;AAAC,SAAK4C,UAAL,CAAgB6B,YAAhB,CAA6BzE,CAA7B,GAAgCA,CAAC,CAAC0E,IAAF,IAAQ,KAAKC,OAAL,EAAxC;AAAuD;;AAAAA,EAAAA,OAAO,GAAE;AAAC,UAAM3E,CAAC,GAAC,KAAKqC,MAAL,CAAYoB,QAApB;AAA6BxB,IAAAA,CAAC,CAAC2C,aAAF,CAAgBC,WAAhB,IAA6BC,OAAO,CAACC,GAAR,CAAY,gBAAc/E,CAAC,CAACgF,eAAF,EAA1B,CAA7B,EAA4EhF,CAAC,CAACiF,MAAF,CAAS,KAAK1C,UAAd,CAA5E,EAAsGN,CAAC,CAAC2C,aAAF,CAAgBC,WAAhB,KAA8BC,OAAO,CAACC,GAAR,CAAY,cAAY,KAAKxC,UAAL,CAAgB2C,IAAhB,CAAqBC,GAArB,CAA0BnF,CAAC,IAAEA,CAAC,CAACoF,EAA/B,CAAxB,GAA6DN,OAAO,CAACC,GAAR,CAAY,iBAAe,KAAKxC,UAAL,CAAgB8C,OAAhB,CAAwBF,GAAxB,CAA6BnF,CAAC,IAAEA,CAAC,CAACoF,EAAlC,CAA3B,CAA3F,CAAtG,EAAqQ,KAAK5C,aAAL,CAAmB8C,KAAnB,EAArQ,EAAgS,KAAK3B,UAAL,CAAgB4B,MAAhB,CAAuB,KAAKhD,UAA5B,CAAhS,EAAwU,KAAKoB,UAAL,CAAgBG,cAAhB,EAAxU;AAAyW;;AAAA0B,EAAAA,QAAQ,CAACxF,CAAD,EAAGC,CAAH,EAAK;AAAC,WAAO,KAAK2C,UAAL,CAAgB4C,QAAhB,CAAyBxF,CAAzB,EAA2BC,CAA3B,CAAP;AAAqC;;AAAAwF,EAAAA,SAAS,CAACzF,CAAD,EAAG;AAAC,SAAKwC,aAAL,CAAmBS,GAAnB,CAAuBjD,CAAvB,GAA0B,KAAK2D,UAAL,CAAgBG,cAAhB,EAA1B;AAA2D;;AAAA4B,EAAAA,iBAAiB,GAAE;AAAC,UAAM1F,CAAC,GAAC,KAAKqC,MAAL,CAAYoB,QAApB;;AAA6B,SAAKnB,OAAL,CAAaqD,MAAb,CAAqB1F,CAAC,IAAE;AAAC,OAAC,KAAKuC,aAAL,CAAmBoD,GAAnB,CAAuB3F,CAAC,CAACmF,EAAzB,KAA8B,MAAInF,CAAC,CAAC4F,YAArC,MAAqD7F,CAAC,CAAC8F,WAAF,CAAc7F,CAAC,CAACmF,EAAhB,EAAmB,KAAK7C,UAAxB,GAAoC,KAAKC,aAAL,CAAmBuD,MAAnB,CAA0B9F,CAAC,CAACmF,EAA5B,CAAzF;AAA0H,KAAnJ;;AAAsJ,SAAI,MAAMnF,CAAV,IAAe,KAAKuC,aAApB,EAAkCxC,CAAC,CAAC8F,WAAF,CAAc7F,CAAd,EAAgB,KAAKsC,UAArB;;AAAiC,SAAKC,aAAL,CAAmB8C,KAAnB,IAA2B,KAAK3B,UAAL,CAAgB4B,MAAhB,CAAuB,KAAKhD,UAA5B,CAA3B;AAAmE;;AAAAyD,EAAAA,SAAS,CAAChG,CAAD,EAAG;AAAC,WAAO,KAAKqC,MAAL,CAAY2D,SAAZ,CAAsBhG,CAAtB,CAAP;AAAgC;;AAAU,MAANiG,MAAM,GAAE;AAAC,WAAO,KAAK3D,OAAZ;AAAoB;;AAAAuB,EAAAA,SAAS,CAAC7D,CAAD,EAAG;AAAC,SAAKsC,OAAL,CAAa4D,IAAb,CAAmBjG,CAAC,IAAEA,CAAC,KAAGD,CAA1B,KAA+B,KAAKsC,OAAL,CAAa6D,IAAb,CAAkBnG,CAAlB,CAA/B;AAAoD;;AAAAgE,EAAAA,YAAY,CAAChE,CAAD,EAAG;AAAC,SAAK2E,OAAL,IAAe,QAAM,KAAKrC,OAAL,CAAa8D,eAAb,CAA6BpG,CAA7B,CAAN,KAAwC,KAAKqC,MAAL,CAAYoB,QAAZ,CAAqB4C,2BAArB,CAAiDrG,CAAC,CAACoF,EAAnD,EAAsD,KAAK7C,UAAL,CAAgB8C,OAAtE,GAA+E,KAAK1B,UAAL,CAAgB4B,MAAhB,CAAuB,KAAKhD,UAA5B,CAAvH,CAAf;AAA+K;;AAAA+D,EAAAA,eAAe,CAACtG,CAAD,EAAGC,CAAH,EAAKC,CAAL,EAAO;AAAC,UAAME,CAAC,GAAC,KAAKuD,UAAL,CAAgB4C,aAAhB,CAA8BtD,GAA9B,CAAkCjD,CAAlC,EAAoCC,CAApC,EAAsCC,CAAtC,CAAR;AAAA,UAAiDI,CAAC,GAAC,MAAI;AAACW,MAAAA,CAAC,CAAChB,CAAD,CAAD,IAAM,KAAKuG,uBAAL,CAA6BC,sBAA7B,CAAoDxG,CAApD,CAAN;AAA6D,KAArH;;AAAsH,QAAGU,CAAC,CAACP,CAAD,CAAJ,EAAQ,OAAOA,CAAC,CAACsG,IAAF,CAAOpG,CAAP,CAAP;AAAiBA,IAAAA,CAAC;AAAG;;AAAAqG,EAAAA,kBAAkB,CAAC3G,CAAD,EAAG;AAACiB,IAAAA,CAAC,CAACjB,CAAD,CAAD,IAAM,KAAKwG,uBAAL,CAA6BI,yBAA7B,CAAuD5G,CAAvD,CAAN,EAAgE,KAAK2D,UAAL,CAAgB4C,aAAhB,CAA8BxC,MAA9B,CAAqC/D,CAArC,CAAhE;AAAwG;;AAAmB,MAAf6G,eAAe,GAAE;AAAC,WAAM;AAAClD,MAAAA,UAAU,EAAC,KAAKA,UAAL,CAAgBkD,eAA5B;AAA4CC,MAAAA,KAAK,EAAC,KAAKzE,MAAL,CAAY0E,QAAZ;AAAlD,KAAN;AAAgF;;AAAQ,MAAJC,IAAI,GAAE;AAAC,UAAMhH,CAAC,GAAC,IAAR;AAAa,WAAM;AAACiH,MAAAA,QAAQ,EAAChH,CAAC,IAAED,CAAC,CAACqC,MAAF,CAAS2E,IAAT,CAAcE,OAAd,CAAsBC,MAAtB,CAA8BnH,CAAC,IAAEA,CAAC,CAACoH,IAAF,KAASnH,CAA1C,EAA8CoH,MAA3D;AAAkEC,MAAAA,cAAc,EAACrH,CAAC,IAAED,CAAC,CAACqC,MAAF,CAAS2E,IAAT,CAAcE,OAAd,CAAsBC,MAAtB,CAA8BnH,CAAC,IAAE,MAAIA,CAAC,CAACoH,IAAvC,EAA8CG,OAA9C,CAAuDvH,CAAC,IAAEQ,CAAC,CAACR,CAAC,CAACwH,SAAH,EAAcxH,CAAC,IAAEA,CAAC,CAACyH,UAAF,CAAaxH,CAAb,CAAjB,CAA3D,CAApF;AAAoL6G,MAAAA,KAAK,EAAC9G,CAAC,CAACqC;AAA5L,KAAN;AAA0M;;AAAp3F,CAA3B;AAAi5FH,CAAC,CAAC0C,aAAF,GAAgB;AAAC8C,EAAAA,yBAAyB,EAAC,CAAC,CAA5B;AAA8B7C,EAAAA,WAAW,EAAC,CAAC;AAA3C,CAAhB,EAA8D7E,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC8G,EAAAA,aAAa,EAAC,CAAC;AAAhB,CAAD,CAAF,CAAD,EAAyBzF,CAAC,CAAC0F,SAA3B,EAAqC,oBAArC,EAA0D,KAAK,CAA/D,CAA/D,EAAiI5H,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC8G,EAAAA,aAAa,EAAC,CAAC;AAAhB,CAAD,CAAF,CAAD,EAAyBzF,CAAC,CAAC0F,SAA3B,EAAqC,SAArC,EAA+C,KAAK,CAApD,CAAlI,EAAyL5H,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC8G,EAAAA,aAAa,EAAC,CAAC;AAAhB,CAAD,CAAF,CAAD,EAAyBzF,CAAC,CAAC0F,SAA3B,EAAqC,OAArC,EAA6C,KAAK,CAAlD,CAA1L,EAA+O5H,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC8G,EAAAA,aAAa,EAAC,CAAC;AAAhB,CAAD,CAAF,CAAD,EAAyBzF,CAAC,CAAC0F,SAA3B,EAAqC,yBAArC,EAA+D,KAAK,CAApE,CAAhP,EAAuT5H,CAAC,CAAC,CAACa,CAAC,CAAC;AAACgH,EAAAA,QAAQ,EAAC,CAAC;AAAX,CAAD,CAAF,CAAD,EAAoB3F,CAAC,CAAC0F,SAAtB,EAAgC,aAAhC,EAA8C,IAA9C,CAAxT,EAA4W5H,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC8G,EAAAA,aAAa,EAAC,CAAC;AAAhB,CAAD,CAAF,CAAD,EAAyBzF,CAAC,CAAC0F,SAA3B,EAAqC,WAArC,EAAiD,KAAK,CAAtD,CAA7W,EAAsa5H,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC8G,EAAAA,aAAa,EAAC,CAAC;AAAhB,CAAD,CAAF,CAAD,EAAyBzF,CAAC,CAAC0F,SAA3B,EAAqC,UAArC,EAAgD,KAAK,CAArD,CAAva,EAA+d5H,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC8G,EAAAA,aAAa,EAAC,CAAC;AAAhB,CAAD,CAAF,CAAD,EAAyBzF,CAAC,CAAC0F,SAA3B,EAAqC,UAArC,EAAgD,KAAK,CAArD,CAAhe,EAAwhB5H,CAAC,CAAC,CAACa,CAAC,CAAC;AAACgH,EAAAA,QAAQ,EAAC,CAAC;AAAX,CAAD,CAAF,CAAD,EAAoB3F,CAAC,CAAC0F,SAAtB,EAAgC,UAAhC,EAA2C,IAA3C,CAAzhB,EAA0kB5H,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC8G,EAAAA,aAAa,EAAC,CAAC;AAAhB,CAAD,CAAF,CAAD,EAAyBzF,CAAC,CAAC0F,SAA3B,EAAqC,QAArC,EAA8C,KAAK,CAAnD,CAA3kB,EAAioB5H,CAAC,CAAC,CAACqB,CAAC,EAAF,EAAKR,CAAC,EAAN,CAAD,EAAWqB,CAAC,CAAC0F,SAAb,EAAuB,YAAvB,EAAoC,KAAK,CAAzC,CAAloB,EAA8qB1F,CAAC,GAACD,CAAC,GAACjC,CAAC,CAAC,CAACe,CAAC,CAAC,kCAAD,CAAF,CAAD,EAAyCmB,CAAzC,CAAnrB;AAA+tB,SAAOA,CAAC,IAAI4F,KAAZ","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import t from\"../../../core/Accessor.js\";import r from\"../../../core/Handles.js\";import{isNone as s,isSome as o,applySome as i}from\"../../../core/maybe.js\";import n from\"../../../core/PooledArray.js\";import{isPromise as d}from\"../../../core/promiseUtils.js\";import{property as a}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import\"../../../core/Logger.js\";import{subclass as l}from\"../../../core/accessorSupport/decorators/subclass.js\";import{isIntersectionHandler as c}from\"../state/helpers/SceneIntersectionHelper.js\";import{AutoDisposableMixin as h,autoDispose as m}from\"./lib/AutoDisposable.js\";import{ChangeSet as y}from\"./lib/ChangeSet.js\";import{GeometryRecord as p}from\"./lib/GeometryRecord.js\";import{isWebGLLayer as _}from\"./lib/WebGLLayer.js\";import{Model as g}from\"./parts/Model.js\";import{RenderView as u}from\"./parts/RenderView.js\";import{TaskPriority as S}from\"../../support/Scheduler.js\";var f;let w=f=class extends(h(t)){constructor(e){super(e),this._handles=new r,this._model=new g,this._layers=new n,this._changeSet=new y,this._layerSyncSet=new Set}initialize(){this._set(\"renderView\",new u(this)),this._frameTask=this.resourceController.scheduler.registerTask(S.STAGE,this),this._handles.add(this._frameTask)}destroy(){p.pool.prune(0),this._handles.destroy(),this.dispose()}get viewingMode(){return this.state.viewingMode}get updating(){return this._model.dirtySet.dirty||this.renderView.updating}add(e){this._model.add(e),_(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.setNeedsRender()}remove(e){s(e)||(this.renderView.setNeedsRender(),this._model.remove(e),_(e)&&(this._removeLayer(e),e.detachStage()))}addMany(e){o(e)&&(this._model.addMany(e),this.renderView.setNeedsRender())}removeMany(e){o(e)&&(this._model.removeMany(e),this.renderView.setNeedsRender())}forEachOfType(e,t){this._model.forEachOfType(e,t)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.setNeedsRender())}get running(){return this._model.dirtySet.dirty}runTask(e){this._frameTask.processQueue(e),e.done||this._commit()}_commit(){const e=this._model.dirtySet;f.DebugSettings.logDirtySet&&console.log(\"Dirty set: \"+e.formatDebugInfo()),e.commit(this._changeSet),f.DebugSettings.logDirtySet&&(console.log(\"RGs add: \"+this._changeSet.adds.map((e=>e.id))),console.log(\"RGs remove: \"+this._changeSet.removes.map((e=>e.id)))),this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.setNeedsRender()}schedule(e,t){return this._frameTask.schedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.setNeedsRender()}processSyncLayers(){const e=this._model.dirtySet;this._layers.forAll((t=>{(this._layerSyncSet.has(t.id)||1===t.updatePolicy)&&(e.commitLayer(t.id,this._changeSet),this._layerSyncSet.delete(t.id))}));for(const t of this._layerSyncSet)e.commitLayer(t,this._changeSet);this._layerSyncSet.clear(),this.renderView.modify(this._changeSet)}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.some((t=>t===e))||this._layers.push(e)}_removeLayer(e){this._commit(),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._changeSet.removes),this.renderView.modify(this._changeSet))}addRenderPlugin(e,t,r){const s=this.renderView.renderPlugins.add(e,t,r),o=()=>{c(t)&&this.sceneIntersectionHelper.addIntersectionHandler(t)};if(d(s))return s.then(o);o()}removeRenderPlugin(e){c(e)&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const e=this;return{getCount:t=>e._model.test.content.filter((e=>e.type===t)).length,stopAnimations:t=>e._model.test.content.filter((e=>3===e.type)).forEach((e=>i(e.animation,(e=>e.stopAtTime(t))))),model:e._model}}};w.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},e([a({constructOnly:!0})],w.prototype,\"resourceController\",void 0),e([a({constructOnly:!0})],w.prototype,\"options\",void 0),e([a({constructOnly:!0})],w.prototype,\"state\",void 0),e([a({constructOnly:!0})],w.prototype,\"sceneIntersectionHelper\",void 0),e([a({readOnly:!0})],w.prototype,\"viewingMode\",null),e([a({constructOnly:!0})],w.prototype,\"container\",void 0),e([a({constructOnly:!0})],w.prototype,\"renderSR\",void 0),e([a({constructOnly:!0})],w.prototype,\"_handles\",void 0),e([a({readOnly:!0})],w.prototype,\"updating\",null),e([a({constructOnly:!0})],w.prototype,\"_model\",void 0),e([m(),a()],w.prototype,\"renderView\",void 0),w=f=e([l(\"esri.views.3d.webgl-engine.Stage\")],w);export{w as Stage};\n"]},"metadata":{},"sourceType":"module"}