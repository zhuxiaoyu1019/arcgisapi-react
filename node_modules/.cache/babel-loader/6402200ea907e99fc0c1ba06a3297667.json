{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from \"../support/FeatureSet.js\";\nimport e from \"../support/IdSet.js\";\nimport { IdState as n } from \"../support/shared.js\";\nimport { resolve as s, reject as i } from \"../../../core/promiseUtils.js\";\n\nclass a extends t {\n  constructor(t) {\n    super(t), this._topnum = 0, this.declaredClass = \"esri.arcade.featureset.actions.Top\", this._countedin = 0, this._maxProcessing = 100, this._topnum = t.topnum, this._parent = t.parentfeatureset;\n  }\n\n  _getSet(t) {\n    return null === this._wset ? this._ensureLoaded().then(() => this._parent._getSet(t)).then(t => (this._wset = new e(t._candidates.slice(0), t._known.slice(0), !1, this._clonePageDefinition(t.pagesDefinition)), this._setKnownLength(this._wset) > this._topnum && (this._wset._known = this._wset._known.slice(0, this._topnum)), this._setKnownLength(this._wset) >= this._topnum && (this._wset._candidates = []), this._wset)) : s(this._wset);\n  }\n\n  _setKnownLength(t) {\n    return t._known.length > 0 && \"GETPAGES\" === t._known[t._known.length - 1] ? t._known.length - 1 : t._known.length;\n  }\n\n  _isInFeatureSet(t) {\n    const e = this._parent._isInFeatureSet(t);\n\n    if (e === n.NotInFeatureSet) return e;\n    const s = this._idstates[t];\n    return s === n.InFeatureSet || s === n.NotInFeatureSet ? s : e === n.InFeatureSet && void 0 === s ? this._countedin < this._topnum ? (this._idstates[t] = n.InFeatureSet, this._countedin++, n.InFeatureSet) : (this._idstates[t] = n.NotInFeatureSet, n.NotInFeatureSet) : n.Unknown;\n  }\n\n  _expandPagedSet(t, e, n, a, r) {\n    if (null === this._parent) return i(new Error(\"Parent Paging not implemented\"));\n\n    if (e > this._topnum && (e = this._topnum), this._countedin >= this._topnum && t.pagesDefinition.internal.set.length <= t.pagesDefinition.resultOffset) {\n      let e = t._known.length;\n      return e > 0 && \"GETPAGES\" === t._known[e - 1] && (t._known.length = e - 1), e = t._candidates.length, e > 0 && \"GETPAGES\" === t._candidates[e - 1] && (t._candidates.length = e - 1), s(\"success\");\n    }\n\n    return this._parent._expandPagedSet(t, e, n, a, r).then(e => (this._setKnownLength(t) > this._topnum && (t._known.length = this._topnum), this._setKnownLength(t) >= this._topnum && (t._candidates.length = 0), e));\n  }\n\n  _getFeatures(t, n, i, a) {\n    const r = [],\n          o = this._maxQueryRate();\n\n    if (!0 === this._checkIfNeedToExpandKnownPage(t, o)) return this._expandPagedSet(t, o, 0, 0, a).then(() => this._getFeatures(t, n, i, a));\n    -1 !== n && void 0 === this._featureCache[n] && r.push(n);\n    let _ = 0;\n\n    for (let e = t._lastFetchedIndex; e < t._known.length && (_++, _ <= i && (t._lastFetchedIndex += 1), !(void 0 === this._featureCache[t._known[e]] && (t._known[e] !== n && r.push(t._known[e]), r.length > o))); e++);\n\n    if (0 === r.length) return s(\"success\");\n    const h = new e([], r, !1, null),\n          u = Math.min(r.length, i);\n    return this._parent._getFeatures(h, -1, u, a).then(() => {\n      for (let t = 0; t < u; t++) {\n        const e = this._parent._featureFromCache(r[t]);\n\n        void 0 !== e && (this._featureCache[r[t]] = e);\n      }\n\n      return \"success\";\n    });\n  }\n\n  _getFilteredSet(t, n, s, i, a) {\n    return this._ensureLoaded().then(() => this._getSet(a)).then(t => new e(t._candidates.slice(0).concat(t._known.slice(0)), [], !1, this._clonePageDefinition(t.pagesDefinition)));\n  }\n\n  _refineKnowns(t, e) {\n    let s = 0,\n        i = null;\n    const a = [];\n\n    for (let r = 0; r < t._candidates.length; r++) {\n      const o = this._isInFeatureSet(t._candidates[r]);\n\n      if (o === n.InFeatureSet) {\n        if (t._known.push(t._candidates[r]), s += 1, null === i ? i = {\n          start: r,\n          end: r\n        } : i.end === r - 1 ? i.end = r : (a.push(i), i = {\n          start: r,\n          end: r\n        }), t._known.length >= this._topnum) break;\n      } else if (o === n.NotInFeatureSet) null === i ? i = {\n        start: r,\n        end: r\n      } : i.end === r - 1 ? i.end = r : (a.push(i), i = {\n        start: r,\n        end: r\n      }), s += 1;else if (o === n.Unknown) break;\n\n      if (s >= e) break;\n    }\n\n    null !== i && a.push(i);\n\n    for (let n = a.length - 1; n >= 0; n--) t._candidates.splice(a[n].start, a[n].end - a[n].start + 1);\n\n    this._setKnownLength(t) > this._topnum && (t._known = t._known.slice(0, this._topnum)), this._setKnownLength(t) >= this._topnum && (t._candidates = []);\n  }\n\n  _stat() {\n    return s({\n      calculated: !1\n    });\n  }\n\n  _canDoAggregates() {\n    return s(!1);\n  }\n\n  static registerAction() {\n    t._featuresetFunctions.top = function (t) {\n      return new a({\n        parentfeatureset: this,\n        topnum: t\n      });\n    };\n  }\n\n}\n\nexport default a;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/arcade/featureset/actions/Top.js"],"names":["t","e","IdState","n","resolve","s","reject","i","a","constructor","_topnum","declaredClass","_countedin","_maxProcessing","topnum","_parent","parentfeatureset","_getSet","_wset","_ensureLoaded","then","_candidates","slice","_known","_clonePageDefinition","pagesDefinition","_setKnownLength","length","_isInFeatureSet","NotInFeatureSet","_idstates","InFeatureSet","Unknown","_expandPagedSet","r","Error","internal","set","resultOffset","_getFeatures","o","_maxQueryRate","_checkIfNeedToExpandKnownPage","_featureCache","push","_","_lastFetchedIndex","h","u","Math","min","_featureFromCache","_getFilteredSet","concat","_refineKnowns","start","end","splice","_stat","calculated","_canDoAggregates","registerAction","_featuresetFunctions","top"],"mappings":"AAAA;AACA;AACA;AACA;AACA,OAAOA,CAAP,MAAa,0BAAb;AAAwC,OAAOC,CAAP,MAAa,qBAAb;AAAmC,SAAOC,OAAO,IAAIC,CAAlB,QAAwB,sBAAxB;AAA+C,SAAOC,OAAO,IAAIC,CAAlB,EAAoBC,MAAM,IAAIC,CAA9B,QAAoC,+BAApC;;AAAoE,MAAMC,CAAN,SAAgBR,CAAhB,CAAiB;AAACS,EAAAA,WAAW,CAACT,CAAD,EAAG;AAAC,UAAMA,CAAN,GAAS,KAAKU,OAAL,GAAa,CAAtB,EAAwB,KAAKC,aAAL,GAAmB,oCAA3C,EAAgF,KAAKC,UAAL,GAAgB,CAAhG,EAAkG,KAAKC,cAAL,GAAoB,GAAtH,EAA0H,KAAKH,OAAL,GAAaV,CAAC,CAACc,MAAzI,EAAgJ,KAAKC,OAAL,GAAaf,CAAC,CAACgB,gBAA/J;AAAgL;;AAAAC,EAAAA,OAAO,CAACjB,CAAD,EAAG;AAAC,WAAO,SAAO,KAAKkB,KAAZ,GAAkB,KAAKC,aAAL,GAAqBC,IAArB,CAA2B,MAAI,KAAKL,OAAL,CAAaE,OAAb,CAAqBjB,CAArB,CAA/B,EAAyDoB,IAAzD,CAA+DpB,CAAC,KAAG,KAAKkB,KAAL,GAAW,IAAIjB,CAAJ,CAAMD,CAAC,CAACqB,WAAF,CAAcC,KAAd,CAAoB,CAApB,CAAN,EAA6BtB,CAAC,CAACuB,MAAF,CAASD,KAAT,CAAe,CAAf,CAA7B,EAA+C,CAAC,CAAhD,EAAkD,KAAKE,oBAAL,CAA0BxB,CAAC,CAACyB,eAA5B,CAAlD,CAAX,EAA2G,KAAKC,eAAL,CAAqB,KAAKR,KAA1B,IAAiC,KAAKR,OAAtC,KAAgD,KAAKQ,KAAL,CAAWK,MAAX,GAAkB,KAAKL,KAAL,CAAWK,MAAX,CAAkBD,KAAlB,CAAwB,CAAxB,EAA0B,KAAKZ,OAA/B,CAAlE,CAA3G,EAAsN,KAAKgB,eAAL,CAAqB,KAAKR,KAA1B,KAAkC,KAAKR,OAAvC,KAAiD,KAAKQ,KAAL,CAAWG,WAAX,GAAuB,EAAxE,CAAtN,EAAkS,KAAKH,KAA1S,CAAhE,CAAlB,GAAqYb,CAAC,CAAC,KAAKa,KAAN,CAA7Y;AAA0Z;;AAAAQ,EAAAA,eAAe,CAAC1B,CAAD,EAAG;AAAC,WAAOA,CAAC,CAACuB,MAAF,CAASI,MAAT,GAAgB,CAAhB,IAAmB,eAAa3B,CAAC,CAACuB,MAAF,CAASvB,CAAC,CAACuB,MAAF,CAASI,MAAT,GAAgB,CAAzB,CAAhC,GAA4D3B,CAAC,CAACuB,MAAF,CAASI,MAAT,GAAgB,CAA5E,GAA8E3B,CAAC,CAACuB,MAAF,CAASI,MAA9F;AAAqG;;AAAAC,EAAAA,eAAe,CAAC5B,CAAD,EAAG;AAAC,UAAMC,CAAC,GAAC,KAAKc,OAAL,CAAaa,eAAb,CAA6B5B,CAA7B,CAAR;;AAAwC,QAAGC,CAAC,KAAGE,CAAC,CAAC0B,eAAT,EAAyB,OAAO5B,CAAP;AAAS,UAAMI,CAAC,GAAC,KAAKyB,SAAL,CAAe9B,CAAf,CAAR;AAA0B,WAAOK,CAAC,KAAGF,CAAC,CAAC4B,YAAN,IAAoB1B,CAAC,KAAGF,CAAC,CAAC0B,eAA1B,GAA0CxB,CAA1C,GAA4CJ,CAAC,KAAGE,CAAC,CAAC4B,YAAN,IAAoB,KAAK,CAAL,KAAS1B,CAA7B,GAA+B,KAAKO,UAAL,GAAgB,KAAKF,OAArB,IAA8B,KAAKoB,SAAL,CAAe9B,CAAf,IAAkBG,CAAC,CAAC4B,YAApB,EAAiC,KAAKnB,UAAL,EAAjC,EAAmDT,CAAC,CAAC4B,YAAnF,KAAkG,KAAKD,SAAL,CAAe9B,CAAf,IAAkBG,CAAC,CAAC0B,eAApB,EAAoC1B,CAAC,CAAC0B,eAAxI,CAA/B,GAAwL1B,CAAC,CAAC6B,OAA7O;AAAqP;;AAAAC,EAAAA,eAAe,CAACjC,CAAD,EAAGC,CAAH,EAAKE,CAAL,EAAOK,CAAP,EAAS0B,CAAT,EAAW;AAAC,QAAG,SAAO,KAAKnB,OAAf,EAAuB,OAAOR,CAAC,CAAC,IAAI4B,KAAJ,CAAU,+BAAV,CAAD,CAAR;;AAAqD,QAAGlC,CAAC,GAAC,KAAKS,OAAP,KAAiBT,CAAC,GAAC,KAAKS,OAAxB,GAAiC,KAAKE,UAAL,IAAiB,KAAKF,OAAtB,IAA+BV,CAAC,CAACyB,eAAF,CAAkBW,QAAlB,CAA2BC,GAA3B,CAA+BV,MAA/B,IAAuC3B,CAAC,CAACyB,eAAF,CAAkBa,YAA5H,EAAyI;AAAC,UAAIrC,CAAC,GAACD,CAAC,CAACuB,MAAF,CAASI,MAAf;AAAsB,aAAO1B,CAAC,GAAC,CAAF,IAAK,eAAaD,CAAC,CAACuB,MAAF,CAAStB,CAAC,GAAC,CAAX,CAAlB,KAAkCD,CAAC,CAACuB,MAAF,CAASI,MAAT,GAAgB1B,CAAC,GAAC,CAApD,GAAuDA,CAAC,GAACD,CAAC,CAACqB,WAAF,CAAcM,MAAvE,EAA8E1B,CAAC,GAAC,CAAF,IAAK,eAAaD,CAAC,CAACqB,WAAF,CAAcpB,CAAC,GAAC,CAAhB,CAAlB,KAAuCD,CAAC,CAACqB,WAAF,CAAcM,MAAd,GAAqB1B,CAAC,GAAC,CAA9D,CAA9E,EAA+II,CAAC,CAAC,SAAD,CAAvJ;AAAmK;;AAAA,WAAO,KAAKU,OAAL,CAAakB,eAAb,CAA6BjC,CAA7B,EAA+BC,CAA/B,EAAiCE,CAAjC,EAAmCK,CAAnC,EAAqC0B,CAArC,EAAwCd,IAAxC,CAA8CnB,CAAC,KAAG,KAAKyB,eAAL,CAAqB1B,CAArB,IAAwB,KAAKU,OAA7B,KAAuCV,CAAC,CAACuB,MAAF,CAASI,MAAT,GAAgB,KAAKjB,OAA5D,GAAqE,KAAKgB,eAAL,CAAqB1B,CAArB,KAAyB,KAAKU,OAA9B,KAAwCV,CAAC,CAACqB,WAAF,CAAcM,MAAd,GAAqB,CAA7D,CAArE,EAAqI1B,CAAxI,CAA/C,CAAP;AAAmM;;AAAAsC,EAAAA,YAAY,CAACvC,CAAD,EAAGG,CAAH,EAAKI,CAAL,EAAOC,CAAP,EAAS;AAAC,UAAM0B,CAAC,GAAC,EAAR;AAAA,UAAWM,CAAC,GAAC,KAAKC,aAAL,EAAb;;AAAkC,QAAG,CAAC,CAAD,KAAK,KAAKC,6BAAL,CAAmC1C,CAAnC,EAAqCwC,CAArC,CAAR,EAAgD,OAAO,KAAKP,eAAL,CAAqBjC,CAArB,EAAuBwC,CAAvB,EAAyB,CAAzB,EAA2B,CAA3B,EAA6BhC,CAA7B,EAAgCY,IAAhC,CAAsC,MAAI,KAAKmB,YAAL,CAAkBvC,CAAlB,EAAoBG,CAApB,EAAsBI,CAAtB,EAAwBC,CAAxB,CAA1C,CAAP;AAA8E,KAAC,CAAD,KAAKL,CAAL,IAAQ,KAAK,CAAL,KAAS,KAAKwC,aAAL,CAAmBxC,CAAnB,CAAjB,IAAwC+B,CAAC,CAACU,IAAF,CAAOzC,CAAP,CAAxC;AAAkD,QAAI0C,CAAC,GAAC,CAAN;;AAAQ,SAAI,IAAI5C,CAAC,GAACD,CAAC,CAAC8C,iBAAZ,EAA8B7C,CAAC,GAACD,CAAC,CAACuB,MAAF,CAASI,MAAX,KAAoBkB,CAAC,IAAGA,CAAC,IAAEtC,CAAH,KAAOP,CAAC,CAAC8C,iBAAF,IAAqB,CAA5B,CAAH,EAAkC,EAAE,KAAK,CAAL,KAAS,KAAKH,aAAL,CAAmB3C,CAAC,CAACuB,MAAF,CAAStB,CAAT,CAAnB,CAAT,KAA2CD,CAAC,CAACuB,MAAF,CAAStB,CAAT,MAAcE,CAAd,IAAiB+B,CAAC,CAACU,IAAF,CAAO5C,CAAC,CAACuB,MAAF,CAAStB,CAAT,CAAP,CAAjB,EAAqCiC,CAAC,CAACP,MAAF,GAASa,CAAzF,CAAF,CAAvD,CAA9B,EAAqLvC,CAAC,EAAtL,CAAyL;;AAAC,QAAG,MAAIiC,CAAC,CAACP,MAAT,EAAgB,OAAOtB,CAAC,CAAC,SAAD,CAAR;AAAoB,UAAM0C,CAAC,GAAC,IAAI9C,CAAJ,CAAM,EAAN,EAASiC,CAAT,EAAW,CAAC,CAAZ,EAAc,IAAd,CAAR;AAAA,UAA4Bc,CAAC,GAACC,IAAI,CAACC,GAAL,CAAShB,CAAC,CAACP,MAAX,EAAkBpB,CAAlB,CAA9B;AAAmD,WAAO,KAAKQ,OAAL,CAAawB,YAAb,CAA0BQ,CAA1B,EAA4B,CAAC,CAA7B,EAA+BC,CAA/B,EAAiCxC,CAAjC,EAAoCY,IAApC,CAA0C,MAAI;AAAC,WAAI,IAAIpB,CAAC,GAAC,CAAV,EAAYA,CAAC,GAACgD,CAAd,EAAgBhD,CAAC,EAAjB,EAAoB;AAAC,cAAMC,CAAC,GAAC,KAAKc,OAAL,CAAaoC,iBAAb,CAA+BjB,CAAC,CAAClC,CAAD,CAAhC,CAAR;;AAA6C,aAAK,CAAL,KAASC,CAAT,KAAa,KAAK0C,aAAL,CAAmBT,CAAC,CAAClC,CAAD,CAApB,IAAyBC,CAAtC;AAAyC;;AAAA,aAAM,SAAN;AAAgB,KAA1K,CAAP;AAAoL;;AAAAmD,EAAAA,eAAe,CAACpD,CAAD,EAAGG,CAAH,EAAKE,CAAL,EAAOE,CAAP,EAASC,CAAT,EAAW;AAAC,WAAO,KAAKW,aAAL,GAAqBC,IAArB,CAA2B,MAAI,KAAKH,OAAL,CAAaT,CAAb,CAA/B,EAAiDY,IAAjD,CAAuDpB,CAAC,IAAE,IAAIC,CAAJ,CAAMD,CAAC,CAACqB,WAAF,CAAcC,KAAd,CAAoB,CAApB,EAAuB+B,MAAvB,CAA8BrD,CAAC,CAACuB,MAAF,CAASD,KAAT,CAAe,CAAf,CAA9B,CAAN,EAAuD,EAAvD,EAA0D,CAAC,CAA3D,EAA6D,KAAKE,oBAAL,CAA0BxB,CAAC,CAACyB,eAA5B,CAA7D,CAA1D,CAAP;AAA8K;;AAAA6B,EAAAA,aAAa,CAACtD,CAAD,EAAGC,CAAH,EAAK;AAAC,QAAII,CAAC,GAAC,CAAN;AAAA,QAAQE,CAAC,GAAC,IAAV;AAAe,UAAMC,CAAC,GAAC,EAAR;;AAAW,SAAI,IAAI0B,CAAC,GAAC,CAAV,EAAYA,CAAC,GAAClC,CAAC,CAACqB,WAAF,CAAcM,MAA5B,EAAmCO,CAAC,EAApC,EAAuC;AAAC,YAAMM,CAAC,GAAC,KAAKZ,eAAL,CAAqB5B,CAAC,CAACqB,WAAF,CAAca,CAAd,CAArB,CAAR;;AAA+C,UAAGM,CAAC,KAAGrC,CAAC,CAAC4B,YAAT,EAAsB;AAAC,YAAG/B,CAAC,CAACuB,MAAF,CAASqB,IAAT,CAAc5C,CAAC,CAACqB,WAAF,CAAca,CAAd,CAAd,GAAgC7B,CAAC,IAAE,CAAnC,EAAqC,SAAOE,CAAP,GAASA,CAAC,GAAC;AAACgD,UAAAA,KAAK,EAACrB,CAAP;AAASsB,UAAAA,GAAG,EAACtB;AAAb,SAAX,GAA2B3B,CAAC,CAACiD,GAAF,KAAQtB,CAAC,GAAC,CAAV,GAAY3B,CAAC,CAACiD,GAAF,GAAMtB,CAAlB,IAAqB1B,CAAC,CAACoC,IAAF,CAAOrC,CAAP,GAAUA,CAAC,GAAC;AAACgD,UAAAA,KAAK,EAACrB,CAAP;AAASsB,UAAAA,GAAG,EAACtB;AAAb,SAAjC,CAAhE,EAAkHlC,CAAC,CAACuB,MAAF,CAASI,MAAT,IAAiB,KAAKjB,OAA3I,EAAmJ;AAAM,OAAhL,MAAqL,IAAG8B,CAAC,KAAGrC,CAAC,CAAC0B,eAAT,EAAyB,SAAOtB,CAAP,GAASA,CAAC,GAAC;AAACgD,QAAAA,KAAK,EAACrB,CAAP;AAASsB,QAAAA,GAAG,EAACtB;AAAb,OAAX,GAA2B3B,CAAC,CAACiD,GAAF,KAAQtB,CAAC,GAAC,CAAV,GAAY3B,CAAC,CAACiD,GAAF,GAAMtB,CAAlB,IAAqB1B,CAAC,CAACoC,IAAF,CAAOrC,CAAP,GAAUA,CAAC,GAAC;AAACgD,QAAAA,KAAK,EAACrB,CAAP;AAASsB,QAAAA,GAAG,EAACtB;AAAb,OAAjC,CAA3B,EAA6E7B,CAAC,IAAE,CAAhF,CAAzB,KAAgH,IAAGmC,CAAC,KAAGrC,CAAC,CAAC6B,OAAT,EAAiB;;AAAM,UAAG3B,CAAC,IAAEJ,CAAN,EAAQ;AAAM;;AAAA,aAAOM,CAAP,IAAUC,CAAC,CAACoC,IAAF,CAAOrC,CAAP,CAAV;;AAAoB,SAAI,IAAIJ,CAAC,GAACK,CAAC,CAACmB,MAAF,GAAS,CAAnB,EAAqBxB,CAAC,IAAE,CAAxB,EAA0BA,CAAC,EAA3B,EAA8BH,CAAC,CAACqB,WAAF,CAAcoC,MAAd,CAAqBjD,CAAC,CAACL,CAAD,CAAD,CAAKoD,KAA1B,EAAgC/C,CAAC,CAACL,CAAD,CAAD,CAAKqD,GAAL,GAAShD,CAAC,CAACL,CAAD,CAAD,CAAKoD,KAAd,GAAoB,CAApD;;AAAuD,SAAK7B,eAAL,CAAqB1B,CAArB,IAAwB,KAAKU,OAA7B,KAAuCV,CAAC,CAACuB,MAAF,GAASvB,CAAC,CAACuB,MAAF,CAASD,KAAT,CAAe,CAAf,EAAiB,KAAKZ,OAAtB,CAAhD,GAAgF,KAAKgB,eAAL,CAAqB1B,CAArB,KAAyB,KAAKU,OAA9B,KAAwCV,CAAC,CAACqB,WAAF,GAAc,EAAtD,CAAhF;AAA0I;;AAAAqC,EAAAA,KAAK,GAAE;AAAC,WAAOrD,CAAC,CAAC;AAACsD,MAAAA,UAAU,EAAC,CAAC;AAAb,KAAD,CAAR;AAA0B;;AAAAC,EAAAA,gBAAgB,GAAE;AAAC,WAAOvD,CAAC,CAAC,CAAC,CAAF,CAAR;AAAa;;AAAqB,SAAdwD,cAAc,GAAE;AAAC7D,IAAAA,CAAC,CAAC8D,oBAAF,CAAuBC,GAAvB,GAA2B,UAAS/D,CAAT,EAAW;AAAC,aAAO,IAAIQ,CAAJ,CAAM;AAACQ,QAAAA,gBAAgB,EAAC,IAAlB;AAAuBF,QAAAA,MAAM,EAACd;AAA9B,OAAN,CAAP;AAA+C,KAAtF;AAAuF;;AAAt6G;;AAAu6G,eAAeQ,CAAf","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from\"../support/FeatureSet.js\";import e from\"../support/IdSet.js\";import{IdState as n}from\"../support/shared.js\";import{resolve as s,reject as i}from\"../../../core/promiseUtils.js\";class a extends t{constructor(t){super(t),this._topnum=0,this.declaredClass=\"esri.arcade.featureset.actions.Top\",this._countedin=0,this._maxProcessing=100,this._topnum=t.topnum,this._parent=t.parentfeatureset}_getSet(t){return null===this._wset?this._ensureLoaded().then((()=>this._parent._getSet(t))).then((t=>(this._wset=new e(t._candidates.slice(0),t._known.slice(0),!1,this._clonePageDefinition(t.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),this._wset))):s(this._wset)}_setKnownLength(t){return t._known.length>0&&\"GETPAGES\"===t._known[t._known.length-1]?t._known.length-1:t._known.length}_isInFeatureSet(t){const e=this._parent._isInFeatureSet(t);if(e===n.NotInFeatureSet)return e;const s=this._idstates[t];return s===n.InFeatureSet||s===n.NotInFeatureSet?s:e===n.InFeatureSet&&void 0===s?this._countedin<this._topnum?(this._idstates[t]=n.InFeatureSet,this._countedin++,n.InFeatureSet):(this._idstates[t]=n.NotInFeatureSet,n.NotInFeatureSet):n.Unknown}_expandPagedSet(t,e,n,a,r){if(null===this._parent)return i(new Error(\"Parent Paging not implemented\"));if(e>this._topnum&&(e=this._topnum),this._countedin>=this._topnum&&t.pagesDefinition.internal.set.length<=t.pagesDefinition.resultOffset){let e=t._known.length;return e>0&&\"GETPAGES\"===t._known[e-1]&&(t._known.length=e-1),e=t._candidates.length,e>0&&\"GETPAGES\"===t._candidates[e-1]&&(t._candidates.length=e-1),s(\"success\")}return this._parent._expandPagedSet(t,e,n,a,r).then((e=>(this._setKnownLength(t)>this._topnum&&(t._known.length=this._topnum),this._setKnownLength(t)>=this._topnum&&(t._candidates.length=0),e)))}_getFeatures(t,n,i,a){const r=[],o=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(t,o))return this._expandPagedSet(t,o,0,0,a).then((()=>this._getFeatures(t,n,i,a)));-1!==n&&void 0===this._featureCache[n]&&r.push(n);let _=0;for(let e=t._lastFetchedIndex;e<t._known.length&&(_++,_<=i&&(t._lastFetchedIndex+=1),!(void 0===this._featureCache[t._known[e]]&&(t._known[e]!==n&&r.push(t._known[e]),r.length>o)));e++);if(0===r.length)return s(\"success\");const h=new e([],r,!1,null),u=Math.min(r.length,i);return this._parent._getFeatures(h,-1,u,a).then((()=>{for(let t=0;t<u;t++){const e=this._parent._featureFromCache(r[t]);void 0!==e&&(this._featureCache[r[t]]=e)}return\"success\"}))}_getFilteredSet(t,n,s,i,a){return this._ensureLoaded().then((()=>this._getSet(a))).then((t=>new e(t._candidates.slice(0).concat(t._known.slice(0)),[],!1,this._clonePageDefinition(t.pagesDefinition))))}_refineKnowns(t,e){let s=0,i=null;const a=[];for(let r=0;r<t._candidates.length;r++){const o=this._isInFeatureSet(t._candidates[r]);if(o===n.InFeatureSet){if(t._known.push(t._candidates[r]),s+=1,null===i?i={start:r,end:r}:i.end===r-1?i.end=r:(a.push(i),i={start:r,end:r}),t._known.length>=this._topnum)break}else if(o===n.NotInFeatureSet)null===i?i={start:r,end:r}:i.end===r-1?i.end=r:(a.push(i),i={start:r,end:r}),s+=1;else if(o===n.Unknown)break;if(s>=e)break}null!==i&&a.push(i);for(let n=a.length-1;n>=0;n--)t._candidates.splice(a[n].start,a[n].end-a[n].start+1);this._setKnownLength(t)>this._topnum&&(t._known=t._known.slice(0,this._topnum)),this._setKnownLength(t)>=this._topnum&&(t._candidates=[])}_stat(){return s({calculated:!1})}_canDoAggregates(){return s(!1)}static registerAction(){t._featuresetFunctions.top=function(t){return new a({parentfeatureset:this,topnum:t})}}}export default a;\n"]},"metadata":{},"sourceType":"module"}