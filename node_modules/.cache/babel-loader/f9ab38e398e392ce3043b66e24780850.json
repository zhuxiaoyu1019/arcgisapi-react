{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../../../core/Error.js\";\nimport t from \"../../../../../core/Logger.js\";\nimport { isNone as r, isSome as s } from \"../../../../../core/maybe.js\";\nimport i from \"../../../../../core/pbf.js\";\nimport { convertToGeometry as a, unquantizeOptimizedGeometry as n } from \"../../../../../layers/graphics/featureConversionUtils.js\";\nimport o from \"../../../../../layers/graphics/OptimizedFeature.js\";\nimport h from \"../../../../../layers/graphics/OptimizedGeometry.js\";\nimport { FeatureSetReader as u } from \"./FeatureSetReader.js\";\nimport { parseHeader as c } from \"./FeatureSetReaderPBFHeader.js\";\nconst d = t.getLogger(\"esri.view.2d.layers.features.support.FeatureSetReaderPBF\"),\n      _ = 268435455;\n\nfunction g(e) {\n  return e.toLowerCase().trim();\n}\n\nfunction l(t) {\n  try {\n    const e = 2,\n          r = new i(new Uint8Array(t), new DataView(t));\n\n    for (; r.next();) switch (r.tag()) {\n      case e:\n        return f(r.getMessage());\n\n      default:\n        r.skip();\n    }\n  } catch (r) {\n    const t = new e(\"query:parsing-pbf\", \"Error while parsing FeatureSet PBF payload\", {\n      error: r\n    });\n    d.error(t);\n  }\n\n  return null;\n}\n\nfunction f(e) {\n  const t = 1;\n\n  for (; e.next();) switch (e.tag()) {\n    case t:\n      return e.getMessage();\n\n    default:\n      e.skip();\n  }\n\n  return null;\n}\n\nfunction y(e) {\n  const t = 1,\n        r = 2,\n        s = 3,\n        i = 4,\n        a = 5,\n        n = 6,\n        o = 7,\n        h = 8,\n        u = 9,\n        c = e.getLength(),\n        d = e.pos() + c;\n\n  for (; e.pos() < d && e.next();) switch (e.tag()) {\n    case t:\n      return e.getString();\n\n    case r:\n      return e.getFloat();\n\n    case s:\n      return e.getDouble();\n\n    case i:\n      return e.getSInt32();\n\n    case a:\n      return e.getUInt32();\n\n    case n:\n      return e.getInt64();\n\n    case o:\n      return e.getUInt64();\n\n    case h:\n      return e.getSInt64();\n\n    case u:\n      return e.getBool();\n\n    default:\n      return e.skip(), null;\n  }\n\n  return null;\n}\n\nclass m extends u {\n  constructor(e, t, r, s) {\n    super(e), this._hasNext = !1, this._isPoints = !1, this._isPolygons = !1, this._featureIndex = -1, this._featureOffset = 0, this._cache = {\n      area: 0,\n      unquantGeometry: void 0,\n      geometry: void 0,\n      centroid: void 0,\n      legacyFeature: void 0,\n      optFeature: void 0\n    }, this._geometryType = s, this._reader = t, this._header = r, this._hasNext = r.hasFeatures, this._isPoints = \"esriGeometryPoint\" === s, this._isPolygons = \"esriGeometryPolygon\" === s;\n  }\n\n  static fromBuffer(e, t, r = !1) {\n    const s = l(e),\n          i = c(s, \"esriGeometryPoint\" === t, r),\n          a = u.createInstance();\n    return new m(a, s, i, t);\n  }\n\n  get geometryType() {\n    return this._geometryType;\n  }\n\n  get size() {\n    return this._header.featureCount;\n  }\n\n  get hasZ() {\n    return !1;\n  }\n\n  get hasM() {\n    return !1;\n  }\n\n  get stride() {\n    return 2 + (this.hasZ ? 1 : 0) + (this.hasM ? 1 : 0);\n  }\n\n  get hasFeatures() {\n    return this._header.hasFeatures;\n  }\n\n  get hasNext() {\n    return this._hasNext;\n  }\n\n  get exceededTransferLimit() {\n    return this._header.exceededTransferLimit;\n  }\n\n  getSize() {\n    return this.size;\n  }\n\n  getQuantizationTransform() {\n    return this._header.transform;\n  }\n\n  getCursor() {\n    return this.copy();\n  }\n\n  getIndex() {\n    return this._featureIndex;\n  }\n\n  setIndex(e) {\n    this._cache.area = 0, this._cache.unquantGeometry = void 0, this._cache.geometry = void 0, this._cache.centroid = void 0, this._cache.legacyFeature = void 0, this._cache.optFeature = void 0, this._featureIndex = e;\n  }\n\n  getAttributeHash() {\n    let e = \"\";\n    return this._header.fields.forEach(({\n      index: t\n    }) => {\n      e += this._readAttributeAtIndex(t) + \".\";\n    }), e;\n  }\n\n  getObjectId() {\n    return this._readAttributeAtIndex(this._header.objectIdFieldIndex);\n  }\n\n  getDisplayId() {\n    return this._header.displayIds[this._featureIndex];\n  }\n\n  setDisplayId(e) {\n    this._header.displayIds[this._featureIndex] = e;\n  }\n\n  getGroupId() {\n    return this._header.groupIds[this._featureIndex];\n  }\n\n  setGroupId(e) {\n    this._header.groupIds[this._featureIndex] = e;\n  }\n\n  readLegacyFeature() {\n    if (void 0 === this._cache.legacyFeature) {\n      var e;\n      const t = this.readCentroid(),\n            r = {\n        attributes: this.readAttributes(),\n        geometry: this._isPoints ? this.readLegacyPointGeometry() : this.readLegacyGeometry(),\n        centroid: null != (e = t && {\n          x: t.coords[0],\n          y: t.coords[1]\n        }) ? e : null\n      };\n      return this._cache.legacyFeature = r, r;\n    }\n\n    return this._cache.legacyFeature;\n  }\n\n  readOptimizedFeature() {\n    if (void 0 === this._cache.optFeature) {\n      const e = new o(this.readGeometry(), this.readAttributes(), this.readCentroid());\n      return e.objectId = this.getObjectId(), e.displayId = this.getDisplayId(), this._cache.optFeature = e, e;\n    }\n\n    return this._cache.optFeature;\n  }\n\n  getXHydrate() {\n    const e = this._header.centroid[2 * this._featureIndex],\n          t = this.getQuantizationTransform();\n    return r(t) ? e : e * t.scale[0] + t.translate[0];\n  }\n\n  getYHydrate() {\n    const e = this._header.centroid[2 * this._featureIndex + 1],\n          t = this.getQuantizationTransform();\n    return r(t) ? e : t.translate[1] - e * t.scale[1];\n  }\n\n  getX() {\n    return this._header.centroid[2 * this._featureIndex] * this._sx + this._tx;\n  }\n\n  getY() {\n    return this._header.centroid[2 * this._featureIndex + 1] * this._sy + this._ty;\n  }\n\n  readLegacyPointGeometry() {\n    return {\n      x: this.getX(),\n      y: this.getY()\n    };\n  }\n\n  readLegacyGeometry() {\n    const e = this.readGeometry();\n    return a(e, this.geometryType, !1, !1);\n  }\n\n  readLegacyCentroid() {\n    const e = this.readCentroid();\n    if (!e) return null;\n    const [t, r] = e.coords;\n    return {\n      x: t,\n      y: r\n    };\n  }\n\n  readGeometryArea() {\n    return this._cache.area || this.readGeometry(), this._cache.area;\n  }\n\n  readUnquantizedGeometry() {\n    if (void 0 === this._cache.unquantGeometry) {\n      const e = this.readGeometry();\n      if (!e) return this._cache.unquantGeometry = null, null;\n      const t = e.clone(),\n            r = t.lengths,\n            s = t.coords;\n\n      for (let i = 0, a = 2; i < r.length; i++, a += 2) {\n        const e = r[i];\n\n        for (let t = 1; t < e; t += 1, a += 2) s[a] += s[a - 2], s[a + 1] += s[a - 1];\n      }\n\n      return this._cache.unquantGeometry = t, t;\n    }\n\n    return this._cache.unquantGeometry;\n  }\n\n  readHydratedGeometry() {\n    if (this._isPoints) {\n      if (this._header.centroid[2 * this._featureIndex] === _) return null;\n      const e = this.getXHydrate(),\n            t = this.getYHydrate();\n      return new h([], [e, t]);\n    }\n\n    const e = this.readGeometry();\n    if (!e) return null;\n    const t = e.clone(),\n          r = this.getQuantizationTransform();\n    return s(r) && n(t, t, this.hasZ, this.hasM, r), t;\n  }\n\n  readGeometry() {\n    if (void 0 === this._cache.geometry) {\n      let t = null;\n\n      if (this._isPoints) {\n        if (this._header.centroid[2 * this._featureIndex] === _) return null;\n        const e = this.getX(),\n              r = this.getY();\n        t = new h([], [e, r]);\n      } else {\n        const r = this._header.offsets.geometry[this._featureIndex],\n              s = this._reader;\n        if (0 === r) return null;\n        s.move(r);\n\n        try {\n          t = this._parseGeometry(s);\n        } catch (e) {\n          return console.error(\"Failed to parse geometry!\", e), null;\n        }\n      }\n\n      return this._cache.geometry = t, t;\n    }\n\n    return this._cache.geometry;\n  }\n\n  readCentroid() {\n    if (void 0 === this._cache.centroid) {\n      let e = null;\n      const t = this._header.centroid[2 * this._featureIndex] + this._tx,\n            r = this._header.centroid[2 * this._featureIndex + 1] + this._ty;\n      return t === _ ? (e = this._computeCentroid(), e && (this._header.centroid[2 * this._featureIndex] = e.coords[0] - this._tx, this._header.centroid[2 * this._featureIndex + 1] = e.coords[1] - this._ty)) : e = new h([], [t, r]), this._cache.centroid = e, e;\n    }\n\n    return this._cache.centroid;\n  }\n\n  copy() {\n    const e = this._reader.clone(),\n          t = new m(this.instance, e, this._header, this.geometryType);\n\n    return this.copyInto(t), t;\n  }\n\n  next() {\n    for (this._cache.area = 0, this._cache.unquantGeometry = void 0, this._cache.geometry = void 0, this._cache.centroid = void 0, this._cache.legacyFeature = void 0, this._cache.optFeature = void 0; ++this._featureIndex < this.size && !this._getExists(););\n\n    return this._featureIndex < this.size;\n  }\n\n  _readAttribute(e, t) {\n    const r = this._header.hasField(e) ? e : g(e),\n          s = this._header.getFieldIndex(r);\n\n    if (null == s) return;\n\n    const i = this._readAttributeAtIndex(s);\n\n    if (!t) return i;\n    if (null == i) return i;\n    return this._header.isDateField(r) ? new Date(i) : i;\n  }\n\n  _readAttributes() {\n    const e = {};\n    return this._header.fields.forEach(({\n      fieldName: t,\n      index: r\n    }) => {\n      e[t] = this._readAttributeAtIndex(r);\n    }), e;\n  }\n\n  copyInto(e) {\n    super.copyInto(e), e._featureIndex = this._featureIndex, e._featureOffset = this._featureOffset, e._hasNext = this._hasNext;\n  }\n\n  _readAttributeAtIndex(e) {\n    const t = this._header.offsets.attributes[this._featureIndex * this._header.fieldCount + e],\n          r = this._reader;\n    return r.move(t), y(r);\n  }\n\n  _preprocessPolygon(e, t) {\n    let r = 0,\n        s = 0,\n        i = 0,\n        a = !1,\n        n = !1,\n        o = !1,\n        u = -1;\n    const c = 1e6,\n          d = [];\n    let _ = 0,\n        g = !1;\n\n    for (let h = 0; h < t.length; h++) {\n      const l = t[h];\n      let f = e[2 * r],\n          y = e[2 * r + 1],\n          m = 0;\n\n      for (let t = 1; t < l; t++) {\n        const s = f,\n              i = y,\n              a = f + e[2 * (r + t)],\n              n = y + e[2 * (r + t) + 1];\n        f = a, y = n, m += .5 * ((a - s) * (n + i));\n      }\n\n      const p = m > 0;\n      if (p && g && (s += l), p || (u++, g = !1), u >= c) break;\n      _ += m, a && p && n && (o = !0);\n      {\n        e[2 * i] = e[2 * s], e[2 * i++ + 1] = e[2 * s++ + 1];\n        let t = 1,\n            r = e[2 * s],\n            a = e[2 * s++ + 1];\n\n        for (let n = 2; n < l; n++) {\n          const n = e[2 * s],\n                o = e[2 * s++ + 1];\n          0 === r * o - n * a && r * n + a * o > 0 ? (r += n, a += o) : (e[2 * i] = r, e[2 * i++ + 1] = a, t++, r = n, a = o);\n        }\n\n        e[2 * i] = r, e[2 * i++ + 1] = a, t++, d.push(t);\n      }\n      a = !1, n = !0, r += l;\n    }\n\n    return d.length ? (this._cache.area = Math.abs(_), new h(d, e, o)) : null;\n  }\n\n  _parseGeometry(e) {\n    const t = 1,\n          r = 2,\n          s = 3,\n          i = e.getLength(),\n          a = e.pos() + i,\n          n = [],\n          o = [];\n\n    for (; e.pos() < a && e.next();) switch (e.tag()) {\n      case r:\n        {\n          const t = e.getUInt32(),\n                r = e.pos() + t;\n\n          for (; e.pos() < r;) o.push(e.getUInt32());\n\n          break;\n        }\n\n      case s:\n        {\n          const t = e.getUInt32(),\n                r = e.pos() + t;\n\n          for (; e.pos() < r;) n.push(e.getSInt32()), n.push(e.getSInt32()), this.hasZ && e.getSInt32(), this.hasM && e.getSInt32();\n\n          break;\n        }\n\n      case t:\n      default:\n        e.skip();\n    }\n\n    let u = 0;\n\n    for (const h of o) n[2 * u] += this._tx, n[2 * u + 1] += this._ty, u += h;\n\n    return this._isPolygons ? this._preprocessPolygon(n, o) : new h(o, n);\n  }\n\n}\n\nexport { m as FeatureSetReaderPBF };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/2d/layers/features/support/FeatureSetReaderPBF.js"],"names":["e","t","isNone","r","isSome","s","i","convertToGeometry","a","unquantizeOptimizedGeometry","n","o","h","FeatureSetReader","u","parseHeader","c","d","getLogger","_","g","toLowerCase","trim","l","Uint8Array","DataView","next","tag","f","getMessage","skip","error","y","getLength","pos","getString","getFloat","getDouble","getSInt32","getUInt32","getInt64","getUInt64","getSInt64","getBool","m","constructor","_hasNext","_isPoints","_isPolygons","_featureIndex","_featureOffset","_cache","area","unquantGeometry","geometry","centroid","legacyFeature","optFeature","_geometryType","_reader","_header","hasFeatures","fromBuffer","createInstance","geometryType","size","featureCount","hasZ","hasM","stride","hasNext","exceededTransferLimit","getSize","getQuantizationTransform","transform","getCursor","copy","getIndex","setIndex","getAttributeHash","fields","forEach","index","_readAttributeAtIndex","getObjectId","objectIdFieldIndex","getDisplayId","displayIds","setDisplayId","getGroupId","groupIds","setGroupId","readLegacyFeature","readCentroid","attributes","readAttributes","readLegacyPointGeometry","readLegacyGeometry","x","coords","readOptimizedFeature","readGeometry","objectId","displayId","getXHydrate","scale","translate","getYHydrate","getX","_sx","_tx","getY","_sy","_ty","readLegacyCentroid","readGeometryArea","readUnquantizedGeometry","clone","lengths","length","readHydratedGeometry","offsets","move","_parseGeometry","console","_computeCentroid","instance","copyInto","_getExists","_readAttribute","hasField","getFieldIndex","isDateField","Date","_readAttributes","fieldName","fieldCount","_preprocessPolygon","p","push","Math","abs","FeatureSetReaderPBF"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../../../core/Error.js\";import t from\"../../../../../core/Logger.js\";import{isNone as r,isSome as s}from\"../../../../../core/maybe.js\";import i from\"../../../../../core/pbf.js\";import{convertToGeometry as a,unquantizeOptimizedGeometry as n}from\"../../../../../layers/graphics/featureConversionUtils.js\";import o from\"../../../../../layers/graphics/OptimizedFeature.js\";import h from\"../../../../../layers/graphics/OptimizedGeometry.js\";import{FeatureSetReader as u}from\"./FeatureSetReader.js\";import{parseHeader as c}from\"./FeatureSetReaderPBFHeader.js\";const d=t.getLogger(\"esri.view.2d.layers.features.support.FeatureSetReaderPBF\"),_=268435455;function g(e){return e.toLowerCase().trim()}function l(t){try{const e=2,r=new i(new Uint8Array(t),new DataView(t));for(;r.next();)switch(r.tag()){case e:return f(r.getMessage());default:r.skip()}}catch(r){const t=new e(\"query:parsing-pbf\",\"Error while parsing FeatureSet PBF payload\",{error:r});d.error(t)}return null}function f(e){const t=1;for(;e.next();)switch(e.tag()){case t:return e.getMessage();default:e.skip()}return null}function y(e){const t=1,r=2,s=3,i=4,a=5,n=6,o=7,h=8,u=9,c=e.getLength(),d=e.pos()+c;for(;e.pos()<d&&e.next();)switch(e.tag()){case t:return e.getString();case r:return e.getFloat();case s:return e.getDouble();case i:return e.getSInt32();case a:return e.getUInt32();case n:return e.getInt64();case o:return e.getUInt64();case h:return e.getSInt64();case u:return e.getBool();default:return e.skip(),null}return null}class m extends u{constructor(e,t,r,s){super(e),this._hasNext=!1,this._isPoints=!1,this._isPolygons=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._geometryType=s,this._reader=t,this._header=r,this._hasNext=r.hasFeatures,this._isPoints=\"esriGeometryPoint\"===s,this._isPolygons=\"esriGeometryPolygon\"===s}static fromBuffer(e,t,r=!1){const s=l(e),i=c(s,\"esriGeometryPoint\"===t,r),a=u.createInstance();return new m(a,s,i,t)}get geometryType(){return this._geometryType}get size(){return this._header.featureCount}get hasZ(){return!1}get hasM(){return!1}get stride(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}getSize(){return this.size}getQuantizationTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=e}getAttributeHash(){let e=\"\";return this._header.fields.forEach((({index:t})=>{e+=this._readAttributeAtIndex(t)+\".\"})),e}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(e){this._header.displayIds[this._featureIndex]=e}getGroupId(){return this._header.groupIds[this._featureIndex]}setGroupId(e){this._header.groupIds[this._featureIndex]=e}readLegacyFeature(){if(void 0===this._cache.legacyFeature){var e;const t=this.readCentroid(),r={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:null!=(e=t&&{x:t.coords[0],y:t.coords[1]})?e:null};return this._cache.legacyFeature=r,r}return this._cache.legacyFeature}readOptimizedFeature(){if(void 0===this._cache.optFeature){const e=new o(this.readGeometry(),this.readAttributes(),this.readCentroid());return e.objectId=this.getObjectId(),e.displayId=this.getDisplayId(),this._cache.optFeature=e,e}return this._cache.optFeature}getXHydrate(){const e=this._header.centroid[2*this._featureIndex],t=this.getQuantizationTransform();return r(t)?e:e*t.scale[0]+t.translate[0]}getYHydrate(){const e=this._header.centroid[2*this._featureIndex+1],t=this.getQuantizationTransform();return r(t)?e:t.translate[1]-e*t.scale[1]}getX(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx}getY(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty}readLegacyPointGeometry(){return{x:this.getX(),y:this.getY()}}readLegacyGeometry(){const e=this.readGeometry();return a(e,this.geometryType,!1,!1)}readLegacyCentroid(){const e=this.readCentroid();if(!e)return null;const[t,r]=e.coords;return{x:t,y:r}}readGeometryArea(){return this._cache.area||this.readGeometry(),this._cache.area}readUnquantizedGeometry(){if(void 0===this._cache.unquantGeometry){const e=this.readGeometry();if(!e)return this._cache.unquantGeometry=null,null;const t=e.clone(),r=t.lengths,s=t.coords;for(let i=0,a=2;i<r.length;i++,a+=2){const e=r[i];for(let t=1;t<e;t+=1,a+=2)s[a]+=s[a-2],s[a+1]+=s[a-1]}return this._cache.unquantGeometry=t,t}return this._cache.unquantGeometry}readHydratedGeometry(){if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===_)return null;const e=this.getXHydrate(),t=this.getYHydrate();return new h([],[e,t])}const e=this.readGeometry();if(!e)return null;const t=e.clone(),r=this.getQuantizationTransform();return s(r)&&n(t,t,this.hasZ,this.hasM,r),t}readGeometry(){if(void 0===this._cache.geometry){let t=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===_)return null;const e=this.getX(),r=this.getY();t=new h([],[e,r])}else{const r=this._header.offsets.geometry[this._featureIndex],s=this._reader;if(0===r)return null;s.move(r);try{t=this._parseGeometry(s)}catch(e){return console.error(\"Failed to parse geometry!\",e),null}}return this._cache.geometry=t,t}return this._cache.geometry}readCentroid(){if(void 0===this._cache.centroid){let e=null;const t=this._header.centroid[2*this._featureIndex]+this._tx,r=this._header.centroid[2*this._featureIndex+1]+this._ty;return t===_?(e=this._computeCentroid(),e&&(this._header.centroid[2*this._featureIndex]=e.coords[0]-this._tx,this._header.centroid[2*this._featureIndex+1]=e.coords[1]-this._ty)):e=new h([],[t,r]),this._cache.centroid=e,e}return this._cache.centroid}copy(){const e=this._reader.clone(),t=new m(this.instance,e,this._header,this.geometryType);return this.copyInto(t),t}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this.size&&!this._getExists(););return this._featureIndex<this.size}_readAttribute(e,t){const r=this._header.hasField(e)?e:g(e),s=this._header.getFieldIndex(r);if(null==s)return;const i=this._readAttributeAtIndex(s);if(!t)return i;if(null==i)return i;return this._header.isDateField(r)?new Date(i):i}_readAttributes(){const e={};return this._header.fields.forEach((({fieldName:t,index:r})=>{e[t]=this._readAttributeAtIndex(r)})),e}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._featureOffset=this._featureOffset,e._hasNext=this._hasNext}_readAttributeAtIndex(e){const t=this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e],r=this._reader;return r.move(t),y(r)}_preprocessPolygon(e,t){let r=0,s=0,i=0,a=!1,n=!1,o=!1,u=-1;const c=1e6,d=[];let _=0,g=!1;for(let h=0;h<t.length;h++){const l=t[h];let f=e[2*r],y=e[2*r+1],m=0;for(let t=1;t<l;t++){const s=f,i=y,a=f+e[2*(r+t)],n=y+e[2*(r+t)+1];f=a,y=n,m+=.5*((a-s)*(n+i))}const p=m>0;if(p&&g&&(s+=l),p||(u++,g=!1),u>=c)break;_+=m,a&&p&&n&&(o=!0);{e[2*i]=e[2*s],e[2*i+++1]=e[2*s+++1];let t=1,r=e[2*s],a=e[2*s+++1];for(let n=2;n<l;n++){const n=e[2*s],o=e[2*s+++1];0===r*o-n*a&&r*n+a*o>0?(r+=n,a+=o):(e[2*i]=r,e[2*i+++1]=a,t++,r=n,a=o)}e[2*i]=r,e[2*i+++1]=a,t++,d.push(t)}a=!1,n=!0,r+=l}return d.length?(this._cache.area=Math.abs(_),new h(d,e,o)):null}_parseGeometry(e){const t=1,r=2,s=3,i=e.getLength(),a=e.pos()+i,n=[],o=[];for(;e.pos()<a&&e.next();)switch(e.tag()){case r:{const t=e.getUInt32(),r=e.pos()+t;for(;e.pos()<r;)o.push(e.getUInt32());break}case s:{const t=e.getUInt32(),r=e.pos()+t;for(;e.pos()<r;)n.push(e.getSInt32()),n.push(e.getSInt32()),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();break}case t:default:e.skip()}let u=0;for(const h of o)n[2*u]+=this._tx,n[2*u+1]+=this._ty,u+=h;return this._isPolygons?this._preprocessPolygon(n,o):new h(o,n)}}export{m as FeatureSetReaderPBF};\n"]},"metadata":{},"sourceType":"module"}