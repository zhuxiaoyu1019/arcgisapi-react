{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from \"../../../Camera.js\";\nimport i from \"../../../Viewpoint.js\";\nimport e from \"../../../core/Error.js\";\nimport { isSome as a, isNone as n } from \"../../../core/maybe.js\";\nimport { createAbortController as o, onAbort as r, createAbortError as s } from \"../../../core/promiseUtils.js\";\nimport { whenOnce as l } from \"../../../core/watchUtils.js\";\nimport { applyAll as c } from \"../camera/constraintUtils.js\";\nimport { State as h } from \"./controllers/CameraController.js\";\nimport { PointToPointAnimationController as m } from \"./controllers/PointToPointAnimationController.js\";\nimport { SurfaceCollisionCorrectionController as w } from \"./controllers/SurfaceCollisionCorrectionController.js\";\nimport { externalToInternal as p } from \"../support/cameraUtils.js\";\nimport { create as f } from \"../support/viewpointUtils.js\";\nimport { applySurfaceCollisionConstraint as v } from \"../camera/constraintUtils/surfaceCollision.js\";\n\nclass C {\n  constructor(t, i, e) {\n    this.target = t, this.options = i, this.view = e, this.state = \"pending\", this.abortController = null, this.animationController = null, this.promise = new Promise((t, i) => {\n      this.resolveCallback = t, this.rejectCallback = i;\n      const e = o();\n      a(this.options.signal) && r(this.options.signal, () => {\n        this.abort();\n      }), this.abortController = e, this.waitForReady();\n    });\n  }\n\n  then(t, i) {\n    return this.promise.then(t, i);\n  }\n\n  catch(t) {\n    return this.promise.catch(t);\n  }\n\n  resolve(t) {\n    return this.state = \"finished\", this.resolveCallback(t);\n  }\n\n  reject(t) {\n    return this.state = \"finished\", this.rejectCallback(t);\n  }\n\n  abort(t = !1) {\n    switch (this.state) {\n      case \"pending\":\n      case \"wait-for-ready\":\n      case \"wait-for-viewpoint\":\n        this.reject(s());\n        break;\n\n      case \"wait-for-animation-finish\":\n        !t && a(this.animationController) && this.view.state.cameraController === this.animationController && this.animationController.active && this.animationController.stopController(), this.reject(s());\n    }\n  }\n\n  waitForReady() {\n    this.state = \"wait-for-ready\", this.view.ready ? this.createViewPoint() : l(this.view, \"ready\", this.abortController.signal).then(() => {\n      this.createViewPoint();\n    }, t => {\n      this.reject(t);\n    });\n  }\n\n  createViewPoint() {\n    \"finished\" !== this.state && (this.state = \"wait-for-viewpoint\", this.animationController = this.options.animate ? this.getAnimationController() : null, f(this.view, this.target, this.abortController.signal).then(t => {\n      if (\"finished\" === this.state) return;\n      const i = this.getCameraFromViewpoint(t);\n      if (!n(i)) if (this.options.animate) {\n        if (n(this.animationController)) return;\n        this.startAnimation(i, this.animationController);\n      } else this.view.stateManager.setStateCamera(i.camera, {\n        applyConstraints: !i.isFullySpecified,\n        positionAndOrientationOnly: !0,\n        doNotCancelGoToOperation: !0\n      }), this.resolve();\n    }, t => {\n      this.reject(t);\n    }));\n  }\n\n  getCameraFromViewpoint(a) {\n    const o = !!(this.target instanceof i && this.target.camera || this.target instanceof t),\n          r = a.camera;\n    if (n(r)) return null;\n\n    if (!this.view.stateManager.isCompatible(r)) {\n      const t = r.position,\n            i = t && t.spatialReference,\n            a = i ? i.wkid : \"none\",\n            n = this.view.spatialReference.wkid;\n      return this.reject(new e(\"GotoAnimation:incompatible-spatialreference\", `Resulting camera has an incompatible spatial reference (camera: ${a}, view: ${n})`, {\n        camera: r\n      })), null;\n    }\n\n    const s = p(this.view, r);\n    return n(s) ? (this.reject(new e(\"GotoAnimation:invalid-camera\", \"Resulting camera is invalid\")), null) : {\n      viewpoint: a,\n      camera: s,\n      isFullySpecified: o\n    };\n  }\n\n  startAnimation(t, i) {\n    this.state = \"wait-for-animation-finish\";\n    const o = i.viewAnimation;\n    if (n(o)) return void this.reject(new e(\"GotoAnimation:missing-animation\", \"Unreachable code in view.stateManager\"));\n    if (o.update(t.viewpoint, \"running\"), !i.active || n(i.viewAnimation) || i.viewAnimation.target !== t.viewpoint || this.view.state.cameraController !== i) return this.abort();\n    let r;\n    t.isFullySpecified ? (r = new w({\n      view: this.view,\n      desiredCamera: t.camera\n    }), v(this.view, t.camera, 1)) : c(this.view, t.camera), i.begin(t.camera, this.options);\n\n    const s = () => {\n      const e = this.view.state.cameraController;\n      r && (e && e.active ? e instanceof m && a(e.viewAnimation) && e.viewAnimation.target === t.viewpoint && (this.view.state.cameraController = r) : a(i.viewAnimation) && i.viewAnimation.target === t.viewpoint && \"finished\" === i.state && (this.view.state.cameraController = r));\n    },\n          l = t => {\n      if (!n(this.view.state)) switch (i.state) {\n        case h.Finished:\n          switch (this.state) {\n            case \"pending\":\n            case \"wait-for-ready\":\n            case \"wait-for-viewpoint\":\n            case \"wait-for-animation-finish\":\n              this.resolve();\n          }\n\n          break;\n\n        case h.Ready:\n        case h.Rejected:\n        case h.Running:\n        case h.Stopped:\n          switch (this.state) {\n            case \"pending\":\n            case \"wait-for-ready\":\n            case \"wait-for-viewpoint\":\n            case \"wait-for-animation-finish\":\n              this.reject(t);\n          }\n\n      }\n    };\n\n    o.when(s, t => l(t)), i.asyncResult = {\n      resolve: () => l(),\n      reject: t => l(t)\n    };\n  }\n\n  getAnimationController() {\n    let t,\n        i = null;\n    const n = this.view.state.cameraController;\n    return n instanceof m && (n.updateStateFromViewAnimation(), n.active && (t = n, i = t.viewAnimation)), null != t || (t = new m({\n      view: this.view,\n      mode: \"animation\"\n    }), i = t.viewAnimation, this.view.state.switchCameraController(t)) ? t : (a(i) && i.stop(), this.reject(new e(\"GotoAnimation:goto-cannot-interrupt\", \"Cannot start an animation while interacting\")), null);\n  }\n\n}\n\nexport { C as GoToOperation };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/state/GoToOperation.js"],"names":["t","i","e","isSome","a","isNone","n","createAbortController","o","onAbort","r","createAbortError","s","whenOnce","l","applyAll","c","State","h","PointToPointAnimationController","m","SurfaceCollisionCorrectionController","w","externalToInternal","p","create","f","applySurfaceCollisionConstraint","v","C","constructor","target","options","view","state","abortController","animationController","promise","Promise","resolveCallback","rejectCallback","signal","abort","waitForReady","then","catch","resolve","reject","cameraController","active","stopController","ready","createViewPoint","animate","getAnimationController","getCameraFromViewpoint","startAnimation","stateManager","setStateCamera","camera","applyConstraints","isFullySpecified","positionAndOrientationOnly","doNotCancelGoToOperation","isCompatible","position","spatialReference","wkid","viewpoint","viewAnimation","update","desiredCamera","begin","Finished","Ready","Rejected","Running","Stopped","when","asyncResult","updateStateFromViewAnimation","mode","switchCameraController","stop","GoToOperation"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from\"../../../Camera.js\";import i from\"../../../Viewpoint.js\";import e from\"../../../core/Error.js\";import{isSome as a,isNone as n}from\"../../../core/maybe.js\";import{createAbortController as o,onAbort as r,createAbortError as s}from\"../../../core/promiseUtils.js\";import{whenOnce as l}from\"../../../core/watchUtils.js\";import{applyAll as c}from\"../camera/constraintUtils.js\";import{State as h}from\"./controllers/CameraController.js\";import{PointToPointAnimationController as m}from\"./controllers/PointToPointAnimationController.js\";import{SurfaceCollisionCorrectionController as w}from\"./controllers/SurfaceCollisionCorrectionController.js\";import{externalToInternal as p}from\"../support/cameraUtils.js\";import{create as f}from\"../support/viewpointUtils.js\";import{applySurfaceCollisionConstraint as v}from\"../camera/constraintUtils/surfaceCollision.js\";class C{constructor(t,i,e){this.target=t,this.options=i,this.view=e,this.state=\"pending\",this.abortController=null,this.animationController=null,this.promise=new Promise(((t,i)=>{this.resolveCallback=t,this.rejectCallback=i;const e=o();a(this.options.signal)&&r(this.options.signal,(()=>{this.abort()})),this.abortController=e,this.waitForReady()}))}then(t,i){return this.promise.then(t,i)}catch(t){return this.promise.catch(t)}resolve(t){return this.state=\"finished\",this.resolveCallback(t)}reject(t){return this.state=\"finished\",this.rejectCallback(t)}abort(t=!1){switch(this.state){case\"pending\":case\"wait-for-ready\":case\"wait-for-viewpoint\":this.reject(s());break;case\"wait-for-animation-finish\":!t&&a(this.animationController)&&this.view.state.cameraController===this.animationController&&this.animationController.active&&this.animationController.stopController(),this.reject(s())}}waitForReady(){this.state=\"wait-for-ready\",this.view.ready?this.createViewPoint():l(this.view,\"ready\",this.abortController.signal).then((()=>{this.createViewPoint()}),(t=>{this.reject(t)}))}createViewPoint(){\"finished\"!==this.state&&(this.state=\"wait-for-viewpoint\",this.animationController=this.options.animate?this.getAnimationController():null,f(this.view,this.target,this.abortController.signal).then((t=>{if(\"finished\"===this.state)return;const i=this.getCameraFromViewpoint(t);if(!n(i))if(this.options.animate){if(n(this.animationController))return;this.startAnimation(i,this.animationController)}else this.view.stateManager.setStateCamera(i.camera,{applyConstraints:!i.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()}),(t=>{this.reject(t)})))}getCameraFromViewpoint(a){const o=!!(this.target instanceof i&&this.target.camera||this.target instanceof t),r=a.camera;if(n(r))return null;if(!this.view.stateManager.isCompatible(r)){const t=r.position,i=t&&t.spatialReference,a=i?i.wkid:\"none\",n=this.view.spatialReference.wkid;return this.reject(new e(\"GotoAnimation:incompatible-spatialreference\",`Resulting camera has an incompatible spatial reference (camera: ${a}, view: ${n})`,{camera:r})),null}const s=p(this.view,r);return n(s)?(this.reject(new e(\"GotoAnimation:invalid-camera\",\"Resulting camera is invalid\")),null):{viewpoint:a,camera:s,isFullySpecified:o}}startAnimation(t,i){this.state=\"wait-for-animation-finish\";const o=i.viewAnimation;if(n(o))return void this.reject(new e(\"GotoAnimation:missing-animation\",\"Unreachable code in view.stateManager\"));if(o.update(t.viewpoint,\"running\"),!i.active||n(i.viewAnimation)||i.viewAnimation.target!==t.viewpoint||this.view.state.cameraController!==i)return this.abort();let r;t.isFullySpecified?(r=new w({view:this.view,desiredCamera:t.camera}),v(this.view,t.camera,1)):c(this.view,t.camera),i.begin(t.camera,this.options);const s=()=>{const e=this.view.state.cameraController;r&&(e&&e.active?e instanceof m&&a(e.viewAnimation)&&e.viewAnimation.target===t.viewpoint&&(this.view.state.cameraController=r):a(i.viewAnimation)&&i.viewAnimation.target===t.viewpoint&&\"finished\"===i.state&&(this.view.state.cameraController=r))},l=t=>{if(!n(this.view.state))switch(i.state){case h.Finished:switch(this.state){case\"pending\":case\"wait-for-ready\":case\"wait-for-viewpoint\":case\"wait-for-animation-finish\":this.resolve()}break;case h.Ready:case h.Rejected:case h.Running:case h.Stopped:switch(this.state){case\"pending\":case\"wait-for-ready\":case\"wait-for-viewpoint\":case\"wait-for-animation-finish\":this.reject(t)}}};o.when(s,(t=>l(t))),i.asyncResult={resolve:()=>l(),reject:t=>l(t)}}getAnimationController(){let t,i=null;const n=this.view.state.cameraController;return n instanceof m&&(n.updateStateFromViewAnimation(),n.active&&(t=n,i=t.viewAnimation)),null!=t||(t=new m({view:this.view,mode:\"animation\"}),i=t.viewAnimation,this.view.state.switchCameraController(t))?t:(a(i)&&i.stop(),this.reject(new e(\"GotoAnimation:goto-cannot-interrupt\",\"Cannot start an animation while interacting\")),null)}}export{C as GoToOperation};\n"]},"metadata":{},"sourceType":"module"}