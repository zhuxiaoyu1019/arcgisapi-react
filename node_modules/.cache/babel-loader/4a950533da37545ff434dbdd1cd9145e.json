{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { disposeMaybe as e, isSome as i } from \"../../../../core/maybe.js\";\nimport { c as t } from \"../../../../chunks/vec4.js\";\nimport { f as r } from \"../../../../chunks/vec4f32.js\";\nimport { c as o } from \"../../../../chunks/vec4f64.js\";\nimport a from \"../../support/debugFlags.js\";\nimport { Default3D as s } from \"./DefaultVertexAttributeLocations.js\";\nimport { Pos2Tex as l } from \"./DefaultVertexBufferLayouts.js\";\nimport { createQuadVAO as h } from \"./glUtil3D.js\";\nimport { HighlightCompositionTechniqueConfiguration as p, HighlightCompositionTechnique as c } from \"../shaders/HighlightTechnique.js\";\nimport g from \"../../../webgl/BufferObject.js\";\nimport u from \"../../../webgl/FramebufferObject.js\";\nimport { vertexCount as m } from \"../../../webgl/Util.js\";\nimport n from \"../../../webgl/VertexArrayObject.js\";\nconst d = 32;\n\nclass b {\n  constructor(e, i) {\n    this._techniqueRep = e, this._rctx = i, this.viewportToRestore = o(), this.defaultOptions = {\n      color: r(1, 0, 1, 1),\n      haloColor: r(1, 0, 1, 1),\n      haloOpacity: 1,\n      fillOpacity: .2,\n      haloOpacityOccluded: .25,\n      fillOpacityOccluded: .05,\n      shadowColor: r(1, 0, 1, 1),\n      shadowOpacity: .15,\n      occludedShadowOpacity: .075\n    }, this._grid = {\n      coverageMipmap: null,\n      vao: null,\n      verticalCellCount: 0,\n      horizontalCellCount: 0,\n      cellPixelSize: 0,\n      mipmapLevels: 0,\n      viewportWidth: 0,\n      viewportHeight: 0\n    };\n  }\n\n  assertResources() {\n    if (this.quadVAO) return;\n    this.quadVAO = h(this._rctx);\n    const e = {\n      colorTarget: 0,\n      depthStencilTarget: 0,\n      width: 0,\n      height: 0\n    },\n          i = {\n      target: 3553,\n      pixelFormat: 6408,\n      dataType: 5121,\n      samplingMode: 9729,\n      wrapMode: 33071,\n      width: 0,\n      height: 0\n    };\n    this.blur0Fbo = new u(this._rctx, e, i), this.blur1Fbo = new u(this._rctx, e, i);\n    const t = new p();\n    t.highlightStage = 0, t.gridOptimization = !1, this.blurTechnique = this._techniqueRep.acquire(c, t), t.highlightStage = 0, t.gridOptimization = !0, this.blurGridTechnique = this._techniqueRep.acquire(c, t), t.highlightStage = 1, t.gridOptimization = !1, this.applyTechnique = this._techniqueRep.acquire(c, t), t.highlightStage = 1, t.gridOptimization = !0, this.applyGridTechnique = this._techniqueRep.acquire(c, t), t.highlightStage = 2, t.gridOptimization = !1, this.downsampleTechnique = this._techniqueRep.acquire(c, t);\n  }\n\n  dispose() {\n    if (this._grid.coverageMipmap) for (let e = 1; e < this._grid.coverageMipmap.length; e++) this._grid.coverageMipmap[e].dispose();\n    this._grid.vao && this._grid.vao.dispose(!0), this.quadVAO && (this.quadVAO.dispose(!0), this.quadVAO = null), this.blur0Fbo = e(this.blur0Fbo), this.blur1Fbo = e(this.blur1Fbo);\n  }\n\n  get profilingCallback() {\n    return a.HIGHLIGHTS_PROFILE_TO_CONSOLE ? e => console.log(e) : null;\n  }\n\n  setDefaultOptions(e) {\n    this.defaultOptions = e;\n  }\n\n  render(e, i, r) {\n    const o = e.pixelRatio,\n          s = a.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED,\n          l = this._rctx;\n    this.assertResources(), t(this.viewportToRestore, e.fullViewport);\n    const h = e.fullWidth,\n          p = e.fullHeight,\n          c = Math.ceil(h / o),\n          g = Math.ceil(p / o);\n    this.blur0Fbo.resize(c, g), this.blur1Fbo.resize(c, g), l.bindVAO(this.quadVAO);\n    let u = null;\n    const n = s ? this.blurGridTechnique : this.blurTechnique;\n    n.bindPipelineState(l), l.useProgram(n.program), s ? (this._gridUpdateResources(i, d), this._gridComputeMipmap(), u = this._grid.vao, n.program.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture, \"coverageTex\")) : u = this.quadVAO, l.bindVAO(u), l.bindFramebuffer(this.blur0Fbo), l.setViewport(0, 0, c, g), l.setClearColor(0, 0, 0, 0), l.clear(16384), n.program.bindTexture(i.colorTexture, \"tex\"), n.program.setUniform2f(\"blurSize\", 1 / c, 0), l.drawArrays(n.primitiveType, 0, m(u, \"geometry\")), l.bindFramebuffer(this.blur1Fbo), l.clear(16384), n.program.bindTexture(this.blur0Fbo.colorTexture, \"tex\"), n.program.setUniform2f(\"blurSize\", 0, 1 / g), l.drawArrays(n.primitiveType, 0, m(u, \"geometry\"));\n    const b = s ? this.applyGridTechnique : this.applyTechnique;\n\n    if (l.bindFramebuffer(r), b.bindPipelineState(l), l.setViewport(this.viewportToRestore[0], this.viewportToRestore[1], this.viewportToRestore[2], this.viewportToRestore[3]), l.useProgram(b.program), b.program.bindTexture(this.blur1Fbo.colorTexture, \"tex\"), b.program.bindTexture(i.colorTexture, \"origin\"), s) {\n      const e = this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture;\n      b.program.bindTexture(e, \"coverageTex\");\n    }\n\n    b.bindApplyPass(this.defaultOptions), l.drawArrays(b.primitiveType, 0, m(u, \"geometry\")), l.bindVAO(null);\n  }\n\n  _gridUpdateResources(e, i) {\n    const t = this._rctx,\n          r = this._grid;\n    let o = !1;\n\n    if (null === r.coverageMipmap && (r.coverageMipmap = [e], o = !0), r.viewportWidth === e.width && r.viewportHeight === e.height || (o = !0, r.viewportWidth = e.width, r.viewportHeight = e.height), r.coverageMipmap[0] = e, r.cellPixelSize !== i && (r.cellPixelSize = i, o = !0), o) {\n      for (let e = 1; e < r.coverageMipmap.length; e++) r.coverageMipmap[e].dispose();\n\n      r.mipmapLevels = Math.ceil(Math.log(r.cellPixelSize) * Math.LOG2E), r.coverageMipmap.length = r.mipmapLevels + 1;\n\n      for (let e = 0; e < r.mipmapLevels; e++) {\n        const i = r.coverageMipmap[e],\n              o = {\n          target: 3553,\n          pixelFormat: 6407,\n          dataType: 33635,\n          samplingMode: 9729,\n          wrapMode: 33071,\n          width: Math.ceil(i.width / 2),\n          height: Math.ceil(i.height / 2)\n        },\n              a = {\n          colorTarget: 0,\n          depthStencilTarget: 0,\n          width: Math.ceil(i.width / 2),\n          height: Math.ceil(i.height / 2)\n        };\n        r.coverageMipmap[e + 1] = new u(t, a, o);\n      }\n    }\n\n    const a = Math.ceil(e.height / r.cellPixelSize),\n          h = Math.ceil(e.width / r.cellPixelSize);\n\n    if (!r.vao || r.verticalCellCount !== a || r.horizontalCellCount !== h) {\n      r.verticalCellCount = a, r.horizontalCellCount = h;\n      const e = a + 1,\n            i = h + 1,\n            o = 1 / a,\n            p = 1 / h,\n            c = 6,\n            u = 4,\n            m = new Float32Array(c * u * e * i);\n      let d = 0;\n\n      for (let t = 0; t < e; t++) for (let e = 0; e < i; e++) m[d + 0] = (e - .5) * p * 2 - 1, m[d + 1] = (t - .5) * o * 2 - 1, m[d + 2] = e * p, m[d + 3] = t * o, m[d + 4] = (e + .5) * p * 2 - 1, m[d + 5] = (t - .5) * o * 2 - 1, m[d + 6] = e * p, m[d + 7] = t * o, m[d + 8] = (e - .5) * p * 2 - 1, m[d + 9] = (t + .5) * o * 2 - 1, m[d + 10] = e * p, m[d + 11] = t * o, m[d + 12] = (e - .5) * p * 2 - 1, m[d + 13] = (t + .5) * o * 2 - 1, m[d + 14] = e * p, m[d + 15] = t * o, m[d + 16] = (e + .5) * p * 2 - 1, m[d + 17] = (t - .5) * o * 2 - 1, m[d + 18] = e * p, m[d + 19] = t * o, m[d + 20] = (e + .5) * p * 2 - 1, m[d + 21] = (t + .5) * o * 2 - 1, m[d + 22] = e * p, m[d + 23] = t * o, d += c * u;\n\n      r.vao && r.vao.dispose(!0), r.vao = new n(t, s, {\n        geometry: l\n      }, {\n        geometry: g.createVertex(t, 35044, m)\n      });\n    }\n  }\n\n  _gridComputeMipmap() {\n    const e = this._rctx,\n          i = this._grid,\n          t = this.downsampleTechnique.program;\n    this.downsampleTechnique.bindPipelineState(e), e.bindVAO(this.quadVAO), e.useProgram(t);\n\n    for (let r = 0; r < i.mipmapLevels; r++) {\n      e.bindFramebuffer(i.coverageMipmap[r + 1]), t.bindTexture(i.coverageMipmap[r].colorTexture, \"tex\");\n      const o = i.coverageMipmap[r + 1].width,\n            a = i.coverageMipmap[r + 1].height;\n      t.setUniform2f(\"invFramebufferDim\", 1 / o, 1 / a), e.setViewport(0, 0, o, a), e.drawArrays(5, 0, m(this.quadVAO, \"geometry\"));\n    }\n  }\n\n  getGpuMemoryUsage() {\n    let e = (i(this.blur0Fbo) ? this.blur0Fbo.gpuMemoryUsage : 0) + (i(this.blur1Fbo) ? this.blur1Fbo.gpuMemoryUsage : 0);\n    if (this._grid.coverageMipmap) for (const i of this._grid.coverageMipmap) e += i.gpuMemoryUsage;\n    return e;\n  }\n\n  get test() {\n    return {\n      coverage: this._grid.coverageMipmap,\n      blur: [this.blur0Fbo, this.blur1Fbo]\n    };\n  }\n\n}\n\nexport default b;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/webgl-engine/lib/HighlightHelper.js"],"names":["disposeMaybe","e","isSome","i","c","t","f","r","o","a","Default3D","s","Pos2Tex","l","createQuadVAO","h","HighlightCompositionTechniqueConfiguration","p","HighlightCompositionTechnique","g","u","vertexCount","m","n","d","b","constructor","_techniqueRep","_rctx","viewportToRestore","defaultOptions","color","haloColor","haloOpacity","fillOpacity","haloOpacityOccluded","fillOpacityOccluded","shadowColor","shadowOpacity","occludedShadowOpacity","_grid","coverageMipmap","vao","verticalCellCount","horizontalCellCount","cellPixelSize","mipmapLevels","viewportWidth","viewportHeight","assertResources","quadVAO","colorTarget","depthStencilTarget","width","height","target","pixelFormat","dataType","samplingMode","wrapMode","blur0Fbo","blur1Fbo","highlightStage","gridOptimization","blurTechnique","acquire","blurGridTechnique","applyTechnique","applyGridTechnique","downsampleTechnique","dispose","length","profilingCallback","HIGHLIGHTS_PROFILE_TO_CONSOLE","console","log","setDefaultOptions","render","pixelRatio","HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED","fullViewport","fullWidth","fullHeight","Math","ceil","resize","bindVAO","bindPipelineState","useProgram","program","_gridUpdateResources","_gridComputeMipmap","bindTexture","colorTexture","bindFramebuffer","setViewport","setClearColor","clear","setUniform2f","drawArrays","primitiveType","bindApplyPass","LOG2E","Float32Array","geometry","createVertex","getGpuMemoryUsage","gpuMemoryUsage","test","coverage","blur"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{disposeMaybe as e,isSome as i}from\"../../../../core/maybe.js\";import{c as t}from\"../../../../chunks/vec4.js\";import{f as r}from\"../../../../chunks/vec4f32.js\";import{c as o}from\"../../../../chunks/vec4f64.js\";import a from\"../../support/debugFlags.js\";import{Default3D as s}from\"./DefaultVertexAttributeLocations.js\";import{Pos2Tex as l}from\"./DefaultVertexBufferLayouts.js\";import{createQuadVAO as h}from\"./glUtil3D.js\";import{HighlightCompositionTechniqueConfiguration as p,HighlightCompositionTechnique as c}from\"../shaders/HighlightTechnique.js\";import g from\"../../../webgl/BufferObject.js\";import u from\"../../../webgl/FramebufferObject.js\";import{vertexCount as m}from\"../../../webgl/Util.js\";import n from\"../../../webgl/VertexArrayObject.js\";const d=32;class b{constructor(e,i){this._techniqueRep=e,this._rctx=i,this.viewportToRestore=o(),this.defaultOptions={color:r(1,0,1,1),haloColor:r(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05,shadowColor:r(1,0,1,1),shadowOpacity:.15,occludedShadowOpacity:.075},this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0}}assertResources(){if(this.quadVAO)return;this.quadVAO=h(this._rctx);const e={colorTarget:0,depthStencilTarget:0,width:0,height:0},i={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=new u(this._rctx,e,i),this.blur1Fbo=new u(this._rctx,e,i);const t=new p;t.highlightStage=0,t.gridOptimization=!1,this.blurTechnique=this._techniqueRep.acquire(c,t),t.highlightStage=0,t.gridOptimization=!0,this.blurGridTechnique=this._techniqueRep.acquire(c,t),t.highlightStage=1,t.gridOptimization=!1,this.applyTechnique=this._techniqueRep.acquire(c,t),t.highlightStage=1,t.gridOptimization=!0,this.applyGridTechnique=this._techniqueRep.acquire(c,t),t.highlightStage=2,t.gridOptimization=!1,this.downsampleTechnique=this._techniqueRep.acquire(c,t)}dispose(){if(this._grid.coverageMipmap)for(let e=1;e<this._grid.coverageMipmap.length;e++)this._grid.coverageMipmap[e].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this.quadVAO&&(this.quadVAO.dispose(!0),this.quadVAO=null),this.blur0Fbo=e(this.blur0Fbo),this.blur1Fbo=e(this.blur1Fbo)}get profilingCallback(){return a.HIGHLIGHTS_PROFILE_TO_CONSOLE?e=>console.log(e):null}setDefaultOptions(e){this.defaultOptions=e}render(e,i,r){const o=e.pixelRatio,s=a.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED,l=this._rctx;this.assertResources(),t(this.viewportToRestore,e.fullViewport);const h=e.fullWidth,p=e.fullHeight,c=Math.ceil(h/o),g=Math.ceil(p/o);this.blur0Fbo.resize(c,g),this.blur1Fbo.resize(c,g),l.bindVAO(this.quadVAO);let u=null;const n=s?this.blurGridTechnique:this.blurTechnique;n.bindPipelineState(l),l.useProgram(n.program),s?(this._gridUpdateResources(i,d),this._gridComputeMipmap(),u=this._grid.vao,n.program.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,\"coverageTex\")):u=this.quadVAO,l.bindVAO(u),l.bindFramebuffer(this.blur0Fbo),l.setViewport(0,0,c,g),l.setClearColor(0,0,0,0),l.clear(16384),n.program.bindTexture(i.colorTexture,\"tex\"),n.program.setUniform2f(\"blurSize\",1/c,0),l.drawArrays(n.primitiveType,0,m(u,\"geometry\")),l.bindFramebuffer(this.blur1Fbo),l.clear(16384),n.program.bindTexture(this.blur0Fbo.colorTexture,\"tex\"),n.program.setUniform2f(\"blurSize\",0,1/g),l.drawArrays(n.primitiveType,0,m(u,\"geometry\"));const b=s?this.applyGridTechnique:this.applyTechnique;if(l.bindFramebuffer(r),b.bindPipelineState(l),l.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]),l.useProgram(b.program),b.program.bindTexture(this.blur1Fbo.colorTexture,\"tex\"),b.program.bindTexture(i.colorTexture,\"origin\"),s){const e=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture;b.program.bindTexture(e,\"coverageTex\")}b.bindApplyPass(this.defaultOptions),l.drawArrays(b.primitiveType,0,m(u,\"geometry\")),l.bindVAO(null)}_gridUpdateResources(e,i){const t=this._rctx,r=this._grid;let o=!1;if(null===r.coverageMipmap&&(r.coverageMipmap=[e],o=!0),r.viewportWidth===e.width&&r.viewportHeight===e.height||(o=!0,r.viewportWidth=e.width,r.viewportHeight=e.height),r.coverageMipmap[0]=e,r.cellPixelSize!==i&&(r.cellPixelSize=i,o=!0),o){for(let e=1;e<r.coverageMipmap.length;e++)r.coverageMipmap[e].dispose();r.mipmapLevels=Math.ceil(Math.log(r.cellPixelSize)*Math.LOG2E),r.coverageMipmap.length=r.mipmapLevels+1;for(let e=0;e<r.mipmapLevels;e++){const i=r.coverageMipmap[e],o={target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(i.width/2),height:Math.ceil(i.height/2)},a={colorTarget:0,depthStencilTarget:0,width:Math.ceil(i.width/2),height:Math.ceil(i.height/2)};r.coverageMipmap[e+1]=new u(t,a,o)}}const a=Math.ceil(e.height/r.cellPixelSize),h=Math.ceil(e.width/r.cellPixelSize);if(!r.vao||r.verticalCellCount!==a||r.horizontalCellCount!==h){r.verticalCellCount=a,r.horizontalCellCount=h;const e=a+1,i=h+1,o=1/a,p=1/h,c=6,u=4,m=new Float32Array(c*u*e*i);let d=0;for(let t=0;t<e;t++)for(let e=0;e<i;e++)m[d+0]=(e-.5)*p*2-1,m[d+1]=(t-.5)*o*2-1,m[d+2]=e*p,m[d+3]=t*o,m[d+4]=(e+.5)*p*2-1,m[d+5]=(t-.5)*o*2-1,m[d+6]=e*p,m[d+7]=t*o,m[d+8]=(e-.5)*p*2-1,m[d+9]=(t+.5)*o*2-1,m[d+10]=e*p,m[d+11]=t*o,m[d+12]=(e-.5)*p*2-1,m[d+13]=(t+.5)*o*2-1,m[d+14]=e*p,m[d+15]=t*o,m[d+16]=(e+.5)*p*2-1,m[d+17]=(t-.5)*o*2-1,m[d+18]=e*p,m[d+19]=t*o,m[d+20]=(e+.5)*p*2-1,m[d+21]=(t+.5)*o*2-1,m[d+22]=e*p,m[d+23]=t*o,d+=c*u;r.vao&&r.vao.dispose(!0),r.vao=new n(t,s,{geometry:l},{geometry:g.createVertex(t,35044,m)})}}_gridComputeMipmap(){const e=this._rctx,i=this._grid,t=this.downsampleTechnique.program;this.downsampleTechnique.bindPipelineState(e),e.bindVAO(this.quadVAO),e.useProgram(t);for(let r=0;r<i.mipmapLevels;r++){e.bindFramebuffer(i.coverageMipmap[r+1]),t.bindTexture(i.coverageMipmap[r].colorTexture,\"tex\");const o=i.coverageMipmap[r+1].width,a=i.coverageMipmap[r+1].height;t.setUniform2f(\"invFramebufferDim\",1/o,1/a),e.setViewport(0,0,o,a),e.drawArrays(5,0,m(this.quadVAO,\"geometry\"))}}getGpuMemoryUsage(){let e=(i(this.blur0Fbo)?this.blur0Fbo.gpuMemoryUsage:0)+(i(this.blur1Fbo)?this.blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap)for(const i of this._grid.coverageMipmap)e+=i.gpuMemoryUsage;return e}get test(){return{coverage:this._grid.coverageMipmap,blur:[this.blur0Fbo,this.blur1Fbo]}}}export default b;\n"]},"metadata":{},"sourceType":"module"}