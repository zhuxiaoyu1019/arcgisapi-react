{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { equals as e } from \"../../../../core/arrayUtils.js\";\nimport t from \"../../../../core/Handles.js\";\nimport { smoothstep as i } from \"../../../../core/mathUtils.js\";\nimport { isNone as s, disposeMaybe as r } from \"../../../../core/maybe.js\";\nimport { reactionInit as a } from \"../../../../core/accessorSupport/trackingUtils.js\";\nimport { t as o, a as n } from \"../../../../chunks/mat4.js\";\nimport { c as h } from \"../../../../chunks/mat4f64.js\";\nimport { a as c } from \"../../../../chunks/vec2f64.js\";\nimport { z as _, g as u } from \"../../../../chunks/vec3.js\";\nimport { c as m } from \"../../../../chunks/vec3f64.js\";\nimport { c as l } from \"../../../../chunks/vec4f64.js\";\nimport \"../../../webgl/BufferObject.js\";\nimport d from \"../../../webgl/FramebufferObject.js\";\nimport \"../../../../core/has.js\";\nimport \"../../../webgl/enums.js\";\nimport \"../../../webgl/RenderingContext.js\";\nimport \"../../../../chunks/builtins.js\";\nimport \"../../../webgl/Texture.js\";\nimport \"../../../webgl/VertexArrayObject.js\";\nimport p from \"./Camera.js\";\nimport { ZERO as g } from \"./depthRange.js\";\nimport { createQuadVAO as w } from \"./glUtil3D.js\";\nimport { ShadowAccumulationRenderer as f, shadowAccumulationDisabledElevationThreshold as v, shadowAccumulationDisableElevationMax as b, shadowAccumulationDisableElevationMin as j } from \"./ShadowAccumulationRenderer.js\";\nimport S from \"./ShadowMap.js\";\nimport { inverseProjectionInfo as C } from \"./Util.js\";\nimport { s as x } from \"../../../../chunks/ShadowAccumulation.glsl.js\";\nimport { ShadowAccumulationTechniqueConfiguration as A, ShadowAccumulationTechnique as F } from \"../shaders/ShadowAccumulationTechnique.js\";\nimport { TaskPriority as R } from \"../../../support/Scheduler.js\";\nimport { vertexCount as T } from \"../../../webgl/Util.js\";\n\nclass M {\n  constructor(e, i, r, o, n, _) {\n    this._rctx = e, this._stage = r, this._prepareForShadowMapPass = o, this._renderToShadowMap = n, this._requestRender = _, this._progress = 0, this._sampleCount = 0, this._cachedCamera = new p(), this._contentCamera = new p(), this._enabled = !1, this._cachedLightDirections = [], this._depthRange = g, this._previewing = !1, this._handles = new t(), this._cameraForcedForScreenshot = !1, this._shadowMap = new S(e, r.viewingMode), this._shadowMap.enabled = !0, this._vao = w(e);\n    const u = {\n      rctx: e,\n      viewingMode: r.viewingMode\n    },\n          m = new A();\n    m.pass = 0, this._accumulationTechnique = new F(u, m);\n    const v = {\n      colorTarget: 0,\n      depthStencilTarget: 0,\n      width: 0,\n      height: 0\n    },\n          b = {\n      target: 3553,\n      pixelFormat: 6408,\n      dataType: 5121,\n      samplingMode: 9729,\n      wrapMode: 33071,\n      width: 0,\n      height: 0\n    };\n    this._fbo = new d(e, v, b), this._accumulationParams = {\n      camera: this._cachedCamera,\n      linearDepthTexture: null,\n      shadowMap: this._shadowMap,\n      inverseView: h(),\n      projInfo: l(),\n      zScale: c()\n    }, this._accumulationRenderer = new f(i, e, this, _);\n    const j = this._stage.resourceController.scheduler;\n    this._handles.add(j.registerTask(R.SHADOW_ACCUMULATOR, this)), this._handles.add(a(() => r.renderView, e => {\n      this._handles.remove(M.renderViewHandleKey), s(e) || this._handles.add(e.events.on(\"force-camera-for-screenshot\", () => this._cameraForcedForScreenshot = !0), M.renderViewHandleKey);\n    }));\n  }\n\n  get computedSamples() {\n    return this._progress;\n  }\n\n  get accumulationTexture() {\n    return this._fbo.colorTexture;\n  }\n\n  get running() {\n    return this._isRefining && this._canAccumulate;\n  }\n\n  get isAccumulating() {\n    return this._isPreviewing || this._isRefining;\n  }\n\n  get _isRefining() {\n    return this._isActive && !this._isDoneAccumulating && !this._previewing;\n  }\n\n  get _isPreviewing() {\n    return this._isActive && this._previewing;\n  }\n\n  get _isActive() {\n    return this._enabled && this._sampleCount > 0;\n  }\n\n  get _canAccumulate() {\n    return null !== this._accumulationParams.linearDepthTexture && this._depthRange !== g && this._opacityFromElevation > v;\n  }\n\n  get _isDoneAccumulating() {\n    return this._progress >= this._sampleCount;\n  }\n\n  get _lightDirections() {\n    return this._cachedLightDirections;\n  }\n\n  set _lightDirections(t) {\n    const i = this._cachedLightDirections;\n    if (e(i, t, _)) return;\n    const s = t.length;\n    i.length = s, this._sampleCount = Math.min(x, s);\n\n    for (let e = 0; e < s; ++e) {\n      const s = t[e],\n            r = i[e] || m();\n      u(r, s), i[e] = r;\n    }\n\n    this._invalidate();\n  }\n\n  get _projInfo() {\n    return this._accumulationParams.projInfo;\n  }\n\n  get _zScale() {\n    return this._accumulationParams.zScale;\n  }\n\n  get _inverseView() {\n    return this._accumulationParams.inverseView;\n  }\n\n  get _opacityFromElevation() {\n    return this._accumulationRenderer.opacityFromElevation;\n  }\n\n  set _opacityFromElevation(e) {\n    this._accumulationRenderer.opacityFromElevation = e;\n  }\n\n  runTask(e) {\n    for (this._prepareForShadowMapPass(this._cachedCamera, this._contentCamera); !e.done && !this._isDoneAccumulating;) this._accumulateShadow(), e.madeProgress();\n\n    this._requestRender();\n  }\n\n  accumulateFixedSamples() {\n    if (!this.isAccumulating || !this._canAccumulate) return;\n    (this._previewing || 0 === this._progress || this._cameraForcedForScreenshot) && this._clear();\n    const e = this._cameraForcedForScreenshot ? this._sampleCount : Math.min(M.previewSamples, this._sampleCount - this._progress);\n\n    for (let t = 0; t < e; ++t) this._accumulateShadow();\n\n    this._cameraForcedForScreenshot = !1;\n  }\n\n  render() {\n    this._accumulationRenderer.render();\n  }\n\n  dispose() {\n    this._stop(), this._handles.destroy(), this._accumulationRenderer = r(this._accumulationRenderer), this._shadowMap = r(this._shadowMap), this._fbo = r(this._fbo), this._vao = r(this._vao), this._accumulationTechnique = r(this._accumulationTechnique), this._cachedLightDirections.length = 0, this._sampleCount = 0;\n  }\n\n  setOptions(e) {\n    void 0 !== e.enabled && this._setEnabled(e.enabled), void 0 !== e.previewing && this.setPreviewing(e.previewing), void 0 !== e.lightDirections && this.setLightDirections(e.lightDirections), this._accumulationRenderer.setOptions(e);\n  }\n\n  setPreviewing(e) {\n    this._previewing !== e && (this._previewing = e, this._requestRenderIfEnabled());\n  }\n\n  setLightDirections(e) {\n    this._lightDirections = e;\n  }\n\n  setAccumulationDependencies(e, t, i, s) {\n    this._accumulationParams.linearDepthTexture = e, this._depthRange = t, this._updateCamera(i), this._contentCamera = s;\n  }\n\n  readAccumulatedShadow(e, t) {\n    if (!this._isActive || this._progress < 1 || e < 0 || e > this._fbo.width || t < 0 || t > this._fbo.height) return 0;\n    const i = D;\n    return this._fbo.readPixels(e, t, 1, 1, 6408, 5121, i), i[0] / this._progress;\n  }\n\n  _start() {\n    this._progress = 0, this._enabled = !0;\n  }\n\n  _stop() {\n    this._enabled = !1;\n  }\n\n  _invalidate() {\n    this._progress = 0, this._requestRenderIfEnabled();\n  }\n\n  _clear() {\n    this._rctx.bindFramebuffer(this._fbo), this._rctx.setClearColor(0, 0, 0, 0), this._rctx.clearSafe(16384), this._progress = 0;\n  }\n\n  _accumulateShadow() {\n    const e = this._lightDirections[this._progress],\n          t = this._cachedCamera;\n    this._renderToShadowMap(this._shadowMap, e, t, this._depthRange), this._rctx.bindFramebuffer(this._fbo), this._rctx.useProgram(this._accumulationTechnique.program), this._accumulationTechnique.bindPipelineState(this._rctx), this._accumulationTechnique.bindPass(this._accumulationParams), this._rctx.bindVAO(this._vao), this._rctx.drawArrays(this._accumulationTechnique.primitiveType, 0, T(this._vao, \"geometry\")), this._progress++;\n  }\n\n  _updateCamera(e) {\n    if (e.equals(this._cachedCamera)) return;\n    const {\n      fullWidth: t,\n      fullHeight: s,\n      projectionMatrix: r,\n      viewMatrix: a,\n      center: h\n    } = e;\n    this._cachedCamera.copyFrom(e), this._fbo.resize(t, s), C(r, t, s, this._projInfo, this._zScale), o(this._inverseView, a, h), n(this._inverseView, this._inverseView), this._opacityFromElevation = 1 - i(j, b, e.relativeElevation);\n  }\n\n  _setEnabled(e) {\n    e !== this._enabled && (e ? this._start() : this._stop());\n  }\n\n  _requestRenderIfEnabled() {\n    this._enabled && this._requestRender();\n  }\n\n}\n\nM.previewSamples = 6, M.renderViewHandleKey = \"renderView\";\nconst D = new Uint8Array(4);\nexport { M as ShadowAccumulator };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/webgl-engine/lib/ShadowAccumulator.js"],"names":["equals","e","t","smoothstep","i","isNone","s","disposeMaybe","r","reactionInit","a","o","n","c","h","z","_","g","u","m","l","d","p","ZERO","createQuadVAO","w","ShadowAccumulationRenderer","f","shadowAccumulationDisabledElevationThreshold","v","shadowAccumulationDisableElevationMax","b","shadowAccumulationDisableElevationMin","j","S","inverseProjectionInfo","C","x","ShadowAccumulationTechniqueConfiguration","A","ShadowAccumulationTechnique","F","TaskPriority","R","vertexCount","T","M","constructor","_rctx","_stage","_prepareForShadowMapPass","_renderToShadowMap","_requestRender","_progress","_sampleCount","_cachedCamera","_contentCamera","_enabled","_cachedLightDirections","_depthRange","_previewing","_handles","_cameraForcedForScreenshot","_shadowMap","viewingMode","enabled","_vao","rctx","pass","_accumulationTechnique","colorTarget","depthStencilTarget","width","height","target","pixelFormat","dataType","samplingMode","wrapMode","_fbo","_accumulationParams","camera","linearDepthTexture","shadowMap","inverseView","projInfo","zScale","_accumulationRenderer","resourceController","scheduler","add","registerTask","SHADOW_ACCUMULATOR","renderView","remove","renderViewHandleKey","events","on","computedSamples","accumulationTexture","colorTexture","running","_isRefining","_canAccumulate","isAccumulating","_isPreviewing","_isActive","_isDoneAccumulating","_opacityFromElevation","_lightDirections","length","Math","min","_invalidate","_projInfo","_zScale","_inverseView","opacityFromElevation","runTask","done","_accumulateShadow","madeProgress","accumulateFixedSamples","_clear","previewSamples","render","dispose","_stop","destroy","setOptions","_setEnabled","previewing","setPreviewing","lightDirections","setLightDirections","_requestRenderIfEnabled","setAccumulationDependencies","_updateCamera","readAccumulatedShadow","D","readPixels","_start","bindFramebuffer","setClearColor","clearSafe","useProgram","program","bindPipelineState","bindPass","bindVAO","drawArrays","primitiveType","fullWidth","fullHeight","projectionMatrix","viewMatrix","center","copyFrom","resize","relativeElevation","Uint8Array","ShadowAccumulator"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{equals as e}from\"../../../../core/arrayUtils.js\";import t from\"../../../../core/Handles.js\";import{smoothstep as i}from\"../../../../core/mathUtils.js\";import{isNone as s,disposeMaybe as r}from\"../../../../core/maybe.js\";import{reactionInit as a}from\"../../../../core/accessorSupport/trackingUtils.js\";import{t as o,a as n}from\"../../../../chunks/mat4.js\";import{c as h}from\"../../../../chunks/mat4f64.js\";import{a as c}from\"../../../../chunks/vec2f64.js\";import{z as _,g as u}from\"../../../../chunks/vec3.js\";import{c as m}from\"../../../../chunks/vec3f64.js\";import{c as l}from\"../../../../chunks/vec4f64.js\";import\"../../../webgl/BufferObject.js\";import d from\"../../../webgl/FramebufferObject.js\";import\"../../../../core/has.js\";import\"../../../webgl/enums.js\";import\"../../../webgl/RenderingContext.js\";import\"../../../../chunks/builtins.js\";import\"../../../webgl/Texture.js\";import\"../../../webgl/VertexArrayObject.js\";import p from\"./Camera.js\";import{ZERO as g}from\"./depthRange.js\";import{createQuadVAO as w}from\"./glUtil3D.js\";import{ShadowAccumulationRenderer as f,shadowAccumulationDisabledElevationThreshold as v,shadowAccumulationDisableElevationMax as b,shadowAccumulationDisableElevationMin as j}from\"./ShadowAccumulationRenderer.js\";import S from\"./ShadowMap.js\";import{inverseProjectionInfo as C}from\"./Util.js\";import{s as x}from\"../../../../chunks/ShadowAccumulation.glsl.js\";import{ShadowAccumulationTechniqueConfiguration as A,ShadowAccumulationTechnique as F}from\"../shaders/ShadowAccumulationTechnique.js\";import{TaskPriority as R}from\"../../../support/Scheduler.js\";import{vertexCount as T}from\"../../../webgl/Util.js\";class M{constructor(e,i,r,o,n,_){this._rctx=e,this._stage=r,this._prepareForShadowMapPass=o,this._renderToShadowMap=n,this._requestRender=_,this._progress=0,this._sampleCount=0,this._cachedCamera=new p,this._contentCamera=new p,this._enabled=!1,this._cachedLightDirections=[],this._depthRange=g,this._previewing=!1,this._handles=new t,this._cameraForcedForScreenshot=!1,this._shadowMap=new S(e,r.viewingMode),this._shadowMap.enabled=!0,this._vao=w(e);const u={rctx:e,viewingMode:r.viewingMode},m=new A;m.pass=0,this._accumulationTechnique=new F(u,m);const v={colorTarget:0,depthStencilTarget:0,width:0,height:0},b={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this._fbo=new d(e,v,b),this._accumulationParams={camera:this._cachedCamera,linearDepthTexture:null,shadowMap:this._shadowMap,inverseView:h(),projInfo:l(),zScale:c()},this._accumulationRenderer=new f(i,e,this,_);const j=this._stage.resourceController.scheduler;this._handles.add(j.registerTask(R.SHADOW_ACCUMULATOR,this)),this._handles.add(a((()=>r.renderView),(e=>{this._handles.remove(M.renderViewHandleKey),s(e)||this._handles.add(e.events.on(\"force-camera-for-screenshot\",(()=>this._cameraForcedForScreenshot=!0)),M.renderViewHandleKey)})))}get computedSamples(){return this._progress}get accumulationTexture(){return this._fbo.colorTexture}get running(){return this._isRefining&&this._canAccumulate}get isAccumulating(){return this._isPreviewing||this._isRefining}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._enabled&&this._sampleCount>0}get _canAccumulate(){return null!==this._accumulationParams.linearDepthTexture&&this._depthRange!==g&&this._opacityFromElevation>v}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(t){const i=this._cachedLightDirections;if(e(i,t,_))return;const s=t.length;i.length=s,this._sampleCount=Math.min(x,s);for(let e=0;e<s;++e){const s=t[e],r=i[e]||m();u(r,s),i[e]=r}this._invalidate()}get _projInfo(){return this._accumulationParams.projInfo}get _zScale(){return this._accumulationParams.zScale}get _inverseView(){return this._accumulationParams.inverseView}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}runTask(e){for(this._prepareForShadowMapPass(this._cachedCamera,this._contentCamera);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}accumulateFixedSamples(){if(!this.isAccumulating||!this._canAccumulate)return;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const e=this._cameraForcedForScreenshot?this._sampleCount:Math.min(M.previewSamples,this._sampleCount-this._progress);for(let t=0;t<e;++t)this._accumulateShadow();this._cameraForcedForScreenshot=!1}render(){this._accumulationRenderer.render()}dispose(){this._stop(),this._handles.destroy(),this._accumulationRenderer=r(this._accumulationRenderer),this._shadowMap=r(this._shadowMap),this._fbo=r(this._fbo),this._vao=r(this._vao),this._accumulationTechnique=r(this._accumulationTechnique),this._cachedLightDirections.length=0,this._sampleCount=0}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.previewing&&this.setPreviewing(e.previewing),void 0!==e.lightDirections&&this.setLightDirections(e.lightDirections),this._accumulationRenderer.setOptions(e)}setPreviewing(e){this._previewing!==e&&(this._previewing=e,this._requestRenderIfEnabled())}setLightDirections(e){this._lightDirections=e}setAccumulationDependencies(e,t,i,s){this._accumulationParams.linearDepthTexture=e,this._depthRange=t,this._updateCamera(i),this._contentCamera=s}readAccumulatedShadow(e,t){if(!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height)return 0;const i=D;return this._fbo.readPixels(e,t,1,1,6408,5121,i),i[0]/this._progress}_start(){this._progress=0,this._enabled=!0}_stop(){this._enabled=!1}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(16384),this._progress=0}_accumulateShadow(){const e=this._lightDirections[this._progress],t=this._cachedCamera;this._renderToShadowMap(this._shadowMap,e,t,this._depthRange),this._rctx.bindFramebuffer(this._fbo),this._rctx.useProgram(this._accumulationTechnique.program),this._accumulationTechnique.bindPipelineState(this._rctx),this._accumulationTechnique.bindPass(this._accumulationParams),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(this._accumulationTechnique.primitiveType,0,T(this._vao,\"geometry\")),this._progress++}_updateCamera(e){if(e.equals(this._cachedCamera))return;const{fullWidth:t,fullHeight:s,projectionMatrix:r,viewMatrix:a,center:h}=e;this._cachedCamera.copyFrom(e),this._fbo.resize(t,s),C(r,t,s,this._projInfo,this._zScale),o(this._inverseView,a,h),n(this._inverseView,this._inverseView),this._opacityFromElevation=1-i(j,b,e.relativeElevation)}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}}M.previewSamples=6,M.renderViewHandleKey=\"renderView\";const D=new Uint8Array(4);export{M as ShadowAccumulator};\n"]},"metadata":{},"sourceType":"module"}