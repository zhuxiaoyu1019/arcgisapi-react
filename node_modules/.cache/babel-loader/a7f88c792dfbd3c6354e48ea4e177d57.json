{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isSome as e } from \"../../../../core/maybe.js\";\nimport { g as t } from \"../../../../chunks/vec3.js\";\nimport { intersectLine as i } from \"../../support/orientedBoundingBox.js\";\nimport { IntersectorResult as r } from \"../../webgl-engine/lib/intersectorUtils.js\";\nimport { getVerticalOffsetI3S as s } from \"../../webgl-engine/lib/verticalOffsetUtils.js\";\n\nclass n {\n  constructor(e) {\n    this.type = \"I3S\", this.layerUid = e.layerUid, this.sublayerUid = e.sublayerUid, this.collection = e.collection, this.forEach = e.forEach, this.slicePlane = e.slicePlaneEnabled, this.isGround = e.isGround;\n  }\n\n  intersect(n, l, a, d) {\n    const c = n.results,\n          u = 2 === n.options.store,\n          b = n.ray.direction,\n          f = n.tolerance;\n\n    let m = e => e,\n        h = e => e;\n\n    const p = s(n.verticalOffset);\n    e(p) && (m = e => p.applyToMbs(e), h = e => p.applyToObb(e)), this.forEach((s, y) => {\n      if (e(s.geometryObb)) {\n        if (!i(h(s.geometryObb), a, b, f)) return;\n      } else if (e(s.serviceObbInRenderSR)) {\n        if (!i(h(s.serviceObbInRenderSR), a, b, f)) return;\n      } else if (!o(m(s.renderMbs), a, b, f)) return;\n\n      this.collection.intersect(y, a, d, f, p, (e, i, o, b) => {\n        if (i >= 0) {\n          if (null != l && !l(a, d, i)) return;\n\n          const f = r => {\n            r.intersector = this.type, r.target = {\n              type: \"external\",\n              metadata: {\n                layerUid: this.layerUid,\n                sublayerUid: this.sublayerUid,\n                nodeIndex: s.index,\n                componentIndex: e\n              }\n            }, r.dist = i, t(r.normal, o), r.triangleNr = b;\n          };\n\n          if (this.isGround && (null == c.ground.dist || i < c.ground.dist) && f(c.ground), n.options.isFiltered) return;\n\n          if ((null == c.min.dist || i < c.min.dist) && f(c.min), (null == c.max.dist || i > c.max.dist) && f(c.max), u) {\n            const e = new r(n.ray);\n            f(e), n.results.all.push(e);\n          }\n        }\n      });\n    });\n  }\n\n  get intersectionHandlerId() {\n    return this.layerUid;\n  }\n\n}\n\nfunction o(e, t, i, r = 0) {\n  const s = e[3] + r,\n        n = t[0] - e[0],\n        o = t[1] - e[1],\n        l = t[2] - e[2],\n        a = i[0],\n        d = i[1],\n        c = i[2],\n        u = a * n + d * o + c * l;\n  return u * u - (a * a + d * d + c * c) * (n * n + o * o + l * l - s * s) >= 0;\n}\n\nexport { n as I3SIntersectionHandler };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/layers/i3s/I3SIntersectionHandler.js"],"names":["isSome","e","g","t","intersectLine","i","IntersectorResult","r","getVerticalOffsetI3S","s","n","constructor","type","layerUid","sublayerUid","collection","forEach","slicePlane","slicePlaneEnabled","isGround","intersect","l","a","d","c","results","u","options","store","b","ray","direction","f","tolerance","m","h","p","verticalOffset","applyToMbs","applyToObb","y","geometryObb","serviceObbInRenderSR","o","renderMbs","intersector","target","metadata","nodeIndex","index","componentIndex","dist","normal","triangleNr","ground","isFiltered","min","max","all","push","intersectionHandlerId","I3SIntersectionHandler"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isSome as e}from\"../../../../core/maybe.js\";import{g as t}from\"../../../../chunks/vec3.js\";import{intersectLine as i}from\"../../support/orientedBoundingBox.js\";import{IntersectorResult as r}from\"../../webgl-engine/lib/intersectorUtils.js\";import{getVerticalOffsetI3S as s}from\"../../webgl-engine/lib/verticalOffsetUtils.js\";class n{constructor(e){this.type=\"I3S\",this.layerUid=e.layerUid,this.sublayerUid=e.sublayerUid,this.collection=e.collection,this.forEach=e.forEach,this.slicePlane=e.slicePlaneEnabled,this.isGround=e.isGround}intersect(n,l,a,d){const c=n.results,u=2===n.options.store,b=n.ray.direction,f=n.tolerance;let m=e=>e,h=e=>e;const p=s(n.verticalOffset);e(p)&&(m=e=>p.applyToMbs(e),h=e=>p.applyToObb(e)),this.forEach(((s,y)=>{if(e(s.geometryObb)){if(!i(h(s.geometryObb),a,b,f))return}else if(e(s.serviceObbInRenderSR)){if(!i(h(s.serviceObbInRenderSR),a,b,f))return}else if(!o(m(s.renderMbs),a,b,f))return;this.collection.intersect(y,a,d,f,p,((e,i,o,b)=>{if(i>=0){if(null!=l&&!l(a,d,i))return;const f=r=>{r.intersector=this.type,r.target={type:\"external\",metadata:{layerUid:this.layerUid,sublayerUid:this.sublayerUid,nodeIndex:s.index,componentIndex:e}},r.dist=i,t(r.normal,o),r.triangleNr=b};if(this.isGround&&(null==c.ground.dist||i<c.ground.dist)&&f(c.ground),n.options.isFiltered)return;if((null==c.min.dist||i<c.min.dist)&&f(c.min),(null==c.max.dist||i>c.max.dist)&&f(c.max),u){const e=new r(n.ray);f(e),n.results.all.push(e)}}}))}))}get intersectionHandlerId(){return this.layerUid}}function o(e,t,i,r=0){const s=e[3]+r,n=t[0]-e[0],o=t[1]-e[1],l=t[2]-e[2],a=i[0],d=i[1],c=i[2],u=a*n+d*o+c*l;return u*u-(a*a+d*d+c*c)*(n*n+o*o+l*l-s*s)>=0}export{n as I3SIntersectionHandler};\n"]},"metadata":{},"sourceType":"module"}