{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { equals as e } from \"../../../core/arrayUtils.js\";\nimport { clamp as t } from \"../../../core/mathUtils.js\";\nimport { isSome as r, isNone as i } from \"../../../core/maybe.js\";\nimport { empty as s } from \"../../../geometry/support/aaBoundingBox.js\";\nimport { glLayout as a } from \"../support/buffer/glUtil.js\";\nimport { PatchGeometry as o, releaseGeometry as l } from \"./PatchGeometryFactory.js\";\nimport { ELEVATION_DESIRED_RESOLUTION_LEVEL as n } from \"./TerrainConst.js\";\nimport u from \"./TextureFader.js\";\nimport m from \"./TileOverlayData.js\";\nimport { fallsWithinLayer as h } from \"./tileUtils.js\";\nimport { Default3D as c } from \"../webgl-engine/lib/DefaultVertexAttributeLocations.js\";\nimport f from \"../../webgl/BufferObject.js\";\nimport p from \"../../webgl/VertexArrayObject.js\";\n\nclass g {\n  constructor() {\n    this.geometryInfo = new o(), this._textureRef = new u(() => this.tile.surface.textureFadeDuration), this.overlay = new m();\n  }\n\n  init(e) {\n    this.tile = e, this.clear();\n    const t = this.geometryInfo;\n    t.indices = null, t.vertexAttributes = null, s(t.boundingBox), t.numSurfaceIndices = 0, t.numSkirtIndices = 0, t.numWithoutSkirtIndices = 0, t.numVertsPerRow = 0, this.geometryState = {\n      numVertsPerRow: 0,\n      samplerData: null,\n      clippingArea: null,\n      wireframe: !1\n    }, this.opacity = 1, this.localOrigin = null, this.overlay.clear();\n  }\n\n  clear() {\n    this.releaseGeometry(), this.releaseTexture(), this._textureRef.clear();\n  }\n\n  updateGeometry(e, t) {\n    return !!this._updateGeometryState(t) && (this._releaseGeometry(), this._createGeometry(e), !0);\n  }\n\n  releaseGeometry() {\n    return !!this._releaseGeometry() && (this.geometryState = {\n      numVertsPerRow: 0,\n      samplerData: null,\n      clippingArea: null,\n      wireframe: !1\n    }, !0);\n  }\n\n  ensureTexture(e, t) {\n    return r(this._texture) && this._texture.descriptor.width !== e && this.releaseTexture(), i(this._texture) && (this._texture = t(), this.tile.setMemoryDirty()), this._texture;\n  }\n\n  releaseTexture() {\n    r(this._texture) && (this._texture.release(), this._texture = null, this.tile.setMemoryDirty());\n  }\n\n  _updateGeometryState(r) {\n    const i = this._getElevationInfo(),\n          s = this.tile.level;\n\n    let a = s < 8 ? this.tile.numSubdivisionsAtLevel[s] + 1 : 2;\n\n    if (i.samplerData) {\n      const e = this.tile.vlevel - s,\n            r = Math.max(s - i.maxTileLevel, n - e),\n            o = this.tile.maxTesselation;\n      a = t(1 + (o >> r), 2, o + 1);\n    }\n\n    let o = this.tile.clippingArea;\n    this.tile.intersectsClippingArea && !this.tile.isWithinClippingArea || (o = null);\n    const l = this.geometryState;\n    let u = !1;\n    return l.numVertsPerRow !== a && (l.numVertsPerRow = a, u = !0), i.changed && (l.samplerData = i.samplerData, u = !0), e(l.clippingArea, o) || (l.clippingArea = o, u = !0), l.wireframe !== r && (l.wireframe = r, u = !0), u;\n  }\n\n  _createGeometry(e) {\n    this.tile.createGeometry(this.geometryState, this.localOrigin);\n    const t = this.geometryInfo.vertexAttributes,\n          r = this.geometryInfo.indices,\n          i = e.gl;\n    this._vao = new p(e, c, {\n      geometry: a(t.layout)\n    }, {\n      geometry: f.createVertex(e, i.STATIC_DRAW, t.buffer)\n    }, f.createIndex(e, i.STATIC_DRAW, r));\n  }\n\n  _releaseGeometry() {\n    return !!this._vao && (this._vao.dispose(), this._vao = null, l(this.geometryInfo), !0);\n  }\n\n  get vao() {\n    return this._vao;\n  }\n\n  setTextureReference(e, t, r, i, s = 0) {\n    e !== this._texture && this.releaseTexture(), this._textureRef.push(e, t, r, i, s);\n  }\n\n  get textureReference() {\n    return this._textureRef.current;\n  }\n\n  get nextTextureReference() {\n    return this._textureRef.next;\n  }\n\n  get textureFadeFactor() {\n    return this._textureRef.fadeFactor;\n  }\n\n  get textureIsFading() {\n    return this._textureRef.isFading;\n  }\n\n  _getElevationInfo() {\n    const e = this.geometryState.samplerData,\n          t = this.tile.layerInfo[0],\n          r = t.length;\n    let i = new Array(r),\n        s = 0,\n        a = 0,\n        o = !1;\n\n    for (let l = 0; l < r; l++) {\n      const r = t[l];\n\n      if (r.upsampleInfo) {\n        const t = r.upsampleInfo.tile,\n              n = t.layerInfo[0][l].data,\n              u = n && n.samplerData;\n        e && e[s] === u || (o = !0), i[s++] = u, a = Math.max(a, t.lij[0]);\n      } else if (r.data) {\n        const t = this.tile.surface.layerViewByIndex(l, 0);\n\n        if (h(this.tile, t.layer, !1)) {\n          const t = r.data;\n          e && e[s] === t.samplerData || (o = !0), i[s++] = t.samplerData, a = this.tile.lij[0];\n        }\n      }\n    }\n\n    return e && e.length !== s && (o = !0), s > 0 ? i.length = s : i = null, {\n      changed: o,\n      samplerData: i,\n      maxTileLevel: a\n    };\n  }\n\n  get estimatedGeometryMemoryUsage() {\n    return this.geometryInfo.indices.byteLength + this.geometryInfo.vertexAttributes.byteLength;\n  }\n\n  get textureDescriptor() {\n    return r(this._texture) ? this._texture.descriptor : null;\n  }\n\n  get test() {\n    return {\n      hasTexture: null != this._texture\n    };\n  }\n\n}\n\nexport { g as PatchRenderData };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/terrain/PatchRenderData.js"],"names":["equals","e","clamp","t","isSome","r","isNone","i","empty","s","glLayout","a","PatchGeometry","o","releaseGeometry","l","ELEVATION_DESIRED_RESOLUTION_LEVEL","n","u","m","fallsWithinLayer","h","Default3D","c","f","p","g","constructor","geometryInfo","_textureRef","tile","surface","textureFadeDuration","overlay","init","clear","indices","vertexAttributes","boundingBox","numSurfaceIndices","numSkirtIndices","numWithoutSkirtIndices","numVertsPerRow","geometryState","samplerData","clippingArea","wireframe","opacity","localOrigin","releaseTexture","updateGeometry","_updateGeometryState","_releaseGeometry","_createGeometry","ensureTexture","_texture","descriptor","width","setMemoryDirty","release","_getElevationInfo","level","numSubdivisionsAtLevel","vlevel","Math","max","maxTileLevel","maxTesselation","intersectsClippingArea","isWithinClippingArea","changed","createGeometry","gl","_vao","geometry","layout","createVertex","STATIC_DRAW","buffer","createIndex","dispose","vao","setTextureReference","push","textureReference","current","nextTextureReference","next","textureFadeFactor","fadeFactor","textureIsFading","isFading","layerInfo","length","Array","upsampleInfo","data","lij","layerViewByIndex","layer","estimatedGeometryMemoryUsage","byteLength","textureDescriptor","test","hasTexture","PatchRenderData"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{equals as e}from\"../../../core/arrayUtils.js\";import{clamp as t}from\"../../../core/mathUtils.js\";import{isSome as r,isNone as i}from\"../../../core/maybe.js\";import{empty as s}from\"../../../geometry/support/aaBoundingBox.js\";import{glLayout as a}from\"../support/buffer/glUtil.js\";import{PatchGeometry as o,releaseGeometry as l}from\"./PatchGeometryFactory.js\";import{ELEVATION_DESIRED_RESOLUTION_LEVEL as n}from\"./TerrainConst.js\";import u from\"./TextureFader.js\";import m from\"./TileOverlayData.js\";import{fallsWithinLayer as h}from\"./tileUtils.js\";import{Default3D as c}from\"../webgl-engine/lib/DefaultVertexAttributeLocations.js\";import f from\"../../webgl/BufferObject.js\";import p from\"../../webgl/VertexArrayObject.js\";class g{constructor(){this.geometryInfo=new o,this._textureRef=new u((()=>this.tile.surface.textureFadeDuration)),this.overlay=new m}init(e){this.tile=e,this.clear();const t=this.geometryInfo;t.indices=null,t.vertexAttributes=null,s(t.boundingBox),t.numSurfaceIndices=0,t.numSkirtIndices=0,t.numWithoutSkirtIndices=0,t.numVertsPerRow=0,this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},this.opacity=1,this.localOrigin=null,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear()}updateGeometry(e,t){return!!this._updateGeometryState(t)&&(this._releaseGeometry(),this._createGeometry(e),!0)}releaseGeometry(){return!!this._releaseGeometry()&&(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0)}ensureTexture(e,t){return r(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),i(this._texture)&&(this._texture=t(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){r(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}_updateGeometryState(r){const i=this._getElevationInfo(),s=this.tile.level;let a=s<8?this.tile.numSubdivisionsAtLevel[s]+1:2;if(i.samplerData){const e=this.tile.vlevel-s,r=Math.max(s-i.maxTileLevel,n-e),o=this.tile.maxTesselation;a=t(1+(o>>r),2,o+1)}let o=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(o=null);const l=this.geometryState;let u=!1;return l.numVertsPerRow!==a&&(l.numVertsPerRow=a,u=!0),i.changed&&(l.samplerData=i.samplerData,u=!0),e(l.clippingArea,o)||(l.clippingArea=o,u=!0),l.wireframe!==r&&(l.wireframe=r,u=!0),u}_createGeometry(e){this.tile.createGeometry(this.geometryState,this.localOrigin);const t=this.geometryInfo.vertexAttributes,r=this.geometryInfo.indices,i=e.gl;this._vao=new p(e,c,{geometry:a(t.layout)},{geometry:f.createVertex(e,i.STATIC_DRAW,t.buffer)},f.createIndex(e,i.STATIC_DRAW,r))}_releaseGeometry(){return!!this._vao&&(this._vao.dispose(),this._vao=null,l(this.geometryInfo),!0)}get vao(){return this._vao}setTextureReference(e,t,r,i,s=0){e!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t,r,i,s)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[0],r=t.length;let i=new Array(r),s=0,a=0,o=!1;for(let l=0;l<r;l++){const r=t[l];if(r.upsampleInfo){const t=r.upsampleInfo.tile,n=t.layerInfo[0][l].data,u=n&&n.samplerData;e&&e[s]===u||(o=!0),i[s++]=u,a=Math.max(a,t.lij[0])}else if(r.data){const t=this.tile.surface.layerViewByIndex(l,0);if(h(this.tile,t.layer,!1)){const t=r.data;e&&e[s]===t.samplerData||(o=!0),i[s++]=t.samplerData,a=this.tile.lij[0]}}}return e&&e.length!==s&&(o=!0),s>0?i.length=s:i=null,{changed:o,samplerData:i,maxTileLevel:a}}get estimatedGeometryMemoryUsage(){return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength}get textureDescriptor(){return r(this._texture)?this._texture.descriptor:null}get test(){return{hasTexture:null!=this._texture}}}export{g as PatchRenderData};\n"]},"metadata":{},"sourceType":"module"}