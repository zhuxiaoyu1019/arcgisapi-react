{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isNone as e } from \"../../../../core/maybe.js\";\nimport { createResolver as t } from \"../../../../core/promiseUtils.js\";\nimport { d as r } from \"../../../../chunks/vec4f64.js\";\nimport { AutoDisposable as s } from \"../lib/AutoDisposable.js\";\nimport { encodeResult as i, createEmptyImageData as o, resampleHermite as n } from \"../../../support/screenshotUtils.js\";\nimport a from \"../../../webgl/FramebufferObject.js\";\n\nclass h extends s {\n  constructor(e, t, r, s = null, i, o = !0) {\n    super(), this._rctx = e, this._renderScene = t, this._requestRenderScene = r, this._renderOverlay = s, this.forceCameraHook = i, this.supersample = o, this._screenshotQueue = [];\n  }\n\n  dispose() {\n    this._rctx = null;\n  }\n\n  takeScreenshot(e) {\n    this._requestRenderScene();\n\n    const r = t();\n    return this._screenshotQueue.push({\n      settings: e,\n      resolver: r\n    }), r.promise;\n  }\n\n  update(e) {\n    if (0 !== this._screenshotQueue.length) {\n      for (const t of this._screenshotQueue) {\n        if (this.isDisposed) {\n          t.resolver.reject();\n          continue;\n        }\n\n        const r = { ...t.settings,\n          pixelRatio: t.settings.pixelRatio * e.viewCamera.pixelRatio\n        },\n              s = this._ensureScreenshotEncodeCanvas(),\n              o = this._renderScreenshot(e, r),\n              n = i(o, r, s, {\n          flipY: !0,\n          premultipliedAlpha: !0\n        });\n\n        t.resolver(n);\n      }\n\n      this._screenshotQueue = [];\n    }\n  }\n\n  _renderScreenshotOverlay(t, r, s) {\n    if (e(this._renderOverlay)) return r;\n    t.width = r.width, t.height = r.height;\n    const i = t.getContext(\"2d\"),\n          o = s.pixelRatio;\n    return i.save(), i.translate(0, r.height), i.scale(1, -1), s.region && i.translate(-s.region.x, -s.region.y), i.scale(o, o), r = this._renderOverlay(t, r), i.restore(), r;\n  }\n\n  _readbackScreenshot(e) {\n    return e.resample ? this._readbackScreenshotResampled(e) : this._readbackScreenshotImmediate(e);\n  }\n\n  _readbackScreenshotResampled(e) {\n    const {\n      framebufferWidth: t,\n      framebufferHeight: r,\n      region: s,\n      resample: i\n    } = e,\n          a = this._ensureScreenshotEncodeCanvas();\n\n    let h = o(t, r, a);\n    this._rctx.gl.readPixels(0, 0, t, r, 6408, 5121, new Uint8Array(h.data.buffer)), h = this._renderScreenshotOverlay(a, h, { ...e,\n      region: null\n    });\n    const c = o(s.width, s.height, a);\n    return n(h, c, !0, i.region.x, r - (i.region.y + i.region.height), i.region.width, i.region.height);\n  }\n\n  _readbackScreenshotImmediate(e) {\n    const {\n      framebufferHeight: t,\n      region: r\n    } = e,\n          s = this._ensureScreenshotEncodeCanvas(),\n          i = o(r.width, r.height, s);\n\n    return this._rctx.gl.readPixels(r.x, t - (r.y + r.height), r.width, r.height, 6408, 5121, new Uint8Array(i.data.buffer)), this._renderScreenshotOverlay(s, i, e);\n  }\n\n  _renderScreenshot(e, t) {\n    let s = null;\n    const i = e.viewCamera,\n          {\n      framebufferWidth: o,\n      framebufferHeight: n\n    } = t;\n    let h = !1;\n    const c = t.disableDecorations && e.frameHasDecorations,\n          l = o !== i.fullWidth || n !== i.fullHeight,\n          d = t.ignorePadding && i.pixelRatio !== t.pixelRatio,\n          f = l || c || d;\n\n    if (f) {\n      const e = i.clone();\n\n      if (t.ignorePadding) {\n        const s = r(e.padding);\n\n        for (let r = 0; r < 4; r++) s[r] = Math.round(s[r] / e.pixelRatio * t.pixelRatio);\n\n        e.padding = s;\n      }\n\n      e.fullWidth = o, e.fullHeight = n, e.pixelRatio = t.pixelRatio;\n      const c = i.fovX - e.fovX,\n            l = i.fovY - e.fovY;\n      c < 0 && c < l ? e.fovX = i.fovX : l < 0 && l < c && (e.fovY = i.fovY), this.forceCameraHook(e), h = !0, s = new a(this._rctx, {\n        width: e.fullWidth,\n        height: e.fullHeight,\n        colorTarget: 0,\n        depthStencilTarget: 3\n      }), this._renderScene(s, e, t.disableDecorations);\n    }\n\n    const u = this._readbackScreenshot(t);\n\n    if (f && !this._rctx.contextAttributes.alpha) for (let r = 3; r < u.data.length; r += 4) u.data[r] = 255;\n    return s && s.dispose(), this._rctx.bindFramebuffer(null), h && this.forceCameraHook(i), u;\n  }\n\n  _ensureScreenshotEncodeCanvas() {\n    return this._screenshotEncodeCanvas || (this._screenshotEncodeCanvas = document.createElement(\"canvas\")), this._screenshotEncodeCanvas;\n  }\n\n}\n\nexport { h as ScreenshotManager };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/webgl-engine/parts/ScreenshotManager.js"],"names":["isNone","e","createResolver","t","d","r","AutoDisposable","s","encodeResult","i","createEmptyImageData","o","resampleHermite","n","a","h","constructor","_rctx","_renderScene","_requestRenderScene","_renderOverlay","forceCameraHook","supersample","_screenshotQueue","dispose","takeScreenshot","push","settings","resolver","promise","update","length","isDisposed","reject","pixelRatio","viewCamera","_ensureScreenshotEncodeCanvas","_renderScreenshot","flipY","premultipliedAlpha","_renderScreenshotOverlay","width","height","getContext","save","translate","scale","region","x","y","restore","_readbackScreenshot","resample","_readbackScreenshotResampled","_readbackScreenshotImmediate","framebufferWidth","framebufferHeight","gl","readPixels","Uint8Array","data","buffer","c","disableDecorations","frameHasDecorations","l","fullWidth","fullHeight","ignorePadding","f","clone","padding","Math","round","fovX","fovY","colorTarget","depthStencilTarget","u","contextAttributes","alpha","bindFramebuffer","_screenshotEncodeCanvas","document","createElement","ScreenshotManager"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isNone as e}from\"../../../../core/maybe.js\";import{createResolver as t}from\"../../../../core/promiseUtils.js\";import{d as r}from\"../../../../chunks/vec4f64.js\";import{AutoDisposable as s}from\"../lib/AutoDisposable.js\";import{encodeResult as i,createEmptyImageData as o,resampleHermite as n}from\"../../../support/screenshotUtils.js\";import a from\"../../../webgl/FramebufferObject.js\";class h extends s{constructor(e,t,r,s=null,i,o=!0){super(),this._rctx=e,this._renderScene=t,this._requestRenderScene=r,this._renderOverlay=s,this.forceCameraHook=i,this.supersample=o,this._screenshotQueue=[]}dispose(){this._rctx=null}takeScreenshot(e){this._requestRenderScene();const r=t();return this._screenshotQueue.push({settings:e,resolver:r}),r.promise}update(e){if(0!==this._screenshotQueue.length){for(const t of this._screenshotQueue){if(this.isDisposed){t.resolver.reject();continue}const r={...t.settings,pixelRatio:t.settings.pixelRatio*e.viewCamera.pixelRatio},s=this._ensureScreenshotEncodeCanvas(),o=this._renderScreenshot(e,r),n=i(o,r,s,{flipY:!0,premultipliedAlpha:!0});t.resolver(n)}this._screenshotQueue=[]}}_renderScreenshotOverlay(t,r,s){if(e(this._renderOverlay))return r;t.width=r.width,t.height=r.height;const i=t.getContext(\"2d\"),o=s.pixelRatio;return i.save(),i.translate(0,r.height),i.scale(1,-1),s.region&&i.translate(-s.region.x,-s.region.y),i.scale(o,o),r=this._renderOverlay(t,r),i.restore(),r}_readbackScreenshot(e){return e.resample?this._readbackScreenshotResampled(e):this._readbackScreenshotImmediate(e)}_readbackScreenshotResampled(e){const{framebufferWidth:t,framebufferHeight:r,region:s,resample:i}=e,a=this._ensureScreenshotEncodeCanvas();let h=o(t,r,a);this._rctx.gl.readPixels(0,0,t,r,6408,5121,new Uint8Array(h.data.buffer)),h=this._renderScreenshotOverlay(a,h,{...e,region:null});const c=o(s.width,s.height,a);return n(h,c,!0,i.region.x,r-(i.region.y+i.region.height),i.region.width,i.region.height)}_readbackScreenshotImmediate(e){const{framebufferHeight:t,region:r}=e,s=this._ensureScreenshotEncodeCanvas(),i=o(r.width,r.height,s);return this._rctx.gl.readPixels(r.x,t-(r.y+r.height),r.width,r.height,6408,5121,new Uint8Array(i.data.buffer)),this._renderScreenshotOverlay(s,i,e)}_renderScreenshot(e,t){let s=null;const i=e.viewCamera,{framebufferWidth:o,framebufferHeight:n}=t;let h=!1;const c=t.disableDecorations&&e.frameHasDecorations,l=o!==i.fullWidth||n!==i.fullHeight,d=t.ignorePadding&&i.pixelRatio!==t.pixelRatio,f=l||c||d;if(f){const e=i.clone();if(t.ignorePadding){const s=r(e.padding);for(let r=0;r<4;r++)s[r]=Math.round(s[r]/e.pixelRatio*t.pixelRatio);e.padding=s}e.fullWidth=o,e.fullHeight=n,e.pixelRatio=t.pixelRatio;const c=i.fovX-e.fovX,l=i.fovY-e.fovY;c<0&&c<l?e.fovX=i.fovX:l<0&&l<c&&(e.fovY=i.fovY),this.forceCameraHook(e),h=!0,s=new a(this._rctx,{width:e.fullWidth,height:e.fullHeight,colorTarget:0,depthStencilTarget:3}),this._renderScene(s,e,t.disableDecorations)}const u=this._readbackScreenshot(t);if(f&&!this._rctx.contextAttributes.alpha)for(let r=3;r<u.data.length;r+=4)u.data[r]=255;return s&&s.dispose(),this._rctx.bindFramebuffer(null),h&&this.forceCameraHook(i),u}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement(\"canvas\")),this._screenshotEncodeCanvas}}export{h as ScreenshotManager};\n"]},"metadata":{},"sourceType":"module"}