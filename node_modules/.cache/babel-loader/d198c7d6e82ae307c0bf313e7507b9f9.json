{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../chunks/tslib.es6.js\";\nimport t from \"../../../core/Accessor.js\";\nimport i from \"../../../core/Handles.js\";\nimport { property as s } from \"../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../core/has.js\";\nimport \"../../../core/accessorSupport/ensureType.js\";\nimport \"../../../core/Logger.js\";\nimport { subclass as r } from \"../../../core/accessorSupport/decorators/subclass.js\";\nimport { canProjectToWGS84ComparableLonLat as o } from \"../../../geometry/projection.js\";\nimport { isMars as n, isMoon as l } from \"../../../geometry/support/spatialReferenceUtils.js\";\nimport { isTiledLayer as h } from \"../../../layers/support/layerUtils.js\";\nimport { getTiledLayerInfo as c, isVectorTileLayer as a, isProjectableRasterLayer as p } from \"./terrainUtils.js\";\nimport d from \"./TilingScheme.js\";\nlet m = class extends t {\n  constructor(e) {\n    super(e), this._handles = new i();\n  }\n\n  initialize() {\n    this._handles.add(this.layers.on(\"change\", () => this._update())), this._handles.add(this.extentHelper.watch(\"layerViewsExtent\", () => this._setAdHocTilingScheme())), this._update(), this.tilingSchemeLocked || this._setAdHocTilingScheme();\n  }\n\n  destroy() {\n    this._handles.destroy(), this._handles = null, this._waitTask = null;\n  }\n\n  _update() {\n    if (this._waitTask = null, this.tilingSchemeLocked) return;\n    let e;\n    if (this._set(\"tilingSchemeDone\", !1), this.layers.some(t => !(!h(t) || t.isRejected()) && !(t.isFulfilled() && !S(t, this.viewSpatialReference, this.viewingMode)) && (e = t, !a(t) && !p(t))), e) {\n      if (e.isResolved()) {\n        const t = e,\n              {\n          tileInfo: i\n        } = c(t, this.viewSpatialReference, this.viewingMode),\n              s = new d(i);\n        this._set(\"tilingSchemeDone\", !0), this._lockTilingScheme(s);\n      } else this._updateWhen(e);\n    } else this._set(\"tilingSchemeDone\", !0);\n  }\n\n  _updateWhen(e) {\n    const t = e.when().catch(e => e).then(() => {\n      t !== this._waitTask || this.destroyed || this._update();\n    });\n    this._waitTask = t;\n  }\n\n  _lockTilingScheme(e) {\n    if (1 === this.viewingMode) {\n      const t = e.levels.length - 1;\n      e.spatialReference.isWebMercator ? e = d.makeWebMercatorAuxiliarySphere(t) : o(e.spatialReference) && (e = d.makeGCSWithTileSize(e.spatialReference, e.pixelSize, t));\n    }\n\n    this.tilingSchemeLocked = !0, this.tilingScheme = e, this.extentHelper.tilingScheme = this.tilingScheme, this._updateTiledLayerExtent(), this._handles.removeAll(), this._handles.add(this.extentHelper.watch(\"tiledLayersExtent\", () => this._updateTiledLayerExtent()));\n  }\n\n  _updateTiledLayerExtent() {\n    this.extent = this.extentHelper.tiledLayersExtent;\n  }\n\n  _setAdHocTilingScheme() {\n    if (1 === this.viewingMode) {\n      const e = this.extentHelper.spatialReference,\n            t = o(e) || n(e) || l(e);\n      e.isWebMercator ? this.tilingScheme = d.WebMercatorAuxiliarySphere : t && (this.tilingScheme = d.makeGCSWithTileSize(e, 256)), this.extent = this.extentHelper.layerViewsExtent;\n    } else {\n      const e = this.extentHelper.layerViewsExtent;\n      e && (this.tilingScheme = d.fromExtent(e, this.extentHelper.spatialReference), this.extent = e);\n    }\n  }\n\n};\n\nfunction S(e, t, i) {\n  return !!c(e, t, i).tileInfo;\n}\n\ne([s()], m.prototype, \"tilingScheme\", void 0), e([s()], m.prototype, \"extent\", void 0), e([s({\n  value: !1\n})], m.prototype, \"tilingSchemeLocked\", void 0), e([s({\n  readOnly: !0,\n  value: !1\n})], m.prototype, \"tilingSchemeDone\", void 0), e([s({\n  constructOnly: !0\n})], m.prototype, \"viewSpatialReference\", void 0), e([s({\n  constructOnly: !0\n})], m.prototype, \"layers\", void 0), e([s({\n  constructOnly: !0\n})], m.prototype, \"extentHelper\", void 0), e([s({\n  constructOnly: !0\n})], m.prototype, \"viewingMode\", void 0), m = e([r(\"esri.views.3d.terrain.SurfaceTilingSchemeLogic\")], m);\nexport { m as SurfaceTilingSchemeLogic };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/terrain/SurfaceTilingSchemeLogic.js"],"names":["_","e","t","i","property","s","subclass","r","canProjectToWGS84ComparableLonLat","o","isMars","n","isMoon","l","isTiledLayer","h","getTiledLayerInfo","c","isVectorTileLayer","a","isProjectableRasterLayer","p","d","m","constructor","_handles","initialize","add","layers","on","_update","extentHelper","watch","_setAdHocTilingScheme","tilingSchemeLocked","destroy","_waitTask","_set","some","isRejected","isFulfilled","S","viewSpatialReference","viewingMode","isResolved","tileInfo","_lockTilingScheme","_updateWhen","when","catch","then","destroyed","levels","length","spatialReference","isWebMercator","makeWebMercatorAuxiliarySphere","makeGCSWithTileSize","pixelSize","tilingScheme","_updateTiledLayerExtent","removeAll","extent","tiledLayersExtent","WebMercatorAuxiliarySphere","layerViewsExtent","fromExtent","prototype","value","readOnly","constructOnly","SurfaceTilingSchemeLogic"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import t from\"../../../core/Accessor.js\";import i from\"../../../core/Handles.js\";import{property as s}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import\"../../../core/Logger.js\";import{subclass as r}from\"../../../core/accessorSupport/decorators/subclass.js\";import{canProjectToWGS84ComparableLonLat as o}from\"../../../geometry/projection.js\";import{isMars as n,isMoon as l}from\"../../../geometry/support/spatialReferenceUtils.js\";import{isTiledLayer as h}from\"../../../layers/support/layerUtils.js\";import{getTiledLayerInfo as c,isVectorTileLayer as a,isProjectableRasterLayer as p}from\"./terrainUtils.js\";import d from\"./TilingScheme.js\";let m=class extends t{constructor(e){super(e),this._handles=new i}initialize(){this._handles.add(this.layers.on(\"change\",(()=>this._update()))),this._handles.add(this.extentHelper.watch(\"layerViewsExtent\",(()=>this._setAdHocTilingScheme()))),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._handles.destroy(),this._handles=null,this._waitTask=null}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this._set(\"tilingSchemeDone\",!1),this.layers.some((t=>!(!h(t)||t.isRejected())&&(!(t.isFulfilled()&&!S(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!a(t)&&!p(t))))),e)if(e.isResolved()){const t=e,{tileInfo:i}=c(t,this.viewSpatialReference,this.viewingMode),s=new d(i);this._set(\"tilingSchemeDone\",!0),this._lockTilingScheme(s)}else this._updateWhen(e);else this._set(\"tilingSchemeDone\",!0)}_updateWhen(e){const t=e.when().catch((e=>e)).then((()=>{t!==this._waitTask||this.destroyed||this._update()}));this._waitTask=t}_lockTilingScheme(e){if(1===this.viewingMode){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=d.makeWebMercatorAuxiliarySphere(t):o(e.spatialReference)&&(e=d.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(this.extentHelper.watch(\"tiledLayersExtent\",(()=>this._updateTiledLayerExtent())))}_updateTiledLayerExtent(){this.extent=this.extentHelper.tiledLayersExtent}_setAdHocTilingScheme(){if(1===this.viewingMode){const e=this.extentHelper.spatialReference,t=o(e)||n(e)||l(e);e.isWebMercator?this.tilingScheme=d.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=d.makeGCSWithTileSize(e,256)),this.extent=this.extentHelper.layerViewsExtent}else{const e=this.extentHelper.layerViewsExtent;e&&(this.tilingScheme=d.fromExtent(e,this.extentHelper.spatialReference),this.extent=e)}}};function S(e,t,i){return!!c(e,t,i).tileInfo}e([s()],m.prototype,\"tilingScheme\",void 0),e([s()],m.prototype,\"extent\",void 0),e([s({value:!1})],m.prototype,\"tilingSchemeLocked\",void 0),e([s({readOnly:!0,value:!1})],m.prototype,\"tilingSchemeDone\",void 0),e([s({constructOnly:!0})],m.prototype,\"viewSpatialReference\",void 0),e([s({constructOnly:!0})],m.prototype,\"layers\",void 0),e([s({constructOnly:!0})],m.prototype,\"extentHelper\",void 0),e([s({constructOnly:!0})],m.prototype,\"viewingMode\",void 0),m=e([r(\"esri.views.3d.terrain.SurfaceTilingSchemeLogic\")],m);export{m as SurfaceTilingSchemeLogic};\n"]},"metadata":{},"sourceType":"module"}