{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../chunks/tslib.es6.js\";\nimport \"../../../../geometry.js\";\nimport t from \"../../../../request.js\";\nimport r from \"../../../../core/Error.js\";\nimport o from \"../../../../core/Logger.js\";\nimport { isNone as s, isSome as i, unwrapOr as n, get as a } from \"../../../../core/maybe.js\";\nimport { createResolver as c } from \"../../../../core/promiseUtils.js\";\nimport \"../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../core/has.js\";\nimport \"../../../../core/accessorSupport/ensureType.js\";\nimport { subclass as u } from \"../../../../core/accessorSupport/decorators/subclass.js\";\nimport { WebSocketConnection as f } from \"./WebSocketConnection.js\";\nimport { executeQuery as d } from \"../../../../rest/query/operations/query.js\";\nimport h from \"../../../../rest/support/Query.js\";\nimport { fromJSON as l } from \"../../../../geometry/support/jsonUtils.js\";\nimport y from \"../../../../geometry/SpatialReference.js\";\nconst p = o.getLogger(\"esri.layers.graphics.sources.connections.GeoEventConnection\"),\n      m = 1e4,\n      g = {\n  maxQueryDepth: 5,\n  maxRecordCountFactor: 3\n};\n\nlet _ = class extends f {\n  constructor(e) {\n    super({ ...g,\n      ...e\n    });\n  }\n\n  async _open() {\n    const e = await this._fetchServiceDefinition(this._config.source);\n    e.timeInfo.trackIdField || p.warn(\"GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.\");\n    const t = await this._fetchWebSocketUrl(e.streamUrls, this._config.spatialReference);\n    this._buddyServicesQuery || (this._buddyServicesQuery = this._queryBuddyServices()), await this._buddyServicesQuery, await this._tryCreateWebSocket(t);\n    const {\n      filter: r,\n      outFields: o\n    } = this._config;\n    this.destroyed || this._setFilter(r, o);\n  }\n\n  _onMessage(e) {\n    let t;\n\n    try {\n      t = this._enrich(JSON.parse(e.data)), this._featureZScaler && this._featureZScaler(t.geometry);\n    } catch (o) {\n      return void p.error(new r(\"geoevent-connection\", \"Failed to parse message\", o));\n    }\n\n    this.onFeature(t);\n  }\n\n  async _fetchServiceDefinition(e) {\n    const r = {\n      f: \"json\"\n    },\n          o = t(e.path, {\n      query: r,\n      responseType: \"json\"\n    }),\n          s = (await o).data;\n    return this._serviceDefinition = s, s;\n  }\n\n  async _fetchWebSocketUrl(e, t) {\n    const r = e[0],\n          {\n      urls: o,\n      token: s\n    } = r;\n    return `${this._inferWebSocketBaseUrl(o)}/subscribe?outSR=${t.wkid}${s ? \"&token=\" + s : \"\"}`;\n  }\n\n  _inferWebSocketBaseUrl(e) {\n    if (1 === e.length) return e[0];\n\n    for (const t of e) if (-1 !== t.indexOf(\"wss\")) return t;\n\n    return p.error(new r(\"geoevent-connection\", \"Unable to infer WebSocket url\", e)), null;\n  }\n\n  async _setFilter(e, t) {\n    const o = this._websocket;\n    if (s(o) || s(e) && s(t)) return;\n    const i = JSON.stringify({\n      filter: this._serializeFilter(e, t)\n    });\n    let n = !1;\n\n    const a = c(),\n          u = () => {\n      n || (this.destroyed || this._websocket !== o || p.error(new r(\"geoevent-connection\", \"Server timed out when setting filter\")), a.reject());\n    },\n          f = e => {\n      const t = JSON.parse(e.data);\n      t.filter && (t.error && (p.error(new r(\"geoevent-connection\", \"Failed to set service filter\", t.error)), this._set(\"errorString\", `Could not set service filter - ${t.error}`), a.reject(t.error)), o.onmessage = this._onMessage.bind(this), n = !0, a.resolve());\n    };\n\n    return o.onmessage = f, o.send(i), setTimeout(u, m), a.promise;\n  }\n\n  _serializeFilter(e, t) {\n    const o = {};\n    if (s(e) && s(t)) return o;\n    if (i(e) && e.geometry) try {\n      const t = l(e.geometry);\n      if (\"extent\" !== t.type) throw new r(`Expected extent but found type ${t.type}`);\n      o.geometry = JSON.stringify(t.shiftCentralMeridian());\n    } catch (n) {\n      p.error(new r(\"geoevent-connection\", \"Encountered an error when setting connection geometryDefinition\", n));\n    }\n    return i(e) && e.where && \"1 = 1\" !== e.where && (o.where = e.where), i(t) && (o.outFields = t.join(\",\")), o;\n  }\n\n  _enrich(e) {\n    if (!this._relatedFeatures) return e;\n    const t = this._serviceDefinition.relatedFeatures.joinField,\n          o = e.attributes[t];\n    if (!this._relatedFeatures.has(o)) return p.warn(\"geoevent-connection\", \"Feature join failed. Is the join field configured correctly?\", e), e;\n\n    const {\n      attributes: s,\n      geometry: i\n    } = this._relatedFeatures.get(o);\n\n    for (const r in s) e.attributes[r] = s[r];\n\n    return i && (e.geometry = i), e.geometry || e.centroid || p.error(new r(\"geoevent-connection\", \"Found malformed feature - no geometry found\", e)), e;\n  }\n\n  async _queryBuddyServices() {\n    try {\n      const {\n        relatedFeatures: e,\n        keepLatestArchive: t\n      } = this._serviceDefinition,\n            r = this._queryRelatedFeatures(e),\n            o = this._queryArchive(t);\n\n      await r;\n      const s = await o;\n      if (!s) return;\n\n      for (const i of s.features) this.onFeature(this._enrich(i));\n    } catch (e) {\n      p.error(new r(\"geoevent-connection\", \"Encountered an error when querying buddy services\", {\n        error: e\n      }));\n    }\n  }\n\n  async _queryRelatedFeatures(e) {\n    if (!e) return;\n    const t = await this._queryBuddy(e.featuresUrl);\n\n    this._addRelatedFeatures(t);\n  }\n\n  async _queryArchive(e) {\n    if (e) return this._queryBuddy(e.featuresUrl);\n  }\n\n  async _queryBuddy(e) {\n    const t = new (await import(\"../../../FeatureLayer.js\")).default({\n      url: e\n    }),\n          {\n      capabilities: r\n    } = await t.load(),\n          o = r.query.supportsMaxRecordCountFactor,\n          s = r.query.supportsPagination,\n          i = r.query.supportsCentroid,\n          c = this._config.maxRecordCountFactor,\n          u = t.capabilities.query.maxRecordCount,\n          f = o ? u * c : u,\n          l = new h();\n    if (l.outFields = n(this._config.outFields, [\"*\"]), l.where = n(a(this._config.filter, \"where\"), \"1=1\"), l.returnGeometry = !0, l.returnExceededLimitFeatures = !0, l.outSpatialReference = y.fromJSON(this._config.spatialReference), i && (l.returnCentroid = !0), o && (l.maxRecordCountFactor = c), s) return l.num = f, t.destroy(), this._queryPages(e, l);\n    const p = await d(e, l, this._config.sourceSpatialReference);\n    return t.destroy(), p.data;\n  }\n\n  async _queryPages(e, t, r = [], o = 0) {\n    t.start = i(t.num) ? o * t.num : null;\n    const {\n      data: s\n    } = await d(e, t, this._config.sourceSpatialReference);\n    return s.exceededTransferLimit && o < this._config.maxQueryDepth ? (s.features.forEach(e => r.push(e)), this._queryPages(e, t, r, o + 1)) : (r.forEach(e => s.features.push(e)), s);\n  }\n\n  _addRelatedFeatures(e) {\n    const t = new Map(),\n          r = e.features,\n          o = this._serviceDefinition.relatedFeatures.joinField;\n\n    for (const s of r) {\n      const e = s.attributes[o];\n      t.set(e, s);\n    }\n\n    this._relatedFeatures = t;\n  }\n\n};\n\n_ = e([u(\"esri.layers.graphics.sources.connections.GeoEventConnection\")], _);\nvar w = _;\nexport default w;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/layers/graphics/sources/connections/GeoEventConnection.js"],"names":["_","e","t","r","o","isNone","s","isSome","i","unwrapOr","n","get","a","createResolver","c","subclass","u","WebSocketConnection","f","executeQuery","d","h","fromJSON","l","y","p","getLogger","m","g","maxQueryDepth","maxRecordCountFactor","constructor","_open","_fetchServiceDefinition","_config","source","timeInfo","trackIdField","warn","_fetchWebSocketUrl","streamUrls","spatialReference","_buddyServicesQuery","_queryBuddyServices","_tryCreateWebSocket","filter","outFields","destroyed","_setFilter","_onMessage","_enrich","JSON","parse","data","_featureZScaler","geometry","error","onFeature","path","query","responseType","_serviceDefinition","urls","token","_inferWebSocketBaseUrl","wkid","length","indexOf","_websocket","stringify","_serializeFilter","reject","_set","onmessage","bind","resolve","send","setTimeout","promise","type","shiftCentralMeridian","where","join","_relatedFeatures","relatedFeatures","joinField","attributes","has","centroid","keepLatestArchive","_queryRelatedFeatures","_queryArchive","features","_queryBuddy","featuresUrl","_addRelatedFeatures","default","url","capabilities","load","supportsMaxRecordCountFactor","supportsPagination","supportsCentroid","maxRecordCount","returnGeometry","returnExceededLimitFeatures","outSpatialReference","returnCentroid","num","destroy","_queryPages","sourceSpatialReference","start","exceededTransferLimit","forEach","push","Map","set","w"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../chunks/tslib.es6.js\";import\"../../../../geometry.js\";import t from\"../../../../request.js\";import r from\"../../../../core/Error.js\";import o from\"../../../../core/Logger.js\";import{isNone as s,isSome as i,unwrapOr as n,get as a}from\"../../../../core/maybe.js\";import{createResolver as c}from\"../../../../core/promiseUtils.js\";import\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/ensureType.js\";import{subclass as u}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{WebSocketConnection as f}from\"./WebSocketConnection.js\";import{executeQuery as d}from\"../../../../rest/query/operations/query.js\";import h from\"../../../../rest/support/Query.js\";import{fromJSON as l}from\"../../../../geometry/support/jsonUtils.js\";import y from\"../../../../geometry/SpatialReference.js\";const p=o.getLogger(\"esri.layers.graphics.sources.connections.GeoEventConnection\"),m=1e4,g={maxQueryDepth:5,maxRecordCountFactor:3};let _=class extends f{constructor(e){super({...g,...e})}async _open(){const e=await this._fetchServiceDefinition(this._config.source);e.timeInfo.trackIdField||p.warn(\"GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.\");const t=await this._fetchWebSocketUrl(e.streamUrls,this._config.spatialReference);this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),await this._buddyServicesQuery,await this._tryCreateWebSocket(t);const{filter:r,outFields:o}=this._config;this.destroyed||this._setFilter(r,o)}_onMessage(e){let t;try{t=this._enrich(JSON.parse(e.data)),this._featureZScaler&&this._featureZScaler(t.geometry)}catch(o){return void p.error(new r(\"geoevent-connection\",\"Failed to parse message\",o))}this.onFeature(t)}async _fetchServiceDefinition(e){const r={f:\"json\"},o=t(e.path,{query:r,responseType:\"json\"}),s=(await o).data;return this._serviceDefinition=s,s}async _fetchWebSocketUrl(e,t){const r=e[0],{urls:o,token:s}=r;return`${this._inferWebSocketBaseUrl(o)}/subscribe?outSR=${t.wkid}${s?\"&token=\"+s:\"\"}`}_inferWebSocketBaseUrl(e){if(1===e.length)return e[0];for(const t of e)if(-1!==t.indexOf(\"wss\"))return t;return p.error(new r(\"geoevent-connection\",\"Unable to infer WebSocket url\",e)),null}async _setFilter(e,t){const o=this._websocket;if(s(o)||s(e)&&s(t))return;const i=JSON.stringify({filter:this._serializeFilter(e,t)});let n=!1;const a=c(),u=()=>{n||(this.destroyed||this._websocket!==o||p.error(new r(\"geoevent-connection\",\"Server timed out when setting filter\")),a.reject())},f=e=>{const t=JSON.parse(e.data);t.filter&&(t.error&&(p.error(new r(\"geoevent-connection\",\"Failed to set service filter\",t.error)),this._set(\"errorString\",`Could not set service filter - ${t.error}`),a.reject(t.error)),o.onmessage=this._onMessage.bind(this),n=!0,a.resolve())};return o.onmessage=f,o.send(i),setTimeout(u,m),a.promise}_serializeFilter(e,t){const o={};if(s(e)&&s(t))return o;if(i(e)&&e.geometry)try{const t=l(e.geometry);if(\"extent\"!==t.type)throw new r(`Expected extent but found type ${t.type}`);o.geometry=JSON.stringify(t.shiftCentralMeridian())}catch(n){p.error(new r(\"geoevent-connection\",\"Encountered an error when setting connection geometryDefinition\",n))}return i(e)&&e.where&&\"1 = 1\"!==e.where&&(o.where=e.where),i(t)&&(o.outFields=t.join(\",\")),o}_enrich(e){if(!this._relatedFeatures)return e;const t=this._serviceDefinition.relatedFeatures.joinField,o=e.attributes[t];if(!this._relatedFeatures.has(o))return p.warn(\"geoevent-connection\",\"Feature join failed. Is the join field configured correctly?\",e),e;const{attributes:s,geometry:i}=this._relatedFeatures.get(o);for(const r in s)e.attributes[r]=s[r];return i&&(e.geometry=i),e.geometry||e.centroid||p.error(new r(\"geoevent-connection\",\"Found malformed feature - no geometry found\",e)),e}async _queryBuddyServices(){try{const{relatedFeatures:e,keepLatestArchive:t}=this._serviceDefinition,r=this._queryRelatedFeatures(e),o=this._queryArchive(t);await r;const s=await o;if(!s)return;for(const i of s.features)this.onFeature(this._enrich(i))}catch(e){p.error(new r(\"geoevent-connection\",\"Encountered an error when querying buddy services\",{error:e}))}}async _queryRelatedFeatures(e){if(!e)return;const t=await this._queryBuddy(e.featuresUrl);this._addRelatedFeatures(t)}async _queryArchive(e){if(e)return this._queryBuddy(e.featuresUrl)}async _queryBuddy(e){const t=new((await import(\"../../../FeatureLayer.js\")).default)({url:e}),{capabilities:r}=await t.load(),o=r.query.supportsMaxRecordCountFactor,s=r.query.supportsPagination,i=r.query.supportsCentroid,c=this._config.maxRecordCountFactor,u=t.capabilities.query.maxRecordCount,f=o?u*c:u,l=new h;if(l.outFields=n(this._config.outFields,[\"*\"]),l.where=n(a(this._config.filter,\"where\"),\"1=1\"),l.returnGeometry=!0,l.returnExceededLimitFeatures=!0,l.outSpatialReference=y.fromJSON(this._config.spatialReference),i&&(l.returnCentroid=!0),o&&(l.maxRecordCountFactor=c),s)return l.num=f,t.destroy(),this._queryPages(e,l);const p=await d(e,l,this._config.sourceSpatialReference);return t.destroy(),p.data}async _queryPages(e,t,r=[],o=0){t.start=i(t.num)?o*t.num:null;const{data:s}=await d(e,t,this._config.sourceSpatialReference);return s.exceededTransferLimit&&o<this._config.maxQueryDepth?(s.features.forEach((e=>r.push(e))),this._queryPages(e,t,r,o+1)):(r.forEach((e=>s.features.push(e))),s)}_addRelatedFeatures(e){const t=new Map,r=e.features,o=this._serviceDefinition.relatedFeatures.joinField;for(const s of r){const e=s.attributes[o];t.set(e,s)}this._relatedFeatures=t}};_=e([u(\"esri.layers.graphics.sources.connections.GeoEventConnection\")],_);var w=_;export default w;\n"]},"metadata":{},"sourceType":"module"}