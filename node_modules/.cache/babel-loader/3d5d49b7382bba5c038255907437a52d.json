{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { RenderTargetHelper as e } from \"./RenderTargetHelper.js\";\n\nclass t {\n  constructor(t, r) {\n    this._rctx = t, this._compositingHelper = r, this._currentRenderTarget = 0, this.dimensions = {\n      width: 4,\n      height: 4\n    }, this._needLastFrameColorTexture = !1, this._background = {\n      type: \"color\",\n      color: [0, 0, 0, 1]\n    };\n    const i = this._rctx,\n          o = \"webgl2\" === i.webglVersion;\n    this.renderTargetHelper = new e(i);\n    const s = this.renderTargetHelper;\n    this.mainColorTarget0 = s.registerColorTarget({\n      name: \"mainColorTarget0\"\n    }), this.mainColorTarget1 = s.registerColorTarget({\n      name: \"mainColorTarget1\"\n    }), this.frontFaceTarget = s.registerColorTarget({\n      name: \"frontFaceTarget\"\n    });\n\n    const a = e => s.registerColorTarget({\n      name: e,\n      dataType: 5126,\n      internalFormat: o ? 34836 : 6408,\n      samplingMode: 9728\n    });\n\n    this.colorFloatTarget = a(\"colorFloatTarget\"), this.alphaFloatTarget = a(\"alphaFloatTarget\"), this.mainDepth = s.registerDepthTarget({\n      name: \"mainDepth\"\n    }), this.linearDepth = s.registerColorTarget({\n      name: \"linearDepth\",\n      samplingMode: 9728\n    }), this.terrainLinearDepth = s.registerColorTarget({\n      name: \"terrainLinearDepth\"\n    }), this.geometryLinearDepth = s.registerColorTarget({\n      name: \"geometryLinearDepth\"\n    }), this.normal = s.registerColorTarget({\n      name: \"normal\"\n    }), this.highlight = s.registerColorTarget({\n      name: \"highlight\",\n      internalFormat: o ? 32854 : 6408,\n      dataType: 32819\n    }), this.hudVisibility = s.registerColorTarget({\n      name: \"hudVisibility\",\n      internalFormat: o ? 32854 : 6408,\n      dataType: 32819\n    }), this.tmpColor = s.registerColorTarget({\n      name: \"tmpColor\"\n    }), this.tmpDepth = s.registerDepthTarget({\n      name: \"tmpDepth\"\n    }), this.hudColor = s.registerColorTarget({\n      name: \"hudColor\"\n    });\n  }\n\n  dispose() {\n    this.renderTargetHelper.dispose();\n  }\n\n  get width() {\n    return this.dimensions.width;\n  }\n\n  get height() {\n    return this.dimensions.height;\n  }\n\n  set background(e) {\n    this._background = e;\n  }\n\n  get background() {\n    return this._background;\n  }\n\n  get currentColorTarget() {\n    return 0 === this._currentRenderTarget ? this.mainColorTarget0 : this.mainColorTarget1;\n  }\n\n  get previousColorTarget() {\n    return 0 === this._currentRenderTarget ? this.mainColorTarget1 : this.mainColorTarget0;\n  }\n\n  get currentRenderTarget() {\n    return this._currentRenderTarget;\n  }\n\n  get framebuffer() {\n    return this.getFramebuffer(this.currentColorTarget, this.mainDepth);\n  }\n\n  getFramebuffer(e, t) {\n    return this.renderTargetHelper.getFramebuffer(this.dimensions, e, t);\n  }\n\n  get colorTexture() {\n    return this.renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget);\n  }\n\n  get depthTexture() {\n    return this.renderTargetHelper.getAllocatedDepthTexture(this.mainDepth);\n  }\n\n  get linearDepthTexture() {\n    return this.renderTargetHelper.getAllocatedColorTexture(this.linearDepth);\n  }\n\n  get terrainLinearDepthTexture() {\n    return this.renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth);\n  }\n\n  get geometryLinearDepthTexture() {\n    return this.renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth);\n  }\n\n  get lastFrameColorTexture() {\n    return this.renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget);\n  }\n\n  get normalTexture() {\n    return this.renderTargetHelper.getAllocatedColorTexture(this.normal);\n  }\n\n  get highlightTexture() {\n    return this.renderTargetHelper.getAllocatedColorTexture(this.highlight);\n  }\n\n  get hudVisibilityTexture() {\n    return this.getColorTexture(this.hudVisibility);\n  }\n\n  get tmpColorTexture() {\n    return this.getColorTexture(this.tmpColor);\n  }\n\n  get hudColorTexture() {\n    return this.getColorTexture(this.hudColor);\n  }\n\n  get mainColorTexture() {\n    return this.getColorTexture(this.currentColorTarget);\n  }\n\n  advanceCurrentRenderTarget() {\n    this._currentRenderTarget = 0 === this._currentRenderTarget && this._needLastFrameColorTexture ? 1 : 0;\n  }\n\n  initializeFrame(e) {\n    const t = this._rctx;\n    this.dimensions.width = e.fullWidth, this.dimensions.height = e.fullHeight, this.bindTarget(this.currentColorTarget, this.mainDepth), t.setClearStencil(0);\n    const r = this._background.color;\n    t.setClearColor(r[0] * r[3], r[1] * r[3], r[2] * r[3], r[3]), t.clearSafe(17664);\n  }\n\n  composite() {\n    this._compositingHelper.composite(this.colorTexture, 0);\n  }\n\n  renderTmpAndCompositeToMain(e, t, i = !1) {\n    this.renderToTargets(e, this.tmpColor, i ? this.tmpDepth : this.mainDepth, r), this._compositingHelper.composite(this.getColorTexture(this.tmpColor), t);\n  }\n\n  renderHUDVisibility(e, t = !1) {\n    this.renderToTargets(e, this.hudVisibility, t ? this.tmpDepth : this.mainDepth, i);\n  }\n\n  compositeTransparentTerrainOntoHUDVisibility() {\n    this.renderToTargets(() => {\n      this._compositingHelper.compositeSpecial(this.getColorTexture(this.tmpColor), 1);\n    }, this.hudVisibility, this.tmpDepth);\n  }\n\n  renderOITPass(e, t, r) {\n    let i, o;\n\n    switch (t) {\n      case 0:\n        i = this.colorFloatTarget, o = [0, 0, 0, 0];\n        break;\n\n      case 1:\n        i = this.alphaFloatTarget, o = [1, 1, 1, 1];\n        break;\n\n      case 2:\n        i = this.frontFaceTarget, o = [0, 0, 0, 0];\n    }\n\n    r ? this.renderToTargets(e, i, this.tmpDepth, o, !0, !0) : this.renderToTargets(e, i, this.mainDepth, o, !1);\n  }\n\n  compositeTransparentTerrainOntoMain() {\n    this.bindFramebuffer(), this._compositingHelper.composite(this.getColorTexture(this.tmpColor), 2);\n  }\n\n  compositeOccludedOntoMain(e) {\n    this.bindFramebuffer(), this._compositingHelper.composite(this.getColorTexture(this.tmpColor), 2, e);\n  }\n\n  compositeTransparentOntoOpaque(e) {\n    e ? (this.bindTarget(this.hudColor, this.tmpDepth), this._rctx.setClearColor(0, 0, 0, 1e-13), this._rctx.clearSafe(16384)) : this.bindFramebuffer(), this._compositingHelper.compositeTransparent(this.getColorTexture(this.colorFloatTarget), this.getColorTexture(this.alphaFloatTarget), this.getColorTexture(this.frontFaceTarget));\n  }\n\n  bindFramebuffer() {\n    this._rctx.bindFramebuffer(this.framebuffer);\n  }\n\n  renderDepthDetached(e) {\n    this.bindTarget(this.currentColorTarget), e(), this.bindTarget(this.currentColorTarget, this.mainDepth);\n  }\n\n  disposeTarget(e) {\n    this.renderTargetHelper.disposeTargetResource(e);\n  }\n\n  set needLastFrameColorTexture(e) {\n    !e && this._needLastFrameColorTexture && (this._currentRenderTarget = 0, this.disposeTarget(this.mainColorTarget1)), this._needLastFrameColorTexture = e;\n  }\n\n  get needLastFrameColorTexture() {\n    return this._needLastFrameColorTexture;\n  }\n\n  renderToTargets(e, t, r, i, o = !1, s = !1) {\n    const a = this._rctx,\n          h = this.bindTarget(t, r);\n    let n = 0;\n\n    if (i) {\n      const e = 1e-13,\n            t = Math.max(e, i[3]);\n      a.setClearColor(i[0], i[1], i[2], t), n |= 16384;\n    }\n\n    return o && (n |= 256), !1 === s ? s = 0 : (!0 === s && (s = 255), n |= 1024), n && a.clearSafe(n, s), e(), a.gl.flush(), this.bindTarget(this.currentColorTarget, this.mainDepth), h;\n  }\n\n  bindTarget(e, t) {\n    const r = this.renderTargetHelper.getFramebuffer(this.dimensions, e, t);\n    return this._rctx.bindFramebuffer(r), r;\n  }\n\n  getColorTexture(e) {\n    return this.renderTargetHelper.getColorTexture(e, this.dimensions);\n  }\n\n  getGpuMemoryUsage() {\n    let e = 0;\n    return this.renderTargetHelper && (e += this.renderTargetHelper.getGpuMemoryUsage()), e;\n  }\n\n}\n\nconst r = [0, 0, 0, 0],\n      i = [0, 1, 0, 1];\nexport { t as OffscreenRendering };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/webgl-engine/lib/OffscreenRendering.js"],"names":["RenderTargetHelper","e","t","constructor","r","_rctx","_compositingHelper","_currentRenderTarget","dimensions","width","height","_needLastFrameColorTexture","_background","type","color","i","o","webglVersion","renderTargetHelper","s","mainColorTarget0","registerColorTarget","name","mainColorTarget1","frontFaceTarget","a","dataType","internalFormat","samplingMode","colorFloatTarget","alphaFloatTarget","mainDepth","registerDepthTarget","linearDepth","terrainLinearDepth","geometryLinearDepth","normal","highlight","hudVisibility","tmpColor","tmpDepth","hudColor","dispose","background","currentColorTarget","previousColorTarget","currentRenderTarget","framebuffer","getFramebuffer","colorTexture","getAllocatedColorTexture","depthTexture","getAllocatedDepthTexture","linearDepthTexture","terrainLinearDepthTexture","geometryLinearDepthTexture","lastFrameColorTexture","normalTexture","highlightTexture","hudVisibilityTexture","getColorTexture","tmpColorTexture","hudColorTexture","mainColorTexture","advanceCurrentRenderTarget","initializeFrame","fullWidth","fullHeight","bindTarget","setClearStencil","setClearColor","clearSafe","composite","renderTmpAndCompositeToMain","renderToTargets","renderHUDVisibility","compositeTransparentTerrainOntoHUDVisibility","compositeSpecial","renderOITPass","compositeTransparentTerrainOntoMain","bindFramebuffer","compositeOccludedOntoMain","compositeTransparentOntoOpaque","compositeTransparent","renderDepthDetached","disposeTarget","disposeTargetResource","needLastFrameColorTexture","h","n","Math","max","gl","flush","getGpuMemoryUsage","OffscreenRendering"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{RenderTargetHelper as e}from\"./RenderTargetHelper.js\";class t{constructor(t,r){this._rctx=t,this._compositingHelper=r,this._currentRenderTarget=0,this.dimensions={width:4,height:4},this._needLastFrameColorTexture=!1,this._background={type:\"color\",color:[0,0,0,1]};const i=this._rctx,o=\"webgl2\"===i.webglVersion;this.renderTargetHelper=new e(i);const s=this.renderTargetHelper;this.mainColorTarget0=s.registerColorTarget({name:\"mainColorTarget0\"}),this.mainColorTarget1=s.registerColorTarget({name:\"mainColorTarget1\"}),this.frontFaceTarget=s.registerColorTarget({name:\"frontFaceTarget\"});const a=e=>s.registerColorTarget({name:e,dataType:5126,internalFormat:o?34836:6408,samplingMode:9728});this.colorFloatTarget=a(\"colorFloatTarget\"),this.alphaFloatTarget=a(\"alphaFloatTarget\"),this.mainDepth=s.registerDepthTarget({name:\"mainDepth\"}),this.linearDepth=s.registerColorTarget({name:\"linearDepth\",samplingMode:9728}),this.terrainLinearDepth=s.registerColorTarget({name:\"terrainLinearDepth\"}),this.geometryLinearDepth=s.registerColorTarget({name:\"geometryLinearDepth\"}),this.normal=s.registerColorTarget({name:\"normal\"}),this.highlight=s.registerColorTarget({name:\"highlight\",internalFormat:o?32854:6408,dataType:32819}),this.hudVisibility=s.registerColorTarget({name:\"hudVisibility\",internalFormat:o?32854:6408,dataType:32819}),this.tmpColor=s.registerColorTarget({name:\"tmpColor\"}),this.tmpDepth=s.registerDepthTarget({name:\"tmpDepth\"}),this.hudColor=s.registerColorTarget({name:\"hudColor\"})}dispose(){this.renderTargetHelper.dispose()}get width(){return this.dimensions.width}get height(){return this.dimensions.height}set background(e){this._background=e}get background(){return this._background}get currentColorTarget(){return 0===this._currentRenderTarget?this.mainColorTarget0:this.mainColorTarget1}get previousColorTarget(){return 0===this._currentRenderTarget?this.mainColorTarget1:this.mainColorTarget0}get currentRenderTarget(){return this._currentRenderTarget}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(e,t){return this.renderTargetHelper.getFramebuffer(this.dimensions,e,t)}get colorTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this.renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this.getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this.getColorTexture(this.tmpColor)}get hudColorTexture(){return this.getColorTexture(this.hudColor)}get mainColorTexture(){return this.getColorTexture(this.currentColorTarget)}advanceCurrentRenderTarget(){this._currentRenderTarget=0===this._currentRenderTarget&&this._needLastFrameColorTexture?1:0}initializeFrame(e){const t=this._rctx;this.dimensions.width=e.fullWidth,this.dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),t.setClearStencil(0);const r=this._background.color;t.setClearColor(r[0]*r[3],r[1]*r[3],r[2]*r[3],r[3]),t.clearSafe(17664)}composite(){this._compositingHelper.composite(this.colorTexture,0)}renderTmpAndCompositeToMain(e,t,i=!1){this.renderToTargets(e,this.tmpColor,i?this.tmpDepth:this.mainDepth,r),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),t)}renderHUDVisibility(e,t=!1){this.renderToTargets(e,this.hudVisibility,t?this.tmpDepth:this.mainDepth,i)}compositeTransparentTerrainOntoHUDVisibility(){this.renderToTargets((()=>{this._compositingHelper.compositeSpecial(this.getColorTexture(this.tmpColor),1)}),this.hudVisibility,this.tmpDepth)}renderOITPass(e,t,r){let i,o;switch(t){case 0:i=this.colorFloatTarget,o=[0,0,0,0];break;case 1:i=this.alphaFloatTarget,o=[1,1,1,1];break;case 2:i=this.frontFaceTarget,o=[0,0,0,0]}r?this.renderToTargets(e,i,this.tmpDepth,o,!0,!0):this.renderToTargets(e,i,this.mainDepth,o,!1)}compositeTransparentTerrainOntoMain(){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2)}compositeOccludedOntoMain(e){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2,e)}compositeTransparentOntoOpaque(e){e?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(16384)):this.bindFramebuffer(),this._compositingHelper.compositeTransparent(this.getColorTexture(this.colorFloatTarget),this.getColorTexture(this.alphaFloatTarget),this.getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(e){this.renderTargetHelper.disposeTargetResource(e)}set needLastFrameColorTexture(e){!e&&this._needLastFrameColorTexture&&(this._currentRenderTarget=0,this.disposeTarget(this.mainColorTarget1)),this._needLastFrameColorTexture=e}get needLastFrameColorTexture(){return this._needLastFrameColorTexture}renderToTargets(e,t,r,i,o=!1,s=!1){const a=this._rctx,h=this.bindTarget(t,r);let n=0;if(i){const e=1e-13,t=Math.max(e,i[3]);a.setClearColor(i[0],i[1],i[2],t),n|=16384}return o&&(n|=256),!1===s?s=0:(!0===s&&(s=255),n|=1024),n&&a.clearSafe(n,s),e(),a.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth),h}bindTarget(e,t){const r=this.renderTargetHelper.getFramebuffer(this.dimensions,e,t);return this._rctx.bindFramebuffer(r),r}getColorTexture(e){return this.renderTargetHelper.getColorTexture(e,this.dimensions)}getGpuMemoryUsage(){let e=0;return this.renderTargetHelper&&(e+=this.renderTargetHelper.getGpuMemoryUsage()),e}}const r=[0,0,0,0],i=[0,1,0,1];export{t as OffscreenRendering};\n"]},"metadata":{},"sourceType":"module"}