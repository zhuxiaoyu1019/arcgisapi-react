{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isNone as t } from \"../../../../core/maybe.js\";\nimport { d as e } from \"../../../../chunks/mat4.js\";\nimport { c as a } from \"../../../../chunks/mat4f64.js\";\nimport { s as o } from \"../../../../chunks/vec3.js\";\nimport { c as s } from \"../../../../chunks/vec3f64.js\";\nimport { projectBuffer as n, computeLinearTransformation as r } from \"../../../../geometry/projection.js\";\nimport { evaluateElevationAlignmentAtPoint as i } from \"./elevationAlignmentUtils.js\";\nimport { updateVertexAttributeAuxpos1w as l } from \"./graphicUtils.js\";\nimport c from \"../../support/debugFlags.js\";\nimport { SamplePosition as m } from \"../../support/ElevationProvider.js\";\n\nfunction f(t, e, a, o) {\n  const s = t.stageObject,\n        r = a.spatialReference,\n        l = s.geometryRecords,\n        f = l.length,\n        E = \"absolute-height\" !== e.mode;\n  let u = 0;\n\n  for (let p = 0; p < f; p++) {\n    const t = l[p].geometry,\n          f = l[p].getShaderTransformation();\n    A[0] = f[12], A[1] = f[13], A[2] = f[14], t.invalidateBoundingInfo();\n\n    const I = t.getMutableAttribute(\"position\"),\n          b = I.data,\n          g = t.vertexAttributes.get(\"mapPos\").data,\n          R = I.size,\n          _ = b.length / R,\n          D = new m(g, r);\n\n    let v = 0,\n        L = !1,\n        j = 0;\n\n    for (let s = 0; s < _; s++) {\n      h[0] = b[v], h[1] = b[v + 1], h[2] = b[v + 2];\n      const t = i(D, a, e, o, E ? S : null);\n      if (E && (j += S.sampledElevation), c.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES ? (b[v] = D.array[D.offset], b[v + 1] = D.array[D.offset + 1], b[v + 2] = t, n(b, r, v, b, o.spatialReference, v, 1), b[v] -= A[0], b[v + 1] -= A[1], b[v + 2] -= A[2]) : (T[0] = b[v] + A[0], T[1] = b[v + 1] + A[1], T[2] = b[v + 2] + A[2], o.setAltitude(T, t), b[v] = T[0] - A[0], b[v + 1] = T[1] - A[1], b[v + 2] = T[2] - A[2]), c.TESTS_DISABLE_UPDATE_THRESHOLDS) L = !0;else {\n        const t = d / o.unitInMeters;\n        (Math.abs(h[0] - b[v]) >= t || Math.abs(h[1] - b[v + 1]) >= t || Math.abs(h[2] - b[v + 2]) >= t) && (L = !0);\n      }\n      v += R, D.offset += 3;\n    }\n\n    u += j / _, L && s.geometryVertexAttrsUpdated(p);\n  }\n\n  return u / f;\n}\n\nfunction E(t, a, s, n) {\n  const m = t.stageObject,\n        f = a.centerPointInElevationSR;\n  let E = 0,\n      p = 0;\n  if (m.metadata.usesVerticalDistanceToGround) E = i(f, s, a, n, S), l(m, S.verticalDistanceToGround), p = S.sampledElevation;else {\n    const t = \"absolute-height\" !== a.mode;\n    E = i(f, s, a, n, t ? S : null), t && (p = S.sampledElevation);\n  }\n  const A = e(u, m.transformation),\n        h = o(b, A[12], A[13], A[14]);\n  c.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES ? (T[0] = f.x, T[1] = f.y, T[2] = E, r(f.spatialReference, T, A, n.spatialReference) && (m.transformation = A)) : n.setAltitudeOfTransformation(E, A);\n  const I = d / n.unitInMeters;\n  return (Math.abs(A[12] - h[0]) >= I || Math.abs(A[13] - h[1]) >= I || Math.abs(A[14] - h[2]) >= I) && (m.transformation = A), p;\n}\n\nconst u = a();\n\nfunction p(e, a, s, n) {\n  const l = e.graphics3DSymbolLayer.lodRenderer;\n  if (t(l)) return 0;\n  const m = a.centerPointInElevationSR;\n  let f = 0,\n      E = 0;\n  const u = \"absolute-height\" !== a.mode;\n  f = i(m, s, a, n, u ? S : null), u && (E = S.sampledElevation);\n  const p = l.instanceData,\n        A = e.instanceIndex,\n        h = I;\n  p.getGlobalTransform(A, h);\n  const g = o(b, h[12], h[13], h[14]);\n  c.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES ? (T[0] = m.x, T[1] = m.y, T[2] = f, r(m.spatialReference, T, h, n.spatialReference) && p.setGlobalTransform(A, h)) : n.setAltitudeOfTransformation(f, h);\n  const R = d / n.unitInMeters;\n  return (c.TESTS_DISABLE_UPDATE_THRESHOLDS || Math.abs(h[12] - g[0]) >= R || Math.abs(h[13] - g[1]) >= R || Math.abs(h[14] - g[2]) >= R) && p.setGlobalTransform(A, h), E;\n}\n\nconst d = .01,\n      T = s(),\n      A = s(),\n      h = s(),\n      I = a(),\n      b = s(),\n      S = {\n  verticalDistanceToGround: 0,\n  sampledElevation: 0\n};\nexport { p as perLodInstanceElevationAligner, E as perObjectElevationAligner, f as perVertexElevationAligner };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/layers/graphics/ElevationAligners.js"],"names":["isNone","t","d","e","c","a","s","o","projectBuffer","n","computeLinearTransformation","r","evaluateElevationAlignmentAtPoint","i","updateVertexAttributeAuxpos1w","l","SamplePosition","m","f","stageObject","spatialReference","geometryRecords","length","E","mode","u","p","geometry","getShaderTransformation","A","invalidateBoundingInfo","I","getMutableAttribute","b","data","g","vertexAttributes","get","R","size","_","D","v","L","j","h","S","sampledElevation","DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES","array","offset","T","setAltitude","TESTS_DISABLE_UPDATE_THRESHOLDS","unitInMeters","Math","abs","geometryVertexAttrsUpdated","centerPointInElevationSR","metadata","usesVerticalDistanceToGround","verticalDistanceToGround","transformation","x","y","setAltitudeOfTransformation","graphics3DSymbolLayer","lodRenderer","instanceData","instanceIndex","getGlobalTransform","setGlobalTransform","perLodInstanceElevationAligner","perObjectElevationAligner","perVertexElevationAligner"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isNone as t}from\"../../../../core/maybe.js\";import{d as e}from\"../../../../chunks/mat4.js\";import{c as a}from\"../../../../chunks/mat4f64.js\";import{s as o}from\"../../../../chunks/vec3.js\";import{c as s}from\"../../../../chunks/vec3f64.js\";import{projectBuffer as n,computeLinearTransformation as r}from\"../../../../geometry/projection.js\";import{evaluateElevationAlignmentAtPoint as i}from\"./elevationAlignmentUtils.js\";import{updateVertexAttributeAuxpos1w as l}from\"./graphicUtils.js\";import c from\"../../support/debugFlags.js\";import{SamplePosition as m}from\"../../support/ElevationProvider.js\";function f(t,e,a,o){const s=t.stageObject,r=a.spatialReference,l=s.geometryRecords,f=l.length,E=\"absolute-height\"!==e.mode;let u=0;for(let p=0;p<f;p++){const t=l[p].geometry,f=l[p].getShaderTransformation();A[0]=f[12],A[1]=f[13],A[2]=f[14],t.invalidateBoundingInfo();const I=t.getMutableAttribute(\"position\"),b=I.data,g=t.vertexAttributes.get(\"mapPos\").data,R=I.size,_=b.length/R,D=new m(g,r);let v=0,L=!1,j=0;for(let s=0;s<_;s++){h[0]=b[v],h[1]=b[v+1],h[2]=b[v+2];const t=i(D,a,e,o,E?S:null);if(E&&(j+=S.sampledElevation),c.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(b[v]=D.array[D.offset],b[v+1]=D.array[D.offset+1],b[v+2]=t,n(b,r,v,b,o.spatialReference,v,1),b[v]-=A[0],b[v+1]-=A[1],b[v+2]-=A[2]):(T[0]=b[v]+A[0],T[1]=b[v+1]+A[1],T[2]=b[v+2]+A[2],o.setAltitude(T,t),b[v]=T[0]-A[0],b[v+1]=T[1]-A[1],b[v+2]=T[2]-A[2]),c.TESTS_DISABLE_UPDATE_THRESHOLDS)L=!0;else{const t=d/o.unitInMeters;(Math.abs(h[0]-b[v])>=t||Math.abs(h[1]-b[v+1])>=t||Math.abs(h[2]-b[v+2])>=t)&&(L=!0)}v+=R,D.offset+=3}u+=j/_,L&&s.geometryVertexAttrsUpdated(p)}return u/f}function E(t,a,s,n){const m=t.stageObject,f=a.centerPointInElevationSR;let E=0,p=0;if(m.metadata.usesVerticalDistanceToGround)E=i(f,s,a,n,S),l(m,S.verticalDistanceToGround),p=S.sampledElevation;else{const t=\"absolute-height\"!==a.mode;E=i(f,s,a,n,t?S:null),t&&(p=S.sampledElevation)}const A=e(u,m.transformation),h=o(b,A[12],A[13],A[14]);c.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(T[0]=f.x,T[1]=f.y,T[2]=E,r(f.spatialReference,T,A,n.spatialReference)&&(m.transformation=A)):n.setAltitudeOfTransformation(E,A);const I=d/n.unitInMeters;return(Math.abs(A[12]-h[0])>=I||Math.abs(A[13]-h[1])>=I||Math.abs(A[14]-h[2])>=I)&&(m.transformation=A),p}const u=a();function p(e,a,s,n){const l=e.graphics3DSymbolLayer.lodRenderer;if(t(l))return 0;const m=a.centerPointInElevationSR;let f=0,E=0;const u=\"absolute-height\"!==a.mode;f=i(m,s,a,n,u?S:null),u&&(E=S.sampledElevation);const p=l.instanceData,A=e.instanceIndex,h=I;p.getGlobalTransform(A,h);const g=o(b,h[12],h[13],h[14]);c.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(T[0]=m.x,T[1]=m.y,T[2]=f,r(m.spatialReference,T,h,n.spatialReference)&&p.setGlobalTransform(A,h)):n.setAltitudeOfTransformation(f,h);const R=d/n.unitInMeters;return(c.TESTS_DISABLE_UPDATE_THRESHOLDS||Math.abs(h[12]-g[0])>=R||Math.abs(h[13]-g[1])>=R||Math.abs(h[14]-g[2])>=R)&&p.setGlobalTransform(A,h),E}const d=.01,T=s(),A=s(),h=s(),I=a(),b=s(),S={verticalDistanceToGround:0,sampledElevation:0};export{p as perLodInstanceElevationAligner,E as perObjectElevationAligner,f as perVertexElevationAligner};\n"]},"metadata":{},"sourceType":"module"}