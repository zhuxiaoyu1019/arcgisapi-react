{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from \"../../../../core/CircularArray.js\";\nimport e from \"../../../../core/Evented.js\";\nimport \"../../../../core/has.js\";\nimport { isNone as s, isSome as a, unwrap as r } from \"../../../../core/maybe.js\";\nimport { r as n } from \"../../../../chunks/rbush.js\";\nimport { fromRect as i } from \"../../../../geometry/support/aaBoundingBox.js\";\nimport { Store2D as o } from \"./Store2D.js\";\nimport { FeatureSetReaderIndirect as d } from \"./support/FeatureSetReaderPBFIndirect.js\";\n\nfunction h(t, e) {\n  return t << 16 | e;\n}\n\nfunction c(t) {\n  return (4294901760 & t) >>> 16;\n}\n\nfunction I(t) {\n  return 65535 & t;\n}\n\nconst u = {\n  getObjectId: t => t.getObjectId(),\n  getAttributes: t => t.readAttributes(),\n  getAttribute: (t, e) => t.readAttribute(e),\n  cloneWithGeometry: (t, e) => t,\n  getGeometry: t => t.readHydratedGeometry(),\n  getCentroid: (t, e) => t.readCentroid()\n};\n\nclass l extends o {\n  constructor(s, a, r) {\n    super(s, a), this.featureAdapter = u, this.events = new e(), this._featureSetsByInstance = new Map(), this._objectIdToDisplayId = new Map(), this._spatialIndexInvalid = !0, this._indexSearchCache = new t(50), this._index = n(9, t => ({\n      minX: this._storage.getXMin(t),\n      minY: this._storage.getYMin(t),\n      maxX: this._storage.getXMax(t),\n      maxY: this._storage.getYMax(t)\n    })), this._storage = a, this.mode = r;\n  }\n\n  get storage() {\n    return this._storage;\n  }\n\n  get storeStatistics() {\n    return {\n      featureCount: 0,\n      vertexCount: 0\n    };\n  }\n\n  hasInstance(t) {\n    return this._featureSetsByInstance.has(t);\n  }\n\n  onTileData(t, e) {\n    if (s(e.addOrUpdate)) return e;\n\n    if (e.addOrUpdate.attachStorage(this._storage), \"snapshot\" === this.mode) {\n      const s = e.addOrUpdate.getCursor();\n\n      for (; s.next();) {\n        const e = s.getDisplayId();\n        this.setComputedAttributes(this._storage, s, e, t.scale);\n      }\n\n      return e;\n    }\n\n    this._featureSetsByInstance.set(e.addOrUpdate.instance, e.addOrUpdate);\n\n    const a = e.addOrUpdate.getCursor();\n\n    for (; a.next();) this._insertFeature(a, t.scale);\n\n    return this._spatialIndexInvalid = !0, this.events.emit(\"changed\"), e;\n  }\n\n  search(t) {\n    this._rebuildIndex();\n\n    const e = t.id,\n          s = this._indexSearchCache.find(t => t.tileId === e);\n\n    if (a(s)) return s.readers;\n\n    const r = new Map(),\n          n = this._searchIndex(t.bounds),\n          i = [];\n\n    for (const a of n) {\n      const t = this._storage.getInstanceId(a),\n            e = c(t),\n            s = I(t);\n\n      r.has(e) || r.set(e, []);\n      r.get(e).push(s);\n    }\n\n    return r.forEach((t, e) => {\n      const s = this._featureSetsByInstance.get(e);\n\n      i.push(d.from(s, t));\n    }), this._indexSearchCache.enqueue({\n      tileId: e,\n      readers: i\n    }), i;\n  }\n\n  insert(t) {\n    const e = t.getCursor(),\n          s = this._storage;\n\n    for (; e.next();) {\n      var a;\n      const t = h(e.instance, e.getIndex()),\n            r = e.getObjectId(),\n            n = null != (a = this._objectIdToDisplayId.get(r)) ? a : this._storage.createDisplayId();\n      e.setDisplayId(n), s.setInstanceId(n, t), this._objectIdToDisplayId.set(r, n);\n    }\n\n    this._featureSetsByInstance.set(t.instance, t), this._spatialIndexInvalid = !0;\n  }\n\n  remove(t) {\n    const e = this._objectIdToDisplayId.get(t);\n\n    if (!e) return;\n\n    const s = this._storage.getInstanceId(e),\n          a = I(s),\n          r = c(s),\n          n = this._featureSetsByInstance.get(r);\n\n    this._objectIdToDisplayId.delete(t), this._storage.releaseDisplayId(e), n.removeAtIndex(a), n.isEmpty && this._featureSetsByInstance.delete(r), this._spatialIndexInvalid = !0;\n  }\n\n  forEach(t) {\n    this._objectIdToDisplayId.forEach(e => {\n      const s = this._storage.getInstanceId(e),\n            a = this._lookupFeature(s);\n\n      t(a);\n    });\n  }\n\n  forEachUnsafe(t) {\n    this._objectIdToDisplayId.forEach(e => {\n      const s = this._storage.getInstanceId(e),\n            a = c(s),\n            r = I(s),\n            n = this._getFeatureSet(a);\n\n      n.setIndex(r), t(n);\n    });\n  }\n\n  forEachInBounds(t, e) {\n    const s = this._searchIndex(t);\n\n    for (const a of s) {\n      const t = this.lookupFeatureByDisplayId(a, this._storage);\n      e(r(t));\n    }\n  }\n\n  forEachBounds(t, e, s) {\n    this._rebuildIndex();\n\n    const a = [0, 0, 0, 0];\n\n    for (const r of t) {\n      if (!r.readGeometry()) continue;\n      const t = r.getDisplayId();\n      a[0] = this._storage.getXMin(t), a[1] = this._storage.getYMin(t), a[2] = this._storage.getXMax(t), a[3] = this._storage.getYMax(t), e(i(s, a));\n    }\n  }\n\n  sweepFeatures(t, e, s) {\n    this._spatialIndexInvalid = !0, this._objectIdToDisplayId.forEach((a, r) => {\n      t.has(a) || (e.releaseDisplayId(a), s && s.unsetAttributeData(a), this._objectIdToDisplayId.delete(r));\n    }), this.events.emit(\"changed\");\n  }\n\n  sweepFeatureSets(t) {\n    this._spatialIndexInvalid = !0, this._featureSetsByInstance.forEach((e, s) => {\n      t.has(s) || this._featureSetsByInstance.delete(s);\n    });\n  }\n\n  lookupObjectId(t, e) {\n    const a = this.lookupFeatureByDisplayId(t, e);\n    return s(a) ? null : a.getObjectId();\n  }\n\n  lookupDisplayId(t) {\n    return this._objectIdToDisplayId.get(t);\n  }\n\n  lookupFeatureByDisplayId(t, e) {\n    const s = e.getInstanceId(t);\n    return this._lookupFeature(s);\n  }\n\n  lookupByDisplayIdUnsafe(t) {\n    const e = this._storage.getInstanceId(t),\n          s = c(e),\n          a = I(e),\n          r = this._getFeatureSet(s);\n\n    return r ? (r.setIndex(a), r) : null;\n  }\n\n  _insertFeature(t, e) {\n    const s = this._storage,\n          a = t.getObjectId(),\n          r = h(t.instance, t.getIndex());\n    s.getInstanceId(t.getDisplayId());\n\n    let n = this._objectIdToDisplayId.get(a);\n\n    n || (n = s.createDisplayId(), this._objectIdToDisplayId.set(a, n), this._spatialIndexInvalid = !0), t.setDisplayId(n), s.setInstanceId(n, r), this.setComputedAttributes(s, t, n, e);\n  }\n\n  _searchIndex(t) {\n    this._rebuildIndex();\n\n    const e = {\n      minX: t[0],\n      minY: t[1],\n      maxX: t[2],\n      maxY: t[3]\n    };\n    return this._index.search(e);\n  }\n\n  _rebuildIndex() {\n    if (!this._spatialIndexInvalid) return;\n    const t = [];\n    \"snapshot\" === this.mode ? this._featureSetsByInstance.forEach(e => {\n      const s = e.getCursor();\n\n      for (; s.next();) {\n        const e = s.getDisplayId();\n        this._storage.setBounds(e, s) && t.push(e);\n      }\n    }) : this._objectIdToDisplayId.forEach(e => {\n      const s = this._storage.getInstanceId(e);\n\n      this._storage.setBounds(e, this._lookupFeature(s)) && t.push(e);\n    }), this._index.clear(), this._index.load(t), this._indexSearchCache.clear(), this._spatialIndexInvalid = !1;\n  }\n\n  _lookupFeature(t) {\n    const e = c(t),\n          s = I(t),\n          a = this._getFeatureSet(e);\n\n    if (!a) return null;\n    const r = a.getCursor();\n    return r.setIndex(s), r;\n  }\n\n  _getFeatureSet(t) {\n    return this._featureSetsByInstance.get(t);\n  }\n\n}\n\nexport { l as FeatureStore2D, u as featureAdapter };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/2d/layers/features/FeatureStore2D.js"],"names":["t","e","isNone","s","isSome","a","unwrap","r","n","fromRect","i","Store2D","o","FeatureSetReaderIndirect","d","h","c","I","u","getObjectId","getAttributes","readAttributes","getAttribute","readAttribute","cloneWithGeometry","getGeometry","readHydratedGeometry","getCentroid","readCentroid","l","constructor","featureAdapter","events","_featureSetsByInstance","Map","_objectIdToDisplayId","_spatialIndexInvalid","_indexSearchCache","_index","minX","_storage","getXMin","minY","getYMin","maxX","getXMax","maxY","getYMax","mode","storage","storeStatistics","featureCount","vertexCount","hasInstance","has","onTileData","addOrUpdate","attachStorage","getCursor","next","getDisplayId","setComputedAttributes","scale","set","instance","_insertFeature","emit","search","_rebuildIndex","id","find","tileId","readers","_searchIndex","bounds","getInstanceId","get","push","forEach","from","enqueue","insert","getIndex","createDisplayId","setDisplayId","setInstanceId","remove","delete","releaseDisplayId","removeAtIndex","isEmpty","_lookupFeature","forEachUnsafe","_getFeatureSet","setIndex","forEachInBounds","lookupFeatureByDisplayId","forEachBounds","readGeometry","sweepFeatures","unsetAttributeData","sweepFeatureSets","lookupObjectId","lookupDisplayId","lookupByDisplayIdUnsafe","setBounds","clear","load","FeatureStore2D"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from\"../../../../core/CircularArray.js\";import e from\"../../../../core/Evented.js\";import\"../../../../core/has.js\";import{isNone as s,isSome as a,unwrap as r}from\"../../../../core/maybe.js\";import{r as n}from\"../../../../chunks/rbush.js\";import{fromRect as i}from\"../../../../geometry/support/aaBoundingBox.js\";import{Store2D as o}from\"./Store2D.js\";import{FeatureSetReaderIndirect as d}from\"./support/FeatureSetReaderPBFIndirect.js\";function h(t,e){return t<<16|e}function c(t){return(4294901760&t)>>>16}function I(t){return 65535&t}const u={getObjectId:t=>t.getObjectId(),getAttributes:t=>t.readAttributes(),getAttribute:(t,e)=>t.readAttribute(e),cloneWithGeometry:(t,e)=>t,getGeometry:t=>t.readHydratedGeometry(),getCentroid:(t,e)=>t.readCentroid()};class l extends o{constructor(s,a,r){super(s,a),this.featureAdapter=u,this.events=new e,this._featureSetsByInstance=new Map,this._objectIdToDisplayId=new Map,this._spatialIndexInvalid=!0,this._indexSearchCache=new t(50),this._index=n(9,(t=>({minX:this._storage.getXMin(t),minY:this._storage.getYMin(t),maxX:this._storage.getXMax(t),maxY:this._storage.getYMax(t)}))),this._storage=a,this.mode=r}get storage(){return this._storage}get storeStatistics(){return{featureCount:0,vertexCount:0}}hasInstance(t){return this._featureSetsByInstance.has(t)}onTileData(t,e){if(s(e.addOrUpdate))return e;if(e.addOrUpdate.attachStorage(this._storage),\"snapshot\"===this.mode){const s=e.addOrUpdate.getCursor();for(;s.next();){const e=s.getDisplayId();this.setComputedAttributes(this._storage,s,e,t.scale)}return e}this._featureSetsByInstance.set(e.addOrUpdate.instance,e.addOrUpdate);const a=e.addOrUpdate.getCursor();for(;a.next();)this._insertFeature(a,t.scale);return this._spatialIndexInvalid=!0,this.events.emit(\"changed\"),e}search(t){this._rebuildIndex();const e=t.id,s=this._indexSearchCache.find((t=>t.tileId===e));if(a(s))return s.readers;const r=new Map,n=this._searchIndex(t.bounds),i=[];for(const a of n){const t=this._storage.getInstanceId(a),e=c(t),s=I(t);r.has(e)||r.set(e,[]);r.get(e).push(s)}return r.forEach(((t,e)=>{const s=this._featureSetsByInstance.get(e);i.push(d.from(s,t))})),this._indexSearchCache.enqueue({tileId:e,readers:i}),i}insert(t){const e=t.getCursor(),s=this._storage;for(;e.next();){var a;const t=h(e.instance,e.getIndex()),r=e.getObjectId(),n=null!=(a=this._objectIdToDisplayId.get(r))?a:this._storage.createDisplayId();e.setDisplayId(n),s.setInstanceId(n,t),this._objectIdToDisplayId.set(r,n)}this._featureSetsByInstance.set(t.instance,t),this._spatialIndexInvalid=!0}remove(t){const e=this._objectIdToDisplayId.get(t);if(!e)return;const s=this._storage.getInstanceId(e),a=I(s),r=c(s),n=this._featureSetsByInstance.get(r);this._objectIdToDisplayId.delete(t),this._storage.releaseDisplayId(e),n.removeAtIndex(a),n.isEmpty&&this._featureSetsByInstance.delete(r),this._spatialIndexInvalid=!0}forEach(t){this._objectIdToDisplayId.forEach((e=>{const s=this._storage.getInstanceId(e),a=this._lookupFeature(s);t(a)}))}forEachUnsafe(t){this._objectIdToDisplayId.forEach((e=>{const s=this._storage.getInstanceId(e),a=c(s),r=I(s),n=this._getFeatureSet(a);n.setIndex(r),t(n)}))}forEachInBounds(t,e){const s=this._searchIndex(t);for(const a of s){const t=this.lookupFeatureByDisplayId(a,this._storage);e(r(t))}}forEachBounds(t,e,s){this._rebuildIndex();const a=[0,0,0,0];for(const r of t){if(!r.readGeometry())continue;const t=r.getDisplayId();a[0]=this._storage.getXMin(t),a[1]=this._storage.getYMin(t),a[2]=this._storage.getXMax(t),a[3]=this._storage.getYMax(t),e(i(s,a))}}sweepFeatures(t,e,s){this._spatialIndexInvalid=!0,this._objectIdToDisplayId.forEach(((a,r)=>{t.has(a)||(e.releaseDisplayId(a),s&&s.unsetAttributeData(a),this._objectIdToDisplayId.delete(r))})),this.events.emit(\"changed\")}sweepFeatureSets(t){this._spatialIndexInvalid=!0,this._featureSetsByInstance.forEach(((e,s)=>{t.has(s)||this._featureSetsByInstance.delete(s)}))}lookupObjectId(t,e){const a=this.lookupFeatureByDisplayId(t,e);return s(a)?null:a.getObjectId()}lookupDisplayId(t){return this._objectIdToDisplayId.get(t)}lookupFeatureByDisplayId(t,e){const s=e.getInstanceId(t);return this._lookupFeature(s)}lookupByDisplayIdUnsafe(t){const e=this._storage.getInstanceId(t),s=c(e),a=I(e),r=this._getFeatureSet(s);return r?(r.setIndex(a),r):null}_insertFeature(t,e){const s=this._storage,a=t.getObjectId(),r=h(t.instance,t.getIndex());s.getInstanceId(t.getDisplayId());let n=this._objectIdToDisplayId.get(a);n||(n=s.createDisplayId(),this._objectIdToDisplayId.set(a,n),this._spatialIndexInvalid=!0),t.setDisplayId(n),s.setInstanceId(n,r),this.setComputedAttributes(s,t,n,e)}_searchIndex(t){this._rebuildIndex();const e={minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]};return this._index.search(e)}_rebuildIndex(){if(!this._spatialIndexInvalid)return;const t=[];\"snapshot\"===this.mode?this._featureSetsByInstance.forEach((e=>{const s=e.getCursor();for(;s.next();){const e=s.getDisplayId();this._storage.setBounds(e,s)&&t.push(e)}})):this._objectIdToDisplayId.forEach((e=>{const s=this._storage.getInstanceId(e);this._storage.setBounds(e,this._lookupFeature(s))&&t.push(e)})),this._index.clear(),this._index.load(t),this._indexSearchCache.clear(),this._spatialIndexInvalid=!1}_lookupFeature(t){const e=c(t),s=I(t),a=this._getFeatureSet(e);if(!a)return null;const r=a.getCursor();return r.setIndex(s),r}_getFeatureSet(t){return this._featureSetsByInstance.get(t)}}export{l as FeatureStore2D,u as featureAdapter};\n"]},"metadata":{},"sourceType":"module"}