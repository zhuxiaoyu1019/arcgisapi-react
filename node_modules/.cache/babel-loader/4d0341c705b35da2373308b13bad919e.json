{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../core/Error.js\";\nimport { layerLookupMap as t } from \"../../layers/support/lazyLayerLoader.js\";\nimport r from \"../Portal.js\";\nimport { createForItem as n } from \"./jsonContext.js\";\nimport { loadStyleRenderer as l } from \"../../renderers/support/styleUtils.js\";\nimport { requestArcGISServiceJSON as a } from \"../../support/requestPresets.js\";\n\nasync function o(e, t) {\n  const r = e.instance.portalItem;\n  return r && r.id ? (await r.load(t), s(e), i(e, t)) : Promise.resolve();\n}\n\nfunction s(t) {\n  const r = t.instance.portalItem;\n  if (-1 === t.supportedTypes.indexOf(r.type)) throw new e(\"portal:invalid-layer-item-type\", \"Invalid layer item type '${type}', expected '${expectedType}'\", {\n    type: r.type,\n    expectedType: t.supportedTypes.join(\", \")\n  });\n}\n\nasync function i(e, t) {\n  const r = e.instance,\n        a = r.portalItem,\n        {\n    url: o,\n    title: s\n  } = a,\n        i = n(a);\n  if (\"group\" === r.type) return r.read({\n    title: s\n  }, i), u(r, e);\n  o && r.read({\n    url: o\n  }, i);\n  const c = await y(e, t);\n  return c && r.read(c, i), r.resourceReferences = {\n    portalItem: a,\n    paths: i.readResourcePaths\n  }, r.read({\n    title: s\n  }, i), l(r, i);\n}\n\nfunction u(r, n) {\n  let l;\n  const a = r.portalItem.type;\n\n  switch (a) {\n    case \"Feature Service\":\n      l = t.FeatureLayer;\n      break;\n\n    case \"Stream Service\":\n      l = t.StreamLayer;\n      break;\n\n    case \"Scene Service\":\n      l = t.SceneLayer;\n      break;\n\n    case \"Feature Collection\":\n      l = t.FeatureLayer;\n      break;\n\n    default:\n      throw new e(\"portal:unsupported-item-type-as-group\", `The item type '${a}' is not supported as a 'IGroupLayer'`);\n  }\n\n  let o;\n  return l().then(e => (o = e, y(n))).then(async e => \"Feature Service\" === a ? (e = await m(e, r.portalItem.url), p(r, o, e)) : h(e) > 0 ? p(r, o, e) : c(r, o));\n}\n\nfunction c(e, t) {\n  return e.portalItem.url ? a(e.portalItem.url).then(r => {\n    var n, l;\n\n    function a(e) {\n      return {\n        id: e.id,\n        name: e.name\n      };\n    }\n\n    r && p(e, t, {\n      layers: null == (n = r.layers) ? void 0 : n.map(a),\n      tables: null == (l = r.tables) ? void 0 : l.map(a)\n    });\n  }) : Promise.resolve();\n}\n\nfunction p(e, t, r) {\n  let n = r.layers || [];\n  const l = r.tables || [];\n  \"Feature Collection\" === e.portalItem.type && (n.forEach(e => {\n    var t;\n    \"Table\" === (null == e || null == (t = e.layerDefinition) ? void 0 : t.type) && l.push(e);\n  }), n = n.filter(e => {\n    var t;\n    return \"Table\" !== (null == e || null == (t = e.layerDefinition) ? void 0 : t.type);\n  })), n.reverse().forEach(n => {\n    const l = d(e, t, r, n);\n    e.add(l);\n  }), l.reverse().forEach(n => {\n    const l = d(e, t, r, n);\n    e.tables.add(l);\n  });\n}\n\nfunction d(e, t, n, l) {\n  const a = new t({\n    portalItem: e.portalItem.clone(),\n    layerId: l.id,\n    sublayerTitleMode: \"service-name\"\n  });\n\n  if (\"Feature Collection\" === e.portalItem.type) {\n    const t = {\n      origin: \"portal-item\",\n      portal: e.portalItem.portal || r.getDefault()\n    };\n    a.read(l, t);\n    const o = n.showLegend;\n    null != o && a.read({\n      showLegend: o\n    }, t);\n  }\n\n  return a;\n}\n\nfunction y(e, t) {\n  if (!1 === e.supportsData) return Promise.resolve(void 0);\n  const r = e.instance;\n  return r.portalItem.fetchData(\"json\", t).catch(() => null).then(async e => {\n    if (I(r)) {\n      let t,\n          n = !0;\n      return e && h(e) > 0 && (null == r.layerId && (r.layerId = f(e)), t = v(e, r.layerId), t && (1 === h(e) && (n = !1), null != e.showLegend && (t.showLegend = e.showLegend))), n && \"service-name\" !== r.sublayerTitleMode && (r.sublayerTitleMode = \"item-title-and-service-name\"), t;\n    }\n\n    return e;\n  });\n}\n\nasync function m(e, t) {\n  var r, n;\n\n  if (null == (null == (r = e) ? void 0 : r.layers) || null == (null == (n = e) ? void 0 : n.tables)) {\n    const r = await a(t);\n    (e = e || {}).layers = e.layers || (null == r ? void 0 : r.layers), e.tables = e.tables || (null == r ? void 0 : r.tables);\n  }\n\n  return e;\n}\n\nfunction f(e) {\n  const t = e.layers;\n  if (t && t.length) return t[0].id;\n  const r = e.tables;\n  return r && r.length ? r[0].id : null;\n}\n\nfunction v(e, t) {\n  const r = e.layers;\n  if (r) for (let l = 0; l < r.length; l++) if (r[l].id === t) return r[l];\n  const n = e.tables;\n  if (n) for (let l = 0; l < n.length; l++) if (n[l].id === t) return n[l];\n  return null;\n}\n\nfunction h(e) {\n  var t, r, n, l;\n  return (null != (t = null == e || null == (r = e.layers) ? void 0 : r.length) ? t : 0) + (null != (n = null == e || null == (l = e.tables) ? void 0 : l.length) ? n : 0);\n}\n\nfunction I(e) {\n  return \"stream\" !== e.type && \"layerId\" in e;\n}\n\nexport { f as getFirstLayerOrTableId, h as getNumLayersAndTables, o as load, m as preprocessFSItemData };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/portal/support/layersLoader.js"],"names":["e","layerLookupMap","t","r","createForItem","n","loadStyleRenderer","l","requestArcGISServiceJSON","a","o","instance","portalItem","id","load","s","i","Promise","resolve","supportedTypes","indexOf","type","expectedType","join","url","title","read","u","c","y","resourceReferences","paths","readResourcePaths","FeatureLayer","StreamLayer","SceneLayer","then","m","p","h","name","layers","map","tables","forEach","layerDefinition","push","filter","reverse","d","add","clone","layerId","sublayerTitleMode","origin","portal","getDefault","showLegend","supportsData","fetchData","catch","I","f","v","length","getFirstLayerOrTableId","getNumLayersAndTables","preprocessFSItemData"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../core/Error.js\";import{layerLookupMap as t}from\"../../layers/support/lazyLayerLoader.js\";import r from\"../Portal.js\";import{createForItem as n}from\"./jsonContext.js\";import{loadStyleRenderer as l}from\"../../renderers/support/styleUtils.js\";import{requestArcGISServiceJSON as a}from\"../../support/requestPresets.js\";async function o(e,t){const r=e.instance.portalItem;return r&&r.id?(await r.load(t),s(e),i(e,t)):Promise.resolve()}function s(t){const r=t.instance.portalItem;if(-1===t.supportedTypes.indexOf(r.type))throw new e(\"portal:invalid-layer-item-type\",\"Invalid layer item type '${type}', expected '${expectedType}'\",{type:r.type,expectedType:t.supportedTypes.join(\", \")})}async function i(e,t){const r=e.instance,a=r.portalItem,{url:o,title:s}=a,i=n(a);if(\"group\"===r.type)return r.read({title:s},i),u(r,e);o&&r.read({url:o},i);const c=await y(e,t);return c&&r.read(c,i),r.resourceReferences={portalItem:a,paths:i.readResourcePaths},r.read({title:s},i),l(r,i)}function u(r,n){let l;const a=r.portalItem.type;switch(a){case\"Feature Service\":l=t.FeatureLayer;break;case\"Stream Service\":l=t.StreamLayer;break;case\"Scene Service\":l=t.SceneLayer;break;case\"Feature Collection\":l=t.FeatureLayer;break;default:throw new e(\"portal:unsupported-item-type-as-group\",`The item type '${a}' is not supported as a 'IGroupLayer'`)}let o;return l().then((e=>(o=e,y(n)))).then((async e=>\"Feature Service\"===a?(e=await m(e,r.portalItem.url),p(r,o,e)):h(e)>0?p(r,o,e):c(r,o)))}function c(e,t){return e.portalItem.url?a(e.portalItem.url).then((r=>{var n,l;function a(e){return{id:e.id,name:e.name}}r&&p(e,t,{layers:null==(n=r.layers)?void 0:n.map(a),tables:null==(l=r.tables)?void 0:l.map(a)})})):Promise.resolve()}function p(e,t,r){let n=r.layers||[];const l=r.tables||[];\"Feature Collection\"===e.portalItem.type&&(n.forEach((e=>{var t;\"Table\"===(null==e||null==(t=e.layerDefinition)?void 0:t.type)&&l.push(e)})),n=n.filter((e=>{var t;return\"Table\"!==(null==e||null==(t=e.layerDefinition)?void 0:t.type)}))),n.reverse().forEach((n=>{const l=d(e,t,r,n);e.add(l)})),l.reverse().forEach((n=>{const l=d(e,t,r,n);e.tables.add(l)}))}function d(e,t,n,l){const a=new t({portalItem:e.portalItem.clone(),layerId:l.id,sublayerTitleMode:\"service-name\"});if(\"Feature Collection\"===e.portalItem.type){const t={origin:\"portal-item\",portal:e.portalItem.portal||r.getDefault()};a.read(l,t);const o=n.showLegend;null!=o&&a.read({showLegend:o},t)}return a}function y(e,t){if(!1===e.supportsData)return Promise.resolve(void 0);const r=e.instance;return r.portalItem.fetchData(\"json\",t).catch((()=>null)).then((async e=>{if(I(r)){let t,n=!0;return e&&h(e)>0&&(null==r.layerId&&(r.layerId=f(e)),t=v(e,r.layerId),t&&(1===h(e)&&(n=!1),null!=e.showLegend&&(t.showLegend=e.showLegend))),n&&\"service-name\"!==r.sublayerTitleMode&&(r.sublayerTitleMode=\"item-title-and-service-name\"),t}return e}))}async function m(e,t){var r,n;if(null==(null==(r=e)?void 0:r.layers)||null==(null==(n=e)?void 0:n.tables)){const r=await a(t);(e=e||{}).layers=e.layers||(null==r?void 0:r.layers),e.tables=e.tables||(null==r?void 0:r.tables)}return e}function f(e){const t=e.layers;if(t&&t.length)return t[0].id;const r=e.tables;return r&&r.length?r[0].id:null}function v(e,t){const r=e.layers;if(r)for(let l=0;l<r.length;l++)if(r[l].id===t)return r[l];const n=e.tables;if(n)for(let l=0;l<n.length;l++)if(n[l].id===t)return n[l];return null}function h(e){var t,r,n,l;return(null!=(t=null==e||null==(r=e.layers)?void 0:r.length)?t:0)+(null!=(n=null==e||null==(l=e.tables)?void 0:l.length)?n:0)}function I(e){return\"stream\"!==e.type&&\"layerId\"in e}export{f as getFirstLayerOrTableId,h as getNumLayersAndTables,o as load,m as preprocessFSItemData};\n"]},"metadata":{},"sourceType":"module"}