{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../chunks/tslib.es6.js\";\nimport t from \"../../core/Accessor.js\";\nimport { intersect as i } from \"../../core/arrayUtils.js\";\nimport s from \"../../core/Handles.js\";\nimport o from \"../../core/Logger.js\";\nimport { createAbortController as n } from \"../../core/promiseUtils.js\";\nimport { on as a, when as l } from \"../../core/watchUtils.js\";\nimport { property as r } from \"../../core/accessorSupport/decorators/property.js\";\nimport \"../../core/has.js\";\nimport \"../../core/accessorSupport/ensureType.js\";\nimport { subclass as d } from \"../../core/accessorSupport/decorators/subclass.js\";\nimport { mayHaveHeightModelInfo as h, deriveHeightModelInfoFromLayer as c } from \"../../geometry/support/heightModelInfoUtils.js\";\nimport { canProject as p, project as u } from \"../../geometry/support/webMercatorUtils.js\";\nvar f;\nconst g = o.getLogger(\"esri.views.support.DefaultsFromMap\"),\n      _ = 10;\nlet m = f = class extends t {\n  constructor() {\n    super(...arguments), this._handles = new s(), this._waitTask = null, this._extentProjectController = null, this._spatialReferenceCandidates = null, this._extentCandidates = null, this.logDebugInformation = !1, this.isSpatialReferenceDone = !1, this.isTileInfoDone = !1, this.isHeightModelInfoSearching = !1, this.spatialReference = null, this.extent = null, this.heightModelInfo = null, this.vcsWkid = null, this.latestVcsWkid = null, this.mapCollectionPaths = f.DefaultMapCollectionPaths.slice(), this.tileInfo = null;\n  }\n\n  initialize() {\n    this.watch(\"mapCollectionPaths\", () => {\n      this._running && (this.reset(), this.start());\n    });\n  }\n\n  destroy() {\n    this._set(\"view\", null), this._handles && (this._handles.destroy(), this._handles = null), this._cancelLoading();\n  }\n\n  get _running() {\n    return !!(this._handles && this._handles.size > 0);\n  }\n\n  reset() {\n    this._handles.removeAll(), this._set(\"isSpatialReferenceDone\", !1), this._set(\"isTileInfoDone\", !1), this._set(\"isHeightModelInfoSearching\", !1), this._set(\"spatialReference\", null), this._set(\"extent\", null), this._set(\"heightModelInfo\", null), this._set(\"vcsWkid\", null), this._set(\"latestVcsWkid\", null), this._set(\"tileInfo\", null), this._spatialReferenceCandidates = null, this._extentCandidates = null;\n  }\n\n  start() {\n    this._handles.removeAll();\n\n    const e = this._updateLayerChange.bind(this);\n\n    for (const t of this.mapCollectionPaths) this._handles.add(a(this.view, `map.${t}`, \"change\", e, e, e, !0));\n\n    this._handles.add(l(this, \"isSpatialReferenceDone\", () => this._updateTileInfo(), !0));\n  }\n\n  _ownerNameFromCollectionName(e) {\n    const t = e.lastIndexOf(\".\");\n    return -1 === t ? \"view\" : \"view.\" + e.slice(0, t);\n  }\n\n  _ensureLoadedOwnersFromCollectionName(e) {\n    const t = this._ownerNameFromCollectionName(e).split(\".\");\n\n    let i;\n\n    for (let s = 0; s < t.length && (i = this.get(t.slice(0, s + 1).join(\".\")), i); s++) if (i.load && !i.isFulfilled()) return {\n      collectionName: e,\n      owner: null,\n      loading: i.load().catch(() => {})\n    };\n\n    return {\n      collectionName: e,\n      owner: i\n    };\n  }\n\n  _cancelLoading() {\n    this._waitTask = null, this._extentProjectController && (this._extentProjectController.abort(), this._extentProjectController = null);\n  }\n\n  _updateWhen(e) {\n    let t = !0,\n        i = !1;\n    const s = e.catch(() => {}).then(() => {\n      t ? i = !0 : s === this._waitTask && this._update();\n    });\n    return t = !1, i || (this._waitTask = s), i;\n  }\n\n  _updateLayerChange() {\n    this.isSpatialReferenceDone && !this.spatialReference && this._set(\"isSpatialReferenceDone\", !1), this._update();\n  }\n\n  _update() {\n    if (this._cancelLoading(), this.view) {\n      if (!this.isSpatialReferenceDone) {\n        this._debugLog(\"Starting search for spatial reference...\");\n\n        const e = this._processMapCollections(e => this._processSpatialReferenceSource(e));\n\n        if (this._debugLog(`Search ended with status '${y(e)}'`), 0 !== e) {\n          let e = null,\n              t = this._spatialReferenceCandidates;\n          if (!t || t.length < 1 ? (e = this.defaultSpatialReference, this._debugLog(`No spatial reference found, locking to default (${S(e)})`)) : (this.defaultSpatialReference && t.length > 1 && t.findIndex(e => e.equals(this.defaultSpatialReference)) > -1 && (t = [this.defaultSpatialReference]), e = t[0], this._debugLog(`Locking to ${S(e)}`)), this._set(\"spatialReference\", e), e) {\n            if (this.extent) this._set(\"isSpatialReferenceDone\", !0);else {\n              const t = this.logDebugInformation;\n              this.logDebugInformation = !1, this._processMapCollections(t => this._findExtent(t, e)), this.logDebugInformation = t, this._projectExtentCandidate().catch(() => {}).then(() => this._set(\"isSpatialReferenceDone\", !0));\n            }\n          } else this._set(\"isSpatialReferenceDone\", !0);\n        }\n      }\n\n      if (null == this.heightModelInfo && this.view.isHeightModelInfoRequired) {\n        this._debugLog(\"Starting search for height model info...\");\n\n        const e = this._processMapCollections(e => this._processHeightModelInfoSource(e), e => h(e));\n\n        this._debugLog(`Search ended with status ${y(e)}`), this._set(\"isHeightModelInfoSearching\", 0 === e);\n      }\n\n      this._updateTileInfo();\n    }\n  }\n\n  _processMapCollections(e, t) {\n    this._preloadMapCollections(t);\n\n    let i = 2;\n    return this._forAllMapCollectionSources(e => {\n      if (2 !== i) return !1;\n      const {\n        collectionName: t\n      } = e;\n      return this._debugLog(`Processing collection ${t}...`), !(e.loading && !this._updateWhen(e.loading)) || (this._debugLog(`Collection ${e.collectionName} owner is loading -> wait`), i = 0, !1);\n    }, s => {\n      if (2 !== i) return !1;\n      return null != t && !t(s) ? (this._debugLog(`Source ${s.id} is skipped due to predicate`), !1) : !s.load || s.isFulfilled() || this._updateWhen(s.load()) ? !((!s.load || s.isResolved()) && e(s)) || (i = 1, !1) : (this._debugLog(`Source ${s.id} is loading -> wait`), i = 0, !1);\n    }), i;\n  }\n\n  _preloadMapCollections(e) {\n    let t = _;\n    const i = this.logDebugInformation;\n    this.logDebugInformation = !1, this._forAllMapCollectionSources(() => !0, s => {\n      if (0 === t) return !1;\n      return !(null != e && !e(s)) && (s.load && !s.isFulfilled() && (this.logDebugInformation = i, this._debugLog(`Pre-loading source ${s.id}`), this.logDebugInformation = !1, s.load().catch(() => {}), t--), !0);\n    }), this.logDebugInformation = i;\n  }\n\n  _forAllMapCollectionSources(e, t) {\n    for (const i of this.mapCollectionPaths) {\n      const s = `map.${i}`,\n            o = this._ensureLoadedOwnersFromCollectionName(s);\n\n      if (!1 === e(o)) continue;\n      const n = o.owner;\n\n      if (!n || n.isRejected && n.isRejected()) {\n        this._debugLog(`Collection ${s} owner is invalid or rejected -> skip`);\n\n        continue;\n      }\n\n      const a = this.view.get(s);\n      a ? this._forEachSource(a, t) : this._debugLog(`Collection ${s} does not exist -> skip`);\n    }\n  }\n\n  _forEachSource(e, t) {\n    for (const i of e.items) !1 !== t(i) && \"layers\" in i && i.layers && this._forEachSource(i.layers, t);\n  }\n\n  _processSpatialReferenceSource(e) {\n    let t = this._getSupportedSpatialReferences(e);\n\n    return 0 !== t.length && (this._spatialReferenceCandidates ? (t = i(t, this._spatialReferenceCandidates, (e, t) => e.equals(t)), t.length > 0 ? this._spatialReferenceCandidates = t : this._debugLog(`Layer ${e.id} is ignored because its supported spatial\\n          references are not compatible with the previous candidates`)) : this._spatialReferenceCandidates = t, 1 === this._spatialReferenceCandidates.length);\n  }\n\n  _findExtent(e, t) {\n    const i = \"fullExtents\" in e && e.fullExtents || (e.fullExtent ? [e.fullExtent] : []),\n          s = i.find(e => e.spatialReference.equals(t));\n    if (s) return this._set(\"extent\", s), !0;\n\n    if (this._getSupportedSpatialReferences(e).length > 0) {\n      const t = i.map(t => ({\n        extent: t,\n        layer: e\n      })),\n            s = this._extentCandidates || [];\n      this._extentCandidates = s.concat(t);\n    }\n\n    return !1;\n  }\n\n  async _projectExtentCandidate() {\n    if (!this._extentCandidates || !this._extentCandidates.length) return;\n\n    const e = this.spatialReference,\n          t = this._extentCandidates.find(t => p(t.extent.spatialReference, e));\n\n    if (t) this._set(\"extent\", u(t.extent, e));else {\n      const t = this._extentCandidates[0];\n      this._extentProjectController = n();\n      const i = await import(\"../../portal/support/geometryServiceUtils.js\");\n\n      try {\n        const s = await i.projectGeometry(t.extent, e, t.layer.portalItem, this._extentProjectController.signal);\n\n        this._set(\"extent\", s);\n      } catch {}\n\n      this._extentProjectController = null;\n    }\n  }\n\n  _getSupportedSpatialReferences(e) {\n    const t = \"supportedSpatialReferences\" in e && e.supportedSpatialReferences || (e.spatialReference ? [e.spatialReference] : []);\n    if (0 === t.length) return this._debugLog(`Layer ${e.id} is ignored because it does not have any spatial references`), [];\n    const i = t.filter(t => this.view.isSpatialReferenceSupported(t, e, e => this._debugLog(e)));\n    return 0 === i.length ? this._debugLog(`Layer ${e.id} has spatial references but none of them are supported (or layer doesn't require locking)`) : this._debugLog(`Layer ${e.id} has spatial references. Resulting candidate set: ${i.map(S).join(\", \")}`), i;\n  }\n\n  _processHeightModelInfoSource(e) {\n    const t = c(e);\n    return !!t && (this._set(\"heightModelInfo\", t), this._set(\"isHeightModelInfoSearching\", !1), e.spatialReference && (this._set(\"vcsWkid\", e.spatialReference.vcsWkid), this._set(\"latestVcsWkid\", e.spatialReference.latestVcsWkid)), !0);\n  }\n\n  _updateTileInfo() {\n    if (null != this.tileInfo) return;\n    if (!this.view.isTileInfoRequired()) return void this._set(\"isTileInfoDone\", !0);\n    if (!this.isSpatialReferenceDone) return;\n    const e = this.get(\"view.map\");\n    if (!e) return void this._debugLog(\"updateTileInfo: no map\");\n    const t = e.basemap,\n          i = e.get(\"layers.0\");\n    let s = null;\n\n    if (t && \"failed\" !== t.loadStatus) {\n      if (!t.loaded) return this._updateWhen(t.load()), void this._debugLog(\"updateTileInfo: basemap still loading\");\n      const e = t && t.get(\"baseLayers.0\");\n\n      if (e && \"failed\" !== e.loadStatus) {\n        if (!e.loaded) return this._updateWhen(e.load()), void this._debugLog(\"updateTileInfo: first basemap layer still loading\");\n        s = \"tileInfo\" in e && e.tileInfo;\n      } else {\n        if (!i || \"failed\" === i.loadStatus) return this._debugLog(\"updateTileInfo: no tileInfo\"), void this._set(\"isTileInfoDone\", !0);\n        if (!i.loaded) return this._updateWhen(i.load()), void this._debugLog(\"updateTileInfo: first operational layer still loading\");\n        s = \"tileInfo\" in i && i.tileInfo;\n      }\n    } else if (i && \"failed\" !== i.loadStatus) {\n      if (!i.loaded) return this._updateWhen(i.load()), void this._debugLog(\"updateTileInfo: first operational layer still loading\");\n      s = \"tileInfo\" in i && i.tileInfo;\n    }\n\n    s && !s.spatialReference.equals(this.spatialReference) && (s = null), this._debugLog(`updateTileInfo: setting ${s}`), this._set(\"tileInfo\", s), this._set(\"isTileInfoDone\", !0);\n  }\n\n  _debugLog(e) {\n    this.logDebugInformation && g.info(e);\n  }\n\n};\n\nfunction S(e) {\n  return e ? JSON.stringify(e.toJSON()) : \"undefined\";\n}\n\nfunction y(e) {\n  switch (e) {\n    case 0:\n      return \"Waiting\";\n\n    case 1:\n      return \"Found\";\n\n    case 2:\n      return \"Exhausted\";\n  }\n}\n\nm.DefaultMapCollectionPaths = [\"basemap.baseLayers\", \"layers\", \"ground.layers\", \"basemap.referenceLayers\"], e([r()], m.prototype, \"logDebugInformation\", void 0), e([r({\n  readOnly: !0\n})], m.prototype, \"isSpatialReferenceDone\", void 0), e([r({\n  readOnly: !0\n})], m.prototype, \"isTileInfoDone\", void 0), e([r({\n  readOnly: !0\n})], m.prototype, \"isHeightModelInfoSearching\", void 0), e([r({\n  constructOnly: !0\n})], m.prototype, \"view\", void 0), e([r({\n  readOnly: !0\n})], m.prototype, \"spatialReference\", void 0), e([r({\n  readOnly: !0\n})], m.prototype, \"extent\", void 0), e([r({\n  readOnly: !0\n})], m.prototype, \"heightModelInfo\", void 0), e([r({\n  readOnly: !0\n})], m.prototype, \"vcsWkid\", void 0), e([r({\n  readOnly: !0\n})], m.prototype, \"latestVcsWkid\", void 0), e([r()], m.prototype, \"mapCollectionPaths\", void 0), e([r()], m.prototype, \"defaultSpatialReference\", void 0), e([r({\n  readOnly: !0\n})], m.prototype, \"tileInfo\", void 0), m = f = e([d(\"esri.views.support.DefaultsFromMap\")], m);\nvar I = m;\nexport default I;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/support/DefaultsFromMap.js"],"names":["_","e","t","intersect","i","s","o","createAbortController","n","on","a","when","l","property","r","subclass","d","mayHaveHeightModelInfo","h","deriveHeightModelInfoFromLayer","c","canProject","p","project","u","f","g","getLogger","m","constructor","arguments","_handles","_waitTask","_extentProjectController","_spatialReferenceCandidates","_extentCandidates","logDebugInformation","isSpatialReferenceDone","isTileInfoDone","isHeightModelInfoSearching","spatialReference","extent","heightModelInfo","vcsWkid","latestVcsWkid","mapCollectionPaths","DefaultMapCollectionPaths","slice","tileInfo","initialize","watch","_running","reset","start","destroy","_set","_cancelLoading","size","removeAll","_updateLayerChange","bind","add","view","_updateTileInfo","_ownerNameFromCollectionName","lastIndexOf","_ensureLoadedOwnersFromCollectionName","split","length","get","join","load","isFulfilled","collectionName","owner","loading","catch","abort","_updateWhen","then","_update","_debugLog","_processMapCollections","_processSpatialReferenceSource","y","defaultSpatialReference","S","findIndex","equals","_findExtent","_projectExtentCandidate","isHeightModelInfoRequired","_processHeightModelInfoSource","_preloadMapCollections","_forAllMapCollectionSources","id","isResolved","isRejected","_forEachSource","items","layers","_getSupportedSpatialReferences","fullExtents","fullExtent","find","map","layer","concat","projectGeometry","portalItem","signal","supportedSpatialReferences","filter","isSpatialReferenceSupported","isTileInfoRequired","basemap","loadStatus","loaded","info","JSON","stringify","toJSON","prototype","readOnly","constructOnly","I"],"mappings":"AAAA;AACA;AACA;AACA;AACA,SAAOA,CAAC,IAAIC,CAAZ,QAAkB,2BAAlB;AAA8C,OAAOC,CAAP,MAAa,wBAAb;AAAsC,SAAOC,SAAS,IAAIC,CAApB,QAA0B,0BAA1B;AAAqD,OAAOC,CAAP,MAAa,uBAAb;AAAqC,OAAOC,CAAP,MAAa,sBAAb;AAAoC,SAAOC,qBAAqB,IAAIC,CAAhC,QAAsC,4BAAtC;AAAmE,SAAOC,EAAE,IAAIC,CAAb,EAAeC,IAAI,IAAIC,CAAvB,QAA6B,0BAA7B;AAAwD,SAAOC,QAAQ,IAAIC,CAAnB,QAAyB,mDAAzB;AAA6E,OAAM,mBAAN;AAA0B,OAAM,0CAAN;AAAiD,SAAOC,QAAQ,IAAIC,CAAnB,QAAyB,mDAAzB;AAA6E,SAAOC,sBAAsB,IAAIC,CAAjC,EAAmCC,8BAA8B,IAAIC,CAArE,QAA2E,gDAA3E;AAA4H,SAAOC,UAAU,IAAIC,CAArB,EAAuBC,OAAO,IAAIC,CAAlC,QAAwC,4CAAxC;AAAqF,IAAIC,CAAJ;AAAM,MAAMC,CAAC,GAACpB,CAAC,CAACqB,SAAF,CAAY,oCAAZ,CAAR;AAAA,MAA0D3B,CAAC,GAAC,EAA5D;AAA+D,IAAI4B,CAAC,GAACH,CAAC,GAAC,cAAcvB,CAAd,CAAe;AAAC2B,EAAAA,WAAW,GAAE;AAAC,UAAM,GAAGC,SAAT,GAAoB,KAAKC,QAAL,GAAc,IAAI1B,CAAJ,EAAlC,EAAwC,KAAK2B,SAAL,GAAe,IAAvD,EAA4D,KAAKC,wBAAL,GAA8B,IAA1F,EAA+F,KAAKC,2BAAL,GAAiC,IAAhI,EAAqI,KAAKC,iBAAL,GAAuB,IAA5J,EAAiK,KAAKC,mBAAL,GAAyB,CAAC,CAA3L,EAA6L,KAAKC,sBAAL,GAA4B,CAAC,CAA1N,EAA4N,KAAKC,cAAL,GAAoB,CAAC,CAAjP,EAAmP,KAAKC,0BAAL,GAAgC,CAAC,CAApR,EAAsR,KAAKC,gBAAL,GAAsB,IAA5S,EAAiT,KAAKC,MAAL,GAAY,IAA7T,EAAkU,KAAKC,eAAL,GAAqB,IAAvV,EAA4V,KAAKC,OAAL,GAAa,IAAzW,EAA8W,KAAKC,aAAL,GAAmB,IAAjY,EAAsY,KAAKC,kBAAL,GAAwBpB,CAAC,CAACqB,yBAAF,CAA4BC,KAA5B,EAA9Z,EAAkc,KAAKC,QAAL,GAAc,IAAhd;AAAqd;;AAAAC,EAAAA,UAAU,GAAE;AAAC,SAAKC,KAAL,CAAW,oBAAX,EAAiC,MAAI;AAAC,WAAKC,QAAL,KAAgB,KAAKC,KAAL,IAAa,KAAKC,KAAL,EAA7B;AAA2C,KAAjF;AAAoF;;AAAAC,EAAAA,OAAO,GAAE;AAAC,SAAKC,IAAL,CAAU,MAAV,EAAiB,IAAjB,GAAuB,KAAKxB,QAAL,KAAgB,KAAKA,QAAL,CAAcuB,OAAd,IAAwB,KAAKvB,QAAL,GAAc,IAAtD,CAAvB,EAAmF,KAAKyB,cAAL,EAAnF;AAAyG;;AAAY,MAARL,QAAQ,GAAE;AAAC,WAAM,CAAC,EAAE,KAAKpB,QAAL,IAAe,KAAKA,QAAL,CAAc0B,IAAd,GAAmB,CAApC,CAAP;AAA8C;;AAAAL,EAAAA,KAAK,GAAE;AAAC,SAAKrB,QAAL,CAAc2B,SAAd,IAA0B,KAAKH,IAAL,CAAU,wBAAV,EAAmC,CAAC,CAApC,CAA1B,EAAiE,KAAKA,IAAL,CAAU,gBAAV,EAA2B,CAAC,CAA5B,CAAjE,EAAgG,KAAKA,IAAL,CAAU,4BAAV,EAAuC,CAAC,CAAxC,CAAhG,EAA2I,KAAKA,IAAL,CAAU,kBAAV,EAA6B,IAA7B,CAA3I,EAA8K,KAAKA,IAAL,CAAU,QAAV,EAAmB,IAAnB,CAA9K,EAAuM,KAAKA,IAAL,CAAU,iBAAV,EAA4B,IAA5B,CAAvM,EAAyO,KAAKA,IAAL,CAAU,SAAV,EAAoB,IAApB,CAAzO,EAAmQ,KAAKA,IAAL,CAAU,eAAV,EAA0B,IAA1B,CAAnQ,EAAmS,KAAKA,IAAL,CAAU,UAAV,EAAqB,IAArB,CAAnS,EAA8T,KAAKrB,2BAAL,GAAiC,IAA/V,EAAoW,KAAKC,iBAAL,GAAuB,IAA3X;AAAgY;;AAAAkB,EAAAA,KAAK,GAAE;AAAC,SAAKtB,QAAL,CAAc2B,SAAd;;AAA0B,UAAMzD,CAAC,GAAC,KAAK0D,kBAAL,CAAwBC,IAAxB,CAA6B,IAA7B,CAAR;;AAA2C,SAAI,MAAM1D,CAAV,IAAe,KAAK2C,kBAApB,EAAuC,KAAKd,QAAL,CAAc8B,GAAd,CAAkBnD,CAAC,CAAC,KAAKoD,IAAN,EAAY,OAAM5D,CAAE,EAApB,EAAsB,QAAtB,EAA+BD,CAA/B,EAAiCA,CAAjC,EAAmCA,CAAnC,EAAqC,CAAC,CAAtC,CAAnB;;AAA6D,SAAK8B,QAAL,CAAc8B,GAAd,CAAkBjD,CAAC,CAAC,IAAD,EAAM,wBAAN,EAAgC,MAAI,KAAKmD,eAAL,EAApC,EAA4D,CAAC,CAA7D,CAAnB;AAAoF;;AAAAC,EAAAA,4BAA4B,CAAC/D,CAAD,EAAG;AAAC,UAAMC,CAAC,GAACD,CAAC,CAACgE,WAAF,CAAc,GAAd,CAAR;AAA2B,WAAM,CAAC,CAAD,KAAK/D,CAAL,GAAO,MAAP,GAAc,UAAQD,CAAC,CAAC8C,KAAF,CAAQ,CAAR,EAAU7C,CAAV,CAA5B;AAAyC;;AAAAgE,EAAAA,qCAAqC,CAACjE,CAAD,EAAG;AAAC,UAAMC,CAAC,GAAC,KAAK8D,4BAAL,CAAkC/D,CAAlC,EAAqCkE,KAArC,CAA2C,GAA3C,CAAR;;AAAwD,QAAI/D,CAAJ;;AAAM,SAAI,IAAIC,CAAC,GAAC,CAAV,EAAYA,CAAC,GAACH,CAAC,CAACkE,MAAJ,KAAahE,CAAC,GAAC,KAAKiE,GAAL,CAASnE,CAAC,CAAC6C,KAAF,CAAQ,CAAR,EAAU1C,CAAC,GAAC,CAAZ,EAAeiE,IAAf,CAAoB,GAApB,CAAT,CAAF,EAAqClE,CAAlD,CAAZ,EAAiEC,CAAC,EAAlE,EAAqE,IAAGD,CAAC,CAACmE,IAAF,IAAQ,CAACnE,CAAC,CAACoE,WAAF,EAAZ,EAA4B,OAAM;AAACC,MAAAA,cAAc,EAACxE,CAAhB;AAAkByE,MAAAA,KAAK,EAAC,IAAxB;AAA6BC,MAAAA,OAAO,EAACvE,CAAC,CAACmE,IAAF,GAASK,KAAT,CAAgB,MAAI,CAAE,CAAtB;AAArC,KAAN;;AAAqE,WAAM;AAACH,MAAAA,cAAc,EAACxE,CAAhB;AAAkByE,MAAAA,KAAK,EAACtE;AAAxB,KAAN;AAAiC;;AAAAoD,EAAAA,cAAc,GAAE;AAAC,SAAKxB,SAAL,GAAe,IAAf,EAAoB,KAAKC,wBAAL,KAAgC,KAAKA,wBAAL,CAA8B4C,KAA9B,IAAsC,KAAK5C,wBAAL,GAA8B,IAApG,CAApB;AAA8H;;AAAA6C,EAAAA,WAAW,CAAC7E,CAAD,EAAG;AAAC,QAAIC,CAAC,GAAC,CAAC,CAAP;AAAA,QAASE,CAAC,GAAC,CAAC,CAAZ;AAAc,UAAMC,CAAC,GAACJ,CAAC,CAAC2E,KAAF,CAAS,MAAI,CAAE,CAAf,EAAkBG,IAAlB,CAAwB,MAAI;AAAC7E,MAAAA,CAAC,GAACE,CAAC,GAAC,CAAC,CAAJ,GAAMC,CAAC,KAAG,KAAK2B,SAAT,IAAoB,KAAKgD,OAAL,EAA3B;AAA0C,KAAvE,CAAR;AAAkF,WAAO9E,CAAC,GAAC,CAAC,CAAH,EAAKE,CAAC,KAAG,KAAK4B,SAAL,GAAe3B,CAAlB,CAAN,EAA2BD,CAAlC;AAAoC;;AAAAuD,EAAAA,kBAAkB,GAAE;AAAC,SAAKtB,sBAAL,IAA6B,CAAC,KAAKG,gBAAnC,IAAqD,KAAKe,IAAL,CAAU,wBAAV,EAAmC,CAAC,CAApC,CAArD,EAA4F,KAAKyB,OAAL,EAA5F;AAA2G;;AAAAA,EAAAA,OAAO,GAAE;AAAC,QAAG,KAAKxB,cAAL,IAAsB,KAAKM,IAA9B,EAAmC;AAAC,UAAG,CAAC,KAAKzB,sBAAT,EAAgC;AAAC,aAAK4C,SAAL,CAAe,0CAAf;;AAA2D,cAAMhF,CAAC,GAAC,KAAKiF,sBAAL,CAA6BjF,CAAC,IAAE,KAAKkF,8BAAL,CAAoClF,CAApC,CAAhC,CAAR;;AAAiF,YAAG,KAAKgF,SAAL,CAAgB,6BAA4BG,CAAC,CAACnF,CAAD,CAAI,GAAjD,GAAqD,MAAIA,CAA5D,EAA8D;AAAC,cAAIA,CAAC,GAAC,IAAN;AAAA,cAAWC,CAAC,GAAC,KAAKgC,2BAAlB;AAA8C,cAAG,CAAChC,CAAD,IAAIA,CAAC,CAACkE,MAAF,GAAS,CAAb,IAAgBnE,CAAC,GAAC,KAAKoF,uBAAP,EAA+B,KAAKJ,SAAL,CAAgB,mDAAkDK,CAAC,CAACrF,CAAD,CAAI,GAAvE,CAA/C,KAA4H,KAAKoF,uBAAL,IAA8BnF,CAAC,CAACkE,MAAF,GAAS,CAAvC,IAA0ClE,CAAC,CAACqF,SAAF,CAAatF,CAAC,IAAEA,CAAC,CAACuF,MAAF,CAAS,KAAKH,uBAAd,CAAhB,IAAyD,CAAC,CAApG,KAAwGnF,CAAC,GAAC,CAAC,KAAKmF,uBAAN,CAA1G,GAA0IpF,CAAC,GAACC,CAAC,CAAC,CAAD,CAA7I,EAAiJ,KAAK+E,SAAL,CAAgB,cAAaK,CAAC,CAACrF,CAAD,CAAI,EAAlC,CAA7Q,GAAmT,KAAKsD,IAAL,CAAU,kBAAV,EAA6BtD,CAA7B,CAAnT,EAAmVA,CAAtV;AAAwV,gBAAG,KAAKwC,MAAR,EAAe,KAAKc,IAAL,CAAU,wBAAV,EAAmC,CAAC,CAApC,EAAf,KAA0D;AAAC,oBAAMrD,CAAC,GAAC,KAAKkC,mBAAb;AAAiC,mBAAKA,mBAAL,GAAyB,CAAC,CAA1B,EAA4B,KAAK8C,sBAAL,CAA6BhF,CAAC,IAAE,KAAKuF,WAAL,CAAiBvF,CAAjB,EAAmBD,CAAnB,CAAhC,CAA5B,EAAoF,KAAKmC,mBAAL,GAAyBlC,CAA7G,EAA+G,KAAKwF,uBAAL,GAA+Bd,KAA/B,CAAsC,MAAI,CAAE,CAA5C,EAA+CG,IAA/C,CAAqD,MAAI,KAAKxB,IAAL,CAAU,wBAAV,EAAmC,CAAC,CAApC,CAAzD,CAA/G;AAAiN;AAAroB,iBAA0oB,KAAKA,IAAL,CAAU,wBAAV,EAAmC,CAAC,CAApC;AAAuC;AAAC;;AAAA,UAAG,QAAM,KAAKb,eAAX,IAA4B,KAAKoB,IAAL,CAAU6B,yBAAzC,EAAmE;AAAC,aAAKV,SAAL,CAAe,0CAAf;;AAA2D,cAAMhF,CAAC,GAAC,KAAKiF,sBAAL,CAA6BjF,CAAC,IAAE,KAAK2F,6BAAL,CAAmC3F,CAAnC,CAAhC,EAAwEA,CAAC,IAAEiB,CAAC,CAACjB,CAAD,CAA5E,CAAR;;AAA0F,aAAKgF,SAAL,CAAgB,4BAA2BG,CAAC,CAACnF,CAAD,CAAI,EAAhD,GAAmD,KAAKsD,IAAL,CAAU,4BAAV,EAAuC,MAAItD,CAA3C,CAAnD;AAAiG;;AAAA,WAAK8D,eAAL;AAAuB;AAAC;;AAAAmB,EAAAA,sBAAsB,CAACjF,CAAD,EAAGC,CAAH,EAAK;AAAC,SAAK2F,sBAAL,CAA4B3F,CAA5B;;AAA+B,QAAIE,CAAC,GAAC,CAAN;AAAQ,WAAO,KAAK0F,2BAAL,CAAkC7F,CAAC,IAAE;AAAC,UAAG,MAAIG,CAAP,EAAS,OAAM,CAAC,CAAP;AAAS,YAAK;AAACqE,QAAAA,cAAc,EAACvE;AAAhB,UAAmBD,CAAxB;AAA0B,aAAO,KAAKgF,SAAL,CAAgB,yBAAwB/E,CAAE,KAA1C,GAAgD,EAAED,CAAC,CAAC0E,OAAF,IAAW,CAAC,KAAKG,WAAL,CAAiB7E,CAAC,CAAC0E,OAAnB,CAAd,MAA6C,KAAKM,SAAL,CAAgB,cAAahF,CAAC,CAACwE,cAAe,2BAA9C,GAA0ErE,CAAC,GAAC,CAA5E,EAA8E,CAAC,CAA5H,CAAvD;AAAsL,KAAxQ,EAA2QC,CAAC,IAAE;AAAC,UAAG,MAAID,CAAP,EAAS,OAAM,CAAC,CAAP;AAAS,aAAO,QAAMF,CAAN,IAAS,CAACA,CAAC,CAACG,CAAD,CAAX,IAAgB,KAAK4E,SAAL,CAAgB,UAAS5E,CAAC,CAAC0F,EAAG,8BAA9B,GAA6D,CAAC,CAA9E,IAAiF,CAAC1F,CAAC,CAACkE,IAAH,IAASlE,CAAC,CAACmE,WAAF,EAAT,IAA0B,KAAKM,WAAL,CAAiBzE,CAAC,CAACkE,IAAF,EAAjB,CAA1B,GAAqD,EAAE,CAAC,CAAClE,CAAC,CAACkE,IAAH,IAASlE,CAAC,CAAC2F,UAAF,EAAV,KAA2B/F,CAAC,CAACI,CAAD,CAA9B,MAAqCD,CAAC,GAAC,CAAF,EAAI,CAAC,CAA1C,CAArD,IAAmG,KAAK6E,SAAL,CAAgB,UAAS5E,CAAC,CAAC0F,EAAG,qBAA9B,GAAoD3F,CAAC,GAAC,CAAtD,EAAwD,CAAC,CAA5J,CAAxF;AAAuP,KAAxhB,GAA2hBA,CAAliB;AAAoiB;;AAAAyF,EAAAA,sBAAsB,CAAC5F,CAAD,EAAG;AAAC,QAAIC,CAAC,GAACF,CAAN;AAAQ,UAAMI,CAAC,GAAC,KAAKgC,mBAAb;AAAiC,SAAKA,mBAAL,GAAyB,CAAC,CAA1B,EAA4B,KAAK0D,2BAAL,CAAkC,MAAI,CAAC,CAAvC,EAA2CzF,CAAC,IAAE;AAAC,UAAG,MAAIH,CAAP,EAAS,OAAM,CAAC,CAAP;AAAS,aAAM,EAAE,QAAMD,CAAN,IAAS,CAACA,CAAC,CAACI,CAAD,CAAb,MAAoBA,CAAC,CAACkE,IAAF,IAAQ,CAAClE,CAAC,CAACmE,WAAF,EAAT,KAA2B,KAAKpC,mBAAL,GAAyBhC,CAAzB,EAA2B,KAAK6E,SAAL,CAAgB,sBAAqB5E,CAAC,CAAC0F,EAAG,EAA1C,CAA3B,EAAwE,KAAK3D,mBAAL,GAAyB,CAAC,CAAlG,EAAoG/B,CAAC,CAACkE,IAAF,GAASK,KAAT,CAAgB,MAAI,CAAE,CAAtB,CAApG,EAA6H1E,CAAC,EAAzJ,GAA6J,CAAC,CAAlL,CAAN;AAA2L,KAA5P,CAA5B,EAA2R,KAAKkC,mBAAL,GAAyBhC,CAApT;AAAsT;;AAAA0F,EAAAA,2BAA2B,CAAC7F,CAAD,EAAGC,CAAH,EAAK;AAAC,SAAI,MAAME,CAAV,IAAe,KAAKyC,kBAApB,EAAuC;AAAC,YAAMxC,CAAC,GAAE,OAAMD,CAAE,EAAjB;AAAA,YAAmBE,CAAC,GAAC,KAAK4D,qCAAL,CAA2C7D,CAA3C,CAArB;;AAAmE,UAAG,CAAC,CAAD,KAAKJ,CAAC,CAACK,CAAD,CAAT,EAAa;AAAS,YAAME,CAAC,GAACF,CAAC,CAACoE,KAAV;;AAAgB,UAAG,CAAClE,CAAD,IAAIA,CAAC,CAACyF,UAAF,IAAczF,CAAC,CAACyF,UAAF,EAArB,EAAoC;AAAC,aAAKhB,SAAL,CAAgB,cAAa5E,CAAE,uCAA/B;;AAAuE;AAAS;;AAAA,YAAMK,CAAC,GAAC,KAAKoD,IAAL,CAAUO,GAAV,CAAchE,CAAd,CAAR;AAAyBK,MAAAA,CAAC,GAAC,KAAKwF,cAAL,CAAoBxF,CAApB,EAAsBR,CAAtB,CAAD,GAA0B,KAAK+E,SAAL,CAAgB,cAAa5E,CAAE,yBAA/B,CAA3B;AAAoF;AAAC;;AAAA6F,EAAAA,cAAc,CAACjG,CAAD,EAAGC,CAAH,EAAK;AAAC,SAAI,MAAME,CAAV,IAAeH,CAAC,CAACkG,KAAjB,EAAuB,CAAC,CAAD,KAAKjG,CAAC,CAACE,CAAD,CAAN,IAAW,YAAWA,CAAtB,IAAyBA,CAAC,CAACgG,MAA3B,IAAmC,KAAKF,cAAL,CAAoB9F,CAAC,CAACgG,MAAtB,EAA6BlG,CAA7B,CAAnC;AAAmE;;AAAAiF,EAAAA,8BAA8B,CAAClF,CAAD,EAAG;AAAC,QAAIC,CAAC,GAAC,KAAKmG,8BAAL,CAAoCpG,CAApC,CAAN;;AAA6C,WAAO,MAAIC,CAAC,CAACkE,MAAN,KAAe,KAAKlC,2BAAL,IAAkChC,CAAC,GAACE,CAAC,CAACF,CAAD,EAAG,KAAKgC,2BAAR,EAAqC,CAACjC,CAAD,EAAGC,CAAH,KAAOD,CAAC,CAACuF,MAAF,CAAStF,CAAT,CAA5C,CAAH,EAA6DA,CAAC,CAACkE,MAAF,GAAS,CAAT,GAAW,KAAKlC,2BAAL,GAAiChC,CAA5C,GAA8C,KAAK+E,SAAL,CAAgB,SAAQhF,CAAC,CAAC8F,EAAG,iHAA7B,CAA7I,IAA6R,KAAK7D,2BAAL,GAAiChC,CAA9T,EAAgU,MAAI,KAAKgC,2BAAL,CAAiCkC,MAApX,CAAP;AAAmY;;AAAAqB,EAAAA,WAAW,CAACxF,CAAD,EAAGC,CAAH,EAAK;AAAC,UAAME,CAAC,GAAC,iBAAgBH,CAAhB,IAAmBA,CAAC,CAACqG,WAArB,KAAmCrG,CAAC,CAACsG,UAAF,GAAa,CAACtG,CAAC,CAACsG,UAAH,CAAb,GAA4B,EAA/D,CAAR;AAAA,UAA2ElG,CAAC,GAACD,CAAC,CAACoG,IAAF,CAAQvG,CAAC,IAAEA,CAAC,CAACuC,gBAAF,CAAmBgD,MAAnB,CAA0BtF,CAA1B,CAAX,CAA7E;AAAuH,QAAGG,CAAH,EAAK,OAAO,KAAKkD,IAAL,CAAU,QAAV,EAAmBlD,CAAnB,GAAsB,CAAC,CAA9B;;AAAgC,QAAG,KAAKgG,8BAAL,CAAoCpG,CAApC,EAAuCmE,MAAvC,GAA8C,CAAjD,EAAmD;AAAC,YAAMlE,CAAC,GAACE,CAAC,CAACqG,GAAF,CAAOvG,CAAC,KAAG;AAACuC,QAAAA,MAAM,EAACvC,CAAR;AAAUwG,QAAAA,KAAK,EAACzG;AAAhB,OAAH,CAAR,CAAR;AAAA,YAAyCI,CAAC,GAAC,KAAK8B,iBAAL,IAAwB,EAAnE;AAAsE,WAAKA,iBAAL,GAAuB9B,CAAC,CAACsG,MAAF,CAASzG,CAAT,CAAvB;AAAmC;;AAAA,WAAM,CAAC,CAAP;AAAS;;AAA6B,QAAvBwF,uBAAuB,GAAE;AAAC,QAAG,CAAC,KAAKvD,iBAAN,IAAyB,CAAC,KAAKA,iBAAL,CAAuBiC,MAApD,EAA2D;;AAAO,UAAMnE,CAAC,GAAC,KAAKuC,gBAAb;AAAA,UAA8BtC,CAAC,GAAC,KAAKiC,iBAAL,CAAuBqE,IAAvB,CAA6BtG,CAAC,IAAEoB,CAAC,CAACpB,CAAC,CAACuC,MAAF,CAASD,gBAAV,EAA2BvC,CAA3B,CAAjC,CAAhC;;AAAiG,QAAGC,CAAH,EAAK,KAAKqD,IAAL,CAAU,QAAV,EAAmB/B,CAAC,CAACtB,CAAC,CAACuC,MAAH,EAAUxC,CAAV,CAApB,EAAL,KAA2C;AAAC,YAAMC,CAAC,GAAC,KAAKiC,iBAAL,CAAuB,CAAvB,CAAR;AAAkC,WAAKF,wBAAL,GAA8BzB,CAAC,EAA/B;AAAkC,YAAMJ,CAAC,GAAC,MAAM,OAAO,8CAAP,CAAd;;AAAqE,UAAG;AAAC,cAAMC,CAAC,GAAC,MAAMD,CAAC,CAACwG,eAAF,CAAkB1G,CAAC,CAACuC,MAApB,EAA2BxC,CAA3B,EAA6BC,CAAC,CAACwG,KAAF,CAAQG,UAArC,EAAgD,KAAK5E,wBAAL,CAA8B6E,MAA9E,CAAd;;AAAoG,aAAKvD,IAAL,CAAU,QAAV,EAAmBlD,CAAnB;AAAsB,OAA9H,CAA8H,MAAK,CAAE;;AAAA,WAAK4B,wBAAL,GAA8B,IAA9B;AAAmC;AAAC;;AAAAoE,EAAAA,8BAA8B,CAACpG,CAAD,EAAG;AAAC,UAAMC,CAAC,GAAC,gCAA+BD,CAA/B,IAAkCA,CAAC,CAAC8G,0BAApC,KAAiE9G,CAAC,CAACuC,gBAAF,GAAmB,CAACvC,CAAC,CAACuC,gBAAH,CAAnB,GAAwC,EAAzG,CAAR;AAAqH,QAAG,MAAItC,CAAC,CAACkE,MAAT,EAAgB,OAAO,KAAKa,SAAL,CAAgB,SAAQhF,CAAC,CAAC8F,EAAG,6DAA7B,GAA2F,EAAlG;AAAqG,UAAM3F,CAAC,GAACF,CAAC,CAAC8G,MAAF,CAAU9G,CAAC,IAAE,KAAK4D,IAAL,CAAUmD,2BAAV,CAAsC/G,CAAtC,EAAwCD,CAAxC,EAA2CA,CAAC,IAAE,KAAKgF,SAAL,CAAehF,CAAf,CAA9C,CAAb,CAAR;AAAyF,WAAO,MAAIG,CAAC,CAACgE,MAAN,GAAa,KAAKa,SAAL,CAAgB,SAAQhF,CAAC,CAAC8F,EAAG,2FAA7B,CAAb,GAAsI,KAAKd,SAAL,CAAgB,SAAQhF,CAAC,CAAC8F,EAAG,qDAAoD3F,CAAC,CAACqG,GAAF,CAAMnB,CAAN,EAAShB,IAAT,CAAc,IAAd,CAAoB,EAArG,CAAtI,EAA8OlE,CAArP;AAAuP;;AAAAwF,EAAAA,6BAA6B,CAAC3F,CAAD,EAAG;AAAC,UAAMC,CAAC,GAACkB,CAAC,CAACnB,CAAD,CAAT;AAAa,WAAM,CAAC,CAACC,CAAF,KAAM,KAAKqD,IAAL,CAAU,iBAAV,EAA4BrD,CAA5B,GAA+B,KAAKqD,IAAL,CAAU,4BAAV,EAAuC,CAAC,CAAxC,CAA/B,EAA0EtD,CAAC,CAACuC,gBAAF,KAAqB,KAAKe,IAAL,CAAU,SAAV,EAAoBtD,CAAC,CAACuC,gBAAF,CAAmBG,OAAvC,GAAgD,KAAKY,IAAL,CAAU,eAAV,EAA0BtD,CAAC,CAACuC,gBAAF,CAAmBI,aAA7C,CAArE,CAA1E,EAA4M,CAAC,CAAnN,CAAN;AAA4N;;AAAAmB,EAAAA,eAAe,GAAE;AAAC,QAAG,QAAM,KAAKf,QAAd,EAAuB;AAAO,QAAG,CAAC,KAAKc,IAAL,CAAUoD,kBAAV,EAAJ,EAAmC,OAAO,KAAK,KAAK3D,IAAL,CAAU,gBAAV,EAA2B,CAAC,CAA5B,CAAZ;AAA2C,QAAG,CAAC,KAAKlB,sBAAT,EAAgC;AAAO,UAAMpC,CAAC,GAAC,KAAKoE,GAAL,CAAS,UAAT,CAAR;AAA6B,QAAG,CAACpE,CAAJ,EAAM,OAAO,KAAK,KAAKgF,SAAL,CAAe,wBAAf,CAAZ;AAAqD,UAAM/E,CAAC,GAACD,CAAC,CAACkH,OAAV;AAAA,UAAkB/G,CAAC,GAACH,CAAC,CAACoE,GAAF,CAAM,UAAN,CAApB;AAAsC,QAAIhE,CAAC,GAAC,IAAN;;AAAW,QAAGH,CAAC,IAAE,aAAWA,CAAC,CAACkH,UAAnB,EAA8B;AAAC,UAAG,CAAClH,CAAC,CAACmH,MAAN,EAAa,OAAO,KAAKvC,WAAL,CAAiB5E,CAAC,CAACqE,IAAF,EAAjB,GAA2B,KAAK,KAAKU,SAAL,CAAe,uCAAf,CAAvC;AAA+F,YAAMhF,CAAC,GAACC,CAAC,IAAEA,CAAC,CAACmE,GAAF,CAAM,cAAN,CAAX;;AAAiC,UAAGpE,CAAC,IAAE,aAAWA,CAAC,CAACmH,UAAnB,EAA8B;AAAC,YAAG,CAACnH,CAAC,CAACoH,MAAN,EAAa,OAAO,KAAKvC,WAAL,CAAiB7E,CAAC,CAACsE,IAAF,EAAjB,GAA2B,KAAK,KAAKU,SAAL,CAAe,mDAAf,CAAvC;AAA2G5E,QAAAA,CAAC,GAAC,cAAaJ,CAAb,IAAgBA,CAAC,CAAC+C,QAApB;AAA6B,OAApL,MAAwL;AAAC,YAAG,CAAC5C,CAAD,IAAI,aAAWA,CAAC,CAACgH,UAApB,EAA+B,OAAO,KAAKnC,SAAL,CAAe,6BAAf,GAA8C,KAAK,KAAK1B,IAAL,CAAU,gBAAV,EAA2B,CAAC,CAA5B,CAA1D;AAAyF,YAAG,CAACnD,CAAC,CAACiH,MAAN,EAAa,OAAO,KAAKvC,WAAL,CAAiB1E,CAAC,CAACmE,IAAF,EAAjB,GAA2B,KAAK,KAAKU,SAAL,CAAe,uDAAf,CAAvC;AAA+G5E,QAAAA,CAAC,GAAC,cAAaD,CAAb,IAAgBA,CAAC,CAAC4C,QAApB;AAA6B;AAAC,KAAvnB,MAA4nB,IAAG5C,CAAC,IAAE,aAAWA,CAAC,CAACgH,UAAnB,EAA8B;AAAC,UAAG,CAAChH,CAAC,CAACiH,MAAN,EAAa,OAAO,KAAKvC,WAAL,CAAiB1E,CAAC,CAACmE,IAAF,EAAjB,GAA2B,KAAK,KAAKU,SAAL,CAAe,uDAAf,CAAvC;AAA+G5E,MAAAA,CAAC,GAAC,cAAaD,CAAb,IAAgBA,CAAC,CAAC4C,QAApB;AAA6B;;AAAA3C,IAAAA,CAAC,IAAE,CAACA,CAAC,CAACmC,gBAAF,CAAmBgD,MAAnB,CAA0B,KAAKhD,gBAA/B,CAAJ,KAAuDnC,CAAC,GAAC,IAAzD,GAA+D,KAAK4E,SAAL,CAAgB,2BAA0B5E,CAAE,EAA5C,CAA/D,EAA8G,KAAKkD,IAAL,CAAU,UAAV,EAAqBlD,CAArB,CAA9G,EAAsI,KAAKkD,IAAL,CAAU,gBAAV,EAA2B,CAAC,CAA5B,CAAtI;AAAqK;;AAAA0B,EAAAA,SAAS,CAAChF,CAAD,EAAG;AAAC,SAAKmC,mBAAL,IAA0BV,CAAC,CAAC4F,IAAF,CAAOrH,CAAP,CAA1B;AAAoC;;AAAz8Q,CAAvB;;AAAk+Q,SAASqF,CAAT,CAAWrF,CAAX,EAAa;AAAC,SAAOA,CAAC,GAACsH,IAAI,CAACC,SAAL,CAAevH,CAAC,CAACwH,MAAF,EAAf,CAAD,GAA4B,WAApC;AAAgD;;AAAA,SAASrC,CAAT,CAAWnF,CAAX,EAAa;AAAC,UAAOA,CAAP;AAAU,SAAK,CAAL;AAAO,aAAM,SAAN;;AAAgB,SAAK,CAAL;AAAO,aAAM,OAAN;;AAAc,SAAK,CAAL;AAAO,aAAM,WAAN;AAA7D;AAAgF;;AAAA2B,CAAC,CAACkB,yBAAF,GAA4B,CAAC,oBAAD,EAAsB,QAAtB,EAA+B,eAA/B,EAA+C,yBAA/C,CAA5B,EAAsG7C,CAAC,CAAC,CAACa,CAAC,EAAF,CAAD,EAAOc,CAAC,CAAC8F,SAAT,EAAmB,qBAAnB,EAAyC,KAAK,CAA9C,CAAvG,EAAwJzH,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC6G,EAAAA,QAAQ,EAAC,CAAC;AAAX,CAAD,CAAF,CAAD,EAAoB/F,CAAC,CAAC8F,SAAtB,EAAgC,wBAAhC,EAAyD,KAAK,CAA9D,CAAzJ,EAA0NzH,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC6G,EAAAA,QAAQ,EAAC,CAAC;AAAX,CAAD,CAAF,CAAD,EAAoB/F,CAAC,CAAC8F,SAAtB,EAAgC,gBAAhC,EAAiD,KAAK,CAAtD,CAA3N,EAAoRzH,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC6G,EAAAA,QAAQ,EAAC,CAAC;AAAX,CAAD,CAAF,CAAD,EAAoB/F,CAAC,CAAC8F,SAAtB,EAAgC,4BAAhC,EAA6D,KAAK,CAAlE,CAArR,EAA0VzH,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC8G,EAAAA,aAAa,EAAC,CAAC;AAAhB,CAAD,CAAF,CAAD,EAAyBhG,CAAC,CAAC8F,SAA3B,EAAqC,MAArC,EAA4C,KAAK,CAAjD,CAA3V,EAA+YzH,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC6G,EAAAA,QAAQ,EAAC,CAAC;AAAX,CAAD,CAAF,CAAD,EAAoB/F,CAAC,CAAC8F,SAAtB,EAAgC,kBAAhC,EAAmD,KAAK,CAAxD,CAAhZ,EAA2czH,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC6G,EAAAA,QAAQ,EAAC,CAAC;AAAX,CAAD,CAAF,CAAD,EAAoB/F,CAAC,CAAC8F,SAAtB,EAAgC,QAAhC,EAAyC,KAAK,CAA9C,CAA5c,EAA6fzH,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC6G,EAAAA,QAAQ,EAAC,CAAC;AAAX,CAAD,CAAF,CAAD,EAAoB/F,CAAC,CAAC8F,SAAtB,EAAgC,iBAAhC,EAAkD,KAAK,CAAvD,CAA9f,EAAwjBzH,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC6G,EAAAA,QAAQ,EAAC,CAAC;AAAX,CAAD,CAAF,CAAD,EAAoB/F,CAAC,CAAC8F,SAAtB,EAAgC,SAAhC,EAA0C,KAAK,CAA/C,CAAzjB,EAA2mBzH,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC6G,EAAAA,QAAQ,EAAC,CAAC;AAAX,CAAD,CAAF,CAAD,EAAoB/F,CAAC,CAAC8F,SAAtB,EAAgC,eAAhC,EAAgD,KAAK,CAArD,CAA5mB,EAAoqBzH,CAAC,CAAC,CAACa,CAAC,EAAF,CAAD,EAAOc,CAAC,CAAC8F,SAAT,EAAmB,oBAAnB,EAAwC,KAAK,CAA7C,CAArqB,EAAqtBzH,CAAC,CAAC,CAACa,CAAC,EAAF,CAAD,EAAOc,CAAC,CAAC8F,SAAT,EAAmB,yBAAnB,EAA6C,KAAK,CAAlD,CAAttB,EAA2wBzH,CAAC,CAAC,CAACa,CAAC,CAAC;AAAC6G,EAAAA,QAAQ,EAAC,CAAC;AAAX,CAAD,CAAF,CAAD,EAAoB/F,CAAC,CAAC8F,SAAtB,EAAgC,UAAhC,EAA2C,KAAK,CAAhD,CAA5wB,EAA+zB9F,CAAC,GAACH,CAAC,GAACxB,CAAC,CAAC,CAACe,CAAC,CAAC,oCAAD,CAAF,CAAD,EAA2CY,CAA3C,CAAp0B;AAAk3B,IAAIiG,CAAC,GAACjG,CAAN;AAAQ,eAAeiG,CAAf","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../chunks/tslib.es6.js\";import t from\"../../core/Accessor.js\";import{intersect as i}from\"../../core/arrayUtils.js\";import s from\"../../core/Handles.js\";import o from\"../../core/Logger.js\";import{createAbortController as n}from\"../../core/promiseUtils.js\";import{on as a,when as l}from\"../../core/watchUtils.js\";import{property as r}from\"../../core/accessorSupport/decorators/property.js\";import\"../../core/has.js\";import\"../../core/accessorSupport/ensureType.js\";import{subclass as d}from\"../../core/accessorSupport/decorators/subclass.js\";import{mayHaveHeightModelInfo as h,deriveHeightModelInfoFromLayer as c}from\"../../geometry/support/heightModelInfoUtils.js\";import{canProject as p,project as u}from\"../../geometry/support/webMercatorUtils.js\";var f;const g=o.getLogger(\"esri.views.support.DefaultsFromMap\"),_=10;let m=f=class extends t{constructor(){super(...arguments),this._handles=new s,this._waitTask=null,this._extentProjectController=null,this._spatialReferenceCandidates=null,this._extentCandidates=null,this.logDebugInformation=!1,this.isSpatialReferenceDone=!1,this.isTileInfoDone=!1,this.isHeightModelInfoSearching=!1,this.spatialReference=null,this.extent=null,this.heightModelInfo=null,this.vcsWkid=null,this.latestVcsWkid=null,this.mapCollectionPaths=f.DefaultMapCollectionPaths.slice(),this.tileInfo=null}initialize(){this.watch(\"mapCollectionPaths\",(()=>{this._running&&(this.reset(),this.start())}))}destroy(){this._set(\"view\",null),this._handles&&(this._handles.destroy(),this._handles=null),this._cancelLoading()}get _running(){return!!(this._handles&&this._handles.size>0)}reset(){this._handles.removeAll(),this._set(\"isSpatialReferenceDone\",!1),this._set(\"isTileInfoDone\",!1),this._set(\"isHeightModelInfoSearching\",!1),this._set(\"spatialReference\",null),this._set(\"extent\",null),this._set(\"heightModelInfo\",null),this._set(\"vcsWkid\",null),this._set(\"latestVcsWkid\",null),this._set(\"tileInfo\",null),this._spatialReferenceCandidates=null,this._extentCandidates=null}start(){this._handles.removeAll();const e=this._updateLayerChange.bind(this);for(const t of this.mapCollectionPaths)this._handles.add(a(this.view,`map.${t}`,\"change\",e,e,e,!0));this._handles.add(l(this,\"isSpatialReferenceDone\",(()=>this._updateTileInfo()),!0))}_ownerNameFromCollectionName(e){const t=e.lastIndexOf(\".\");return-1===t?\"view\":\"view.\"+e.slice(0,t)}_ensureLoadedOwnersFromCollectionName(e){const t=this._ownerNameFromCollectionName(e).split(\".\");let i;for(let s=0;s<t.length&&(i=this.get(t.slice(0,s+1).join(\".\")),i);s++)if(i.load&&!i.isFulfilled())return{collectionName:e,owner:null,loading:i.load().catch((()=>{}))};return{collectionName:e,owner:i}}_cancelLoading(){this._waitTask=null,this._extentProjectController&&(this._extentProjectController.abort(),this._extentProjectController=null)}_updateWhen(e){let t=!0,i=!1;const s=e.catch((()=>{})).then((()=>{t?i=!0:s===this._waitTask&&this._update()}));return t=!1,i||(this._waitTask=s),i}_updateLayerChange(){this.isSpatialReferenceDone&&!this.spatialReference&&this._set(\"isSpatialReferenceDone\",!1),this._update()}_update(){if(this._cancelLoading(),this.view){if(!this.isSpatialReferenceDone){this._debugLog(\"Starting search for spatial reference...\");const e=this._processMapCollections((e=>this._processSpatialReferenceSource(e)));if(this._debugLog(`Search ended with status '${y(e)}'`),0!==e){let e=null,t=this._spatialReferenceCandidates;if(!t||t.length<1?(e=this.defaultSpatialReference,this._debugLog(`No spatial reference found, locking to default (${S(e)})`)):(this.defaultSpatialReference&&t.length>1&&t.findIndex((e=>e.equals(this.defaultSpatialReference)))>-1&&(t=[this.defaultSpatialReference]),e=t[0],this._debugLog(`Locking to ${S(e)}`)),this._set(\"spatialReference\",e),e)if(this.extent)this._set(\"isSpatialReferenceDone\",!0);else{const t=this.logDebugInformation;this.logDebugInformation=!1,this._processMapCollections((t=>this._findExtent(t,e))),this.logDebugInformation=t,this._projectExtentCandidate().catch((()=>{})).then((()=>this._set(\"isSpatialReferenceDone\",!0)))}else this._set(\"isSpatialReferenceDone\",!0)}}if(null==this.heightModelInfo&&this.view.isHeightModelInfoRequired){this._debugLog(\"Starting search for height model info...\");const e=this._processMapCollections((e=>this._processHeightModelInfoSource(e)),(e=>h(e)));this._debugLog(`Search ended with status ${y(e)}`),this._set(\"isHeightModelInfoSearching\",0===e)}this._updateTileInfo()}}_processMapCollections(e,t){this._preloadMapCollections(t);let i=2;return this._forAllMapCollectionSources((e=>{if(2!==i)return!1;const{collectionName:t}=e;return this._debugLog(`Processing collection ${t}...`),!(e.loading&&!this._updateWhen(e.loading))||(this._debugLog(`Collection ${e.collectionName} owner is loading -> wait`),i=0,!1)}),(s=>{if(2!==i)return!1;return null!=t&&!t(s)?(this._debugLog(`Source ${s.id} is skipped due to predicate`),!1):!s.load||s.isFulfilled()||this._updateWhen(s.load())?!((!s.load||s.isResolved())&&e(s))||(i=1,!1):(this._debugLog(`Source ${s.id} is loading -> wait`),i=0,!1)})),i}_preloadMapCollections(e){let t=_;const i=this.logDebugInformation;this.logDebugInformation=!1,this._forAllMapCollectionSources((()=>!0),(s=>{if(0===t)return!1;return!(null!=e&&!e(s))&&(s.load&&!s.isFulfilled()&&(this.logDebugInformation=i,this._debugLog(`Pre-loading source ${s.id}`),this.logDebugInformation=!1,s.load().catch((()=>{})),t--),!0)})),this.logDebugInformation=i}_forAllMapCollectionSources(e,t){for(const i of this.mapCollectionPaths){const s=`map.${i}`,o=this._ensureLoadedOwnersFromCollectionName(s);if(!1===e(o))continue;const n=o.owner;if(!n||n.isRejected&&n.isRejected()){this._debugLog(`Collection ${s} owner is invalid or rejected -> skip`);continue}const a=this.view.get(s);a?this._forEachSource(a,t):this._debugLog(`Collection ${s} does not exist -> skip`)}}_forEachSource(e,t){for(const i of e.items)!1!==t(i)&&\"layers\"in i&&i.layers&&this._forEachSource(i.layers,t)}_processSpatialReferenceSource(e){let t=this._getSupportedSpatialReferences(e);return 0!==t.length&&(this._spatialReferenceCandidates?(t=i(t,this._spatialReferenceCandidates,((e,t)=>e.equals(t))),t.length>0?this._spatialReferenceCandidates=t:this._debugLog(`Layer ${e.id} is ignored because its supported spatial\\n          references are not compatible with the previous candidates`)):this._spatialReferenceCandidates=t,1===this._spatialReferenceCandidates.length)}_findExtent(e,t){const i=\"fullExtents\"in e&&e.fullExtents||(e.fullExtent?[e.fullExtent]:[]),s=i.find((e=>e.spatialReference.equals(t)));if(s)return this._set(\"extent\",s),!0;if(this._getSupportedSpatialReferences(e).length>0){const t=i.map((t=>({extent:t,layer:e}))),s=this._extentCandidates||[];this._extentCandidates=s.concat(t)}return!1}async _projectExtentCandidate(){if(!this._extentCandidates||!this._extentCandidates.length)return;const e=this.spatialReference,t=this._extentCandidates.find((t=>p(t.extent.spatialReference,e)));if(t)this._set(\"extent\",u(t.extent,e));else{const t=this._extentCandidates[0];this._extentProjectController=n();const i=await import(\"../../portal/support/geometryServiceUtils.js\");try{const s=await i.projectGeometry(t.extent,e,t.layer.portalItem,this._extentProjectController.signal);this._set(\"extent\",s)}catch{}this._extentProjectController=null}}_getSupportedSpatialReferences(e){const t=\"supportedSpatialReferences\"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===t.length)return this._debugLog(`Layer ${e.id} is ignored because it does not have any spatial references`),[];const i=t.filter((t=>this.view.isSpatialReferenceSupported(t,e,(e=>this._debugLog(e)))));return 0===i.length?this._debugLog(`Layer ${e.id} has spatial references but none of them are supported (or layer doesn't require locking)`):this._debugLog(`Layer ${e.id} has spatial references. Resulting candidate set: ${i.map(S).join(\", \")}`),i}_processHeightModelInfoSource(e){const t=c(e);return!!t&&(this._set(\"heightModelInfo\",t),this._set(\"isHeightModelInfoSearching\",!1),e.spatialReference&&(this._set(\"vcsWkid\",e.spatialReference.vcsWkid),this._set(\"latestVcsWkid\",e.spatialReference.latestVcsWkid)),!0)}_updateTileInfo(){if(null!=this.tileInfo)return;if(!this.view.isTileInfoRequired())return void this._set(\"isTileInfoDone\",!0);if(!this.isSpatialReferenceDone)return;const e=this.get(\"view.map\");if(!e)return void this._debugLog(\"updateTileInfo: no map\");const t=e.basemap,i=e.get(\"layers.0\");let s=null;if(t&&\"failed\"!==t.loadStatus){if(!t.loaded)return this._updateWhen(t.load()),void this._debugLog(\"updateTileInfo: basemap still loading\");const e=t&&t.get(\"baseLayers.0\");if(e&&\"failed\"!==e.loadStatus){if(!e.loaded)return this._updateWhen(e.load()),void this._debugLog(\"updateTileInfo: first basemap layer still loading\");s=\"tileInfo\"in e&&e.tileInfo}else{if(!i||\"failed\"===i.loadStatus)return this._debugLog(\"updateTileInfo: no tileInfo\"),void this._set(\"isTileInfoDone\",!0);if(!i.loaded)return this._updateWhen(i.load()),void this._debugLog(\"updateTileInfo: first operational layer still loading\");s=\"tileInfo\"in i&&i.tileInfo}}else if(i&&\"failed\"!==i.loadStatus){if(!i.loaded)return this._updateWhen(i.load()),void this._debugLog(\"updateTileInfo: first operational layer still loading\");s=\"tileInfo\"in i&&i.tileInfo}s&&!s.spatialReference.equals(this.spatialReference)&&(s=null),this._debugLog(`updateTileInfo: setting ${s}`),this._set(\"tileInfo\",s),this._set(\"isTileInfoDone\",!0)}_debugLog(e){this.logDebugInformation&&g.info(e)}};function S(e){return e?JSON.stringify(e.toJSON()):\"undefined\"}function y(e){switch(e){case 0:return\"Waiting\";case 1:return\"Found\";case 2:return\"Exhausted\"}}m.DefaultMapCollectionPaths=[\"basemap.baseLayers\",\"layers\",\"ground.layers\",\"basemap.referenceLayers\"],e([r()],m.prototype,\"logDebugInformation\",void 0),e([r({readOnly:!0})],m.prototype,\"isSpatialReferenceDone\",void 0),e([r({readOnly:!0})],m.prototype,\"isTileInfoDone\",void 0),e([r({readOnly:!0})],m.prototype,\"isHeightModelInfoSearching\",void 0),e([r({constructOnly:!0})],m.prototype,\"view\",void 0),e([r({readOnly:!0})],m.prototype,\"spatialReference\",void 0),e([r({readOnly:!0})],m.prototype,\"extent\",void 0),e([r({readOnly:!0})],m.prototype,\"heightModelInfo\",void 0),e([r({readOnly:!0})],m.prototype,\"vcsWkid\",void 0),e([r({readOnly:!0})],m.prototype,\"latestVcsWkid\",void 0),e([r()],m.prototype,\"mapCollectionPaths\",void 0),e([r()],m.prototype,\"defaultSpatialReference\",void 0),e([r({readOnly:!0})],m.prototype,\"tileInfo\",void 0),m=f=e([d(\"esri.views.support.DefaultsFromMap\")],m);var I=m;export default I;\n"]},"metadata":{},"sourceType":"module"}