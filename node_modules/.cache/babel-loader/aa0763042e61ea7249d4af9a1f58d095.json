{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../../request.js\";\nimport t from \"../../../../core/has.js\";\nimport s from \"../../../../core/ItemCache.js\";\nimport { isAbortError as r, eachAlways as i } from \"../../../../core/promiseUtils.js\";\nimport { open as o } from \"../../../../core/workers/workers.js\";\nimport a from \"./GlyphMosaic.js\";\nimport l from \"./GlyphSource.js\";\nimport n from \"./SpriteMosaic.js\";\nimport c from \"./TileIndex.js\";\nimport { perfAdd as h } from \"./decluttering/debugging.js\";\nimport u from \"../../tiling/TileKey.js\";\nconst p = new s(10),\n      y = new Map();\n\nclass f {\n  constructor(e, t, s) {\n    this._vectorTileLayer = e, this._styleRepository = t, this.devicePixelRatio = s, this._spriteMosaic = null, this._glyphMosaic = null, this._connection = null;\n  }\n\n  destroy() {\n    this._connection && (this._connection.close(), this._connection = null), this._styleRepository = null, this._vectorTileLayer = null, this._spriteMosaic && (this._spriteMosaic = null), this._glyphMosaic && (this._glyphMosaic = null);\n  }\n\n  get spriteMosaic() {\n    return this._spriteSourcePromise.then(() => this._spriteMosaic);\n  }\n\n  get glyphMosaic() {\n    return this._glyphMosaic;\n  }\n\n  async start(e) {\n    const s = this._vectorTileLayer,\n          r = s.sourceNameToSource,\n          i = [];\n\n    for (const t in r) i.push(this._fetchTileMap(r[t], e));\n\n    this._spriteSourcePromise = this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio, e), this._spriteSourcePromise.then(e => {\n      this._spriteMosaic = new n(1024, 1024, 250), this._spriteMosaic.setSpriteSource(e);\n    });\n    const c = this._styleRepository,\n          h = new l(c.glyphs);\n    return this._glyphMosaic = new a(1024, 1024, h), this._broadcastPromise = o(\"WorkerTileHandler\", {\n      client: this,\n      schedule: e.schedule,\n      signal: e.signal\n    }).then(r => (this._connection = r, Promise.all(this._connection.broadcast(\"setStyle\", {\n      style: s.currentStyleInfo.style,\n      vectorTileLayerMaxBuffers: t(\"vectortilelayer-max-buffers\")\n    }, e)))), Promise.all(i);\n  }\n\n  async updateStyle(e) {\n    return await this._broadcastPromise, this._broadcastPromise = new Promise((t, s) => {\n      Promise.all(this._connection.broadcast(\"updateStyle\", e)).then(t, s);\n    }), this._broadcastPromise;\n  }\n\n  async setStyle(e, s) {\n    await this._broadcastPromise, this._styleRepository = e;\n    const r = this._vectorTileLayer.sourceNameToSource,\n          i = [];\n\n    for (const t in r) i.push(this._fetchTileMap(r[t], null));\n\n    this._spriteSourcePromise = this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio, null), this._spriteSourcePromise.then(e => {\n      this._spriteMosaic = new n(1024, 1024, 250), this._spriteMosaic.setSpriteSource(e);\n    });\n    const o = new l(e.glyphs);\n    return this._glyphMosaic = new a(1024, 1024, o), this._broadcastPromise = new Promise((e, r) => {\n      Promise.all(this._connection.broadcast(\"setStyle\", {\n        style: s,\n        vectorTileLayerMaxBuffers: t(\"vectortilelayer-max-buffers\")\n      })).then(e, r);\n    }), i.push(this._broadcastPromise), Promise.all(i);\n  }\n\n  fetchTileData(e, t) {\n    return this._getRefKeys(e, t).then(e => {\n      const s = this._vectorTileLayer.sourceNameToSource,\n            r = [];\n\n      for (const t in s) r.push(t);\n\n      return this._getSourcesData(r, e, t);\n    });\n  }\n\n  parseTileData(e, t) {\n    const s = e && e.data;\n    if (!s) return Promise.resolve(null);\n    const {\n      sourceName2DataAndRefKey: r,\n      transferList: i\n    } = s;\n    return 0 === Object.keys(r).length ? Promise.resolve(null) : this._broadcastPromise.then(() => this._connection.getAvailableClient().then(s => s.invoke(\"createTileAndParse\", {\n      key: e.key.id,\n      sourceName2DataAndRefKey: r,\n      styleLayerUIDs: e.styleLayerUIDs\n    }, { ...t,\n      transferList: i\n    }).then(e => ({\n      tileData: e\n    }))));\n  }\n\n  async getSprites(e) {\n    return await this._spriteSourcePromise, this._spriteMosaic.getSpriteItems(e);\n  }\n\n  getGlyphs(e) {\n    return this._glyphMosaic.getGlyphItems(e.font, e.codePoints);\n  }\n\n  perfReport({\n    key: e,\n    milliseconds: t\n  }) {\n    h(e, t, \"ms\");\n  }\n\n  async _getTilePayload(e, t, s) {\n    const i = u.pool.acquire(e.id),\n          o = this._vectorTileLayer.sourceNameToSource[t].getSourceTileUrl(i.level, i.row, i.col);\n\n    u.pool.release(i);\n\n    try {\n      return {\n        protobuff: await this.request(o, s),\n        sourceName: t\n      };\n    } catch (a) {\n      if (r(a)) throw a;\n      return {\n        protobuff: null,\n        sourceName: t\n      };\n    }\n  }\n\n  request(t, s) {\n    return e(t, {\n      responseType: \"array-buffer\",\n      ...s\n    }).then(({\n      data: e\n    }) => e);\n  }\n\n  async _fetchTileMap(t, s) {\n    if (t.capabilities.operations.supportsTileMap && t.tileIndex) return Promise.resolve();\n    if (!t.tileMapURL) return;\n    const i = p.get(t.tileMapURL);\n    if (i) return void (t.tileIndex = i);\n    let o;\n\n    if (y.has(t.tileMapURL)) {\n      try {\n        o = await y.get(t.tileMapURL), t.tileIndex = new c(o.data);\n      } catch (l) {\n        if (r(l)) throw l;\n      }\n\n      return;\n    }\n\n    const a = e(t.tileMapURL, s);\n    y.set(t.tileMapURL, a);\n\n    try {\n      o = await a, y.delete(t.tileMapURL), p.put(t.tileMapURL, t.tileIndex), t.tileIndex = new c(o.data);\n    } catch (l) {\n      if (y.delete(t.tileMapURL), r(l)) throw l;\n    }\n  }\n\n  _getRefKeys(e, t) {\n    const s = this._vectorTileLayer.sourceNameToSource,\n          r = new Array();\n\n    for (const i in s) {\n      const o = s[i].getRefKey(e, t);\n      r.push(o);\n    }\n\n    return i(r);\n  }\n\n  _getSourcesData(e, t, s) {\n    const r = [];\n\n    for (let i = 0; i < t.length; i++) if (null == t[i].value || null == e[i]) r.push(null);else {\n      const o = this._getTilePayload(t[i].value, e[i], s);\n\n      r.push(o);\n    }\n\n    return i(r).then(e => {\n      const s = {},\n            r = [];\n\n      for (let i = 0; i < e.length; i++) if (e[i].value && e[i].value && e[i].value.protobuff && e[i].value.protobuff.byteLength > 0) {\n        const o = t[i].value.id;\n        s[e[i].value.sourceName] = {\n          refKey: o,\n          protobuff: e[i].value.protobuff\n        }, r.push(e[i].value.protobuff);\n      }\n\n      return {\n        sourceName2DataAndRefKey: s,\n        transferList: r\n      };\n    });\n  }\n\n}\n\nexport { f as TileHandler };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/2d/engine/vectorTiles/TileHandler.js"],"names":["e","t","s","isAbortError","r","eachAlways","i","open","o","a","l","n","c","perfAdd","h","u","p","y","Map","f","constructor","_vectorTileLayer","_styleRepository","devicePixelRatio","_spriteMosaic","_glyphMosaic","_connection","destroy","close","spriteMosaic","_spriteSourcePromise","then","glyphMosaic","start","sourceNameToSource","push","_fetchTileMap","loadSpriteSource","setSpriteSource","glyphs","_broadcastPromise","client","schedule","signal","Promise","all","broadcast","style","currentStyleInfo","vectorTileLayerMaxBuffers","updateStyle","setStyle","fetchTileData","_getRefKeys","_getSourcesData","parseTileData","data","resolve","sourceName2DataAndRefKey","transferList","Object","keys","length","getAvailableClient","invoke","key","id","styleLayerUIDs","tileData","getSprites","getSpriteItems","getGlyphs","getGlyphItems","font","codePoints","perfReport","milliseconds","_getTilePayload","pool","acquire","getSourceTileUrl","level","row","col","release","protobuff","request","sourceName","responseType","capabilities","operations","supportsTileMap","tileIndex","tileMapURL","get","has","set","delete","put","Array","getRefKey","value","byteLength","refKey","TileHandler"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../../request.js\";import t from\"../../../../core/has.js\";import s from\"../../../../core/ItemCache.js\";import{isAbortError as r,eachAlways as i}from\"../../../../core/promiseUtils.js\";import{open as o}from\"../../../../core/workers/workers.js\";import a from\"./GlyphMosaic.js\";import l from\"./GlyphSource.js\";import n from\"./SpriteMosaic.js\";import c from\"./TileIndex.js\";import{perfAdd as h}from\"./decluttering/debugging.js\";import u from\"../../tiling/TileKey.js\";const p=new s(10),y=new Map;class f{constructor(e,t,s){this._vectorTileLayer=e,this._styleRepository=t,this.devicePixelRatio=s,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null}destroy(){this._connection&&(this._connection.close(),this._connection=null),this._styleRepository=null,this._vectorTileLayer=null,this._spriteMosaic&&(this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic=null)}get spriteMosaic(){return this._spriteSourcePromise.then((()=>this._spriteMosaic))}get glyphMosaic(){return this._glyphMosaic}async start(e){const s=this._vectorTileLayer,r=s.sourceNameToSource,i=[];for(const t in r)i.push(this._fetchTileMap(r[t],e));this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,e),this._spriteSourcePromise.then((e=>{this._spriteMosaic=new n(1024,1024,250),this._spriteMosaic.setSpriteSource(e)}));const c=this._styleRepository,h=new l(c.glyphs);return this._glyphMosaic=new a(1024,1024,h),this._broadcastPromise=o(\"WorkerTileHandler\",{client:this,schedule:e.schedule,signal:e.signal}).then((r=>(this._connection=r,Promise.all(this._connection.broadcast(\"setStyle\",{style:s.currentStyleInfo.style,vectorTileLayerMaxBuffers:t(\"vectortilelayer-max-buffers\")},e))))),Promise.all(i)}async updateStyle(e){return await this._broadcastPromise,this._broadcastPromise=new Promise(((t,s)=>{Promise.all(this._connection.broadcast(\"updateStyle\",e)).then(t,s)})),this._broadcastPromise}async setStyle(e,s){await this._broadcastPromise,this._styleRepository=e;const r=this._vectorTileLayer.sourceNameToSource,i=[];for(const t in r)i.push(this._fetchTileMap(r[t],null));this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,null),this._spriteSourcePromise.then((e=>{this._spriteMosaic=new n(1024,1024,250),this._spriteMosaic.setSpriteSource(e)}));const o=new l(e.glyphs);return this._glyphMosaic=new a(1024,1024,o),this._broadcastPromise=new Promise(((e,r)=>{Promise.all(this._connection.broadcast(\"setStyle\",{style:s,vectorTileLayerMaxBuffers:t(\"vectortilelayer-max-buffers\")})).then(e,r)})),i.push(this._broadcastPromise),Promise.all(i)}fetchTileData(e,t){return this._getRefKeys(e,t).then((e=>{const s=this._vectorTileLayer.sourceNameToSource,r=[];for(const t in s)r.push(t);return this._getSourcesData(r,e,t)}))}parseTileData(e,t){const s=e&&e.data;if(!s)return Promise.resolve(null);const{sourceName2DataAndRefKey:r,transferList:i}=s;return 0===Object.keys(r).length?Promise.resolve(null):this._broadcastPromise.then((()=>this._connection.getAvailableClient().then((s=>s.invoke(\"createTileAndParse\",{key:e.key.id,sourceName2DataAndRefKey:r,styleLayerUIDs:e.styleLayerUIDs},{...t,transferList:i}).then((e=>({tileData:e})))))))}async getSprites(e){return await this._spriteSourcePromise,this._spriteMosaic.getSpriteItems(e)}getGlyphs(e){return this._glyphMosaic.getGlyphItems(e.font,e.codePoints)}perfReport({key:e,milliseconds:t}){h(e,t,\"ms\")}async _getTilePayload(e,t,s){const i=u.pool.acquire(e.id),o=this._vectorTileLayer.sourceNameToSource[t].getSourceTileUrl(i.level,i.row,i.col);u.pool.release(i);try{return{protobuff:await this.request(o,s),sourceName:t}}catch(a){if(r(a))throw a;return{protobuff:null,sourceName:t}}}request(t,s){return e(t,{responseType:\"array-buffer\",...s}).then((({data:e})=>e))}async _fetchTileMap(t,s){if(t.capabilities.operations.supportsTileMap&&t.tileIndex)return Promise.resolve();if(!t.tileMapURL)return;const i=p.get(t.tileMapURL);if(i)return void(t.tileIndex=i);let o;if(y.has(t.tileMapURL)){try{o=await y.get(t.tileMapURL),t.tileIndex=new c(o.data)}catch(l){if(r(l))throw l}return}const a=e(t.tileMapURL,s);y.set(t.tileMapURL,a);try{o=await a,y.delete(t.tileMapURL),p.put(t.tileMapURL,t.tileIndex),t.tileIndex=new c(o.data)}catch(l){if(y.delete(t.tileMapURL),r(l))throw l}}_getRefKeys(e,t){const s=this._vectorTileLayer.sourceNameToSource,r=new Array;for(const i in s){const o=s[i].getRefKey(e,t);r.push(o)}return i(r)}_getSourcesData(e,t,s){const r=[];for(let i=0;i<t.length;i++)if(null==t[i].value||null==e[i])r.push(null);else{const o=this._getTilePayload(t[i].value,e[i],s);r.push(o)}return i(r).then((e=>{const s={},r=[];for(let i=0;i<e.length;i++)if(e[i].value&&e[i].value&&e[i].value.protobuff&&e[i].value.protobuff.byteLength>0){const o=t[i].value.id;s[e[i].value.sourceName]={refKey:o,protobuff:e[i].value.protobuff},r.push(e[i].value.protobuff)}return{sourceName2DataAndRefKey:s,transferList:r}}))}}export{f as TileHandler};\n"]},"metadata":{},"sourceType":"module"}