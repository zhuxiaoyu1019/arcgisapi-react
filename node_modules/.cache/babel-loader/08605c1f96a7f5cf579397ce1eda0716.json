{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { createScreenPointArray as e, createRenderScreenPointArray3 as t } from \"../../../../core/screenUtils.js\";\nimport { a as i, b as s } from \"../../../../chunks/vec3.js\";\nimport { c as r } from \"../../../../chunks/vec3f64.js\";\nimport { create as o, fromValues as n, distance as a, empty as c, expandPointInPlace as l, expand as h, intersection as m } from \"../../../../geometry/support/aaBoundingRect.js\";\nimport { signedDistance as u, normal as p } from \"../../../../geometry/support/plane.js\";\nimport { areaPoints2d as d } from \"../../../../geometry/support/triangle.js\";\nimport { FeatureTileVisibility3D as f } from \"./FeatureTileVisibility3D.js\";\nimport S from \"../../webgl-engine/lib/Camera.js\";\n\nclass j {\n  constructor(e) {\n    this.camera = new S(), this.focusOnMap = [0, 0], this.screenRect = o(), this.tileSize = e.tileSize, this.renderCoordsHelper = e.renderCoordsHelper, this.tilingScheme = e.tilingScheme, this.visibility = new f(e.renderCoordsHelper);\n  }\n\n  begin(e, t, i) {\n    this.camera.copyFrom(e), this.surfaceElevation = i, this.focusOnMap[0] = t.x, this.focusOnMap[1] = t.y, n(0, 0, e.fullWidth, e.fullHeight, this.screenRect), this.visibility.begin(this.camera, i);\n  }\n\n  end() {\n    this.visibility.end();\n  }\n\n  updateTile(e) {\n    e.measures.visibility = this.visibility.calculate(e), e.measures.distance = a(e.extent, this.focusOnMap), 0 !== e.measures.visibility && this.updateScreenMeasure(e);\n  }\n\n  updateScreenMeasure(e) {\n    const t = y,\n          i = 1 << t,\n          s = e.measures.screenRect;\n    c(s);\n    let r = 0;\n    const o = e.lij[0] + t,\n          n = e.lij[1] << t,\n          a = e.lij[2] << t,\n          l = this.tileSizeWithBias(e),\n          h = l * l;\n\n    for (let c = 0; c < i; c++) for (let t = 0; t < i; t++) if (r += this.computeScreenArea(e, o, n + c, a + t, s), r > h) return void (e.measures.shouldSplit = !0);\n\n    e.measures.shouldSplit = !1;\n  }\n\n  tileSizeWithBias(e) {\n    return 1 === e.measures.visibility ? this.tileSize * v : this.tileSize;\n  }\n\n  computeScreenArea(e, t, i, s, r) {\n    const o = 1 === e.measures.visibility;\n    this.projectToScreen(t, i, s, o, R), c(g);\n\n    for (let n = 0; n < 4; n++) l(g, R[n]);\n\n    return h(r, g), m(g, this.screenRect, b), d(R[0], R[1], R[2]) + d(R[0], R[2], R[3]);\n  }\n\n  projectToScreen(e, t, i, s, r) {\n    this.tilingScheme.ensureMaxLod(e), this.tilingScheme.getExtent(e, t, i, C), this.toRenderCoords(C, 0, 3, M[0]), this.toRenderCoords(C, 2, 3, M[1]), this.toRenderCoords(C, 2, 1, M[2]), this.toRenderCoords(C, 0, 1, M[3]), s && (this.projectToPlane(M, this.camera.frustum[4]), this.projectToPlane(M, this.camera.frustum[3]), this.projectToPlane(M, this.camera.frustum[2]));\n\n    for (let o = 0; o < 4; o++) this.camera.projectToRenderScreen(M[o], z), this.camera.renderToScreen(z, r[o]);\n  }\n\n  projectToPlane(e, t) {\n    for (let i = 0; i < 4; i++) x[i] = u(t, e[i]);\n\n    const r = Math.max(x[0], x[1], x[2], x[3]);\n\n    if (r > 0) {\n      const o = i(T, p(t), -r);\n\n      for (let t = 0; t < 4; t++) s(e[t], e[t], o);\n    }\n  }\n\n  toRenderCoords(e, t, i, s) {\n    return T[0] = e[t], T[1] = e[i], T[2] = this.surfaceElevation, this.renderCoordsHelper.toRenderCoords(T, this.tilingScheme.spatialReference, s), s;\n  }\n\n}\n\nconst g = o(),\n      b = o(),\n      y = 2,\n      v = 5,\n      R = [e(), e(), e(), e()],\n      C = o(),\n      T = r(),\n      M = [r(), r(), r(), r()],\n      x = [0, 0, 0, 0],\n      z = t();\nexport default j;\nexport { j as FeatureTileMeasurements3D };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/layers/support/FeatureTileMeasurements3D.js"],"names":["createScreenPointArray","e","createRenderScreenPointArray3","t","a","i","b","s","c","r","create","o","fromValues","n","distance","empty","expandPointInPlace","l","expand","h","intersection","m","signedDistance","u","normal","p","areaPoints2d","d","FeatureTileVisibility3D","f","S","j","constructor","camera","focusOnMap","screenRect","tileSize","renderCoordsHelper","tilingScheme","visibility","begin","copyFrom","surfaceElevation","x","y","fullWidth","fullHeight","end","updateTile","measures","calculate","extent","updateScreenMeasure","lij","tileSizeWithBias","computeScreenArea","shouldSplit","v","projectToScreen","R","g","ensureMaxLod","getExtent","C","toRenderCoords","M","projectToPlane","frustum","projectToRenderScreen","z","renderToScreen","Math","max","T","spatialReference","FeatureTileMeasurements3D"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{createScreenPointArray as e,createRenderScreenPointArray3 as t}from\"../../../../core/screenUtils.js\";import{a as i,b as s}from\"../../../../chunks/vec3.js\";import{c as r}from\"../../../../chunks/vec3f64.js\";import{create as o,fromValues as n,distance as a,empty as c,expandPointInPlace as l,expand as h,intersection as m}from\"../../../../geometry/support/aaBoundingRect.js\";import{signedDistance as u,normal as p}from\"../../../../geometry/support/plane.js\";import{areaPoints2d as d}from\"../../../../geometry/support/triangle.js\";import{FeatureTileVisibility3D as f}from\"./FeatureTileVisibility3D.js\";import S from\"../../webgl-engine/lib/Camera.js\";class j{constructor(e){this.camera=new S,this.focusOnMap=[0,0],this.screenRect=o(),this.tileSize=e.tileSize,this.renderCoordsHelper=e.renderCoordsHelper,this.tilingScheme=e.tilingScheme,this.visibility=new f(e.renderCoordsHelper)}begin(e,t,i){this.camera.copyFrom(e),this.surfaceElevation=i,this.focusOnMap[0]=t.x,this.focusOnMap[1]=t.y,n(0,0,e.fullWidth,e.fullHeight,this.screenRect),this.visibility.begin(this.camera,i)}end(){this.visibility.end()}updateTile(e){e.measures.visibility=this.visibility.calculate(e),e.measures.distance=a(e.extent,this.focusOnMap),0!==e.measures.visibility&&this.updateScreenMeasure(e)}updateScreenMeasure(e){const t=y,i=1<<t,s=e.measures.screenRect;c(s);let r=0;const o=e.lij[0]+t,n=e.lij[1]<<t,a=e.lij[2]<<t,l=this.tileSizeWithBias(e),h=l*l;for(let c=0;c<i;c++)for(let t=0;t<i;t++)if(r+=this.computeScreenArea(e,o,n+c,a+t,s),r>h)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}tileSizeWithBias(e){return 1===e.measures.visibility?this.tileSize*v:this.tileSize}computeScreenArea(e,t,i,s,r){const o=1===e.measures.visibility;this.projectToScreen(t,i,s,o,R),c(g);for(let n=0;n<4;n++)l(g,R[n]);return h(r,g),m(g,this.screenRect,b),d(R[0],R[1],R[2])+d(R[0],R[2],R[3])}projectToScreen(e,t,i,s,r){this.tilingScheme.ensureMaxLod(e),this.tilingScheme.getExtent(e,t,i,C),this.toRenderCoords(C,0,3,M[0]),this.toRenderCoords(C,2,3,M[1]),this.toRenderCoords(C,2,1,M[2]),this.toRenderCoords(C,0,1,M[3]),s&&(this.projectToPlane(M,this.camera.frustum[4]),this.projectToPlane(M,this.camera.frustum[3]),this.projectToPlane(M,this.camera.frustum[2]));for(let o=0;o<4;o++)this.camera.projectToRenderScreen(M[o],z),this.camera.renderToScreen(z,r[o])}projectToPlane(e,t){for(let i=0;i<4;i++)x[i]=u(t,e[i]);const r=Math.max(x[0],x[1],x[2],x[3]);if(r>0){const o=i(T,p(t),-r);for(let t=0;t<4;t++)s(e[t],e[t],o)}}toRenderCoords(e,t,i,s){return T[0]=e[t],T[1]=e[i],T[2]=this.surfaceElevation,this.renderCoordsHelper.toRenderCoords(T,this.tilingScheme.spatialReference,s),s}}const g=o(),b=o(),y=2,v=5,R=[e(),e(),e(),e()],C=o(),T=r(),M=[r(),r(),r(),r()],x=[0,0,0,0],z=t();export default j;export{j as FeatureTileMeasurements3D};\n"]},"metadata":{},"sourceType":"module"}