{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isSome as e, isNone as t } from \"../../../../../core/maybe.js\";\n\nclass r {\n  constructor(e) {\n    this.technique = e, this.refCount = 0, this.refZeroFrame = 0;\n  }\n\n}\n\nclass s {\n  constructor(e) {\n    this._context = e, this._perConstructorInstances = new Map(), this._frameCounter = 0, this._keepAliveFrameCount = 1200;\n  }\n\n  get viewingMode() {\n    return this._context.viewingMode;\n  }\n\n  get constructionContext() {\n    return this._context;\n  }\n\n  dispose() {\n    this._perConstructorInstances.forEach(e => e.forEach(e => e.technique.dispose())), this._perConstructorInstances.clear();\n  }\n\n  acquire(e, t) {\n    const s = t.key;\n\n    let n = this._perConstructorInstances.get(e);\n\n    n || (n = new Map(), this._perConstructorInstances.set(e, n));\n    let o = n.get(s);\n\n    if (void 0 === o) {\n      const c = new e(this._context, t, () => this.release(c));\n      o = new r(c), n.set(s, o);\n    }\n\n    return ++o.refCount, o.technique;\n  }\n\n  releaseAndAcquire(t, r, s) {\n    if (e(s)) {\n      if (r.key === s.key) return s;\n      s.release();\n    }\n\n    return this.acquire(t, r);\n  }\n\n  release(e) {\n    if (t(e)) return;\n\n    const r = this._perConstructorInstances.get(e.constructor).get(e.key);\n\n    --r.refCount, 0 === r.refCount && (r.refZeroFrame = this._frameCounter);\n  }\n\n  frameUpdate() {\n    this._frameCounter++, this._perConstructorInstances.forEach((e, t) => {\n      e.forEach((t, r) => {\n        0 === t.refCount && t.refZeroFrame + this._keepAliveFrameCount < this._frameCounter && (t.technique.dispose(), e.delete(r));\n      }), 0 === e.size && this._perConstructorInstances.delete(t);\n    });\n  }\n\n  async hotReload() {\n    const e = new Array();\n    this._perConstructorInstances.forEach((t, r) => {\n      const s = async (e, t) => {\n        const r = t.shader;\n        r && (await r.reload(), e.forEach(e => {\n          e.technique.reload(this._context);\n        }));\n      };\n\n      e.push(s(t, r));\n    }), await Promise.all(e);\n  }\n\n}\n\nexport { s as ShaderTechniqueRepository };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/webgl-engine/core/shaderTechnique/ShaderTechniqueRepository.js"],"names":["isSome","e","isNone","t","r","constructor","technique","refCount","refZeroFrame","s","_context","_perConstructorInstances","Map","_frameCounter","_keepAliveFrameCount","viewingMode","constructionContext","dispose","forEach","clear","acquire","key","n","get","set","o","c","release","releaseAndAcquire","frameUpdate","delete","size","hotReload","Array","shader","reload","push","Promise","all","ShaderTechniqueRepository"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isSome as e,isNone as t}from\"../../../../../core/maybe.js\";class r{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}class s{constructor(e){this._context=e,this._perConstructorInstances=new Map,this._frameCounter=0,this._keepAliveFrameCount=1200}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}dispose(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.dispose())))),this._perConstructorInstances.clear()}acquire(e,t){const s=t.key;let n=this._perConstructorInstances.get(e);n||(n=new Map,this._perConstructorInstances.set(e,n));let o=n.get(s);if(void 0===o){const c=new e(this._context,t,(()=>this.release(c)));o=new r(c),n.set(s,o)}return++o.refCount,o.technique}releaseAndAcquire(t,r,s){if(e(s)){if(r.key===s.key)return s;s.release()}return this.acquire(t,r)}release(e){if(t(e))return;const r=this._perConstructorInstances.get(e.constructor).get(e.key);--r.refCount,0===r.refCount&&(r.refZeroFrame=this._frameCounter)}frameUpdate(){this._frameCounter++,this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((t,r)=>{0===t.refCount&&t.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(t.technique.dispose(),e.delete(r))})),0===e.size&&this._perConstructorInstances.delete(t)}))}async hotReload(){const e=new Array;this._perConstructorInstances.forEach(((t,r)=>{const s=async(e,t)=>{const r=t.shader;r&&(await r.reload(),e.forEach((e=>{e.technique.reload(this._context)})))};e.push(s(t,r))})),await Promise.all(e)}}export{s as ShaderTechniqueRepository};\n"]},"metadata":{},"sourceType":"module"}