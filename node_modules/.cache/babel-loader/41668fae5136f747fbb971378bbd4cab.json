{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../Graphic.js\";\nimport t from \"../support/FeatureSet.js\";\nimport r from \"../support/IdSet.js\";\nimport { defaultMaxRecords as i, IdState as s } from \"../support/shared.js\";\nimport { create as a, all as n, resolve as l, reject as d } from \"../../../core/promiseUtils.js\";\nimport o from \"../../../rest/support/RelationshipQuery.js\";\n\nclass u extends t {\n  constructor(e) {\n    super(e), this.declaredClass = \"esri.arcade.featureset.sources.FeatureLayerRelated\", this._findObjectId = -1, this._requestStandardised = !1, this._removeGeometry = !1, this._overrideFields = null, this.featureObjectId = null, this.relatedLayer = null, this.relationship = null, e.spatialReference && (this.spatialReference = e.spatialReference), this._transparent = !0, this._maxProcessing = 1e3, this._layer = e.layer, this._wset = null, this._findObjectId = e.objectId, this.featureObjectId = e.objectId, this.relationship = e.relationship, this.relatedLayer = e.relatedLayer, void 0 !== e.outFields && (this._overrideFields = e.outFields), void 0 !== e.includeGeometry && (this._removeGeometry = !1 === e.includeGeometry);\n  }\n\n  _maxQueryRate() {\n    return i;\n  }\n\n  end() {\n    return this._layer;\n  }\n\n  optimisePagingFeatureQueries() {}\n\n  load() {\n    return null === this._loadPromise && (this._loadPromise = a((e, t) => {\n      n([this._layer.load(), this.relatedLayer.load()]).then(() => {\n        this._initialiseFeatureSet(), e(this);\n      }, t);\n    })), this._loadPromise;\n  }\n\n  nativeCapabilities() {\n    return this.relatedLayer.nativeCapabilities();\n  }\n\n  _initialiseFeatureSet() {\n    if (null == this.spatialReference && (this.spatialReference = this._layer.spatialReference), this.geometryType = this.relatedLayer.geometryType, this.fields = this.relatedLayer.fields.slice(0), null !== this._overrideFields) if (1 === this._overrideFields.length && \"*\" === this._overrideFields[0]) this._overrideFields = null;else {\n      const e = [],\n            t = [];\n\n      for (const r of this.fields) if (\"oid\" === r.type) e.push(r), t.push(r.name);else for (const i of this._overrideFields) if (i.toLowerCase() === r.name.toLowerCase()) {\n        e.push(r), t.push(r.name);\n        break;\n      }\n\n      this.fields = e, this._overrideFields = t;\n    }\n\n    const e = this._layer.nativeCapabilities();\n\n    e && (this._databaseType = e.databaseType, this._requestStandardised = e.requestStandardised), this.objectIdField = this.relatedLayer.objectIdField, this.globalIdField = this.relatedLayer.globalIdField, this.hasM = this.relatedLayer.supportsM, this.hasZ = this.relatedLayer.supportsZ, this.typeIdField = this.relatedLayer.typeIdField, this.types = this.relatedLayer.types;\n  }\n\n  databaseType() {\n    return this.relatedLayer.databaseType().then(() => (this._databaseType = this.relatedLayer._databaseType, this._databaseType));\n  }\n\n  isTable() {\n    return this.relatedLayer.isTable();\n  }\n\n  _isInFeatureSet() {\n    return s.InFeatureSet;\n  }\n\n  _candidateIdTransform(e) {\n    return e;\n  }\n\n  _getSet(e) {\n    return null === this._wset ? this._ensureLoaded().then(() => this._getFilteredSet(\"\", null, null, null, e)).then(e => (this._wset = e, e)) : l(this._wset);\n  }\n\n  _changeFeature(t) {\n    const r = {};\n\n    for (const e of this.fields) r[e.name] = t.attributes[e.name];\n\n    return new e({\n      geometry: !0 === this._removeGeometry ? null : t.geometry,\n      attributes: r\n    });\n  }\n\n  _getFilteredSet(e, t, i, s, a) {\n    return this.databaseType().then(() => {\n      if (this.isTable() && t && null !== e && \"\" !== e) {\n        return new r([], [], !0, null);\n      }\n\n      const n = this._layer.nativeCapabilities();\n\n      if (!1 === n.canQueryRelated) {\n        return new r([], [], !0, null);\n      }\n\n      if (n.capabilities.queryRelated && n.capabilities.queryRelated.supportsPagination) return this._getFilteredSetUsingPaging(e, t, i, s, a);\n      let l = \"\",\n          d = !1;\n      null !== s && n.capabilities && n.capabilities.queryRelated && !0 === n.capabilities.queryRelated.supportsOrderBy && (l = s.constructClause(), d = !0);\n      const u = new o();\n      u.objectIds = [this._findObjectId];\n      const h = null !== this._overrideFields ? this._overrideFields : this._fieldsIncludingObjectId(this.relatedLayer.fields ? this.relatedLayer.fields.map(e => e.name) : [\"*\"]);\n      u.outFields = h, u.relationshipId = this.relationship.id, u.where = \"1=1\";\n      let c = !0;\n      return !0 === this._removeGeometry && (c = !1), u.returnGeometry = c, this._requestStandardised && (u.sqlFormat = \"standard\"), u.outSpatialReference = this.spatialReference, u.orderByFields = \"\" !== l ? l.split(\",\") : null, n.source.queryRelatedFeatures(u).then(s => {\n        this._checkCancelled(a);\n\n        const n = s[this._findObjectId] ? s[this._findObjectId].features : [],\n              l = [];\n\n        for (let e = 0; e < n.length; e++) this._featureCache[n[e].attributes[this._layer.objectIdField]] = n[e], l.push(n[e].attributes[this._layer.objectIdField]);\n\n        const o = t && null !== e && \"\" !== e,\n              u = null != i;\n        return new r(o || u ? l : [], o || u ? [] : l, d, null);\n      });\n    });\n  }\n\n  _fieldsIncludingObjectId(e) {\n    if (null === e) return [this.objectIdField];\n    const t = e.slice(0);\n    if (t.indexOf(\"*\") > -1) return t;\n    let r = !1;\n\n    for (const i of t) if (i.toUpperCase() === this.objectIdField.toUpperCase()) {\n      r = !0;\n      break;\n    }\n\n    return !1 === r && t.push(this.objectIdField), t;\n  }\n\n  _getFilteredSetUsingPaging(e, t, i, s, a) {\n    try {\n      let n = \"\",\n          l = !1;\n\n      const d = this._layer.nativeCapabilities();\n\n      return null !== s && d && d.capabilities.queryRelated && !0 === d.capabilities.queryRelated.supportsOrderBy && (n = s.constructClause(), l = !0), this.databaseType().then(() => {\n        const s = \"1=1\";\n\n        let o = this._maxQueryRate();\n\n        const u = d.capabilities.query.maxRecordCount;\n        void 0 !== u && u < o && (o = u);\n        const h = t && null !== e && \"\" !== e,\n              c = null != i;\n        let p = null,\n            y = !0;\n        !0 === this._removeGeometry && (y = !1);\n        const f = null !== this._overrideFields ? this._overrideFields : this._fieldsIncludingObjectId(this.relatedLayer.fields ? this.relatedLayer.fields.map(e => e.name) : [\"*\"]);\n        return p = new r(h || c ? [\"GETPAGES\"] : [], h || c ? [] : [\"GETPAGES\"], l, {\n          outFields: f.join(\",\"),\n          resultRecordCount: o,\n          resultOffset: 0,\n          objectIds: [this._findObjectId],\n          where: s,\n          orderByFields: n,\n          returnGeometry: y,\n          returnIdsOnly: \"false\",\n          internal: {\n            set: [],\n            lastRetrieved: 0,\n            lastPage: 0,\n            fullyResolved: !1\n          }\n        }), this._expandPagedSet(p, o, 0, 0, a).then(() => p);\n      });\n    } catch (n) {\n      return d(n);\n    }\n  }\n\n  _expandPagedSet(e, t, r, i, s) {\n    return this._expandPagedSetFeatureSet(e, t, r, i, s);\n  }\n\n  _clonePageDefinition(e) {\n    return null === e ? null : !0 !== e.groupbypage ? {\n      groupbypage: !1,\n      outFields: e.outFields,\n      resultRecordCount: e.resultRecordCount,\n      resultOffset: e.resultOffset,\n      where: e.where,\n      objectIds: e.objectIds,\n      orderByFields: e.orderByFields,\n      returnGeometry: e.returnGeometry,\n      returnIdsOnly: e.returnIdsOnly,\n      internal: e.internal\n    } : {\n      groupbypage: !0,\n      outFields: e.outFields,\n      resultRecordCount: e.resultRecordCount,\n      useOIDpagination: e.useOIDpagination,\n      generatedOid: e.generatedOid,\n      groupByFieldsForStatistics: e.groupByFieldsForStatistics,\n      resultOffset: e.resultOffset,\n      outStatistics: e.outStatistics,\n      geometry: e.geometry,\n      where: e.where,\n      objectIds: e.objectIds,\n      orderByFields: e.orderByFields,\n      returnGeometry: e.returnGeometry,\n      returnIdsOnly: e.returnIdsOnly,\n      internal: e.internal\n    };\n  }\n\n  _getPhysicalPage(e, t, r) {\n    try {\n      const t = e.pagesDefinition.internal.lastRetrieved,\n            i = t,\n            s = e.pagesDefinition.internal.lastPage,\n            a = this._layer.nativeCapabilities(),\n            n = new o();\n\n      return !0 === this._requestStandardised && (n.sqlFormat = \"standard\"), n.relationshipId = this.relationship.id, n.objectIds = e.pagesDefinition.objectIds, n.resultOffset = e.pagesDefinition.internal.lastPage, n.resultRecordCount = e.pagesDefinition.resultRecordCount, n.outFields = e.pagesDefinition.outFields.split(\",\"), n.where = e.pagesDefinition.where, n.orderByFields = \"\" !== e.pagesDefinition.orderByFields ? e.pagesDefinition.orderByFields.split(\",\") : null, n.returnGeometry = e.pagesDefinition.returnGeometry, n.outSpatialReference = this.spatialReference, a.source.queryRelatedFeatures(n).then(a => {\n        if (this._checkCancelled(r), e.pagesDefinition.internal.lastPage !== s) return 0;\n        const n = a[this._findObjectId] ? a[this._findObjectId].features : [];\n\n        for (let t = 0; t < n.length; t++) e.pagesDefinition.internal.set[i + t] = n[t].attributes[this._layer.objectIdField];\n\n        for (let e = 0; e < n.length; e++) this._featureCache[n[e].attributes[this._layer.objectIdField]] = n[e];\n\n        const l = !a[this._findObjectId] || !1 === a[this._findObjectId].exceededTransferLimit;\n        return n.length !== e.pagesDefinition.resultRecordCount && l && (e.pagesDefinition.internal.fullyResolved = !0), e.pagesDefinition.internal.lastRetrieved = t + n.length, e.pagesDefinition.internal.lastPage += e.pagesDefinition.resultRecordCount, n.length;\n      });\n    } catch (i) {\n      return d(i);\n    }\n  }\n\n  _getFeatures(e, t, r, i) {\n    const s = [];\n    -1 !== t && void 0 === this._featureCache[t] && s.push(t);\n\n    const a = this._maxQueryRate();\n\n    if (!0 === this._checkIfNeedToExpandKnownPage(e, a)) return this._expandPagedSet(e, a, 0, 0, i).then(() => this._getFeatures(e, t, r, i));\n    let n = 0;\n\n    for (let l = e._lastFetchedIndex; l < e._known.length && (n++, n <= r && (e._lastFetchedIndex += 1), !(\"GETPAGES\" !== e._known[l] && void 0 === this._featureCache[e._known[l]] && (e._known[l] !== t && s.push(e._known[l]), s.length > r))) && !(n >= r && 0 === s.length); l++);\n\n    return 0 === s.length ? l(\"success\") : d(new Error(\"Unaccounted for Features. Not in Feature Collection\"));\n  }\n\n  _refineSetBlock(e, t, r) {\n    return l(e);\n  }\n\n  _stat(e, t, r, i, s, a, n) {\n    return l({\n      calculated: !1\n    });\n  }\n\n  get gdbVersion() {\n    return this.relatedLayer.gdbVersion;\n  }\n\n  _canDoAggregates(e, t, r, i, s) {\n    return l(!1);\n  }\n\n  relationshipMetaData() {\n    return this.relatedLayer.relationshipMetaData();\n  }\n\n  serviceUrl() {\n    return this.relatedLayer.serviceUrl();\n  }\n\n  queryAttachments(e, t, r, i) {\n    return this.relatedLayer.queryAttachments(e, t, r, i);\n  }\n\n  getFeatureByObjectId(e, t) {\n    return this.relatedLayer.getFeatureByObjectId(e, t);\n  }\n\n  getOwningSystemUrl() {\n    return this.relatedLayer.getOwningSystemUrl();\n  }\n\n  getIdentityUser() {\n    return this.relatedLayer.getIdentityUser();\n  }\n\n}\n\nexport default u;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/arcade/featureset/sources/FeatureLayerRelated.js"],"names":["e","t","r","defaultMaxRecords","i","IdState","s","create","a","all","n","resolve","l","reject","d","o","u","constructor","declaredClass","_findObjectId","_requestStandardised","_removeGeometry","_overrideFields","featureObjectId","relatedLayer","relationship","spatialReference","_transparent","_maxProcessing","_layer","layer","_wset","objectId","outFields","includeGeometry","_maxQueryRate","end","optimisePagingFeatureQueries","load","_loadPromise","then","_initialiseFeatureSet","nativeCapabilities","geometryType","fields","slice","length","type","push","name","toLowerCase","_databaseType","databaseType","requestStandardised","objectIdField","globalIdField","hasM","supportsM","hasZ","supportsZ","typeIdField","types","isTable","_isInFeatureSet","InFeatureSet","_candidateIdTransform","_getSet","_ensureLoaded","_getFilteredSet","_changeFeature","attributes","geometry","canQueryRelated","capabilities","queryRelated","supportsPagination","_getFilteredSetUsingPaging","supportsOrderBy","constructClause","objectIds","h","_fieldsIncludingObjectId","map","relationshipId","id","where","c","returnGeometry","sqlFormat","outSpatialReference","orderByFields","split","source","queryRelatedFeatures","_checkCancelled","features","_featureCache","indexOf","toUpperCase","query","maxRecordCount","p","y","f","join","resultRecordCount","resultOffset","returnIdsOnly","internal","set","lastRetrieved","lastPage","fullyResolved","_expandPagedSet","_expandPagedSetFeatureSet","_clonePageDefinition","groupbypage","useOIDpagination","generatedOid","groupByFieldsForStatistics","outStatistics","_getPhysicalPage","pagesDefinition","exceededTransferLimit","_getFeatures","_checkIfNeedToExpandKnownPage","_lastFetchedIndex","_known","Error","_refineSetBlock","_stat","calculated","gdbVersion","_canDoAggregates","relationshipMetaData","serviceUrl","queryAttachments","getFeatureByObjectId","getOwningSystemUrl","getIdentityUser"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../Graphic.js\";import t from\"../support/FeatureSet.js\";import r from\"../support/IdSet.js\";import{defaultMaxRecords as i,IdState as s}from\"../support/shared.js\";import{create as a,all as n,resolve as l,reject as d}from\"../../../core/promiseUtils.js\";import o from\"../../../rest/support/RelationshipQuery.js\";class u extends t{constructor(e){super(e),this.declaredClass=\"esri.arcade.featureset.sources.FeatureLayerRelated\",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,this.relatedLayer=null,this.relationship=null,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,this._findObjectId=e.objectId,this.featureObjectId=e.objectId,this.relationship=e.relationship,this.relatedLayer=e.relatedLayer,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return i}end(){return this._layer}optimisePagingFeatureQueries(){}load(){return null===this._loadPromise&&(this._loadPromise=a(((e,t)=>{n([this._layer.load(),this.relatedLayer.load()]).then((()=>{this._initialiseFeatureSet(),e(this)}),t)}))),this._loadPromise}nativeCapabilities(){return this.relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&\"*\"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const r of this.fields)if(\"oid\"===r.type)e.push(r),t.push(r.name);else for(const i of this._overrideFields)if(i.toLowerCase()===r.name.toLowerCase()){e.push(r),t.push(r.name);break}this.fields=e,this._overrideFields=t}const e=this._layer.nativeCapabilities();e&&(this._databaseType=e.databaseType,this._requestStandardised=e.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.globalIdField=this.relatedLayer.globalIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types}databaseType(){return this.relatedLayer.databaseType().then((()=>(this._databaseType=this.relatedLayer._databaseType,this._databaseType)))}isTable(){return this.relatedLayer.isTable()}_isInFeatureSet(){return s.InFeatureSet}_candidateIdTransform(e){return e}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._getFilteredSet(\"\",null,null,null,e))).then((e=>(this._wset=e,e))):l(this._wset)}_changeFeature(t){const r={};for(const e of this.fields)r[e.name]=t.attributes[e.name];return new e({geometry:!0===this._removeGeometry?null:t.geometry,attributes:r})}_getFilteredSet(e,t,i,s,a){return this.databaseType().then((()=>{if(this.isTable()&&t&&null!==e&&\"\"!==e){return new r([],[],!0,null)}const n=this._layer.nativeCapabilities();if(!1===n.canQueryRelated){return new r([],[],!0,null)}if(n.capabilities.queryRelated&&n.capabilities.queryRelated.supportsPagination)return this._getFilteredSetUsingPaging(e,t,i,s,a);let l=\"\",d=!1;null!==s&&n.capabilities&&n.capabilities.queryRelated&&!0===n.capabilities.queryRelated.supportsOrderBy&&(l=s.constructClause(),d=!0);const u=new o;u.objectIds=[this._findObjectId];const h=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map((e=>e.name)):[\"*\"]);u.outFields=h,u.relationshipId=this.relationship.id,u.where=\"1=1\";let c=!0;return!0===this._removeGeometry&&(c=!1),u.returnGeometry=c,this._requestStandardised&&(u.sqlFormat=\"standard\"),u.outSpatialReference=this.spatialReference,u.orderByFields=\"\"!==l?l.split(\",\"):null,n.source.queryRelatedFeatures(u).then((s=>{this._checkCancelled(a);const n=s[this._findObjectId]?s[this._findObjectId].features:[],l=[];for(let e=0;e<n.length;e++)this._featureCache[n[e].attributes[this._layer.objectIdField]]=n[e],l.push(n[e].attributes[this._layer.objectIdField]);const o=t&&null!==e&&\"\"!==e,u=null!=i;return new r(o||u?l:[],o||u?[]:l,d,null)}))}))}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.indexOf(\"*\")>-1)return t;let r=!1;for(const i of t)if(i.toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}return!1===r&&t.push(this.objectIdField),t}_getFilteredSetUsingPaging(e,t,i,s,a){try{let n=\"\",l=!1;const d=this._layer.nativeCapabilities();return null!==s&&d&&d.capabilities.queryRelated&&!0===d.capabilities.queryRelated.supportsOrderBy&&(n=s.constructClause(),l=!0),this.databaseType().then((()=>{const s=\"1=1\";let o=this._maxQueryRate();const u=d.capabilities.query.maxRecordCount;void 0!==u&&u<o&&(o=u);const h=t&&null!==e&&\"\"!==e,c=null!=i;let p=null,y=!0;!0===this._removeGeometry&&(y=!1);const f=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map((e=>e.name)):[\"*\"]);return p=new r(h||c?[\"GETPAGES\"]:[],h||c?[]:[\"GETPAGES\"],l,{outFields:f.join(\",\"),resultRecordCount:o,resultOffset:0,objectIds:[this._findObjectId],where:s,orderByFields:n,returnGeometry:y,returnIdsOnly:\"false\",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),this._expandPagedSet(p,o,0,0,a).then((()=>p))}))}catch(n){return d(n)}}_expandPagedSet(e,t,r,i,s){return this._expandPagedSetFeatureSet(e,t,r,i,s)}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,r){try{const t=e.pagesDefinition.internal.lastRetrieved,i=t,s=e.pagesDefinition.internal.lastPage,a=this._layer.nativeCapabilities(),n=new o;return!0===this._requestStandardised&&(n.sqlFormat=\"standard\"),n.relationshipId=this.relationship.id,n.objectIds=e.pagesDefinition.objectIds,n.resultOffset=e.pagesDefinition.internal.lastPage,n.resultRecordCount=e.pagesDefinition.resultRecordCount,n.outFields=e.pagesDefinition.outFields.split(\",\"),n.where=e.pagesDefinition.where,n.orderByFields=\"\"!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(\",\"):null,n.returnGeometry=e.pagesDefinition.returnGeometry,n.outSpatialReference=this.spatialReference,a.source.queryRelatedFeatures(n).then((a=>{if(this._checkCancelled(r),e.pagesDefinition.internal.lastPage!==s)return 0;const n=a[this._findObjectId]?a[this._findObjectId].features:[];for(let t=0;t<n.length;t++)e.pagesDefinition.internal.set[i+t]=n[t].attributes[this._layer.objectIdField];for(let e=0;e<n.length;e++)this._featureCache[n[e].attributes[this._layer.objectIdField]]=n[e];const l=!a[this._findObjectId]||!1===a[this._findObjectId].exceededTransferLimit;return n.length!==e.pagesDefinition.resultRecordCount&&l&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=t+n.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,n.length}))}catch(i){return d(i)}}_getFeatures(e,t,r,i){const s=[];-1!==t&&void 0===this._featureCache[t]&&s.push(t);const a=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,a))return this._expandPagedSet(e,a,0,0,i).then((()=>this._getFeatures(e,t,r,i)));let n=0;for(let l=e._lastFetchedIndex;l<e._known.length&&(n++,n<=r&&(e._lastFetchedIndex+=1),!(\"GETPAGES\"!==e._known[l]&&void 0===this._featureCache[e._known[l]]&&(e._known[l]!==t&&s.push(e._known[l]),s.length>r)))&&!(n>=r&&0===s.length);l++);return 0===s.length?l(\"success\"):d(new Error(\"Unaccounted for Features. Not in Feature Collection\"))}_refineSetBlock(e,t,r){return l(e)}_stat(e,t,r,i,s,a,n){return l({calculated:!1})}get gdbVersion(){return this.relatedLayer.gdbVersion}_canDoAggregates(e,t,r,i,s){return l(!1)}relationshipMetaData(){return this.relatedLayer.relationshipMetaData()}serviceUrl(){return this.relatedLayer.serviceUrl()}queryAttachments(e,t,r,i){return this.relatedLayer.queryAttachments(e,t,r,i)}getFeatureByObjectId(e,t){return this.relatedLayer.getFeatureByObjectId(e,t)}getOwningSystemUrl(){return this.relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this.relatedLayer.getIdentityUser()}}export default u;\n"]},"metadata":{},"sourceType":"module"}