{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../../chunks/tslib.es6.js\";\nimport { equals as t } from \"../../../../../core/arrayUtils.js\";\nimport { AsyncSequence as i } from \"../../../../../core/AsyncSequence.js\";\nimport { HandleOwner as s } from \"../../../../../core/HandleOwner.js\";\nimport { makeHandle as r } from \"../../../../../core/handleUtils.js\";\nimport o from \"../../../../../core/Logger.js\";\nimport { isSome as n, isNone as a, unwrap as l } from \"../../../../../core/maybe.js\";\nimport { createAbortController as u, createTask as c, throwIfAbortError as d } from \"../../../../../core/promiseUtils.js\";\nimport { property as h } from \"../../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../../core/has.js\";\nimport \"../../../../../core/accessorSupport/ensureType.js\";\nimport { subclass as p } from \"../../../../../core/accessorSupport/decorators/subclass.js\";\nimport f from \"../../../../../geometry/Extent.js\";\nimport { toExtent as y } from \"../../../../../geometry/support/aaBoundingRect.js\";\nimport { unquantizeOptimizedFeatureSet as g, convertFromFeatureSet as m } from \"../../../../../layers/graphics/featureConversionUtils.js\";\nimport { OptimizedFeatureSetParserContext as b } from \"../../../../../rest/query/operations/pbfOptimizedFeatureSet.js\";\nimport { executeQueryForExtent as F, executeQueryPBF as T, executeQuery as v } from \"../../../../../rest/query/operations/query.js\";\nimport P from \"../../../../../rest/support/Query.js\";\nimport { PendingFeatureTile as I } from \"./PendingFeatureTile.js\";\nconst S = o.getLogger(\"esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher\");\nlet O = class extends s {\n  constructor(e) {\n    super(e), this.tilesOfInterest = [], this.availability = 0, this.pendingTiles = new Map(), this.pendingEdits = new i(), this.pendingEditsAbortController = u();\n  }\n\n  get minimumVerticesPerFeature() {\n    var e;\n\n    switch (null == (e = this.store) ? void 0 : e.featureStore.geometryType) {\n      case \"esriGeometryPoint\":\n      case \"esriGeometryMultipoint\":\n        return 1;\n\n      case \"esriGeometryPolygon\":\n        return 4;\n\n      case \"esriGeometryPolyline\":\n        return 2;\n    }\n  }\n\n  set filter(e) {\n    const t = this._get(\"filter\"),\n          i = this.filterProperties(e);\n\n    JSON.stringify(t) !== JSON.stringify(i) && this._set(\"filter\", i);\n  }\n\n  set customParameters(e) {\n    const t = this._get(\"customParameters\");\n\n    JSON.stringify(t) !== JSON.stringify(e) && this._set(\"customParameters\", e);\n  }\n\n  get configuration() {\n    return {\n      filter: this.filter,\n      customParameters: this.customParameters,\n      tileInfo: this.tileInfo,\n      tileSize: this.tileSize\n    };\n  }\n\n  set tileInfo(e) {\n    const t = this._get(\"tileInfo\");\n\n    t !== e && (n(e) && n(t) && JSON.stringify(e) === JSON.stringify(t) || (this._set(\"tileInfo\", e), this.store.tileInfo = e));\n  }\n\n  set tileSize(e) {\n    this._get(\"tileSize\") !== e && this._set(\"tileSize\", e);\n  }\n\n  get updating() {\n    return this.updatingHandles.updating || this.pendingEdits.updating;\n  }\n\n  initialize() {\n    this.initializeFetchExtent(), this.updatingHandles.add(this, \"configuration\", () => this.refresh()), this.updatingHandles.add(this, \"tilesOfInterest\", (e, i) => {\n      t(e, i, ({\n        id: e\n      }, {\n        id: t\n      }) => e === t) || this.process();\n    }, 1);\n  }\n\n  destroy() {\n    this.pendingTiles.forEach(e => this.deletePendingTile(e)), this.pendingTiles.clear(), this.store.destroy(), this.tilesOfInterest.length = 0, this.pendingEditsAbortController.abort(), this.pendingEditsAbortController = null;\n  }\n\n  refresh() {\n    this.store.refresh(), this.pendingTiles.forEach(e => this.deletePendingTile(e)), this.process();\n  }\n\n  applyEdits(e) {\n    this.pendingEdits.push(e, async e => {\n      if (0 === e.addedFeatures.length && 0 === e.updatedFeatures.length && 0 === e.deletedFeatures.length) return;\n\n      for (const [, i] of this.pendingTiles) i.reset();\n\n      const t = { ...e,\n        deletedFeatures: e.deletedFeatures.map(({\n          objectId: e,\n          globalId: t\n        }) => e && -1 !== e ? e : this.lookupObjectIdByGlobalId(t))\n      };\n      await this.updatingHandles.addPromise(this.store.processEdits(t, (e, t) => this.queryFeaturesById(e, t), this.pendingEditsAbortController.signal)), this.processPendingTiles();\n    });\n  }\n\n  initializeFetchExtent() {\n    if (!this.capabilities.query.supportsExtent) return;\n    const e = c(async e => {\n      try {\n        var t;\n        const i = await F(this.url, new P({\n          where: \"1=1\",\n          outSpatialReference: this.spatialReference,\n          cacheHint: !!this.capabilities.query.supportsCacheHint || void 0\n        }), {\n          query: this.configuration.customParameters,\n          signal: e\n        });\n        this.store.extent = f.fromJSON(null == (t = i.data) ? void 0 : t.extent);\n      } catch (i) {\n        d(i), S.warn(\"Failed to fetch data extent\", i);\n      }\n    });\n    this.updatingHandles.addPromise(e.promise.then(() => this.process())), this.handles.add(r(() => e.abort()));\n  }\n\n  get debugInfo() {\n    return {\n      numberOfFeatures: this.store.featureStore.numFeatures,\n      tilesOfInterest: this.tilesOfInterest,\n      pendingTiles: Array.from(this.pendingTiles.values()).map(e => e.debugInfo),\n      storedTiles: this.store.debugInfo\n    };\n  }\n\n  process() {\n    this.markTilesNotAlive(), this.createPendingTiles(), this.deletePendingTiles(), this.processPendingTiles();\n  }\n\n  markTilesNotAlive() {\n    for (const [, e] of this.pendingTiles) e.alive = !1;\n  }\n\n  createPendingTiles() {\n    const e = this.collectMissingTilesInfo();\n    if (this.setAvailability(a(e) ? 1 : e.coveredArea / e.fullArea), !a(e)) for (const {\n      data: t,\n      resolution: i\n    } of e.missingTiles) {\n      const e = this.pendingTiles.get(t.id);\n      e ? (e.resolution = i, e.alive = !0) : this.createPendingTile(t, i);\n    }\n  }\n\n  collectMissingTilesInfo() {\n    let e = null;\n\n    for (let t = this.tilesOfInterest.length - 1; t >= 0; t--) {\n      const i = this.tilesOfInterest[t],\n            s = this.store.process(i, (e, t) => this.verifyTileComplexity(e, t));\n      a(e) ? e = s : e.prepend(s);\n    }\n\n    return e;\n  }\n\n  deletePendingTiles() {\n    for (const [, e] of this.pendingTiles) e.alive || this.deletePendingTile(e);\n  }\n\n  processPendingTiles() {\n    const e = {\n      fetchCount: (e, t) => this.fetchCount(e, t),\n      fetchFeatures: (e, t, i) => this.fetchFeatures(e, t, i),\n      finish: (e, t) => this.finishPendingTile(e, t),\n      resume: () => this.processPendingTiles()\n    };\n    if (this.ensureFetchAllCounts(e)) for (const [, t] of this.pendingTiles) this.verifyTileComplexity(this.store.getFeatureCount(t.data), t.resolution) && this.updatingHandles.addPromise(t.process(e));\n  }\n\n  verifyTileComplexity(e, t) {\n    return this.verifyVertexComplexity(e) && this.verifyFeatureDensity(e, t);\n  }\n\n  verifyVertexComplexity(e) {\n    return e * this.minimumVerticesPerFeature < j;\n  }\n\n  verifyFeatureDensity(e, t) {\n    if (a(this.tileInfo)) return !1;\n    const i = this.tileSize * t;\n    return e * (w / (i * i)) < E;\n  }\n\n  ensureFetchAllCounts(e) {\n    let t = !0;\n\n    for (const [, i] of this.pendingTiles) i.state.type < 2 && this.updatingHandles.addPromise(i.process(e)), i.state.type <= 1 && (t = !1);\n\n    return t;\n  }\n\n  finishPendingTile(e, t) {\n    this.store.add(e.data, t), this.deletePendingTile(e), this.updateAvailability();\n  }\n\n  updateAvailability() {\n    const e = this.collectMissingTilesInfo();\n    this.setAvailability(a(e) ? 1 : e.coveredArea / e.fullArea);\n  }\n\n  setAvailability(e) {\n    this._set(\"availability\", e);\n  }\n\n  createPendingTile(e, t) {\n    const i = new I(e, t);\n    return this.pendingTiles.set(e.id, i), i;\n  }\n\n  deletePendingTile(e) {\n    e.reset(), this.pendingTiles.delete(e.data.id);\n  }\n\n  async fetchCount(e, t) {\n    return this.store.fetchCount(e.data, this.url, this.createCountQuery(e), {\n      query: this.customParameters,\n      timeout: x,\n      signal: t\n    });\n  }\n\n  async fetchFeatures(e, t, i) {\n    let s,\n        r = 0,\n        o = 0,\n        n = t;\n\n    for (;;) {\n      const a = this.createFeaturesQuery(e),\n            u = this.setPagingParameters(a, r, n),\n            {\n        features: c,\n        exceededTransferLimit: d\n      } = await this.queryFeatures(a, i);\n      if (u && (r += l(a.num)), o += c.length, s = s ? s.concat(c) : c, n = t - o, !u || !d || n <= 0) return s;\n    }\n  }\n\n  filterProperties(e) {\n    return a(e) ? {\n      where: \"1=1\",\n      gdbVersion: void 0,\n      timeExtent: void 0\n    } : {\n      where: e.where || \"1=1\",\n      timeExtent: e.timeExtent,\n      gdbVersion: e.gdbVersion\n    };\n  }\n\n  lookupObjectIdByGlobalId(e) {\n    const t = this.globalIdField,\n          i = this.objectIdField;\n    if (a(t)) throw new Error(\"Expected globalIdField to be defined\");\n    let s = null;\n    if (this.store.featureStore.forEach(r => {\n      var o;\n      e === r.attributes[t] && (s = null != (o = r.objectId) ? o : r.attributes[i]);\n    }), a(s)) throw new Error(`Expected to find a feature with globalId ${e}`);\n    return s;\n  }\n\n  queryFeaturesById(e, t) {\n    const i = this.createFeaturesQuery(null);\n    return i.objectIds = e, this.queryFeatures(i, t);\n  }\n\n  queryFeatures(e, t) {\n    return this.capabilities.query.supportsFormatPBF ? this.queryFeaturesPBF(e, t) : this.queryFeaturesJSON(e, t);\n  }\n\n  async queryFeaturesPBF(e, t) {\n    const {\n      sourceSpatialReference: i\n    } = this,\n          {\n      data: s\n    } = await T(this.url, e, new b({\n      sourceSpatialReference: i\n    }), {\n      query: this.configuration.customParameters,\n      timeout: x,\n      signal: t\n    });\n    return g(s);\n  }\n\n  async queryFeaturesJSON(e, t) {\n    const {\n      sourceSpatialReference: i\n    } = this,\n          {\n      data: s\n    } = await v(this.url, e, i, {\n      query: this.configuration.customParameters,\n      timeout: x,\n      signal: t\n    });\n    return m(s, this.objectIdField);\n  }\n\n  createCountQuery(e) {\n    const t = this.createBaseQuery(e);\n    return this.capabilities.query.supportsCacheHint && (t.cacheHint = !0), t;\n  }\n\n  createFeaturesQuery(e) {\n    const t = this.createBaseQuery(e);\n    return t.outFields = this.globalIdField ? [this.globalIdField, this.objectIdField] : [this.objectIdField], t.returnGeometry = !0, n(e) && (this.capabilities.query.supportsResultType ? t.resultType = \"tile\" : this.capabilities.query.supportsCacheHint && (t.cacheHint = !0)), t;\n  }\n\n  createBaseQuery(e) {\n    const t = new P({\n      returnZ: !1,\n      returnM: !1,\n      geometry: n(this.tileInfo) && n(e) ? y(e.data.extent, this.tileInfo.spatialReference) : void 0\n    }),\n          i = this.configuration.filter;\n    return n(i) && (t.where = i.where, t.gdbVersion = i.gdbVersion, t.timeExtent = i.timeExtent), t.outSpatialReference = this.spatialReference, t;\n  }\n\n  setPagingParameters(e, t, i) {\n    if (!this.capabilities.query.supportsPagination) return !1;\n    const {\n      supportsMaxRecordCountFactor: s,\n      supportsCacheHint: r,\n      tileMaxRecordCount: o,\n      maxRecordCount: n,\n      supportsResultType: a\n    } = this.capabilities.query,\n          l = s ? P.MAX_MAX_RECORD_COUNT_FACTOR : 1,\n          u = l * ((a || r) && o ? o : n || C);\n    return e.start = t, s ? (e.maxRecordCountFactor = Math.min(l, Math.ceil(i / u)), e.num = Math.min(i, e.maxRecordCountFactor * u)) : e.num = Math.min(i, u), !0;\n  }\n\n};\ne([h({\n  constructOnly: !0\n})], O.prototype, \"url\", void 0), e([h({\n  constructOnly: !0\n})], O.prototype, \"objectIdField\", void 0), e([h({\n  constructOnly: !0\n})], O.prototype, \"globalIdField\", void 0), e([h({\n  constructOnly: !0\n})], O.prototype, \"capabilities\", void 0), e([h({\n  constructOnly: !0\n})], O.prototype, \"sourceSpatialReference\", void 0), e([h({\n  constructOnly: !0\n})], O.prototype, \"spatialReference\", void 0), e([h({\n  constructOnly: !0\n})], O.prototype, \"store\", void 0), e([h({\n  readOnly: !0\n})], O.prototype, \"minimumVerticesPerFeature\", null), e([h()], O.prototype, \"filter\", null), e([h()], O.prototype, \"customParameters\", null), e([h({\n  readOnly: !0\n})], O.prototype, \"configuration\", null), e([h()], O.prototype, \"tileInfo\", null), e([h()], O.prototype, \"tileSize\", null), e([h()], O.prototype, \"tilesOfInterest\", void 0), e([h({\n  readOnly: !0\n})], O.prototype, \"updating\", null), e([h({\n  readOnly: !0\n})], O.prototype, \"availability\", void 0), O = e([p(\"esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher\")], O);\nconst C = 2e3,\n      x = 6e5,\n      j = 1e6,\n      w = 25,\n      E = 1;\nexport { O as FeatureServiceTiledFetcher };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiledFetcher.js"],"names":["_","e","equals","t","AsyncSequence","i","HandleOwner","s","makeHandle","r","o","isSome","n","isNone","a","unwrap","l","createAbortController","u","createTask","c","throwIfAbortError","d","property","h","subclass","p","f","toExtent","y","unquantizeOptimizedFeatureSet","g","convertFromFeatureSet","m","OptimizedFeatureSetParserContext","b","executeQueryForExtent","F","executeQueryPBF","T","executeQuery","v","P","PendingFeatureTile","I","S","getLogger","O","constructor","tilesOfInterest","availability","pendingTiles","Map","pendingEdits","pendingEditsAbortController","minimumVerticesPerFeature","store","featureStore","geometryType","filter","_get","filterProperties","JSON","stringify","_set","customParameters","configuration","tileInfo","tileSize","updating","updatingHandles","initialize","initializeFetchExtent","add","refresh","id","process","destroy","forEach","deletePendingTile","clear","length","abort","applyEdits","push","addedFeatures","updatedFeatures","deletedFeatures","reset","map","objectId","globalId","lookupObjectIdByGlobalId","addPromise","processEdits","queryFeaturesById","signal","processPendingTiles","capabilities","query","supportsExtent","url","where","outSpatialReference","spatialReference","cacheHint","supportsCacheHint","extent","fromJSON","data","warn","promise","then","handles","debugInfo","numberOfFeatures","numFeatures","Array","from","values","storedTiles","markTilesNotAlive","createPendingTiles","deletePendingTiles","alive","collectMissingTilesInfo","setAvailability","coveredArea","fullArea","resolution","missingTiles","get","createPendingTile","verifyTileComplexity","prepend","fetchCount","fetchFeatures","finish","finishPendingTile","resume","ensureFetchAllCounts","getFeatureCount","verifyVertexComplexity","verifyFeatureDensity","j","w","E","state","type","updateAvailability","set","delete","createCountQuery","timeout","x","createFeaturesQuery","setPagingParameters","features","exceededTransferLimit","queryFeatures","num","concat","gdbVersion","timeExtent","globalIdField","objectIdField","Error","attributes","objectIds","supportsFormatPBF","queryFeaturesPBF","queryFeaturesJSON","sourceSpatialReference","createBaseQuery","outFields","returnGeometry","supportsResultType","resultType","returnZ","returnM","geometry","supportsPagination","supportsMaxRecordCountFactor","tileMaxRecordCount","maxRecordCount","MAX_MAX_RECORD_COUNT_FACTOR","C","start","maxRecordCountFactor","Math","min","ceil","constructOnly","prototype","readOnly","FeatureServiceTiledFetcher"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../../chunks/tslib.es6.js\";import{equals as t}from\"../../../../../core/arrayUtils.js\";import{AsyncSequence as i}from\"../../../../../core/AsyncSequence.js\";import{HandleOwner as s}from\"../../../../../core/HandleOwner.js\";import{makeHandle as r}from\"../../../../../core/handleUtils.js\";import o from\"../../../../../core/Logger.js\";import{isSome as n,isNone as a,unwrap as l}from\"../../../../../core/maybe.js\";import{createAbortController as u,createTask as c,throwIfAbortError as d}from\"../../../../../core/promiseUtils.js\";import{property as h}from\"../../../../../core/accessorSupport/decorators/property.js\";import\"../../../../../core/has.js\";import\"../../../../../core/accessorSupport/ensureType.js\";import{subclass as p}from\"../../../../../core/accessorSupport/decorators/subclass.js\";import f from\"../../../../../geometry/Extent.js\";import{toExtent as y}from\"../../../../../geometry/support/aaBoundingRect.js\";import{unquantizeOptimizedFeatureSet as g,convertFromFeatureSet as m}from\"../../../../../layers/graphics/featureConversionUtils.js\";import{OptimizedFeatureSetParserContext as b}from\"../../../../../rest/query/operations/pbfOptimizedFeatureSet.js\";import{executeQueryForExtent as F,executeQueryPBF as T,executeQuery as v}from\"../../../../../rest/query/operations/query.js\";import P from\"../../../../../rest/support/Query.js\";import{PendingFeatureTile as I}from\"./PendingFeatureTile.js\";const S=o.getLogger(\"esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher\");let O=class extends s{constructor(e){super(e),this.tilesOfInterest=[],this.availability=0,this.pendingTiles=new Map,this.pendingEdits=new i,this.pendingEditsAbortController=u()}get minimumVerticesPerFeature(){var e;switch(null==(e=this.store)?void 0:e.featureStore.geometryType){case\"esriGeometryPoint\":case\"esriGeometryMultipoint\":return 1;case\"esriGeometryPolygon\":return 4;case\"esriGeometryPolyline\":return 2}}set filter(e){const t=this._get(\"filter\"),i=this.filterProperties(e);JSON.stringify(t)!==JSON.stringify(i)&&this._set(\"filter\",i)}set customParameters(e){const t=this._get(\"customParameters\");JSON.stringify(t)!==JSON.stringify(e)&&this._set(\"customParameters\",e)}get configuration(){return{filter:this.filter,customParameters:this.customParameters,tileInfo:this.tileInfo,tileSize:this.tileSize}}set tileInfo(e){const t=this._get(\"tileInfo\");t!==e&&(n(e)&&n(t)&&JSON.stringify(e)===JSON.stringify(t)||(this._set(\"tileInfo\",e),this.store.tileInfo=e))}set tileSize(e){this._get(\"tileSize\")!==e&&this._set(\"tileSize\",e)}get updating(){return this.updatingHandles.updating||this.pendingEdits.updating}initialize(){this.initializeFetchExtent(),this.updatingHandles.add(this,\"configuration\",(()=>this.refresh())),this.updatingHandles.add(this,\"tilesOfInterest\",((e,i)=>{t(e,i,(({id:e},{id:t})=>e===t))||this.process()}),1)}destroy(){this.pendingTiles.forEach((e=>this.deletePendingTile(e))),this.pendingTiles.clear(),this.store.destroy(),this.tilesOfInterest.length=0,this.pendingEditsAbortController.abort(),this.pendingEditsAbortController=null}refresh(){this.store.refresh(),this.pendingTiles.forEach((e=>this.deletePendingTile(e))),this.process()}applyEdits(e){this.pendingEdits.push(e,(async e=>{if(0===e.addedFeatures.length&&0===e.updatedFeatures.length&&0===e.deletedFeatures.length)return;for(const[,i]of this.pendingTiles)i.reset();const t={...e,deletedFeatures:e.deletedFeatures.map((({objectId:e,globalId:t})=>e&&-1!==e?e:this.lookupObjectIdByGlobalId(t)))};await this.updatingHandles.addPromise(this.store.processEdits(t,((e,t)=>this.queryFeaturesById(e,t)),this.pendingEditsAbortController.signal)),this.processPendingTiles()}))}initializeFetchExtent(){if(!this.capabilities.query.supportsExtent)return;const e=c((async e=>{try{var t;const i=await F(this.url,new P({where:\"1=1\",outSpatialReference:this.spatialReference,cacheHint:!!this.capabilities.query.supportsCacheHint||void 0}),{query:this.configuration.customParameters,signal:e});this.store.extent=f.fromJSON(null==(t=i.data)?void 0:t.extent)}catch(i){d(i),S.warn(\"Failed to fetch data extent\",i)}}));this.updatingHandles.addPromise(e.promise.then((()=>this.process()))),this.handles.add(r((()=>e.abort())))}get debugInfo(){return{numberOfFeatures:this.store.featureStore.numFeatures,tilesOfInterest:this.tilesOfInterest,pendingTiles:Array.from(this.pendingTiles.values()).map((e=>e.debugInfo)),storedTiles:this.store.debugInfo}}process(){this.markTilesNotAlive(),this.createPendingTiles(),this.deletePendingTiles(),this.processPendingTiles()}markTilesNotAlive(){for(const[,e]of this.pendingTiles)e.alive=!1}createPendingTiles(){const e=this.collectMissingTilesInfo();if(this.setAvailability(a(e)?1:e.coveredArea/e.fullArea),!a(e))for(const{data:t,resolution:i}of e.missingTiles){const e=this.pendingTiles.get(t.id);e?(e.resolution=i,e.alive=!0):this.createPendingTile(t,i)}}collectMissingTilesInfo(){let e=null;for(let t=this.tilesOfInterest.length-1;t>=0;t--){const i=this.tilesOfInterest[t],s=this.store.process(i,((e,t)=>this.verifyTileComplexity(e,t)));a(e)?e=s:e.prepend(s)}return e}deletePendingTiles(){for(const[,e]of this.pendingTiles)e.alive||this.deletePendingTile(e)}processPendingTiles(){const e={fetchCount:(e,t)=>this.fetchCount(e,t),fetchFeatures:(e,t,i)=>this.fetchFeatures(e,t,i),finish:(e,t)=>this.finishPendingTile(e,t),resume:()=>this.processPendingTiles()};if(this.ensureFetchAllCounts(e))for(const[,t]of this.pendingTiles)this.verifyTileComplexity(this.store.getFeatureCount(t.data),t.resolution)&&this.updatingHandles.addPromise(t.process(e))}verifyTileComplexity(e,t){return this.verifyVertexComplexity(e)&&this.verifyFeatureDensity(e,t)}verifyVertexComplexity(e){return e*this.minimumVerticesPerFeature<j}verifyFeatureDensity(e,t){if(a(this.tileInfo))return!1;const i=this.tileSize*t;return e*(w/(i*i))<E}ensureFetchAllCounts(e){let t=!0;for(const[,i]of this.pendingTiles)i.state.type<2&&this.updatingHandles.addPromise(i.process(e)),i.state.type<=1&&(t=!1);return t}finishPendingTile(e,t){this.store.add(e.data,t),this.deletePendingTile(e),this.updateAvailability()}updateAvailability(){const e=this.collectMissingTilesInfo();this.setAvailability(a(e)?1:e.coveredArea/e.fullArea)}setAvailability(e){this._set(\"availability\",e)}createPendingTile(e,t){const i=new I(e,t);return this.pendingTiles.set(e.id,i),i}deletePendingTile(e){e.reset(),this.pendingTiles.delete(e.data.id)}async fetchCount(e,t){return this.store.fetchCount(e.data,this.url,this.createCountQuery(e),{query:this.customParameters,timeout:x,signal:t})}async fetchFeatures(e,t,i){let s,r=0,o=0,n=t;for(;;){const a=this.createFeaturesQuery(e),u=this.setPagingParameters(a,r,n),{features:c,exceededTransferLimit:d}=await this.queryFeatures(a,i);if(u&&(r+=l(a.num)),o+=c.length,s=s?s.concat(c):c,n=t-o,!u||!d||n<=0)return s}}filterProperties(e){return a(e)?{where:\"1=1\",gdbVersion:void 0,timeExtent:void 0}:{where:e.where||\"1=1\",timeExtent:e.timeExtent,gdbVersion:e.gdbVersion}}lookupObjectIdByGlobalId(e){const t=this.globalIdField,i=this.objectIdField;if(a(t))throw new Error(\"Expected globalIdField to be defined\");let s=null;if(this.store.featureStore.forEach((r=>{var o;e===r.attributes[t]&&(s=null!=(o=r.objectId)?o:r.attributes[i])})),a(s))throw new Error(`Expected to find a feature with globalId ${e}`);return s}queryFeaturesById(e,t){const i=this.createFeaturesQuery(null);return i.objectIds=e,this.queryFeatures(i,t)}queryFeatures(e,t){return this.capabilities.query.supportsFormatPBF?this.queryFeaturesPBF(e,t):this.queryFeaturesJSON(e,t)}async queryFeaturesPBF(e,t){const{sourceSpatialReference:i}=this,{data:s}=await T(this.url,e,new b({sourceSpatialReference:i}),{query:this.configuration.customParameters,timeout:x,signal:t});return g(s)}async queryFeaturesJSON(e,t){const{sourceSpatialReference:i}=this,{data:s}=await v(this.url,e,i,{query:this.configuration.customParameters,timeout:x,signal:t});return m(s,this.objectIdField)}createCountQuery(e){const t=this.createBaseQuery(e);return this.capabilities.query.supportsCacheHint&&(t.cacheHint=!0),t}createFeaturesQuery(e){const t=this.createBaseQuery(e);return t.outFields=this.globalIdField?[this.globalIdField,this.objectIdField]:[this.objectIdField],t.returnGeometry=!0,n(e)&&(this.capabilities.query.supportsResultType?t.resultType=\"tile\":this.capabilities.query.supportsCacheHint&&(t.cacheHint=!0)),t}createBaseQuery(e){const t=new P({returnZ:!1,returnM:!1,geometry:n(this.tileInfo)&&n(e)?y(e.data.extent,this.tileInfo.spatialReference):void 0}),i=this.configuration.filter;return n(i)&&(t.where=i.where,t.gdbVersion=i.gdbVersion,t.timeExtent=i.timeExtent),t.outSpatialReference=this.spatialReference,t}setPagingParameters(e,t,i){if(!this.capabilities.query.supportsPagination)return!1;const{supportsMaxRecordCountFactor:s,supportsCacheHint:r,tileMaxRecordCount:o,maxRecordCount:n,supportsResultType:a}=this.capabilities.query,l=s?P.MAX_MAX_RECORD_COUNT_FACTOR:1,u=l*((a||r)&&o?o:n||C);return e.start=t,s?(e.maxRecordCountFactor=Math.min(l,Math.ceil(i/u)),e.num=Math.min(i,e.maxRecordCountFactor*u)):e.num=Math.min(i,u),!0}};e([h({constructOnly:!0})],O.prototype,\"url\",void 0),e([h({constructOnly:!0})],O.prototype,\"objectIdField\",void 0),e([h({constructOnly:!0})],O.prototype,\"globalIdField\",void 0),e([h({constructOnly:!0})],O.prototype,\"capabilities\",void 0),e([h({constructOnly:!0})],O.prototype,\"sourceSpatialReference\",void 0),e([h({constructOnly:!0})],O.prototype,\"spatialReference\",void 0),e([h({constructOnly:!0})],O.prototype,\"store\",void 0),e([h({readOnly:!0})],O.prototype,\"minimumVerticesPerFeature\",null),e([h()],O.prototype,\"filter\",null),e([h()],O.prototype,\"customParameters\",null),e([h({readOnly:!0})],O.prototype,\"configuration\",null),e([h()],O.prototype,\"tileInfo\",null),e([h()],O.prototype,\"tileSize\",null),e([h()],O.prototype,\"tilesOfInterest\",void 0),e([h({readOnly:!0})],O.prototype,\"updating\",null),e([h({readOnly:!0})],O.prototype,\"availability\",void 0),O=e([p(\"esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher\")],O);const C=2e3,x=6e5,j=1e6,w=25,E=1;export{O as FeatureServiceTiledFetcher};\n"]},"metadata":{},"sourceType":"module"}