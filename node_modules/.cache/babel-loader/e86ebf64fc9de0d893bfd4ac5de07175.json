{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../../core/has.js\";\nimport { isNone as s } from \"../../../../core/maybe.js\";\nimport { diff as t, hasDiff as i } from \"../../../../core/accessorSupport/diffUtils.js\";\nimport { createRendererExpression as a } from \"../../../../support/arcadeOnDemand.js\";\nimport r from \"../../arcade/callExpressionWithCursor.js\";\nconst c = import(\"../../../../layers/support/labelFormatUtils.js\");\n\nclass o {\n  constructor(e, s) {\n    this._canCacheExpressionValue = !1, this._sourceInfo = e, this._bitsets = {\n      computed: s.getBitset(s.createBitset())\n    };\n  }\n\n  invalidate() {\n    this._bitsets.computed.clear();\n  }\n\n  async updateSchema(a, r) {\n    const c = t(this._schema, r);\n    if (this._schema = r, !r || s(c) || !i(c, \"attributes\")) return;\n    e(\"esri-2d-update-debug\") && console.debug(\"Applying Update - Store:\", c), this._bitsets.computed.clear(), a.targets[r.name] = !0;\n    const o = r.attributes,\n          n = [],\n          d = [];\n\n    for (const e in o) {\n      const s = o[e];\n\n      switch (s.type) {\n        case \"field\":\n          break;\n\n        case \"expression\":\n          n.push(this._createArcadeComputedField(s));\n          break;\n\n        case \"label-expression\":\n          n.push(this._createLabelArcadeComputedField(s));\n          break;\n\n        case \"statistic\":\n          d.push(s);\n      }\n    }\n\n    this._computedFields = await Promise.all(n), this._canCacheExpressionValue = !this._computedFields.some(e => \"expression\" === e.type && e.expression.referencesScale()), this._statisticFields = d;\n  }\n\n  setComputedAttributes(e, s, t, i) {\n    const a = this._bitsets.computed;\n\n    if (!this._canCacheExpressionValue || !a.has(t)) {\n      a.set(t);\n\n      for (const a of this._computedFields) {\n        const r = this._evaluateField(s, a, i);\n\n        switch (a.resultType) {\n          case \"numeric\":\n            e.setComputedNumericAtIndex(t, a.fieldIndex, r);\n            break;\n\n          case \"string\":\n            e.setComputedStringAtIndex(t, a.fieldIndex, r);\n        }\n      }\n    }\n  }\n\n  async _createArcadeComputedField(e) {\n    const s = this._sourceInfo.spatialReference,\n          t = this._sourceInfo.fieldsIndex;\n    return { ...e,\n      expression: await a(e.valueExpression, s, t)\n    };\n  }\n\n  async _createLabelArcadeComputedField(e) {\n    const s = this._sourceInfo.spatialReference,\n          t = this._sourceInfo.fieldsIndex,\n          {\n      createLabelFunction: i\n    } = await c,\n          a = await i(e.label, t, s);\n    return { ...e,\n      builder: a\n    };\n  }\n\n  _evaluateField(e, s, t) {\n    switch (s.type) {\n      case \"label-expression\":\n        {\n          const t = e.readArcadeFeature();\n          return s.builder.evaluate(t) || \"\";\n        }\n\n      case \"expression\":\n        {\n          const {\n            expression: i\n          } = s;\n          return r(i, e, {\n            $view: {\n              scale: t\n            }\n          });\n        }\n    }\n  }\n\n}\n\nexport { o as Store2D };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/2d/layers/features/Store2D.js"],"names":["e","isNone","s","diff","t","hasDiff","i","createRendererExpression","a","r","c","o","constructor","_canCacheExpressionValue","_sourceInfo","_bitsets","computed","getBitset","createBitset","invalidate","clear","updateSchema","_schema","console","debug","targets","name","attributes","n","d","type","push","_createArcadeComputedField","_createLabelArcadeComputedField","_computedFields","Promise","all","some","expression","referencesScale","_statisticFields","setComputedAttributes","has","set","_evaluateField","resultType","setComputedNumericAtIndex","fieldIndex","setComputedStringAtIndex","spatialReference","fieldsIndex","valueExpression","createLabelFunction","label","builder","readArcadeFeature","evaluate","$view","scale","Store2D"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../../core/has.js\";import{isNone as s}from\"../../../../core/maybe.js\";import{diff as t,hasDiff as i}from\"../../../../core/accessorSupport/diffUtils.js\";import{createRendererExpression as a}from\"../../../../support/arcadeOnDemand.js\";import r from\"../../arcade/callExpressionWithCursor.js\";const c=import(\"../../../../layers/support/labelFormatUtils.js\");class o{constructor(e,s){this._canCacheExpressionValue=!1,this._sourceInfo=e,this._bitsets={computed:s.getBitset(s.createBitset())}}invalidate(){this._bitsets.computed.clear()}async updateSchema(a,r){const c=t(this._schema,r);if(this._schema=r,!r||s(c)||!i(c,\"attributes\"))return;e(\"esri-2d-update-debug\")&&console.debug(\"Applying Update - Store:\",c),this._bitsets.computed.clear(),a.targets[r.name]=!0;const o=r.attributes,n=[],d=[];for(const e in o){const s=o[e];switch(s.type){case\"field\":break;case\"expression\":n.push(this._createArcadeComputedField(s));break;case\"label-expression\":n.push(this._createLabelArcadeComputedField(s));break;case\"statistic\":d.push(s)}}this._computedFields=await Promise.all(n),this._canCacheExpressionValue=!this._computedFields.some((e=>\"expression\"===e.type&&e.expression.referencesScale())),this._statisticFields=d}setComputedAttributes(e,s,t,i){const a=this._bitsets.computed;if(!this._canCacheExpressionValue||!a.has(t)){a.set(t);for(const a of this._computedFields){const r=this._evaluateField(s,a,i);switch(a.resultType){case\"numeric\":e.setComputedNumericAtIndex(t,a.fieldIndex,r);break;case\"string\":e.setComputedStringAtIndex(t,a.fieldIndex,r)}}}}async _createArcadeComputedField(e){const s=this._sourceInfo.spatialReference,t=this._sourceInfo.fieldsIndex;return{...e,expression:await a(e.valueExpression,s,t)}}async _createLabelArcadeComputedField(e){const s=this._sourceInfo.spatialReference,t=this._sourceInfo.fieldsIndex,{createLabelFunction:i}=await c,a=await i(e.label,t,s);return{...e,builder:a}}_evaluateField(e,s,t){switch(s.type){case\"label-expression\":{const t=e.readArcadeFeature();return s.builder.evaluate(t)||\"\"}case\"expression\":{const{expression:i}=s;return r(i,e,{$view:{scale:t}})}}}}export{o as Store2D};\n"]},"metadata":{},"sourceType":"module"}