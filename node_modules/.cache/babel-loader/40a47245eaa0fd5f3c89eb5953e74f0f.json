{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../../chunks/tslib.es6.js\";\nimport \"../../../../../geometry.js\";\nimport t from \"../../../../../core/Accessor.js\";\nimport s from \"../../../../../core/Handles.js\";\nimport { handlesGroup as n, makeHandle as r } from \"../../../../../core/handleUtils.js\";\nimport { isNone as i, isSome as o, abortMaybe as a, removeMaybe as l, none as c } from \"../../../../../core/maybe.js\";\nimport { createTask as p, ignoreAbortErrors as h } from \"../../../../../core/promiseUtils.js\";\nimport { property as u } from \"../../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../../core/has.js\";\nimport \"../../../../../core/accessorSupport/ensureType.js\";\nimport \"../../../../../core/Logger.js\";\nimport { subclass as g } from \"../../../../../core/accessorSupport/decorators/subclass.js\";\nimport { reactionInit as d } from \"../../../../../core/accessorSupport/trackingUtils.js\";\nimport { g as y, f as _, n as m, a as v, b as f, j as A, w as b } from \"../../../../../chunks/vec3.js\";\nimport { c as T } from \"../../../../../chunks/vec3f64.js\";\nimport { fromPoints as C, create as O } from \"../../../../../geometry/support/ray.js\";\nimport { LineOfSightAnalysis as j } from \"./LineOfSightAnalysis.js\";\nimport { LineOfSightResult as E } from \"./LineOfSightResult.js\";\nimport { Intersector as I } from \"../../../webgl-engine/lib/Intersector.js\";\nimport { toGraphic as L } from \"../../../webgl-engine/lib/intersectorUtilsConversions.js\";\nimport { ImmediateTask as w, TaskPriority as S } from \"../../../../support/Scheduler.js\";\nimport P from \"../../../../../geometry/Point.js\";\nlet V = class extends t {\n  constructor(e) {\n    super(e), this._tasks = w, this._handles = new s(), this._analysisHandles = new s();\n  }\n\n  initialize() {\n    var e;\n    const t = null == (e = this.view.resourceController) ? void 0 : e.scheduler;\n    t && (this._tasks = t.registerTask(S.LINE_OF_SIGHT_TOOL));\n    this._handles.add([d(() => this.layer.observer, e => this._onObserverChange(e)), this._connectAnalyses(), this._connectTargets()]), this._intersector = new I(this.view.state.viewingMode), this._intersector.options.hud = !1, this._intersector.options.store = 0;\n  }\n\n  destroy() {\n    this._handles.destroy(), this._analysisHandles.destroy(), this._analyses.removeAll();\n  }\n\n  get updating() {\n    return this._tasks.updating;\n  }\n\n  get priority() {\n    return this._tasks.priority;\n  }\n\n  set priority(e) {\n    this._tasks.priority = e;\n  }\n\n  get _analyses() {\n    return this.layerViewData.analyses;\n  }\n\n  get _observerEngineLocation() {\n    return this.layerViewData.observerEngineLocation;\n  }\n\n  set _observerEngineLocation(e) {\n    this.layerViewData.observerEngineLocation = e;\n  }\n\n  get _screenPixelSize() {\n    return this.view.state.camera.computeScreenPixelSizeAt(this._observerEngineLocation);\n  }\n\n  getLineOfSightComputationDependencies(e) {\n    const {\n      inputPoints: t\n    } = e;\n    return {\n      inputPoints: t\n    };\n  }\n\n  computeAnalysis(e, t = !1) {\n    const {\n      analysis: s\n    } = e,\n          {\n      inputPoints: n,\n      computationResult: r\n    } = s,\n          {\n      observerAdjusted: i,\n      targetAdjusted: o\n    } = n,\n          {\n      start: a,\n      end: l\n    } = r;\n    y(a, i), y(l, o);\n    t || this._canComputeAnalysis(s) ? this._computeAnalysisIntersection(e) : this._interpolateAnalysisIntersection(e), s.updateComputationResults();\n  }\n\n  _adjustStartEndPositions(e) {\n    const t = this._screenPixelSize,\n          s = this.view,\n          {\n      inputPoints: n\n    } = e,\n          {\n      observer: r,\n      target: i,\n      observerAdjusted: o,\n      targetAdjusted: a\n    } = n,\n          l = R;\n\n    _(l, i, r);\n\n    const c = t;\n    m(l, l), v(l, l, Math.min(c, 1)), f(o, r, l), _(l, r, i);\n    const p = s.state.camera.computeScreenPixelSizeAt(i);\n    m(l, l), v(l, l, Math.min(p, 1)), f(a, i, l);\n  }\n\n  _computeAnalysisIntersection({\n    analysis: e,\n    interpolationInfo: t\n  }) {\n    const {\n      view: s\n    } = this,\n          {\n      sceneIntersectionHelper: n,\n      renderCoordsHelper: r\n    } = s;\n    if (i(n)) return;\n    const o = this._intersector,\n          {\n      computationResult: a,\n      inputPoints: l\n    } = e,\n          {\n      observer: c,\n      target: p\n    } = l,\n          {\n      start: h,\n      end: u\n    } = a,\n          g = C(h, u, H);\n    n.intersectToolIntersectorRay(g, o);\n    const d = a.intersection,\n          _ = R,\n          m = !!o.results.min && o.results.min.getIntersectionPoint(d);\n    let v = !0;\n\n    if (m) {\n      y(t.originalIntersection, d), y(t.originalObserver, h), y(t.originalTarget, u), r.fromRenderCoords(d, _, s.spatialReference);\n      const e = 1 - A(u, p) / A(h, p);\n      v = A(c, d) >= e * A(c, p);\n    }\n\n    const f = new P(_, s.spatialReference);\n    e.result = new E({\n      target: e.target,\n      intersectedGraphic: v ? null : L(o.results.min, s),\n      intersectedLocation: v ? null : f,\n      visible: !!m && v\n    }), a.isValid = l.isValid = !0, a.isTargetVisible = v;\n  }\n\n  _interpolateAnalysisIntersection({\n    analysis: e,\n    interpolationInfo: t\n  }) {\n    const {\n      computationResult: s,\n      inputPoints: n\n    } = e,\n          {\n      start: r,\n      end: i,\n      intersection: o\n    } = s,\n          {\n      originalIntersection: a,\n      originalObserver: l,\n      originalTarget: c\n    } = t;\n\n    if (y(o, a), n.isValid) {\n      const e = R,\n            t = A(l, a) / A(l, c);\n      b(e, r, l), v(e, e, 1 - t), f(o, o, e), b(e, i, c), v(e, e, t), f(o, o, e), s.isValid = !0;\n    } else e.result = null, s.isValid = !1, s.isTargetVisible = !1;\n  }\n\n  _canComputeAnalysis(e) {\n    const t = this.layer.observer,\n          s = this.view.frustum;\n    if (i(t) || i(e.target) || i(s)) return !1;\n    const {\n      observerAdjusted: n,\n      targetAdjusted: r\n    } = e.inputPoints,\n          o = s.intersectsPoint(n),\n          a = s.intersectsPoint(r);\n    return o && a;\n  }\n\n  _onObserverChange(e) {\n    if (i(e)) return void this.layer.targets.removeAll();\n    const t = T();\n    this.view.renderCoordsHelper.toRenderCoords(e, t), this._observerEngineLocation = t, this.priority = S.LINE_OF_SIGHT_TOOL_INTERACTIVE;\n  }\n\n  _onObserverChangeForAnalysis(e) {\n    e.inputPoints.isValid = !1;\n  }\n\n  _onObserverEngineForAnalysis(e, t) {\n    const {\n      inputPoints: s\n    } = e;\n    y(s.observer, t), this._adjustStartEndPositions(e), e.updateInputPoints(), this.priority = S.LINE_OF_SIGHT_TOOL_INTERACTIVE;\n  }\n\n  _onTargetLocationChange(e, t) {\n    const {\n      inputPoints: s\n    } = e;\n    s.isValid = !1, this.view.renderCoordsHelper.toRenderCoords(t, s.target), this._adjustStartEndPositions(e), e.updateInputPoints(), this.priority = S.LINE_OF_SIGHT_TOOL_INTERACTIVE;\n  }\n\n  _connectAnalysisToTarget(e) {\n    return d(() => ({\n      analysis: e,\n      target: e.target\n    }), ({\n      analysis: e,\n      target: t\n    }) => {\n      o(t) && this._onTargetLocationChange(e, t);\n    });\n  }\n\n  _connectAnalysisToObserver(e) {\n    return d(() => ({\n      analysis: e,\n      observer: this.layer.observer\n    }), ({\n      analysis: e\n    }) => {\n      this._onObserverChangeForAnalysis(e);\n    });\n  }\n\n  _connectAnalysisToObserverEngine(e) {\n    return d(() => ({\n      analysis: e,\n      observer: this._observerEngineLocation\n    }), ({\n      analysis: e,\n      observer: t\n    }) => {\n      this._onObserverEngineForAnalysis(e, t);\n    });\n  }\n\n  _connectAnalysisForCompute(e) {\n    let t = c;\n    const s = {\n      analysis: e,\n      interpolationInfo: {\n        originalIntersection: T(),\n        originalObserver: T(),\n        originalTarget: T()\n      }\n    };\n    return n([d(() => this.getLineOfSightComputationDependencies(e), () => {\n      t = a(t), t = p(async e => {\n        await h(this._tasks.schedule(() => this.computeAnalysis(s), e));\n      });\n    }), r(() => t = a(t))]);\n  }\n\n  _connectAnalysis(e) {\n    const t = this._analysisHandles;\n    t.has(e) || t.add([this._connectAnalysisToTarget(e), this._connectAnalysisToObserver(e), this._connectAnalysisToObserverEngine(e), this._connectAnalysisForCompute(e)]);\n  }\n\n  _disconnectAnalysis(e) {\n    this._analysisHandles.remove(e);\n  }\n\n  _onAnalysesCollectionChange(e) {\n    e.added.forEach(e => this._connectAnalysis(e)), e.removed.forEach(e => this._disconnectAnalysis(e));\n  }\n\n  _onTargetsChange(e) {\n    return this._analyses.removeAll(), e.items.length > 0 && e.forEach(e => this._addTarget(e)), e.on(\"change\", e => this._onTargetCollectionChange(e));\n  }\n\n  _onTargetCollectionChange(e) {\n    e.added.forEach(e => this._addTarget(e)), e.removed.forEach(e => this._removeTarget(e));\n  }\n\n  _addTarget(e) {\n    const t = this._analyses;\n    t.some(t => t.target === e) || t.add(new j({\n      target: e\n    }));\n  }\n\n  _removeTarget(e) {\n    const t = this._analyses,\n          s = t.find(t => t.target === e);\n    t.remove(s);\n  }\n\n  _connectAnalyses() {\n    let e = null;\n    return n([d(() => this._analyses, t => {\n      e = l(e), e = t.on(\"change\", e => this._onAnalysesCollectionChange(e)), t.forEach(e => this._connectAnalysis(e));\n    }), r(() => e = l(e))]);\n  }\n\n  _connectTargets() {\n    let e = null;\n    return n([d(() => this.layer.targets, t => {\n      e = l(e), e = this._onTargetsChange(t);\n    }), r(() => e = l(e))]);\n  }\n\n};\ne([u({\n  constructOnly: !0\n})], V.prototype, \"layer\", void 0), e([u({\n  constructOnly: !0\n})], V.prototype, \"layerViewData\", void 0), e([u({\n  constructOnly: !0\n})], V.prototype, \"view\", void 0), e([u()], V.prototype, \"updating\", null), e([u()], V.prototype, \"priority\", null), e([u()], V.prototype, \"_analyses\", null), e([u()], V.prototype, \"_observerEngineLocation\", null), e([u()], V.prototype, \"_screenPixelSize\", null), e([u()], V.prototype, \"_tasks\", void 0), V = e([g(\"esri.views.3d.layers.analysis.LineOfSight.LineOfSightController\")], V);\nconst R = T(),\n      H = O();\nexport { V as LineOfSightController };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/layers/analysis/LineOfSight/LineOfSightController.js"],"names":["_","e","t","s","handlesGroup","n","makeHandle","r","isNone","i","isSome","o","abortMaybe","a","removeMaybe","l","none","c","createTask","p","ignoreAbortErrors","h","property","u","subclass","g","reactionInit","d","y","f","m","v","b","j","A","w","T","fromPoints","C","create","O","LineOfSightAnalysis","LineOfSightResult","E","Intersector","I","toGraphic","L","ImmediateTask","TaskPriority","S","P","V","constructor","_tasks","_handles","_analysisHandles","initialize","view","resourceController","scheduler","registerTask","LINE_OF_SIGHT_TOOL","add","layer","observer","_onObserverChange","_connectAnalyses","_connectTargets","_intersector","state","viewingMode","options","hud","store","destroy","_analyses","removeAll","updating","priority","layerViewData","analyses","_observerEngineLocation","observerEngineLocation","_screenPixelSize","camera","computeScreenPixelSizeAt","getLineOfSightComputationDependencies","inputPoints","computeAnalysis","analysis","computationResult","observerAdjusted","targetAdjusted","start","end","_canComputeAnalysis","_computeAnalysisIntersection","_interpolateAnalysisIntersection","updateComputationResults","_adjustStartEndPositions","target","R","Math","min","interpolationInfo","sceneIntersectionHelper","renderCoordsHelper","H","intersectToolIntersectorRay","intersection","results","getIntersectionPoint","originalIntersection","originalObserver","originalTarget","fromRenderCoords","spatialReference","result","intersectedGraphic","intersectedLocation","visible","isValid","isTargetVisible","frustum","intersectsPoint","targets","toRenderCoords","LINE_OF_SIGHT_TOOL_INTERACTIVE","_onObserverChangeForAnalysis","_onObserverEngineForAnalysis","updateInputPoints","_onTargetLocationChange","_connectAnalysisToTarget","_connectAnalysisToObserver","_connectAnalysisToObserverEngine","_connectAnalysisForCompute","schedule","_connectAnalysis","has","_disconnectAnalysis","remove","_onAnalysesCollectionChange","added","forEach","removed","_onTargetsChange","items","length","_addTarget","on","_onTargetCollectionChange","_removeTarget","some","find","constructOnly","prototype","LineOfSightController"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../../chunks/tslib.es6.js\";import\"../../../../../geometry.js\";import t from\"../../../../../core/Accessor.js\";import s from\"../../../../../core/Handles.js\";import{handlesGroup as n,makeHandle as r}from\"../../../../../core/handleUtils.js\";import{isNone as i,isSome as o,abortMaybe as a,removeMaybe as l,none as c}from\"../../../../../core/maybe.js\";import{createTask as p,ignoreAbortErrors as h}from\"../../../../../core/promiseUtils.js\";import{property as u}from\"../../../../../core/accessorSupport/decorators/property.js\";import\"../../../../../core/has.js\";import\"../../../../../core/accessorSupport/ensureType.js\";import\"../../../../../core/Logger.js\";import{subclass as g}from\"../../../../../core/accessorSupport/decorators/subclass.js\";import{reactionInit as d}from\"../../../../../core/accessorSupport/trackingUtils.js\";import{g as y,f as _,n as m,a as v,b as f,j as A,w as b}from\"../../../../../chunks/vec3.js\";import{c as T}from\"../../../../../chunks/vec3f64.js\";import{fromPoints as C,create as O}from\"../../../../../geometry/support/ray.js\";import{LineOfSightAnalysis as j}from\"./LineOfSightAnalysis.js\";import{LineOfSightResult as E}from\"./LineOfSightResult.js\";import{Intersector as I}from\"../../../webgl-engine/lib/Intersector.js\";import{toGraphic as L}from\"../../../webgl-engine/lib/intersectorUtilsConversions.js\";import{ImmediateTask as w,TaskPriority as S}from\"../../../../support/Scheduler.js\";import P from\"../../../../../geometry/Point.js\";let V=class extends t{constructor(e){super(e),this._tasks=w,this._handles=new s,this._analysisHandles=new s}initialize(){var e;const t=null==(e=this.view.resourceController)?void 0:e.scheduler;t&&(this._tasks=t.registerTask(S.LINE_OF_SIGHT_TOOL));this._handles.add([d((()=>this.layer.observer),(e=>this._onObserverChange(e))),this._connectAnalyses(),this._connectTargets()]),this._intersector=new I(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=0}destroy(){this._handles.destroy(),this._analysisHandles.destroy(),this._analyses.removeAll()}get updating(){return this._tasks.updating}get priority(){return this._tasks.priority}set priority(e){this._tasks.priority=e}get _analyses(){return this.layerViewData.analyses}get _observerEngineLocation(){return this.layerViewData.observerEngineLocation}set _observerEngineLocation(e){this.layerViewData.observerEngineLocation=e}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._observerEngineLocation)}getLineOfSightComputationDependencies(e){const{inputPoints:t}=e;return{inputPoints:t}}computeAnalysis(e,t=!1){const{analysis:s}=e,{inputPoints:n,computationResult:r}=s,{observerAdjusted:i,targetAdjusted:o}=n,{start:a,end:l}=r;y(a,i),y(l,o);t||this._canComputeAnalysis(s)?this._computeAnalysisIntersection(e):this._interpolateAnalysisIntersection(e),s.updateComputationResults()}_adjustStartEndPositions(e){const t=this._screenPixelSize,s=this.view,{inputPoints:n}=e,{observer:r,target:i,observerAdjusted:o,targetAdjusted:a}=n,l=R;_(l,i,r);const c=t;m(l,l),v(l,l,Math.min(c,1)),f(o,r,l),_(l,r,i);const p=s.state.camera.computeScreenPixelSizeAt(i);m(l,l),v(l,l,Math.min(p,1)),f(a,i,l)}_computeAnalysisIntersection({analysis:e,interpolationInfo:t}){const{view:s}=this,{sceneIntersectionHelper:n,renderCoordsHelper:r}=s;if(i(n))return;const o=this._intersector,{computationResult:a,inputPoints:l}=e,{observer:c,target:p}=l,{start:h,end:u}=a,g=C(h,u,H);n.intersectToolIntersectorRay(g,o);const d=a.intersection,_=R,m=!!o.results.min&&o.results.min.getIntersectionPoint(d);let v=!0;if(m){y(t.originalIntersection,d),y(t.originalObserver,h),y(t.originalTarget,u),r.fromRenderCoords(d,_,s.spatialReference);const e=1-A(u,p)/A(h,p);v=A(c,d)>=e*A(c,p)}const f=new P(_,s.spatialReference);e.result=new E({target:e.target,intersectedGraphic:v?null:L(o.results.min,s),intersectedLocation:v?null:f,visible:!!m&&v}),a.isValid=l.isValid=!0,a.isTargetVisible=v}_interpolateAnalysisIntersection({analysis:e,interpolationInfo:t}){const{computationResult:s,inputPoints:n}=e,{start:r,end:i,intersection:o}=s,{originalIntersection:a,originalObserver:l,originalTarget:c}=t;if(y(o,a),n.isValid){const e=R,t=A(l,a)/A(l,c);b(e,r,l),v(e,e,1-t),f(o,o,e),b(e,i,c),v(e,e,t),f(o,o,e),s.isValid=!0}else e.result=null,s.isValid=!1,s.isTargetVisible=!1}_canComputeAnalysis(e){const t=this.layer.observer,s=this.view.frustum;if(i(t)||i(e.target)||i(s))return!1;const{observerAdjusted:n,targetAdjusted:r}=e.inputPoints,o=s.intersectsPoint(n),a=s.intersectsPoint(r);return o&&a}_onObserverChange(e){if(i(e))return void this.layer.targets.removeAll();const t=T();this.view.renderCoordsHelper.toRenderCoords(e,t),this._observerEngineLocation=t,this.priority=S.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverChangeForAnalysis(e){e.inputPoints.isValid=!1}_onObserverEngineForAnalysis(e,t){const{inputPoints:s}=e;y(s.observer,t),this._adjustStartEndPositions(e),e.updateInputPoints(),this.priority=S.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetLocationChange(e,t){const{inputPoints:s}=e;s.isValid=!1,this.view.renderCoordsHelper.toRenderCoords(t,s.target),this._adjustStartEndPositions(e),e.updateInputPoints(),this.priority=S.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectAnalysisToTarget(e){return d((()=>({analysis:e,target:e.target})),(({analysis:e,target:t})=>{o(t)&&this._onTargetLocationChange(e,t)}))}_connectAnalysisToObserver(e){return d((()=>({analysis:e,observer:this.layer.observer})),(({analysis:e})=>{this._onObserverChangeForAnalysis(e)}))}_connectAnalysisToObserverEngine(e){return d((()=>({analysis:e,observer:this._observerEngineLocation})),(({analysis:e,observer:t})=>{this._onObserverEngineForAnalysis(e,t)}))}_connectAnalysisForCompute(e){let t=c;const s={analysis:e,interpolationInfo:{originalIntersection:T(),originalObserver:T(),originalTarget:T()}};return n([d((()=>this.getLineOfSightComputationDependencies(e)),(()=>{t=a(t),t=p((async e=>{await h(this._tasks.schedule((()=>this.computeAnalysis(s)),e))}))})),r((()=>t=a(t)))])}_connectAnalysis(e){const t=this._analysisHandles;t.has(e)||t.add([this._connectAnalysisToTarget(e),this._connectAnalysisToObserver(e),this._connectAnalysisToObserverEngine(e),this._connectAnalysisForCompute(e)])}_disconnectAnalysis(e){this._analysisHandles.remove(e)}_onAnalysesCollectionChange(e){e.added.forEach((e=>this._connectAnalysis(e))),e.removed.forEach((e=>this._disconnectAnalysis(e)))}_onTargetsChange(e){return this._analyses.removeAll(),e.items.length>0&&e.forEach((e=>this._addTarget(e))),e.on(\"change\",(e=>this._onTargetCollectionChange(e)))}_onTargetCollectionChange(e){e.added.forEach((e=>this._addTarget(e))),e.removed.forEach((e=>this._removeTarget(e)))}_addTarget(e){const t=this._analyses;t.some((t=>t.target===e))||t.add(new j({target:e}))}_removeTarget(e){const t=this._analyses,s=t.find((t=>t.target===e));t.remove(s)}_connectAnalyses(){let e=null;return n([d((()=>this._analyses),(t=>{e=l(e),e=t.on(\"change\",(e=>this._onAnalysesCollectionChange(e))),t.forEach((e=>this._connectAnalysis(e)))})),r((()=>e=l(e)))])}_connectTargets(){let e=null;return n([d((()=>this.layer.targets),(t=>{e=l(e),e=this._onTargetsChange(t)})),r((()=>e=l(e)))])}};e([u({constructOnly:!0})],V.prototype,\"layer\",void 0),e([u({constructOnly:!0})],V.prototype,\"layerViewData\",void 0),e([u({constructOnly:!0})],V.prototype,\"view\",void 0),e([u()],V.prototype,\"updating\",null),e([u()],V.prototype,\"priority\",null),e([u()],V.prototype,\"_analyses\",null),e([u()],V.prototype,\"_observerEngineLocation\",null),e([u()],V.prototype,\"_screenPixelSize\",null),e([u()],V.prototype,\"_tasks\",void 0),V=e([g(\"esri.views.3d.layers.analysis.LineOfSight.LineOfSightController\")],V);const R=T(),H=O();export{V as LineOfSightController};\n"]},"metadata":{},"sourceType":"module"}