{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../chunks/tslib.es6.js\";\nimport t from \"../../../../core/Accessor.js\";\nimport { forEach as s, result as l } from \"../../../../core/asyncUtils.js\";\nimport a from \"../../../../core/Handles.js\";\nimport i from \"../../../../core/Logger.js\";\nimport { someMap as r } from \"../../../../core/MapUtils.js\";\nimport { destroyMaybe as o, disposeMaybe as n, isNone as c, unwrap as h } from \"../../../../core/maybe.js\";\nimport { throwIfAborted as b, isAbortError as d, createAbortController as p } from \"../../../../core/promiseUtils.js\";\nimport { property as u } from \"../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../core/has.js\";\nimport \"../../../../core/accessorSupport/ensureType.js\";\nimport { subclass as g } from \"../../../../core/accessorSupport/decorators/subclass.js\";\nimport { hydrateGraphic as y } from \"../../../../layers/graphics/hydratedFeatures.js\";\nimport { createLabelFunction as f } from \"../../../../layers/support/labelFormatUtils.js\";\nimport { areLabelsVisible as _ } from \"../../../../layers/support/layerUtils.js\";\nimport { isCalloutSupport as m } from \"../../../../symbols/callouts/calloutUtils.js\";\nimport { make as x } from \"./Graphics3DCalloutSymbolLayerFactory.js\";\nimport C from \"./Graphics3DGraphicCreationContext.js\";\nimport { getGraphics3DSymbol as v } from \"./graphicSymbolUtils.js\";\nimport { get as T } from \"./labelPlacement.js\";\nimport L from \"../../support/debugFlags.js\";\nimport { MaterialCollection as G } from \"../../webgl-engine/lib/MaterialCollection.js\";\nimport { TextRenderer as D } from \"../../webgl-engine/lib/TextRenderer.js\";\nimport { TextRenderParameters as R } from \"../../webgl-engine/lib/TextRenderParameters.js\";\nimport w from \"../../webgl-engine/lib/TextTextureAtlas.js\";\nimport { WebGLLayer as A } from \"../../webgl-engine/lib/WebGLLayer.js\";\nimport { TaskPriority as O } from \"../../../support/Scheduler.js\";\nconst I = i.getLogger(\"esri.views.3d.layers.graphics.Labeler\");\nlet S = class extends t {\n  constructor() {\n    super(...arguments), this._dirty = !1, this._labels = new Map(), this._labelsToAdd = new Map(), this._labelsToRemove = new Map(), this._labelingContexts = new Array();\n  }\n\n  setup() {\n    this.dispose(), this._handles = new a(), this._handles.add([this.view.watch(\"state.camera\", () => this.setDirty()), this.view.watch(\"pixelRatio\", () => this._resetAllLabels()), this.view.resourceController.scheduler.registerTask(O.LABELER, this)]), this._textTextureAtlas = new w({\n      view: this.view\n    }), this._hudMaterialCollection = new G(this.view._stage), this._calloutMaterialCollection = new G(this.view._stage);\n  }\n\n  dispose() {\n    this._handles = o(this._handles), this._textTextureAtlas = n(this._textTextureAtlas), this._hudMaterialCollection = n(this._hudMaterialCollection), this._calloutMaterialCollection = n(this._calloutMaterialCollection), this._labelingContexts.length = 0, this._labels.clear(), this._labelsToAdd.clear(), this._labelsToRemove.clear();\n  }\n\n  _activateLabelingContext(e) {\n    e.labels.forEach((e, t) => {\n      this._labels.set(t, e), e.graphics3DGraphic.setVisibilityFlag(0, !0, 1);\n    }), e.active = !0;\n  }\n\n  _deactivateLabelingContext(e) {\n    e.labels.forEach((e, t) => {\n      e.graphics3DGraphic.setVisibilityFlag(0, !1, 1), this.setLabelGraphicVisibility(e.graphics3DGraphic, !1), this._labels.delete(t);\n    }), e.active = !1;\n  }\n\n  _addLabelTextureToAtlas(e) {\n    for (const t of e.graphics3DGraphic.labelGraphics) {\n      if (!t._labelClass) continue;\n      const s = e.textRenderers[t._labelIndex];\n      s && this._textTextureAtlas.addTextTexture(s, t.stageObject);\n    }\n\n    e.rendered = !0;\n  }\n\n  _removeLabelTextureFromAtlas(e) {\n    for (const t of e.graphics3DGraphic.labelGraphics) {\n      if (!t._labelClass) continue;\n      const s = e.textRenderers[t._labelIndex];\n      s && this._textTextureAtlas.removeTextTexture(s, t.stageObject);\n    }\n\n    e.rendered = !1;\n  }\n\n  get running() {\n    var e;\n    return !!this.view.ready && (this._dirty || (null == (e = this._textTextureAtlas) ? void 0 : e.updating) || this.deconflictor.running);\n  }\n\n  runTask(e) {\n    this._updateLabels(e), !this._dirty && this.deconflictor.running && this.deconflictor.runTask(e);\n  }\n\n  _updateLabels(e) {\n    if (this._dirty) {\n      this._dirty = !1;\n\n      for (const t of this._labelingContexts) if (j(t)) {\n        if (!E(t)) {\n          if (V(t)) {\n            this._deactivateLabelingContext(t);\n\n            continue;\n          }\n\n          if (this._createLabelClassContext(t), P(t)) {\n            this._dirty = !0;\n            continue;\n          }\n\n          if (!E(t)) continue;\n        }\n\n        r(t.labelsToInitialize, (s, l) => (this._ensureGraphics3DResources(s) && (this._labels.set(l, s), this.deconflictor.setDirty(), e.madeProgress()), (s.visible && s.hasTextTextureResources || !s.visible && s.hasGraphics3DResources) && (t.labelsToInitialize.delete(l), e.madeProgress()), e.done)) && (this._dirty = !0);\n      }\n\n      this._labelsToRemove.forEach(e => this._removeLabelTextureFromAtlas(e)), this._labelsToAdd.forEach(e => this._addLabelTextureToAtlas(e)), this._labelsToRemove.clear(), this._labelsToAdd.clear(), this._dirty || this.notifyChange(\"updating\");\n    }\n  }\n\n  async _createLabelClassContextAsync(e) {\n    const t = e.labelClassAbortController.signal;\n    await e.layer.when(), b(t), e.scaleVisibility && e.scaleVisibility.updateScaleRangeActive();\n    const a = e.graphics3DCore,\n          i = a.layer,\n          r = i.labelingInfo && i.labelingInfo.filter(e => !!e.symbol);\n    if (!r || 0 === r.length) return;\n    const o = new Array(r.length);\n    let n = !1;\n    await s(r, async (s, i) => {\n      const r = s.symbol,\n            h = v(a.getOrCreateGraphics3DSymbol(r));\n      if (c(h)) return void I.error(\"Failed to create Graphics3DSymbol for label\");\n      await h.load(), b(t);\n      let d = null;\n      m(r) && r.hasVisibleCallout() && (d = x(r, a.symbolCreationContext), await d.load(), b(t));\n      const p = await l(f(s, e.layer.fieldsIndex, this.view.spatialReference));\n      b(t), !0 === p.ok ? o[i] = {\n        labelClass: s,\n        labelFunction: p.value,\n        graphics3DSymbol: h,\n        graphics3DCalloutSymbolLayer: d,\n        calloutSymbolLayerIndex: 0,\n        textRenderParameters: this._createTextRenderParameters(h.symbol)\n      } : (I.error(`Label expression failed to evaluate: ${p.error}`), n = !0);\n    }), b(t), n || (e.labelClassContexts = o);\n  }\n\n  async _createLabelClassContext(e) {\n    return e.labelClassPromise || (e.labelClassPromise = this._createLabelClassContextAsync(e).catch(t => {\n      if (d(t)) throw t;\n      e.labelClassContexts = null;\n    }).then(() => {\n      e.labelClassAbortController = null, this.notifyChange(\"updating\");\n    }).catch(() => {}), this.notifyChange(\"updating\")), e.labelClassPromise;\n  }\n\n  _createTextRenderParameters(e) {\n    const t = e.symbolLayers.getItemAt(0);\n    return t && \"text\" === t.type ? R.fromSymbol(t, this.view.pixelRatio) : null;\n  }\n\n  _destroyLabelClassContext(e) {\n    for (const s of e.labelClassContexts) --s.graphics3DSymbol.referenced, s.graphics3DSymbol = null;\n\n    const t = e.labelClassAbortController;\n    e.labelClassAbortController = p(), t && t.abort(), e.labelClassContexts = [], e.labelClassPromise = null, this.notifyChange(\"updating\");\n  }\n\n  _createTextSymbolGraphic(e, t, s, l, a) {\n    const i = {\n      text: e.text,\n      centerOffset: s.centerOffset,\n      translation: s.translation,\n      elevationOffset: s.elevationOffset,\n      screenOffset: s.screenOffset,\n      anchor: s.anchor,\n      centerOffsetUnits: s.centerOffsetUnits,\n      verticalOffset: s.verticalOffset,\n      debugDrawBorder: L.LABELS_SHOW_BORDER,\n      displayWidth: e.displayWidth,\n      displayHeight: e.displayHeight\n    };\n    return M.graphic = t, M.renderingInfo = null, M.layer = l, a.createLabel(M, i, this._hudMaterialCollection, this._textTextureAtlas);\n  }\n\n  _createLineCalloutGraphic(e, t, s, l, a) {\n    const i = {\n      symbol: t,\n      translation: l.translation,\n      elevationOffset: l.elevationOffset,\n      screenOffset: l.screenOffset,\n      centerOffset: l.centerOffset,\n      centerOffsetUnits: l.centerOffsetUnits,\n      materialCollection: this._calloutMaterialCollection\n    };\n    return M.graphic = e, M.renderingInfo = i, M.layer = a, s.createGraphics3DGraphic(M);\n  }\n\n  _ensureGraphics3DResources(e) {\n    if (e.hasGraphics3DResources) return !1;\n    const t = e.graphics3DGraphic;\n    if (t.destroyed) return !1;\n\n    this._ensureTextTextureResources(e);\n\n    const s = e.labelingContext,\n          l = s.labelClassContexts;\n    if (!l || 0 === l.length || !s.emptySymbolLabelSupported && 0 === t._graphics.length) return !1;\n    let a = !1;\n\n    const i = t.graphic,\n          r = s.layer,\n          o = _(s.layer),\n          n = this.view._stage;\n\n    for (let h = 0; h < l.length; h++) {\n      const b = e.textRenderers[h];\n      if (!b) continue;\n      const d = l[h],\n            p = d.graphics3DSymbol;\n      let u = null;\n      p.symbol && \"label-3d\" === p.symbol.type && (u = p.symbol);\n      const g = p.symbolLayers[0];\n      if (!g) continue;\n\n      const y = d.labelClass,\n            f = s.disablePlacement,\n            _ = T({\n        graphics3DGraphic: t,\n        labelSymbol: u,\n        labelClass: y,\n        disablePlacement: f\n      });\n\n      if (c(_)) continue;\n      g.setElevationInfoOverride(s.elevationInfoOverride);\n\n      const m = this._createTextSymbolGraphic(b, i, _, r, g);\n\n      if (!m) return !1;\n      m._labelClass = y, m._labelIndex = h, t.addLabelGraphic(m, n, s.stageLayer), t.setVisibilityFlag(0, o, 1), t.clearVisibilityFlag(1, 1), t.setVisibilityFlag(3, !1, 1), a = !0;\n      const x = d.graphics3DCalloutSymbolLayer;\n\n      if (x && _.hasLabelVerticalOffset) {\n        x.setElevationInfoOverride(s.elevationInfoOverride);\n\n        const e = this._createLineCalloutGraphic(i, u, x, _, r);\n\n        e && (d.calloutSymbolLayerIndex = t.labelGraphics.length, t.addLabelGraphic(e, n, s.stageLayer));\n      }\n\n      break;\n    }\n\n    return s.scaleVisibility && a && s.scaleVisibility.updateGraphicLabelScaleVisibility(t), e.hasGraphics3DResources = !0, !0;\n  }\n\n  _destroyGraphics3DResources(e) {\n    const t = e.labelingContext.labelClassContexts;\n\n    for (const s of e.graphics3DGraphic.labelGraphics) {\n      if (null == s._labelClass) continue;\n      const e = t[s._labelIndex].graphics3DSymbol.symbolLayers[0];\n      null != e && e.onRemoveGraphic(s);\n    }\n\n    e.graphics3DGraphic.clearLabelGraphics(), e.hasGraphics3DResources = !1;\n  }\n\n  _ensureTextTextureResources(e) {\n    if (e.hasTextTextureResources) return;\n    const t = e.labelingContext,\n          s = t.labelClassContexts;\n    if (!s || 0 === s.length) return;\n    const l = e.graphics3DGraphic.graphic;\n\n    for (let i = 0; i < s.length; i++) {\n      const r = s[i];\n      if (e.textRenderers[i] = null, !r.textRenderParameters) continue;\n      const o = r.labelFunction;\n      let n;\n      if (\"arcade\" === o.type) try {\n        const e = o.needsHydrationToEvaluate() ? y(l, t.layer) : l;\n        n = o.evaluate(e);\n      } catch (a) {\n        n = null;\n      } else n = o.evaluate(l);\n      c(n) || \"\" === n || /^\\s+$/.test(n) || (e.textRenderers[i] = new D(n, r.textRenderParameters));\n    }\n\n    e.hasTextTextureResources = !0;\n  }\n\n  _destroyTextTextureResources(e) {\n    e.textRenderers = [], e.hasTextTextureResources = !1;\n  }\n\n  _addGraphic(e, t) {\n    const s = {\n      hasGraphics3DResources: !1,\n      hasTextTextureResources: !1,\n      visible: !1,\n      rendered: !1,\n      labelingContext: e,\n      graphics3DGraphic: t,\n      textRenderers: []\n    },\n          l = t.graphic.uid;\n    e.labels.set(l, s), e.labelsToInitialize.set(l, s), this.setDirty(), this.deconflictor.setDirty();\n  }\n\n  _removeGraphic(e, t) {\n    const s = t.graphic.uid,\n          l = e.labels.get(s);\n    l && (this._destroyGraphic(l, s), e.labels.delete(s), e.labelsToInitialize.delete(s), this.setDirty(), this.deconflictor.setDirty());\n  }\n\n  _destroyGraphic(e, t) {\n    this._labels.has(t) && (this._labels.delete(t), this._labelsToAdd.delete(t), this._labelsToRemove.delete(t)), e.hasTextTextureResources && (this._removeLabelTextureFromAtlas(e), this._destroyTextTextureResources(e)), e.hasGraphics3DResources && this._destroyGraphics3DResources(e);\n  }\n\n  async _labelingInfoChange(e, t) {\n    if (!t) return this._visibilityInfoChange(e), this._resetLabels(e), this._createLabelClassContext(e);\n\n    for (const s of t) {\n      const t = e.labels.get(s);\n      t && (this._removeGraphic(e, t.graphics3DGraphic), this._addGraphic(e, t.graphics3DGraphic));\n    }\n  }\n\n  _globalPropertyChanged(e, t) {\n    for (const s of t.labelClassContexts) {\n      const l = new Map();\n      t.labels.forEach(e => {\n        const t = e.graphics3DGraphic;\n        l.set(t.graphic.uid, t);\n      });\n\n      const a = e => e.labelGraphics[0];\n\n      if (h(s.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e, l, a), s.graphics3DCalloutSymbolLayer) {\n        const t = e => e.labelGraphics[s.calloutSymbolLayerIndex];\n\n        s.graphics3DCalloutSymbolLayer.globalPropertyChanged(e, l, t);\n      }\n    }\n  }\n\n  _visibilityInfoChange(e) {\n    const t = e.layer.labelsVisible;\n    t && !e.active && this._activateLabelingContext(e), !t && e.active && this._deactivateLabelingContext(e), this.setDirty();\n  }\n\n  _resetAllLabels() {\n    for (const e of this._labelingContexts) this._resetLabels(e);\n  }\n\n  _resetLabels(e) {\n    e.labels.forEach((t, s) => {\n      this._destroyGraphic(t, s), t.visible = !1, t.rendered = !1, e.labelsToInitialize.set(s, t);\n    }), this._destroyLabelClassContext(e), this.setDirty(), this.deconflictor.setDirty();\n  }\n\n  _findLabelingContext(e) {\n    for (const t of this._labelingContexts) if (t.graphics3DCore === e) return t;\n\n    return null;\n  }\n\n  addGraphicsOwner(e, t, s) {\n    const l = s && s.emptySymbolLabelSupported || !1,\n          a = s && s.elevationInfoOverride || null,\n          i = s && s.disablePlacement || null;\n    if (this._findLabelingContext(e)) return;\n    const r = e.layer,\n          o = {\n      graphics3DCore: e,\n      layer: r,\n      scaleVisibility: t,\n      emptySymbolLabelSupported: l,\n      elevationInfoOverride: a,\n      disablePlacement: i,\n      active: r.labelsVisible,\n      labelClassPromise: null,\n      labelClassAbortController: p(),\n      labelClassContexts: [],\n      labels: new Map(),\n      labelsToInitialize: new Map(),\n      stageLayer: new A({\n        isPickable: !0\n      }, r.uid)\n    };\n    return this.view._stage.add(o.stageLayer), this._labelingContexts.push(o), this.setDirty(), {\n      addGraphic: e => this._addGraphic(o, e),\n      removeGraphic: e => this._removeGraphic(o, e),\n      featureReductionChange: () => {},\n      layerLabelsEnabled: () => _(o.layer),\n      labelingInfoChange: e => this._labelingInfoChange(o, e),\n      elevationInfoChange: () => this._globalPropertyChanged(\"elevationInfo\", o),\n      slicePlaneEnabledChange: () => this._globalPropertyChanged(\"slicePlaneEnabled\", o),\n      visibilityInfoChange: () => this._visibilityInfoChange(o),\n      reset: () => this._resetLabels(o),\n      clear: () => {}\n    };\n  }\n\n  removeGraphicsOwner(e) {\n    const t = this._findLabelingContext(e);\n\n    if (!t) return;\n\n    const s = this._labelingContexts.indexOf(t);\n\n    this._labelingContexts.splice(s, 1), t.labels.forEach(e => this._removeGraphic(t, e.graphics3DGraphic)), this.view._stage.remove(t.stageLayer), t.stageLayer = null, this.setDirty();\n  }\n\n  setLabelGraphicVisibility(e, t) {\n    const s = e.graphic.uid,\n          l = this._labels.get(s);\n\n    l && l.visible !== t && (t && !l.rendered ? (this._labelsToAdd.set(s, l), this._labelsToRemove.delete(s), l.hasTextTextureResources || l.labelingContext.labelsToInitialize.set(s, l)) : !t && l.rendered && (this._labelsToRemove.set(s, l), this._labelsToAdd.delete(s)), l.visible = t, this.setDirty());\n  }\n\n  setDirty() {\n    !this._dirty && this._labelingContexts.length > 0 && (this._dirty = !0, this.notifyChange(\"updating\"));\n  }\n\n  get updating() {\n    var e;\n    return this._dirty || (null == (e = this._textTextureAtlas) ? void 0 : e.updating) || this.deconflictor.updating || this._labelingContexts.some(e => P(e));\n  }\n\n  get updatingProgress() {\n    if (!this.updating || !this._textTextureAtlas) return 1;\n    const e = this._labelingContexts.length > 0 ? this._labelingContexts.reduce((e, t) => e + (P(t) ? 0 : 1), 0) / this._labelingContexts.length : 1;\n    return (this._dirty ? 0 : .3) + (this._textTextureAtlas.updating ? 0 : .1) + .1 * e + .5 * this.deconflictor.updatingProgress;\n  }\n\n  get test() {\n    return {\n      textTextureAtlas: this._textTextureAtlas,\n      resetAllLabels: () => this._resetAllLabels()\n    };\n  }\n\n};\n\nfunction j(e) {\n  return e.active && _(e.layer);\n}\n\nfunction P(e) {\n  return e.labelClassPromise && !!e.labelClassAbortController;\n}\n\nfunction E(e) {\n  return e.labelClassContexts && e.labelClassContexts.length;\n}\n\nfunction V(e) {\n  return null === e.labelClassContexts;\n}\n\ne([u({\n  constructOnly: !0\n})], S.prototype, \"view\", void 0), e([u({\n  constructOnly: !0\n})], S.prototype, \"deconflictor\", void 0), e([u()], S.prototype, \"_textTextureAtlas\", void 0), e([u({\n  type: Boolean,\n  readOnly: !0\n})], S.prototype, \"updating\", null), S = e([g(\"esri.views.3d.layers.graphics.Labeler\")], S);\nconst M = new C(null, null, null);\nexport { S as Labeler };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/layers/graphics/Labeler.js"],"names":["_","e","t","forEach","s","result","l","a","i","someMap","r","destroyMaybe","o","disposeMaybe","n","isNone","c","unwrap","h","throwIfAborted","b","isAbortError","d","createAbortController","p","property","u","subclass","g","hydrateGraphic","y","createLabelFunction","f","areLabelsVisible","isCalloutSupport","m","make","x","C","getGraphics3DSymbol","v","get","T","L","MaterialCollection","G","TextRenderer","D","TextRenderParameters","R","w","WebGLLayer","A","TaskPriority","O","I","getLogger","S","constructor","arguments","_dirty","_labels","Map","_labelsToAdd","_labelsToRemove","_labelingContexts","Array","setup","dispose","_handles","add","view","watch","setDirty","_resetAllLabels","resourceController","scheduler","registerTask","LABELER","_textTextureAtlas","_hudMaterialCollection","_stage","_calloutMaterialCollection","length","clear","_activateLabelingContext","labels","set","graphics3DGraphic","setVisibilityFlag","active","_deactivateLabelingContext","setLabelGraphicVisibility","delete","_addLabelTextureToAtlas","labelGraphics","_labelClass","textRenderers","_labelIndex","addTextTexture","stageObject","rendered","_removeLabelTextureFromAtlas","removeTextTexture","running","ready","updating","deconflictor","runTask","_updateLabels","j","E","V","_createLabelClassContext","P","labelsToInitialize","_ensureGraphics3DResources","madeProgress","visible","hasTextTextureResources","hasGraphics3DResources","done","notifyChange","_createLabelClassContextAsync","labelClassAbortController","signal","layer","when","scaleVisibility","updateScaleRangeActive","graphics3DCore","labelingInfo","filter","symbol","getOrCreateGraphics3DSymbol","error","load","hasVisibleCallout","symbolCreationContext","fieldsIndex","spatialReference","ok","labelClass","labelFunction","value","graphics3DSymbol","graphics3DCalloutSymbolLayer","calloutSymbolLayerIndex","textRenderParameters","_createTextRenderParameters","labelClassContexts","labelClassPromise","catch","then","symbolLayers","getItemAt","type","fromSymbol","pixelRatio","_destroyLabelClassContext","referenced","abort","_createTextSymbolGraphic","text","centerOffset","translation","elevationOffset","screenOffset","anchor","centerOffsetUnits","verticalOffset","debugDrawBorder","LABELS_SHOW_BORDER","displayWidth","displayHeight","M","graphic","renderingInfo","createLabel","_createLineCalloutGraphic","materialCollection","createGraphics3DGraphic","destroyed","_ensureTextTextureResources","labelingContext","emptySymbolLabelSupported","_graphics","disablePlacement","labelSymbol","setElevationInfoOverride","elevationInfoOverride","addLabelGraphic","stageLayer","clearVisibilityFlag","hasLabelVerticalOffset","updateGraphicLabelScaleVisibility","_destroyGraphics3DResources","onRemoveGraphic","clearLabelGraphics","needsHydrationToEvaluate","evaluate","test","_destroyTextTextureResources","_addGraphic","uid","_removeGraphic","_destroyGraphic","has","_labelingInfoChange","_visibilityInfoChange","_resetLabels","_globalPropertyChanged","globalPropertyChanged","labelsVisible","_findLabelingContext","addGraphicsOwner","isPickable","push","addGraphic","removeGraphic","featureReductionChange","layerLabelsEnabled","labelingInfoChange","elevationInfoChange","slicePlaneEnabledChange","visibilityInfoChange","reset","removeGraphicsOwner","indexOf","splice","remove","some","updatingProgress","reduce","textTextureAtlas","resetAllLabels","constructOnly","prototype","Boolean","readOnly","Labeler"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../chunks/tslib.es6.js\";import t from\"../../../../core/Accessor.js\";import{forEach as s,result as l}from\"../../../../core/asyncUtils.js\";import a from\"../../../../core/Handles.js\";import i from\"../../../../core/Logger.js\";import{someMap as r}from\"../../../../core/MapUtils.js\";import{destroyMaybe as o,disposeMaybe as n,isNone as c,unwrap as h}from\"../../../../core/maybe.js\";import{throwIfAborted as b,isAbortError as d,createAbortController as p}from\"../../../../core/promiseUtils.js\";import{property as u}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/ensureType.js\";import{subclass as g}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{hydrateGraphic as y}from\"../../../../layers/graphics/hydratedFeatures.js\";import{createLabelFunction as f}from\"../../../../layers/support/labelFormatUtils.js\";import{areLabelsVisible as _}from\"../../../../layers/support/layerUtils.js\";import{isCalloutSupport as m}from\"../../../../symbols/callouts/calloutUtils.js\";import{make as x}from\"./Graphics3DCalloutSymbolLayerFactory.js\";import C from\"./Graphics3DGraphicCreationContext.js\";import{getGraphics3DSymbol as v}from\"./graphicSymbolUtils.js\";import{get as T}from\"./labelPlacement.js\";import L from\"../../support/debugFlags.js\";import{MaterialCollection as G}from\"../../webgl-engine/lib/MaterialCollection.js\";import{TextRenderer as D}from\"../../webgl-engine/lib/TextRenderer.js\";import{TextRenderParameters as R}from\"../../webgl-engine/lib/TextRenderParameters.js\";import w from\"../../webgl-engine/lib/TextTextureAtlas.js\";import{WebGLLayer as A}from\"../../webgl-engine/lib/WebGLLayer.js\";import{TaskPriority as O}from\"../../../support/Scheduler.js\";const I=i.getLogger(\"esri.views.3d.layers.graphics.Labeler\");let S=class extends t{constructor(){super(...arguments),this._dirty=!1,this._labels=new Map,this._labelsToAdd=new Map,this._labelsToRemove=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this._handles=new a,this._handles.add([this.view.watch(\"state.camera\",(()=>this.setDirty())),this.view.watch(\"pixelRatio\",(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(O.LABELER,this)]),this._textTextureAtlas=new w({view:this.view}),this._hudMaterialCollection=new G(this.view._stage),this._calloutMaterialCollection=new G(this.view._stage)}dispose(){this._handles=o(this._handles),this._textTextureAtlas=n(this._textTextureAtlas),this._hudMaterialCollection=n(this._hudMaterialCollection),this._calloutMaterialCollection=n(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()}_activateLabelingContext(e){e.labels.forEach(((e,t)=>{this._labels.set(t,e),e.graphics3DGraphic.setVisibilityFlag(0,!0,1)})),e.active=!0}_deactivateLabelingContext(e){e.labels.forEach(((e,t)=>{e.graphics3DGraphic.setVisibilityFlag(0,!1,1),this.setLabelGraphicVisibility(e.graphics3DGraphic,!1),this._labels.delete(t)})),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const s=e.textRenderers[t._labelIndex];s&&this._textTextureAtlas.addTextTexture(s,t.stageObject)}e.rendered=!0}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const s=e.textRenderers[t._labelIndex];s&&this._textTextureAtlas.removeTextTexture(s,t.stageObject)}e.rendered=!1}get running(){var e;return!!this.view.ready&&(this._dirty||(null==(e=this._textTextureAtlas)?void 0:e.updating)||this.deconflictor.running)}runTask(e){this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e)}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(j(t)){if(!E(t)){if(V(t)){this._deactivateLabelingContext(t);continue}if(this._createLabelClassContext(t),P(t)){this._dirty=!0;continue}if(!E(t))continue}r(t.labelsToInitialize,((s,l)=>(this._ensureGraphics3DResources(s)&&(this._labels.set(l,s),this.deconflictor.setDirty(),e.madeProgress()),(s.visible&&s.hasTextTextureResources||!s.visible&&s.hasGraphics3DResources)&&(t.labelsToInitialize.delete(l),e.madeProgress()),e.done)))&&(this._dirty=!0)}this._labelsToRemove.forEach((e=>this._removeLabelTextureFromAtlas(e))),this._labelsToAdd.forEach((e=>this._addLabelTextureToAtlas(e))),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange(\"updating\")}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController.signal;await e.layer.when(),b(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const a=e.graphics3DCore,i=a.layer,r=i.labelingInfo&&i.labelingInfo.filter((e=>!!e.symbol));if(!r||0===r.length)return;const o=new Array(r.length);let n=!1;await s(r,(async(s,i)=>{const r=s.symbol,h=v(a.getOrCreateGraphics3DSymbol(r));if(c(h))return void I.error(\"Failed to create Graphics3DSymbol for label\");await h.load(),b(t);let d=null;m(r)&&r.hasVisibleCallout()&&(d=x(r,a.symbolCreationContext),await d.load(),b(t));const p=await l(f(s,e.layer.fieldsIndex,this.view.spatialReference));b(t),!0===p.ok?o[i]={labelClass:s,labelFunction:p.value,graphics3DSymbol:h,graphics3DCalloutSymbolLayer:d,calloutSymbolLayerIndex:0,textRenderParameters:this._createTextRenderParameters(h.symbol)}:(I.error(`Label expression failed to evaluate: ${p.error}`),n=!0)})),b(t),n||(e.labelClassContexts=o)}async _createLabelClassContext(e){return e.labelClassPromise||(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if(d(t))throw t;e.labelClassContexts=null})).then((()=>{e.labelClassAbortController=null,this.notifyChange(\"updating\")})).catch((()=>{})),this.notifyChange(\"updating\")),e.labelClassPromise}_createTextRenderParameters(e){const t=e.symbolLayers.getItemAt(0);return t&&\"text\"===t.type?R.fromSymbol(t,this.view.pixelRatio):null}_destroyLabelClassContext(e){for(const s of e.labelClassContexts)--s.graphics3DSymbol.referenced,s.graphics3DSymbol=null;const t=e.labelClassAbortController;e.labelClassAbortController=p(),t&&t.abort(),e.labelClassContexts=[],e.labelClassPromise=null,this.notifyChange(\"updating\")}_createTextSymbolGraphic(e,t,s,l,a){const i={text:e.text,centerOffset:s.centerOffset,translation:s.translation,elevationOffset:s.elevationOffset,screenOffset:s.screenOffset,anchor:s.anchor,centerOffsetUnits:s.centerOffsetUnits,verticalOffset:s.verticalOffset,debugDrawBorder:L.LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return M.graphic=t,M.renderingInfo=null,M.layer=l,a.createLabel(M,i,this._hudMaterialCollection,this._textTextureAtlas)}_createLineCalloutGraphic(e,t,s,l,a){const i={symbol:t,translation:l.translation,elevationOffset:l.elevationOffset,screenOffset:l.screenOffset,centerOffset:l.centerOffset,centerOffsetUnits:l.centerOffsetUnits,materialCollection:this._calloutMaterialCollection};return M.graphic=e,M.renderingInfo=i,M.layer=a,s.createGraphics3DGraphic(M)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const s=e.labelingContext,l=s.labelClassContexts;if(!l||0===l.length||!s.emptySymbolLabelSupported&&0===t._graphics.length)return!1;let a=!1;const i=t.graphic,r=s.layer,o=_(s.layer),n=this.view._stage;for(let h=0;h<l.length;h++){const b=e.textRenderers[h];if(!b)continue;const d=l[h],p=d.graphics3DSymbol;let u=null;p.symbol&&\"label-3d\"===p.symbol.type&&(u=p.symbol);const g=p.symbolLayers[0];if(!g)continue;const y=d.labelClass,f=s.disablePlacement,_=T({graphics3DGraphic:t,labelSymbol:u,labelClass:y,disablePlacement:f});if(c(_))continue;g.setElevationInfoOverride(s.elevationInfoOverride);const m=this._createTextSymbolGraphic(b,i,_,r,g);if(!m)return!1;m._labelClass=y,m._labelIndex=h,t.addLabelGraphic(m,n,s.stageLayer),t.setVisibilityFlag(0,o,1),t.clearVisibilityFlag(1,1),t.setVisibilityFlag(3,!1,1),a=!0;const x=d.graphics3DCalloutSymbolLayer;if(x&&_.hasLabelVerticalOffset){x.setElevationInfoOverride(s.elevationInfoOverride);const e=this._createLineCalloutGraphic(i,u,x,_,r);e&&(d.calloutSymbolLayerIndex=t.labelGraphics.length,t.addLabelGraphic(e,n,s.stageLayer))}break}return s.scaleVisibility&&a&&s.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const s of e.graphics3DGraphic.labelGraphics){if(null==s._labelClass)continue;const e=t[s._labelIndex].graphics3DSymbol.symbolLayers[0];null!=e&&e.onRemoveGraphic(s)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.hasTextTextureResources)return;const t=e.labelingContext,s=t.labelClassContexts;if(!s||0===s.length)return;const l=e.graphics3DGraphic.graphic;for(let i=0;i<s.length;i++){const r=s[i];if(e.textRenderers[i]=null,!r.textRenderParameters)continue;const o=r.labelFunction;let n;if(\"arcade\"===o.type)try{const e=o.needsHydrationToEvaluate()?y(l,t.layer):l;n=o.evaluate(e)}catch(a){n=null}else n=o.evaluate(l);c(n)||\"\"===n||/^\\s+$/.test(n)||(e.textRenderers[i]=new D(n,r.textRenderParameters))}e.hasTextTextureResources=!0}_destroyTextTextureResources(e){e.textRenderers=[],e.hasTextTextureResources=!1}_addGraphic(e,t){const s={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textRenderers:[]},l=t.graphic.uid;e.labels.set(l,s),e.labelsToInitialize.set(l,s),this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,t){const s=t.graphic.uid,l=e.labels.get(s);l&&(this._destroyGraphic(l,s),e.labels.delete(s),e.labelsToInitialize.delete(s),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.has(t)&&(this._labels.delete(t),this._labelsToAdd.delete(t),this._labelsToRemove.delete(t)),e.hasTextTextureResources&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const s of t){const t=e.labels.get(s);t&&(this._removeGraphic(e,t.graphics3DGraphic),this._addGraphic(e,t.graphics3DGraphic))}}_globalPropertyChanged(e,t){for(const s of t.labelClassContexts){const l=new Map;t.labels.forEach((e=>{const t=e.graphics3DGraphic;l.set(t.graphic.uid,t)}));const a=e=>e.labelGraphics[0];if(h(s.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,l,a),s.graphics3DCalloutSymbolLayer){const t=e=>e.labelGraphics[s.calloutSymbolLayerIndex];s.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,l,t)}}}_visibilityInfoChange(e){const t=e.layer.labelsVisible;t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.labels.forEach(((t,s)=>{this._destroyGraphic(t,s),t.visible=!1,t.rendered=!1,e.labelsToInitialize.set(s,t)})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,s){const l=s&&s.emptySymbolLabelSupported||!1,a=s&&s.elevationInfoOverride||null,i=s&&s.disablePlacement||null;if(this._findLabelingContext(e))return;const r=e.layer,o={graphics3DCore:e,layer:r,scaleVisibility:t,emptySymbolLabelSupported:l,elevationInfoOverride:a,disablePlacement:i,active:r.labelsVisible,labelClassPromise:null,labelClassAbortController:p(),labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new A({isPickable:!0},r.uid)};return this.view._stage.add(o.stageLayer),this._labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this._addGraphic(o,e),removeGraphic:e=>this._removeGraphic(o,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>_(o.layer),labelingInfoChange:e=>this._labelingInfoChange(o,e),elevationInfoChange:()=>this._globalPropertyChanged(\"elevationInfo\",o),slicePlaneEnabledChange:()=>this._globalPropertyChanged(\"slicePlaneEnabled\",o),visibilityInfoChange:()=>this._visibilityInfoChange(o),reset:()=>this._resetLabels(o),clear:()=>{}}}removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const s=this._labelingContexts.indexOf(t);this._labelingContexts.splice(s,1),t.labels.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this.view._stage.remove(t.stageLayer),t.stageLayer=null,this.setDirty()}setLabelGraphicVisibility(e,t){const s=e.graphic.uid,l=this._labels.get(s);l&&l.visible!==t&&(t&&!l.rendered?(this._labelsToAdd.set(s,l),this._labelsToRemove.delete(s),l.hasTextTextureResources||l.labelingContext.labelsToInitialize.set(s,l)):!t&&l.rendered&&(this._labelsToRemove.set(s,l),this._labelsToAdd.delete(s)),l.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange(\"updating\"))}get updating(){var e;return this._dirty||(null==(e=this._textTextureAtlas)?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some((e=>P(e)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(P(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function j(e){return e.active&&_(e.layer)}function P(e){return e.labelClassPromise&&!!e.labelClassAbortController}function E(e){return e.labelClassContexts&&e.labelClassContexts.length}function V(e){return null===e.labelClassContexts}e([u({constructOnly:!0})],S.prototype,\"view\",void 0),e([u({constructOnly:!0})],S.prototype,\"deconflictor\",void 0),e([u()],S.prototype,\"_textTextureAtlas\",void 0),e([u({type:Boolean,readOnly:!0})],S.prototype,\"updating\",null),S=e([g(\"esri.views.3d.layers.graphics.Labeler\")],S);const M=new C(null,null,null);export{S as Labeler};\n"]},"metadata":{},"sourceType":"module"}