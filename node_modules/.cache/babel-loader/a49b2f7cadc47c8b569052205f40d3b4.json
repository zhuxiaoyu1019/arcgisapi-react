{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../../core/Error.js\";\nimport { sign as t, acosClamped as i, reciprocalClamped as r } from \"../../../../core/mathUtils.js\";\nimport { isSome as s, get as a } from \"../../../../core/maybe.js\";\nimport { s as o } from \"../../../../chunks/mat2.js\";\nimport { s as n, b as l } from \"../../../../chunks/vec2.js\";\nimport { f as h } from \"../../../../chunks/vec2f64.js\";\nimport { s as c, b as p, d as m, c as d, a as f, n as u, o as y, f as g } from \"../../../../chunks/vec3.js\";\nimport { c as _ } from \"../../../../chunks/vec3f32.js\";\nimport { d as b, c as v } from \"../../../../chunks/vec3f64.js\";\nimport { projectBuffer as x } from \"../../../../geometry/projection.js\";\nimport { create as w, empty as S, expandWithBuffer as D, intersectsClippingArea as P } from \"../../../../geometry/support/aaBoundingBox.js\";\nimport \"../../../../layers/graphics/dehydratedFeatures.js\";\nimport { needsElevationUpdates3D as R, evaluateElevationAlignmentAtPoint as V } from \"./elevationAlignmentUtils.js\";\nimport { ElevationContext as j } from \"./ElevationContext.js\";\nimport { Graphics3DObject3DGraphicLayer as C } from \"./Graphics3DObject3DGraphicLayer.js\";\nimport { Graphics3DSymbolLayer as A, getAttributeValue as L } from \"./Graphics3DSymbolLayer.js\";\nimport { isValidSize as z } from \"./graphicUtils.js\";\nimport { initFastSymbolUpdatesState as E, updateFastSymbolUpdatesState as U } from \"../support/FastSymbolUpdates.js\";\nimport { Object3D as k } from \"../../webgl-engine/lib/Object3D.js\";\nimport { PathGeometry as F, isPathGeometry as G } from \"../../webgl-engine/lib/PathGeometry.js\";\nimport { Profile as I, SimpleExtruder as M, MiterExtruder as O, RoundCapBuilder as B, TriangulationCapBuilder as q, NoCapBuilder as H, Path as T, Builder as N, FastUpdatePathGeometry as W, StaticPathGeometry as Z, computeMinimumRotationTangentFrame as J, vertexSpaceToProfileSpace as K, PathVertex as Q } from \"../../webgl-engine/lib/pathGeometryUtils.js\";\nimport { DefaultMaterial as X } from \"../../webgl-engine/materials/DefaultMaterial.js\";\nimport { PathMaterial as Y } from \"../../webgl-engine/materials/PathMaterial.js\";\nconst $ = [\"polyline\"];\n\nclass ee extends A {\n  constructor(e, t, i, r) {\n    super(e, t, i, r), this._intrinsicSize = h(1, 1), this.upVectorAlignment = \"path\", this.stencilWidth = .1, this.ensureDrapedStatus(!1);\n  }\n\n  async doLoad() {\n    const t = s(this.symbolLayer.width) ? this.symbolLayer.width : s(this.symbolLayer.height) ? this.symbolLayer.height : this.symbolLayer.size,\n          i = s(this.symbolLayer.height) ? this.symbolLayer.height : t;\n    this._vvConvertOptions = {\n      modelSize: [1, 1, 1],\n      symbolSize: [t, 1, i],\n      unitInMeters: this._context.renderCoordsHelper.unitInMeters,\n      transformation: {\n        anchor: [0, 0, 0],\n        scale: [1, 1, 1],\n        rotation: [0, 0, 0]\n      },\n      supportedTypes: {\n        size: !0,\n        color: !0,\n        opacity: !0,\n        rotation: !1\n      }\n    }, this._context.renderer && this._context.renderer.visualVariables && this._context.renderer.visualVariables.length > 0 ? this._fastUpdates = E(this._context.renderer, this._vvConvertOptions) : this._fastUpdates = {\n      enabled: !1\n    };\n    const r = this.symbolLayer.anchor || \"center\";\n    this.upVectorAlignment = \"path\", \"heading\" === this.symbolLayer.profileRotation && (this.upVectorAlignment = \"world\");\n    const o = this.symbolLayer.profile || \"circle\";\n\n    switch (o) {\n      case \"circle\":\n      default:\n        this._profile = I.circle(ce);\n        break;\n\n      case \"quad\":\n        this._profile = I.rect();\n    }\n\n    let h = [0, 0];\n    \"center\" !== r && (h = {\n      left: [.5, 0],\n      right: [-.5, 0],\n      top: [0, -.5],\n      bottom: [0, .5]\n    }[r], this._profile.translate(h[0], h[1]));\n\n    switch (this.symbolLayer.join || \"simple\") {\n      case \"round\":\n        this._extruder = new O(0, le);\n        break;\n\n      case \"bevel\":\n        this._extruder = new O(0, 1);\n        break;\n\n      case \"miter\":\n        this._extruder = new O(.8 * Math.PI, 1);\n        break;\n\n      case \"simple\":\n      default:\n        this._extruder = new M();\n    }\n\n    const c = this.symbolLayer.cap || \"butt\";\n\n    switch (c) {\n      case \"none\":\n        this._startCap = new H(), this._endCap = new H();\n        break;\n\n      case \"butt\":\n      default:\n        this._startCap = new q(this._profile, 0), this._endCap = new q(this._profile, 0, !0);\n        break;\n\n      case \"square\":\n        this._startCap = new q(this._profile, -.5), this._endCap = new q(this._profile, .5, !0);\n        break;\n\n      case \"round\":\n        {\n          const e = \"quad\" === o;\n          this._startCap = new B({\n            profile: this._profile,\n            flip: !1,\n            breakNormals: e,\n            subdivisions: he\n          }), this._endCap = new B({\n            profile: this._profile,\n            flip: !0,\n            breakNormals: e,\n            subdivisions: he\n          });\n          break;\n        }\n    }\n\n    const p = a(this.symbolLayer, \"material\", \"color\"),\n          m = this._getCombinedOpacityAndColor(p),\n          d = b(m),\n          f = m[3],\n          u = f < 1 || this.needsDrivenTransparentPass,\n          y = {\n      diffuse: d,\n      ambient: d,\n      opacity: f,\n      transparent: u,\n      vertexColors: !1,\n      slicePlaneEnabled: this._context.slicePlaneEnabled,\n      castShadows: this.symbolLayer.castShadows,\n      cullFace: u || \"none\" === c ? 0 : 2,\n      offsetTransparentBackfaces: !0\n    };\n\n    if (!this._drivenProperties.size && (n(this._intrinsicSize, t, i), !z(this._intrinsicSize[0]) || !z(this._intrinsicSize[1]))) throw new e(\"graphics3dpathsymbollayer:invalid-size\", \"Symbol sizes may not be negative values\");\n    this._fastUpdates.enabled && this._fastUpdates.visualVariables.size || l(this._intrinsicSize, this._intrinsicSize, 1 / this._context.renderCoordsHelper.unitInMeters), this._fastUpdates.enabled ? (Object.assign(y, this._fastUpdates.materialParameters, {\n      size: [this._intrinsicSize[0], this._intrinsicSize[1], 0]\n    }), this._material = new Y(y)) : (y.vertexColors = this._drivenProperties.color || this._drivenProperties.opacity, this._material = new X(y)), this._material.setParameterValues({\n      usePBR: this._context.physicalBasedRenderingEnabled,\n      isSchematic: !0\n    }), this._context.stage.add(this._material);\n  }\n\n  destroy() {\n    super.destroy(), this._context.stage.remove(this._material), this._material = null;\n  }\n\n  createGraphics3DGraphic(e) {\n    const t = e.graphic;\n    if (!this._validateGeometry(t.geometry, $, this.symbolLayer.type)) return null;\n    const i = this.setGraphicElevationContext(t, new j()),\n          r = e.renderingInfo;\n    return this._createAs3DShape(t, r, i, t.uid);\n  }\n\n  layerOpacityChanged() {\n    const e = a(this.symbolLayer, \"material\", \"color\"),\n          t = this._getCombinedOpacity(e),\n          i = t < 1 || this.needsDrivenTransparentPass;\n\n    return this._material.setParameterValues({\n      opacity: t,\n      transparent: i\n    }), !0;\n  }\n\n  layerElevationInfoChanged(e, t) {\n    return this.updateGraphics3DGraphicElevationInfo(e, t, R);\n  }\n\n  slicePlaneEnabledChanged() {\n    return this._material.setParameterValues({\n      slicePlaneEnabled: this._context.slicePlaneEnabled\n    }), !0;\n  }\n\n  physicalBasedRenderingChanged() {\n    return this._material.setParameterValues({\n      usePBR: this._context.physicalBasedRenderingEnabled,\n      isSchematic: !0\n    }), !0;\n  }\n\n  pixelRatioChanged() {\n    return !0;\n  }\n\n  applyRendererDiff(e, t) {\n    for (const i in e.diff) switch (i) {\n      case \"visualVariables\":\n        if (!U(this._fastUpdates, t, this._vvConvertOptions)) return !1;\n\n        this._material.setParameterValues(this._fastUpdates.materialParameters);\n\n        break;\n\n      default:\n        return !1;\n    }\n\n    return !0;\n  }\n\n  getVertexData(e) {\n    let t = 0;\n    const i = e.paths,\n          r = [],\n          s = e.spatialReference,\n          a = this._context.elevationProvider.spatialReference,\n          o = this._context.renderCoordsHelper.spatialReference;\n\n    for (const m of i) t += m.length;\n\n    const n = new Float64Array(3 * t),\n          l = new Float64Array(3 * t),\n          h = new Float64Array(3 * t);\n    let c = 0;\n\n    for (const m of i) {\n      r.push({\n        index: c,\n        numVertices: m.length\n      });\n\n      for (const t of m) n[c++] = t[0], n[c++] = t[1], n[c++] = e.hasZ ? t[2] : 0;\n    }\n\n    let p = !0;\n    return s.equals(a) ? this._copyVertices(n, 0, l, 0, t) : p = x(n, s, 0, l, a, 0, t), a.equals(o) ? this._copyVertices(l, 0, h, 0, t) : x(l, a, 0, h, o, 0, t), {\n      pathVertexDataInfos: r,\n      vertexDataGS: n,\n      vertexDataES: l,\n      vertexDataRS: h,\n      projectionSuccess: p,\n      terrainElevation: 0\n    };\n  }\n\n  _copyVertices(e, t, i, r, s) {\n    t *= 3, r *= 3;\n\n    for (let a = 0; a < s; ++a) i[r++] = e[t++], i[r++] = e[t++], i[r++] = e[t++];\n  }\n\n  _createAs3DShape(e, t, i, r) {\n    const a = e.geometry,\n          o = new Array(),\n          n = new Array(),\n          l = new Array(),\n          h = a.spatialReference,\n          p = w(),\n          m = this._context.renderCoordsHelper,\n          d = this.getVertexData(a);\n    if (!d.projectionSuccess) return this.logger.warn(\"PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)\"), null;\n\n    if (d.pathVertexDataInfos.length > 0) {\n      for (let r = 0; r < d.pathVertexDataInfos.length; ++r) {\n        const a = d.pathVertexDataInfos[r],\n              f = a.index,\n              u = a.numVertices;\n        if (u < 2) continue;\n        if (s(this._context.clippingExtent) && (S(p), D(p, d.vertexDataES, 3 * f, u), !P(p, this._context.clippingExtent))) continue;\n        const y = [];\n\n        for (let e = f; e < f + 3 * u;) {\n          const t = e++,\n                r = e++,\n                s = e++,\n                a = new Q();\n          c(a.posGS, d.vertexDataGS[t], d.vertexDataGS[r], d.vertexDataGS[s]), c(a.posES, d.vertexDataES[t], d.vertexDataES[r], d.vertexDataES[s]);\n          const o = V(a.posES, this._context.elevationProvider, i, m, null);\n          c(ae, d.vertexDataRS[t], d.vertexDataRS[r], d.vertexDataRS[s]), m.setAltitude(ae, o), c(a.pos, ae[0], ae[1], ae[2]), y.push(a);\n        }\n\n        const g = new T(y);\n        te(g, this.upVectorAlignment, this._context.renderCoordsHelper);\n\n        const _ = new N(g, this._profile, this._extruder, this._startCap, this._endCap);\n\n        let b = null;\n\n        if (this._fastUpdates.enabled) {\n          const t = this._fastUpdates.visualVariables,\n                i = t.size ? L(t.size.field, e) : 0,\n                r = t.color ? L(t.color.field, e) : 0,\n                s = t.opacity ? L(t.opacity.field, e) : 0;\n          b = new W(_, i, r, s);\n        } else {\n          const e = [this._intrinsicSize[0], this._intrinsicSize[1]];\n          this._drivenProperties.size && (e[0] *= ie(t.size[0], \"symbol-value\" === t.size[2] ? this.symbolLayer.height || 0 : t.size[2], this.symbolLayer.width || 0), e[1] *= ie(t.size[2], \"symbol-value\" === t.size[0] ? this.symbolLayer.width || 0 : t.size[0], this.symbolLayer.height || 0));\n          let i = null;\n          this._drivenProperties.color && (i = t.color), this._drivenProperties.opacity && null != t.opacity && (i = i ? [i[0], i[1], i[2], t.opacity] : [1, 1, 1, t.opacity]);\n          const r = new Z(_);\n          r.bake(e), i && r.bakeVertexColors(i), b = r;\n        }\n\n        const {\n          vertexAttributes: v,\n          indices: x\n        } = b.createGeometryData(),\n              w = new F(v, x, b, h, this.upVectorAlignment, this.stencilWidth);\n        o.push(w), n.push(this._material), l.push(b.xform);\n      }\n\n      if (o.length > 0) {\n        const e = {\n          layerUid: this._context.layer.uid,\n          graphicUid: r\n        },\n              t = new k({\n          geometries: o,\n          materials: n,\n          transformations: l,\n          metadata: e\n        }),\n              s = new C(this, t, o, null, null, se, i);\n        return s.alignedSampledElevation = d.terrainElevation, s.needsElevationUpdates = R(i.mode), s;\n      }\n    } else 0 !== a.paths.length && a.paths.some(e => e.length > 0) || this.logger.warn(\"PathSymbol3DLayer geometry failed to be created (no paths were defined)\");\n\n    return null;\n  }\n\n}\n\nfunction te(e, s, a) {\n  switch (s) {\n    case \"world\":\n      for (const t of e.vertices) p(oe, t.pos, e.offset), a.worldUpAtPosition(oe, ae), t.setFrameFromUpVector(ae), t.computeRotationAxisAndAngleFromUpVector();\n\n      break;\n\n    case \"path\":\n      p(oe, e.vertices[0].pos, e.offset), a.worldUpAtPosition(oe, ae), J(e, ae);\n\n      for (const s of e.vertices) {\n        const e = t(m(s.frame.right, s.vRight));\n        d(s.rotationFrame.up, s.vRight, s.vLeft), f(s.rotationFrame.up, s.rotationFrame.up, e), u(s.rotationFrame.up, s.rotationFrame.up);\n        const a = m(s.rotationFrame.up, s.frame.up),\n              n = m(s.rotationFrame.up, s.frame.right);\n\n        if (f(oe, s.frame.up, -n), f(ne, s.frame.right, a), p(oe, oe, ne), u(s.rotationFrame.right, oe), K(s.rotationRight, s.frame, s.rotationFrame.right), y(oe, s.vLeft), s.rotationAngle = -e * (Math.PI - i(m(oe, s.vRight))), Math.abs(s.rotationAngle) > 0) {\n          const e = r(Math.cos(.5 * s.rotationAngle));\n          o(s.miterStretch, 1 + (e - 1) * s.rotationRight[0] * s.rotationRight[0], (e - 1) * s.rotationRight[0] * s.rotationRight[1], (e - 1) * s.rotationRight[0] * s.rotationRight[1], 1 + (e - 1) * s.rotationRight[1] * s.rotationRight[1]);\n        }\n\n        const l = Math.PI - s.rotationAngle;\n        s.maxStretchDistance = Math.abs(Math.min(s.vLeftLength, s.vRightLength) * r(Math.cos(.5 * l)));\n      }\n\n  }\n}\n\nfunction ie(e, t, i) {\n  switch (e) {\n    case \"symbol-value\":\n      return i;\n\n    case \"proportional\":\n      return t;\n\n    default:\n      return e;\n  }\n}\n\nfunction re(e, t, i, r) {\n  let s = 0;\n\n  for (const a of e.vertices) {\n    const o = V(a.posES, i, t, r, pe);\n    s += pe.sampledElevation, p(ae, a.pos, e.offset), r.setAltitude(ae, o), g(a.pos, ae, e.offset);\n  }\n\n  return e.updatePathVertexInformation(), s / e.vertices.length;\n}\n\nfunction se(e, t, i, r) {\n  const s = e.stageObject,\n        a = s.geometryRecords,\n        o = a.length;\n  let n = 0;\n  r.spatialReference;\n\n  for (let l = 0; l < o; l++) {\n    const e = a[l].geometry;\n    if (!G(e)) continue;\n    const o = e.path,\n          h = o.builder.path;\n    e.geometrySR, n += re(h, t, i, r), \"world\" !== e.upVectorAlignment && te(h, e.upVectorAlignment, r), o.onPathChanged(), e.invalidateBoundingInfo(), s.geometryVertexAttrsUpdated(l);\n  }\n\n  return n / o;\n}\n\nconst ae = v(),\n      oe = _(),\n      ne = _(),\n      le = 3,\n      he = 3,\n      ce = 10,\n      pe = {\n  verticalDistanceToGround: 0,\n  sampledElevation: 0\n};\n\nexport default ee;\nexport { ee as Graphics3DPathSymbolLayer, ce as NUM_CIRCLE_PROFILE_SUBDIVISIONS, he as NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS, le as NUM_ROUND_JOIN_SUBDIVISIONS };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/layers/graphics/Graphics3DPathSymbolLayer.js"],"names":["e","sign","t","acosClamped","i","reciprocalClamped","r","isSome","s","get","a","o","n","b","l","f","h","c","p","d","m","u","y","g","_","v","projectBuffer","x","create","w","empty","S","expandWithBuffer","D","intersectsClippingArea","P","needsElevationUpdates3D","R","evaluateElevationAlignmentAtPoint","V","ElevationContext","j","Graphics3DObject3DGraphicLayer","C","Graphics3DSymbolLayer","A","getAttributeValue","L","isValidSize","z","initFastSymbolUpdatesState","E","updateFastSymbolUpdatesState","U","Object3D","k","PathGeometry","F","isPathGeometry","G","Profile","I","SimpleExtruder","M","MiterExtruder","O","RoundCapBuilder","B","TriangulationCapBuilder","q","NoCapBuilder","H","Path","T","Builder","N","FastUpdatePathGeometry","W","StaticPathGeometry","Z","computeMinimumRotationTangentFrame","J","vertexSpaceToProfileSpace","K","PathVertex","Q","DefaultMaterial","X","PathMaterial","Y","$","ee","constructor","_intrinsicSize","upVectorAlignment","stencilWidth","ensureDrapedStatus","doLoad","symbolLayer","width","height","size","_vvConvertOptions","modelSize","symbolSize","unitInMeters","_context","renderCoordsHelper","transformation","anchor","scale","rotation","supportedTypes","color","opacity","renderer","visualVariables","length","_fastUpdates","enabled","profileRotation","profile","_profile","circle","ce","rect","left","right","top","bottom","translate","join","_extruder","le","Math","PI","cap","_startCap","_endCap","flip","breakNormals","subdivisions","he","_getCombinedOpacityAndColor","needsDrivenTransparentPass","diffuse","ambient","transparent","vertexColors","slicePlaneEnabled","castShadows","cullFace","offsetTransparentBackfaces","_drivenProperties","Object","assign","materialParameters","_material","setParameterValues","usePBR","physicalBasedRenderingEnabled","isSchematic","stage","add","destroy","remove","createGraphics3DGraphic","graphic","_validateGeometry","geometry","type","setGraphicElevationContext","renderingInfo","_createAs3DShape","uid","layerOpacityChanged","_getCombinedOpacity","layerElevationInfoChanged","updateGraphics3DGraphicElevationInfo","slicePlaneEnabledChanged","physicalBasedRenderingChanged","pixelRatioChanged","applyRendererDiff","diff","getVertexData","paths","spatialReference","elevationProvider","Float64Array","push","index","numVertices","hasZ","equals","_copyVertices","pathVertexDataInfos","vertexDataGS","vertexDataES","vertexDataRS","projectionSuccess","terrainElevation","Array","logger","warn","clippingExtent","posGS","posES","ae","setAltitude","pos","te","field","ie","bake","bakeVertexColors","vertexAttributes","indices","createGeometryData","xform","layerUid","layer","graphicUid","geometries","materials","transformations","metadata","se","alignedSampledElevation","needsElevationUpdates","mode","some","vertices","oe","offset","worldUpAtPosition","setFrameFromUpVector","computeRotationAxisAndAngleFromUpVector","frame","vRight","rotationFrame","up","vLeft","ne","rotationRight","rotationAngle","abs","cos","miterStretch","maxStretchDistance","min","vLeftLength","vRightLength","re","pe","sampledElevation","updatePathVertexInformation","stageObject","geometryRecords","path","builder","geometrySR","onPathChanged","invalidateBoundingInfo","geometryVertexAttrsUpdated","verticalDistanceToGround","Graphics3DPathSymbolLayer","NUM_CIRCLE_PROFILE_SUBDIVISIONS","NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS","NUM_ROUND_JOIN_SUBDIVISIONS"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../../core/Error.js\";import{sign as t,acosClamped as i,reciprocalClamped as r}from\"../../../../core/mathUtils.js\";import{isSome as s,get as a}from\"../../../../core/maybe.js\";import{s as o}from\"../../../../chunks/mat2.js\";import{s as n,b as l}from\"../../../../chunks/vec2.js\";import{f as h}from\"../../../../chunks/vec2f64.js\";import{s as c,b as p,d as m,c as d,a as f,n as u,o as y,f as g}from\"../../../../chunks/vec3.js\";import{c as _}from\"../../../../chunks/vec3f32.js\";import{d as b,c as v}from\"../../../../chunks/vec3f64.js\";import{projectBuffer as x}from\"../../../../geometry/projection.js\";import{create as w,empty as S,expandWithBuffer as D,intersectsClippingArea as P}from\"../../../../geometry/support/aaBoundingBox.js\";import\"../../../../layers/graphics/dehydratedFeatures.js\";import{needsElevationUpdates3D as R,evaluateElevationAlignmentAtPoint as V}from\"./elevationAlignmentUtils.js\";import{ElevationContext as j}from\"./ElevationContext.js\";import{Graphics3DObject3DGraphicLayer as C}from\"./Graphics3DObject3DGraphicLayer.js\";import{Graphics3DSymbolLayer as A,getAttributeValue as L}from\"./Graphics3DSymbolLayer.js\";import{isValidSize as z}from\"./graphicUtils.js\";import{initFastSymbolUpdatesState as E,updateFastSymbolUpdatesState as U}from\"../support/FastSymbolUpdates.js\";import{Object3D as k}from\"../../webgl-engine/lib/Object3D.js\";import{PathGeometry as F,isPathGeometry as G}from\"../../webgl-engine/lib/PathGeometry.js\";import{Profile as I,SimpleExtruder as M,MiterExtruder as O,RoundCapBuilder as B,TriangulationCapBuilder as q,NoCapBuilder as H,Path as T,Builder as N,FastUpdatePathGeometry as W,StaticPathGeometry as Z,computeMinimumRotationTangentFrame as J,vertexSpaceToProfileSpace as K,PathVertex as Q}from\"../../webgl-engine/lib/pathGeometryUtils.js\";import{DefaultMaterial as X}from\"../../webgl-engine/materials/DefaultMaterial.js\";import{PathMaterial as Y}from\"../../webgl-engine/materials/PathMaterial.js\";const $=[\"polyline\"];class ee extends A{constructor(e,t,i,r){super(e,t,i,r),this._intrinsicSize=h(1,1),this.upVectorAlignment=\"path\",this.stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){const t=s(this.symbolLayer.width)?this.symbolLayer.width:s(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size,i=s(this.symbolLayer.height)?this.symbolLayer.height:t;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[t,1,i],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=E(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1};const r=this.symbolLayer.anchor||\"center\";this.upVectorAlignment=\"path\",\"heading\"===this.symbolLayer.profileRotation&&(this.upVectorAlignment=\"world\");const o=this.symbolLayer.profile||\"circle\";switch(o){case\"circle\":default:this._profile=I.circle(ce);break;case\"quad\":this._profile=I.rect()}let h=[0,0];\"center\"!==r&&(h={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[r],this._profile.translate(h[0],h[1]));switch(this.symbolLayer.join||\"simple\"){case\"round\":this._extruder=new O(0,le);break;case\"bevel\":this._extruder=new O(0,1);break;case\"miter\":this._extruder=new O(.8*Math.PI,1);break;case\"simple\":default:this._extruder=new M}const c=this.symbolLayer.cap||\"butt\";switch(c){case\"none\":this._startCap=new H,this._endCap=new H;break;case\"butt\":default:this._startCap=new q(this._profile,0),this._endCap=new q(this._profile,0,!0);break;case\"square\":this._startCap=new q(this._profile,-.5),this._endCap=new q(this._profile,.5,!0);break;case\"round\":{const e=\"quad\"===o;this._startCap=new B({profile:this._profile,flip:!1,breakNormals:e,subdivisions:he}),this._endCap=new B({profile:this._profile,flip:!0,breakNormals:e,subdivisions:he});break}}const p=a(this.symbolLayer,\"material\",\"color\"),m=this._getCombinedOpacityAndColor(p),d=b(m),f=m[3],u=f<1||this.needsDrivenTransparentPass,y={diffuse:d,ambient:d,opacity:f,transparent:u,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:u||\"none\"===c?0:2,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(n(this._intrinsicSize,t,i),!z(this._intrinsicSize[0])||!z(this._intrinsicSize[1])))throw new e(\"graphics3dpathsymbollayer:invalid-size\",\"Symbol sizes may not be negative values\");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||l(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(Object.assign(y,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new Y(y)):(y.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new X(y)),this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,$,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new j),r=e.renderingInfo;return this._createAs3DShape(t,r,i,t.uid)}layerOpacityChanged(){const e=a(this.symbolLayer,\"material\",\"color\"),t=this._getCombinedOpacity(e),i=t<1||this.needsDrivenTransparentPass;return this._material.setParameterValues({opacity:t,transparent:i}),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,R)}slicePlaneEnabledChanged(){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}applyRendererDiff(e,t){for(const i in e.diff)switch(i){case\"visualVariables\":if(!U(this._fastUpdates,t,this._vvConvertOptions))return!1;this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0}getVertexData(e){let t=0;const i=e.paths,r=[],s=e.spatialReference,a=this._context.elevationProvider.spatialReference,o=this._context.renderCoordsHelper.spatialReference;for(const m of i)t+=m.length;const n=new Float64Array(3*t),l=new Float64Array(3*t),h=new Float64Array(3*t);let c=0;for(const m of i){r.push({index:c,numVertices:m.length});for(const t of m)n[c++]=t[0],n[c++]=t[1],n[c++]=e.hasZ?t[2]:0}let p=!0;return s.equals(a)?this._copyVertices(n,0,l,0,t):p=x(n,s,0,l,a,0,t),a.equals(o)?this._copyVertices(l,0,h,0,t):x(l,a,0,h,o,0,t),{pathVertexDataInfos:r,vertexDataGS:n,vertexDataES:l,vertexDataRS:h,projectionSuccess:p,terrainElevation:0}}_copyVertices(e,t,i,r,s){t*=3,r*=3;for(let a=0;a<s;++a)i[r++]=e[t++],i[r++]=e[t++],i[r++]=e[t++]}_createAs3DShape(e,t,i,r){const a=e.geometry,o=new Array,n=new Array,l=new Array,h=a.spatialReference,p=w(),m=this._context.renderCoordsHelper,d=this.getVertexData(a);if(!d.projectionSuccess)return this.logger.warn(\"PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)\"),null;if(d.pathVertexDataInfos.length>0){for(let r=0;r<d.pathVertexDataInfos.length;++r){const a=d.pathVertexDataInfos[r],f=a.index,u=a.numVertices;if(u<2)continue;if(s(this._context.clippingExtent)&&(S(p),D(p,d.vertexDataES,3*f,u),!P(p,this._context.clippingExtent)))continue;const y=[];for(let e=f;e<f+3*u;){const t=e++,r=e++,s=e++,a=new Q;c(a.posGS,d.vertexDataGS[t],d.vertexDataGS[r],d.vertexDataGS[s]),c(a.posES,d.vertexDataES[t],d.vertexDataES[r],d.vertexDataES[s]);const o=V(a.posES,this._context.elevationProvider,i,m,null);c(ae,d.vertexDataRS[t],d.vertexDataRS[r],d.vertexDataRS[s]),m.setAltitude(ae,o),c(a.pos,ae[0],ae[1],ae[2]),y.push(a)}const g=new T(y);te(g,this.upVectorAlignment,this._context.renderCoordsHelper);const _=new N(g,this._profile,this._extruder,this._startCap,this._endCap);let b=null;if(this._fastUpdates.enabled){const t=this._fastUpdates.visualVariables,i=t.size?L(t.size.field,e):0,r=t.color?L(t.color.field,e):0,s=t.opacity?L(t.opacity.field,e):0;b=new W(_,i,r,s)}else{const e=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(e[0]*=ie(t.size[0],\"symbol-value\"===t.size[2]?this.symbolLayer.height||0:t.size[2],this.symbolLayer.width||0),e[1]*=ie(t.size[2],\"symbol-value\"===t.size[0]?this.symbolLayer.width||0:t.size[0],this.symbolLayer.height||0));let i=null;this._drivenProperties.color&&(i=t.color),this._drivenProperties.opacity&&null!=t.opacity&&(i=i?[i[0],i[1],i[2],t.opacity]:[1,1,1,t.opacity]);const r=new Z(_);r.bake(e),i&&r.bakeVertexColors(i),b=r}const{vertexAttributes:v,indices:x}=b.createGeometryData(),w=new F(v,x,b,h,this.upVectorAlignment,this.stencilWidth);o.push(w),n.push(this._material),l.push(b.xform)}if(o.length>0){const e={layerUid:this._context.layer.uid,graphicUid:r},t=new k({geometries:o,materials:n,transformations:l,metadata:e}),s=new C(this,t,o,null,null,se,i);return s.alignedSampledElevation=d.terrainElevation,s.needsElevationUpdates=R(i.mode),s}}else 0!==a.paths.length&&a.paths.some((e=>e.length>0))||this.logger.warn(\"PathSymbol3DLayer geometry failed to be created (no paths were defined)\");return null}}function te(e,s,a){switch(s){case\"world\":for(const t of e.vertices)p(oe,t.pos,e.offset),a.worldUpAtPosition(oe,ae),t.setFrameFromUpVector(ae),t.computeRotationAxisAndAngleFromUpVector();break;case\"path\":p(oe,e.vertices[0].pos,e.offset),a.worldUpAtPosition(oe,ae),J(e,ae);for(const s of e.vertices){const e=t(m(s.frame.right,s.vRight));d(s.rotationFrame.up,s.vRight,s.vLeft),f(s.rotationFrame.up,s.rotationFrame.up,e),u(s.rotationFrame.up,s.rotationFrame.up);const a=m(s.rotationFrame.up,s.frame.up),n=m(s.rotationFrame.up,s.frame.right);if(f(oe,s.frame.up,-n),f(ne,s.frame.right,a),p(oe,oe,ne),u(s.rotationFrame.right,oe),K(s.rotationRight,s.frame,s.rotationFrame.right),y(oe,s.vLeft),s.rotationAngle=-e*(Math.PI-i(m(oe,s.vRight))),Math.abs(s.rotationAngle)>0){const e=r(Math.cos(.5*s.rotationAngle));o(s.miterStretch,1+(e-1)*s.rotationRight[0]*s.rotationRight[0],(e-1)*s.rotationRight[0]*s.rotationRight[1],(e-1)*s.rotationRight[0]*s.rotationRight[1],1+(e-1)*s.rotationRight[1]*s.rotationRight[1])}const l=Math.PI-s.rotationAngle;s.maxStretchDistance=Math.abs(Math.min(s.vLeftLength,s.vRightLength)*r(Math.cos(.5*l)))}}}function ie(e,t,i){switch(e){case\"symbol-value\":return i;case\"proportional\":return t;default:return e}}function re(e,t,i,r){let s=0;for(const a of e.vertices){const o=V(a.posES,i,t,r,pe);s+=pe.sampledElevation,p(ae,a.pos,e.offset),r.setAltitude(ae,o),g(a.pos,ae,e.offset)}return e.updatePathVertexInformation(),s/e.vertices.length}function se(e,t,i,r){const s=e.stageObject,a=s.geometryRecords,o=a.length;let n=0;r.spatialReference;for(let l=0;l<o;l++){const e=a[l].geometry;if(!G(e))continue;const o=e.path,h=o.builder.path;e.geometrySR,n+=re(h,t,i,r),\"world\"!==e.upVectorAlignment&&te(h,e.upVectorAlignment,r),o.onPathChanged(),e.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(l)}return n/o}const ae=v(),oe=_(),ne=_(),le=3,he=3,ce=10,pe={verticalDistanceToGround:0,sampledElevation:0};export default ee;export{ee as Graphics3DPathSymbolLayer,ce as NUM_CIRCLE_PROFILE_SUBDIVISIONS,he as NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS,le as NUM_ROUND_JOIN_SUBDIVISIONS};\n"]},"metadata":{},"sourceType":"module"}