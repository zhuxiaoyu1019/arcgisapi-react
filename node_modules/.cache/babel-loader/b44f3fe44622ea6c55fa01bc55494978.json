{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../chunks/tslib.es6.js\";\nimport t from \"../../../../core/Accessor.js\";\nimport s from \"../../../../core/Handles.js\";\nimport i from \"../../../../core/Logger.js\";\nimport { someMap as r } from \"../../../../core/MapUtils.js\";\nimport { isSome as a, destroyMaybe as n, isNone as o, unwrap as u } from \"../../../../core/maybe.js\";\nimport { createAbortController as l, isAbortError as h, eachAlways as c } from \"../../../../core/promiseUtils.js\";\nimport { schedule as d } from \"../../../../core/scheduling.js\";\nimport { on as p } from \"../../../../core/watchUtils.js\";\nimport { property as f } from \"../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../core/has.js\";\nimport \"../../../../core/accessorSupport/ensureType.js\";\nimport { subclass as m } from \"../../../../core/accessorSupport/decorators/subclass.js\";\nimport { equals as g, clone as F, expand as y, toExtent as T, create as x } from \"../../../../geometry/support/aaBoundingRect.js\";\nimport { getObjectId as R, hasVertices as C } from \"../../../../layers/graphics/dehydratedFeatures.js\";\nimport E from \"../../../../rest/support/QuantizationParameters.js\";\nimport v from \"../../../../rest/support/Query.js\";\nimport { MultiFeatureReference as b, SingleFeatureReference as M } from \"./featureReference.js\";\nimport { FAILED_FEATURE_COUNT as _, FeatureTile as w } from \"./FeatureTile.js\";\nimport { tilesAreRelated as j } from \"../../terrain/tileUtils.js\";\nimport { ImmediateTask as D, TaskPriority as O } from \"../../../support/Scheduler.js\";\nconst P = i.getLogger(\"esri.views.3d.layers.support.FeatureTileFetcher3D\");\nlet q = class extends t {\n  constructor(e) {\n    super(e), this._useTileCount = !1, this.updating = !1, this.updatingTotal = 0, this.updatingRemaining = 0, this.expectedFeatureDiff = 0, this.maximumNumberOfFeaturesExceeded = !1, this.maximumNumberOfFeaturesExceededThrottle = 1e3, this._fullRatio = 1, this._farRatio = 1, this.changes = {\n      updates: {\n        adds: new Array(),\n        removes: new Array()\n      },\n      adds: new Array(),\n      removes: new Array()\n    }, this.handles = new s(), this._frameTask = D, this._dirty = !1, this.featureTiles = new Map(), this.displayingFeatureReferences = new Map(), this.numDisplayingFeatureReferences = 0, this.suspended = !0, this.pendingEdits = null;\n  }\n\n  set maximumNumberOfFeatures(e) {\n    e = e || 1 / 0;\n\n    const t = this._get(\"maximumNumberOfFeatures\");\n\n    e === t || e < 1 || (this._set(\"maximumNumberOfFeatures\", e), this.maximumFeaturesUpdated(t, e));\n  }\n\n  set memoryFactor(e) {\n    this.memoryFactor !== e && (this._set(\"memoryFactor\", e), this.setDirty());\n  }\n\n  set lodFactor(e) {\n    this.lodFactor !== e && (this._set(\"lodFactor\", e), this.supportsResolution && this.refetch());\n  }\n\n  get useTileCount() {\n    return this._useTileCount && a(this.context.query.queryFeatureCount);\n  }\n\n  set useTileCount(e) {\n    this._useTileCount = e, this.notifyChange(\"useTileCount\");\n  }\n\n  get memoryForUnusedFeatures() {\n    let e = 0;\n    return this.featureTiles.forEach(t => e += t.estimatedUnusedSize), e;\n  }\n\n  get totalVertices() {\n    let e = 0;\n    return this.featureTiles.forEach(t => e += t.numVertices), e;\n  }\n\n  get totalFeatures() {\n    let e = 0;\n    return this.featureTiles.forEach(t => e += t.numFeatures), e;\n  }\n\n  set filterExtent(e) {\n    if (e && this.context.tilingScheme && !e.spatialReference.equals(this.context.tilingScheme.spatialReference)) return void P.error(\"#filterExtent=\", \"extent needs to be in the same spatial reference as the tiling scheme\");\n\n    const t = this._get(\"filterExtent\");\n\n    if (t === e || t && e && t.equals(e)) return;\n    const s = e ? e.clone() : null;\n    this._set(\"filterExtent\", s), this.reclip(s, t);\n  }\n\n  initialize() {\n    this.handles.add(p(this, \"tileDescriptors\", \"change\", () => this.setDirty(), () => this.setDirty())), this.objectIdField = this.context.objectIdField, this.FeatureReferenceClass = this.context.capabilities.supportsMultipleResolutions ? b : M;\n    const e = this.context.scheduler;\n    a(e) && (this._frameTask = e.registerTask(O.FEATURE_TILE_FETCHER, this)), this.setDirty();\n  }\n\n  destroy() {\n    this._frameTask.remove(), this.handles = n(this.handles), this.featureTiles.forEach(e => {\n      this.cancelFetchTile(e), this.removeTile(e);\n    }), this.featureTiles.clear(), this.displayingFeatureReferences.clear(), this.pendingEdits && (this.pendingEdits.controller.abort(), this.pendingEdits = null);\n  }\n\n  get paused() {\n    return this.suspended || !!this.pendingEdits;\n  }\n\n  restart() {\n    this.featureTiles.forEach(e => {\n      this.cancelFetchTile(e), this.clearTile(e), this.resetFetchTile(e);\n    }), a(this.context.memoryCache) && this.context.memoryCache.clear(), this.setDirty();\n  }\n\n  refetch() {\n    this.featureTiles.forEach(e => {\n      this.cancelFetchTile(e), this.resetFetchTile(e);\n    }), a(this.context.memoryCache) && this.context.memoryCache.clear(), this.setDirty();\n  }\n\n  suspend() {\n    this.suspended || (this.suspended = !0, this.pause(), this.setDirty());\n  }\n\n  resume() {\n    this.suspended && (this.suspended = !1, this.unpause());\n  }\n\n  pause() {\n    this.paused && (this.featureTiles.forEach(e => this.cancelFetchTile(e)), this.updated());\n  }\n\n  unpause() {\n    this.paused || (this.setDirty(), this.updated());\n  }\n\n  get availableFields() {\n    let e = null;\n    return this.featureTiles.forEach(t => {\n      o(t.displayingFeatures) || 0 === t.displayingFeatures.length || (o(e) ? e = new Set(t.availableFields) : e.forEach(s => {\n        t.availableFields.has(s) || u(e).delete(s);\n      }));\n    }), a(e) ? e : new Set();\n  }\n\n  applyEdits(e) {\n    this.pendingEdits || (this.pendingEdits = {\n      edits: Promise.resolve(),\n      count: 0,\n      controller: l()\n    }, this.pause());\n    const t = this.pendingEdits;\n    t.count++;\n    const s = t.edits.then(() => e.result.catch(e => {\n      if (h(e)) throw e;\n      return null;\n    }).then(e => e ? (this.applyEditsDeleteFeatures(e.deletedFeatures), this.applyEditsAddUpdateFeatures(e.addedFeatures, e.updatedFeatures, t.controller.signal).then(() => e)) : e).then(e => (0 == --t.count && (this.pendingEdits === t && (this.pendingEdits = null), a(this.context.memoryCache) && this.context.memoryCache.clear(), this.unpause(), this.updated()), e)));\n    return t.edits = s, this.updated(), s;\n  }\n\n  applyEditsDeleteFeatures(e) {\n    if (0 === e.length) return;\n    const t = this.context.globalIdField,\n          s = t && this.availableFields.has(t),\n          i = new Set(),\n          r = this.objectIdField;\n    e.forEach(({\n      objectId: e,\n      globalId: a\n    }) => {\n      if ((!e || e < 0) && t) {\n        s || P.errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected in the view`);\n        const e = this.features.find(e => e.attributes && e.attributes[t] === a);\n        e && i.add(R(e, r));\n      } else i.add(e);\n    }), this.featureTiles.forEach(e => {\n      if (!e.features) return;\n      const t = e.features.filter(e => !i.has(R(e, this.objectIdField)));\n      t.length !== e.features.length && (e.setFeatures(t, 0, e.availableFields), this.invalidateCounts());\n    });\n  }\n\n  async applyEditsAddUpdateFeatures(e, t, s) {\n    const i = [],\n          r = new Set();\n    if (e.forEach(e => i.push(e.objectId)), t.forEach(e => {\n      i.push(e.objectId), r.add(e.objectId);\n    }), 0 === i.length) return;\n    const a = [];\n    this.featureTiles.forEach(e => {\n      const t = this.applyEditsAddUpdateTile(e, i, r, s);\n      t && a.push(t);\n    }), await c(a);\n  }\n\n  async applyEditsAddUpdateTile(e, t, s, i) {\n    if (!e.features) return;\n    const r = this.createQuery(e);\n    r.resultType = void 0, r.cacheHint = !1, r.objectIds = t;\n    const a = await this.queryFeatures(r, i);\n    let n = null;\n\n    if (s.size > 0) {\n      const t = e.features.filter(e => !s.has(R(e, this.objectIdField)));\n      t.length !== e.features.length && (n = t);\n    }\n\n    if (a.features.length > 0) {\n      n || (n = e.features.slice());\n\n      for (const e of a.features) n.push(e);\n    }\n\n    n && (e.hasPreciseFeatureCount && (e.numFeatures = Math.max(e.numFeatures, n.length)), e.setFeatures(n, 0, k(e.availableFields, a.fields)), this.invalidateCounts());\n  }\n\n  queryFeatures(e, t) {\n    return this.context.query.queryFeaturesDehydrated(e, {\n      signal: t,\n      timeout: H\n    });\n  }\n\n  setDirty() {\n    this._dirty = !0, this.updated();\n  }\n\n  get running() {\n    return this.updating;\n  }\n\n  runTask(e) {\n    if (this._frameTask.processQueue(e), !this._dirty || !this.constructed) return;\n    this._dirty = !1;\n    const t = this.getListOfTiles();\n    if (this.markTilesNotAlive(t), !e.run(() => this.addTiles(t, e)) || !e.run(() => this.filterExtentTiles(t, e)) || !e.run(() => this.removeTiles(t, e)) || e.done) return void this.setDirty();\n    const s = this.sortTiles(t);\n    e.run(() => this.displayTiles(s, e)) && e.run(() => this.fetchTiles(s, e)) && e.run(() => this.updateMemoryEstimates(s, e)) || this.setDirty(), this.updated(), this.updating || this.updateMaximumNumberOfFeaturesExceeded();\n  }\n\n  markTilesNotAlive(e) {\n    for (const t of e) t.alive = !1;\n  }\n\n  addTiles(e, t) {\n    return !this.suspended && (this.tileDescriptors.forEach(s => {\n      const i = this.featureTiles.get(s.id);\n      i ? i.alive = !0 : t.done || (e.push(this.addTile(s)), t.madeProgress());\n    }), t.hasProgressed);\n  }\n\n  filterExtentTiles(e, t) {\n    for (const s of e) {\n      if (t.done) break;\n      s.alive && (s.filtered = !s.intersects(this.filterExtent), s.filtered && (this.clearTile(s), t.madeProgress()));\n    }\n\n    return t.hasProgressed;\n  }\n\n  removeTiles(e, t) {\n    for (let s = e.length - 1; s >= 0 && !t.done; s--) {\n      const i = e[s];\n      i.alive || (this.removeTile(i), s !== e.length - 1 && (e[s] = e[e.length - 1]), e.pop(), t.madeProgress());\n    }\n\n    return t.hasProgressed;\n  }\n\n  sortTiles(e) {\n    return e.sort((e, t) => e.descriptor.loadPriority - t.descriptor.loadPriority), e;\n  }\n\n  displayTiles(e, t) {\n    const s = this.updateRatio(e),\n          i = e => {\n      const t = this._fullRatio < 1 ? s(e) * this._farRatio : 1;\n      return e.reduceFeatures(t, this.memoryFactor, this.objectIdField) && this.setDirty(), this.showTile(e);\n    };\n\n    for (const r of e) if (!t.run(() => i(r))) {\n      this.setDirty();\n      break;\n    }\n\n    return t.hasProgressed;\n  }\n\n  fetchTiles(e, t) {\n    if (this.paused) return !1;\n    let s = !1;\n\n    for (const i of e) {\n      if (!i.needsFetching) continue;\n      const e = a(this.context.memoryCache) ? this.context.memoryCache.pop(i.id) : null;\n      if (a(e)) i.cache = e, this.setDirty(), this.scheduleUpdated(), t.madeProgress();else {\n        if (this.needsNumFeatures(i)) {\n          const e = l(),\n                r = this.fetchTileCount(i, e.signal);\n          this._handleRequest(i, r, e, () => i.numFeatures = _), s = !0, t.madeProgress();\n        }\n\n        if (t.done) return !0;\n      }\n    }\n\n    if (s) return t.hasProgressed;\n\n    for (const i of e) if (i.needsFetching) {\n      const e = l(),\n            s = this.fetchTile(i, e.signal);\n      if (this._handleRequest(i, s, e, e => {\n        i.setFeatures([], 0, null), this.invalidateCounts(), i.featuresMissing = !1, this.context.logFetchError(P, e);\n      }), t.madeProgress(), t.done) return !0;\n    }\n\n    return t.hasProgressed;\n  }\n\n  updateMemoryEstimates(e, t) {\n    return e.some(e => !t.run(() => e.updateMemoryEstimates()) && (this.setDirty(), !0)), t.hasProgressed;\n  }\n\n  reclip(e, t) {\n    if (!this.constructed) return;\n    const s = new Array();\n    this.featureTiles.forEach(i => {\n      o(i.displayingFeatures) || 0 === i.displayingFeatures.length || (i.intersectionIncludingBorrowed(t, V), i.intersectionIncludingBorrowed(e, z), g(V, z) || s.push(i));\n    }), this.refreshDisplayingFeatures(s), this.updated();\n  }\n\n  refreshDisplayingFeatures(e) {\n    const t = new Set(),\n          s = this.changes.updates;\n\n    for (const i of e) if (!o(i.displayingFeatures)) for (const e of i.displayingFeatures) {\n      const i = R(e, this.objectIdField);\n      if (t.has(i)) continue;\n      t.add(i);\n      const {\n        feature: r\n      } = this.displayingFeatureReferences.get(i);\n      s.removes.push(r), s.adds.push(r);\n    }\n\n    this.applyChanges();\n  }\n\n  updated() {\n    let e = 0;\n    this.paused || this.featureTiles.forEach(t => t.isFetching ? ++e : 0);\n    const t = this._dirty || e > 0 || !!this.pendingEdits;\n\n    if (this._set(\"updating\", t), t) {\n      let t = 0,\n          s = 0,\n          i = 0,\n          r = 0,\n          n = 0;\n      const o = this.displayingFeatureReferences.size / this.numDisplayingFeatureReferences;\n      this.featureTiles.forEach(e => {\n        if (++s, e.isFetching && e.hasPreciseFeatureCount) {\n          const t = this.maximumFeaturesForTile(e) * (1 - e.emptyFeatureRatio),\n                s = a(e.displayingFeatures) ? e.displayingFeatures.length * o : 0;\n          n += t - s;\n        }\n\n        e.needsFetching ? ++r : e.numFeatures > 0 && (++i, t += e.numFeatures);\n      }), r += e;\n      let u = 0,\n          l = 0;\n      t ? (l = t, u = Math.min(r * t / i, t)) : (l = s, u = r), n = Math.min(this.maximumNumberOfFeatures - this.features.length, n), this._set(\"updatingTotal\", l), this._set(\"updatingRemaining\", u), this._set(\"expectedFeatureDiff\", n);\n    } else this._set(\"updatingTotal\", 0), this._set(\"updatingRemaining\", 0), this._set(\"expectedFeatureDiff\", 0);\n\n    this.debugger && this.debugger.update();\n  }\n\n  updateMaximumNumberOfFeaturesExceeded() {\n    const e = r(this.featureTiles, e => e.perTileMaximumNumberOfFeaturesExceeded);\n\n    this._set(\"maximumNumberOfFeaturesExceeded\", e);\n  }\n\n  updateRatio(e) {\n    const t = S(e),\n          s = e => 1 / (1 << Math.max(0, t - e.descriptor.lij[0]));\n\n    let i = 0,\n        r = 0;\n\n    for (const a of e) {\n      const e = a.numFeatures;\n      i += e, r += e * s(a);\n    }\n\n    return this._fullRatio = Math.min(1, this.maximumNumberOfFeatures / i), this._farRatio = this.maximumNumberOfFeatures / r, this.scheduleUpdated(), s;\n  }\n\n  maximumFeaturesUpdated(e, t) {\n    e !== t && (t > e && this.featureTiles.forEach(e => {\n      if (!e.featuresMissing) return;\n      const t = this.maximumFeaturesForTile(e);\n      e.features && (e.features.length >= t || 5 === e.fetchStatus) || (this.cancelFetchTile(e), this.resetFetchTile(e));\n    }), this.setDirty());\n  }\n\n  addTile(e) {\n    const t = new w(e);\n    return this.featureTiles.set(t.id, t), this.resetFetchTile(t), this.referenceDisplayingFeaturesFromRelatedTiles(t), t;\n  }\n\n  referenceDisplayingFeaturesFromRelatedTiles(e) {\n    const t = e.descriptor.resolution;\n    this.featureTiles.forEach(s => {\n      if (!(o(s.displayingFeatures) || e === s || e.descriptor.lij && s.descriptor.lij && !j(e.descriptor.lij, s.descriptor.lij))) {\n        o(e.displayingFeatures) && (e.displayingFeatures = []), e.descriptor.extent && s.descriptor.extent && (o(e.extentIncludingBorrowedFeatures) && (e.extentIncludingBorrowedFeatures = F(e.descriptor.extent)), y(e.extentIncludingBorrowedFeatures, s.descriptor.extent, e.extentIncludingBorrowedFeatures));\n\n        for (const i of s.displayingFeatures) {\n          e.displayingFeatures.push(i);\n          const s = this.displayingFeatureReferences.get(R(i, this.objectIdField));\n          s.ref(s.feature, t), this.numDisplayingFeatureReferences++;\n        }\n      }\n    }), e.featureLimit = a(e.displayingFeatures) ? e.displayingFeatures.length : 0;\n  }\n\n  removeTile(e) {\n    this.clearTile(e), this.featureTiles.delete(e.id);\n  }\n\n  resetFetchTile(e) {\n    e.filtered = !e.intersects(this.filterExtent), e.filtered ? e.needsFetching && (e.fetchStatus = 4) : e.fetchStatus = 0;\n  }\n\n  cancelFetchTile(e) {\n    const t = e.requestController;\n    a(t) && (e.requestController = null, e.resetFetching(), t.abort());\n  }\n\n  async fetchTileCount(e, t) {\n    return e.numFeatures = await this.fetchCount(e, t), this.updateRatio(this.getListOfTiles()), 3 === e.fetchStatus ? 1 : 0;\n  }\n\n  async fetchTile(e, t) {\n    const s = this.maximumFeaturesForTile(e);\n    if (s <= 0) return N(e);\n    const i = this.getMaxRecordCount(e),\n          r = Math.ceil(s / i);\n    if (I(e) || !this.context.capabilities.supportsMaxRecordCountFactor || e.numFeatures <= s && r > v.MAX_MAX_RECORD_COUNT_FACTOR) return this.fetchPagedTile(e, t);\n    const a = this.createQuery(e);\n\n    if (a.maxRecordCountFactor = Math.ceil(s / i), e.isRefetching && e.features && e.features.length > 0) {\n      const t = Math.ceil(e.features.length / (1 - e.emptyFeatureRatio) / i);\n      a.maxRecordCountFactor = Math.max(t + 1, a.maxRecordCountFactor);\n    }\n\n    const {\n      features: n,\n      exceededTransferLimit: o,\n      fields: u\n    } = await this.queryFeatures(a, t),\n          l = o ? a.maxRecordCountFactor >= v.MAX_MAX_RECORD_COUNT_FACTOR ? 5 : 4 : 5;\n    return await this._frameTask.schedule(() => {\n      e.featuresMissing = n.length < e.numFeatures || o;\n\n      const t = this._removeEmptyFeatures(n);\n\n      e.setFeatures(n, t, Q(u));\n    }, t), this.invalidateCounts(), l;\n  }\n\n  async fetchCount(e, t) {\n    return this.context.query.queryFeatureCount(this.createFeatureCountQuery(e), {\n      signal: t\n    });\n  }\n\n  async fetchPagedTile(e, t) {\n    let s,\n        i = 0,\n        r = 0,\n        a = 0,\n        n = this.maximumFeaturesForTile(e) - a;\n    const o = this.getMaxRecordCount(e);\n    let l = null;\n\n    for (;;) {\n      const h = this.createQuery(e),\n            c = this.setPagingParameters(h, i, n, o),\n            {\n        features: d,\n        exceededTransferLimit: p,\n        fields: f\n      } = await this.queryFeatures(h, t);\n      if (await this._frameTask.schedule(() => {\n        c && (i += u(h.num)), a += d.length, r += this._removeEmptyFeatures(d), e.featuresMissing = i < e.numFeatures || p, s = s ? s.concat(d) : d, l = k(l, f), e.setFeatures(s, r, l);\n      }, t), this.invalidateCounts(), this.setDirty(), n = this.maximumFeaturesForTile(e) - a, !c || !p || n <= 0) return p ? 4 : 5;\n    }\n  }\n\n  createFeatureCountQuery(e) {\n    const t = this.createQuery(e);\n    return this.context.capabilities.supportsCacheHint && (t.resultType = void 0, t.cacheHint = !0), t;\n  }\n\n  createQuery(e) {\n    const t = this.context.createQuery(),\n          s = e.descriptor.extent;\n\n    if (s) {\n      const e = this.context.tilingScheme.spatialReference;\n      t.geometry = T(s, e);\n    }\n\n    return this.setResolutionParams(t, e), this.useTileQuery(e) ? t.resultType = \"tile\" : this.context.capabilities.supportsCacheHint && (t.cacheHint = !0), t;\n  }\n\n  setPagingParameters(e, t, s, i) {\n    return !!this.context.capabilities.supportsPagination && (e.start = t, s > 0 && this.context.capabilities.supportsMaxRecordCountFactor ? (e.maxRecordCountFactor = Math.ceil(s / i), e.num = Math.min(e.maxRecordCountFactor * i, s)) : e.num = Math.min(i), !0);\n  }\n\n  getEffectiveTileResolution(e) {\n    if (null == e.descriptor.resolution) return null;\n    const t = 1 === this.context.viewingMode ? this.context.tilingScheme.resolutionAtLevel(3) : 1 / 0;\n    return Math.min(e.descriptor.resolution, t) / this.lodFactor;\n  }\n\n  get supportsResolution() {\n    return this.context.capabilities.supportsMultipleResolutions && \"point\" !== this.context.geometryType;\n  }\n\n  setResolutionParams(e, t) {\n    if (!this.supportsResolution) return;\n    const s = this.getEffectiveTileResolution(t);\n    null != s && (this.context.capabilities.supportsQuantization ? e.quantizationParameters = new E({\n      mode: \"view\",\n      originPosition: \"upper-left\",\n      tolerance: s,\n      extent: this.context.fullExtent\n    }) : \"polyline\" === this.context.geometryType && (e.maxAllowableOffset = s));\n  }\n\n  _removeEmptyFeatures(e) {\n    const t = e.length;\n\n    for (let s = 0; s < e.length;) {\n      const t = e[s];\n      C(t.geometry) ? ++s : (e[s] = e[e.length - 1], --e.length);\n    }\n\n    return t - e.length;\n  }\n\n  needsNumFeatures(e) {\n    return this.useTileCount && e.needsFeatureCount && !I(e);\n  }\n\n  getMaxRecordCount(e) {\n    const {\n      tileMaxRecordCount: t,\n      maxRecordCount: s\n    } = this.context;\n    return this.useTileQuery(e) && a(t) && t > 0 && this.context.capabilities.supportsResultType ? t : a(s) && s > 0 ? s : L;\n  }\n\n  useTileQuery(e) {\n    return (!I(e) || !this.context.capabilities.supportsCacheHint) && this.context.capabilities.supportsResultType;\n  }\n\n  _handleRequest(e, t, s, i) {\n    e.fetchStatus = e.needsRefetching ? 3 : 2, e.requestController = s;\n    let r = !1;\n    t.then(t => {\n      e.requestController = null, e.fetchStatus = t;\n    }).catch(t => {\n      e.requestController === s && (e.requestController = null, e.fetchStatus = 4), h(t) ? r = !0 : i(t);\n    }).then(() => {\n      r || this.setDirty(), this.scheduleUpdated();\n    });\n  }\n\n  scheduleUpdated() {\n    this.handles && !this.handles.has(\"scheduleUpdated\") && this.handles.add(d(() => {\n      this.handles.remove(\"scheduleUpdated\"), this.updated();\n    }), \"scheduleUpdated\");\n  }\n\n  showTile(e) {\n    if (a(e.displayingFeatures) && !e.needsDisplayUpdate) return !1;\n    const t = e.features;\n\n    if (0 === e.featureLimit || !t) {\n      const t = a(e.displayingFeatures) && e.displayingFeatures.length > 0;\n      return this.hideTileFeatures(e), e.displayingFeatures = [], t;\n    }\n\n    const s = e.descriptor.resolution,\n          i = this.changes.updates,\n          r = this.changes.adds,\n          n = Math.min(e.featureLimit, t.length);\n    e.featureLimit = n;\n\n    for (let a = 0; a < n; ++a) {\n      const e = t[a],\n            n = R(e, this.objectIdField),\n            o = this.displayingFeatureReferences.get(n);\n\n      if (o) {\n        const t = o.ref(e, s);\n        t.oldVersion !== t.newVersion && (i.removes.push(t.oldVersion), i.adds.push(t.newVersion));\n      } else this.displayingFeatureReferences.set(n, new this.FeatureReferenceClass(e, s)), r.push(e);\n\n      this.numDisplayingFeatureReferences++;\n    }\n\n    return this.hideTileFeatures(e), this.applyChanges(), e.displayingFeatures = t.slice(0, n), !0;\n  }\n\n  hideTile(e) {\n    this.cancelFetchTile(e), this.hideTileFeatures(e);\n  }\n\n  hideTileFeatures(e) {\n    if (o(e.displayingFeatures)) return;\n    const t = this.changes.updates,\n          s = this.changes.removes;\n\n    for (const i of e.displayingFeatures) {\n      const r = R(i, this.objectIdField),\n            a = this.displayingFeatureReferences.get(r);\n      if (!a) continue;\n      const n = a.unref(e.descriptor.resolution);\n      this.numDisplayingFeatureReferences--, n ? n.oldVersion !== n.newVersion && (null == n.newVersion ? (this.displayingFeatureReferences.delete(r), s.push(n.oldVersion)) : (t.adds.push(n.newVersion), t.removes.push(n.oldVersion))) : console.error(\"Hiding unreferenced feature\");\n    }\n\n    this.applyChanges(), e.displayingFeatures = null;\n  }\n\n  applyChanges() {\n    const e = this.changes.updates;\n    e.removes.length > 0 && (this.features.removeMany(e.removes), e.removes.length = 0), e.adds.length > 0 && (this.features.addMany(e.adds), e.adds.length = 0);\n    const t = this.changes.adds,\n          s = this.changes.removes,\n          i = Math.min(t.length, s.length);\n    let r = 0;\n\n    for (; r < i;) {\n      const e = Math.min(r + B, i);\n      this.features.addMany(t.slice(r, e)), this.features.removeMany(s.slice(r, e)), r = e;\n    }\n\n    t.length > i && this.features.addMany(0 === r ? t : t.slice(r)), s.length > i && this.features.removeMany(0 === r ? s : s.slice(r)), t.length = 0, s.length = 0;\n  }\n\n  clearTile(e) {\n    if (this.hideTile(e), e.features && a(this.context.memoryCache)) {\n      const t = 16 + e.estimatedSize;\n      this.context.memoryCache.put(e.id, e.cache, t);\n    }\n\n    e.setFeatures(null, 0, null), this.invalidateCounts();\n  }\n\n  invalidateCounts() {\n    this.notifyChange(\"totalVertices\"), this.notifyChange(\"totalFeatures\"), this.notifyChange(\"memoryForUnusedFeatures\");\n  }\n\n  getListOfTiles() {\n    return Array.from(this.featureTiles.values());\n  }\n\n  get storedFeatures() {\n    return this.getListOfTiles().reduce((e, t) => e + (t.features ? t.features.length : 0), 0);\n  }\n\n  maximumFeaturesForTile(e) {\n    const t = e.hasPreciseFeatureCount ? e.numFeatures : 1 / 0,\n          s = e.hasPreciseFeatureCount ? t : this.maximumNumberOfFeatures,\n          i = this._fullRatio < 1 ? this._farRatio : 1;\n    return Math.min(Math.ceil(s * i / (1 - e.emptyFeatureRatio)), t);\n  }\n\n  get test() {\n    return {\n      process: e => this.runTask(e),\n      getFeatureTileById: e => this.featureTiles.get(e),\n      forEachFeatureTile: e => this.featureTiles.forEach(e)\n    };\n  }\n\n};\n\nfunction I(e) {\n  return \"dummy-tile-full-extent\" === e.id;\n}\n\nfunction S(e) {\n  let t = 0;\n\n  for (const s of e) s.features && s.features.length > 0 && s.alive && (t = Math.max(t, s.descriptor.lij[0]));\n\n  return t;\n}\n\nfunction U(e) {\n  const t = e.capabilities.query;\n  return {\n    supportsMultipleResolutions: A(e),\n    supportsPagination: !(!t || !t.supportsPagination),\n    supportsResultType: !(!t || !t.supportsResultType),\n    supportsCacheHint: !(!t || !t.supportsCacheHint),\n    supportsQuantization: !(!t || !t.supportsQuantization),\n    supportsQuantizationEditMode: !(!t || !t.supportsQuantizationEditMode),\n    supportsMaxRecordCountFactor: !(!t || !t.supportsMaxRecordCountFactor),\n    supportsFormatPBF: !(!t || !t.supportsFormatPBF)\n  };\n}\n\nfunction A(e) {\n  switch (e.geometryType) {\n    case \"polyline\":\n      return !0;\n\n    case \"polygon\":\n      return e.capabilities && e.capabilities.query && e.capabilities.query.supportsQuantization;\n\n    default:\n      return !1;\n  }\n}\n\nfunction N(e) {\n  return e.setFeatures([], 0, null), e.featuresMissing = !1, 4;\n}\n\nfunction Q(e) {\n  return o(e) ? new Set() : new Set(e.map(e => e.name));\n}\n\nfunction k(e, t) {\n  if (o(e) || o(t)) return Q(t);\n  const s = new Set();\n\n  for (const {\n    name: i\n  } of t) e.has(i) && s.add(i);\n\n  return s;\n}\n\ne([f({\n  constructOnly: !0\n})], q.prototype, \"features\", void 0), e([f()], q.prototype, \"tileDescriptors\", void 0), e([f({\n  value: 1 / 0\n})], q.prototype, \"maximumNumberOfFeatures\", null), e([f({\n  value: 1\n})], q.prototype, \"memoryFactor\", null), e([f({\n  value: 1\n})], q.prototype, \"lodFactor\", null), e([f()], q.prototype, \"useTileCount\", null), e([f({\n  readOnly: !0\n})], q.prototype, \"updating\", void 0), e([f({\n  readOnly: !0\n})], q.prototype, \"updatingTotal\", void 0), e([f({\n  readOnly: !0\n})], q.prototype, \"updatingRemaining\", void 0), e([f({\n  readOnly: !0\n})], q.prototype, \"expectedFeatureDiff\", void 0), e([f({\n  readOnly: !0\n})], q.prototype, \"memoryForUnusedFeatures\", null), e([f({\n  readOnly: !0\n})], q.prototype, \"maximumNumberOfFeaturesExceeded\", void 0), e([f({\n  constructOnly: !0\n})], q.prototype, \"maximumNumberOfFeaturesExceededThrottle\", void 0), e([f({\n  readOnly: !0\n})], q.prototype, \"totalVertices\", null), e([f({\n  readOnly: !0\n})], q.prototype, \"totalFeatures\", null), e([f()], q.prototype, \"filterExtent\", null), e([f({\n  constructOnly: !0\n})], q.prototype, \"context\", void 0), q = e([m(\"esri.views.3d.layers.support.FeatureTileFetcher3D\")], q);\nconst L = 2e3,\n      V = x(),\n      z = x(),\n      H = 6e5,\n      B = 200;\nvar X = q;\nexport default X;\nexport { q as FeatureTileFetcher3D, U as contextCapabilitiesFromLayer };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/layers/support/FeatureTileFetcher3D.js"],"names":["_","e","t","s","i","someMap","r","isSome","a","destroyMaybe","n","isNone","o","unwrap","u","createAbortController","l","isAbortError","h","eachAlways","c","schedule","d","on","p","property","f","subclass","m","equals","g","clone","F","expand","y","toExtent","T","create","x","getObjectId","R","hasVertices","C","E","v","MultiFeatureReference","b","SingleFeatureReference","M","FAILED_FEATURE_COUNT","FeatureTile","w","tilesAreRelated","j","ImmediateTask","D","TaskPriority","O","P","getLogger","q","constructor","_useTileCount","updating","updatingTotal","updatingRemaining","expectedFeatureDiff","maximumNumberOfFeaturesExceeded","maximumNumberOfFeaturesExceededThrottle","_fullRatio","_farRatio","changes","updates","adds","Array","removes","handles","_frameTask","_dirty","featureTiles","Map","displayingFeatureReferences","numDisplayingFeatureReferences","suspended","pendingEdits","maximumNumberOfFeatures","_get","_set","maximumFeaturesUpdated","memoryFactor","setDirty","lodFactor","supportsResolution","refetch","useTileCount","context","query","queryFeatureCount","notifyChange","memoryForUnusedFeatures","forEach","estimatedUnusedSize","totalVertices","numVertices","totalFeatures","numFeatures","filterExtent","tilingScheme","spatialReference","error","reclip","initialize","add","objectIdField","FeatureReferenceClass","capabilities","supportsMultipleResolutions","scheduler","registerTask","FEATURE_TILE_FETCHER","destroy","remove","cancelFetchTile","removeTile","clear","controller","abort","paused","restart","clearTile","resetFetchTile","memoryCache","suspend","pause","resume","unpause","updated","availableFields","displayingFeatures","length","Set","has","delete","applyEdits","edits","Promise","resolve","count","then","result","catch","applyEditsDeleteFeatures","deletedFeatures","applyEditsAddUpdateFeatures","addedFeatures","updatedFeatures","signal","globalIdField","objectId","globalId","errorOncePerTick","features","find","attributes","filter","setFeatures","invalidateCounts","push","applyEditsAddUpdateTile","createQuery","resultType","cacheHint","objectIds","queryFeatures","size","slice","hasPreciseFeatureCount","Math","max","k","fields","queryFeaturesDehydrated","timeout","H","running","runTask","processQueue","constructed","getListOfTiles","markTilesNotAlive","run","addTiles","filterExtentTiles","removeTiles","done","sortTiles","displayTiles","fetchTiles","updateMemoryEstimates","updateMaximumNumberOfFeaturesExceeded","alive","tileDescriptors","get","id","addTile","madeProgress","hasProgressed","filtered","intersects","pop","sort","descriptor","loadPriority","updateRatio","reduceFeatures","showTile","needsFetching","cache","scheduleUpdated","needsNumFeatures","fetchTileCount","_handleRequest","fetchTile","featuresMissing","logFetchError","some","intersectionIncludingBorrowed","V","z","refreshDisplayingFeatures","feature","applyChanges","isFetching","maximumFeaturesForTile","emptyFeatureRatio","min","debugger","update","perTileMaximumNumberOfFeaturesExceeded","S","lij","fetchStatus","set","referenceDisplayingFeaturesFromRelatedTiles","resolution","extent","extentIncludingBorrowedFeatures","ref","featureLimit","requestController","resetFetching","fetchCount","N","getMaxRecordCount","ceil","I","supportsMaxRecordCountFactor","MAX_MAX_RECORD_COUNT_FACTOR","fetchPagedTile","maxRecordCountFactor","isRefetching","exceededTransferLimit","_removeEmptyFeatures","Q","createFeatureCountQuery","setPagingParameters","num","concat","supportsCacheHint","geometry","setResolutionParams","useTileQuery","supportsPagination","start","getEffectiveTileResolution","viewingMode","resolutionAtLevel","geometryType","supportsQuantization","quantizationParameters","mode","originPosition","tolerance","fullExtent","maxAllowableOffset","needsFeatureCount","tileMaxRecordCount","maxRecordCount","supportsResultType","L","needsRefetching","needsDisplayUpdate","hideTileFeatures","oldVersion","newVersion","hideTile","unref","console","removeMany","addMany","B","estimatedSize","put","from","values","storedFeatures","reduce","test","process","getFeatureTileById","forEachFeatureTile","U","A","supportsQuantizationEditMode","supportsFormatPBF","map","name","constructOnly","prototype","value","readOnly","X","FeatureTileFetcher3D","contextCapabilitiesFromLayer"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../chunks/tslib.es6.js\";import t from\"../../../../core/Accessor.js\";import s from\"../../../../core/Handles.js\";import i from\"../../../../core/Logger.js\";import{someMap as r}from\"../../../../core/MapUtils.js\";import{isSome as a,destroyMaybe as n,isNone as o,unwrap as u}from\"../../../../core/maybe.js\";import{createAbortController as l,isAbortError as h,eachAlways as c}from\"../../../../core/promiseUtils.js\";import{schedule as d}from\"../../../../core/scheduling.js\";import{on as p}from\"../../../../core/watchUtils.js\";import{property as f}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/ensureType.js\";import{subclass as m}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{equals as g,clone as F,expand as y,toExtent as T,create as x}from\"../../../../geometry/support/aaBoundingRect.js\";import{getObjectId as R,hasVertices as C}from\"../../../../layers/graphics/dehydratedFeatures.js\";import E from\"../../../../rest/support/QuantizationParameters.js\";import v from\"../../../../rest/support/Query.js\";import{MultiFeatureReference as b,SingleFeatureReference as M}from\"./featureReference.js\";import{FAILED_FEATURE_COUNT as _,FeatureTile as w}from\"./FeatureTile.js\";import{tilesAreRelated as j}from\"../../terrain/tileUtils.js\";import{ImmediateTask as D,TaskPriority as O}from\"../../../support/Scheduler.js\";const P=i.getLogger(\"esri.views.3d.layers.support.FeatureTileFetcher3D\");let q=class extends t{constructor(e){super(e),this._useTileCount=!1,this.updating=!1,this.updatingTotal=0,this.updatingRemaining=0,this.expectedFeatureDiff=0,this.maximumNumberOfFeaturesExceeded=!1,this.maximumNumberOfFeaturesExceededThrottle=1e3,this._fullRatio=1,this._farRatio=1,this.changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},this.handles=new s,this._frameTask=D,this._dirty=!1,this.featureTiles=new Map,this.displayingFeatureReferences=new Map,this.numDisplayingFeatureReferences=0,this.suspended=!0,this.pendingEdits=null}set maximumNumberOfFeatures(e){e=e||1/0;const t=this._get(\"maximumNumberOfFeatures\");e===t||e<1||(this._set(\"maximumNumberOfFeatures\",e),this.maximumFeaturesUpdated(t,e))}set memoryFactor(e){this.memoryFactor!==e&&(this._set(\"memoryFactor\",e),this.setDirty())}set lodFactor(e){this.lodFactor!==e&&(this._set(\"lodFactor\",e),this.supportsResolution&&this.refetch())}get useTileCount(){return this._useTileCount&&a(this.context.query.queryFeatureCount)}set useTileCount(e){this._useTileCount=e,this.notifyChange(\"useTileCount\")}get memoryForUnusedFeatures(){let e=0;return this.featureTiles.forEach((t=>e+=t.estimatedUnusedSize)),e}get totalVertices(){let e=0;return this.featureTiles.forEach((t=>e+=t.numVertices)),e}get totalFeatures(){let e=0;return this.featureTiles.forEach((t=>e+=t.numFeatures)),e}set filterExtent(e){if(e&&this.context.tilingScheme&&!e.spatialReference.equals(this.context.tilingScheme.spatialReference))return void P.error(\"#filterExtent=\",\"extent needs to be in the same spatial reference as the tiling scheme\");const t=this._get(\"filterExtent\");if(t===e||t&&e&&t.equals(e))return;const s=e?e.clone():null;this._set(\"filterExtent\",s),this.reclip(s,t)}initialize(){this.handles.add(p(this,\"tileDescriptors\",\"change\",(()=>this.setDirty()),(()=>this.setDirty()))),this.objectIdField=this.context.objectIdField,this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?b:M;const e=this.context.scheduler;a(e)&&(this._frameTask=e.registerTask(O.FEATURE_TILE_FETCHER,this)),this.setDirty()}destroy(){this._frameTask.remove(),this.handles=n(this.handles),this.featureTiles.forEach((e=>{this.cancelFetchTile(e),this.removeTile(e)})),this.featureTiles.clear(),this.displayingFeatureReferences.clear(),this.pendingEdits&&(this.pendingEdits.controller.abort(),this.pendingEdits=null)}get paused(){return this.suspended||!!this.pendingEdits}restart(){this.featureTiles.forEach((e=>{this.cancelFetchTile(e),this.clearTile(e),this.resetFetchTile(e)})),a(this.context.memoryCache)&&this.context.memoryCache.clear(),this.setDirty()}refetch(){this.featureTiles.forEach((e=>{this.cancelFetchTile(e),this.resetFetchTile(e)})),a(this.context.memoryCache)&&this.context.memoryCache.clear(),this.setDirty()}suspend(){this.suspended||(this.suspended=!0,this.pause(),this.setDirty())}resume(){this.suspended&&(this.suspended=!1,this.unpause())}pause(){this.paused&&(this.featureTiles.forEach((e=>this.cancelFetchTile(e))),this.updated())}unpause(){this.paused||(this.setDirty(),this.updated())}get availableFields(){let e=null;return this.featureTiles.forEach((t=>{o(t.displayingFeatures)||0===t.displayingFeatures.length||(o(e)?e=new Set(t.availableFields):e.forEach((s=>{t.availableFields.has(s)||u(e).delete(s)})))})),a(e)?e:new Set}applyEdits(e){this.pendingEdits||(this.pendingEdits={edits:Promise.resolve(),count:0,controller:l()},this.pause());const t=this.pendingEdits;t.count++;const s=t.edits.then((()=>e.result.catch((e=>{if(h(e))throw e;return null})).then((e=>e?(this.applyEditsDeleteFeatures(e.deletedFeatures),this.applyEditsAddUpdateFeatures(e.addedFeatures,e.updatedFeatures,t.controller.signal).then((()=>e))):e)).then((e=>(0==--t.count&&(this.pendingEdits===t&&(this.pendingEdits=null),a(this.context.memoryCache)&&this.context.memoryCache.clear(),this.unpause(),this.updated()),e)))));return t.edits=s,this.updated(),s}applyEditsDeleteFeatures(e){if(0===e.length)return;const t=this.context.globalIdField,s=t&&this.availableFields.has(t),i=new Set,r=this.objectIdField;e.forEach((({objectId:e,globalId:a})=>{if((!e||e<0)&&t){s||P.errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected in the view`);const e=this.features.find((e=>e.attributes&&e.attributes[t]===a));e&&i.add(R(e,r))}else i.add(e)})),this.featureTiles.forEach((e=>{if(!e.features)return;const t=e.features.filter((e=>!i.has(R(e,this.objectIdField))));t.length!==e.features.length&&(e.setFeatures(t,0,e.availableFields),this.invalidateCounts())}))}async applyEditsAddUpdateFeatures(e,t,s){const i=[],r=new Set;if(e.forEach((e=>i.push(e.objectId))),t.forEach((e=>{i.push(e.objectId),r.add(e.objectId)})),0===i.length)return;const a=[];this.featureTiles.forEach((e=>{const t=this.applyEditsAddUpdateTile(e,i,r,s);t&&a.push(t)})),await c(a)}async applyEditsAddUpdateTile(e,t,s,i){if(!e.features)return;const r=this.createQuery(e);r.resultType=void 0,r.cacheHint=!1,r.objectIds=t;const a=await this.queryFeatures(r,i);let n=null;if(s.size>0){const t=e.features.filter((e=>!s.has(R(e,this.objectIdField))));t.length!==e.features.length&&(n=t)}if(a.features.length>0){n||(n=e.features.slice());for(const e of a.features)n.push(e)}n&&(e.hasPreciseFeatureCount&&(e.numFeatures=Math.max(e.numFeatures,n.length)),e.setFeatures(n,0,k(e.availableFields,a.fields)),this.invalidateCounts())}queryFeatures(e,t){return this.context.query.queryFeaturesDehydrated(e,{signal:t,timeout:H})}setDirty(){this._dirty=!0,this.updated()}get running(){return this.updating}runTask(e){if(this._frameTask.processQueue(e),!this._dirty||!this.constructed)return;this._dirty=!1;const t=this.getListOfTiles();if(this.markTilesNotAlive(t),!e.run((()=>this.addTiles(t,e)))||!e.run((()=>this.filterExtentTiles(t,e)))||!e.run((()=>this.removeTiles(t,e)))||e.done)return void this.setDirty();const s=this.sortTiles(t);e.run((()=>this.displayTiles(s,e)))&&e.run((()=>this.fetchTiles(s,e)))&&e.run((()=>this.updateMemoryEstimates(s,e)))||this.setDirty(),this.updated(),this.updating||this.updateMaximumNumberOfFeaturesExceeded()}markTilesNotAlive(e){for(const t of e)t.alive=!1}addTiles(e,t){return!this.suspended&&(this.tileDescriptors.forEach((s=>{const i=this.featureTiles.get(s.id);i?i.alive=!0:t.done||(e.push(this.addTile(s)),t.madeProgress())})),t.hasProgressed)}filterExtentTiles(e,t){for(const s of e){if(t.done)break;s.alive&&(s.filtered=!s.intersects(this.filterExtent),s.filtered&&(this.clearTile(s),t.madeProgress()))}return t.hasProgressed}removeTiles(e,t){for(let s=e.length-1;s>=0&&!t.done;s--){const i=e[s];i.alive||(this.removeTile(i),s!==e.length-1&&(e[s]=e[e.length-1]),e.pop(),t.madeProgress())}return t.hasProgressed}sortTiles(e){return e.sort(((e,t)=>e.descriptor.loadPriority-t.descriptor.loadPriority)),e}displayTiles(e,t){const s=this.updateRatio(e),i=e=>{const t=this._fullRatio<1?s(e)*this._farRatio:1;return e.reduceFeatures(t,this.memoryFactor,this.objectIdField)&&this.setDirty(),this.showTile(e)};for(const r of e)if(!t.run((()=>i(r)))){this.setDirty();break}return t.hasProgressed}fetchTiles(e,t){if(this.paused)return!1;let s=!1;for(const i of e){if(!i.needsFetching)continue;const e=a(this.context.memoryCache)?this.context.memoryCache.pop(i.id):null;if(a(e))i.cache=e,this.setDirty(),this.scheduleUpdated(),t.madeProgress();else{if(this.needsNumFeatures(i)){const e=l(),r=this.fetchTileCount(i,e.signal);this._handleRequest(i,r,e,(()=>i.numFeatures=_)),s=!0,t.madeProgress()}if(t.done)return!0}}if(s)return t.hasProgressed;for(const i of e)if(i.needsFetching){const e=l(),s=this.fetchTile(i,e.signal);if(this._handleRequest(i,s,e,(e=>{i.setFeatures([],0,null),this.invalidateCounts(),i.featuresMissing=!1,this.context.logFetchError(P,e)})),t.madeProgress(),t.done)return!0}return t.hasProgressed}updateMemoryEstimates(e,t){return e.some((e=>!t.run((()=>e.updateMemoryEstimates()))&&(this.setDirty(),!0))),t.hasProgressed}reclip(e,t){if(!this.constructed)return;const s=new Array;this.featureTiles.forEach((i=>{o(i.displayingFeatures)||0===i.displayingFeatures.length||(i.intersectionIncludingBorrowed(t,V),i.intersectionIncludingBorrowed(e,z),g(V,z)||s.push(i))})),this.refreshDisplayingFeatures(s),this.updated()}refreshDisplayingFeatures(e){const t=new Set,s=this.changes.updates;for(const i of e)if(!o(i.displayingFeatures))for(const e of i.displayingFeatures){const i=R(e,this.objectIdField);if(t.has(i))continue;t.add(i);const{feature:r}=this.displayingFeatureReferences.get(i);s.removes.push(r),s.adds.push(r)}this.applyChanges()}updated(){let e=0;this.paused||this.featureTiles.forEach((t=>t.isFetching?++e:0));const t=this._dirty||e>0||!!this.pendingEdits;if(this._set(\"updating\",t),t){let t=0,s=0,i=0,r=0,n=0;const o=this.displayingFeatureReferences.size/this.numDisplayingFeatureReferences;this.featureTiles.forEach((e=>{if(++s,e.isFetching&&e.hasPreciseFeatureCount){const t=this.maximumFeaturesForTile(e)*(1-e.emptyFeatureRatio),s=a(e.displayingFeatures)?e.displayingFeatures.length*o:0;n+=t-s}e.needsFetching?++r:e.numFeatures>0&&(++i,t+=e.numFeatures)})),r+=e;let u=0,l=0;t?(l=t,u=Math.min(r*t/i,t)):(l=s,u=r),n=Math.min(this.maximumNumberOfFeatures-this.features.length,n),this._set(\"updatingTotal\",l),this._set(\"updatingRemaining\",u),this._set(\"expectedFeatureDiff\",n)}else this._set(\"updatingTotal\",0),this._set(\"updatingRemaining\",0),this._set(\"expectedFeatureDiff\",0);this.debugger&&this.debugger.update()}updateMaximumNumberOfFeaturesExceeded(){const e=r(this.featureTiles,(e=>e.perTileMaximumNumberOfFeaturesExceeded));this._set(\"maximumNumberOfFeaturesExceeded\",e)}updateRatio(e){const t=S(e),s=e=>1/(1<<Math.max(0,t-e.descriptor.lij[0]));let i=0,r=0;for(const a of e){const e=a.numFeatures;i+=e,r+=e*s(a)}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/i),this._farRatio=this.maximumNumberOfFeatures/r,this.scheduleUpdated(),s}maximumFeaturesUpdated(e,t){e!==t&&(t>e&&this.featureTiles.forEach((e=>{if(!e.featuresMissing)return;const t=this.maximumFeaturesForTile(e);e.features&&(e.features.length>=t||5===e.fetchStatus)||(this.cancelFetchTile(e),this.resetFetchTile(e))})),this.setDirty())}addTile(e){const t=new w(e);return this.featureTiles.set(t.id,t),this.resetFetchTile(t),this.referenceDisplayingFeaturesFromRelatedTiles(t),t}referenceDisplayingFeaturesFromRelatedTiles(e){const t=e.descriptor.resolution;this.featureTiles.forEach((s=>{if(!(o(s.displayingFeatures)||e===s||e.descriptor.lij&&s.descriptor.lij&&!j(e.descriptor.lij,s.descriptor.lij))){o(e.displayingFeatures)&&(e.displayingFeatures=[]),e.descriptor.extent&&s.descriptor.extent&&(o(e.extentIncludingBorrowedFeatures)&&(e.extentIncludingBorrowedFeatures=F(e.descriptor.extent)),y(e.extentIncludingBorrowedFeatures,s.descriptor.extent,e.extentIncludingBorrowedFeatures));for(const i of s.displayingFeatures){e.displayingFeatures.push(i);const s=this.displayingFeatureReferences.get(R(i,this.objectIdField));s.ref(s.feature,t),this.numDisplayingFeatureReferences++}}})),e.featureLimit=a(e.displayingFeatures)?e.displayingFeatures.length:0}removeTile(e){this.clearTile(e),this.featureTiles.delete(e.id)}resetFetchTile(e){e.filtered=!e.intersects(this.filterExtent),e.filtered?e.needsFetching&&(e.fetchStatus=4):e.fetchStatus=0}cancelFetchTile(e){const t=e.requestController;a(t)&&(e.requestController=null,e.resetFetching(),t.abort())}async fetchTileCount(e,t){return e.numFeatures=await this.fetchCount(e,t),this.updateRatio(this.getListOfTiles()),3===e.fetchStatus?1:0}async fetchTile(e,t){const s=this.maximumFeaturesForTile(e);if(s<=0)return N(e);const i=this.getMaxRecordCount(e),r=Math.ceil(s/i);if(I(e)||!this.context.capabilities.supportsMaxRecordCountFactor||e.numFeatures<=s&&r>v.MAX_MAX_RECORD_COUNT_FACTOR)return this.fetchPagedTile(e,t);const a=this.createQuery(e);if(a.maxRecordCountFactor=Math.ceil(s/i),e.isRefetching&&e.features&&e.features.length>0){const t=Math.ceil(e.features.length/(1-e.emptyFeatureRatio)/i);a.maxRecordCountFactor=Math.max(t+1,a.maxRecordCountFactor)}const{features:n,exceededTransferLimit:o,fields:u}=await this.queryFeatures(a,t),l=o?a.maxRecordCountFactor>=v.MAX_MAX_RECORD_COUNT_FACTOR?5:4:5;return await this._frameTask.schedule((()=>{e.featuresMissing=n.length<e.numFeatures||o;const t=this._removeEmptyFeatures(n);e.setFeatures(n,t,Q(u))}),t),this.invalidateCounts(),l}async fetchCount(e,t){return this.context.query.queryFeatureCount(this.createFeatureCountQuery(e),{signal:t})}async fetchPagedTile(e,t){let s,i=0,r=0,a=0,n=this.maximumFeaturesForTile(e)-a;const o=this.getMaxRecordCount(e);let l=null;for(;;){const h=this.createQuery(e),c=this.setPagingParameters(h,i,n,o),{features:d,exceededTransferLimit:p,fields:f}=await this.queryFeatures(h,t);if(await this._frameTask.schedule((()=>{c&&(i+=u(h.num)),a+=d.length,r+=this._removeEmptyFeatures(d),e.featuresMissing=i<e.numFeatures||p,s=s?s.concat(d):d,l=k(l,f),e.setFeatures(s,r,l)}),t),this.invalidateCounts(),this.setDirty(),n=this.maximumFeaturesForTile(e)-a,!c||!p||n<=0)return p?4:5}}createFeatureCountQuery(e){const t=this.createQuery(e);return this.context.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t}createQuery(e){const t=this.context.createQuery(),s=e.descriptor.extent;if(s){const e=this.context.tilingScheme.spatialReference;t.geometry=T(s,e)}return this.setResolutionParams(t,e),this.useTileQuery(e)?t.resultType=\"tile\":this.context.capabilities.supportsCacheHint&&(t.cacheHint=!0),t}setPagingParameters(e,t,s,i){return!!this.context.capabilities.supportsPagination&&(e.start=t,s>0&&this.context.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(s/i),e.num=Math.min(e.maxRecordCountFactor*i,s)):e.num=Math.min(i),!0)}getEffectiveTileResolution(e){if(null==e.descriptor.resolution)return null;const t=1===this.context.viewingMode?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.descriptor.resolution,t)/this.lodFactor}get supportsResolution(){return this.context.capabilities.supportsMultipleResolutions&&\"point\"!==this.context.geometryType}setResolutionParams(e,t){if(!this.supportsResolution)return;const s=this.getEffectiveTileResolution(t);null!=s&&(this.context.capabilities.supportsQuantization?e.quantizationParameters=new E({mode:\"view\",originPosition:\"upper-left\",tolerance:s,extent:this.context.fullExtent}):\"polyline\"===this.context.geometryType&&(e.maxAllowableOffset=s))}_removeEmptyFeatures(e){const t=e.length;for(let s=0;s<e.length;){const t=e[s];C(t.geometry)?++s:(e[s]=e[e.length-1],--e.length)}return t-e.length}needsNumFeatures(e){return this.useTileCount&&e.needsFeatureCount&&!I(e)}getMaxRecordCount(e){const{tileMaxRecordCount:t,maxRecordCount:s}=this.context;return this.useTileQuery(e)&&a(t)&&t>0&&this.context.capabilities.supportsResultType?t:a(s)&&s>0?s:L}useTileQuery(e){return(!I(e)||!this.context.capabilities.supportsCacheHint)&&this.context.capabilities.supportsResultType}_handleRequest(e,t,s,i){e.fetchStatus=e.needsRefetching?3:2,e.requestController=s;let r=!1;t.then((t=>{e.requestController=null,e.fetchStatus=t})).catch((t=>{e.requestController===s&&(e.requestController=null,e.fetchStatus=4),h(t)?r=!0:i(t)})).then((()=>{r||this.setDirty(),this.scheduleUpdated()}))}scheduleUpdated(){this.handles&&!this.handles.has(\"scheduleUpdated\")&&this.handles.add(d((()=>{this.handles.remove(\"scheduleUpdated\"),this.updated()})),\"scheduleUpdated\")}showTile(e){if(a(e.displayingFeatures)&&!e.needsDisplayUpdate)return!1;const t=e.features;if(0===e.featureLimit||!t){const t=a(e.displayingFeatures)&&e.displayingFeatures.length>0;return this.hideTileFeatures(e),e.displayingFeatures=[],t}const s=e.descriptor.resolution,i=this.changes.updates,r=this.changes.adds,n=Math.min(e.featureLimit,t.length);e.featureLimit=n;for(let a=0;a<n;++a){const e=t[a],n=R(e,this.objectIdField),o=this.displayingFeatureReferences.get(n);if(o){const t=o.ref(e,s);t.oldVersion!==t.newVersion&&(i.removes.push(t.oldVersion),i.adds.push(t.newVersion))}else this.displayingFeatureReferences.set(n,new this.FeatureReferenceClass(e,s)),r.push(e);this.numDisplayingFeatureReferences++}return this.hideTileFeatures(e),this.applyChanges(),e.displayingFeatures=t.slice(0,n),!0}hideTile(e){this.cancelFetchTile(e),this.hideTileFeatures(e)}hideTileFeatures(e){if(o(e.displayingFeatures))return;const t=this.changes.updates,s=this.changes.removes;for(const i of e.displayingFeatures){const r=R(i,this.objectIdField),a=this.displayingFeatureReferences.get(r);if(!a)continue;const n=a.unref(e.descriptor.resolution);this.numDisplayingFeatureReferences--,n?n.oldVersion!==n.newVersion&&(null==n.newVersion?(this.displayingFeatureReferences.delete(r),s.push(n.oldVersion)):(t.adds.push(n.newVersion),t.removes.push(n.oldVersion))):console.error(\"Hiding unreferenced feature\")}this.applyChanges(),e.displayingFeatures=null}applyChanges(){const e=this.changes.updates;e.removes.length>0&&(this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this.features.addMany(e.adds),e.adds.length=0);const t=this.changes.adds,s=this.changes.removes,i=Math.min(t.length,s.length);let r=0;for(;r<i;){const e=Math.min(r+B,i);this.features.addMany(t.slice(r,e)),this.features.removeMany(s.slice(r,e)),r=e}t.length>i&&this.features.addMany(0===r?t:t.slice(r)),s.length>i&&this.features.removeMany(0===r?s:s.slice(r)),t.length=0,s.length=0}clearTile(e){if(this.hideTile(e),e.features&&a(this.context.memoryCache)){const t=16+e.estimatedSize;this.context.memoryCache.put(e.id,e.cache,t)}e.setFeatures(null,0,null),this.invalidateCounts()}invalidateCounts(){this.notifyChange(\"totalVertices\"),this.notifyChange(\"totalFeatures\"),this.notifyChange(\"memoryForUnusedFeatures\")}getListOfTiles(){return Array.from(this.featureTiles.values())}get storedFeatures(){return this.getListOfTiles().reduce(((e,t)=>e+(t.features?t.features.length:0)),0)}maximumFeaturesForTile(e){const t=e.hasPreciseFeatureCount?e.numFeatures:1/0,s=e.hasPreciseFeatureCount?t:this.maximumNumberOfFeatures,i=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(s*i/(1-e.emptyFeatureRatio)),t)}get test(){return{process:e=>this.runTask(e),getFeatureTileById:e=>this.featureTiles.get(e),forEachFeatureTile:e=>this.featureTiles.forEach(e)}}};function I(e){return\"dummy-tile-full-extent\"===e.id}function S(e){let t=0;for(const s of e)s.features&&s.features.length>0&&s.alive&&(t=Math.max(t,s.descriptor.lij[0]));return t}function U(e){const t=e.capabilities.query;return{supportsMultipleResolutions:A(e),supportsPagination:!(!t||!t.supportsPagination),supportsResultType:!(!t||!t.supportsResultType),supportsCacheHint:!(!t||!t.supportsCacheHint),supportsQuantization:!(!t||!t.supportsQuantization),supportsQuantizationEditMode:!(!t||!t.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!t||!t.supportsMaxRecordCountFactor),supportsFormatPBF:!(!t||!t.supportsFormatPBF)}}function A(e){switch(e.geometryType){case\"polyline\":return!0;case\"polygon\":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}}function N(e){return e.setFeatures([],0,null),e.featuresMissing=!1,4}function Q(e){return o(e)?new Set:new Set(e.map((e=>e.name)))}function k(e,t){if(o(e)||o(t))return Q(t);const s=new Set;for(const{name:i}of t)e.has(i)&&s.add(i);return s}e([f({constructOnly:!0})],q.prototype,\"features\",void 0),e([f()],q.prototype,\"tileDescriptors\",void 0),e([f({value:1/0})],q.prototype,\"maximumNumberOfFeatures\",null),e([f({value:1})],q.prototype,\"memoryFactor\",null),e([f({value:1})],q.prototype,\"lodFactor\",null),e([f()],q.prototype,\"useTileCount\",null),e([f({readOnly:!0})],q.prototype,\"updating\",void 0),e([f({readOnly:!0})],q.prototype,\"updatingTotal\",void 0),e([f({readOnly:!0})],q.prototype,\"updatingRemaining\",void 0),e([f({readOnly:!0})],q.prototype,\"expectedFeatureDiff\",void 0),e([f({readOnly:!0})],q.prototype,\"memoryForUnusedFeatures\",null),e([f({readOnly:!0})],q.prototype,\"maximumNumberOfFeaturesExceeded\",void 0),e([f({constructOnly:!0})],q.prototype,\"maximumNumberOfFeaturesExceededThrottle\",void 0),e([f({readOnly:!0})],q.prototype,\"totalVertices\",null),e([f({readOnly:!0})],q.prototype,\"totalFeatures\",null),e([f()],q.prototype,\"filterExtent\",null),e([f({constructOnly:!0})],q.prototype,\"context\",void 0),q=e([m(\"esri.views.3d.layers.support.FeatureTileFetcher3D\")],q);const L=2e3,V=x(),z=x(),H=6e5,B=200;var X=q;export default X;export{q as FeatureTileFetcher3D,U as contextCapabilitiesFromLayer};\n"]},"metadata":{},"sourceType":"module"}