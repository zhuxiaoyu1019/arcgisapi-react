{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from \"../../core/Logger.js\";\nimport { ResourceType as e } from \"./enums.js\";\nimport i from \"./Renderbuffer.js\";\nimport { webglValidateShadersEnabled as r } from \"./RenderingContext.js\";\nimport s from \"./Texture.js\";\nimport { getGpuMemoryUsage as h } from \"./Util.js\";\nconst n = t.getLogger(\"esri.views.webgl.FrameBufferObject\");\n\nclass o {\n  constructor(t, r, h, n) {\n    if (this._context = t, this._glName = null, this._depthAttachment = null, this._stencilAttachment = null, this._colorAttachments = new Map(), this._initialized = !1, this._desc = { ...r\n    }, t.instanceCounter.increment(e.Framebuffer, this), h) {\n      Array.isArray(h) || (h = [h]);\n\n      for (let e = 0; e < h.length; ++e) {\n        var o;\n        const i = h[e];\n        let r;\n        c(i) ? (r = i.descriptor, this._colorAttachments.set(36064 + e, i)) : (r = i, this._colorAttachments.set(36064 + e, new s(t, i))), 0 !== (null == (o = this._desc) ? void 0 : o.colorTarget) && console.error(\"Framebuffer is initialized with a texture however the descriptor indicates using a renderbuffer color attachment!\"), this._validateColorAttachmentPoint(36064 + e), this._validateTextureDimensions(r, this._desc);\n      }\n    }\n\n    if (n instanceof i) {\n      var a;\n      const t = null != (a = this._desc.depthStencilTarget) ? a : 3;\n      2 === t ? this._stencilAttachment = n : 1 === t || 3 === t ? this._depthAttachment = n : console.error('If a Renderbuffer is provided, \"depthStencilTarget\" must be one of STENCIL_RENDER_BUFFER, DEPTH_RENDER_BUFFER or DEPTH_STENCIL_RENDER_BUFFER'), l(n.descriptor, this._desc);\n    } else if (n) {\n      let t;\n      this._context.capabilities.depthTexture || console.error(\"Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture as an attachment!\"), c(n) ? (this._depthStencilTexture = n, t = n.descriptor) : this._depthStencilTexture = new s(this._context, n), this._validateTextureDimensions(t, this._desc);\n    }\n  }\n\n  dispose() {\n    if (!this._desc) return;\n\n    const t = this._context.getBoundFramebufferObject();\n\n    if (this._disposeColorAttachments(), this._disposeDepthStencilAttachments(), this._glName) {\n      this._context.gl.deleteFramebuffer(this._glName), this._glName = null;\n    }\n\n    this._context.bindFramebuffer(t), this._context.instanceCounter.decrement(e.Framebuffer, this), this._desc = null;\n  }\n\n  get glName() {\n    return this._glName;\n  }\n\n  get descriptor() {\n    return this._desc;\n  }\n\n  get colorTexture() {\n    const t = this._colorAttachments.get(36064);\n\n    return t && c(t) ? t : null;\n  }\n\n  get colorAttachment() {\n    return this._colorAttachments.get(36064);\n  }\n\n  get depthStencilAttachment() {\n    return this._depthStencilTexture || this._depthAttachment || this._stencilAttachment;\n  }\n\n  get depthStencilTexture() {\n    return this._depthStencilTexture;\n  }\n\n  get width() {\n    return this._desc.width;\n  }\n\n  get height() {\n    return this._desc.height;\n  }\n\n  get gpuMemoryUsage() {\n    return h(this.colorAttachment) + h(this.depthStencilAttachment);\n  }\n\n  getColorTexture(t) {\n    const e = this._colorAttachments.get(t);\n\n    return e && c(e) ? e : null;\n  }\n\n  attachColorTexture(t, e = 36064) {\n    if (!t) return;\n\n    this._validateColorAttachmentPoint(e);\n\n    const i = t.descriptor;\n\n    if (this._validateTextureDimensions(i, this._desc), this._disposeColorAttachments(), this._initialized) {\n      this._context.bindFramebuffer(this);\n\n      const i = this._context.gl;\n      i.framebufferTexture2D(i.FRAMEBUFFER, e, i.TEXTURE_2D, t.glName, 0);\n    }\n\n    this._colorAttachments.set(e, t);\n  }\n\n  detachColorTexture(t = 36064) {\n    const e = this._colorAttachments.get(t);\n\n    if (c(e)) {\n      const i = e;\n\n      if (this._initialized) {\n        this._context.bindFramebuffer(this);\n\n        const e = this._context.gl;\n        e.framebufferTexture2D(e.FRAMEBUFFER, t, e.TEXTURE_2D, null, 0);\n      }\n\n      return this._colorAttachments.delete(t), i;\n    }\n  }\n\n  attachDepthStencilTexture(t) {\n    if (!t) return;\n    const e = t.descriptor;\n\n    if (34041 !== e.pixelFormat && console.error(\"Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!\"), 34042 !== e.dataType && console.error(\"Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!\"), this._context.capabilities.depthTexture || console.error(\"Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture!\"), this._validateTextureDimensions(e, this._desc), this._desc.depthStencilTarget && 4 !== this._desc.depthStencilTarget && (this._desc.depthStencilTarget = 4), this._disposeDepthStencilAttachments(), this._initialized) {\n      this._context.bindFramebuffer(this);\n\n      const e = this._context.gl;\n      e.framebufferTexture2D(e.FRAMEBUFFER, e.DEPTH_STENCIL_ATTACHMENT, e.TEXTURE_2D, t.glName, 0);\n    }\n\n    this._depthStencilTexture = t;\n  }\n\n  detachDepthStencilTexture() {\n    const t = this._depthStencilTexture;\n\n    if (t && this._initialized) {\n      this._context.bindFramebuffer(this);\n\n      const t = this._context.gl;\n\n      this._context.gl.framebufferTexture2D(t.FRAMEBUFFER, t.DEPTH_STENCIL_ATTACHMENT, t.TEXTURE_2D, null, 0);\n    }\n\n    return this._depthStencilTexture = null, t;\n  }\n\n  attachDepthStencilBuffer(t) {\n    if (!t) return;\n    const e = t.descriptor;\n\n    if (34041 !== e.internalFormat && 33189 !== e.internalFormat && console.error(\"Depth/Stencil buffer must have correct internalFormat\"), l(e, this._desc), this._disposeDepthStencilAttachments(), this._desc.depthStencilTarget = 34041 === e.internalFormat ? 3 : 1, this._initialized) {\n      this._context.bindFramebuffer(this);\n\n      const e = this._context.gl,\n            i = 1 === this._desc.depthStencilTarget ? e.DEPTH_ATTACHMENT : e.DEPTH_STENCIL_ATTACHMENT;\n      e.framebufferRenderbuffer(e.FRAMEBUFFER, i, e.RENDERBUFFER, t.glName);\n    }\n\n    this._depthAttachment = t;\n  }\n\n  detachDepthStencilBuffer() {\n    const t = this._context.gl,\n          e = this._depthAttachment;\n\n    if (e && this._initialized) {\n      this._context.bindFramebuffer(this);\n\n      const e = 1 === this._desc.depthStencilTarget ? t.DEPTH_ATTACHMENT : t.DEPTH_STENCIL_ATTACHMENT;\n      t.framebufferRenderbuffer(t.FRAMEBUFFER, e, t.RENDERBUFFER, null);\n    }\n\n    return this._depthAttachment = null, e;\n  }\n\n  detachAll() {\n    this.detachColorTexture(), this.detachDepthStencilBuffer(), this.detachDepthStencilTexture();\n  }\n\n  copyToTexture(t, e, i, r, h, n, o) {\n    (t < 0 || e < 0 || h < 0 || n < 0) && console.error(\"Offsets cannot be negative!\"), (i <= 0 || r <= 0) && console.error(\"Copy width and height must be greater than zero!\");\n    const c = this._desc,\n          a = o.descriptor;\n    3553 !== o.descriptor.target && console.error(\"Texture target must be TEXTURE_2D!\"), (t + i > c.width || e + r > c.height || h + i > a.width || n + r > a.height) && console.error(\"Bad dimensions, the current input values will attempt to read or copy out of bounds!\");\n\n    const l = this._context,\n          _ = l.bindTexture(o, s.TEXTURE_UNIT_FOR_UPDATES);\n\n    l.bindFramebuffer(this), l.gl.copyTexSubImage2D(3553, 0, h, n, t, e, i, r), l.bindTexture(_, s.TEXTURE_UNIT_FOR_UPDATES);\n  }\n\n  readPixels(t, e, i, r, s, h, n) {\n    (i <= 0 || r <= 0) && console.error(\"Copy width and height must be greater than zero!\"), n || console.error(\"Target memory is not initialized!\"), this._context.bindFramebuffer(this);\n\n    this._context.gl.readPixels(t, e, i, r, s, h, n);\n  }\n\n  resize(t, e) {\n    const i = this._desc;\n\n    if (i.width !== t || i.height !== e) {\n      if (!this._initialized) return i.width = t, i.height = e, this._colorAttachments.forEach(i => {\n        i && i.resize(t, e);\n      }), void (this._depthStencilTexture && this._depthStencilTexture.resize(t, e));\n      i.width = t, i.height = e, this._colorAttachments.forEach(i => {\n        i && i.resize(t, e);\n      }), null != this._depthStencilTexture ? this._depthStencilTexture.resize(t, e) : (this._depthAttachment || this._stencilAttachment) && (this._depthAttachment && this._depthAttachment.resize(t, e), this._stencilAttachment && this._stencilAttachment.resize(t, e)), this._context.getBoundFramebufferObject() === this && this._context.bindFramebuffer(null), this._initialized = !1;\n    }\n  }\n\n  initializeAndBind() {\n    var t, e, h, n;\n    const o = this._context.gl;\n    if (this._initialized) return void o.bindFramebuffer(o.FRAMEBUFFER, this.glName);\n    this._glName && o.deleteFramebuffer(this._glName);\n\n    const l = this._context,\n          _ = o.createFramebuffer(),\n          d = this._desc,\n          u = null != (t = d.colorTarget) ? t : 1,\n          f = null != (e = d.width) ? e : 1,\n          T = null != (h = d.height) ? h : 1;\n\n    if (o.bindFramebuffer(o.FRAMEBUFFER, _), 0 === this._colorAttachments.size) if (0 === u) this._colorAttachments.set(36064, a(l, d));else {\n      const t = new i(l, {\n        internalFormat: 32854,\n        width: f,\n        height: T\n      });\n\n      this._colorAttachments.set(36064, t);\n    }\n\n    this._colorAttachments.forEach((t, e) => {\n      t && (c(t) ? o.framebufferTexture2D(o.FRAMEBUFFER, e, o.TEXTURE_2D, t.glName, 0) : o.framebufferRenderbuffer(o.FRAMEBUFFER, o.COLOR_ATTACHMENT0, o.RENDERBUFFER, t.glName));\n    });\n\n    const m = null != (n = d.depthStencilTarget) ? n : 0;\n\n    switch (m) {\n      case 1:\n      case 3:\n        {\n          this._depthAttachment || (this._depthAttachment = new i(l, {\n            internalFormat: 1 === d.depthStencilTarget ? 33189 : 34041,\n            width: f,\n            height: T\n          }));\n          const t = 1 === m ? o.DEPTH_ATTACHMENT : o.DEPTH_STENCIL_ATTACHMENT;\n          o.framebufferRenderbuffer(o.FRAMEBUFFER, t, o.RENDERBUFFER, this._depthAttachment.glName);\n          break;\n        }\n\n      case 2:\n        this._stencilAttachment || (this._stencilAttachment = new i(l, {\n          internalFormat: 36168,\n          width: f,\n          height: T\n        })), o.framebufferRenderbuffer(o.FRAMEBUFFER, o.STENCIL_ATTACHMENT, o.RENDERBUFFER, this._stencilAttachment.glName);\n        break;\n\n      case 4:\n        if (!this._depthStencilTexture) {\n          l.capabilities.depthTexture || console.error(\"Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture as an attachment!\");\n          const t = {\n            target: 3553,\n            pixelFormat: 34041,\n            dataType: 34042,\n            samplingMode: 9728,\n            wrapMode: 33071,\n            width: f,\n            height: T\n          };\n          this._depthStencilTexture = new s(l, t);\n        }\n\n        o.framebufferTexture2D(o.FRAMEBUFFER, o.DEPTH_STENCIL_ATTACHMENT, o.TEXTURE_2D, this._depthStencilTexture.glName, 0);\n    }\n\n    if (r()) {\n      o.checkFramebufferStatus(o.FRAMEBUFFER) !== o.FRAMEBUFFER_COMPLETE && console.error(\"Framebuffer is incomplete!\");\n    }\n\n    this._glName = _, this._initialized = !0;\n  }\n\n  _disposeColorAttachments() {\n    this._colorAttachments.forEach((t, e) => {\n      if (c(t)) {\n        if (this._initialized) {\n          this._context.bindFramebuffer(this);\n\n          const t = this._context.gl;\n          t.framebufferTexture2D(t.FRAMEBUFFER, e, t.TEXTURE_2D, null, 0);\n        }\n\n        t.dispose();\n      } else if (t instanceof WebGLRenderbuffer) {\n        const i = this._context.gl;\n        this._initialized && (this._context.bindFramebuffer(this), i.framebufferRenderbuffer(i.FRAMEBUFFER, e, i.RENDERBUFFER, null)), this._context.gl.deleteRenderbuffer(t);\n      }\n    }), this._colorAttachments.clear();\n  }\n\n  _disposeDepthStencilAttachments() {\n    const t = this._context.gl;\n\n    if (this._depthAttachment) {\n      if (this._initialized) {\n        this._context.bindFramebuffer(this);\n\n        const e = 1 === this._desc.depthStencilTarget ? t.DEPTH_ATTACHMENT : t.DEPTH_STENCIL_ATTACHMENT;\n        t.framebufferRenderbuffer(t.FRAMEBUFFER, e, t.RENDERBUFFER, null);\n      }\n\n      this._depthAttachment.dispose(), this._depthAttachment = null;\n    }\n\n    this._stencilAttachment && (this._initialized && (this._context.bindFramebuffer(this), t.framebufferRenderbuffer(t.FRAMEBUFFER, t.STENCIL_ATTACHMENT, t.RENDERBUFFER, null)), this._stencilAttachment.dispose(), this._stencilAttachment = null), this._depthStencilTexture && (this._initialized && (this._context.bindFramebuffer(this), t.framebufferTexture2D(t.FRAMEBUFFER, t.DEPTH_STENCIL_ATTACHMENT, t.TEXTURE_2D, null, 0)), this._depthStencilTexture.dispose(), this._depthStencilTexture = null);\n  }\n\n  _validateTextureDimensions(t, e) {\n    3553 !== t.target && console.error(\"Texture type must be TEXTURE_2D!\"), void 0 !== e.width && e.width >= 0 && void 0 !== e.height && e.height >= 0 ? e.width === t.width && e.height === t.height || console.error(\"Color attachment texture must match the framebuffer's!\") : (e.width = t.width, e.height = t.height);\n  }\n\n  _validateColorAttachmentPoint(t) {\n    if (-1 === o._MAX_COLOR_ATTACHMENTS) {\n      const t = this._context.capabilities.drawBuffers;\n\n      if (t) {\n        const e = this._context.gl;\n        o._MAX_COLOR_ATTACHMENTS = e.getParameter(t.MAX_COLOR_ATTACHMENTS);\n      } else o._MAX_COLOR_ATTACHMENTS = 1;\n    }\n\n    const e = t - 36064;\n    e + 1 > o._MAX_COLOR_ATTACHMENTS && n.error(\"esri.FrameBufferObject\", `illegal attachment point for color attachment: ${e + 1}. Implementation supports up to ${o._MAX_COLOR_ATTACHMENTS} color attachments`);\n  }\n\n}\n\nfunction c(t) {\n  return \"type\" in t && \"texture\" === t.type;\n}\n\nfunction a(t, e) {\n  return new s(t, {\n    target: 3553,\n    pixelFormat: 6408,\n    dataType: 5121,\n    samplingMode: 9728,\n    wrapMode: 33071,\n    width: e.width,\n    height: e.height\n  });\n}\n\nfunction l(t, e) {\n  void 0 !== e.width && e.width >= 0 && void 0 !== e.height && e.height >= 0 ? e.width === t.width && e.height === t.height || console.error(\"Renderbuffer dimensions must match the framebuffer's!\") : (e.width = t.width, e.height = t.height);\n}\n\no._MAX_COLOR_ATTACHMENTS = -1;\nexport default o;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/webgl/FramebufferObject.js"],"names":["t","ResourceType","e","i","webglValidateShadersEnabled","r","s","getGpuMemoryUsage","h","n","getLogger","o","constructor","_context","_glName","_depthAttachment","_stencilAttachment","_colorAttachments","Map","_initialized","_desc","instanceCounter","increment","Framebuffer","Array","isArray","length","c","descriptor","set","colorTarget","console","error","_validateColorAttachmentPoint","_validateTextureDimensions","a","depthStencilTarget","l","capabilities","depthTexture","_depthStencilTexture","dispose","getBoundFramebufferObject","_disposeColorAttachments","_disposeDepthStencilAttachments","gl","deleteFramebuffer","bindFramebuffer","decrement","glName","colorTexture","get","colorAttachment","depthStencilAttachment","depthStencilTexture","width","height","gpuMemoryUsage","getColorTexture","attachColorTexture","framebufferTexture2D","FRAMEBUFFER","TEXTURE_2D","detachColorTexture","delete","attachDepthStencilTexture","pixelFormat","dataType","DEPTH_STENCIL_ATTACHMENT","detachDepthStencilTexture","attachDepthStencilBuffer","internalFormat","DEPTH_ATTACHMENT","framebufferRenderbuffer","RENDERBUFFER","detachDepthStencilBuffer","detachAll","copyToTexture","target","_","bindTexture","TEXTURE_UNIT_FOR_UPDATES","copyTexSubImage2D","readPixels","resize","forEach","initializeAndBind","createFramebuffer","d","u","f","T","size","COLOR_ATTACHMENT0","m","STENCIL_ATTACHMENT","samplingMode","wrapMode","checkFramebufferStatus","FRAMEBUFFER_COMPLETE","WebGLRenderbuffer","deleteRenderbuffer","clear","_MAX_COLOR_ATTACHMENTS","drawBuffers","getParameter","MAX_COLOR_ATTACHMENTS","type"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from\"../../core/Logger.js\";import{ResourceType as e}from\"./enums.js\";import i from\"./Renderbuffer.js\";import{webglValidateShadersEnabled as r}from\"./RenderingContext.js\";import s from\"./Texture.js\";import{getGpuMemoryUsage as h}from\"./Util.js\";const n=t.getLogger(\"esri.views.webgl.FrameBufferObject\");class o{constructor(t,r,h,n){if(this._context=t,this._glName=null,this._depthAttachment=null,this._stencilAttachment=null,this._colorAttachments=new Map,this._initialized=!1,this._desc={...r},t.instanceCounter.increment(e.Framebuffer,this),h){Array.isArray(h)||(h=[h]);for(let e=0;e<h.length;++e){var o;const i=h[e];let r;c(i)?(r=i.descriptor,this._colorAttachments.set(36064+e,i)):(r=i,this._colorAttachments.set(36064+e,new s(t,i))),0!==(null==(o=this._desc)?void 0:o.colorTarget)&&console.error(\"Framebuffer is initialized with a texture however the descriptor indicates using a renderbuffer color attachment!\"),this._validateColorAttachmentPoint(36064+e),this._validateTextureDimensions(r,this._desc)}}if(n instanceof i){var a;const t=null!=(a=this._desc.depthStencilTarget)?a:3;2===t?this._stencilAttachment=n:1===t||3===t?this._depthAttachment=n:console.error('If a Renderbuffer is provided, \"depthStencilTarget\" must be one of STENCIL_RENDER_BUFFER, DEPTH_RENDER_BUFFER or DEPTH_STENCIL_RENDER_BUFFER'),l(n.descriptor,this._desc)}else if(n){let t;this._context.capabilities.depthTexture||console.error(\"Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture as an attachment!\"),c(n)?(this._depthStencilTexture=n,t=n.descriptor):this._depthStencilTexture=new s(this._context,n),this._validateTextureDimensions(t,this._desc)}}dispose(){if(!this._desc)return;const t=this._context.getBoundFramebufferObject();if(this._disposeColorAttachments(),this._disposeDepthStencilAttachments(),this._glName){this._context.gl.deleteFramebuffer(this._glName),this._glName=null}this._context.bindFramebuffer(t),this._context.instanceCounter.decrement(e.Framebuffer,this),this._desc=null}get glName(){return this._glName}get descriptor(){return this._desc}get colorTexture(){const t=this._colorAttachments.get(36064);return t&&c(t)?t:null}get colorAttachment(){return this._colorAttachments.get(36064)}get depthStencilAttachment(){return this._depthStencilTexture||this._depthAttachment||this._stencilAttachment}get depthStencilTexture(){return this._depthStencilTexture}get width(){return this._desc.width}get height(){return this._desc.height}get gpuMemoryUsage(){return h(this.colorAttachment)+h(this.depthStencilAttachment)}getColorTexture(t){const e=this._colorAttachments.get(t);return e&&c(e)?e:null}attachColorTexture(t,e=36064){if(!t)return;this._validateColorAttachmentPoint(e);const i=t.descriptor;if(this._validateTextureDimensions(i,this._desc),this._disposeColorAttachments(),this._initialized){this._context.bindFramebuffer(this);const i=this._context.gl;i.framebufferTexture2D(i.FRAMEBUFFER,e,i.TEXTURE_2D,t.glName,0)}this._colorAttachments.set(e,t)}detachColorTexture(t=36064){const e=this._colorAttachments.get(t);if(c(e)){const i=e;if(this._initialized){this._context.bindFramebuffer(this);const e=this._context.gl;e.framebufferTexture2D(e.FRAMEBUFFER,t,e.TEXTURE_2D,null,0)}return this._colorAttachments.delete(t),i}}attachDepthStencilTexture(t){if(!t)return;const e=t.descriptor;if(34041!==e.pixelFormat&&console.error(\"Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!\"),34042!==e.dataType&&console.error(\"Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!\"),this._context.capabilities.depthTexture||console.error(\"Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture!\"),this._validateTextureDimensions(e,this._desc),this._desc.depthStencilTarget&&4!==this._desc.depthStencilTarget&&(this._desc.depthStencilTarget=4),this._disposeDepthStencilAttachments(),this._initialized){this._context.bindFramebuffer(this);const e=this._context.gl;e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,t.glName,0)}this._depthStencilTexture=t}detachDepthStencilTexture(){const t=this._depthStencilTexture;if(t&&this._initialized){this._context.bindFramebuffer(this);const t=this._context.gl;this._context.gl.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.TEXTURE_2D,null,0)}return this._depthStencilTexture=null,t}attachDepthStencilBuffer(t){if(!t)return;const e=t.descriptor;if(34041!==e.internalFormat&&33189!==e.internalFormat&&console.error(\"Depth/Stencil buffer must have correct internalFormat\"),l(e,this._desc),this._disposeDepthStencilAttachments(),this._desc.depthStencilTarget=34041===e.internalFormat?3:1,this._initialized){this._context.bindFramebuffer(this);const e=this._context.gl,i=1===this._desc.depthStencilTarget?e.DEPTH_ATTACHMENT:e.DEPTH_STENCIL_ATTACHMENT;e.framebufferRenderbuffer(e.FRAMEBUFFER,i,e.RENDERBUFFER,t.glName)}this._depthAttachment=t}detachDepthStencilBuffer(){const t=this._context.gl,e=this._depthAttachment;if(e&&this._initialized){this._context.bindFramebuffer(this);const e=1===this._desc.depthStencilTarget?t.DEPTH_ATTACHMENT:t.DEPTH_STENCIL_ATTACHMENT;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,null)}return this._depthAttachment=null,e}detachAll(){this.detachColorTexture(),this.detachDepthStencilBuffer(),this.detachDepthStencilTexture()}copyToTexture(t,e,i,r,h,n,o){(t<0||e<0||h<0||n<0)&&console.error(\"Offsets cannot be negative!\"),(i<=0||r<=0)&&console.error(\"Copy width and height must be greater than zero!\");const c=this._desc,a=o.descriptor;3553!==o.descriptor.target&&console.error(\"Texture target must be TEXTURE_2D!\"),(t+i>c.width||e+r>c.height||h+i>a.width||n+r>a.height)&&console.error(\"Bad dimensions, the current input values will attempt to read or copy out of bounds!\");const l=this._context,_=l.bindTexture(o,s.TEXTURE_UNIT_FOR_UPDATES);l.bindFramebuffer(this),l.gl.copyTexSubImage2D(3553,0,h,n,t,e,i,r),l.bindTexture(_,s.TEXTURE_UNIT_FOR_UPDATES)}readPixels(t,e,i,r,s,h,n){(i<=0||r<=0)&&console.error(\"Copy width and height must be greater than zero!\"),n||console.error(\"Target memory is not initialized!\"),this._context.bindFramebuffer(this);this._context.gl.readPixels(t,e,i,r,s,h,n)}resize(t,e){const i=this._desc;if(i.width!==t||i.height!==e){if(!this._initialized)return i.width=t,i.height=e,this._colorAttachments.forEach((i=>{i&&i.resize(t,e)})),void(this._depthStencilTexture&&this._depthStencilTexture.resize(t,e));i.width=t,i.height=e,this._colorAttachments.forEach((i=>{i&&i.resize(t,e)})),null!=this._depthStencilTexture?this._depthStencilTexture.resize(t,e):(this._depthAttachment||this._stencilAttachment)&&(this._depthAttachment&&this._depthAttachment.resize(t,e),this._stencilAttachment&&this._stencilAttachment.resize(t,e)),this._context.getBoundFramebufferObject()===this&&this._context.bindFramebuffer(null),this._initialized=!1}}initializeAndBind(){var t,e,h,n;const o=this._context.gl;if(this._initialized)return void o.bindFramebuffer(o.FRAMEBUFFER,this.glName);this._glName&&o.deleteFramebuffer(this._glName);const l=this._context,_=o.createFramebuffer(),d=this._desc,u=null!=(t=d.colorTarget)?t:1,f=null!=(e=d.width)?e:1,T=null!=(h=d.height)?h:1;if(o.bindFramebuffer(o.FRAMEBUFFER,_),0===this._colorAttachments.size)if(0===u)this._colorAttachments.set(36064,a(l,d));else{const t=new i(l,{internalFormat:32854,width:f,height:T});this._colorAttachments.set(36064,t)}this._colorAttachments.forEach(((t,e)=>{t&&(c(t)?o.framebufferTexture2D(o.FRAMEBUFFER,e,o.TEXTURE_2D,t.glName,0):o.framebufferRenderbuffer(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.RENDERBUFFER,t.glName))}));const m=null!=(n=d.depthStencilTarget)?n:0;switch(m){case 1:case 3:{this._depthAttachment||(this._depthAttachment=new i(l,{internalFormat:1===d.depthStencilTarget?33189:34041,width:f,height:T}));const t=1===m?o.DEPTH_ATTACHMENT:o.DEPTH_STENCIL_ATTACHMENT;o.framebufferRenderbuffer(o.FRAMEBUFFER,t,o.RENDERBUFFER,this._depthAttachment.glName);break}case 2:this._stencilAttachment||(this._stencilAttachment=new i(l,{internalFormat:36168,width:f,height:T})),o.framebufferRenderbuffer(o.FRAMEBUFFER,o.STENCIL_ATTACHMENT,o.RENDERBUFFER,this._stencilAttachment.glName);break;case 4:if(!this._depthStencilTexture){l.capabilities.depthTexture||console.error(\"Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture as an attachment!\");const t={target:3553,pixelFormat:34041,dataType:34042,samplingMode:9728,wrapMode:33071,width:f,height:T};this._depthStencilTexture=new s(l,t)}o.framebufferTexture2D(o.FRAMEBUFFER,o.DEPTH_STENCIL_ATTACHMENT,o.TEXTURE_2D,this._depthStencilTexture.glName,0)}if(r()){o.checkFramebufferStatus(o.FRAMEBUFFER)!==o.FRAMEBUFFER_COMPLETE&&console.error(\"Framebuffer is incomplete!\")}this._glName=_,this._initialized=!0}_disposeColorAttachments(){this._colorAttachments.forEach(((t,e)=>{if(c(t)){if(this._initialized){this._context.bindFramebuffer(this);const t=this._context.gl;t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,null,0)}t.dispose()}else if(t instanceof WebGLRenderbuffer){const i=this._context.gl;this._initialized&&(this._context.bindFramebuffer(this),i.framebufferRenderbuffer(i.FRAMEBUFFER,e,i.RENDERBUFFER,null)),this._context.gl.deleteRenderbuffer(t)}})),this._colorAttachments.clear()}_disposeDepthStencilAttachments(){const t=this._context.gl;if(this._depthAttachment){if(this._initialized){this._context.bindFramebuffer(this);const e=1===this._desc.depthStencilTarget?t.DEPTH_ATTACHMENT:t.DEPTH_STENCIL_ATTACHMENT;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,null)}this._depthAttachment.dispose(),this._depthAttachment=null}this._stencilAttachment&&(this._initialized&&(this._context.bindFramebuffer(this),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.STENCIL_ATTACHMENT,t.RENDERBUFFER,null)),this._stencilAttachment.dispose(),this._stencilAttachment=null),this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.TEXTURE_2D,null,0)),this._depthStencilTexture.dispose(),this._depthStencilTexture=null)}_validateTextureDimensions(t,e){3553!==t.target&&console.error(\"Texture type must be TEXTURE_2D!\"),void 0!==e.width&&e.width>=0&&void 0!==e.height&&e.height>=0?e.width===t.width&&e.height===t.height||console.error(\"Color attachment texture must match the framebuffer's!\"):(e.width=t.width,e.height=t.height)}_validateColorAttachmentPoint(t){if(-1===o._MAX_COLOR_ATTACHMENTS){const t=this._context.capabilities.drawBuffers;if(t){const e=this._context.gl;o._MAX_COLOR_ATTACHMENTS=e.getParameter(t.MAX_COLOR_ATTACHMENTS)}else o._MAX_COLOR_ATTACHMENTS=1}const e=t-36064;e+1>o._MAX_COLOR_ATTACHMENTS&&n.error(\"esri.FrameBufferObject\",`illegal attachment point for color attachment: ${e+1}. Implementation supports up to ${o._MAX_COLOR_ATTACHMENTS} color attachments`)}}function c(t){return\"type\"in t&&\"texture\"===t.type}function a(t,e){return new s(t,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:e.width,height:e.height})}function l(t,e){void 0!==e.width&&e.width>=0&&void 0!==e.height&&e.height>=0?e.width===t.width&&e.height===t.height||console.error(\"Renderbuffer dimensions must match the framebuffer's!\"):(e.width=t.width,e.height=t.height)}o._MAX_COLOR_ATTACHMENTS=-1;export default o;\n"]},"metadata":{},"sourceType":"module"}