{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport \"../../../../../../core/has.js\";\nimport { isSome as e } from \"../../../../../../core/maybe.js\";\nimport { isAborted as t } from \"../../../../../../core/promiseUtils.js\";\nimport r from \"../templates/WGLLabelTemplate.js\";\nimport s from \"../templates/WGLMarkerTemplate.js\";\nimport { isDynamicId as o } from \"../templates/WGLTemplateStore.js\";\nimport { isAggregateId as a } from \"../../../../layers/features/support/AttributeStore.js\";\n\nclass i {\n  constructor(e, t, r) {\n    this._geometryType = e, this._idField = t, this._templateStore = r;\n  }\n\n  update(t, r) {\n    e(t.mesh.labels) && (this._labelTemplates = this._createLabelTemplates(t.mesh.labels, r));\n  }\n\n  _createLabelTemplates(e, t) {\n    const s = new Map();\n\n    if (\"simple\" === e.type) {\n      for (const o of e.classes) {\n        const e = r.fromLabelClass(o, t);\n        s.set(o.index, e);\n      }\n\n      return s;\n    }\n\n    for (const o in e.classes) {\n      const a = e.classes[o];\n\n      for (const e of a) {\n        const o = r.fromLabelClass(e, t);\n        s.set(e.index, o);\n      }\n    }\n\n    return s;\n  }\n\n  get templates() {\n    return this._templateStore;\n  }\n\n  async analyze(r, s, i, l, n, p) {\n    if (t(p)) return;\n    let f;\n    \"dictionary\" === s.type && (f = await s.analyze(this._idField, r.copy(), l, n, p));\n    let m = 0;\n\n    for (; r.next();) {\n      let t;\n\n      if (t = f ? f[m++] : e(i) && a(r.getDisplayId()) && 1 !== r.readAttribute(\"cluster_count\") ? i.match(this._idField, r, this._geometryType, l, n) : s.match(this._idField, r, this._geometryType, l, n), r.setGroupId(t), o(t)) {\n        const e = this._templateStore.getDynamicTemplateGroup(t);\n\n        for (const t of e) t && t.analyze && t.analyze(this._templateStore, r, l, n);\n      }\n    }\n\n    return this._templateStore.finalize(p);\n  }\n\n  async analyzeGraphics(e, r, s, a, i) {\n    if (t(i)) return;\n    const l = e.getCursor();\n\n    for (r && (await r.analyze(this._idField, l.copy(), s, a, i)); l.next();) {\n      let e = l.getGroupId();\n\n      if (null != e && -1 !== e || (e = r.match(this._idField, l, l.geometryType, s, a), l.setGroupId(e)), o(e)) {\n        const t = this._templateStore.getDynamicTemplateGroup(e);\n\n        for (const e of t) e && e.analyze && e.analyze(this._templateStore, l, s, a);\n      }\n\n      l.setGroupId(e);\n    }\n\n    return this._templateStore.finalize(i);\n  }\n\n  writeGraphic(e, t, r) {\n    const s = t.getGroupId(),\n          a = t.getDisplayId(),\n          i = this._templateStore.getTemplateGroup(s);\n\n    if (e.featureStart(t.insertAfter), null != a) {\n      if (o(s)) for (const e of i) e.bindFeature(t, null, null);\n\n      if (i) {\n        for (const s of i) s && s.write(e, t, r);\n\n        e.featureEnd();\n      }\n    }\n  }\n\n  writeCursor(t, r, s, a, i, l) {\n    const n = r.getGroupId(),\n          p = r.getDisplayId(),\n          f = this._templateStore.getTemplateGroup(n);\n\n    if (r.getObjectId(), null != p && f) {\n      if (o(n)) for (const e of f) e.bindFeature(r, s, a);\n\n      for (const e of f) e.write(t, r, i);\n\n      if (e(l) && t.hasRecords) {\n        const e = l && this._findLabelRef(f);\n\n        this._writeLabels(t, r, l, e, i);\n      }\n    }\n  }\n\n  _findLabelRef(e) {\n    for (const t of e) if (t instanceof s) return t;\n\n    return null;\n  }\n\n  _writeLabels(t, r, s, o, a) {\n    for (const i of s) if (e(i) && i) {\n      const {\n        glyphs: e,\n        rtl: s,\n        index: l\n      } = i,\n            n = this._labelTemplates.get(l);\n\n      n.setZoomLevel(a), n.bindReferenceTemplate(o), n.bindTextInfo(e, s), n.write(t, r, null);\n    }\n  }\n\n}\n\nexport { i as WGLMeshFactory };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/2d/engine/webgl/mesh/factories/WGLMeshFactory.js"],"names":["isSome","e","isAborted","t","r","s","isDynamicId","o","isAggregateId","a","i","constructor","_geometryType","_idField","_templateStore","update","mesh","labels","_labelTemplates","_createLabelTemplates","Map","type","classes","fromLabelClass","set","index","templates","analyze","l","n","p","f","copy","m","next","getDisplayId","readAttribute","match","setGroupId","getDynamicTemplateGroup","finalize","analyzeGraphics","getCursor","getGroupId","geometryType","writeGraphic","getTemplateGroup","featureStart","insertAfter","bindFeature","write","featureEnd","writeCursor","getObjectId","hasRecords","_findLabelRef","_writeLabels","glyphs","rtl","get","setZoomLevel","bindReferenceTemplate","bindTextInfo","WGLMeshFactory"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport\"../../../../../../core/has.js\";import{isSome as e}from\"../../../../../../core/maybe.js\";import{isAborted as t}from\"../../../../../../core/promiseUtils.js\";import r from\"../templates/WGLLabelTemplate.js\";import s from\"../templates/WGLMarkerTemplate.js\";import{isDynamicId as o}from\"../templates/WGLTemplateStore.js\";import{isAggregateId as a}from\"../../../../layers/features/support/AttributeStore.js\";class i{constructor(e,t,r){this._geometryType=e,this._idField=t,this._templateStore=r}update(t,r){e(t.mesh.labels)&&(this._labelTemplates=this._createLabelTemplates(t.mesh.labels,r))}_createLabelTemplates(e,t){const s=new Map;if(\"simple\"===e.type){for(const o of e.classes){const e=r.fromLabelClass(o,t);s.set(o.index,e)}return s}for(const o in e.classes){const a=e.classes[o];for(const e of a){const o=r.fromLabelClass(e,t);s.set(e.index,o)}}return s}get templates(){return this._templateStore}async analyze(r,s,i,l,n,p){if(t(p))return;let f;\"dictionary\"===s.type&&(f=await s.analyze(this._idField,r.copy(),l,n,p));let m=0;for(;r.next();){let t;if(t=f?f[m++]:e(i)&&a(r.getDisplayId())&&1!==r.readAttribute(\"cluster_count\")?i.match(this._idField,r,this._geometryType,l,n):s.match(this._idField,r,this._geometryType,l,n),r.setGroupId(t),o(t)){const e=this._templateStore.getDynamicTemplateGroup(t);for(const t of e)t&&t.analyze&&t.analyze(this._templateStore,r,l,n)}}return this._templateStore.finalize(p)}async analyzeGraphics(e,r,s,a,i){if(t(i))return;const l=e.getCursor();for(r&&await r.analyze(this._idField,l.copy(),s,a,i);l.next();){let e=l.getGroupId();if(null!=e&&-1!==e||(e=r.match(this._idField,l,l.geometryType,s,a),l.setGroupId(e)),o(e)){const t=this._templateStore.getDynamicTemplateGroup(e);for(const e of t)e&&e.analyze&&e.analyze(this._templateStore,l,s,a)}l.setGroupId(e)}return this._templateStore.finalize(i)}writeGraphic(e,t,r){const s=t.getGroupId(),a=t.getDisplayId(),i=this._templateStore.getTemplateGroup(s);if(e.featureStart(t.insertAfter),null!=a){if(o(s))for(const e of i)e.bindFeature(t,null,null);if(i){for(const s of i)s&&s.write(e,t,r);e.featureEnd()}}}writeCursor(t,r,s,a,i,l){const n=r.getGroupId(),p=r.getDisplayId(),f=this._templateStore.getTemplateGroup(n);if(r.getObjectId(),null!=p&&f){if(o(n))for(const e of f)e.bindFeature(r,s,a);for(const e of f)e.write(t,r,i);if(e(l)&&t.hasRecords){const e=l&&this._findLabelRef(f);this._writeLabels(t,r,l,e,i)}}}_findLabelRef(e){for(const t of e)if(t instanceof s)return t;return null}_writeLabels(t,r,s,o,a){for(const i of s)if(e(i)&&i){const{glyphs:e,rtl:s,index:l}=i,n=this._labelTemplates.get(l);n.setZoomLevel(a),n.bindReferenceTemplate(o),n.bindTextInfo(e,s),n.write(t,r,null)}}}export{i as WGLMeshFactory};\n"]},"metadata":{},"sourceType":"module"}