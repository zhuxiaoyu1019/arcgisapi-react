{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../core/Handles.js\";\nimport { on as t } from \"../../../core/watchUtils.js\";\nimport { a } from \"../../../chunks/mat4.js\";\nimport { c as r } from \"../../../chunks/mat4f64.js\";\nimport { s } from \"../../../chunks/vec2.js\";\nimport { a as i } from \"../../../chunks/vec2f64.js\";\nimport { s as n, l as o, g as h, a as d, b as c } from \"../../../chunks/vec3.js\";\nimport { c as m, f as l, a as u } from \"../../../chunks/vec3f64.js\";\nimport { s as p } from \"../../../chunks/vec4.js\";\nimport { c as _, f as v } from \"../../../chunks/vec4f64.js\";\nimport { earth as f } from \"../../../geometry/support/Ellipsoid.js\";\nimport { computeInnerAltitudeFade as D, INNER_ATMOSPHERE_DEPTH as g } from \"./atmosphereUtils.js\";\nimport { RealisticAtmosphereTechniqueConfiguration as w, RealisticAtmosphereTechnique as b } from \"./RealisticAtmosphereTechnique.js\";\nimport { glLayout as j } from \"../support/buffer/glUtil.js\";\nimport { newLayout as P } from \"../support/buffer/InterleavedLayout.js\";\nimport { Default3D as x } from \"../webgl-engine/lib/DefaultVertexAttributeLocations.js\";\nimport T from \"../../webgl/BufferObject.js\";\nimport B from \"../../webgl/VertexArrayObject.js\";\n\nclass S {\n  constructor(e) {\n    this._view = e, this.canRender = !0, this._skyslot = 14, this._hazeSlot = 15, this._renderData = {\n      texDepth: i(),\n      cameraPosition: m(),\n      projectionInverse: r(),\n      viewInverse: r(),\n      heightParameters: _(),\n      atmosphereParameters1: _(),\n      atmosphereParameters2: _(),\n      atmosphereParameters3: m(),\n      invWavelength: E,\n      invWavelengthScaled: H,\n      radii: i(),\n      scale: 0,\n      scaleDepth: q,\n      lowerAlphaBlendBound: 0,\n      scaleOverScaleDepth: 0,\n      oneOverScaleDepth: 0,\n      scaleDepthBlue: U,\n      oneOverScaleDepthBlue: F,\n      scaleOverScaleDepthBlue: 0,\n      g: k,\n      g2: k * k,\n      miePhaseCoefficients: z,\n      nearFar: i(),\n      cameraHeight: 0,\n      cameraHeightSq: 0,\n      C: 0,\n      CSur: 0,\n      innerFadeDistance: 0,\n      altitudeFade: 0\n    }, this._lowerElevationBoundRadius = 0, this._lowerBoundEarthRadius = f.radius, this._updateRadius(f.radius);\n  }\n\n  destroy() {\n    this._handles && (this._handles.destroy(), this._handles = null), this._vao && (this._vao.dispose(), this._vao = null);\n  }\n\n  when() {\n    return Promise.resolve();\n  }\n\n  initializeRenderContext(a) {\n    const r = a.renderContext.rctx;\n    this._handles = new e(), this._updateElevation({\n      spatialReference: this._view.basemapTerrain.spatialReference,\n      tile: this._view.basemapTerrain.rootTiles[0],\n      extent: this._view.basemapTerrain.rootTiles[0].extent,\n      context: \"ground\"\n    }), this._handles.add(t(this._view, \"basemapTerrain\", \"elevation-change\", e => this._updateElevation(e), () => this._updateElevation())), this._handles.add(t(this._view, \"basemapTerrain\", \"elevation-bounds-change\", () => this._updateVisibleElevationBounds(), () => this._updateVisibleElevationBounds()));\n    const s = new w();\n    s.haze = !1, this._atmosphereTechnique = a.shaderTechniqueRep.acquire(b, s), s.haze = !0, this._atmosphereHazeTechnique = a.shaderTechniqueRep.acquire(b, s), this._vao = this._createVertexArrayObject(r);\n  }\n\n  uninitializeRenderContext() {\n    this.destroy();\n  }\n\n  render(e) {\n    return (e.slot === this._hazeSlot || e.slot === this._skyslot) && 0 === e.pass && (this._update(e.camera), e.slot === this._skyslot && this._renderSky(e), e.slot === this._hazeSlot && this._renderHaze(e), !0);\n  }\n\n  _renderSky(e) {\n    const t = e.rctx,\n          a = this._atmosphereTechnique.program;\n    t.useProgram(a), this._atmosphereTechnique.bindPipelineState(t), a.setUniform3fv(\"atmosphereParameters3\", this._renderData.atmosphereParameters3), this._renderCommon(a, e);\n  }\n\n  _renderHaze(e) {\n    const t = e.rctx,\n          a = e.offscreenRenderingHelper,\n          r = this._atmosphereHazeTechnique.program;\n    t.useProgram(r), this._atmosphereHazeTechnique.bindPipelineState(t), a.renderDepthDetached(() => {\n      const t = a.depthTexture;\n      r.bindTexture(t, \"depthTex\"), this._renderCommon(r, e);\n    });\n  }\n\n  _renderCommon(e, t) {\n    const a = t.rctx;\n    e.setUniform3fv(\"invWavelength\", this._renderData.invWavelength), e.setUniform3fv(\"invWavelengthScaled\", this._renderData.invWavelengthScaled), t.scenelightingData.setLightDirectionUniform(e), e.setUniform4fv(\"heightParameters\", this._renderData.heightParameters), e.setUniform3fv(\"cameraPosition\", this._renderData.cameraPosition), e.setUniformMatrix4fv(\"projectionInverse\", this._renderData.projectionInverse), e.setUniformMatrix4fv(\"viewInverse\", this._renderData.viewInverse), e.setUniform2fv(\"nearFar\", this._renderData.nearFar), e.setUniform2fv(\"radii\", this._renderData.radii), e.setUniform4fv(\"atmosphereParameters1\", this._renderData.atmosphereParameters1), e.setUniform4fv(\"atmosphereParameters2\", this._renderData.atmosphereParameters2), e.setUniform1f(\"innerFadeDistance\", this._renderData.innerFadeDistance), e.setUniform1f(\"altitudeFade\", this._renderData.altitudeFade), a.bindVAO(this._vao), e.assertCompatibleVertexAttributeLocations(this._vao), a.drawArrays(5, 0, 4);\n  }\n\n  _createVertexArrayObject(e) {\n    const t = I.createBuffer(4);\n    return t.position.setVec(0, [-1, -1]), t.position.setVec(1, [1, -1]), t.position.setVec(2, [-1, 1]), t.position.setVec(3, [1, 1]), t.uv0.setVec(0, [0, 0]), t.uv0.setVec(1, [1, 0]), t.uv0.setVec(2, [0, 1]), t.uv0.setVec(3, [1, 1]), new B(e, x, {\n      geometry: j(I)\n    }, {\n      geometry: T.createVertex(e, 35044, t.buffer)\n    });\n  }\n\n  _adjustRadiusForTesselation(e) {\n    const t = 16,\n          a = 4,\n          r = Math.PI / 2 ** a / t;\n    return e * Math.cos(r);\n  }\n\n  _updateElevation(e) {\n    const t = e ? e.tile : this._view.basemapTerrain.rootTiles[0];\n    if (0 !== t.lij[0]) return;\n\n    const a = this._adjustRadiusForTesselation(f.radius + t.elevationBounds[0]);\n\n    a !== this._lowerElevationBoundRadius && (this._lowerElevationBoundRadius = a, this._lowerBoundEarthRadius = -1, this._updateVisibleElevationBounds());\n  }\n\n  _updateVisibleElevationBounds() {\n    const e = this._adjustRadiusForTesselation(f.radius + this._view.basemapTerrain.elevationBounds.min);\n\n    (this._lowerBoundEarthRadius < 0 || e < this._lowerBoundEarthRadius) && this._updateRadius(e);\n  }\n\n  _updateRadius(e) {\n    this._lowerBoundEarthRadius = e;\n    const t = e,\n          a = t / 10 * 10.25,\n          r = 1 / (a - t),\n          i = r / q,\n          o = r / U,\n          h = .3 * (a - t) + t,\n          d = this._renderData;\n    p(d.atmosphereParameters1, r, q, i, C), p(d.atmosphereParameters2, k, U, o, F), n(d.atmosphereParameters3, k * k, z, h), s(d.radii, t, a), d.scale = r, d.lowerAlphaBlendBound = h, d.scaleOverScaleDepth = i, d.scaleOverScaleDepthBlue = o;\n    const c = g;\n    d.innerFadeDistance = 2 * Math.sqrt((2 * t - c) * c);\n  }\n\n  _update(e) {\n    e && (this._renderData.cameraHeight = o(e.eye), this._renderData.cameraHeightSq = this._renderData.cameraHeight * this._renderData.cameraHeight, this._renderData.C = this._renderData.cameraHeightSq - this._renderData.radii[1] * this._renderData.radii[1], this._renderData.CSur = this._renderData.cameraHeightSq - this._renderData.radii[0] * this._renderData.radii[0], this._renderData.heightParameters = v(this._renderData.cameraHeight, this._renderData.cameraHeightSq, this._renderData.C, this._renderData.CSur), h(this._renderData.cameraPosition, e.eye), a(this._renderData.projectionInverse, e.projectionMatrix), a(this._renderData.viewInverse, e.viewMatrix), s(this._renderData.nearFar, e.near, e.far), this._renderData.altitudeFade = D(this._renderData.cameraHeight - this._lowerBoundEarthRadius));\n  }\n\n  static isSupported(e) {\n    return e.renderContext.rctx.capabilities.depthTexture;\n  }\n\n}\n\nconst R = .001,\n      V = 4 * .005 * Math.PI,\n      y = 4 * R * Math.PI,\n      E = l(1 / .65 ** 4, 1 / .57 ** 4, 1 / .475 ** 4),\n      H = u(E);\nd(H, H, V), c(H, H, l(y, y, y));\nconst q = .25,\n      U = .05,\n      C = 1 / q,\n      F = 1 / U,\n      k = -.99999,\n      z = (1 - k * k) / (2 + k * k) * 1.5,\n      I = P().vec2f(\"position\").vec2f(\"uv0\");\nexport { S as RealisticAtmosphere };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/environment/RealisticAtmosphere.js"],"names":["e","on","t","a","c","r","s","i","n","l","o","g","h","d","b","m","f","u","p","_","v","earth","computeInnerAltitudeFade","D","INNER_ATMOSPHERE_DEPTH","RealisticAtmosphereTechniqueConfiguration","w","RealisticAtmosphereTechnique","glLayout","j","newLayout","P","Default3D","x","T","B","S","constructor","_view","canRender","_skyslot","_hazeSlot","_renderData","texDepth","cameraPosition","projectionInverse","viewInverse","heightParameters","atmosphereParameters1","atmosphereParameters2","atmosphereParameters3","invWavelength","E","invWavelengthScaled","H","radii","scale","scaleDepth","q","lowerAlphaBlendBound","scaleOverScaleDepth","oneOverScaleDepth","scaleDepthBlue","U","oneOverScaleDepthBlue","F","scaleOverScaleDepthBlue","k","g2","miePhaseCoefficients","z","nearFar","cameraHeight","cameraHeightSq","C","CSur","innerFadeDistance","altitudeFade","_lowerElevationBoundRadius","_lowerBoundEarthRadius","radius","_updateRadius","destroy","_handles","_vao","dispose","when","Promise","resolve","initializeRenderContext","renderContext","rctx","_updateElevation","spatialReference","basemapTerrain","tile","rootTiles","extent","context","add","_updateVisibleElevationBounds","haze","_atmosphereTechnique","shaderTechniqueRep","acquire","_atmosphereHazeTechnique","_createVertexArrayObject","uninitializeRenderContext","render","slot","pass","_update","camera","_renderSky","_renderHaze","program","useProgram","bindPipelineState","setUniform3fv","_renderCommon","offscreenRenderingHelper","renderDepthDetached","depthTexture","bindTexture","scenelightingData","setLightDirectionUniform","setUniform4fv","setUniformMatrix4fv","setUniform2fv","setUniform1f","bindVAO","assertCompatibleVertexAttributeLocations","drawArrays","I","createBuffer","position","setVec","uv0","geometry","createVertex","buffer","_adjustRadiusForTesselation","Math","PI","cos","lij","elevationBounds","min","sqrt","eye","projectionMatrix","viewMatrix","near","far","isSupported","capabilities","R","V","y","vec2f","RealisticAtmosphere"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../core/Handles.js\";import{on as t}from\"../../../core/watchUtils.js\";import{a}from\"../../../chunks/mat4.js\";import{c as r}from\"../../../chunks/mat4f64.js\";import{s}from\"../../../chunks/vec2.js\";import{a as i}from\"../../../chunks/vec2f64.js\";import{s as n,l as o,g as h,a as d,b as c}from\"../../../chunks/vec3.js\";import{c as m,f as l,a as u}from\"../../../chunks/vec3f64.js\";import{s as p}from\"../../../chunks/vec4.js\";import{c as _,f as v}from\"../../../chunks/vec4f64.js\";import{earth as f}from\"../../../geometry/support/Ellipsoid.js\";import{computeInnerAltitudeFade as D,INNER_ATMOSPHERE_DEPTH as g}from\"./atmosphereUtils.js\";import{RealisticAtmosphereTechniqueConfiguration as w,RealisticAtmosphereTechnique as b}from\"./RealisticAtmosphereTechnique.js\";import{glLayout as j}from\"../support/buffer/glUtil.js\";import{newLayout as P}from\"../support/buffer/InterleavedLayout.js\";import{Default3D as x}from\"../webgl-engine/lib/DefaultVertexAttributeLocations.js\";import T from\"../../webgl/BufferObject.js\";import B from\"../../webgl/VertexArrayObject.js\";class S{constructor(e){this._view=e,this.canRender=!0,this._skyslot=14,this._hazeSlot=15,this._renderData={texDepth:i(),cameraPosition:m(),projectionInverse:r(),viewInverse:r(),heightParameters:_(),atmosphereParameters1:_(),atmosphereParameters2:_(),atmosphereParameters3:m(),invWavelength:E,invWavelengthScaled:H,radii:i(),scale:0,scaleDepth:q,lowerAlphaBlendBound:0,scaleOverScaleDepth:0,oneOverScaleDepth:0,scaleDepthBlue:U,oneOverScaleDepthBlue:F,scaleOverScaleDepthBlue:0,g:k,g2:k*k,miePhaseCoefficients:z,nearFar:i(),cameraHeight:0,cameraHeightSq:0,C:0,CSur:0,innerFadeDistance:0,altitudeFade:0},this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=f.radius,this._updateRadius(f.radius)}destroy(){this._handles&&(this._handles.destroy(),this._handles=null),this._vao&&(this._vao.dispose(),this._vao=null)}when(){return Promise.resolve()}initializeRenderContext(a){const r=a.renderContext.rctx;this._handles=new e,this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:\"ground\"}),this._handles.add(t(this._view,\"basemapTerrain\",\"elevation-change\",(e=>this._updateElevation(e)),(()=>this._updateElevation()))),this._handles.add(t(this._view,\"basemapTerrain\",\"elevation-bounds-change\",(()=>this._updateVisibleElevationBounds()),(()=>this._updateVisibleElevationBounds())));const s=new w;s.haze=!1,this._atmosphereTechnique=a.shaderTechniqueRep.acquire(b,s),s.haze=!0,this._atmosphereHazeTechnique=a.shaderTechniqueRep.acquire(b,s),this._vao=this._createVertexArrayObject(r)}uninitializeRenderContext(){this.destroy()}render(e){return(e.slot===this._hazeSlot||e.slot===this._skyslot)&&0===e.pass&&(this._update(e.camera),e.slot===this._skyslot&&this._renderSky(e),e.slot===this._hazeSlot&&this._renderHaze(e),!0)}_renderSky(e){const t=e.rctx,a=this._atmosphereTechnique.program;t.useProgram(a),this._atmosphereTechnique.bindPipelineState(t),a.setUniform3fv(\"atmosphereParameters3\",this._renderData.atmosphereParameters3),this._renderCommon(a,e)}_renderHaze(e){const t=e.rctx,a=e.offscreenRenderingHelper,r=this._atmosphereHazeTechnique.program;t.useProgram(r),this._atmosphereHazeTechnique.bindPipelineState(t),a.renderDepthDetached((()=>{const t=a.depthTexture;r.bindTexture(t,\"depthTex\"),this._renderCommon(r,e)}))}_renderCommon(e,t){const a=t.rctx;e.setUniform3fv(\"invWavelength\",this._renderData.invWavelength),e.setUniform3fv(\"invWavelengthScaled\",this._renderData.invWavelengthScaled),t.scenelightingData.setLightDirectionUniform(e),e.setUniform4fv(\"heightParameters\",this._renderData.heightParameters),e.setUniform3fv(\"cameraPosition\",this._renderData.cameraPosition),e.setUniformMatrix4fv(\"projectionInverse\",this._renderData.projectionInverse),e.setUniformMatrix4fv(\"viewInverse\",this._renderData.viewInverse),e.setUniform2fv(\"nearFar\",this._renderData.nearFar),e.setUniform2fv(\"radii\",this._renderData.radii),e.setUniform4fv(\"atmosphereParameters1\",this._renderData.atmosphereParameters1),e.setUniform4fv(\"atmosphereParameters2\",this._renderData.atmosphereParameters2),e.setUniform1f(\"innerFadeDistance\",this._renderData.innerFadeDistance),e.setUniform1f(\"altitudeFade\",this._renderData.altitudeFade),a.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),a.drawArrays(5,0,4)}_createVertexArrayObject(e){const t=I.createBuffer(4);return t.position.setVec(0,[-1,-1]),t.position.setVec(1,[1,-1]),t.position.setVec(2,[-1,1]),t.position.setVec(3,[1,1]),t.uv0.setVec(0,[0,0]),t.uv0.setVec(1,[1,0]),t.uv0.setVec(2,[0,1]),t.uv0.setVec(3,[1,1]),new B(e,x,{geometry:j(I)},{geometry:T.createVertex(e,35044,t.buffer)})}_adjustRadiusForTesselation(e){const t=16,a=4,r=Math.PI/2**a/t;return e*Math.cos(r)}_updateElevation(e){const t=e?e.tile:this._view.basemapTerrain.rootTiles[0];if(0!==t.lij[0])return;const a=this._adjustRadiusForTesselation(f.radius+t.elevationBounds[0]);a!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=a,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(f.radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||e<this._lowerBoundEarthRadius)&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e;const t=e,a=t/10*10.25,r=1/(a-t),i=r/q,o=r/U,h=.3*(a-t)+t,d=this._renderData;p(d.atmosphereParameters1,r,q,i,C),p(d.atmosphereParameters2,k,U,o,F),n(d.atmosphereParameters3,k*k,z,h),s(d.radii,t,a),d.scale=r,d.lowerAlphaBlendBound=h,d.scaleOverScaleDepth=i,d.scaleOverScaleDepthBlue=o;const c=g;d.innerFadeDistance=2*Math.sqrt((2*t-c)*c)}_update(e){e&&(this._renderData.cameraHeight=o(e.eye),this._renderData.cameraHeightSq=this._renderData.cameraHeight*this._renderData.cameraHeight,this._renderData.C=this._renderData.cameraHeightSq-this._renderData.radii[1]*this._renderData.radii[1],this._renderData.CSur=this._renderData.cameraHeightSq-this._renderData.radii[0]*this._renderData.radii[0],this._renderData.heightParameters=v(this._renderData.cameraHeight,this._renderData.cameraHeightSq,this._renderData.C,this._renderData.CSur),h(this._renderData.cameraPosition,e.eye),a(this._renderData.projectionInverse,e.projectionMatrix),a(this._renderData.viewInverse,e.viewMatrix),s(this._renderData.nearFar,e.near,e.far),this._renderData.altitudeFade=D(this._renderData.cameraHeight-this._lowerBoundEarthRadius))}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}}const R=.001,V=4*.005*Math.PI,y=4*R*Math.PI,E=l(1/.65**4,1/.57**4,1/.475**4),H=u(E);d(H,H,V),c(H,H,l(y,y,y));const q=.25,U=.05,C=1/q,F=1/U,k=-.99999,z=(1-k*k)/(2+k*k)*1.5,I=P().vec2f(\"position\").vec2f(\"uv0\");export{S as RealisticAtmosphere};\n"]},"metadata":{},"sourceType":"module"}