{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as t } from \"../../../chunks/tslib.es6.js\";\nimport { fetchAsset as e } from \"../../../assets.js\";\nimport s from \"../../../core/Accessor.js\";\nimport r from \"../../../core/Error.js\";\nimport i from \"../../../core/Logger.js\";\nimport { isSome as a, abortMaybe as o, disposeMaybe as n, isNone as c } from \"../../../core/maybe.js\";\nimport { createTask as f, isAbortError as u } from \"../../../core/promiseUtils.js\";\nimport { property as h } from \"../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../core/has.js\";\nimport \"../../../core/accessorSupport/ensureType.js\";\nimport { subclass as d } from \"../../../core/accessorSupport/decorators/subclass.js\";\nimport { d as p, r as m, m as l } from \"../../../chunks/mat4.js\";\nimport { c as _, f as g } from \"../../../chunks/mat4f64.js\";\nimport { StarsTechnique as b } from \"./StarsTechnique.js\";\nimport { glLayout as y } from \"../support/buffer/glUtil.js\";\nimport { newLayout as v } from \"../support/buffer/InterleavedLayout.js\";\nimport { Default3D as w } from \"../webgl-engine/lib/DefaultVertexAttributeLocations.js\";\nimport { WatchUpdatingTracking as j } from \"../../support/WatchUpdatingTracking.js\";\nimport k from \"../../webgl/BufferObject.js\";\nimport x from \"../../webgl/VertexArrayObject.js\";\nconst T = i.getLogger(\"esri.views.3d.environment.Stars\");\nlet D = class extends s {\n  constructor(t) {\n    super(t), this.slot = 14, this._loadDataTask = null, this._numPoints = 0, this._modelMatrix = _(), this._updatingTracking = new j(), this._requestRender = () => {};\n  }\n\n  get updating() {\n    return this._updatingTracking.updating || this.loading;\n  }\n\n  get loading() {\n    return a(this._loadDataTask) && !this._loadDataTask.finished;\n  }\n\n  get canRender() {\n    return !this.loading;\n  }\n\n  initialize() {\n    this._loadDataTask = this._createLoadDataTask();\n  }\n\n  destroy() {\n    this._loadDataTask = o(this._loadDataTask), this._updatingTracking.destroy(), this._numPoints = 0, this._technique = n(this._technique), this._vao = n(this._vao), this._requestRender = null;\n  }\n\n  initializeRenderContext(t) {\n    this._requestRender = t.requestRender;\n  }\n\n  uninitializeRenderContext() {\n    this.destroy();\n  }\n\n  render(t) {\n    if (t.slot !== this.slot || 0 !== t.pass) return !1;\n    if (this._ensureResources(t), c(this._technique) || c(this._vao)) return !0;\n    const e = t.rctx,\n          s = this._technique.program;\n    return e.useProgram(s), this._technique.bindPass({\n      camera: t.camera,\n      modelMatrix: this._modelMatrix\n    }), this._technique.bindPipelineState(e), e.bindVAO(this._vao), s.assertCompatibleVertexAttributeLocations(this._vao), e.drawArrays(0, 0, this._numPoints), !0;\n  }\n\n  _ensureResources(t) {\n    if (a(this._technique) || c(S)) return;\n    const e = t.rctx;\n    this._technique = new b({\n      rctx: e,\n      viewingMode: this.view.state.viewingMode\n    }, null), this._numPoints = S.byteLength / R;\n    const s = new Float32Array(S, 0, 2 * this._numPoints),\n          r = new Uint8Array(S, 2 * this._numPoints * 4, this._numPoints);\n    this._vao = this._createVertexArrayObject(t.rctx, s, r, this._numPoints), this._updatingTracking.add(this.view, \"environment.lighting.date\", t => this._update(t), 2);\n  }\n\n  _computeDayDuration(t) {\n    const e = t,\n          s = new Date(t.getFullYear(), 0, 1, 11, 58, 56);\n    return (+e - +s) / (+new Date(t.getFullYear() + 1, 0, 1, 11, 58, 55) - +s);\n  }\n\n  _update(t) {\n    if (!t) return;\n\n    const e = (t.getHours() / 12 + t.getMinutes() / 60 * (2 / 24) + t.getSeconds() / 60 * (2 / 1440) - .9972222) % 2,\n          s = 2 * this._computeDayDuration(t),\n          r = this._modelMatrix;\n\n    p(r, P), m(r, r, -s * Math.PI), l(r, M, r), m(r, r, -e * Math.PI), this._requestRender();\n  }\n\n  _hexToRGB(t) {\n    return [parseInt(t.substring(0, 2), 16), parseInt(t.substring(2, 4), 16), parseInt(t.substring(4, 6), 16)];\n  }\n\n  _unpackUint8Attributes(t) {\n    return t >= 192 ? [2.9, t - 192] : t >= 160 ? [2.5, t - 160] : t >= 128 ? [2, t - 128] : t >= 96 ? [1.5, t - 96] : t >= 64 ? [1, t - 64] : t >= 32 ? [.7, t - 32] : [.4, t];\n  }\n\n  _createVertexArrayObject(t, e, s, r) {\n    const i = A.createBuffer(r),\n          a = i.position,\n          o = i.color,\n          n = i.size;\n\n    for (let c = 0; c < r; c++) {\n      const t = e[2 * c + 0],\n            r = e[2 * c + 1];\n      a.set(c, 0, -Math.cos(t) * Math.sin(r)), a.set(c, 1, -Math.sin(t) * Math.sin(r)), a.set(c, 2, -Math.cos(r));\n\n      const i = this._unpackUint8Attributes(s[c]),\n            f = this._hexToRGB(q[i[1]]);\n\n      o.set(c, 0, 255 * f[0]), o.set(c, 1, 255 * f[1]), o.set(c, 2, 255 * f[2]), o.set(c, 3, 255), n.set(c, i[0]);\n    }\n\n    return new x(t, w, {\n      geometry: y(A)\n    }, {\n      geometry: k.createVertex(t, 35044, i.buffer)\n    });\n  }\n\n  _createLoadDataTask() {\n    if (a(S)) return null;\n    const t = f(async t => {\n      const {\n        data: s\n      } = await e(\"esri/views/3d/environment/resources/stars.wsv\", {\n        responseType: \"array-buffer\",\n        signal: t\n      });\n      this._verifyStarData(s), S = s;\n    });\n    return t.promise.catch(t => {\n      u(t) || T.error(t);\n    }).then(() => {\n      this.destroyed || (this._requestRender(), this.notifyChange(\"updating\"));\n    }), t;\n  }\n\n  _verifyStarData(t) {\n    if (!t) throw new r(\"stars:no-data-received\", \"Failed to create stars because star catalogue is missing\");\n    const e = t.byteLength / R;\n    if (e % 1 != 0 || e > 5e4 || e < 5e3) throw new r(\"stars:invalid-data\", \"Failed to create stars because star catalogue data is invalid\");\n  }\n\n};\nt([h({\n  constructOnly: !0\n})], D.prototype, \"view\", void 0), t([h({\n  readOnly: !0\n})], D.prototype, \"updating\", null), t([h()], D.prototype, \"_loadDataTask\", void 0), t([h()], D.prototype, \"_updatingTracking\", void 0), D = t([d(\"esri.views.3d.environment.Stars\")], D);\nconst q = [\"9bb2ff\", \"9eb5ff\", \"aabfff\", \"bbccff\", \"ccd8ff \", \"dae2ff\", \"e4e9ff\", \"eeefff\", \"f8f6ff\", \"fff9fb\", \"fff5ef\", \"fff1e5\", \"ffeddb\", \"ffe9d2\", \"ffe6ca\", \"ffe3c3\", \"ffe0bb\", \"ffddb4\", \"ffdaad\", \"ffd6a5\", \"ffd29c\", \"ffcc8f\", \"ffc178\", \"ffa94b\", \"ff7b00\"],\n      M = g(1, 0, 0, 0, 0, .9174771405229186, .39778850739794974, 0, 0, -.39778850739794974, .9174771405229186, 0, 0, 0, 0, 1),\n      P = g(1, 0, 0, 0, 0, .9174771405229186, -.39778850739794974, 0, 0, .39778850739794974, .9174771405229186, 0, 0, 0, 0, 1),\n      R = 9,\n      A = v().vec3f(\"position\").vec4u8(\"color\").f32(\"size\");\nlet S = null;\nexport { D as Stars };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/environment/Stars.js"],"names":["_","t","fetchAsset","e","s","r","i","isSome","a","abortMaybe","o","disposeMaybe","n","isNone","c","createTask","f","isAbortError","u","property","h","subclass","d","p","m","l","g","StarsTechnique","b","glLayout","y","newLayout","v","Default3D","w","WatchUpdatingTracking","j","k","x","T","getLogger","D","constructor","slot","_loadDataTask","_numPoints","_modelMatrix","_updatingTracking","_requestRender","updating","loading","finished","canRender","initialize","_createLoadDataTask","destroy","_technique","_vao","initializeRenderContext","requestRender","uninitializeRenderContext","render","pass","_ensureResources","rctx","program","useProgram","bindPass","camera","modelMatrix","bindPipelineState","bindVAO","assertCompatibleVertexAttributeLocations","drawArrays","S","viewingMode","view","state","byteLength","R","Float32Array","Uint8Array","_createVertexArrayObject","add","_update","_computeDayDuration","Date","getFullYear","getHours","getMinutes","getSeconds","P","Math","PI","M","_hexToRGB","parseInt","substring","_unpackUint8Attributes","A","createBuffer","position","color","size","set","cos","sin","q","geometry","createVertex","buffer","data","responseType","signal","_verifyStarData","promise","catch","error","then","destroyed","notifyChange","constructOnly","prototype","readOnly","vec3f","vec4u8","f32","Stars"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as t}from\"../../../chunks/tslib.es6.js\";import{fetchAsset as e}from\"../../../assets.js\";import s from\"../../../core/Accessor.js\";import r from\"../../../core/Error.js\";import i from\"../../../core/Logger.js\";import{isSome as a,abortMaybe as o,disposeMaybe as n,isNone as c}from\"../../../core/maybe.js\";import{createTask as f,isAbortError as u}from\"../../../core/promiseUtils.js\";import{property as h}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import{subclass as d}from\"../../../core/accessorSupport/decorators/subclass.js\";import{d as p,r as m,m as l}from\"../../../chunks/mat4.js\";import{c as _,f as g}from\"../../../chunks/mat4f64.js\";import{StarsTechnique as b}from\"./StarsTechnique.js\";import{glLayout as y}from\"../support/buffer/glUtil.js\";import{newLayout as v}from\"../support/buffer/InterleavedLayout.js\";import{Default3D as w}from\"../webgl-engine/lib/DefaultVertexAttributeLocations.js\";import{WatchUpdatingTracking as j}from\"../../support/WatchUpdatingTracking.js\";import k from\"../../webgl/BufferObject.js\";import x from\"../../webgl/VertexArrayObject.js\";const T=i.getLogger(\"esri.views.3d.environment.Stars\");let D=class extends s{constructor(t){super(t),this.slot=14,this._loadDataTask=null,this._numPoints=0,this._modelMatrix=_(),this._updatingTracking=new j,this._requestRender=()=>{}}get updating(){return this._updatingTracking.updating||this.loading}get loading(){return a(this._loadDataTask)&&!this._loadDataTask.finished}get canRender(){return!this.loading}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=o(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=n(this._technique),this._vao=n(this._vao),this._requestRender=null}initializeRenderContext(t){this._requestRender=t.requestRender}uninitializeRenderContext(){this.destroy()}render(t){if(t.slot!==this.slot||0!==t.pass)return!1;if(this._ensureResources(t),c(this._technique)||c(this._vao))return!0;const e=t.rctx,s=this._technique.program;return e.useProgram(s),this._technique.bindPass({camera:t.camera,modelMatrix:this._modelMatrix}),this._technique.bindPipelineState(e),e.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),e.drawArrays(0,0,this._numPoints),!0}_ensureResources(t){if(a(this._technique)||c(S))return;const e=t.rctx;this._technique=new b({rctx:e,viewingMode:this.view.state.viewingMode},null),this._numPoints=S.byteLength/R;const s=new Float32Array(S,0,2*this._numPoints),r=new Uint8Array(S,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(t.rctx,s,r,this._numPoints),this._updatingTracking.add(this.view,\"environment.lighting.date\",(t=>this._update(t)),2)}_computeDayDuration(t){const e=t,s=new Date(t.getFullYear(),0,1,11,58,56);return(+e-+s)/(+new Date(t.getFullYear()+1,0,1,11,58,55)-+s)}_update(t){if(!t)return;const e=(t.getHours()/12+t.getMinutes()/60*(2/24)+t.getSeconds()/60*(2/1440)-.9972222)%2,s=2*this._computeDayDuration(t),r=this._modelMatrix;p(r,P),m(r,r,-s*Math.PI),l(r,M,r),m(r,r,-e*Math.PI),this._requestRender()}_hexToRGB(t){return[parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16),parseInt(t.substring(4,6),16)]}_unpackUint8Attributes(t){return t>=192?[2.9,t-192]:t>=160?[2.5,t-160]:t>=128?[2,t-128]:t>=96?[1.5,t-96]:t>=64?[1,t-64]:t>=32?[.7,t-32]:[.4,t]}_createVertexArrayObject(t,e,s,r){const i=A.createBuffer(r),a=i.position,o=i.color,n=i.size;for(let c=0;c<r;c++){const t=e[2*c+0],r=e[2*c+1];a.set(c,0,-Math.cos(t)*Math.sin(r)),a.set(c,1,-Math.sin(t)*Math.sin(r)),a.set(c,2,-Math.cos(r));const i=this._unpackUint8Attributes(s[c]),f=this._hexToRGB(q[i[1]]);o.set(c,0,255*f[0]),o.set(c,1,255*f[1]),o.set(c,2,255*f[2]),o.set(c,3,255),n.set(c,i[0])}return new x(t,w,{geometry:y(A)},{geometry:k.createVertex(t,35044,i.buffer)})}_createLoadDataTask(){if(a(S))return null;const t=f((async t=>{const{data:s}=await e(\"esri/views/3d/environment/resources/stars.wsv\",{responseType:\"array-buffer\",signal:t});this._verifyStarData(s),S=s}));return t.promise.catch((t=>{u(t)||T.error(t)})).then((()=>{this.destroyed||(this._requestRender(),this.notifyChange(\"updating\"))})),t}_verifyStarData(t){if(!t)throw new r(\"stars:no-data-received\",\"Failed to create stars because star catalogue is missing\");const e=t.byteLength/R;if(e%1!=0||e>5e4||e<5e3)throw new r(\"stars:invalid-data\",\"Failed to create stars because star catalogue data is invalid\")}};t([h({constructOnly:!0})],D.prototype,\"view\",void 0),t([h({readOnly:!0})],D.prototype,\"updating\",null),t([h()],D.prototype,\"_loadDataTask\",void 0),t([h()],D.prototype,\"_updatingTracking\",void 0),D=t([d(\"esri.views.3d.environment.Stars\")],D);const q=[\"9bb2ff\",\"9eb5ff\",\"aabfff\",\"bbccff\",\"ccd8ff \",\"dae2ff\",\"e4e9ff\",\"eeefff\",\"f8f6ff\",\"fff9fb\",\"fff5ef\",\"fff1e5\",\"ffeddb\",\"ffe9d2\",\"ffe6ca\",\"ffe3c3\",\"ffe0bb\",\"ffddb4\",\"ffdaad\",\"ffd6a5\",\"ffd29c\",\"ffcc8f\",\"ffc178\",\"ffa94b\",\"ff7b00\"],M=g(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),P=g(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),R=9,A=v().vec3f(\"position\").vec4u8(\"color\").f32(\"size\");let S=null;export{D as Stars};\n"]},"metadata":{},"sourceType":"module"}