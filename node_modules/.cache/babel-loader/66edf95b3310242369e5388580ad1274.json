{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../../../core/Logger.js\";\nimport { isSome as t, isNone as o, applySome as r, unwrap as n } from \"../../../../../core/maybe.js\";\nimport { e as i, t as s, g as a } from \"../../../../../chunks/mat3.js\";\nimport { a as c, c as m } from \"../../../../../chunks/mat3f32.js\";\nimport { h as l, w as p, t as h, g as f } from \"../../../../../chunks/vec3.js\";\nimport { c as u } from \"../../../../../chunks/vec3f64.js\";\nimport { c as g } from \"../../../../../chunks/vec4.js\";\nimport { c as b } from \"../../../../../chunks/vec4f32.js\";\nimport { encodeSymbolColor as d } from \"../../../layers/support/symbolColorUtils.js\";\nimport { clone as y } from \"../../../support/orientedBoundingBox.js\";\nimport { glLayout as C } from \"../../../support/buffer/glUtil.js\";\nimport { newLayout as j } from \"../../../support/buffer/InterleavedLayout.js\";\nimport w from \"./ComponentData.js\";\nimport M from \"./ComponentObject.js\";\nimport { VISIBLE_BIT as x, isVaryingComponentParameters as _ } from \"./interface.js\";\nimport S from \"./IntersectionGeometry.js\";\nimport { Renderable as v } from \"./Renderable.js\";\nimport { RenderGeometry as D } from \"./RenderGeometry.js\";\nimport { RenderSubmitSystem as P } from \"./RenderSubmitSystem.js\";\nimport { createVertexBufferLayout as k } from \"./SourceGeometry.js\";\nimport { ComponentParametersVarying as O, ComponentParametersUniform as B, ComponentMaterial as G } from \"./Material/ComponentMaterial.js\";\nimport { ComponentDrawParameters as I } from \"./Material/ComponentTechnique.js\";\nimport { BucketedObjectStore as U } from \"../../core/util/BucketedObjectStore.js\";\nimport { TwoVectorPosition as A } from \"../../core/util/TwoVectorPosition.js\";\nimport { getVisibility as R, updateVisibilityWithCount as E } from \"../../lib/ComponentUtils.js\";\nimport { assert as T } from \"../../lib/Util.js\";\nimport { BufferManager as V } from \"../../lib/TextureBackedBuffer/BufferManager.js\";\nimport L from \"../../../../webgl/BufferObject.js\";\nimport q from \"../../../../webgl/VertexArrayObject.js\";\nconst F = e.getLogger(\"esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection\");\n\nclass H {\n  constructor(e) {\n    this._renderManager = e, this._objects = new U(), this._renderSubmit = new P(this), this._renderManager.register(this._renderSubmit), this._componentBufferManager = new V(e.rctx);\n  }\n\n  dispose() {\n    T(0 === this._objects.count, \"ObjectCollection should be empty upon disposal\"), this._componentBufferManager.destroy();\n  }\n\n  createObject(e) {\n    const t = new M();\n    return t.toMapSpace = e.toMapSpace.slice(), t.transform = e.transform, t.obb = y(e.obb), t.components = new w(this._componentBufferManager, e.geometry.componentOffsets), t.renderable = this._createRenderable(e, t.components), t.intersectionGeometry = new S(e.geometry.positionData, t.components), this._objects.add(e.visible ? x : 0, t), t;\n  }\n\n  destroyObject(e) {\n    const t = e;\n    this._objects.remove(t), t.dispose(), this._notifyDirty();\n  }\n\n  setObjectVisibility(e, t) {\n    const o = e;\n\n    if (t !== o.visible) {\n      const e = t ? o.bucketKey | x : o.bucketKey & ~x;\n      this._objects.updateKey(o, e), this._notifyDirty();\n    }\n  }\n\n  preSubmit(e) {\n    const t = e.camera.eye;\n\n    this._objects.forEach((e, o) => {\n      o & x && e.forEach(e => {\n        const o = l(t, e.obb.center);\n        e.renderable.meta.cameraDepthSquared = o;\n      });\n    });\n  }\n\n  getMaterial(e) {\n    return e.renderable.material;\n  }\n\n  updateMaterial(e, t) {\n    const o = e.renderable.material;\n    t(o), o.dirty && this._notifyDirty();\n  }\n\n  setAllComponentVisibilities(e, t) {\n    const o = e;\n    o.components.visibility.reset(t), o.components.visibilityDirty(), this._notifyDirty();\n  }\n\n  forEachVisibleComponent(e, t) {\n    return e.components.visibility.forEachComponent(t);\n  }\n\n  getComponentCount(e) {\n    const t = e,\n          o = t.components.visibility.componentCount();\n    return {\n      visible: o,\n      invisible: t.components.count - o\n    };\n  }\n\n  setComponentData(e, t) {\n    const o = e,\n          r = o.renderable.material;\n\n    if (_(t)) {\n      const e = o.components,\n            n = e.materialDataBuffer,\n            i = e.materialDataIndices,\n            s = {\n        castShadows: !0,\n        pickable: !0,\n        externalColor: b(),\n        externalColorMixMode: 1\n      },\n            a = n.textureBuffer,\n            c = new Uint8Array(4),\n            m = new Uint32Array(c.buffer);\n      let l = 0,\n          p = 0,\n          h = 0,\n          f = !1,\n          u = 0;\n\n      for (let o = 0; o < e.count; o++) t(o, s), l += +(s.externalColor[3] < 1), p += +(3 === s.externalColorMixMode && 1 === s.externalColor[3]), h += +s.castShadows, d(s.externalColor, s.externalColorMixMode, c), c[2] = 254 & c[2] | +s.castShadows, a.setData(i[o], 0, c[0], c[1], c[2], c[3]), f = f || o > 0 && u !== m[0], u = m[0], s.pickable !== R(e.pickability, o) && (e.pickability = E(e.pickability, e.count, o, s.pickable));\n\n      f ? (r.componentParameters = new O(), r.componentParameters.castShadows = K(h, e.count), r.componentParameters.transparent = K(l, e.count), r.componentParameters.opaqueOverride = K(p, e.count), r.componentParameters.texture = a, a.updateTexture()) : (r.componentParameters = new B(), r.componentParameters.castShadows = s.castShadows ? 0 : 2, r.componentParameters.externalColor = s.externalColor, r.componentParameters.externalColorMixMode = s.externalColorMixMode);\n    } else r.componentParameters = new B(), r.componentParameters.castShadows = t.castShadows ? 0 : 2, r.componentParameters.externalColor = t.externalColor, r.componentParameters.externalColorMixMode = t.externalColorMixMode;\n\n    this._notifyDirty();\n  }\n\n  getComponentAabb(e, t, o) {\n    return e.intersectionGeometry.getComponentAabb(t, o);\n  }\n\n  getComponentObb(e) {\n    return e.obb;\n  }\n\n  getObjectTransform(e) {\n    return e.transform;\n  }\n\n  getComponentPositions(e, t, o) {\n    return e.intersectionGeometry.getComponentPositions(t, o);\n  }\n\n  intersect(e, o, r, n, a, c) {\n    const m = e;\n    t(a) && (a.localOrigin = m.transform.position);\n    const l = i(N, m.transform.rotationScale);\n    p(J, o, m.transform.position), p(Q, r, m.transform.position), h(J, J, l), h(Q, Q, l);\n    const f = s(N, l);\n    return m.intersectionGeometry.intersect(J, Q, n, f, a, c);\n  }\n\n  addEdges(e, t, o, r) {\n    const n = e,\n          {\n      indices: i,\n      positions: s\n    } = n.intersectionGeometry,\n          a = n.components.offsets;\n    return t.addComponentObject(e, n.transform, n.obb.center, s, i, a, o, r);\n  }\n\n  addComponentHighlight(e, t) {\n    const r = e.components;\n    o(r.highlightCounts) && (r.highlightCounts = new Uint32Array(r.count + 1));\n    0 === r.highlightCounts[t]++ && (r.highlightsDirty(), this._notifyDirty()), r.highlightCounts[r.count]++;\n  }\n\n  removeComponentHighlight(e, t) {\n    const r = e.components;\n    if (o(r.highlightCounts)) return void F.warn(\"Removing non-existing highlight.\");\n    const n = r.highlightCounts[t],\n          i = r.highlightCounts[r.count];\n\n    if (0 !== n) {\n      if (n > 1) return r.highlightCounts[t] = n - 1, void (r.highlightCounts[r.count] = i - 1);\n      r.highlightCounts[t] = 0, r.highlightsDirty(), this._notifyDirty(), 1 === i ? r.highlightCounts = null : r.highlightCounts[r.count] = i - 1;\n    } else F.warn(\"Removing non-existing highlight.\");\n  }\n\n  clearHighlights(e) {\n    const o = e.components;\n    t(o.highlightCounts) && (o.highlightCounts = null, o.highlightsDirty(), this._notifyDirty());\n  }\n\n  getObjectGPUMemoryUsage(e) {\n    return e.renderable.meta.gpuMemoryEstimate;\n  }\n\n  get visibleObjects() {\n    return this._objects.getBucket(x);\n  }\n\n  get performanceInfo() {\n    const e = this._objects.getPerformanceInfo(x);\n\n    return {\n      shown: e.added,\n      hidden: e.removed\n    };\n  }\n\n  _createRenderable(e, o) {\n    const m = this._renderManager.rctx,\n          l = e.geometry,\n          p = l.vertices.layoutParameters,\n          h = L.createVertex(m, 35044, l.vertices.data),\n          u = r(l.indices, e => L.createIndex(m, 35044, e)),\n          b = C(k(p)),\n          d = new Uint16Array(l.vertices.count);\n\n    for (let r = 0; r < o.count; r++) {\n      const e = o.offsets[r],\n            n = o.offsets[r + 1],\n            i = o.materialDataIndices[r];\n      if (t(l.indices)) for (let t = e; t < n; t++) {\n        d[l.indices[t]] = i;\n      } else for (let t = e; t < n; t++) d[t] = i;\n    }\n\n    const y = L.createVertex(m, 35044, d.buffer),\n          j = new A(e.transform.position),\n          w = c(e.transform.rotationScale);\n    i(w, w), s(w, w);\n    const M = new I();\n    f(M.worldFromModel_TL, j.low), f(M.worldFromModel_TH, j.high), a(M.worldFromModel_RS, e.transform.rotationScale), a(M.transformNormal_GlobalFromModel, w), g(M.toMapSpace, e.toMapSpace);\n\n    const x = new G(),\n          _ = new q(m, x.attributeLocations, {\n      data: b,\n      componentIndices: z\n    }, {\n      data: h,\n      componentIndices: y\n    }, n(u)),\n          S = new D(_, 4, p, t(u)),\n          P = {\n      cameraDepthSquared: .5,\n      gpuMemoryEstimate: h.byteSize + y.byteSize + (t(u) ? u.byteSize : 0)\n    };\n\n    return new v(x, M, S, P);\n  }\n\n  _notifyDirty() {\n    this._renderManager.notifyDirty();\n  }\n\n}\n\nconst z = C(j().u16(\"componentIndex\"));\n\nfunction K(e, t) {\n  return e === t ? 0 : 0 === e ? 2 : 1;\n}\n\nconst N = m(),\n      J = u(),\n      Q = u();\nexport { H as ComponentObjectCollection };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/webgl-engine/collections/Component/ComponentObjectCollection.js"],"names":["e","isSome","t","isNone","o","applySome","r","unwrap","n","i","s","g","a","c","m","h","l","w","p","f","u","b","encodeSymbolColor","d","clone","y","glLayout","C","newLayout","j","M","VISIBLE_BIT","x","isVaryingComponentParameters","_","S","Renderable","v","RenderGeometry","D","RenderSubmitSystem","P","createVertexBufferLayout","k","ComponentParametersVarying","O","ComponentParametersUniform","B","ComponentMaterial","G","ComponentDrawParameters","I","BucketedObjectStore","U","TwoVectorPosition","A","getVisibility","R","updateVisibilityWithCount","E","assert","T","BufferManager","V","L","q","F","getLogger","H","constructor","_renderManager","_objects","_renderSubmit","register","_componentBufferManager","rctx","dispose","count","destroy","createObject","toMapSpace","slice","transform","obb","components","geometry","componentOffsets","renderable","_createRenderable","intersectionGeometry","positionData","add","visible","destroyObject","remove","_notifyDirty","setObjectVisibility","bucketKey","updateKey","preSubmit","camera","eye","forEach","center","meta","cameraDepthSquared","getMaterial","material","updateMaterial","dirty","setAllComponentVisibilities","visibility","reset","visibilityDirty","forEachVisibleComponent","forEachComponent","getComponentCount","componentCount","invisible","setComponentData","materialDataBuffer","materialDataIndices","castShadows","pickable","externalColor","externalColorMixMode","textureBuffer","Uint8Array","Uint32Array","buffer","setData","pickability","componentParameters","K","transparent","opaqueOverride","texture","updateTexture","getComponentAabb","getComponentObb","getObjectTransform","getComponentPositions","intersect","localOrigin","position","N","rotationScale","J","Q","addEdges","indices","positions","offsets","addComponentObject","addComponentHighlight","highlightCounts","highlightsDirty","removeComponentHighlight","warn","clearHighlights","getObjectGPUMemoryUsage","gpuMemoryEstimate","visibleObjects","getBucket","performanceInfo","getPerformanceInfo","shown","added","hidden","removed","vertices","layoutParameters","createVertex","data","createIndex","Uint16Array","worldFromModel_TL","low","worldFromModel_TH","high","worldFromModel_RS","transformNormal_GlobalFromModel","attributeLocations","componentIndices","z","byteSize","notifyDirty","u16","ComponentObjectCollection"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../../../core/Logger.js\";import{isSome as t,isNone as o,applySome as r,unwrap as n}from\"../../../../../core/maybe.js\";import{e as i,t as s,g as a}from\"../../../../../chunks/mat3.js\";import{a as c,c as m}from\"../../../../../chunks/mat3f32.js\";import{h as l,w as p,t as h,g as f}from\"../../../../../chunks/vec3.js\";import{c as u}from\"../../../../../chunks/vec3f64.js\";import{c as g}from\"../../../../../chunks/vec4.js\";import{c as b}from\"../../../../../chunks/vec4f32.js\";import{encodeSymbolColor as d}from\"../../../layers/support/symbolColorUtils.js\";import{clone as y}from\"../../../support/orientedBoundingBox.js\";import{glLayout as C}from\"../../../support/buffer/glUtil.js\";import{newLayout as j}from\"../../../support/buffer/InterleavedLayout.js\";import w from\"./ComponentData.js\";import M from\"./ComponentObject.js\";import{VISIBLE_BIT as x,isVaryingComponentParameters as _}from\"./interface.js\";import S from\"./IntersectionGeometry.js\";import{Renderable as v}from\"./Renderable.js\";import{RenderGeometry as D}from\"./RenderGeometry.js\";import{RenderSubmitSystem as P}from\"./RenderSubmitSystem.js\";import{createVertexBufferLayout as k}from\"./SourceGeometry.js\";import{ComponentParametersVarying as O,ComponentParametersUniform as B,ComponentMaterial as G}from\"./Material/ComponentMaterial.js\";import{ComponentDrawParameters as I}from\"./Material/ComponentTechnique.js\";import{BucketedObjectStore as U}from\"../../core/util/BucketedObjectStore.js\";import{TwoVectorPosition as A}from\"../../core/util/TwoVectorPosition.js\";import{getVisibility as R,updateVisibilityWithCount as E}from\"../../lib/ComponentUtils.js\";import{assert as T}from\"../../lib/Util.js\";import{BufferManager as V}from\"../../lib/TextureBackedBuffer/BufferManager.js\";import L from\"../../../../webgl/BufferObject.js\";import q from\"../../../../webgl/VertexArrayObject.js\";const F=e.getLogger(\"esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection\");class H{constructor(e){this._renderManager=e,this._objects=new U,this._renderSubmit=new P(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new V(e.rctx)}dispose(){T(0===this._objects.count,\"ObjectCollection should be empty upon disposal\"),this._componentBufferManager.destroy()}createObject(e){const t=new M;return t.toMapSpace=e.toMapSpace.slice(),t.transform=e.transform,t.obb=y(e.obb),t.components=new w(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new S(e.geometry.positionData,t.components),this._objects.add(e.visible?x:0,t),t}destroyObject(e){const t=e;this._objects.remove(t),t.dispose(),this._notifyDirty()}setObjectVisibility(e,t){const o=e;if(t!==o.visible){const e=t?o.bucketKey|x:o.bucketKey&~x;this._objects.updateKey(o,e),this._notifyDirty()}}preSubmit(e){const t=e.camera.eye;this._objects.forEach(((e,o)=>{o&x&&e.forEach((e=>{const o=l(t,e.obb.center);e.renderable.meta.cameraDepthSquared=o}))}))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const o=e.renderable.material;t(o),o.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const o=e;o.components.visibility.reset(t),o.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.components.visibility.forEachComponent(t)}getComponentCount(e){const t=e,o=t.components.visibility.componentCount();return{visible:o,invisible:t.components.count-o}}setComponentData(e,t){const o=e,r=o.renderable.material;if(_(t)){const e=o.components,n=e.materialDataBuffer,i=e.materialDataIndices,s={castShadows:!0,pickable:!0,externalColor:b(),externalColorMixMode:1},a=n.textureBuffer,c=new Uint8Array(4),m=new Uint32Array(c.buffer);let l=0,p=0,h=0,f=!1,u=0;for(let o=0;o<e.count;o++)t(o,s),l+=+(s.externalColor[3]<1),p+=+(3===s.externalColorMixMode&&1===s.externalColor[3]),h+=+s.castShadows,d(s.externalColor,s.externalColorMixMode,c),c[2]=254&c[2]|+s.castShadows,a.setData(i[o],0,c[0],c[1],c[2],c[3]),f=f||o>0&&u!==m[0],u=m[0],s.pickable!==R(e.pickability,o)&&(e.pickability=E(e.pickability,e.count,o,s.pickable));f?(r.componentParameters=new O,r.componentParameters.castShadows=K(h,e.count),r.componentParameters.transparent=K(l,e.count),r.componentParameters.opaqueOverride=K(p,e.count),r.componentParameters.texture=a,a.updateTexture()):(r.componentParameters=new B,r.componentParameters.castShadows=s.castShadows?0:2,r.componentParameters.externalColor=s.externalColor,r.componentParameters.externalColorMixMode=s.externalColorMixMode)}else r.componentParameters=new B,r.componentParameters.castShadows=t.castShadows?0:2,r.componentParameters.externalColor=t.externalColor,r.componentParameters.externalColorMixMode=t.externalColorMixMode;this._notifyDirty()}getComponentAabb(e,t,o){return e.intersectionGeometry.getComponentAabb(t,o)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,o){return e.intersectionGeometry.getComponentPositions(t,o)}intersect(e,o,r,n,a,c){const m=e;t(a)&&(a.localOrigin=m.transform.position);const l=i(N,m.transform.rotationScale);p(J,o,m.transform.position),p(Q,r,m.transform.position),h(J,J,l),h(Q,Q,l);const f=s(N,l);return m.intersectionGeometry.intersect(J,Q,n,f,a,c)}addEdges(e,t,o,r){const n=e,{indices:i,positions:s}=n.intersectionGeometry,a=n.components.offsets;return t.addComponentObject(e,n.transform,n.obb.center,s,i,a,o,r)}addComponentHighlight(e,t){const r=e.components;o(r.highlightCounts)&&(r.highlightCounts=new Uint32Array(r.count+1));0===r.highlightCounts[t]++&&(r.highlightsDirty(),this._notifyDirty()),r.highlightCounts[r.count]++}removeComponentHighlight(e,t){const r=e.components;if(o(r.highlightCounts))return void F.warn(\"Removing non-existing highlight.\");const n=r.highlightCounts[t],i=r.highlightCounts[r.count];if(0!==n){if(n>1)return r.highlightCounts[t]=n-1,void(r.highlightCounts[r.count]=i-1);r.highlightCounts[t]=0,r.highlightsDirty(),this._notifyDirty(),1===i?r.highlightCounts=null:r.highlightCounts[r.count]=i-1}else F.warn(\"Removing non-existing highlight.\")}clearHighlights(e){const o=e.components;t(o.highlightCounts)&&(o.highlightCounts=null,o.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects.getBucket(x)}get performanceInfo(){const e=this._objects.getPerformanceInfo(x);return{shown:e.added,hidden:e.removed}}_createRenderable(e,o){const m=this._renderManager.rctx,l=e.geometry,p=l.vertices.layoutParameters,h=L.createVertex(m,35044,l.vertices.data),u=r(l.indices,(e=>L.createIndex(m,35044,e))),b=C(k(p)),d=new Uint16Array(l.vertices.count);for(let r=0;r<o.count;r++){const e=o.offsets[r],n=o.offsets[r+1],i=o.materialDataIndices[r];if(t(l.indices))for(let t=e;t<n;t++){d[l.indices[t]]=i}else for(let t=e;t<n;t++)d[t]=i}const y=L.createVertex(m,35044,d.buffer),j=new A(e.transform.position),w=c(e.transform.rotationScale);i(w,w),s(w,w);const M=new I;f(M.worldFromModel_TL,j.low),f(M.worldFromModel_TH,j.high),a(M.worldFromModel_RS,e.transform.rotationScale),a(M.transformNormal_GlobalFromModel,w),g(M.toMapSpace,e.toMapSpace);const x=new G,_=new q(m,x.attributeLocations,{data:b,componentIndices:z},{data:h,componentIndices:y},n(u)),S=new D(_,4,p,t(u)),P={cameraDepthSquared:.5,gpuMemoryEstimate:h.byteSize+y.byteSize+(t(u)?u.byteSize:0)};return new v(x,M,S,P)}_notifyDirty(){this._renderManager.notifyDirty()}}const z=C(j().u16(\"componentIndex\"));function K(e,t){return e===t?0:0===e?2:1}const N=m(),J=u(),Q=u();export{H as ComponentObjectCollection};\n"]},"metadata":{},"sourceType":"module"}