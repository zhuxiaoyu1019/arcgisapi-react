{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isSome as e, isNone as s } from \"../../core/maybe.js\";\nimport { createAbortController as t, onAbort as r, onAbortOrThrow as i, createDeferred as h, isPromiseLike as o, createAbortError as c } from \"../../core/promiseUtils.js\";\nimport u from \"../../core/Queue.js\";\nimport { schedule as n } from \"../../core/scheduling.js\";\n\nclass l {\n  constructor(e, s) {\n    this.item = e, this.controller = s, this.promise = null;\n  }\n\n}\n\nclass _ {\n  constructor(s) {\n    this._deferreds = new Map(), this._controllers = new Map(), this._processingItems = new Map(), this._isPaused = !1, this._schedule = null, this._task = null, this.concurrency = 1, s.concurrency && (this.concurrency = s.concurrency), this._queue = new u(s.peeker), this.process = s.process;\n    const t = s.scheduler;\n    s.priority && e(t) && (this._task = t.registerTask(s.priority, this));\n  }\n\n  destroy() {\n    this.clear(), this._schedule && (this._schedule.remove(), this._schedule = null), this._task && (this._task.remove(), this._task = null);\n  }\n\n  get length() {\n    return this._processingItems.size + this._queue.length;\n  }\n\n  abort(e) {\n    const s = this._controllers.get(e);\n\n    s && s.abort();\n  }\n\n  clear() {\n    this._queue.clear();\n\n    const e = [];\n    this._controllers.forEach(s => e.push(s)), this._controllers.clear(), e.forEach(e => e.abort()), this._processingItems.clear(), this._cancelNext();\n  }\n\n  forEach(e) {\n    this._deferreds.forEach((s, t) => e(t));\n  }\n\n  get(e) {\n    const s = this._deferreds.get(e);\n\n    return s ? s.promise : void 0;\n  }\n\n  isOngoing(e) {\n    return this._processingItems.has(e);\n  }\n\n  has(e) {\n    return this._deferreds.has(e);\n  }\n\n  pause() {\n    this._isPaused || (this._isPaused = !0, this._cancelNext());\n  }\n\n  push(s, o) {\n    const u = this.get(s);\n    if (u) return u;\n    const n = t();\n    let l = null;\n    o && (l = r(o, () => n.abort()));\n\n    const _ = () => {\n      const e = this._processingItems.get(s);\n\n      e && e.controller.abort(), p(), d.reject(c());\n    },\n          p = () => {\n      a.remove(), e(l) && l.remove(), this._deferreds.delete(s), this._controllers.delete(s), this._queue.remove(s), this._processingItems.delete(s), this._scheduleNext();\n    },\n          a = i(n.signal, _),\n          d = h();\n\n    return this._deferreds.set(s, d), this._controllers.set(s, n), d.promise.then(p, p), this._queue.push(s), this._scheduleNext(), d.promise;\n  }\n\n  last() {\n    return this._queue.last();\n  }\n\n  peek() {\n    return this._queue.peek();\n  }\n\n  popLast() {\n    return this._queue.popLast();\n  }\n\n  reset() {\n    const e = [];\n    this._processingItems.forEach(s => e.push(s)), this._processingItems.clear();\n\n    for (const s of e) this._queue.push(s.item), s.controller.abort();\n\n    this._scheduleNext();\n  }\n\n  resume() {\n    this._isPaused && (this._isPaused = !1, this._scheduleNext());\n  }\n\n  takeAll() {\n    const e = [];\n\n    for (; this._queue.length;) e.push(this._queue.pop());\n\n    return this.clear(), e;\n  }\n\n  get running() {\n    return !this._isPaused && this._queue.length > 0 && this._processingItems.size < this.concurrency;\n  }\n\n  runTask(e) {\n    for (; !e.done && this._queue.length > 0 && this._processingItems.size < this.concurrency;) this._process(this._queue.pop()), e.madeProgress();\n  }\n\n  _scheduleNext() {\n    this._task || this._isPaused || this._schedule || (this._schedule = n(() => {\n      this._schedule = null, this._next();\n    }));\n  }\n\n  _next() {\n    for (; this._queue.length > 0 && this._processingItems.size < this.concurrency;) this._process(this._queue.pop());\n  }\n\n  _cancelNext() {\n    this._schedule && (this._schedule.remove(), this._schedule = null);\n  }\n\n  _processResult(e, s) {\n    this._canProcessFulfillment(e) && (this._scheduleNext(), this._deferreds.get(e.item).resolve(s));\n  }\n\n  _processError(e, s) {\n    this._canProcessFulfillment(e) && (this._scheduleNext(), this._deferreds.get(e.item).reject(s));\n  }\n\n  _canProcessFulfillment(e) {\n    return !!this._deferreds.get(e.item) && this._processingItems.get(e.item) === e;\n  }\n\n  _process(e) {\n    if (s(e)) return;\n    let r;\n    const i = t(),\n          h = new l(e, i);\n\n    this._processingItems.set(e, h);\n\n    try {\n      r = this.process(e, i.signal);\n    } catch (c) {\n      this._processError(h, c);\n    }\n\n    o(r) ? (h.promise = r, r.then(e => this._processResult(h, e), e => this._processError(h, e))) : this._processResult(h, r);\n  }\n\n  get test() {\n    return {\n      update: e => this.runTask(e)\n    };\n  }\n\n}\n\nexport { _ as QueueProcessor };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/support/QueueProcessor.js"],"names":["isSome","e","isNone","s","createAbortController","t","onAbort","r","onAbortOrThrow","i","createDeferred","h","isPromiseLike","o","createAbortError","c","u","schedule","n","l","constructor","item","controller","promise","_","_deferreds","Map","_controllers","_processingItems","_isPaused","_schedule","_task","concurrency","_queue","peeker","process","scheduler","priority","registerTask","destroy","clear","remove","length","size","abort","get","forEach","push","_cancelNext","isOngoing","has","pause","p","d","reject","a","delete","_scheduleNext","signal","set","then","last","peek","popLast","reset","resume","takeAll","pop","running","runTask","done","_process","madeProgress","_next","_processResult","_canProcessFulfillment","resolve","_processError","test","update","QueueProcessor"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isSome as e,isNone as s}from\"../../core/maybe.js\";import{createAbortController as t,onAbort as r,onAbortOrThrow as i,createDeferred as h,isPromiseLike as o,createAbortError as c}from\"../../core/promiseUtils.js\";import u from\"../../core/Queue.js\";import{schedule as n}from\"../../core/scheduling.js\";class l{constructor(e,s){this.item=e,this.controller=s,this.promise=null}}class _{constructor(s){this._deferreds=new Map,this._controllers=new Map,this._processingItems=new Map,this._isPaused=!1,this._schedule=null,this._task=null,this.concurrency=1,s.concurrency&&(this.concurrency=s.concurrency),this._queue=new u(s.peeker),this.process=s.process;const t=s.scheduler;s.priority&&e(t)&&(this._task=t.registerTask(s.priority,this))}destroy(){this.clear(),this._schedule&&(this._schedule.remove(),this._schedule=null),this._task&&(this._task.remove(),this._task=null)}get length(){return this._processingItems.size+this._queue.length}abort(e){const s=this._controllers.get(e);s&&s.abort()}clear(){this._queue.clear();const e=[];this._controllers.forEach((s=>e.push(s))),this._controllers.clear(),e.forEach((e=>e.abort())),this._processingItems.clear(),this._cancelNext()}forEach(e){this._deferreds.forEach(((s,t)=>e(t)))}get(e){const s=this._deferreds.get(e);return s?s.promise:void 0}isOngoing(e){return this._processingItems.has(e)}has(e){return this._deferreds.has(e)}pause(){this._isPaused||(this._isPaused=!0,this._cancelNext())}push(s,o){const u=this.get(s);if(u)return u;const n=t();let l=null;o&&(l=r(o,(()=>n.abort())));const _=()=>{const e=this._processingItems.get(s);e&&e.controller.abort(),p(),d.reject(c())},p=()=>{a.remove(),e(l)&&l.remove(),this._deferreds.delete(s),this._controllers.delete(s),this._queue.remove(s),this._processingItems.delete(s),this._scheduleNext()},a=i(n.signal,_),d=h();return this._deferreds.set(s,d),this._controllers.set(s,n),d.promise.then(p,p),this._queue.push(s),this._scheduleNext(),d.promise}last(){return this._queue.last()}peek(){return this._queue.peek()}popLast(){return this._queue.popLast()}reset(){const e=[];this._processingItems.forEach((s=>e.push(s))),this._processingItems.clear();for(const s of e)this._queue.push(s.item),s.controller.abort();this._scheduleNext()}resume(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())}takeAll(){const e=[];for(;this._queue.length;)e.push(this._queue.pop());return this.clear(),e}get running(){return!this._isPaused&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()}_scheduleNext(){this._task||this._isPaused||this._schedule||(this._schedule=n((()=>{this._schedule=null,this._next()})))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(e,s){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(s))}_processError(e,s){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(s))}_canProcessFulfillment(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e}_process(e){if(s(e))return;let r;const i=t(),h=new l(e,i);this._processingItems.set(e,h);try{r=this.process(e,i.signal)}catch(c){this._processError(h,c)}o(r)?(h.promise=r,r.then((e=>this._processResult(h,e)),(e=>this._processError(h,e)))):this._processResult(h,r)}get test(){return{update:e=>this.runTask(e)}}}export{_ as QueueProcessor};\n"]},"metadata":{},"sourceType":"module"}