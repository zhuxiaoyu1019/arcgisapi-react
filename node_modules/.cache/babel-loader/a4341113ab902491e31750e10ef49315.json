{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport \"../../../../../core/has.js\";\nimport t from \"../../../../../core/Logger.js\";\nimport { isSome as e, isNone as s } from \"../../../../../core/maybe.js\";\nimport { throwIfAborted as r, after as o } from \"../../../../../core/promiseUtils.js\";\nimport a from \"../../../../../core/RandomLCG.js\";\nimport { BaseFeatureSource as i } from \"./BaseFeatureSource.js\";\nimport { FeatureSetReaderIndirect as n } from \"../support/FeatureSetReaderPBFIndirect.js\";\nimport { UpdateToken as d } from \"../support/UpdateToken.js\";\nconst h = t.getLogger(\"esri.views.2d.layers.features.sources.SnapshotFeatureSource\");\n\nfunction l(t, e, s) {\n  const r = t.getXHydrate(),\n        o = t.getYHydrate(),\n        a = e.getColumnForX(r),\n        i = Math.floor(e.normalizeCol(a));\n  return `${s}/${Math.floor(e.getRowForY(o))}/${i}`;\n}\n\nfunction u(t, e) {\n  if (s(t)) return null;\n  const r = e.transform,\n        o = t.getQuantizationTransform();\n\n  if (s(o)) {\n    const [e, s] = r.scale,\n          [o, a] = r.translate,\n          i = -o / e,\n          n = 1 / e,\n          d = a / s,\n          h = 1 / -s;\n    return t.transform(i, d, n, h);\n  }\n\n  const [a, i] = o.scale,\n        [n, d] = o.translate,\n        [h, l] = r.scale,\n        [u, c] = r.translate,\n        g = a / h,\n        _ = (n - u) / h,\n        p = i / l,\n        m = (-d + c) / l;\n\n  return t.transform(_, m, g, p);\n}\n\nclass c extends i {\n  constructor(t) {\n    super(t), this.mode = \"snapshot\", this._loading = !0, this._controller = new AbortController(), this._downloadPromise = null, this._didSendEnd = !1, this._queries = new Array(), this._invalidated = !1, this._hasAggregates = !1, this._random = new a(1e3), this._featureCount = t.featureCount, this._store = t.store, this._markedIdsBufId = this._store.storage.createBitset();\n  }\n\n  destroy() {\n    super.destroy(), this._controller.abort();\n  }\n\n  get loading() {\n    return this._loading;\n  }\n\n  get _signal() {\n    return this._controller.signal;\n  }\n\n  update(t, e) {\n    super.update(t, e), this._hasAggregates = t.targets.aggregate;\n  }\n\n  async resend(t = !1) {\n    if (await this._downloadPromise, this._invalidated || t) return this._invalidated = !1, this._subscriptions.forEach(t => t.clear()), this._downloadPromise = this._download(this._featureCount), void (await this._downloadPromise);\n\n    const e = this._queries.map(({\n      query: t,\n      reader: e\n    }) => this._sendPatchQuery(t, e));\n\n    await Promise.all(e), this._subscriptions.forEach(t => {\n      t.requests.done.forEach(t => this._onMessage(t.message));\n    });\n  }\n\n  async refresh() {\n    await this.resend(!0);\n  }\n\n  async _sendPatchQuery(t, s) {\n    const o = e(t.outFields) ? t.outFields : [],\n          a = this._queryInfo.outFields,\n          i = a.filter(t => -1 === o.indexOf(t));\n    if (!i.length) return;\n    const n = t.clone(),\n          d = this._signal;\n    n.returnGeometry = !1, n.returnCentroid = !1, n.outFields = i, t.outFields = a;\n    const h = await this._queue.push({\n      query: n,\n      depth: 0,\n      signal: d\n    });\n    r({\n      signal: d\n    }), s.joinAttributes(h);\n  }\n\n  async _fetchDataTile(t) {\n    this._downloadPromise || (this._downloadPromise = this._download(this._featureCount));\n\n    const e = this._store.search(t),\n          s = this._subscriptions.get(t.key.id),\n          r = e.length - 1;\n\n    for (let h = 0; h < r; h++) {\n      const r = u(e[h], t),\n            a = {\n        type: \"append\",\n        id: t.id,\n        addOrUpdate: r,\n        end: !1,\n        status: d.empty()\n      };\n      s.add({\n        query: null,\n        message: a\n      }), this._hasAggregates || (await o(1)), this._onMessage(a);\n    }\n\n    const a = u(r >= 0 ? e[r] : null, t),\n          i = this._didSendEnd,\n          n = {\n      type: \"append\",\n      id: t.id,\n      addOrUpdate: a,\n      end: i,\n      status: d.empty()\n    };\n    s.add({\n      query: null,\n      message: n\n    }), this._onMessage(n);\n  }\n\n  async _download(t) {\n    try {\n      await this.whenInitialized();\n\n      const e = this._store.storage.getBitset(this._markedIdsBufId),\n            s = new Set();\n\n      e.clear();\n      const r = Math.ceil(t / this.pageSize),\n            o = Array.from({\n        length: r\n      }, (t, e) => e).sort((t, e) => this._random.getInt() - this._random.getInt()).map(t => this._downloadPage(t, e, s));\n      await Promise.all(o), this._store.sweepFeatures(e, this._store.storage), this._store.sweepFeatureSets(s);\n    } catch (e) {\n      h.error(\"mapview-snapshot-source\", \"Encountered and error when downloading feature snapshot\", e);\n    }\n\n    this._sendEnd(), this._loading = !1;\n  }\n\n  async _downloadPage(t, s, o) {\n    const a = this.pageSize,\n          i = {\n      start: t * a,\n      num: a,\n      cacheHint: !0\n    };\n    e(this.maxRecordCountFactor) && (i.maxRecordCountFactor = this.maxRecordCountFactor);\n    const n = this.createQuery(i),\n          d = this._signal,\n          h = await this._queue.push({\n      query: n,\n      depth: t,\n      signal: d\n    });\n    r({\n      signal: d\n    }), this._queries.push({\n      query: n,\n      reader: h\n    }), this._store.insert(h), o.add(h.instance);\n    const l = h.getCursor();\n\n    for (; l.next();) s.set(l.getDisplayId());\n\n    this._send(h);\n  }\n\n  _send(t) {\n    if (!this._subscriptions.size) return;\n    let r = null;\n    const o = new Map(),\n          a = new Set(),\n          i = new Map();\n\n    this._subscriptions.forEach(t => {\n      var e;\n      const s = t.tile;\n      o.set(s.key.id, null), r = s.tileInfoView, a.add(s.level);\n      const {\n        row: n,\n        col: d\n      } = s.key,\n            h = `${s.level}/${n}/${d}`,\n            l = null != (e = i.get(h)) ? e : [];\n      l.push(t), i.set(h, l);\n    });\n\n    for (const e of a) {\n      const a = r.getLODInfoAt(e),\n            n = t.getCursor();\n\n      for (; n.next();) {\n        const t = l(n, a, e),\n              r = n.getIndex();\n        if (i.has(t)) for (const e of i.get(t)) {\n          const t = e.tile.id;\n          let a = o.get(t);\n          s(a) && (a = [], o.set(t, a)), a.push(r);\n        }\n      }\n    }\n\n    o.forEach((s, r) => {\n      if (e(s)) {\n        const e = this._subscriptions.get(r),\n              o = {\n          type: \"append\",\n          id: r,\n          addOrUpdate: u(n.from(t, s), e.tile),\n          end: !1,\n          status: d.empty()\n        };\n\n        e.add({\n          query: null,\n          message: o\n        }), this._onMessage(o);\n      }\n    });\n  }\n\n  _sendEnd() {\n    this._subscriptions.forEach(t => {\n      const e = {\n        type: \"append\",\n        id: t.tile.id,\n        addOrUpdate: null,\n        end: !0,\n        status: d.empty()\n      };\n      t.add({\n        query: null,\n        message: e\n      }), this._onMessage(e);\n    }), this._didSendEnd = !0;\n  }\n\n}\n\nexport { c as SnapshotFeatureSource };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/2d/layers/features/sources/SnapshotFeatureSource.js"],"names":["t","isSome","e","isNone","s","throwIfAborted","r","after","o","a","BaseFeatureSource","i","FeatureSetReaderIndirect","n","UpdateToken","d","h","getLogger","l","getXHydrate","getYHydrate","getColumnForX","Math","floor","normalizeCol","getRowForY","u","transform","getQuantizationTransform","scale","translate","c","g","_","p","m","constructor","mode","_loading","_controller","AbortController","_downloadPromise","_didSendEnd","_queries","Array","_invalidated","_hasAggregates","_random","_featureCount","featureCount","_store","store","_markedIdsBufId","storage","createBitset","destroy","abort","loading","_signal","signal","update","targets","aggregate","resend","_subscriptions","forEach","clear","_download","map","query","reader","_sendPatchQuery","Promise","all","requests","done","_onMessage","message","refresh","outFields","_queryInfo","filter","indexOf","length","clone","returnGeometry","returnCentroid","_queue","push","depth","joinAttributes","_fetchDataTile","search","get","key","id","type","addOrUpdate","end","status","empty","add","whenInitialized","getBitset","Set","ceil","pageSize","from","sort","getInt","_downloadPage","sweepFeatures","sweepFeatureSets","error","_sendEnd","start","num","cacheHint","maxRecordCountFactor","createQuery","insert","instance","getCursor","next","set","getDisplayId","_send","size","Map","tile","tileInfoView","level","row","col","getLODInfoAt","getIndex","has","SnapshotFeatureSource"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport\"../../../../../core/has.js\";import t from\"../../../../../core/Logger.js\";import{isSome as e,isNone as s}from\"../../../../../core/maybe.js\";import{throwIfAborted as r,after as o}from\"../../../../../core/promiseUtils.js\";import a from\"../../../../../core/RandomLCG.js\";import{BaseFeatureSource as i}from\"./BaseFeatureSource.js\";import{FeatureSetReaderIndirect as n}from\"../support/FeatureSetReaderPBFIndirect.js\";import{UpdateToken as d}from\"../support/UpdateToken.js\";const h=t.getLogger(\"esri.views.2d.layers.features.sources.SnapshotFeatureSource\");function l(t,e,s){const r=t.getXHydrate(),o=t.getYHydrate(),a=e.getColumnForX(r),i=Math.floor(e.normalizeCol(a));return`${s}/${Math.floor(e.getRowForY(o))}/${i}`}function u(t,e){if(s(t))return null;const r=e.transform,o=t.getQuantizationTransform();if(s(o)){const[e,s]=r.scale,[o,a]=r.translate,i=-o/e,n=1/e,d=a/s,h=1/-s;return t.transform(i,d,n,h)}const[a,i]=o.scale,[n,d]=o.translate,[h,l]=r.scale,[u,c]=r.translate,g=a/h,_=(n-u)/h,p=i/l,m=(-d+c)/l;return t.transform(_,m,g,p)}class c extends i{constructor(t){super(t),this.mode=\"snapshot\",this._loading=!0,this._controller=new AbortController,this._downloadPromise=null,this._didSendEnd=!1,this._queries=new Array,this._invalidated=!1,this._hasAggregates=!1,this._random=new a(1e3),this._featureCount=t.featureCount,this._store=t.store,this._markedIdsBufId=this._store.storage.createBitset()}destroy(){super.destroy(),this._controller.abort()}get loading(){return this._loading}get _signal(){return this._controller.signal}update(t,e){super.update(t,e),this._hasAggregates=t.targets.aggregate}async resend(t=!1){if(await this._downloadPromise,this._invalidated||t)return this._invalidated=!1,this._subscriptions.forEach((t=>t.clear())),this._downloadPromise=this._download(this._featureCount),void await this._downloadPromise;const e=this._queries.map((({query:t,reader:e})=>this._sendPatchQuery(t,e)));await Promise.all(e),this._subscriptions.forEach((t=>{t.requests.done.forEach((t=>this._onMessage(t.message)))}))}async refresh(){await this.resend(!0)}async _sendPatchQuery(t,s){const o=e(t.outFields)?t.outFields:[],a=this._queryInfo.outFields,i=a.filter((t=>-1===o.indexOf(t)));if(!i.length)return;const n=t.clone(),d=this._signal;n.returnGeometry=!1,n.returnCentroid=!1,n.outFields=i,t.outFields=a;const h=await this._queue.push({query:n,depth:0,signal:d});r({signal:d}),s.joinAttributes(h)}async _fetchDataTile(t){this._downloadPromise||(this._downloadPromise=this._download(this._featureCount));const e=this._store.search(t),s=this._subscriptions.get(t.key.id),r=e.length-1;for(let h=0;h<r;h++){const r=u(e[h],t),a={type:\"append\",id:t.id,addOrUpdate:r,end:!1,status:d.empty()};s.add({query:null,message:a}),this._hasAggregates||await o(1),this._onMessage(a)}const a=u(r>=0?e[r]:null,t),i=this._didSendEnd,n={type:\"append\",id:t.id,addOrUpdate:a,end:i,status:d.empty()};s.add({query:null,message:n}),this._onMessage(n)}async _download(t){try{await this.whenInitialized();const e=this._store.storage.getBitset(this._markedIdsBufId),s=new Set;e.clear();const r=Math.ceil(t/this.pageSize),o=Array.from({length:r},((t,e)=>e)).sort(((t,e)=>this._random.getInt()-this._random.getInt())).map((t=>this._downloadPage(t,e,s)));await Promise.all(o),this._store.sweepFeatures(e,this._store.storage),this._store.sweepFeatureSets(s)}catch(e){h.error(\"mapview-snapshot-source\",\"Encountered and error when downloading feature snapshot\",e)}this._sendEnd(),this._loading=!1}async _downloadPage(t,s,o){const a=this.pageSize,i={start:t*a,num:a,cacheHint:!0};e(this.maxRecordCountFactor)&&(i.maxRecordCountFactor=this.maxRecordCountFactor);const n=this.createQuery(i),d=this._signal,h=await this._queue.push({query:n,depth:t,signal:d});r({signal:d}),this._queries.push({query:n,reader:h}),this._store.insert(h),o.add(h.instance);const l=h.getCursor();for(;l.next();)s.set(l.getDisplayId());this._send(h)}_send(t){if(!this._subscriptions.size)return;let r=null;const o=new Map,a=new Set,i=new Map;this._subscriptions.forEach((t=>{var e;const s=t.tile;o.set(s.key.id,null),r=s.tileInfoView,a.add(s.level);const{row:n,col:d}=s.key,h=`${s.level}/${n}/${d}`,l=null!=(e=i.get(h))?e:[];l.push(t),i.set(h,l)}));for(const e of a){const a=r.getLODInfoAt(e),n=t.getCursor();for(;n.next();){const t=l(n,a,e),r=n.getIndex();if(i.has(t))for(const e of i.get(t)){const t=e.tile.id;let a=o.get(t);s(a)&&(a=[],o.set(t,a)),a.push(r)}}}o.forEach(((s,r)=>{if(e(s)){const e=this._subscriptions.get(r),o={type:\"append\",id:r,addOrUpdate:u(n.from(t,s),e.tile),end:!1,status:d.empty()};e.add({query:null,message:o}),this._onMessage(o)}}))}_sendEnd(){this._subscriptions.forEach((t=>{const e={type:\"append\",id:t.tile.id,addOrUpdate:null,end:!0,status:d.empty()};t.add({query:null,message:e}),this._onMessage(e)})),this._didSendEnd=!0}}export{c as SnapshotFeatureSource};\n"]},"metadata":{},"sourceType":"module"}