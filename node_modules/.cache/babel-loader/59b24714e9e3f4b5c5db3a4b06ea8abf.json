{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isSome as e } from \"../../../../core/maybe.js\";\nimport { MIN_PRIORITY as t } from \"../../../../core/MemCache.js\";\nimport { throwIfAborted as o } from \"../../../../core/promiseUtils.js\";\nimport { f as i } from \"../../../../chunks/mat3f32.js\";\nimport { create as s } from \"../../../../geometry/support/aaBoundingRect.js\";\nimport { VectorTile as r } from \"./VectorTile.js\";\nimport { TileHandler as n } from \"./TileHandler.js\";\nimport { declutterSingleTile as l } from \"./decluttering/jobsUtil.js\";\nimport a from \"../../tiling/TileKey.js\";\n\nclass g extends n {\n  constructor(e, t, o, i, s) {\n    super(e, t, o), this._memCache = i, this._loader = s, this._ongoingTileRequests = new Map(), this._ongoingRequestToController = new Map();\n  }\n\n  destroy() {\n    this._ongoingRequestToController.forEach(e => e.abort()), this._ongoingRequestToController.clear(), this._ongoingTileRequests.clear();\n  }\n\n  async getVectorTile(n, g, h, c) {\n    const m = new a(n, g, h, 0);\n\n    let u = this._memCache.get(m.id);\n\n    if (e(u)) return u.retain(), u;\n\n    const _ = await this._getVectorTileData(m);\n\n    if (o(c), !this._vectorTileLayer) return null;\n    if (u = this._memCache.get(m.id), e(u)) return u.retain(), u;\n\n    const T = this._vectorTileLayer.tileInfo.getTileBounds(s(), m);\n\n    return u = new r(m, this._styleRepository, T, [512, 512], this._memCache), e(_) && _.tileData ? (u.setData(_.tileData), u.retain(), this._memCache.put(m.id, u, u.memoryUsage * u.referenced, t)) : u.setData(null), u.neededForCoverage = !0, u.transforms.tileUnitsToPixels = i(1 / 8, 0, 0, 0, 1 / 8, 0, 0, 0, 1), l(u, this._styleRepository), u;\n  }\n\n  _getVectorTileData(e) {\n    const t = e.id;\n    if (this._ongoingTileRequests.has(t)) return this._ongoingTileRequests.get(t);\n\n    const o = new AbortController(),\n          i = {\n      signal: o.signal\n    },\n          s = this._getParsedVectorTileData(e, i).then(e => (this._ongoingTileRequests.delete(t), this._ongoingRequestToController.delete(t), e)).catch(() => (this._ongoingTileRequests.delete(t), this._ongoingRequestToController.delete(t), null));\n\n    return this._ongoingTileRequests.set(t, s), this._ongoingRequestToController.set(t, o), s;\n  }\n\n  _getParsedVectorTileData(e, t) {\n    return this.fetchTileData(e, t).then(o => this.parseTileData({\n      key: e,\n      data: o\n    }, t));\n  }\n\n  request(e, t) {\n    return this._loader.request(e, \"binary\", t);\n  }\n\n}\n\nexport default g;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/2d/engine/vectorTiles/TileHandler3D.js"],"names":["isSome","e","MIN_PRIORITY","t","throwIfAborted","o","f","i","create","s","VectorTile","r","TileHandler","n","declutterSingleTile","l","a","g","constructor","_memCache","_loader","_ongoingTileRequests","Map","_ongoingRequestToController","destroy","forEach","abort","clear","getVectorTile","h","c","m","u","get","id","retain","_","_getVectorTileData","_vectorTileLayer","T","tileInfo","getTileBounds","_styleRepository","tileData","setData","put","memoryUsage","referenced","neededForCoverage","transforms","tileUnitsToPixels","has","AbortController","signal","_getParsedVectorTileData","then","delete","catch","set","fetchTileData","parseTileData","key","data","request"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isSome as e}from\"../../../../core/maybe.js\";import{MIN_PRIORITY as t}from\"../../../../core/MemCache.js\";import{throwIfAborted as o}from\"../../../../core/promiseUtils.js\";import{f as i}from\"../../../../chunks/mat3f32.js\";import{create as s}from\"../../../../geometry/support/aaBoundingRect.js\";import{VectorTile as r}from\"./VectorTile.js\";import{TileHandler as n}from\"./TileHandler.js\";import{declutterSingleTile as l}from\"./decluttering/jobsUtil.js\";import a from\"../../tiling/TileKey.js\";class g extends n{constructor(e,t,o,i,s){super(e,t,o),this._memCache=i,this._loader=s,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map}destroy(){this._ongoingRequestToController.forEach((e=>e.abort())),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear()}async getVectorTile(n,g,h,c){const m=new a(n,g,h,0);let u=this._memCache.get(m.id);if(e(u))return u.retain(),u;const _=await this._getVectorTileData(m);if(o(c),!this._vectorTileLayer)return null;if(u=this._memCache.get(m.id),e(u))return u.retain(),u;const T=this._vectorTileLayer.tileInfo.getTileBounds(s(),m);return u=new r(m,this._styleRepository,T,[512,512],this._memCache),e(_)&&_.tileData?(u.setData(_.tileData),u.retain(),this._memCache.put(m.id,u,u.memoryUsage*u.referenced,t)):u.setData(null),u.neededForCoverage=!0,u.transforms.tileUnitsToPixels=i(1/8,0,0,0,1/8,0,0,0,1),l(u,this._styleRepository),u}_getVectorTileData(e){const t=e.id;if(this._ongoingTileRequests.has(t))return this._ongoingTileRequests.get(t);const o=new AbortController,i={signal:o.signal},s=this._getParsedVectorTileData(e,i).then((e=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),e))).catch((()=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),null)));return this._ongoingTileRequests.set(t,s),this._ongoingRequestToController.set(t,o),s}_getParsedVectorTileData(e,t){return this.fetchTileData(e,t).then((o=>this.parseTileData({key:e,data:o},t)))}request(e,t){return this._loader.request(e,\"binary\",t)}}export default g;\n"]},"metadata":{},"sourceType":"module"}