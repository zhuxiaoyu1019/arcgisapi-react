{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../chunks/tslib.es6.js\";\nimport \"../../../geometry.js\";\nimport t from \"../../../Graphic.js\";\nimport r from \"../../../core/Collection.js\";\nimport s from \"../../../core/Error.js\";\nimport o from \"../../../core/has.js\";\nimport i from \"../../../core/Loadable.js\";\nimport n from \"../../../core/Logger.js\";\nimport { isSome as a, isNone as l } from \"../../../core/maybe.js\";\nimport { EsriPromiseMixin as u } from \"../../../core/Promise.js\";\nimport { open as p } from \"../../../core/workers/workers.js\";\nimport { property as c } from \"../../../core/accessorSupport/decorators/property.js\";\nimport { ensureType as d } from \"../../../core/accessorSupport/ensureType.js\";\nimport { shared as h } from \"../../../core/accessorSupport/decorators/shared.js\";\nimport { subclass as y } from \"../../../core/accessorSupport/decorators/subclass.js\";\nimport { applyFeatureSetZUnitScaling as m } from \"../../../rest/query/operations/queryZScale.js\";\nimport { unapplyEditsZUnitScaling as f } from \"../../../rest/query/operations/zscale.js\";\nimport g from \"../../../rest/support/FeatureSet.js\";\nimport _ from \"../../../geometry/Extent.js\";\nimport S from \"../../../geometry/Polygon.js\";\nimport { typeKebabDictionary as b } from \"../../../geometry/support/typeUtils.js\";\nlet j = 0;\nconst T = n.getLogger(\"esri.layers.graphics.sources.MemorySource\");\nlet F = class extends i.LoadableMixin(u(r)) {\n  constructor(e) {\n    super(e), this._idToClientGraphic = null, this.type = \"memory\";\n  }\n\n  load(e) {\n    const t = a(e) ? e.signal : null;\n    return this.addResolvingPromise(this._startWorker(t)), Promise.resolve(this);\n  }\n\n  destroy() {\n    var e;\n    null == (e = this._connection) || e.close(), this._connection = null;\n  }\n\n  get workerGeometryType() {\n    var e;\n    const t = null == (e = this.layer) ? void 0 : e.geometryType;\n    return t ? this._geometryTypeRequiresClientGraphicMapping(t) ? \"polygon\" : t : null;\n  }\n\n  applyEdits(e) {\n    return this.load().then(() => this._applyEdits(e));\n  }\n\n  openPorts() {\n    return this.load().then(() => this._connection.openPorts());\n  }\n\n  async queryFeatures(e, t = {}) {\n    await this.load(t);\n    const r = await this._connection.invoke(\"queryFeatures\", e ? e.toJSON() : null, t);\n    m(e, this.layer.spatialReference, r);\n    const s = g.fromJSON(r);\n    if (!this._requiresClientGraphicMapping()) return s;\n    const o = this.layer.objectIdField;\n\n    for (const i of s.features) {\n      const e = i.attributes[o],\n            t = this._idToClientGraphic.get(e);\n\n      t && (i.geometry = t.geometry);\n    }\n\n    return s.geometryType = this.layer.geometryType, s;\n  }\n\n  async queryFeaturesJSON(e, t = {}) {\n    if (this._requiresClientGraphicMapping()) throw new s(\"query-features-json:unsupported\", \"Cannot query in JSON format for client only geometry types (mesh and extent)\");\n    await this.load(t);\n    const r = await this._connection.invoke(\"queryFeatures\", e ? e.toJSON() : null, t);\n    return m(e, this.layer.spatialReference, r), r;\n  }\n\n  queryFeatureCount(e, t = {}) {\n    return this.load(t).then(() => this._connection.invoke(\"queryFeatureCount\", e ? e.toJSON() : null, t));\n  }\n\n  queryObjectIds(e, t = {}) {\n    return this.load(t).then(() => this._connection.invoke(\"queryObjectIds\", e ? e.toJSON() : null, t));\n  }\n\n  queryExtent(e, t = {}) {\n    return this.load(t).then(() => this._connection.invoke(\"queryExtent\", e ? e.toJSON() : null, t)).then(e => ({\n      count: e.count,\n      extent: _.fromJSON(e.extent)\n    }));\n  }\n\n  querySnapping(e, t = {}) {\n    return this.load(t).then(() => this._connection.invoke(\"querySnapping\", e, t));\n  }\n\n  async _applyEdits(e) {\n    if (!this._connection) throw new s(\"feature-layer-source:edit-failure\", \"Memory source not loaded\");\n    const t = this.layer.objectIdField;\n    let r = null;\n    const o = [],\n          i = [];\n    await Promise.all([this._prepareClientMapping(e.addFeatures, null), this._prepareClientMapping(e.updateFeatures, null)]);\n\n    const n = e => \"objectId\" in e && null != e.objectId ? e.objectId : \"attributes\" in e && null != e.attributes[t] ? e.attributes[t] : null;\n\n    if (e.addFeatures && (r = this._prepareAddFeatures(e.addFeatures)), e.deleteFeatures) for (const s of e.deleteFeatures) {\n      const e = n(s);\n      null != e && o.push(e);\n    }\n    const a = e.updateFeatures && this._idToClientGraphic ? new Map() : null;\n    if (e.updateFeatures) for (const s of e.updateFeatures) if (i.push(this._serializeFeature(s)), a) {\n      const e = n(s);\n      null != e && a.set(e, s);\n    }\n    f(r ? r.features : null, i, this.layer.spatialReference);\n    const {\n      fullExtent: l,\n      featureEditResults: u\n    } = await this._connection.invoke(\"applyEdits\", {\n      adds: r ? r.features : [],\n      updates: i,\n      deletes: o\n    });\n    return this.fullExtent = l, r && r.finish(u.uidToObjectId), this._updateClientGraphicIds(a, u), this._createEditsResult(u);\n  }\n\n  async _prepareClientMapping(e, t) {\n    if (\"mesh\" !== this.layerOrSourceGeometryType || l(e)) return;\n    const r = [];\n\n    for (const {\n      geometry: s\n    } of e) !a(s) || \"mesh\" !== s.type || s.hasExtent || s.loaded || r.push(s.load({\n      signal: t\n    }));\n\n    r.length && (await Promise.all(r));\n  }\n\n  _updateClientGraphicIds(e, t) {\n    if (this._idToClientGraphic) {\n      if (e) for (const r of t.updateResults) {\n        if (!r.success) continue;\n        const t = e.get(r.objectId);\n        null != t && this._addIdToClientGraphic(t);\n      }\n\n      for (const e of t.deleteResults) e.success && this._idToClientGraphic.delete(e.objectId);\n    }\n  }\n\n  _createEditsResult(e) {\n    return {\n      addFeatureResults: e.addResults ? e.addResults.map(this._createFeatureEditResult, this) : [],\n      updateFeatureResults: e.updateResults ? e.updateResults.map(this._createFeatureEditResult, this) : [],\n      deleteFeatureResults: e.deleteResults ? e.deleteResults.map(this._createFeatureEditResult, this) : [],\n      addAttachmentResults: [],\n      updateAttachmentResults: [],\n      deleteAttachmentResults: []\n    };\n  }\n\n  _createFeatureEditResult(e) {\n    const t = !0 === e.success ? null : e.error || {\n      code: void 0,\n      description: void 0\n    };\n    return {\n      objectId: e.objectId,\n      globalId: e.globalId,\n      error: t ? new s(\"feature-layer-source:edit-failure\", t.description, {\n        code: t.code\n      }) : null\n    };\n  }\n\n  _prepareAddFeatures(e) {\n    const t = new Map(),\n          r = new Array(e.length);\n    let s = null;\n\n    for (let i = 0; i < e.length; i++) {\n      const o = e[i],\n            n = this._serializeFeature(o);\n\n      !s && a(o.geometry) && (s = o.geometry.type), r[i] = n, t.set(`${n.uid}`, o);\n    }\n\n    const o = this;\n    return {\n      features: r,\n      inferredGeometryType: s,\n\n      finish(e) {\n        const r = o.sourceJSON.objectIdField;\n\n        for (const s in e) {\n          const i = e[s],\n                n = t.get(s);\n          n && (n.attributes || (n.attributes = {}), -1 === i ? delete n.attributes[r] : n.attributes[r] = i, o._addIdToClientGraphic(n));\n        }\n      }\n\n    };\n  }\n\n  _addIdToClientGraphic(e) {\n    if (!this._idToClientGraphic) return;\n    const t = this.sourceJSON.objectIdField,\n          r = e.attributes && e.attributes[t];\n    null != r && this._idToClientGraphic.set(r, e);\n  }\n\n  get layerOrSourceGeometryType() {\n    var e, t, r;\n    return null != (e = null == (t = this.layer) ? void 0 : t.geometryType) ? e : null == (r = this.sourceJSON) ? void 0 : r.geometryType;\n  }\n\n  _requiresClientGraphicMapping() {\n    return this._geometryTypeRequiresClientGraphicMapping(this.layerOrSourceGeometryType);\n  }\n\n  _geometryRequiresClientGraphicMapping(e) {\n    return this._geometryTypeRequiresClientGraphicMapping(e.type);\n  }\n\n  _geometryTypeRequiresClientGraphicMapping(e) {\n    return \"mesh\" === e || \"multipatch\" === e || \"extent\" === e;\n  }\n\n  _serializeFeature(e) {\n    const {\n      attributes: t\n    } = e,\n          r = this._geometryForSerialization(e),\n          s = (j++).toString();\n\n    return r ? {\n      uid: s,\n      geometry: r.toJSON(),\n      attributes: t\n    } : {\n      uid: s,\n      attributes: t\n    };\n  }\n\n  _geometryForSerialization(e) {\n    const {\n      geometry: t\n    } = e;\n    if (l(t)) return null;\n\n    if (this._geometryRequiresClientGraphicMapping(t)) {\n      return t.extent ? S.fromExtent(t.extent) : null;\n    }\n\n    return t;\n  }\n\n  async _startWorker(e) {\n    this._connection = await p(\"MemorySourceWorker\", {\n      strategy: o(\"feature-layers-workers\") ? \"dedicated\" : \"local\",\n      signal: e\n    });\n    const {\n      fields: t,\n      spatialReference: r,\n      objectIdField: s,\n      hasM: i,\n      hasZ: n,\n      timeInfo: a\n    } = this.layer,\n          l = \"defaults\" === this.layer.originOf(\"spatialReference\");\n    await this._prepareClientMapping(this.items, e);\n\n    const u = this._prepareAddFeatures(this.items);\n\n    this.on(\"before-changes\", e => {\n      T.error(\"Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead\"), e.preventDefault();\n    });\n    const c = {\n      features: u.features,\n      fields: t && t.map(e => e.toJSON()),\n      geometryType: b.toJSON(this.workerGeometryType),\n      hasM: \"mesh\" !== this.layerOrSourceGeometryType && i,\n      hasZ: \"mesh\" === this.layerOrSourceGeometryType || n,\n      objectIdField: s,\n      spatialReference: l ? null : r && r.toJSON(),\n      timeInfo: a ? a.toJSON() : null\n    },\n          d = await this._connection.invoke(\"load\", c, {\n      signal: e\n    });\n\n    for (const o of d.warnings) T.warn(o.message, {\n      layer: this.layer,\n      warning: o\n    });\n\n    d.featureErrors.length && T.warn(`Encountered ${d.featureErrors.length} validation errors while loading features`, d.featureErrors);\n    const h = d.layerDefinition;\n    this._geometryTypeRequiresClientGraphicMapping(u.inferredGeometryType) && (h.geometryType = b.toJSON(u.inferredGeometryType)), this.sourceJSON = h, this._requiresClientGraphicMapping() && (this._idToClientGraphic = new Map()), u.finish(d.assignedObjectIds);\n  }\n\n};\ne([h({\n  Type: t,\n  ensureType: d(t)\n})], F.prototype, \"itemType\", void 0), e([c()], F.prototype, \"type\", void 0), e([c({\n  constructOnly: !0\n})], F.prototype, \"layer\", void 0), e([c({\n  readOnly: !0\n})], F.prototype, \"workerGeometryType\", null), e([c()], F.prototype, \"sourceJSON\", void 0), F = e([y(\"esri.layers.graphics.sources.MemorySource\")], F);\nvar G = F;\nexport default G;\nexport { F as MemorySource };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/layers/graphics/sources/MemorySource.js"],"names":["_","e","t","r","s","o","i","n","isSome","a","isNone","l","EsriPromiseMixin","u","open","p","property","c","ensureType","d","shared","h","subclass","y","applyFeatureSetZUnitScaling","m","unapplyEditsZUnitScaling","f","g","S","typeKebabDictionary","b","j","T","getLogger","F","LoadableMixin","constructor","_idToClientGraphic","type","load","signal","addResolvingPromise","_startWorker","Promise","resolve","destroy","_connection","close","workerGeometryType","layer","geometryType","_geometryTypeRequiresClientGraphicMapping","applyEdits","then","_applyEdits","openPorts","queryFeatures","invoke","toJSON","spatialReference","fromJSON","_requiresClientGraphicMapping","objectIdField","features","attributes","get","geometry","queryFeaturesJSON","queryFeatureCount","queryObjectIds","queryExtent","count","extent","querySnapping","all","_prepareClientMapping","addFeatures","updateFeatures","objectId","_prepareAddFeatures","deleteFeatures","push","Map","_serializeFeature","set","fullExtent","featureEditResults","adds","updates","deletes","finish","uidToObjectId","_updateClientGraphicIds","_createEditsResult","layerOrSourceGeometryType","hasExtent","loaded","length","updateResults","success","_addIdToClientGraphic","deleteResults","delete","addFeatureResults","addResults","map","_createFeatureEditResult","updateFeatureResults","deleteFeatureResults","addAttachmentResults","updateAttachmentResults","deleteAttachmentResults","error","code","description","globalId","Array","uid","inferredGeometryType","sourceJSON","_geometryRequiresClientGraphicMapping","_geometryForSerialization","toString","fromExtent","strategy","fields","hasM","hasZ","timeInfo","originOf","items","on","preventDefault","warnings","warn","message","warning","featureErrors","layerDefinition","assignedObjectIds","Type","prototype","constructOnly","readOnly","G","MemorySource"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import\"../../../geometry.js\";import t from\"../../../Graphic.js\";import r from\"../../../core/Collection.js\";import s from\"../../../core/Error.js\";import o from\"../../../core/has.js\";import i from\"../../../core/Loadable.js\";import n from\"../../../core/Logger.js\";import{isSome as a,isNone as l}from\"../../../core/maybe.js\";import{EsriPromiseMixin as u}from\"../../../core/Promise.js\";import{open as p}from\"../../../core/workers/workers.js\";import{property as c}from\"../../../core/accessorSupport/decorators/property.js\";import{ensureType as d}from\"../../../core/accessorSupport/ensureType.js\";import{shared as h}from\"../../../core/accessorSupport/decorators/shared.js\";import{subclass as y}from\"../../../core/accessorSupport/decorators/subclass.js\";import{applyFeatureSetZUnitScaling as m}from\"../../../rest/query/operations/queryZScale.js\";import{unapplyEditsZUnitScaling as f}from\"../../../rest/query/operations/zscale.js\";import g from\"../../../rest/support/FeatureSet.js\";import _ from\"../../../geometry/Extent.js\";import S from\"../../../geometry/Polygon.js\";import{typeKebabDictionary as b}from\"../../../geometry/support/typeUtils.js\";let j=0;const T=n.getLogger(\"esri.layers.graphics.sources.MemorySource\");let F=class extends(i.LoadableMixin(u(r))){constructor(e){super(e),this._idToClientGraphic=null,this.type=\"memory\"}load(e){const t=a(e)?e.signal:null;return this.addResolvingPromise(this._startWorker(t)),Promise.resolve(this)}destroy(){var e;null==(e=this._connection)||e.close(),this._connection=null}get workerGeometryType(){var e;const t=null==(e=this.layer)?void 0:e.geometryType;return t?this._geometryTypeRequiresClientGraphicMapping(t)?\"polygon\":t:null}applyEdits(e){return this.load().then((()=>this._applyEdits(e)))}openPorts(){return this.load().then((()=>this._connection.openPorts()))}async queryFeatures(e,t={}){await this.load(t);const r=await this._connection.invoke(\"queryFeatures\",e?e.toJSON():null,t);m(e,this.layer.spatialReference,r);const s=g.fromJSON(r);if(!this._requiresClientGraphicMapping())return s;const o=this.layer.objectIdField;for(const i of s.features){const e=i.attributes[o],t=this._idToClientGraphic.get(e);t&&(i.geometry=t.geometry)}return s.geometryType=this.layer.geometryType,s}async queryFeaturesJSON(e,t={}){if(this._requiresClientGraphicMapping())throw new s(\"query-features-json:unsupported\",\"Cannot query in JSON format for client only geometry types (mesh and extent)\");await this.load(t);const r=await this._connection.invoke(\"queryFeatures\",e?e.toJSON():null,t);return m(e,this.layer.spatialReference,r),r}queryFeatureCount(e,t={}){return this.load(t).then((()=>this._connection.invoke(\"queryFeatureCount\",e?e.toJSON():null,t)))}queryObjectIds(e,t={}){return this.load(t).then((()=>this._connection.invoke(\"queryObjectIds\",e?e.toJSON():null,t)))}queryExtent(e,t={}){return this.load(t).then((()=>this._connection.invoke(\"queryExtent\",e?e.toJSON():null,t))).then((e=>({count:e.count,extent:_.fromJSON(e.extent)})))}querySnapping(e,t={}){return this.load(t).then((()=>this._connection.invoke(\"querySnapping\",e,t)))}async _applyEdits(e){if(!this._connection)throw new s(\"feature-layer-source:edit-failure\",\"Memory source not loaded\");const t=this.layer.objectIdField;let r=null;const o=[],i=[];await Promise.all([this._prepareClientMapping(e.addFeatures,null),this._prepareClientMapping(e.updateFeatures,null)]);const n=e=>\"objectId\"in e&&null!=e.objectId?e.objectId:\"attributes\"in e&&null!=e.attributes[t]?e.attributes[t]:null;if(e.addFeatures&&(r=this._prepareAddFeatures(e.addFeatures)),e.deleteFeatures)for(const s of e.deleteFeatures){const e=n(s);null!=e&&o.push(e)}const a=e.updateFeatures&&this._idToClientGraphic?new Map:null;if(e.updateFeatures)for(const s of e.updateFeatures)if(i.push(this._serializeFeature(s)),a){const e=n(s);null!=e&&a.set(e,s)}f(r?r.features:null,i,this.layer.spatialReference);const{fullExtent:l,featureEditResults:u}=await this._connection.invoke(\"applyEdits\",{adds:r?r.features:[],updates:i,deletes:o});return this.fullExtent=l,r&&r.finish(u.uidToObjectId),this._updateClientGraphicIds(a,u),this._createEditsResult(u)}async _prepareClientMapping(e,t){if(\"mesh\"!==this.layerOrSourceGeometryType||l(e))return;const r=[];for(const{geometry:s}of e)!a(s)||\"mesh\"!==s.type||s.hasExtent||s.loaded||r.push(s.load({signal:t}));r.length&&await Promise.all(r)}_updateClientGraphicIds(e,t){if(this._idToClientGraphic){if(e)for(const r of t.updateResults){if(!r.success)continue;const t=e.get(r.objectId);null!=t&&this._addIdToClientGraphic(t)}for(const e of t.deleteResults)e.success&&this._idToClientGraphic.delete(e.objectId)}}_createEditsResult(e){return{addFeatureResults:e.addResults?e.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:e.updateResults?e.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:e.deleteResults?e.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}}_createFeatureEditResult(e){const t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new s(\"feature-layer-source:edit-failure\",t.description,{code:t.code}):null}}_prepareAddFeatures(e){const t=new Map,r=new Array(e.length);let s=null;for(let i=0;i<e.length;i++){const o=e[i],n=this._serializeFeature(o);!s&&a(o.geometry)&&(s=o.geometry.type),r[i]=n,t.set(`${n.uid}`,o)}const o=this;return{features:r,inferredGeometryType:s,finish(e){const r=o.sourceJSON.objectIdField;for(const s in e){const i=e[s],n=t.get(s);n&&(n.attributes||(n.attributes={}),-1===i?delete n.attributes[r]:n.attributes[r]=i,o._addIdToClientGraphic(n))}}}}_addIdToClientGraphic(e){if(!this._idToClientGraphic)return;const t=this.sourceJSON.objectIdField,r=e.attributes&&e.attributes[t];null!=r&&this._idToClientGraphic.set(r,e)}get layerOrSourceGeometryType(){var e,t,r;return null!=(e=null==(t=this.layer)?void 0:t.geometryType)?e:null==(r=this.sourceJSON)?void 0:r.geometryType}_requiresClientGraphicMapping(){return this._geometryTypeRequiresClientGraphicMapping(this.layerOrSourceGeometryType)}_geometryRequiresClientGraphicMapping(e){return this._geometryTypeRequiresClientGraphicMapping(e.type)}_geometryTypeRequiresClientGraphicMapping(e){return\"mesh\"===e||\"multipatch\"===e||\"extent\"===e}_serializeFeature(e){const{attributes:t}=e,r=this._geometryForSerialization(e),s=(j++).toString();return r?{uid:s,geometry:r.toJSON(),attributes:t}:{uid:s,attributes:t}}_geometryForSerialization(e){const{geometry:t}=e;if(l(t))return null;if(this._geometryRequiresClientGraphicMapping(t)){return t.extent?S.fromExtent(t.extent):null}return t}async _startWorker(e){this._connection=await p(\"MemorySourceWorker\",{strategy:o(\"feature-layers-workers\")?\"dedicated\":\"local\",signal:e});const{fields:t,spatialReference:r,objectIdField:s,hasM:i,hasZ:n,timeInfo:a}=this.layer,l=\"defaults\"===this.layer.originOf(\"spatialReference\");await this._prepareClientMapping(this.items,e);const u=this._prepareAddFeatures(this.items);this.on(\"before-changes\",(e=>{T.error(\"Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead\"),e.preventDefault()}));const c={features:u.features,fields:t&&t.map((e=>e.toJSON())),geometryType:b.toJSON(this.workerGeometryType),hasM:\"mesh\"!==this.layerOrSourceGeometryType&&i,hasZ:\"mesh\"===this.layerOrSourceGeometryType||n,objectIdField:s,spatialReference:l?null:r&&r.toJSON(),timeInfo:a?a.toJSON():null},d=await this._connection.invoke(\"load\",c,{signal:e});for(const o of d.warnings)T.warn(o.message,{layer:this.layer,warning:o});d.featureErrors.length&&T.warn(`Encountered ${d.featureErrors.length} validation errors while loading features`,d.featureErrors);const h=d.layerDefinition;this._geometryTypeRequiresClientGraphicMapping(u.inferredGeometryType)&&(h.geometryType=b.toJSON(u.inferredGeometryType)),this.sourceJSON=h,this._requiresClientGraphicMapping()&&(this._idToClientGraphic=new Map),u.finish(d.assignedObjectIds)}};e([h({Type:t,ensureType:d(t)})],F.prototype,\"itemType\",void 0),e([c()],F.prototype,\"type\",void 0),e([c({constructOnly:!0})],F.prototype,\"layer\",void 0),e([c({readOnly:!0})],F.prototype,\"workerGeometryType\",null),e([c()],F.prototype,\"sourceJSON\",void 0),F=e([y(\"esri.layers.graphics.sources.MemorySource\")],F);var G=F;export default G;export{F as MemorySource};\n"]},"metadata":{},"sourceType":"module"}