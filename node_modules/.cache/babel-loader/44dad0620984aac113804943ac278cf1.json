{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../../../../core/Error.js\";\nimport t from \"../../../../../../core/Logger.js\";\nimport { clamp as i, log2 as o } from \"../../../../../../core/mathUtils.js\";\nimport { unwrap as n, isNone as r } from \"../../../../../../core/maybe.js\";\nimport { pt2px as s } from \"../../../../../../core/screenUtils.js\";\nimport { getAlignmentFromPlacement as a, getXDirection as l, getYDirection as h } from \"../../alignmentUtils.js\";\nimport { premultiplyAlphaRGBAArray as m } from \"../../color.js\";\nimport { TEXT_PLACEMENT_PADDING as c } from \"../../definitions.js\";\nimport { WGLGeometryType as f } from \"../../enums.js\";\nimport { i8888to32 as _ } from \"../../number.js\";\nimport { LabelMaterialKey as p } from \"../../materialKey/MaterialKey.js\";\nimport { isMapAligned as g } from \"./meshUtils.js\";\nimport { smoothPaths as d, pathDivide as u } from \"./segmentUtils.js\";\nimport x from \"./WGLTextTemplate.js\";\n\nconst y = t.getLogger(\"esri.views.2d.engine.webgl.WGLLabelTemplate\"),\n      b = (t, i = \"mapview-labeling\") => y.error(new e(i, t)),\n      L = 1,\n      w = 128,\n      S = 0,\n      P = 16,\n      v = 4;\n\nfunction M(e, t) {\n  const o = !!e.minScale && t.scaleToZoom(e.minScale) || 0;\n  return i(o, 0, 25.5);\n}\n\nfunction Z(e, t) {\n  const o = !!e.maxScale && t.scaleToZoom(e.maxScale) || 255;\n  return i(o, 0, 25.5);\n}\n\nfunction z(e) {\n  const t = new Map();\n  return i => (t.has(i) || t.set(i, e(i)), t.get(i));\n}\n\nconst G = z(e => {\n  let t = 0;\n  if (0 === e) return 1 / 0;\n\n  for (; !(e % 2);) t++, e /= 2;\n\n  return t;\n}),\n      O = e => Math.floor(127 * e + 127),\n      A = e => Math.floor(10 * e),\n      j = e => Math.round(e * (254 / 360));\n\nclass I extends x {\n  constructor(e, t, i, o) {\n    super(e, i.font.size, i.haloSize || 0, i.color && m(i.color) || 0, i.haloColor && m(i.haloColor) || 0, i.horizontalAlignment, i.verticalAlignment, g(t.labelPlacement) ? 1 : 0, i.font.decoration, !1, i.angle || 0, i.xoffset, i.yoffset, i.lineWidth, i.lineHeight, null, null, null, null, null), this._outLineLabelAngle = 0, this._refPlacementPadding = 0, this._refPlacementDirX = 0, this._refPlacementDirY = 0, this._refOffsetX = 0, this._refOffsetY = 0, this._zoomLevel = 0, this.geometryType = f.LABEL;\n    const n = M(t, o),\n          r = Z(t, o),\n          l = t.labelPlacement,\n          [h, _] = a(l);\n    this._xAlignD = h, this._yAlignD = _, this._minZoom = n, this._maxZoom = r, this._refPlacementPadding = s(i.haloSize) + c;\n    const d = p.load(e);\n    d.sdf = !0, this._materialKey = d.data;\n  }\n\n  static fromLabelClass(e, t) {\n    if (\"esriServerLinePlacementCenterAlong\" === e.labelPlacement) {\n      const t = e.symbol;\n      t.xoffset = 0, t.yoffset = 0, t.angle = 0, t.font.decoration = \"none\";\n    }\n\n    return new I(e.materialKey, e, e.symbol, t);\n  }\n\n  get _shapedBox() {\n    return n(this._shapingInfo).bounds;\n  }\n\n  setZoomLevel(e) {\n    this._zoomLevel = e;\n  }\n\n  bindReferenceTemplate(e) {\n    let t = l(this._xAlignD),\n        i = h(this._yAlignD);\n    if (this._refOffsetX = 0, this._refOffsetY = 0, r(e)) return void (this._refSymbolAndPlacementOffset = _(0, 0, O(t), O(i)));\n\n    if (\"circle\" === e.boundsType && (t || i)) {\n      const e = Math.sqrt(t * t + i * i);\n      t /= e, i /= e;\n    }\n\n    const o = Math.max(e.height, e.width),\n          n = this._refPlacementPadding * v;\n    this._refSymbolAndPlacementOffset = _(n, o, O(t), O(i)), this._referenceSize = o, this._refPlacementDirX = t, this._refPlacementDirY = i, this._refOffsetX = e.xOffset, this._refOffsetY = e.yOffset;\n  }\n\n  _write(e, t) {\n    if (r(this._shapingInfo)) return;\n    const i = this._shapingInfo,\n          o = t.getDisplayId(),\n          n = \"esriGeometryPolygon\" === t.geometryType ? t.readLegacyCentroid() : t.readLegacyGeometry();\n    if (n) switch (this.current = {\n      out: e,\n      inId: o,\n      inShaping: i,\n      zoomLevel: this._zoomLevel\n    }, t.geometryType) {\n      case \"esriGeometryPolyline\":\n        this._placeLineLabels(n);\n\n        break;\n\n      case \"esriGeometryPoint\":\n      case \"esriGeometryPolygon\":\n        this._placePointLabels(n);\n\n        break;\n\n      default:\n        b(\"mapview-labeling\", `Geometry of type ${t.geometryType} is not supported`);\n    }\n  }\n\n  _isVisible(e, t) {\n    const i = A(this.current.zoomLevel);\n    return A(e) <= i && i <= A(t);\n  }\n\n  _placePointLabels(e) {\n    const {\n      out: t,\n      inId: i,\n      inShaping: o\n    } = this.current;\n\n    this._writeGlyphs(t, i, e, o);\n  }\n\n  _placeLineLabels(e) {\n    const t = d(e.paths, this.current.inShaping.bounds.width),\n          i = this._placeSubdivGlyphs.bind(this),\n          o = (this._shapedBox.width + w) / (1 << L);\n\n    for (const n of t) u(n, o, i);\n  }\n\n  _placeSubdivGlyphs(e, t, i, n) {\n    const r = G(t),\n          s = this._shapedBox.width / (1 << L),\n          a = P / (1 << L),\n          l = Math.min(i, n - i),\n          h = o(l / (a + s / 2)),\n          m = 0 === t ? h : Math.min(r, h),\n          c = Math.max(this._minZoom, this.current.zoomLevel + L - m),\n          f = this.current.zoomLevel - c,\n          _ = this._shapedBox.width / 2 * 2 ** f;\n\n    this.current.inShaping.isMultiline ? 0 === t && this._placeStraight(e, c) : this._placeCurved(e, c, _);\n  }\n\n  _placeStraight(e, t) {\n    const {\n      out: i,\n      inId: o,\n      inShaping: n\n    } = this.current;\n\n    this._writeGlyphs(i, o, e, n, t);\n  }\n\n  _placeCurved(e, t, i) {\n    const {\n      out: o,\n      inId: n\n    } = this.current;\n    o.metricStart(n, t, e.x, e.y, 0, 0, 0, 0);\n    const r = e.clone(),\n          s = e.angle * (180 / Math.PI) % 360,\n          a = (e.angle * (180 / Math.PI) + 180) % 360;\n    this._outLineLabelAngle = j(s), this._placeFirst(r, t, 1), this._placeBack(e, r, t, i, 1), this._placeForward(e, r, t, i, 1), this._outLineLabelAngle = j(a), this._placeFirst(r, t, 0), this._placeBack(e, r, t, i, 0), this._placeForward(e, r, t, i, 0), o.metricEnd();\n  }\n\n  _placeBack(e, t, i, o, n) {\n    const r = e.clone();\n    let s = e.backwardLength + S;\n\n    for (; r.prev() && !(s >= o);) this._placeOnSegment(r, t, s, i, -1, n), s += r.length + S;\n  }\n\n  _placeForward(e, t, i, o, n) {\n    const r = e.clone();\n    let s = e.remainingLength + S;\n\n    for (; r.next() && !(s >= o);) this._placeOnSegment(r, t, s, i, 1, n), s += r.length + S;\n  }\n\n  _placeFirst(e, t, i) {\n    const n = e,\n          r = this.current.inShaping,\n          s = r.glyphs,\n          a = this.current.zoomLevel,\n          {\n      out: l,\n      inId: h\n    } = this.current;\n\n    for (const m of s) {\n      const s = m.x > r.bounds.x ? i : 1 - i,\n            c = s * e.remainingLength + (1 - s) * e.backwardLength,\n            f = Math.abs(m.x + m.width / 2 - r.bounds.x),\n            _ = Math.max(0, a + o(f / (c + S))),\n            p = Math.max(t, _);\n\n      if (m.maxZoom = 25, m.angle = e.angle + (1 - i) * Math.PI, m.minZoom = p, !(n.x < 0 || n.x >= 512 || n.y < 0 || n.y >= 512) && (this._writeGlyph(l, h, n.x, n.y, m), i && this._isVisible(m.minZoom, m.maxZoom))) {\n        const e = m.bounds;\n        l.metricBoxWrite(e.center[0], e.center[1], e.width, e.height);\n      }\n    }\n  }\n\n  _placeOnSegment(e, t, i, n, r, s) {\n    const a = this.current.inShaping.glyphs,\n          {\n      out: l,\n      inId: h\n    } = this.current,\n          m = this.current.inShaping,\n          c = this.current.zoomLevel,\n          f = e.dx / e.length,\n          _ = e.dy / e.length,\n          p = {\n      x: e.x + i * -r * f,\n      y: e.y + i * -r * _\n    };\n\n    for (const g of a) {\n      const a = g.x > m.bounds.x ? s : 1 - s;\n      if (!(a && 1 === r || !a && -1 === r)) continue;\n\n      const f = Math.abs(g.x + g.width / 2 - m.bounds.x),\n            _ = Math.max(0, c + o(f / i) - .1),\n            d = Math.max(n, c + o(f / (i + e.length + S)));\n\n      if (0 !== _ && (g.angle = e.angle + (1 - s) * Math.PI, g.minZoom = d, g.maxZoom = _, !(p.x < 0 || p.x >= 512 || p.y < 0 || p.y >= 512) && (this._writeGlyph(l, h, p.x, p.y, g), s && this._isVisible(g.minZoom, g.maxZoom)))) {\n        const i = g.bounds,\n              o = e.x - t.x,\n              n = e.y - t.y;\n        l.metricBoxWrite(i.center[0] + o, i.center[1] + n, i.width, i.height);\n      }\n    }\n  }\n\n  _writeGlyphs(e, t, i, o, n = this._minZoom) {\n    if (i.x < 0 || i.x >= 512 || i.y < 0 || i.y >= 512) return;\n    const r = i.x + this._refOffsetX,\n          s = i.y - this._refOffsetY;\n\n    for (const m of o.glyphs) m.minZoom = n, m.maxZoom = this._maxZoom, this._writeGlyph(e, t, r, s, m);\n\n    const a = this._refPlacementDirX,\n          l = this._refPlacementDirY,\n          h = o.boundsT;\n    e.metricStart(t, n, r, s, a, l, this._referenceSize, this._materialKey), e.metricBoxWrite(h.center[0], h.center[1], h.width, h.height), e.metricEnd();\n  }\n\n  _writeVertexCommon(e, t, i, o) {\n    const n = this._color,\n          r = this._haloColor,\n          s = _(0, 0, this._size, this._haloSize),\n          a = Math.max(o.minZoom, this._minZoom),\n          l = Math.min(o.maxZoom, this._maxZoom),\n          h = _(A(a), A(l), this._outLineLabelAngle, 0);\n\n    e.vertexWrite(i), e.vertexWrite(t), e.vertexWrite(n), e.vertexWrite(r), e.vertexWrite(s), e.vertexWrite(this._refSymbolAndPlacementOffset), e.vertexWrite(h);\n  }\n\n}\n\nexport default I;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/2d/engine/webgl/mesh/templates/WGLLabelTemplate.js"],"names":["e","t","clamp","i","log2","o","unwrap","n","isNone","r","pt2px","s","getAlignmentFromPlacement","a","getXDirection","l","getYDirection","h","premultiplyAlphaRGBAArray","m","TEXT_PLACEMENT_PADDING","c","WGLGeometryType","f","i8888to32","_","LabelMaterialKey","p","isMapAligned","g","smoothPaths","d","pathDivide","u","x","y","getLogger","b","error","L","w","S","P","v","M","minScale","scaleToZoom","Z","maxScale","z","Map","has","set","get","G","O","Math","floor","A","j","round","I","constructor","font","size","haloSize","color","haloColor","horizontalAlignment","verticalAlignment","labelPlacement","decoration","angle","xoffset","yoffset","lineWidth","lineHeight","_outLineLabelAngle","_refPlacementPadding","_refPlacementDirX","_refPlacementDirY","_refOffsetX","_refOffsetY","_zoomLevel","geometryType","LABEL","_xAlignD","_yAlignD","_minZoom","_maxZoom","load","sdf","_materialKey","data","fromLabelClass","symbol","materialKey","_shapedBox","_shapingInfo","bounds","setZoomLevel","bindReferenceTemplate","_refSymbolAndPlacementOffset","boundsType","sqrt","max","height","width","_referenceSize","xOffset","yOffset","_write","getDisplayId","readLegacyCentroid","readLegacyGeometry","current","out","inId","inShaping","zoomLevel","_placeLineLabels","_placePointLabels","_isVisible","_writeGlyphs","paths","_placeSubdivGlyphs","bind","min","isMultiline","_placeStraight","_placeCurved","metricStart","clone","PI","_placeFirst","_placeBack","_placeForward","metricEnd","backwardLength","prev","_placeOnSegment","length","remainingLength","next","glyphs","abs","maxZoom","minZoom","_writeGlyph","metricBoxWrite","center","dx","dy","boundsT","_writeVertexCommon","_color","_haloColor","_size","_haloSize","vertexWrite"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../../../../core/Error.js\";import t from\"../../../../../../core/Logger.js\";import{clamp as i,log2 as o}from\"../../../../../../core/mathUtils.js\";import{unwrap as n,isNone as r}from\"../../../../../../core/maybe.js\";import{pt2px as s}from\"../../../../../../core/screenUtils.js\";import{getAlignmentFromPlacement as a,getXDirection as l,getYDirection as h}from\"../../alignmentUtils.js\";import{premultiplyAlphaRGBAArray as m}from\"../../color.js\";import{TEXT_PLACEMENT_PADDING as c}from\"../../definitions.js\";import{WGLGeometryType as f}from\"../../enums.js\";import{i8888to32 as _}from\"../../number.js\";import{LabelMaterialKey as p}from\"../../materialKey/MaterialKey.js\";import{isMapAligned as g}from\"./meshUtils.js\";import{smoothPaths as d,pathDivide as u}from\"./segmentUtils.js\";import x from\"./WGLTextTemplate.js\";const y=t.getLogger(\"esri.views.2d.engine.webgl.WGLLabelTemplate\"),b=(t,i=\"mapview-labeling\")=>y.error(new e(i,t)),L=1,w=128,S=0,P=16,v=4;function M(e,t){const o=!!e.minScale&&t.scaleToZoom(e.minScale)||0;return i(o,0,25.5)}function Z(e,t){const o=!!e.maxScale&&t.scaleToZoom(e.maxScale)||255;return i(o,0,25.5)}function z(e){const t=new Map;return i=>(t.has(i)||t.set(i,e(i)),t.get(i))}const G=z((e=>{let t=0;if(0===e)return 1/0;for(;!(e%2);)t++,e/=2;return t})),O=e=>Math.floor(127*e+127),A=e=>Math.floor(10*e),j=e=>Math.round(e*(254/360));class I extends x{constructor(e,t,i,o){super(e,i.font.size,i.haloSize||0,i.color&&m(i.color)||0,i.haloColor&&m(i.haloColor)||0,i.horizontalAlignment,i.verticalAlignment,g(t.labelPlacement)?1:0,i.font.decoration,!1,i.angle||0,i.xoffset,i.yoffset,i.lineWidth,i.lineHeight,null,null,null,null,null),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this._zoomLevel=0,this.geometryType=f.LABEL;const n=M(t,o),r=Z(t,o),l=t.labelPlacement,[h,_]=a(l);this._xAlignD=h,this._yAlignD=_,this._minZoom=n,this._maxZoom=r,this._refPlacementPadding=s(i.haloSize)+c;const d=p.load(e);d.sdf=!0,this._materialKey=d.data}static fromLabelClass(e,t){if(\"esriServerLinePlacementCenterAlong\"===e.labelPlacement){const t=e.symbol;t.xoffset=0,t.yoffset=0,t.angle=0,t.font.decoration=\"none\"}return new I(e.materialKey,e,e.symbol,t)}get _shapedBox(){return n(this._shapingInfo).bounds}setZoomLevel(e){this._zoomLevel=e}bindReferenceTemplate(e){let t=l(this._xAlignD),i=h(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,r(e))return void(this._refSymbolAndPlacementOffset=_(0,0,O(t),O(i)));if(\"circle\"===e.boundsType&&(t||i)){const e=Math.sqrt(t*t+i*i);t/=e,i/=e}const o=Math.max(e.height,e.width),n=this._refPlacementPadding*v;this._refSymbolAndPlacementOffset=_(n,o,O(t),O(i)),this._referenceSize=o,this._refPlacementDirX=t,this._refPlacementDirY=i,this._refOffsetX=e.xOffset,this._refOffsetY=e.yOffset}_write(e,t){if(r(this._shapingInfo))return;const i=this._shapingInfo,o=t.getDisplayId(),n=\"esriGeometryPolygon\"===t.geometryType?t.readLegacyCentroid():t.readLegacyGeometry();if(n)switch(this.current={out:e,inId:o,inShaping:i,zoomLevel:this._zoomLevel},t.geometryType){case\"esriGeometryPolyline\":this._placeLineLabels(n);break;case\"esriGeometryPoint\":case\"esriGeometryPolygon\":this._placePointLabels(n);break;default:b(\"mapview-labeling\",`Geometry of type ${t.geometryType} is not supported`)}}_isVisible(e,t){const i=A(this.current.zoomLevel);return A(e)<=i&&i<=A(t)}_placePointLabels(e){const{out:t,inId:i,inShaping:o}=this.current;this._writeGlyphs(t,i,e,o)}_placeLineLabels(e){const t=d(e.paths,this.current.inShaping.bounds.width),i=this._placeSubdivGlyphs.bind(this),o=(this._shapedBox.width+w)/(1<<L);for(const n of t)u(n,o,i)}_placeSubdivGlyphs(e,t,i,n){const r=G(t),s=this._shapedBox.width/(1<<L),a=P/(1<<L),l=Math.min(i,n-i),h=o(l/(a+s/2)),m=0===t?h:Math.min(r,h),c=Math.max(this._minZoom,this.current.zoomLevel+L-m),f=this.current.zoomLevel-c,_=this._shapedBox.width/2*2**f;this.current.inShaping.isMultiline?0===t&&this._placeStraight(e,c):this._placeCurved(e,c,_)}_placeStraight(e,t){const{out:i,inId:o,inShaping:n}=this.current;this._writeGlyphs(i,o,e,n,t)}_placeCurved(e,t,i){const{out:o,inId:n}=this.current;o.metricStart(n,t,e.x,e.y,0,0,0,0);const r=e.clone(),s=e.angle*(180/Math.PI)%360,a=(e.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=j(s),this._placeFirst(r,t,1),this._placeBack(e,r,t,i,1),this._placeForward(e,r,t,i,1),this._outLineLabelAngle=j(a),this._placeFirst(r,t,0),this._placeBack(e,r,t,i,0),this._placeForward(e,r,t,i,0),o.metricEnd()}_placeBack(e,t,i,o,n){const r=e.clone();let s=e.backwardLength+S;for(;r.prev()&&!(s>=o);)this._placeOnSegment(r,t,s,i,-1,n),s+=r.length+S}_placeForward(e,t,i,o,n){const r=e.clone();let s=e.remainingLength+S;for(;r.next()&&!(s>=o);)this._placeOnSegment(r,t,s,i,1,n),s+=r.length+S}_placeFirst(e,t,i){const n=e,r=this.current.inShaping,s=r.glyphs,a=this.current.zoomLevel,{out:l,inId:h}=this.current;for(const m of s){const s=m.x>r.bounds.x?i:1-i,c=s*e.remainingLength+(1-s)*e.backwardLength,f=Math.abs(m.x+m.width/2-r.bounds.x),_=Math.max(0,a+o(f/(c+S))),p=Math.max(t,_);if(m.maxZoom=25,m.angle=e.angle+(1-i)*Math.PI,m.minZoom=p,!(n.x<0||n.x>=512||n.y<0||n.y>=512)&&(this._writeGlyph(l,h,n.x,n.y,m),i&&this._isVisible(m.minZoom,m.maxZoom))){const e=m.bounds;l.metricBoxWrite(e.center[0],e.center[1],e.width,e.height)}}}_placeOnSegment(e,t,i,n,r,s){const a=this.current.inShaping.glyphs,{out:l,inId:h}=this.current,m=this.current.inShaping,c=this.current.zoomLevel,f=e.dx/e.length,_=e.dy/e.length,p={x:e.x+i*-r*f,y:e.y+i*-r*_};for(const g of a){const a=g.x>m.bounds.x?s:1-s;if(!(a&&1===r||!a&&-1===r))continue;const f=Math.abs(g.x+g.width/2-m.bounds.x),_=Math.max(0,c+o(f/i)-.1),d=Math.max(n,c+o(f/(i+e.length+S)));if(0!==_&&(g.angle=e.angle+(1-s)*Math.PI,g.minZoom=d,g.maxZoom=_,!(p.x<0||p.x>=512||p.y<0||p.y>=512)&&(this._writeGlyph(l,h,p.x,p.y,g),s&&this._isVisible(g.minZoom,g.maxZoom)))){const i=g.bounds,o=e.x-t.x,n=e.y-t.y;l.metricBoxWrite(i.center[0]+o,i.center[1]+n,i.width,i.height)}}}_writeGlyphs(e,t,i,o,n=this._minZoom){if(i.x<0||i.x>=512||i.y<0||i.y>=512)return;const r=i.x+this._refOffsetX,s=i.y-this._refOffsetY;for(const m of o.glyphs)m.minZoom=n,m.maxZoom=this._maxZoom,this._writeGlyph(e,t,r,s,m);const a=this._refPlacementDirX,l=this._refPlacementDirY,h=o.boundsT;e.metricStart(t,n,r,s,a,l,this._referenceSize,this._materialKey),e.metricBoxWrite(h.center[0],h.center[1],h.width,h.height),e.metricEnd()}_writeVertexCommon(e,t,i,o){const n=this._color,r=this._haloColor,s=_(0,0,this._size,this._haloSize),a=Math.max(o.minZoom,this._minZoom),l=Math.min(o.maxZoom,this._maxZoom),h=_(A(a),A(l),this._outLineLabelAngle,0);e.vertexWrite(i),e.vertexWrite(t),e.vertexWrite(n),e.vertexWrite(r),e.vertexWrite(s),e.vertexWrite(this._refSymbolAndPlacementOffset),e.vertexWrite(h)}}export default I;\n"]},"metadata":{},"sourceType":"module"}