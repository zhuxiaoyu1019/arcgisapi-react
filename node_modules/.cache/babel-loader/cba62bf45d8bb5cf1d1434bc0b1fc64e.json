{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../../../core/Error.js\";\nimport t from \"../../../../../core/Logger.js\";\nimport { isSome as r } from \"../../../../../core/maybe.js\";\nimport { isAbortError as a, throwIfAborted as s, throwIfNotAbortError as o } from \"../../../../../core/promiseUtils.js\";\nimport { BaseFeatureSource as i } from \"./BaseFeatureSource.js\";\nconst n = t.getLogger(\"esri.views.2d.layers.features.sources.FeatureSource\");\n\nclass d extends i {\n  constructor(e) {\n    super(e);\n  }\n\n  async _fetchDataTile(t) {\n    const r = 6,\n          o = 20,\n          i = this._subscriptions.get(t.key.id);\n\n    let d = !1,\n        c = 0,\n        u = 0;\n\n    const p = (e, r) => {\n      u--, s(i);\n      const a = t.id,\n            o = e.reader,\n            n = e.query;\n\n      if (!o.exceededTransferLimit) {\n        if (d = !0, 0 !== r && !o.hasFeatures) {\n          const e = {\n            id: a,\n            addOrUpdate: o,\n            end: 0 === u,\n            type: \"append\"\n          };\n          return i.add({\n            message: e,\n            query: n\n          }), void this._onMessage(e);\n        }\n\n        const e = {\n          id: a,\n          addOrUpdate: o,\n          end: 0 === u,\n          type: \"append\"\n        };\n        return i.add({\n          message: e,\n          query: n\n        }), void this._onMessage(e);\n      }\n\n      const c = {\n        id: a,\n        addOrUpdate: o,\n        end: d && 0 === u,\n        type: \"append\"\n      };\n      i.add({\n        message: c,\n        query: n\n      }), this._onMessage(c);\n    };\n\n    let h = 0,\n        m = 0;\n\n    for (; !d && m++ < o;) {\n      let o;\n\n      for (let r = 0; r < h + 1; r++) {\n        const r = c++;\n        u++, o = this._fetchDataTilePage(t, r, i).then(e => e && p(e, r)).catch(r => {\n          d = !0, a(r) || (n.error(new e(\"mapview-query-error\", \"Encountered error when fetching tile\", {\n            tile: t,\n            error: r\n          })), this._onMessage({\n            id: t.id,\n            addOrUpdate: null,\n            end: d,\n            type: \"append\"\n          }));\n        });\n      }\n\n      await o, s(i), h = Math.min(h + 2, r);\n    }\n  }\n\n  async _fetchDataTilePage(e, t, a) {\n    const i = this._queryInfo,\n          n = {\n      start: this.pageSize * t,\n      num: this.pageSize,\n      returnExceededLimitFeatures: !0,\n      quantizationParameters: e.getQuantizationParameters()\n    };\n    r(this.maxRecordCountFactor) && (n.maxRecordCountFactor = this.maxRecordCountFactor);\n\n    const d = this._createQuery(e, n);\n\n    try {\n      const r = a.signal,\n            o = await this._queue.push({\n        tile: e,\n        query: d,\n        signal: r,\n        depth: t\n      });\n      return s(a), o ? i !== this._queryInfo ? this._fetchDataTilePage(e, t, a) : {\n        reader: o,\n        query: d\n      } : null;\n    } catch (c) {\n      return o(c), null;\n    }\n  }\n\n}\n\nexport { d as PagedFeatureSource };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/2d/layers/features/sources/PagedFeatureSource.js"],"names":["e","t","isSome","r","isAbortError","a","throwIfAborted","s","throwIfNotAbortError","o","BaseFeatureSource","i","n","getLogger","d","constructor","_fetchDataTile","_subscriptions","get","key","id","c","u","p","reader","query","exceededTransferLimit","hasFeatures","addOrUpdate","end","type","add","message","_onMessage","h","m","_fetchDataTilePage","then","catch","error","tile","Math","min","_queryInfo","start","pageSize","num","returnExceededLimitFeatures","quantizationParameters","getQuantizationParameters","maxRecordCountFactor","_createQuery","signal","_queue","push","depth","PagedFeatureSource"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../../../core/Error.js\";import t from\"../../../../../core/Logger.js\";import{isSome as r}from\"../../../../../core/maybe.js\";import{isAbortError as a,throwIfAborted as s,throwIfNotAbortError as o}from\"../../../../../core/promiseUtils.js\";import{BaseFeatureSource as i}from\"./BaseFeatureSource.js\";const n=t.getLogger(\"esri.views.2d.layers.features.sources.FeatureSource\");class d extends i{constructor(e){super(e)}async _fetchDataTile(t){const r=6,o=20,i=this._subscriptions.get(t.key.id);let d=!1,c=0,u=0;const p=(e,r)=>{u--,s(i);const a=t.id,o=e.reader,n=e.query;if(!o.exceededTransferLimit){if(d=!0,0!==r&&!o.hasFeatures){const e={id:a,addOrUpdate:o,end:0===u,type:\"append\"};return i.add({message:e,query:n}),void this._onMessage(e)}const e={id:a,addOrUpdate:o,end:0===u,type:\"append\"};return i.add({message:e,query:n}),void this._onMessage(e)}const c={id:a,addOrUpdate:o,end:d&&0===u,type:\"append\"};i.add({message:c,query:n}),this._onMessage(c)};let h=0,m=0;for(;!d&&m++<o;){let o;for(let r=0;r<h+1;r++){const r=c++;u++,o=this._fetchDataTilePage(t,r,i).then((e=>e&&p(e,r))).catch((r=>{d=!0,a(r)||(n.error(new e(\"mapview-query-error\",\"Encountered error when fetching tile\",{tile:t,error:r})),this._onMessage({id:t.id,addOrUpdate:null,end:d,type:\"append\"}))}))}await o,s(i),h=Math.min(h+2,r)}}async _fetchDataTilePage(e,t,a){const i=this._queryInfo,n={start:this.pageSize*t,num:this.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:e.getQuantizationParameters()};r(this.maxRecordCountFactor)&&(n.maxRecordCountFactor=this.maxRecordCountFactor);const d=this._createQuery(e,n);try{const r=a.signal,o=await this._queue.push({tile:e,query:d,signal:r,depth:t});return s(a),o?i!==this._queryInfo?this._fetchDataTilePage(e,t,a):{reader:o,query:d}:null}catch(c){return o(c),null}}}export{d as PagedFeatureSource};\n"]},"metadata":{},"sourceType":"module"}