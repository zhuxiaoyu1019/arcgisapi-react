{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { someMap as e } from \"../../../../../core/MapUtils.js\";\nimport { isNone as t, isSome as s } from \"../../../../../core/maybe.js\";\nimport { m as a, a as i, e as r } from \"../../../../../chunks/mat4.js\";\nimport { c as n } from \"../../../../../chunks/mat4f64.js\";\nimport { glLayout as o } from \"../../../support/buffer/glUtil.js\";\nimport { ResizableFloat32Array as d } from \"../../lib/ResizableFloat32Array.js\";\nimport { assert as l, setMatrixTranslation3 as h } from \"../../lib/Util.js\";\nimport { WaterGLMaterial as m } from \"../WaterGLMaterial.js\";\nimport { Instance as c, sortInstancesAccordingToRange as u, addOrMerge as g } from \"./Instance.js\";\nimport { acquireMaterials as f, releaseMaterials as p, calculateTransformRelativeToOrigin as w } from \"./utils.js\";\nimport { addToRenderStats as b } from \"../../statistics/RendererPerformanceInfo.js\";\nimport C from \"../../../../webgl/BufferObject.js\";\nimport { getStride as y } from \"../../../../webgl/Util.js\";\nimport _ from \"../../../../webgl/VertexArrayObject.js\";\n\nclass v {\n  constructor(e, t, s) {\n    this.type = \"MergedRenderer\", this._dataByOrigin = new Map(), this._hasHighlights = !1, this._hasOccludees = !1, this._rctx = e, this._material = s, this._materialRep = t, this._glMaterials = f(this._material, this._materialRep), this._bufferWriter = s.createBufferWriter();\n  }\n\n  dispose() {\n    p(this._material, this._materialRep), this._dataByOrigin && (this._dataByOrigin.forEach(e => {\n      e.vao.dispose(!0), e.vao = null;\n    }), this._dataByOrigin.clear(), this._dataByOrigin = null), this._glMaterials && (this._glMaterials.forEach(e => {\n      e && e.dispose();\n    }), this._glMaterials.clear(), this._glMaterials = null);\n  }\n\n  get isEmpty() {\n    return 0 === this._dataByOrigin.size;\n  }\n\n  get hasHighlights() {\n    return this._hasHighlights;\n  }\n\n  get hasOccludees() {\n    return this._hasOccludees;\n  }\n\n  get hasWater() {\n    return !this.isEmpty && e(this._glMaterials, e => e instanceof m);\n  }\n\n  get rendersOccluded() {\n    return !this.isEmpty && 1 !== this._material.renderOccluded;\n  }\n\n  modify(e) {\n    this.updateGeometries(e.updates), this.addAndRemoveGeometries(e.adds, e.removes), this.updateRenderCommands();\n  }\n\n  addAndRemoveGeometries(e, t) {\n    const s = this._bufferWriter,\n          a = s.vertexBufferLayout,\n          i = a.stride / 4,\n          r = this._dataByOrigin,\n          n = H(r, s, e, t);\n    n.forEach((e, t) => {\n      n.delete(t);\n      const s = e.optimalCount,\n            o = e.sparseCount;\n      let d = r.get(t);\n      if (null == d) l(s > 0), d = this.createData(a, s, e.origin), r.set(t, d);else if (0 === s) return d.vao.dispose(!0), d.vao = null, void r.delete(t);\n      const m = s < e.sparseCount / 2,\n            c = m ? s : o,\n            u = R,\n            g = d.buffer.size,\n            f = d.buffer.array,\n            p = d.buffer.resize(c, !1);\n      m || p ? this.removeAndRebuild(d, e.toRemove, i, f, u) : e.toRemove.length > 0 ? (this.removeByErasing(d, e.toRemove, i, u), e.toAdd.length > 0 && (u.end = g)) : (u.begin = g, u.end = g);\n      const w = B;\n      h(w, -e.origin[0], -e.origin[1], -e.origin[2]), this.append(d, e.toAdd, i, w, u);\n      const b = d.vao.vertexBuffers.geometry;\n      if (b.byteSize !== d.buffer.array.buffer.byteLength) b.setData(d.buffer.array);else {\n        const {\n          begin: e,\n          end: t\n        } = u;\n\n        if (e < t) {\n          const s = d.buffer.array,\n                a = 4,\n                i = e * a,\n                r = t * a;\n          b.setSubData(s, i, i, r);\n        }\n      }\n      d.drawCommandsDirty = !0;\n    });\n  }\n\n  updateGeometries(e) {\n    const t = this._bufferWriter,\n          s = t.vertexBufferLayout.stride / 4;\n\n    for (const a of e) {\n      const e = a.updateType,\n            i = a.renderGeometry,\n            r = this._dataByOrigin.get(i.origin.id),\n            n = r && r.instances.get(i.id);\n\n      if (!n) return;\n\n      if (1 & e && (n.isVisible = i.instanceParameters.visible), 9 & e) {\n        const e = i.instanceParameters.visible;\n        n.hasHighlights = !!i.instanceParameters.highlights && e;\n      }\n\n      if (16 & e && (n.hasOccludees = !!i.instanceParameters.occludees), 6 & e) {\n        const e = r.buffer.array,\n              a = r.vao;\n        w(i, D, j), t.write({\n          transformation: D,\n          invTranspTransformation: j\n        }, i.data, t.vertexBufferLayout.createView(e.buffer), n.from), l(n.from + t.elementCount(i.data) === n.to, \"material VBO layout has changed\"), a.vertexBuffers.geometry.setSubData(e, n.from * s * 4, n.from * s * 4, n.to * s * 4);\n      }\n\n      r.drawCommandsDirty = !0;\n    }\n  }\n\n  updateRenderCommands() {\n    this._hasHighlights = !1, this._hasOccludees = !1, this._dataByOrigin.forEach(t => {\n      t.hasHiddenInstances = !1, t.hasHighlights = !1, t.hasOccludees = !1, e(t.instances, e => (e.isVisible ? (e.hasHighlights && (this._hasHighlights = !0, t.hasHighlights = !0), e.hasOccludees && (this._hasOccludees = !0, t.hasOccludees = !0)) : t.hasHiddenInstances = !0, t.hasHiddenInstances && t.hasHighlights && t.hasOccludees));\n    });\n\n    const t = e => {\n      if (e.drawCommandsDefault = null, e.drawCommandsHighlight = null, e.drawCommandsOccludees = null, e.drawCommandsShadowHighlightRest = null, e.stats = {\n        default: 0,\n        highlight: 0,\n        occludees: 0,\n        shadowHighlightRest: 0\n      }, 0 === e.instances.size) return;\n\n      if (!O(e)) {\n        const t = 4 * e.buffer.size / y(e.vao.layout.geometry);\n        return e.drawCommandsDefault = [{\n          first: 0,\n          count: t\n        }], void (e.stats = {\n          default: t,\n          highlight: 0,\n          occludees: 0,\n          shadowHighlightRest: 0\n        });\n      }\n\n      const t = u([...e.instances.values()]);\n      e.drawCommandsDefault = [], e.drawCommandsHighlight = [], e.drawCommandsOccludees = [], e.drawCommandsShadowHighlightRest = [];\n\n      for (const a of t) a.isVisible && (a.hasOccludees ? g(e.drawCommandsOccludees, a) : g(e.drawCommandsDefault, a), a.hasHighlights ? g(e.drawCommandsHighlight, a) : g(e.drawCommandsShadowHighlightRest, a));\n\n      const s = e => {\n        let t = 0;\n\n        for (const s of e) t += s.count;\n\n        return t / 3;\n      };\n\n      e.stats = {\n        default: s(e.drawCommandsDefault),\n        highlight: s(e.drawCommandsHighlight),\n        occludees: s(e.drawCommandsOccludees),\n        shadowHighlightRest: s(e.drawCommandsShadowHighlightRest)\n      };\n    };\n\n    this._dataByOrigin.forEach(e => {\n      e.drawCommandsDirty && (t(e), e.drawCommandsDirty = !1);\n    });\n  }\n\n  updateLogic(e) {\n    return this._material.update(e);\n  }\n\n  render(e, a, i, r) {\n    const n = this._rctx,\n          o = this._glMaterials.get(a),\n          d = 5 === a || 7 === a,\n          l = 6 === a,\n          h = !(d || l);\n\n    if (3 === a && null === e && (e = 22), !o || 2 !== o.ensureResources(n) || null != e && !o.beginSlot(e) || d && !this._hasHighlights) return !1;\n    o.ensureParameters(i);\n    const m = o.getPipelineState(e, !1);\n    n.setPipelineState(m);\n    const c = o.technique;\n    n.useProgram(c.program), o.bind(i);\n    let u = !1;\n    return this._dataByOrigin.forEach(a => {\n      if (t(a.drawCommandsDefault) && t(a.drawCommandsHighlight) && t(a.drawCommandsOccludees) && t(a.drawCommandsShadowHighlightRest)) return;\n      if (d && !a.hasHighlights) return;\n      i.origin = a.origin, c.bindDraw(i, {}, {}), c.ensureAttributeLocations(a.vao), n.bindVAO(a.vao);\n      const g = c.primitiveType,\n            f = d ? a.drawCommandsHighlight : l && O(a) ? a.drawCommandsShadowHighlightRest : a.drawCommandsDefault;\n\n      if (s(f)) {\n        this.renderCommands(n, g, f);\n        const e = d ? a.stats.highlight : l && O(a) ? a.stats.shadowHighlightRest : a.stats.default;\n        b(f.length, e, r), u = !0;\n      }\n\n      if (h) {\n        const t = a.drawCommandsOccludees;\n\n        if (s(t)) {\n          const s = o.getPipelineState(e, !0);\n          n.setPipelineState(s), this.renderCommands(n, g, t), n.setPipelineState(m), b(t.length, a.stats.occludees, r), u = !0;\n        }\n      }\n    }), u;\n  }\n\n  renderCommands(e, t, s) {\n    for (let a = 0; a < s.length; a++) e.drawArrays(t, s[a].first, s[a].count);\n  }\n\n  createData(e, t, s) {\n    return {\n      instances: new Map(),\n      vao: new _(this._rctx, this._material.vertexAttributeLocations, {\n        geometry: o(e)\n      }, {\n        geometry: C.createVertex(this._rctx, 35044)\n      }),\n      buffer: new d(t),\n      optimalCount: 0,\n      origin: s,\n      hasHiddenInstances: !1,\n      hasHighlights: !1,\n      hasOccludees: !1,\n      drawCommandsDirty: !1,\n      drawCommandsDefault: null,\n      drawCommandsOccludees: null,\n      drawCommandsHighlight: null,\n      drawCommandsShadowHighlightRest: null,\n      stats: {\n        default: 0,\n        highlight: 0,\n        occludees: 0,\n        shadowHighlightRest: 0\n      }\n    };\n  }\n\n  removeAndRebuild(e, t, s, a, i) {\n    for (const h of t) {\n      const t = h.id,\n            a = e.instances.get(t);\n      e.optimalCount -= (a.to - a.from) * s, e.instances.delete(t);\n    }\n\n    let r = 0;\n    const n = e.buffer.array;\n    i.begin = 0, i.end = 0;\n    let o = -1,\n        d = -1,\n        l = 0;\n    e.instances.forEach(e => {\n      const t = e.from * s,\n            i = e.to * s,\n            h = i - t;\n      o !== d && d !== t ? (n.set(a.subarray(o, d), l), l += d - o, o = t) : -1 === o && (o = t), d = i, e.from = r / s, r += h, e.to = r / s;\n    }), o !== d && n.set(a.subarray(o, d), l), i.end = r;\n  }\n\n  removeByErasing(e, t, s, a) {\n    a.begin = 1 / 0, a.end = -1 / 0;\n    let i = -1,\n        r = -1;\n\n    for (const n of t) {\n      const t = n.id,\n            o = e.instances.get(t),\n            d = o.from * s,\n            l = o.to * s;\n      i !== r && r !== d ? (e.buffer.erase(i, r), i = d) : -1 === i && (i = d), r = l, e.instances.delete(t), e.optimalCount -= l - d, d < a.begin && (a.begin = d), l > a.end && (a.end = l);\n    }\n\n    i !== r && e.buffer.erase(i, r);\n  }\n\n  append(e, t, n, o, d) {\n    const h = this._bufferWriter;\n\n    for (const m of t) {\n      const t = s(m.transformation) ? a(D, o, m.transformation) : o;\n      i(j, t), r(j, j);\n      const u = d.end;\n      h.write({\n        transformation: t,\n        invTranspTransformation: j\n      }, m.data, h.vertexBufferLayout.createView(e.buffer.array.buffer), d.end / n);\n      const g = h.elementCount(m.data) * n,\n            f = u + g;\n      l(null == e.instances.get(m.id));\n      const p = m.instanceParameters.visible,\n            w = !!m.instanceParameters.highlights && p,\n            b = !!m.instanceParameters.occludees,\n            C = new c(u / n, f / n, p, w, b);\n      e.instances.set(m.id, C), e.optimalCount += g, d.end += g;\n    }\n  }\n\n  get test() {\n    return {\n      material: this._material,\n      glMaterials: this._glMaterials\n    };\n  }\n\n}\n\nfunction H(e, s, a, i) {\n  const r = new Map(),\n        n = s.vertexBufferLayout.stride / 4,\n        o = (a, i) => {\n    const o = a.origin;\n    if (t(o)) return;\n    const d = e.get(o.id);\n    let l = r.get(o.id);\n    null == l && (l = {\n      optimalCount: null == d ? 0 : d.optimalCount,\n      sparseCount: null == d ? 0 : d.buffer.size,\n      toAdd: [],\n      toRemove: [],\n      origin: o.vec3\n    }, r.set(o.id, l));\n    const h = s.elementCount(a.data) * n;\n    i ? (l.optimalCount += h, l.sparseCount += h, l.toAdd.push(a)) : (l.optimalCount -= h, l.toRemove.push(a));\n  };\n\n  for (const t of a) o(t, !0);\n\n  for (const t of i) o(t, !1);\n\n  return r;\n}\n\nfunction O(e) {\n  return e.hasOccludees || e.hasHighlights || e.hasHiddenInstances;\n}\n\nconst R = {\n  begin: 0,\n  end: 0\n},\n      B = n(),\n      D = n(),\n      j = n();\nexport default v;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/webgl-engine/materials/renderers/MergedRenderer.js"],"names":["someMap","e","isNone","t","isSome","s","m","a","i","r","c","n","glLayout","o","ResizableFloat32Array","d","assert","l","setMatrixTranslation3","h","WaterGLMaterial","Instance","sortInstancesAccordingToRange","u","addOrMerge","g","acquireMaterials","f","releaseMaterials","p","calculateTransformRelativeToOrigin","w","addToRenderStats","b","C","getStride","y","_","v","constructor","type","_dataByOrigin","Map","_hasHighlights","_hasOccludees","_rctx","_material","_materialRep","_glMaterials","_bufferWriter","createBufferWriter","dispose","forEach","vao","clear","isEmpty","size","hasHighlights","hasOccludees","hasWater","rendersOccluded","renderOccluded","modify","updateGeometries","updates","addAndRemoveGeometries","adds","removes","updateRenderCommands","vertexBufferLayout","stride","H","delete","optimalCount","sparseCount","get","createData","origin","set","R","buffer","array","resize","removeAndRebuild","toRemove","length","removeByErasing","toAdd","end","begin","B","append","vertexBuffers","geometry","byteSize","byteLength","setData","setSubData","drawCommandsDirty","updateType","renderGeometry","id","instances","isVisible","instanceParameters","visible","highlights","occludees","D","j","write","transformation","invTranspTransformation","data","createView","from","elementCount","to","hasHiddenInstances","drawCommandsDefault","drawCommandsHighlight","drawCommandsOccludees","drawCommandsShadowHighlightRest","stats","default","highlight","shadowHighlightRest","O","layout","first","count","values","updateLogic","update","render","ensureResources","beginSlot","ensureParameters","getPipelineState","setPipelineState","technique","useProgram","program","bind","bindDraw","ensureAttributeLocations","bindVAO","primitiveType","renderCommands","drawArrays","vertexAttributeLocations","createVertex","subarray","erase","test","material","glMaterials","vec3","push"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{someMap as e}from\"../../../../../core/MapUtils.js\";import{isNone as t,isSome as s}from\"../../../../../core/maybe.js\";import{m as a,a as i,e as r}from\"../../../../../chunks/mat4.js\";import{c as n}from\"../../../../../chunks/mat4f64.js\";import{glLayout as o}from\"../../../support/buffer/glUtil.js\";import{ResizableFloat32Array as d}from\"../../lib/ResizableFloat32Array.js\";import{assert as l,setMatrixTranslation3 as h}from\"../../lib/Util.js\";import{WaterGLMaterial as m}from\"../WaterGLMaterial.js\";import{Instance as c,sortInstancesAccordingToRange as u,addOrMerge as g}from\"./Instance.js\";import{acquireMaterials as f,releaseMaterials as p,calculateTransformRelativeToOrigin as w}from\"./utils.js\";import{addToRenderStats as b}from\"../../statistics/RendererPerformanceInfo.js\";import C from\"../../../../webgl/BufferObject.js\";import{getStride as y}from\"../../../../webgl/Util.js\";import _ from\"../../../../webgl/VertexArrayObject.js\";class v{constructor(e,t,s){this.type=\"MergedRenderer\",this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._rctx=e,this._material=s,this._materialRep=t,this._glMaterials=f(this._material,this._materialRep),this._bufferWriter=s.createBufferWriter()}dispose(){p(this._material,this._materialRep),this._dataByOrigin&&(this._dataByOrigin.forEach((e=>{e.vao.dispose(!0),e.vao=null})),this._dataByOrigin.clear(),this._dataByOrigin=null),this._glMaterials&&(this._glMaterials.forEach((e=>{e&&e.dispose()})),this._glMaterials.clear(),this._glMaterials=null)}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&e(this._glMaterials,(e=>e instanceof m))}get rendersOccluded(){return!this.isEmpty&&1!==this._material.renderOccluded}modify(e){this.updateGeometries(e.updates),this.addAndRemoveGeometries(e.adds,e.removes),this.updateRenderCommands()}addAndRemoveGeometries(e,t){const s=this._bufferWriter,a=s.vertexBufferLayout,i=a.stride/4,r=this._dataByOrigin,n=H(r,s,e,t);n.forEach(((e,t)=>{n.delete(t);const s=e.optimalCount,o=e.sparseCount;let d=r.get(t);if(null==d)l(s>0),d=this.createData(a,s,e.origin),r.set(t,d);else if(0===s)return d.vao.dispose(!0),d.vao=null,void r.delete(t);const m=s<e.sparseCount/2,c=m?s:o,u=R,g=d.buffer.size,f=d.buffer.array,p=d.buffer.resize(c,!1);m||p?this.removeAndRebuild(d,e.toRemove,i,f,u):e.toRemove.length>0?(this.removeByErasing(d,e.toRemove,i,u),e.toAdd.length>0&&(u.end=g)):(u.begin=g,u.end=g);const w=B;h(w,-e.origin[0],-e.origin[1],-e.origin[2]),this.append(d,e.toAdd,i,w,u);const b=d.vao.vertexBuffers.geometry;if(b.byteSize!==d.buffer.array.buffer.byteLength)b.setData(d.buffer.array);else{const{begin:e,end:t}=u;if(e<t){const s=d.buffer.array,a=4,i=e*a,r=t*a;b.setSubData(s,i,i,r)}}d.drawCommandsDirty=!0}))}updateGeometries(e){const t=this._bufferWriter,s=t.vertexBufferLayout.stride/4;for(const a of e){const e=a.updateType,i=a.renderGeometry,r=this._dataByOrigin.get(i.origin.id),n=r&&r.instances.get(i.id);if(!n)return;if(1&e&&(n.isVisible=i.instanceParameters.visible),9&e){const e=i.instanceParameters.visible;n.hasHighlights=!!i.instanceParameters.highlights&&e}if(16&e&&(n.hasOccludees=!!i.instanceParameters.occludees),6&e){const e=r.buffer.array,a=r.vao;w(i,D,j),t.write({transformation:D,invTranspTransformation:j},i.data,t.vertexBufferLayout.createView(e.buffer),n.from),l(n.from+t.elementCount(i.data)===n.to,\"material VBO layout has changed\"),a.vertexBuffers.geometry.setSubData(e,n.from*s*4,n.from*s*4,n.to*s*4)}r.drawCommandsDirty=!0}}updateRenderCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((t=>{t.hasHiddenInstances=!1,t.hasHighlights=!1,t.hasOccludees=!1,e(t.instances,(e=>(e.isVisible?(e.hasHighlights&&(this._hasHighlights=!0,t.hasHighlights=!0),e.hasOccludees&&(this._hasOccludees=!0,t.hasOccludees=!0)):t.hasHiddenInstances=!0,t.hasHiddenInstances&&t.hasHighlights&&t.hasOccludees)))}));const t=e=>{if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.drawCommandsShadowHighlightRest=null,e.stats={default:0,highlight:0,occludees:0,shadowHighlightRest:0},0===e.instances.size)return;if(!O(e)){const t=4*e.buffer.size/y(e.vao.layout.geometry);return e.drawCommandsDefault=[{first:0,count:t}],void(e.stats={default:t,highlight:0,occludees:0,shadowHighlightRest:0})}const t=u([...e.instances.values()]);e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[],e.drawCommandsShadowHighlightRest=[];for(const a of t)a.isVisible&&(a.hasOccludees?g(e.drawCommandsOccludees,a):g(e.drawCommandsDefault,a),a.hasHighlights?g(e.drawCommandsHighlight,a):g(e.drawCommandsShadowHighlightRest,a));const s=e=>{let t=0;for(const s of e)t+=s.count;return t/3};e.stats={default:s(e.drawCommandsDefault),highlight:s(e.drawCommandsHighlight),occludees:s(e.drawCommandsOccludees),shadowHighlightRest:s(e.drawCommandsShadowHighlightRest)}};this._dataByOrigin.forEach((e=>{e.drawCommandsDirty&&(t(e),e.drawCommandsDirty=!1)}))}updateLogic(e){return this._material.update(e)}render(e,a,i,r){const n=this._rctx,o=this._glMaterials.get(a),d=5===a||7===a,l=6===a,h=!(d||l);if(3===a&&null===e&&(e=22),!o||2!==o.ensureResources(n)||null!=e&&!o.beginSlot(e)||d&&!this._hasHighlights)return!1;o.ensureParameters(i);const m=o.getPipelineState(e,!1);n.setPipelineState(m);const c=o.technique;n.useProgram(c.program),o.bind(i);let u=!1;return this._dataByOrigin.forEach((a=>{if(t(a.drawCommandsDefault)&&t(a.drawCommandsHighlight)&&t(a.drawCommandsOccludees)&&t(a.drawCommandsShadowHighlightRest))return;if(d&&!a.hasHighlights)return;i.origin=a.origin,c.bindDraw(i,{},{}),c.ensureAttributeLocations(a.vao),n.bindVAO(a.vao);const g=c.primitiveType,f=d?a.drawCommandsHighlight:l&&O(a)?a.drawCommandsShadowHighlightRest:a.drawCommandsDefault;if(s(f)){this.renderCommands(n,g,f);const e=d?a.stats.highlight:l&&O(a)?a.stats.shadowHighlightRest:a.stats.default;b(f.length,e,r),u=!0}if(h){const t=a.drawCommandsOccludees;if(s(t)){const s=o.getPipelineState(e,!0);n.setPipelineState(s),this.renderCommands(n,g,t),n.setPipelineState(m),b(t.length,a.stats.occludees,r),u=!0}}})),u}renderCommands(e,t,s){for(let a=0;a<s.length;a++)e.drawArrays(t,s[a].first,s[a].count)}createData(e,t,s){return{instances:new Map,vao:new _(this._rctx,this._material.vertexAttributeLocations,{geometry:o(e)},{geometry:C.createVertex(this._rctx,35044)}),buffer:new d(t),optimalCount:0,origin:s,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,drawCommandsShadowHighlightRest:null,stats:{default:0,highlight:0,occludees:0,shadowHighlightRest:0}}}removeAndRebuild(e,t,s,a,i){for(const h of t){const t=h.id,a=e.instances.get(t);e.optimalCount-=(a.to-a.from)*s,e.instances.delete(t)}let r=0;const n=e.buffer.array;i.begin=0,i.end=0;let o=-1,d=-1,l=0;e.instances.forEach((e=>{const t=e.from*s,i=e.to*s,h=i-t;o!==d&&d!==t?(n.set(a.subarray(o,d),l),l+=d-o,o=t):-1===o&&(o=t),d=i,e.from=r/s,r+=h,e.to=r/s})),o!==d&&n.set(a.subarray(o,d),l),i.end=r}removeByErasing(e,t,s,a){a.begin=1/0,a.end=-1/0;let i=-1,r=-1;for(const n of t){const t=n.id,o=e.instances.get(t),d=o.from*s,l=o.to*s;i!==r&&r!==d?(e.buffer.erase(i,r),i=d):-1===i&&(i=d),r=l,e.instances.delete(t),e.optimalCount-=l-d,d<a.begin&&(a.begin=d),l>a.end&&(a.end=l)}i!==r&&e.buffer.erase(i,r)}append(e,t,n,o,d){const h=this._bufferWriter;for(const m of t){const t=s(m.transformation)?a(D,o,m.transformation):o;i(j,t),r(j,j);const u=d.end;h.write({transformation:t,invTranspTransformation:j},m.data,h.vertexBufferLayout.createView(e.buffer.array.buffer),d.end/n);const g=h.elementCount(m.data)*n,f=u+g;l(null==e.instances.get(m.id));const p=m.instanceParameters.visible,w=!!m.instanceParameters.highlights&&p,b=!!m.instanceParameters.occludees,C=new c(u/n,f/n,p,w,b);e.instances.set(m.id,C),e.optimalCount+=g,d.end+=g}}get test(){return{material:this._material,glMaterials:this._glMaterials}}}function H(e,s,a,i){const r=new Map,n=s.vertexBufferLayout.stride/4,o=(a,i)=>{const o=a.origin;if(t(o))return;const d=e.get(o.id);let l=r.get(o.id);null==l&&(l={optimalCount:null==d?0:d.optimalCount,sparseCount:null==d?0:d.buffer.size,toAdd:[],toRemove:[],origin:o.vec3},r.set(o.id,l));const h=s.elementCount(a.data)*n;i?(l.optimalCount+=h,l.sparseCount+=h,l.toAdd.push(a)):(l.optimalCount-=h,l.toRemove.push(a))};for(const t of a)o(t,!0);for(const t of i)o(t,!1);return r}function O(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}const R={begin:0,end:0},B=n(),D=n(),j=n();export default v;\n"]},"metadata":{},"sourceType":"module"}