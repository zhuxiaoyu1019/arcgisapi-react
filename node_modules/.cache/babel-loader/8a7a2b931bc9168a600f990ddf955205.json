{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isSome as t, isNone as e } from \"../../../../core/maybe.js\";\nimport { h as s, i, l as r, a as n, d as a, p as o, f as h, b as c } from \"../../../../chunks/vec3.js\";\nimport { c as m } from \"../../../../chunks/vec3f64.js\";\nimport { c as u } from \"../../../../chunks/vec4.js\";\nimport { projectBoundingSphere as p } from \"../../../../geometry/projection.js\";\nimport { getSphericalPCPF as l } from \"../../../../geometry/projectionEllipsoid.js\";\nimport { create as d, fromMatrix as _, intersectsSphere as b } from \"../../../../geometry/support/frustum.js\";\nimport { w as x } from \"../../../../chunks/sphere.js\";\nimport { makeDehydratedPoint as f } from \"../../../../layers/graphics/dehydratedFeatures.js\";\nimport { evaluateElevationAlignmentAtPoint as g } from \"../graphics/elevationAlignmentUtils.js\";\nimport { ElevationContext as M } from \"../graphics/ElevationContext.js\";\nimport { createContextWithoutExpressionSupport as v, extractExpressionInfo as D } from \"../graphics/featureExpressionInfoUtils.js\";\nimport { transformObb as C, intersectBoundingBoxWithMbs as P } from \"./I3SUtil.js\";\nimport { create as R, isVisible as S } from \"../../support/orientedBoundingBox.js\";\nconst E = 1e5;\n\nclass L {\n  constructor(t, e, s, i, r, n, a, o = {}) {\n    this.indexSR = t, this._renderCoordsHelper = e, this.extent = r, this.elevationProvider = n, this.options = o, this._frustum = d(), this._useFrustumCulling = !1, this._poi = m(), this.minDistance = 1 / 0, this.maxDistance = 0, this.maxLodLevel = 2, this._tmp1 = m(), this._tmp2 = m(), this._tmp3 = m(), this._tmp0 = m(), this.screenspaceErrorBias = o.screenspaceErrorBias || 1, this.progressiveLoadFactor = o.progressiveLoadFactor || 1, this.updateCamera(s, i), this.engineSR = this._renderCoordsHelper.spatialReference, this.updateElevationInfo(a), this.tmpPoint = f(0, 0, 0, t);\n  }\n\n  updateElevationInfo(t) {\n    null != t ? (this._elevationContext = M.fromElevationInfo(t), this._elevationContext.updateFeatureExpressionInfoContext(v(D(t, !1)))) : this._elevationContext = null;\n  }\n\n  updateCamera(t, e) {\n    this._useFrustumCulling = e, e && _(t.viewMatrix, t.projectionMatrix, this._frustum), this._screenSizeFactor = 1 / (t.perScreenPixelRatio / 2), this._camPos = t.eye, this.minDistance = 1 / 0, this.maxDistance = 0;\n  }\n\n  setPointOfInterest(t) {\n    this._poi = t;\n  }\n\n  updateScreenSpaceErrorBias(t) {\n    const e = this.screenspaceErrorBias;\n    return this.screenspaceErrorBias = t, e;\n  }\n\n  updateExtent(t) {\n    this.extent = t;\n  }\n\n  getRenderMbs(t) {\n    const e = t.renderMbs;\n    return e[3] < 0 && (u(e, t.mbs), this._elevationContext && e[3] < E && (this.tmpPoint.x = e[0], this.tmpPoint.y = e[1], this.tmpPoint.z = e[2], e[2] = g(this.tmpPoint, this.elevationProvider, this._elevationContext, this._renderCoordsHelper)), p(e, this.indexSR, e, this.engineSR)), e;\n  }\n\n  getVisibilityObb(s) {\n    if (t(s.visibilityObb)) return s.visibilityObb;\n    const i = s.serviceObb;\n    return e(i) || i.halfSize[0] < 0 ? void 0 : (s.serviceObbInRenderSR = this._computeRenderObb(i, s.serviceObbInRenderSR, s.mbs[3]), s.serviceObbInRenderSR);\n  }\n\n  _computeRenderObb(t, s, i) {\n    if (e(s) && (s = R()), s.halfSize[0] < 0) {\n      let e = 0;\n      this._elevationContext && i < E && (this.tmpPoint.x = t.center[0], this.tmpPoint.y = t.center[1], this.tmpPoint.z = t.center[2], e = g(this.tmpPoint, this.elevationProvider, this._elevationContext, this._renderCoordsHelper) - t.center[2]), C(t, this.indexSR, s, this.engineSR, e);\n    }\n\n    return s;\n  }\n\n  isNodeVisible(e) {\n    const s = this.getRenderMbs(e);\n    if (!this.isMBSinExtent(s)) return !1;\n    if (!this._useFrustumCulling) return !0;\n    const i = this.getVisibilityObb(e);\n    return t(i) ? S(i, this._frustum) : b(this._frustum, x(s));\n  }\n\n  isGeometryVisible(e) {\n    if (!this._useFrustumCulling) return !0;\n    const s = e.geometryObb;\n    return t(s) ? S(s, this._frustum) : this.isNodeVisible(e);\n  }\n\n  isMBSinExtent(t) {\n    return !this.extent || 0 !== P(this.extent, t);\n  }\n\n  screenSpaceDiameterMbs(t, e) {\n    const i = this.getRenderMbs(t),\n          r = Math.sqrt(s(i, this._camPos)),\n          n = r - i[3];\n    return this._updateMinMaxDistance(r), n < 0 ? .5 * Number.MAX_VALUE : e / n * this._screenSizeFactor;\n  }\n\n  calcCameraDistance(t) {\n    return this.calcCameraDistanceToCenter(t) - this.getRenderMbs(t)[3];\n  }\n\n  calcCameraDistanceToCenter(t) {\n    const e = this.getRenderMbs(t),\n          s = i(e, this._camPos);\n    return this._updateMinMaxDistance(s), s;\n  }\n\n  calcAngleDependentLoD(t) {\n    const e = this.getRenderMbs(t),\n          s = e[3],\n          n = (Math.abs(e[0] * (e[0] - this._camPos[0]) + e[1] * (e[1] - this._camPos[1]) + e[2] * (e[2] - this._camPos[2])) / r(e) + s) / i(e, this._camPos);\n    return Math.min(1, n);\n  }\n\n  hasLOD(t) {\n    return 0 !== t.lodMetric;\n  }\n\n  getDistancePlanarMode(t, e) {\n    const s = t[0] - e[0],\n          i = t[1] - e[1],\n          r = t[2] - e[2],\n          n = s * s + i * i,\n          a = e[3];\n    if (n <= a * a) return Math.abs(r);\n    const o = Math.sqrt(n) - a;\n    return Math.sqrt(r * r + o * o);\n  }\n\n  getDistanceGlobeMode(t, e) {\n    const m = r(e),\n          u = r(t) - m;\n    n(this._tmp0, t, a(t, e) / o(t));\n    const p = s(e, this._tmp0),\n          l = e[3];\n    if (p <= l * l) return Math.abs(u);\n    {\n      const s = n(this._tmp0, e, 1 / m),\n            o = m,\n            p = l * l / 2 / o,\n            d = n(this._tmp1, s, o - p),\n            _ = t,\n            b = h(this._tmp2, _, d),\n            x = h(this._tmp2, b, n(this._tmp3, s, a(s, b))),\n            f = c(this._tmp2, d, n(this._tmp2, x, l / r(x)));\n      let g = i(_, f);\n\n      if (u >= 2e5) {\n        const t = h(this._tmp1, _, f);\n        let e = a(t, s) / r(t);\n        e < .08 && (e = 1e-4), g /= e;\n      }\n\n      return g;\n    }\n  }\n\n  getDistance(t, e) {\n    return this.engineSR === l(this.engineSR) ? this.getDistanceGlobeMode(t, e) : this.getDistancePlanarMode(t, e);\n  }\n\n  _updateMinMaxDistance(t) {\n    t > 0 ? (this.minDistance = Math.min(this.minDistance, t), this.maxDistance = Math.max(this.maxDistance, t)) : (this.minDistance = 0, this.maxDistance = Math.max(this.maxDistance, -t));\n  }\n\n  getLodLevel(t) {\n    if (0 === t.lodMetric || !t.resources.hasFeatureData) return 0;\n    if (0 === t.childCount) return this.maxLodLevel;\n\n    if (this._useFrustumCulling && this.progressiveLoadFactor < 1) {\n      const e = this.progressiveLoadFactor * this.screenspaceErrorBias,\n            s = this.screenspaceErrorBias;\n      return this.evaluateLODmetric(t, e) ? this.evaluateLODmetric(t, s) ? 2 : 1 : 0;\n    }\n\n    return this.evaluateLODmetric(t, this.screenspaceErrorBias) ? this.maxLodLevel : 0;\n  }\n\n  evaluateLODmetric(t, e) {\n    switch (t.lodMetric) {\n      case 2:\n        {\n          const s = this.getRenderMbs(t),\n                i = this.getDistance(this._camPos, s),\n                r = 2 * i / this._screenSizeFactor,\n                n = i + s[3];\n          return this._updateMinMaxDistance(n), t.maxError * e <= r;\n        }\n\n      case 1:\n        {\n          let s = this.screenSpaceDiameterMbs(t, t.mbs[3] * e);\n          return this.options.angleDependentLoD && (s *= this.calcAngleDependentLoD(t)), s < t.maxError;\n        }\n\n      case 3:\n        return this.screenSpaceDiameterMbs(t, t.maxError) * e < 10;\n\n      case 4:\n        return this.calcCameraDistance(t) > t.maxError * e;\n    }\n\n    return !1;\n  }\n\n  distToPOI(t) {\n    const e = this.getRenderMbs(t);\n    return i(e, this._poi) - e[3];\n  }\n\n  distCameraToPOI() {\n    return i(this._camPos, this._poi);\n  }\n\n}\n\nexport default L;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/layers/i3s/I3SViewportQueries.js"],"names":["isSome","t","isNone","e","h","s","i","l","r","a","n","d","p","o","f","b","c","m","u","projectBoundingSphere","getSphericalPCPF","create","fromMatrix","_","intersectsSphere","w","x","makeDehydratedPoint","evaluateElevationAlignmentAtPoint","g","ElevationContext","M","createContextWithoutExpressionSupport","v","extractExpressionInfo","D","transformObb","C","intersectBoundingBoxWithMbs","P","R","isVisible","S","E","L","constructor","indexSR","_renderCoordsHelper","extent","elevationProvider","options","_frustum","_useFrustumCulling","_poi","minDistance","maxDistance","maxLodLevel","_tmp1","_tmp2","_tmp3","_tmp0","screenspaceErrorBias","progressiveLoadFactor","updateCamera","engineSR","spatialReference","updateElevationInfo","tmpPoint","_elevationContext","fromElevationInfo","updateFeatureExpressionInfoContext","viewMatrix","projectionMatrix","_screenSizeFactor","perScreenPixelRatio","_camPos","eye","setPointOfInterest","updateScreenSpaceErrorBias","updateExtent","getRenderMbs","renderMbs","mbs","y","z","getVisibilityObb","visibilityObb","serviceObb","halfSize","serviceObbInRenderSR","_computeRenderObb","center","isNodeVisible","isMBSinExtent","isGeometryVisible","geometryObb","screenSpaceDiameterMbs","Math","sqrt","_updateMinMaxDistance","Number","MAX_VALUE","calcCameraDistance","calcCameraDistanceToCenter","calcAngleDependentLoD","abs","min","hasLOD","lodMetric","getDistancePlanarMode","getDistanceGlobeMode","getDistance","max","getLodLevel","resources","hasFeatureData","childCount","evaluateLODmetric","maxError","angleDependentLoD","distToPOI","distCameraToPOI"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isSome as t,isNone as e}from\"../../../../core/maybe.js\";import{h as s,i,l as r,a as n,d as a,p as o,f as h,b as c}from\"../../../../chunks/vec3.js\";import{c as m}from\"../../../../chunks/vec3f64.js\";import{c as u}from\"../../../../chunks/vec4.js\";import{projectBoundingSphere as p}from\"../../../../geometry/projection.js\";import{getSphericalPCPF as l}from\"../../../../geometry/projectionEllipsoid.js\";import{create as d,fromMatrix as _,intersectsSphere as b}from\"../../../../geometry/support/frustum.js\";import{w as x}from\"../../../../chunks/sphere.js\";import{makeDehydratedPoint as f}from\"../../../../layers/graphics/dehydratedFeatures.js\";import{evaluateElevationAlignmentAtPoint as g}from\"../graphics/elevationAlignmentUtils.js\";import{ElevationContext as M}from\"../graphics/ElevationContext.js\";import{createContextWithoutExpressionSupport as v,extractExpressionInfo as D}from\"../graphics/featureExpressionInfoUtils.js\";import{transformObb as C,intersectBoundingBoxWithMbs as P}from\"./I3SUtil.js\";import{create as R,isVisible as S}from\"../../support/orientedBoundingBox.js\";const E=1e5;class L{constructor(t,e,s,i,r,n,a,o={}){this.indexSR=t,this._renderCoordsHelper=e,this.extent=r,this.elevationProvider=n,this.options=o,this._frustum=d(),this._useFrustumCulling=!1,this._poi=m(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=m(),this._tmp2=m(),this._tmp3=m(),this._tmp0=m(),this.screenspaceErrorBias=o.screenspaceErrorBias||1,this.progressiveLoadFactor=o.progressiveLoadFactor||1,this.updateCamera(s,i),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(a),this.tmpPoint=f(0,0,0,t)}updateElevationInfo(t){null!=t?(this._elevationContext=M.fromElevationInfo(t),this._elevationContext.updateFeatureExpressionInfoContext(v(D(t,!1)))):this._elevationContext=null}updateCamera(t,e){this._useFrustumCulling=e,e&&_(t.viewMatrix,t.projectionMatrix,this._frustum),this._screenSizeFactor=1/(t.perScreenPixelRatio/2),this._camPos=t.eye,this.minDistance=1/0,this.maxDistance=0}setPointOfInterest(t){this._poi=t}updateScreenSpaceErrorBias(t){const e=this.screenspaceErrorBias;return this.screenspaceErrorBias=t,e}updateExtent(t){this.extent=t}getRenderMbs(t){const e=t.renderMbs;return e[3]<0&&(u(e,t.mbs),this._elevationContext&&e[3]<E&&(this.tmpPoint.x=e[0],this.tmpPoint.y=e[1],this.tmpPoint.z=e[2],e[2]=g(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)),p(e,this.indexSR,e,this.engineSR)),e}getVisibilityObb(s){if(t(s.visibilityObb))return s.visibilityObb;const i=s.serviceObb;return e(i)||i.halfSize[0]<0?void 0:(s.serviceObbInRenderSR=this._computeRenderObb(i,s.serviceObbInRenderSR,s.mbs[3]),s.serviceObbInRenderSR)}_computeRenderObb(t,s,i){if(e(s)&&(s=R()),s.halfSize[0]<0){let e=0;this._elevationContext&&i<E&&(this.tmpPoint.x=t.center[0],this.tmpPoint.y=t.center[1],this.tmpPoint.z=t.center[2],e=g(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)-t.center[2]),C(t,this.indexSR,s,this.engineSR,e)}return s}isNodeVisible(e){const s=this.getRenderMbs(e);if(!this.isMBSinExtent(s))return!1;if(!this._useFrustumCulling)return!0;const i=this.getVisibilityObb(e);return t(i)?S(i,this._frustum):b(this._frustum,x(s))}isGeometryVisible(e){if(!this._useFrustumCulling)return!0;const s=e.geometryObb;return t(s)?S(s,this._frustum):this.isNodeVisible(e)}isMBSinExtent(t){return!this.extent||0!==P(this.extent,t)}screenSpaceDiameterMbs(t,e){const i=this.getRenderMbs(t),r=Math.sqrt(s(i,this._camPos)),n=r-i[3];return this._updateMinMaxDistance(r),n<0?.5*Number.MAX_VALUE:e/n*this._screenSizeFactor}calcCameraDistance(t){return this.calcCameraDistanceToCenter(t)-this.getRenderMbs(t)[3]}calcCameraDistanceToCenter(t){const e=this.getRenderMbs(t),s=i(e,this._camPos);return this._updateMinMaxDistance(s),s}calcAngleDependentLoD(t){const e=this.getRenderMbs(t),s=e[3],n=(Math.abs(e[0]*(e[0]-this._camPos[0])+e[1]*(e[1]-this._camPos[1])+e[2]*(e[2]-this._camPos[2]))/r(e)+s)/i(e,this._camPos);return Math.min(1,n)}hasLOD(t){return 0!==t.lodMetric}getDistancePlanarMode(t,e){const s=t[0]-e[0],i=t[1]-e[1],r=t[2]-e[2],n=s*s+i*i,a=e[3];if(n<=a*a)return Math.abs(r);const o=Math.sqrt(n)-a;return Math.sqrt(r*r+o*o)}getDistanceGlobeMode(t,e){const m=r(e),u=r(t)-m;n(this._tmp0,t,a(t,e)/o(t));const p=s(e,this._tmp0),l=e[3];if(p<=l*l)return Math.abs(u);{const s=n(this._tmp0,e,1/m),o=m,p=l*l/2/o,d=n(this._tmp1,s,o-p),_=t,b=h(this._tmp2,_,d),x=h(this._tmp2,b,n(this._tmp3,s,a(s,b))),f=c(this._tmp2,d,n(this._tmp2,x,l/r(x)));let g=i(_,f);if(u>=2e5){const t=h(this._tmp1,_,f);let e=a(t,s)/r(t);e<.08&&(e=1e-4),g/=e}return g}}getDistance(t,e){return this.engineSR===l(this.engineSR)?this.getDistanceGlobeMode(t,e):this.getDistancePlanarMode(t,e)}_updateMinMaxDistance(t){t>0?(this.minDistance=Math.min(this.minDistance,t),this.maxDistance=Math.max(this.maxDistance,t)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-t))}getLodLevel(t){if(0===t.lodMetric||!t.resources.hasFeatureData)return 0;if(0===t.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this.progressiveLoadFactor<1){const e=this.progressiveLoadFactor*this.screenspaceErrorBias,s=this.screenspaceErrorBias;return this.evaluateLODmetric(t,e)?this.evaluateLODmetric(t,s)?2:1:0}return this.evaluateLODmetric(t,this.screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(t,e){switch(t.lodMetric){case 2:{const s=this.getRenderMbs(t),i=this.getDistance(this._camPos,s),r=2*i/this._screenSizeFactor,n=i+s[3];return this._updateMinMaxDistance(n),t.maxError*e<=r}case 1:{let s=this.screenSpaceDiameterMbs(t,t.mbs[3]*e);return this.options.angleDependentLoD&&(s*=this.calcAngleDependentLoD(t)),s<t.maxError}case 3:return this.screenSpaceDiameterMbs(t,t.maxError)*e<10;case 4:return this.calcCameraDistance(t)>t.maxError*e}return!1}distToPOI(t){const e=this.getRenderMbs(t);return i(e,this._poi)-e[3]}distCameraToPOI(){return i(this._camPos,this._poi)}}export default L;\n"]},"metadata":{},"sourceType":"module"}