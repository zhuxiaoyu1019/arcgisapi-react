{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../chunks/tslib.es6.js\";\nimport t from \"../../core/Accessor.js\";\nimport r from \"../../core/Logger.js\";\nimport i from \"../../core/Queue.js\";\nimport { property as n } from \"../../core/accessorSupport/decorators/property.js\";\nimport \"../../core/has.js\";\nimport \"../../core/accessorSupport/ensureType.js\";\nimport { subclass as s } from \"../../core/accessorSupport/decorators/subclass.js\";\nimport { primaryKey as o, isSystemModifier as a } from \"./keys.js\";\nimport { LatestPointerType as p } from \"./handlers/LatestPointerType.js\";\nconst h = r.getLogger(\"esri.views.input.InputManager\");\nlet d = class extends t {\n  constructor(e) {\n    super(e), this._pointerCaptures = new Map(), this._nameToGroup = {}, this._handlers = [], this._currentPropagation = null, this._updateDependenciesAfterPropagation = !1, this._sourceEvents = new Set(), this._keyModifiers = new Set(), this._activeKeyModifiers = new Set(), this._stoppedPropagationEventIds = new Set(), this.primaryKey = o, this.latestPointerType = \"mouse\", this.test = {\n      timestamp: void 0,\n      hasCurrentPropagation: () => !!this._currentPropagation\n    };\n  }\n\n  initialize() {\n    this.eventSource.onEventReceived = this._onEventReceived.bind(this), this._installRecognizers();\n  }\n\n  destroy() {\n    const e = Object.keys(this._nameToGroup);\n\n    for (const t of e) this.uninstallHandlers(t);\n\n    this.eventSource = null, this._currentPropagation = null;\n  }\n\n  get hasPendingInputs() {\n    return this._handlers.some(e => e.handler.hasPendingInputs);\n  }\n\n  installHandlers(e, t, r = u.INTERNAL) {\n    if (this._nameToGroup[e]) return void h.error(\"There is already an InputHandler group registered under the name `\" + e + \"`\");\n    if (0 === t.length) return void h.error(\"Can't register a group of zero handlers\");\n    const i = {\n      name: e,\n      handlers: t.map(e => ({\n        handler: e,\n        active: !0,\n        removed: !1,\n        priorityIndex: 0,\n        groupPriority: r,\n        eventCallback: null,\n        uninstallCallback: null\n      }))\n    };\n    this._nameToGroup[e] = i;\n\n    for (let n = i.handlers.length - 1; n >= 0; n--) {\n      const e = i.handlers[n];\n      this._handlers.push(e), e.handler.onInstall({\n        updateDependencies: () => {\n          this.updateDependencies();\n        },\n        emit: (t, r, i, n, s) => {\n          this._emitInputEvent(e.priorityIndex + 1, t, r, i, s, n);\n        },\n        setPointerCapture: (t, r) => {\n          this._setPointerCapture(i, e, t, r);\n        },\n        setEventCallback: t => {\n          e.eventCallback = t;\n        },\n        setUninstallCallback: t => {\n          e.uninstallCallback = t;\n        },\n        refreshHasPendingInputs: () => {\n          this.notifyChange(\"hasPendingInputs\");\n        }\n      });\n    }\n\n    this.updateDependencies();\n  }\n\n  uninstallHandlers(e) {\n    const t = this._nameToGroup[e];\n    t ? (t.handlers.forEach(e => {\n      e.removed = !0, e.uninstallCallback();\n    }), delete this._nameToGroup[e], this._currentPropagation ? this._currentPropagation.needsHandlerGarbageCollect = !0 : this._garbageCollectRemovedHandlers()) : h.error(\"There is no InputHandler group registered under the name `\" + e + \"`\");\n  }\n\n  hasHandlers(e) {\n    return void 0 !== this._nameToGroup[e];\n  }\n\n  updateDependencies() {\n    if (this._currentPropagation) return void (this._updateDependenciesAfterPropagation = !0);\n    this._updateDependenciesAfterPropagation = !1;\n    const e = new Set(),\n          t = new Set();\n    this._handlersPriority = [];\n\n    for (let r = this._handlers.length - 1; r >= 0; r--) {\n      const e = this._handlers[r];\n      e.priorityIndex = r, this._handlersPriority.push(e);\n    }\n\n    this._handlersPriority = this._sortHandlersPriority(this._handlersPriority);\n\n    for (let r = this._handlersPriority.length - 1; r >= 0; r--) {\n      const i = this._handlersPriority[r];\n      i.priorityIndex = r;\n      let n = i.handler.hasSideEffects;\n      if (!n) for (const t of i.handler.outgoingEventTypes) if (e.has(t)) {\n        n = !0;\n        break;\n      }\n      if (n) for (const r of i.handler.incomingEventMatches) {\n        e.add(r.eventType);\n\n        for (const e of r.keyModifiers) a(e) || t.add(e);\n      }\n      i.active = n;\n    }\n\n    this._sourceEvents = e, this._keyModifiers = t, this._pointerCaptures.size > 0 && this._sourceEvents.add(\"pointer-capture-lost\"), this._keyModifiers.size > 0 && (this._sourceEvents.add(\"key-down\"), this._sourceEvents.add(\"key-up\")), this.eventSource && (this.eventSource.activeEvents = this._sourceEvents);\n  }\n\n  _setLatestPointerType(e) {\n    this._set(\"latestPointerType\", e);\n  }\n\n  _onEventReceived(e, t) {\n    if (\"pointer-capture-lost\" === e) {\n      const e = t;\n\n      this._pointerCaptures.delete(e.native.pointerId);\n    }\n\n    this._updateKeyModifiers(e, t);\n\n    const r = null != this.test.timestamp ? this.test.timestamp : t.native ? t.native.timestamp : void 0,\n          i = t.native ? t.native.cancelable : void 0;\n\n    this._emitInputEventFromSource(e, t, r, i);\n  }\n\n  _updateKeyModifiers(e, t) {\n    if (!t) return;\n    let r = !1;\n\n    const i = () => {\n      if (!r) {\n        const e = new Set();\n        this._activeKeyModifiers.forEach(t => {\n          e.add(t);\n        }), this._activeKeyModifiers = e, r = !0;\n      }\n    },\n          n = (e, t) => {\n      t && !this._activeKeyModifiers.has(e) ? (i(), this._activeKeyModifiers.add(e)) : !t && this._activeKeyModifiers.has(e) && (i(), this._activeKeyModifiers.delete(e));\n    };\n\n    if (\"key-down\" === e || \"key-up\" === e) {\n      const r = t.key;\n      this._keyModifiers.has(r) && n(r, \"key-down\" === e);\n    }\n\n    const s = t.native;\n    n(\"Alt\", !(!s || !s.altKey)), n(\"Ctrl\", !(!s || !s.ctrlKey)), n(\"Shift\", !(!s || !s.shiftKey)), n(\"Meta\", !(!s || !s.metaKey)), n(\"Primary\", this._activeKeyModifiers.has(this.primaryKey));\n  }\n\n  _installRecognizers() {\n    this._latestPointerTypeHandler = new p(e => this._setLatestPointerType(e)), this.recognizers.length > 0 && this.installHandlers(\"default\", this.recognizers, u.INTERNAL), this.installHandlers(\"input-manager-logic\", [this._latestPointerTypeHandler], u.INTERNAL);\n  }\n\n  _setPointerCapture(e, t, r, i) {\n    const n = e.name + \"-\" + t.priorityIndex,\n          s = this._pointerCaptures.get(r.pointerId) || new Set();\n    this._pointerCaptures.set(r.pointerId, s), i ? (s.add(n), 1 === s.size && this.eventSource && this.eventSource.setPointerCapture(r, !0)) : s.has(n) && (s.delete(n), 0 === s.size && (this._pointerCaptures.delete(r.pointerId), this.eventSource && this.eventSource.setPointerCapture(r, !1)));\n  }\n\n  _garbageCollectRemovedHandlers() {\n    this._handlers = this._handlers.filter(e => !e.removed), this.updateDependencies();\n  }\n\n  _emitInputEventFromSource(e, t, r, i) {\n    this._emitInputEvent(0, e, t, r, i);\n  }\n\n  _emitInputEvent(e, t, r, i, n, s) {\n    const o = void 0 !== i ? i : this._currentPropagation ? this._currentPropagation.timestamp : performance.now(),\n          a = void 0 !== n && n,\n          p = {\n      event: new l(t, r, o, s || this._activeKeyModifiers, a),\n      priorityIndex: e\n    };\n    this._currentPropagation ? this._currentPropagation.events.push(p) : this._doNewPropagation(p);\n  }\n\n  _doNewPropagation(e) {\n    this._currentPropagation = {\n      events: new i(),\n      currentHandler: null,\n      needsHandlerGarbageCollect: !1,\n      timestamp: e.event.timestamp\n    }, this._currentPropagation.events.push(e), this._continuePropagation();\n  }\n\n  _continuePropagation() {\n    const e = this._currentPropagation;\n\n    if (e) {\n      for (; this._currentPropagation.events.length > 0;) {\n        const {\n          event: t,\n          priorityIndex: r\n        } = this._currentPropagation.events.pop(),\n              i = t.data && t.data.eventId;\n\n        if (!(null != i && this._stoppedPropagationEventIds.has(i))) for (e.currentHandler = this._handlersPriority[r]; e.currentHandler;) {\n          if (e.currentHandler.removed) e.needsHandlerGarbageCollect = !0;else {\n            if (e.currentHandler.active && !t.shouldStopPropagation() && e.currentHandler.eventCallback(t), t.shouldStopPropagation()) {\n              null != i && this._stoppedPropagationEventIds.add(i);\n              break;\n            }\n\n            if (t.shouldPausePropagation(() => this._continuePropagation())) return void this._pausePropagation({\n              event: t,\n              priorityIndex: e.currentHandler.priorityIndex + 1\n            });\n          }\n          e.currentHandler = this._handlersPriority[e.currentHandler.priorityIndex + 1];\n        }\n      }\n\n      e.needsHandlerGarbageCollect && this._garbageCollectRemovedHandlers(), this.hasPendingInputs || this._stoppedPropagationEventIds.clear(), this._currentPropagation = null, this._updateDependenciesAfterPropagation && this.updateDependencies();\n    }\n  }\n\n  _pausePropagation(e) {\n    const t = new i();\n\n    for (t.push(e); this._currentPropagation.events.length;) t.push(this._currentPropagation.events.pop());\n\n    this._currentPropagation.events = t, this._currentPropagation.currentHandler = null;\n  }\n\n  _compareHandlerPriority(e, t) {\n    if (e.handler.hasSideEffects !== t.handler.hasSideEffects) return e.handler.hasSideEffects ? 1 : -1;\n    if (e.groupPriority !== t.groupPriority) return e.groupPriority > t.groupPriority ? -1 : 1;\n\n    for (const r of e.handler.incomingEventMatches) for (const e of t.handler.incomingEventMatches) {\n      if (r.eventType !== e.eventType) continue;\n      const t = r.keyModifiers.filter(t => -1 !== e.keyModifiers.indexOf(t));\n      if (t.length === r.keyModifiers.length !== (t.length === e.keyModifiers.length)) return r.keyModifiers.length > e.keyModifiers.length ? -1 : 1;\n    }\n\n    return e.priorityIndex > t.priorityIndex ? -1 : 1;\n  }\n\n  _sortHandlersPriority(e) {\n    const t = [];\n\n    for (const r of e) {\n      let e = 0;\n\n      for (; e < t.length && this._compareHandlerPriority(r, t[e]) >= 0;) e++;\n\n      t.splice(e, 0, r);\n    }\n\n    return t;\n  }\n\n  get debug() {\n    const e = e => {\n      const t = this._setPointerCapture;\n      this._setPointerCapture = () => {}, e(), this._setPointerCapture = t;\n    };\n\n    return {\n      injectEvent: (t, r) => {\n        e(() => {\n          this._onEventReceived(t, r);\n        });\n      },\n      disablePointerCapture: e\n    };\n  }\n\n};\ne([n({\n  readOnly: !0\n})], d.prototype, \"hasPendingInputs\", null), e([n()], d.prototype, \"eventSource\", void 0), e([n()], d.prototype, \"recognizers\", void 0), e([n({\n  readOnly: !0\n})], d.prototype, \"latestPointerType\", void 0), d = e([s(\"esri.views.input.InputManager\")], d);\n\nclass l {\n  constructor(e, t, r, i, n) {\n    this.type = e, this.data = t, this.timestamp = r, this.modifiers = i, this.cancelable = n, this._propagationState = 0, this._resumeCallback = null;\n  }\n\n  stopPropagation() {\n    this._propagationState |= 1;\n  }\n\n  shouldStopPropagation() {\n    return 0 != (1 & this._propagationState);\n  }\n\n  async(e) {\n    this._propagationState |= 2;\n\n    const t = (e, t) => {\n      this._propagationState &= -3;\n      const r = this._resumeCallback;\n      if (this._resumeCallback = null, r && r(), t) throw e;\n      return e;\n    };\n\n    return (\"function\" == typeof e ? e() : e).then(e => t(e, !1), e => t(e, !0));\n  }\n\n  shouldPausePropagation(e) {\n    return !!(2 & this._propagationState) && (this._resumeCallback = e, !0);\n  }\n\n  preventDefault() {\n    this.data.native.preventDefault();\n  }\n\n}\n\nconst u = {\n  DEFAULT: 0,\n  TOOL: -1,\n  WIDGET: -2,\n  INTERNAL: -3\n};\nexport { d as InputManager, u as ViewEventPriorities };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/input/InputManager.js"],"names":["_","e","t","r","i","property","n","subclass","s","primaryKey","o","isSystemModifier","a","LatestPointerType","p","h","getLogger","d","constructor","_pointerCaptures","Map","_nameToGroup","_handlers","_currentPropagation","_updateDependenciesAfterPropagation","_sourceEvents","Set","_keyModifiers","_activeKeyModifiers","_stoppedPropagationEventIds","latestPointerType","test","timestamp","hasCurrentPropagation","initialize","eventSource","onEventReceived","_onEventReceived","bind","_installRecognizers","destroy","Object","keys","uninstallHandlers","hasPendingInputs","some","handler","installHandlers","u","INTERNAL","error","length","name","handlers","map","active","removed","priorityIndex","groupPriority","eventCallback","uninstallCallback","push","onInstall","updateDependencies","emit","_emitInputEvent","setPointerCapture","_setPointerCapture","setEventCallback","setUninstallCallback","refreshHasPendingInputs","notifyChange","forEach","needsHandlerGarbageCollect","_garbageCollectRemovedHandlers","hasHandlers","_handlersPriority","_sortHandlersPriority","hasSideEffects","outgoingEventTypes","has","incomingEventMatches","add","eventType","keyModifiers","size","activeEvents","_setLatestPointerType","_set","delete","native","pointerId","_updateKeyModifiers","cancelable","_emitInputEventFromSource","key","altKey","ctrlKey","shiftKey","metaKey","_latestPointerTypeHandler","recognizers","get","set","filter","performance","now","event","l","events","_doNewPropagation","currentHandler","_continuePropagation","pop","data","eventId","shouldStopPropagation","shouldPausePropagation","_pausePropagation","clear","_compareHandlerPriority","indexOf","splice","debug","injectEvent","disablePointerCapture","readOnly","prototype","type","modifiers","_propagationState","_resumeCallback","stopPropagation","async","then","preventDefault","DEFAULT","TOOL","WIDGET","InputManager","ViewEventPriorities"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../chunks/tslib.es6.js\";import t from\"../../core/Accessor.js\";import r from\"../../core/Logger.js\";import i from\"../../core/Queue.js\";import{property as n}from\"../../core/accessorSupport/decorators/property.js\";import\"../../core/has.js\";import\"../../core/accessorSupport/ensureType.js\";import{subclass as s}from\"../../core/accessorSupport/decorators/subclass.js\";import{primaryKey as o,isSystemModifier as a}from\"./keys.js\";import{LatestPointerType as p}from\"./handlers/LatestPointerType.js\";const h=r.getLogger(\"esri.views.input.InputManager\");let d=class extends t{constructor(e){super(e),this._pointerCaptures=new Map,this._nameToGroup={},this._handlers=[],this._currentPropagation=null,this._updateDependenciesAfterPropagation=!1,this._sourceEvents=new Set,this._keyModifiers=new Set,this._activeKeyModifiers=new Set,this._stoppedPropagationEventIds=new Set,this.primaryKey=o,this.latestPointerType=\"mouse\",this.test={timestamp:void 0,hasCurrentPropagation:()=>!!this._currentPropagation}}initialize(){this.eventSource.onEventReceived=this._onEventReceived.bind(this),this._installRecognizers()}destroy(){const e=Object.keys(this._nameToGroup);for(const t of e)this.uninstallHandlers(t);this.eventSource=null,this._currentPropagation=null}get hasPendingInputs(){return this._handlers.some((e=>e.handler.hasPendingInputs))}installHandlers(e,t,r=u.INTERNAL){if(this._nameToGroup[e])return void h.error(\"There is already an InputHandler group registered under the name `\"+e+\"`\");if(0===t.length)return void h.error(\"Can't register a group of zero handlers\");const i={name:e,handlers:t.map((e=>({handler:e,active:!0,removed:!1,priorityIndex:0,groupPriority:r,eventCallback:null,uninstallCallback:null})))};this._nameToGroup[e]=i;for(let n=i.handlers.length-1;n>=0;n--){const e=i.handlers[n];this._handlers.push(e),e.handler.onInstall({updateDependencies:()=>{this.updateDependencies()},emit:(t,r,i,n,s)=>{this._emitInputEvent(e.priorityIndex+1,t,r,i,s,n)},setPointerCapture:(t,r)=>{this._setPointerCapture(i,e,t,r)},setEventCallback:t=>{e.eventCallback=t},setUninstallCallback:t=>{e.uninstallCallback=t},refreshHasPendingInputs:()=>{this.notifyChange(\"hasPendingInputs\")}})}this.updateDependencies()}uninstallHandlers(e){const t=this._nameToGroup[e];t?(t.handlers.forEach((e=>{e.removed=!0,e.uninstallCallback()})),delete this._nameToGroup[e],this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers()):h.error(\"There is no InputHandler group registered under the name `\"+e+\"`\")}hasHandlers(e){return void 0!==this._nameToGroup[e]}updateDependencies(){if(this._currentPropagation)return void(this._updateDependenciesAfterPropagation=!0);this._updateDependenciesAfterPropagation=!1;const e=new Set,t=new Set;this._handlersPriority=[];for(let r=this._handlers.length-1;r>=0;r--){const e=this._handlers[r];e.priorityIndex=r,this._handlersPriority.push(e)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(let r=this._handlersPriority.length-1;r>=0;r--){const i=this._handlersPriority[r];i.priorityIndex=r;let n=i.handler.hasSideEffects;if(!n)for(const t of i.handler.outgoingEventTypes)if(e.has(t)){n=!0;break}if(n)for(const r of i.handler.incomingEventMatches){e.add(r.eventType);for(const e of r.keyModifiers)a(e)||t.add(e)}i.active=n}this._sourceEvents=e,this._keyModifiers=t,this._pointerCaptures.size>0&&this._sourceEvents.add(\"pointer-capture-lost\"),this._keyModifiers.size>0&&(this._sourceEvents.add(\"key-down\"),this._sourceEvents.add(\"key-up\")),this.eventSource&&(this.eventSource.activeEvents=this._sourceEvents)}_setLatestPointerType(e){this._set(\"latestPointerType\",e)}_onEventReceived(e,t){if(\"pointer-capture-lost\"===e){const e=t;this._pointerCaptures.delete(e.native.pointerId)}this._updateKeyModifiers(e,t);const r=null!=this.test.timestamp?this.test.timestamp:t.native?t.native.timestamp:void 0,i=t.native?t.native.cancelable:void 0;this._emitInputEventFromSource(e,t,r,i)}_updateKeyModifiers(e,t){if(!t)return;let r=!1;const i=()=>{if(!r){const e=new Set;this._activeKeyModifiers.forEach((t=>{e.add(t)})),this._activeKeyModifiers=e,r=!0}},n=(e,t)=>{t&&!this._activeKeyModifiers.has(e)?(i(),this._activeKeyModifiers.add(e)):!t&&this._activeKeyModifiers.has(e)&&(i(),this._activeKeyModifiers.delete(e))};if(\"key-down\"===e||\"key-up\"===e){const r=t.key;this._keyModifiers.has(r)&&n(r,\"key-down\"===e)}const s=t.native;n(\"Alt\",!(!s||!s.altKey)),n(\"Ctrl\",!(!s||!s.ctrlKey)),n(\"Shift\",!(!s||!s.shiftKey)),n(\"Meta\",!(!s||!s.metaKey)),n(\"Primary\",this._activeKeyModifiers.has(this.primaryKey))}_installRecognizers(){this._latestPointerTypeHandler=new p((e=>this._setLatestPointerType(e))),this.recognizers.length>0&&this.installHandlers(\"default\",this.recognizers,u.INTERNAL),this.installHandlers(\"input-manager-logic\",[this._latestPointerTypeHandler],u.INTERNAL)}_setPointerCapture(e,t,r,i){const n=e.name+\"-\"+t.priorityIndex,s=this._pointerCaptures.get(r.pointerId)||new Set;this._pointerCaptures.set(r.pointerId,s),i?(s.add(n),1===s.size&&this.eventSource&&this.eventSource.setPointerCapture(r,!0)):s.has(n)&&(s.delete(n),0===s.size&&(this._pointerCaptures.delete(r.pointerId),this.eventSource&&this.eventSource.setPointerCapture(r,!1)))}_garbageCollectRemovedHandlers(){this._handlers=this._handlers.filter((e=>!e.removed)),this.updateDependencies()}_emitInputEventFromSource(e,t,r,i){this._emitInputEvent(0,e,t,r,i)}_emitInputEvent(e,t,r,i,n,s){const o=void 0!==i?i:this._currentPropagation?this._currentPropagation.timestamp:performance.now(),a=void 0!==n&&n,p={event:new l(t,r,o,s||this._activeKeyModifiers,a),priorityIndex:e};this._currentPropagation?this._currentPropagation.events.push(p):this._doNewPropagation(p)}_doNewPropagation(e){this._currentPropagation={events:new i,currentHandler:null,needsHandlerGarbageCollect:!1,timestamp:e.event.timestamp},this._currentPropagation.events.push(e),this._continuePropagation()}_continuePropagation(){const e=this._currentPropagation;if(e){for(;this._currentPropagation.events.length>0;){const{event:t,priorityIndex:r}=this._currentPropagation.events.pop(),i=t.data&&t.data.eventId;if(!(null!=i&&this._stoppedPropagationEventIds.has(i)))for(e.currentHandler=this._handlersPriority[r];e.currentHandler;){if(e.currentHandler.removed)e.needsHandlerGarbageCollect=!0;else{if(e.currentHandler.active&&!t.shouldStopPropagation()&&e.currentHandler.eventCallback(t),t.shouldStopPropagation()){null!=i&&this._stoppedPropagationEventIds.add(i);break}if(t.shouldPausePropagation((()=>this._continuePropagation())))return void this._pausePropagation({event:t,priorityIndex:e.currentHandler.priorityIndex+1})}e.currentHandler=this._handlersPriority[e.currentHandler.priorityIndex+1]}}e.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers(),this.hasPendingInputs||this._stoppedPropagationEventIds.clear(),this._currentPropagation=null,this._updateDependenciesAfterPropagation&&this.updateDependencies()}}_pausePropagation(e){const t=new i;for(t.push(e);this._currentPropagation.events.length;)t.push(this._currentPropagation.events.pop());this._currentPropagation.events=t,this._currentPropagation.currentHandler=null}_compareHandlerPriority(e,t){if(e.handler.hasSideEffects!==t.handler.hasSideEffects)return e.handler.hasSideEffects?1:-1;if(e.groupPriority!==t.groupPriority)return e.groupPriority>t.groupPriority?-1:1;for(const r of e.handler.incomingEventMatches)for(const e of t.handler.incomingEventMatches){if(r.eventType!==e.eventType)continue;const t=r.keyModifiers.filter((t=>-1!==e.keyModifiers.indexOf(t)));if(t.length===r.keyModifiers.length!==(t.length===e.keyModifiers.length))return r.keyModifiers.length>e.keyModifiers.length?-1:1}return e.priorityIndex>t.priorityIndex?-1:1}_sortHandlersPriority(e){const t=[];for(const r of e){let e=0;for(;e<t.length&&this._compareHandlerPriority(r,t[e])>=0;)e++;t.splice(e,0,r)}return t}get debug(){const e=e=>{const t=this._setPointerCapture;this._setPointerCapture=()=>{},e(),this._setPointerCapture=t};return{injectEvent:(t,r)=>{e((()=>{this._onEventReceived(t,r)}))},disablePointerCapture:e}}};e([n({readOnly:!0})],d.prototype,\"hasPendingInputs\",null),e([n()],d.prototype,\"eventSource\",void 0),e([n()],d.prototype,\"recognizers\",void 0),e([n({readOnly:!0})],d.prototype,\"latestPointerType\",void 0),d=e([s(\"esri.views.input.InputManager\")],d);class l{constructor(e,t,r,i,n){this.type=e,this.data=t,this.timestamp=r,this.modifiers=i,this.cancelable=n,this._propagationState=0,this._resumeCallback=null}stopPropagation(){this._propagationState|=1}shouldStopPropagation(){return 0!=(1&this._propagationState)}async(e){this._propagationState|=2;const t=(e,t)=>{this._propagationState&=-3;const r=this._resumeCallback;if(this._resumeCallback=null,r&&r(),t)throw e;return e};return(\"function\"==typeof e?e():e).then((e=>t(e,!1)),(e=>t(e,!0)))}shouldPausePropagation(e){return!!(2&this._propagationState)&&(this._resumeCallback=e,!0)}preventDefault(){this.data.native.preventDefault()}}const u={DEFAULT:0,TOOL:-1,WIDGET:-2,INTERNAL:-3};export{d as InputManager,u as ViewEventPriorities};\n"]},"metadata":{},"sourceType":"module"}