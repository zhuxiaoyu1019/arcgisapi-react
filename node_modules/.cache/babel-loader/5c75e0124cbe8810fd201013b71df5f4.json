{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as t } from \"../chunks/tslib.es6.js\";\nimport o from \"../core/Accessor.js\";\nimport e from \"../core/Collection.js\";\nimport { HandleOwner as i } from \"../core/HandleOwner.js\";\nimport a from \"../core/Logger.js\";\nimport { isSome as r, isNone as s } from \"../core/maybe.js\";\nimport { throwIfAborted as l, onAbort as n, createAbortError as h } from \"../core/promiseUtils.js\";\nimport { whenOnce as c, watch as p } from \"../core/watchUtils.js\";\nimport { property as u } from \"../core/accessorSupport/decorators/property.js\";\nimport \"../core/has.js\";\nimport \"../core/accessorSupport/ensureType.js\";\nimport { subclass as d } from \"../core/accessorSupport/decorators/subclass.js\";\nimport { ViewEventPriorities as v } from \"./input/InputManager.js\";\nimport { eventTypes as m } from \"./input/ViewEvents.js\";\nimport { newToolCollection as T, swap as f, areToolManipulatorsEditable as _, evaluateToolConstructorArguments as g, setActive as w } from \"./interactive/interactiveToolUtils.js\";\nimport E from \"./interactive/ToolViewManagerManipulatorState.js\";\nconst y = a.getLogger(\"esri.views.ToolViewManager\"),\n      j = \"manipulators\",\n      b = \"tools\";\nlet C = class extends i {\n  constructor(t) {\n    super(t), this._creatingTool = null, this._manipulatorState = new E(), this.tools = T(), this.cursor = null, this._forEachTool = t => {\n      if (!r(this._creatingTool) || !t(this._creatingTool)) for (const o of this.tools.items) if (t(o)) return;\n    };\n  }\n\n  initialize() {\n    this.handles.add([this.view.on(m, t => {\n      this._handleInputEvent(t);\n    }, v.TOOL), this.tools.on(\"before-add\", t => {\n      const o = t.item;\n      null == o || this.tools.includes(o) ? t.preventDefault() : null == o.created || o.created || (y.error(\"tools\", \"Tool can not be added to view before it has been created\"), t.preventDefault());\n    }), this.tools.on(\"before-remove\", ({\n      item: t\n    }) => {\n      this._manipulatorState.clearPointers(t, this._forEachTool);\n    }), this.tools.on(\"change\", () => {\n      this._refreshToolWatchers();\n    })]);\n  }\n\n  destroy() {\n    this._forEachTool(t => t.destroy());\n  }\n\n  set activeTool(t) {\n    !r(t) || this.view.ready ? (f(this, t, o => {\n      this._set(\"activeTool\", o), this._removeIncompleteTools(t), this._forEachTool(t => {\n        const o = s(this.activeTool) || t === this.activeTool;\n        t.setEditableFlag && t.setEditableFlag(1, o);\n\n        const e = _(t);\n\n        !s(this.activeTool) && e || this._manipulatorState.clearPointers(t, this._forEachTool, !e);\n      }), this._updateCursor();\n    }), this._creatingTool !== t && this._rejectCreatingTool()) : y.error(\"#activeTool=\", \"cannot set active tool while view is not ready\");\n  }\n\n  get updating() {\n    return this.updatingHandles.updating || this.tools.some(t => t.updating);\n  }\n\n  async createTool(t, e, i) {\n    const a = \"Tool creation was interrupted by another tool being created\",\n          {\n      abortHandle: s,\n      tool: h\n    } = await this.updatingHandles.addPromise((async () => {\n      await this.view.whenReady(), l(i, a);\n      const o = n(i, () => this.activeTool = null),\n            r = g(e),\n            s = new t({ ...r,\n        view: this.view\n      });\n      return await s.whenCreationStarted(), l(i, a), {\n        abortHandle: o,\n        tool: s\n      };\n    })());\n    return this._rejectCreatingTool(a), this._creatingTool = h, h.attach(), this._refreshToolWatchers(), w(h, !0), await h.when(), r(s) && s.remove(), this._creatingTool = null, l(i, a), this.tools.add(h), h instanceof o && null != h.completed && c(h, \"completed\").then(() => {\n      w(h, !1);\n    }), h;\n  }\n\n  attach() {\n    this._forEachTool(t => t.attach()), \"3d\" === this.view.type ? this.handles.add([this.view.state.watch(\"camera\", () => {\n      this.forEachManipulator(t => {\n        null != t.onViewChange && t.onViewChange();\n      });\n    }), this.view.elevationProvider.on(\"elevation-change\", t => {\n      this.forEachManipulator(o => {\n        null != o.onElevationChange && o.onElevationChange(t);\n      });\n    })], j) : this.handles.add(this.view.watch(\"extent\", () => {\n      this.forEachManipulator(t => {\n        null != t.onViewChange && t.onViewChange();\n      });\n    }));\n  }\n\n  detach() {\n    this.activeTool = null, this._forEachTool(t => {\n      t.detach(), t.destroy();\n    }), this.tools.removeAll(), this.handles.remove(j);\n  }\n\n  forEachManipulator(t) {\n    this._forEachTool(o => {\n      o.manipulators && o.manipulators.forEach(({\n        manipulator: e\n      }) => t(e, o));\n    });\n  }\n\n  _handleInputEvent(t) {\n    let o = !1;\n    const e = { ...t,\n      stopPropagation: () => {\n        o = !0, t.stopPropagation();\n      }\n    };\n    r(this.activeTool) ? this.activeTool.handleInputEvent && this.activeTool.handleInputEvent(e) : this._forEachTool(t => {\n      !o && !1 !== t.visible && t.handleInputEvent && t.handleInputEvent(e);\n    }), !o && \"key-down\" === t.type && \"Escape\" === t.key && this.activeTool && (t.stopPropagation(), this.activeTool = null), this._manipulatorState.handleInputEvent(e, {\n      forEachTool: this._forEachTool,\n      activeTool: this.activeTool,\n      setActiveTool: t => {\n        this.activeTool = t;\n      },\n      creatingTool: this._creatingTool,\n      view: this.view\n    }), !o && r(this.activeTool) && this.activeTool.handleInputEventAfter && this.activeTool.handleInputEventAfter(e), this._manipulatorState.handleHoverEvent(e, this._forEachTool), this._updateCursor();\n  }\n\n  _refreshToolWatchers() {\n    this.handles.remove(b), this._forEachTool(t => {\n      if (t instanceof o) {\n        const o = p(t, [\"cursor\", \"visible\", \"editable\"], () => {\n          _(t) || this._manipulatorState.clearPointers(t, this._forEachTool), this._updateCursor();\n        });\n        this.handles.add(o, b);\n      }\n\n      t.manipulators && this.handles.add(t.manipulators.on(\"change\", o => {\n        o.removed.forEach(({\n          id: o\n        }) => {\n          this._manipulatorState.clearPointers(t, this._forEachTool, !0, o);\n        }), this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool), this._updateCursor();\n      }), b);\n    }), this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool), this._updateCursor();\n  }\n\n  _updateCursor() {\n    let t = null;\n    this._forEachTool(o => null != o.cursor && !1 !== o.visible && (t = o.cursor, !0)), t || (t = this._manipulatorState.cursor), this._get(\"cursor\") !== t && this._set(\"cursor\", t);\n  }\n\n  _rejectCreatingTool(t) {\n    const o = this._creatingTool;\n    s(o) || (this._manipulatorState.clearPointers(o, this._forEachTool), o.rejectCreation && o.rejectCreation(h(t)), w(o, !1), \"destroyed\" !== o.toolState && o.destroy(), this._creatingTool = null, this._refreshToolWatchers());\n  }\n\n  _removeIncompleteTools(t) {\n    this.tools.filter(o => (s(t) || o !== t) && null != o.completed && !o.completed).forEach(t => {\n      this.tools.remove(t);\n    });\n  }\n\n};\nt([u({\n  constructOnly: !0,\n  nonNullable: !0\n})], C.prototype, \"view\", void 0), t([u({\n  value: null\n})], C.prototype, \"activeTool\", null), t([u({\n  readOnly: !0,\n  type: e\n})], C.prototype, \"tools\", void 0), t([u({\n  readOnly: !0\n})], C.prototype, \"cursor\", void 0), t([u({\n  readOnly: !0\n})], C.prototype, \"updating\", null), C = t([d(\"esri.views.ToolViewManager\")], C);\nvar S = C;\nexport default S;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/ToolViewManager.js"],"names":["_","t","o","e","HandleOwner","i","a","isSome","r","isNone","s","throwIfAborted","l","onAbort","n","createAbortError","h","whenOnce","c","watch","p","property","u","subclass","d","ViewEventPriorities","v","eventTypes","m","newToolCollection","T","swap","f","areToolManipulatorsEditable","evaluateToolConstructorArguments","g","setActive","w","E","y","getLogger","j","b","C","constructor","_creatingTool","_manipulatorState","tools","cursor","_forEachTool","items","initialize","handles","add","view","on","_handleInputEvent","TOOL","item","includes","preventDefault","created","error","clearPointers","_refreshToolWatchers","destroy","activeTool","ready","_set","_removeIncompleteTools","setEditableFlag","_updateCursor","_rejectCreatingTool","updating","updatingHandles","some","createTool","abortHandle","tool","addPromise","whenReady","whenCreationStarted","attach","when","remove","completed","then","type","state","forEachManipulator","onViewChange","elevationProvider","onElevationChange","detach","removeAll","manipulators","forEach","manipulator","stopPropagation","handleInputEvent","visible","key","forEachTool","setActiveTool","creatingTool","handleInputEventAfter","handleHoverEvent","removed","id","updateHoveredStateFromKnownPointers","_get","rejectCreation","toolState","filter","constructOnly","nonNullable","prototype","value","readOnly","S"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as t}from\"../chunks/tslib.es6.js\";import o from\"../core/Accessor.js\";import e from\"../core/Collection.js\";import{HandleOwner as i}from\"../core/HandleOwner.js\";import a from\"../core/Logger.js\";import{isSome as r,isNone as s}from\"../core/maybe.js\";import{throwIfAborted as l,onAbort as n,createAbortError as h}from\"../core/promiseUtils.js\";import{whenOnce as c,watch as p}from\"../core/watchUtils.js\";import{property as u}from\"../core/accessorSupport/decorators/property.js\";import\"../core/has.js\";import\"../core/accessorSupport/ensureType.js\";import{subclass as d}from\"../core/accessorSupport/decorators/subclass.js\";import{ViewEventPriorities as v}from\"./input/InputManager.js\";import{eventTypes as m}from\"./input/ViewEvents.js\";import{newToolCollection as T,swap as f,areToolManipulatorsEditable as _,evaluateToolConstructorArguments as g,setActive as w}from\"./interactive/interactiveToolUtils.js\";import E from\"./interactive/ToolViewManagerManipulatorState.js\";const y=a.getLogger(\"esri.views.ToolViewManager\"),j=\"manipulators\",b=\"tools\";let C=class extends i{constructor(t){super(t),this._creatingTool=null,this._manipulatorState=new E,this.tools=T(),this.cursor=null,this._forEachTool=t=>{if(!r(this._creatingTool)||!t(this._creatingTool))for(const o of this.tools.items)if(t(o))return}}initialize(){this.handles.add([this.view.on(m,(t=>{this._handleInputEvent(t)}),v.TOOL),this.tools.on(\"before-add\",(t=>{const o=t.item;null==o||this.tools.includes(o)?t.preventDefault():null==o.created||o.created||(y.error(\"tools\",\"Tool can not be added to view before it has been created\"),t.preventDefault())})),this.tools.on(\"before-remove\",(({item:t})=>{this._manipulatorState.clearPointers(t,this._forEachTool)})),this.tools.on(\"change\",(()=>{this._refreshToolWatchers()}))])}destroy(){this._forEachTool((t=>t.destroy()))}set activeTool(t){!r(t)||this.view.ready?(f(this,t,(o=>{this._set(\"activeTool\",o),this._removeIncompleteTools(t),this._forEachTool((t=>{const o=s(this.activeTool)||t===this.activeTool;t.setEditableFlag&&t.setEditableFlag(1,o);const e=_(t);!s(this.activeTool)&&e||this._manipulatorState.clearPointers(t,this._forEachTool,!e)})),this._updateCursor()})),this._creatingTool!==t&&this._rejectCreatingTool()):y.error(\"#activeTool=\",\"cannot set active tool while view is not ready\")}get updating(){return this.updatingHandles.updating||this.tools.some((t=>t.updating))}async createTool(t,e,i){const a=\"Tool creation was interrupted by another tool being created\",{abortHandle:s,tool:h}=await this.updatingHandles.addPromise((async()=>{await this.view.whenReady(),l(i,a);const o=n(i,(()=>this.activeTool=null)),r=g(e),s=new t({...r,view:this.view});return await s.whenCreationStarted(),l(i,a),{abortHandle:o,tool:s}})());return this._rejectCreatingTool(a),this._creatingTool=h,h.attach(),this._refreshToolWatchers(),w(h,!0),await h.when(),r(s)&&s.remove(),this._creatingTool=null,l(i,a),this.tools.add(h),h instanceof o&&null!=h.completed&&c(h,\"completed\").then((()=>{w(h,!1)})),h}attach(){this._forEachTool((t=>t.attach())),\"3d\"===this.view.type?this.handles.add([this.view.state.watch(\"camera\",(()=>{this.forEachManipulator((t=>{null!=t.onViewChange&&t.onViewChange()}))})),this.view.elevationProvider.on(\"elevation-change\",(t=>{this.forEachManipulator((o=>{null!=o.onElevationChange&&o.onElevationChange(t)}))}))],j):this.handles.add(this.view.watch(\"extent\",(()=>{this.forEachManipulator((t=>{null!=t.onViewChange&&t.onViewChange()}))})))}detach(){this.activeTool=null,this._forEachTool((t=>{t.detach(),t.destroy()})),this.tools.removeAll(),this.handles.remove(j)}forEachManipulator(t){this._forEachTool((o=>{o.manipulators&&o.manipulators.forEach((({manipulator:e})=>t(e,o)))}))}_handleInputEvent(t){let o=!1;const e={...t,stopPropagation:()=>{o=!0,t.stopPropagation()}};r(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(e):this._forEachTool((t=>{!o&&!1!==t.visible&&t.handleInputEvent&&t.handleInputEvent(e)})),!o&&\"key-down\"===t.type&&\"Escape\"===t.key&&this.activeTool&&(t.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(e,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:t=>{this.activeTool=t},creatingTool:this._creatingTool,view:this.view}),!o&&r(this.activeTool)&&this.activeTool.handleInputEventAfter&&this.activeTool.handleInputEventAfter(e),this._manipulatorState.handleHoverEvent(e,this._forEachTool),this._updateCursor()}_refreshToolWatchers(){this.handles.remove(b),this._forEachTool((t=>{if(t instanceof o){const o=p(t,[\"cursor\",\"visible\",\"editable\"],(()=>{_(t)||this._manipulatorState.clearPointers(t,this._forEachTool),this._updateCursor()}));this.handles.add(o,b)}t.manipulators&&this.handles.add(t.manipulators.on(\"change\",(o=>{o.removed.forEach((({id:o})=>{this._manipulatorState.clearPointers(t,this._forEachTool,!0,o)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()})),b)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateCursor(){let t=null;this._forEachTool((o=>null!=o.cursor&&!1!==o.visible&&(t=o.cursor,!0))),t||(t=this._manipulatorState.cursor),this._get(\"cursor\")!==t&&this._set(\"cursor\",t)}_rejectCreatingTool(t){const o=this._creatingTool;s(o)||(this._manipulatorState.clearPointers(o,this._forEachTool),o.rejectCreation&&o.rejectCreation(h(t)),w(o,!1),\"destroyed\"!==o.toolState&&o.destroy(),this._creatingTool=null,this._refreshToolWatchers())}_removeIncompleteTools(t){this.tools.filter((o=>(s(t)||o!==t)&&null!=o.completed&&!o.completed)).forEach((t=>{this.tools.remove(t)}))}};t([u({constructOnly:!0,nonNullable:!0})],C.prototype,\"view\",void 0),t([u({value:null})],C.prototype,\"activeTool\",null),t([u({readOnly:!0,type:e})],C.prototype,\"tools\",void 0),t([u({readOnly:!0})],C.prototype,\"cursor\",void 0),t([u({readOnly:!0})],C.prototype,\"updating\",null),C=t([d(\"esri.views.ToolViewManager\")],C);var S=C;export default S;\n"]},"metadata":{},"sourceType":"module"}