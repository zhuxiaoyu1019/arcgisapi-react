{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../chunks/tslib.es6.js\";\nimport r from \"../../../../core/Accessor.js\";\nimport t from \"../../../../core/Error.js\";\nimport s from \"../../../../core/Handles.js\";\nimport { isNone as n } from \"../../../../core/maybe.js\";\nimport { property as o } from \"../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../core/has.js\";\nimport \"../../../../core/accessorSupport/ensureType.js\";\nimport \"../../../../core/Logger.js\";\nimport { subclass as i } from \"../../../../core/accessorSupport/decorators/subclass.js\";\nimport a from \"../../../../geometry/Extent.js\";\nimport u from \"../../../../layers/graphics/data/QueryEngine.js\";\nimport y from \"../../../../rest/support/FeatureSet.js\";\nimport c from \"../../../../rest/support/Query.js\";\nconst l = u;\nlet p = class extends r {\n  constructor(e) {\n    super(e), this._dataQueryEngineInstance = null, this._handles = new s();\n  }\n\n  get defaultQueryJSON() {\n    return new c({\n      outSpatialReference: this.spatialReference\n    }).toJSON();\n  }\n\n  get dataQueryEngine() {\n    return this.ensureDataQueryEngine();\n  }\n\n  initialize() {\n    this._handles.add(this.layerView.on(\"visible-geometry-changed\", () => this.spatialIndex.events.emit(\"changed\")));\n  }\n\n  destroy() {\n    this._dataQueryEngineInstance && (this._dataQueryEngineInstance.destroy(), this._dataQueryEngineInstance = null), this._handles && (this._handles.destroy(), this._handles = null), this._set(\"layerView\", null);\n  }\n\n  async executeQueryForCount(e, r) {\n    return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e), r);\n  }\n\n  async executeQueryForExtent(e, r) {\n    const {\n      count: t,\n      extent: s\n    } = await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e), r);\n    return {\n      count: t,\n      extent: a.fromJSON(s)\n    };\n  }\n\n  async executeQueryForIds(e, r) {\n    return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e), r);\n  }\n\n  async executeQuery(e, r) {\n    const s = this._ensureQueryJSON(e);\n\n    if (s.returnGeometry) throw new t(\"feature-store:unsupported-query\", \"returnGeometry is not yet supported for mesh scene layer queries\");\n    if (s.returnCentroid) throw new t(\"feature-store:unsupported-query\", \"returnCentroid is not yet supported for mesh scene layer queries\");\n    const n = await this.dataQueryEngine.executeQuery(s, r),\n          o = y.fromJSON(n);\n    return o.features.forEach(e => {\n      e.geometry = null;\n    }), o;\n  }\n\n  _ensureQueryJSON(e) {\n    if (n(e)) return this.defaultQueryJSON;\n    const r = e.toJSON();\n    return r.outSpatialReference || (e.outSpatialReference = this.spatialReference), r;\n  }\n\n  ensureDataQueryEngine() {\n    if (this._dataQueryEngineInstance) return this._dataQueryEngineInstance;\n    const e = this.layer.objectIdField || \"OBJECTID\",\n          r = \"esriGeometryPolygon\",\n          t = this.layer.fields.map(e => e.toJSON()),\n          s = this.layerView.view.resourceController.scheduler,\n          n = this.spatialReference.toJSON(),\n          o = this.priority,\n          i = this.spatialIndex;\n    return this._dataQueryEngineInstance = new l({\n      hasZ: !0,\n      hasM: !1,\n      geometryType: r,\n      fields: t,\n      timeInfo: null,\n      spatialReference: n,\n      objectIdField: e,\n      featureStore: i,\n      scheduler: s,\n      priority: o\n    }), this._dataQueryEngineInstance;\n  }\n\n};\ne([o({\n  constructOnly: !0\n})], p.prototype, \"layerView\", void 0), e([o({\n  constructOnly: !0\n})], p.prototype, \"priority\", void 0), e([o({\n  constructOnly: !0\n})], p.prototype, \"spatialIndex\", void 0), e([o({\n  readOnly: !0,\n  aliasOf: \"layerView.view.spatialReference\"\n})], p.prototype, \"spatialReference\", void 0), e([o({\n  readOnly: !0,\n  aliasOf: \"layerView.i3slayer\"\n})], p.prototype, \"layer\", void 0), e([o({\n  readOnly: !0\n})], p.prototype, \"defaultQueryJSON\", null), p = e([i(\"esri.views.3d.layers.i3s.I3SQueryEngine\")], p);\nvar d = p;\nexport default d;\nexport { p as I3SQueryEngine };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/layers/i3s/I3SQueryEngine.js"],"names":["_","e","r","t","s","isNone","n","property","o","subclass","i","a","u","y","c","l","p","constructor","_dataQueryEngineInstance","_handles","defaultQueryJSON","outSpatialReference","spatialReference","toJSON","dataQueryEngine","ensureDataQueryEngine","initialize","add","layerView","on","spatialIndex","events","emit","destroy","_set","executeQueryForCount","_ensureQueryJSON","executeQueryForExtent","count","extent","fromJSON","executeQueryForIds","executeQuery","returnGeometry","returnCentroid","features","forEach","geometry","layer","objectIdField","fields","map","view","resourceController","scheduler","priority","hasZ","hasM","geometryType","timeInfo","featureStore","constructOnly","prototype","readOnly","aliasOf","d","I3SQueryEngine"],"mappings":"AAAA;AACA;AACA;AACA;AACA,SAAOA,CAAC,IAAIC,CAAZ,QAAkB,iCAAlB;AAAoD,OAAOC,CAAP,MAAa,8BAAb;AAA4C,OAAOC,CAAP,MAAa,2BAAb;AAAyC,OAAOC,CAAP,MAAa,6BAAb;AAA2C,SAAOC,MAAM,IAAIC,CAAjB,QAAuB,2BAAvB;AAAmD,SAAOC,QAAQ,IAAIC,CAAnB,QAAyB,yDAAzB;AAAmF,OAAM,yBAAN;AAAgC,OAAM,gDAAN;AAAuD,OAAM,4BAAN;AAAmC,SAAOC,QAAQ,IAAIC,CAAnB,QAAyB,yDAAzB;AAAmF,OAAOC,CAAP,MAAa,gCAAb;AAA8C,OAAOC,CAAP,MAAa,iDAAb;AAA+D,OAAOC,CAAP,MAAa,wCAAb;AAAsD,OAAOC,CAAP,MAAa,mCAAb;AAAiD,MAAMC,CAAC,GAACH,CAAR;AAAU,IAAII,CAAC,GAAC,cAAcd,CAAd,CAAe;AAACe,EAAAA,WAAW,CAAChB,CAAD,EAAG;AAAC,UAAMA,CAAN,GAAS,KAAKiB,wBAAL,GAA8B,IAAvC,EAA4C,KAAKC,QAAL,GAAc,IAAIf,CAAJ,EAA1D;AAAgE;;AAAoB,MAAhBgB,gBAAgB,GAAE;AAAC,WAAO,IAAIN,CAAJ,CAAM;AAACO,MAAAA,mBAAmB,EAAC,KAAKC;AAA1B,KAAN,EAAmDC,MAAnD,EAAP;AAAmE;;AAAmB,MAAfC,eAAe,GAAE;AAAC,WAAO,KAAKC,qBAAL,EAAP;AAAoC;;AAAAC,EAAAA,UAAU,GAAE;AAAC,SAAKP,QAAL,CAAcQ,GAAd,CAAkB,KAAKC,SAAL,CAAeC,EAAf,CAAkB,0BAAlB,EAA8C,MAAI,KAAKC,YAAL,CAAkBC,MAAlB,CAAyBC,IAAzB,CAA8B,SAA9B,CAAlD,CAAlB;AAAgH;;AAAAC,EAAAA,OAAO,GAAE;AAAC,SAAKf,wBAAL,KAAgC,KAAKA,wBAAL,CAA8Be,OAA9B,IAAwC,KAAKf,wBAAL,GAA8B,IAAtG,GAA4G,KAAKC,QAAL,KAAgB,KAAKA,QAAL,CAAcc,OAAd,IAAwB,KAAKd,QAAL,GAAc,IAAtD,CAA5G,EAAwK,KAAKe,IAAL,CAAU,WAAV,EAAsB,IAAtB,CAAxK;AAAoM;;AAA0B,QAApBC,oBAAoB,CAAClC,CAAD,EAAGC,CAAH,EAAK;AAAC,WAAO,KAAKsB,eAAL,CAAqBW,oBAArB,CAA0C,KAAKC,gBAAL,CAAsBnC,CAAtB,CAA1C,EAAmEC,CAAnE,CAAP;AAA6E;;AAA2B,QAArBmC,qBAAqB,CAACpC,CAAD,EAAGC,CAAH,EAAK;AAAC,UAAK;AAACoC,MAAAA,KAAK,EAACnC,CAAP;AAASoC,MAAAA,MAAM,EAACnC;AAAhB,QAAmB,MAAM,KAAKoB,eAAL,CAAqBa,qBAArB,CAA2C,KAAKD,gBAAL,CAAsBnC,CAAtB,CAA3C,EAAoEC,CAApE,CAA9B;AAAqG,WAAM;AAACoC,MAAAA,KAAK,EAACnC,CAAP;AAASoC,MAAAA,MAAM,EAAC5B,CAAC,CAAC6B,QAAF,CAAWpC,CAAX;AAAhB,KAAN;AAAqC;;AAAwB,QAAlBqC,kBAAkB,CAACxC,CAAD,EAAGC,CAAH,EAAK;AAAC,WAAO,KAAKsB,eAAL,CAAqBiB,kBAArB,CAAwC,KAAKL,gBAAL,CAAsBnC,CAAtB,CAAxC,EAAiEC,CAAjE,CAAP;AAA2E;;AAAkB,QAAZwC,YAAY,CAACzC,CAAD,EAAGC,CAAH,EAAK;AAAC,UAAME,CAAC,GAAC,KAAKgC,gBAAL,CAAsBnC,CAAtB,CAAR;;AAAiC,QAAGG,CAAC,CAACuC,cAAL,EAAoB,MAAM,IAAIxC,CAAJ,CAAM,iCAAN,EAAwC,kEAAxC,CAAN;AAAkH,QAAGC,CAAC,CAACwC,cAAL,EAAoB,MAAM,IAAIzC,CAAJ,CAAM,iCAAN,EAAwC,kEAAxC,CAAN;AAAkH,UAAMG,CAAC,GAAC,MAAM,KAAKkB,eAAL,CAAqBkB,YAArB,CAAkCtC,CAAlC,EAAoCF,CAApC,CAAd;AAAA,UAAqDM,CAAC,GAACK,CAAC,CAAC2B,QAAF,CAAWlC,CAAX,CAAvD;AAAqE,WAAOE,CAAC,CAACqC,QAAF,CAAWC,OAAX,CAAoB7C,CAAC,IAAE;AAACA,MAAAA,CAAC,CAAC8C,QAAF,GAAW,IAAX;AAAgB,KAAxC,GAA2CvC,CAAlD;AAAoD;;AAAA4B,EAAAA,gBAAgB,CAACnC,CAAD,EAAG;AAAC,QAAGK,CAAC,CAACL,CAAD,CAAJ,EAAQ,OAAO,KAAKmB,gBAAZ;AAA6B,UAAMlB,CAAC,GAACD,CAAC,CAACsB,MAAF,EAAR;AAAmB,WAAOrB,CAAC,CAACmB,mBAAF,KAAwBpB,CAAC,CAACoB,mBAAF,GAAsB,KAAKC,gBAAnD,GAAqEpB,CAA5E;AAA8E;;AAAAuB,EAAAA,qBAAqB,GAAE;AAAC,QAAG,KAAKP,wBAAR,EAAiC,OAAO,KAAKA,wBAAZ;AAAqC,UAAMjB,CAAC,GAAC,KAAK+C,KAAL,CAAWC,aAAX,IAA0B,UAAlC;AAAA,UAA6C/C,CAAC,GAAC,qBAA/C;AAAA,UAAqEC,CAAC,GAAC,KAAK6C,KAAL,CAAWE,MAAX,CAAkBC,GAAlB,CAAuBlD,CAAC,IAAEA,CAAC,CAACsB,MAAF,EAA1B,CAAvE;AAAA,UAA8GnB,CAAC,GAAC,KAAKwB,SAAL,CAAewB,IAAf,CAAoBC,kBAApB,CAAuCC,SAAvJ;AAAA,UAAiKhD,CAAC,GAAC,KAAKgB,gBAAL,CAAsBC,MAAtB,EAAnK;AAAA,UAAkMf,CAAC,GAAC,KAAK+C,QAAzM;AAAA,UAAkN7C,CAAC,GAAC,KAAKoB,YAAzN;AAAsO,WAAO,KAAKZ,wBAAL,GAA8B,IAAIH,CAAJ,CAAM;AAACyC,MAAAA,IAAI,EAAC,CAAC,CAAP;AAASC,MAAAA,IAAI,EAAC,CAAC,CAAf;AAAiBC,MAAAA,YAAY,EAACxD,CAA9B;AAAgCgD,MAAAA,MAAM,EAAC/C,CAAvC;AAAyCwD,MAAAA,QAAQ,EAAC,IAAlD;AAAuDrC,MAAAA,gBAAgB,EAAChB,CAAxE;AAA0E2C,MAAAA,aAAa,EAAChD,CAAxF;AAA0F2D,MAAAA,YAAY,EAAClD,CAAvG;AAAyG4C,MAAAA,SAAS,EAAClD,CAAnH;AAAqHmD,MAAAA,QAAQ,EAAC/C;AAA9H,KAAN,CAA9B,EAAsK,KAAKU,wBAAlL;AAA2M;;AAAvhE,CAArB;AAA8iEjB,CAAC,CAAC,CAACO,CAAC,CAAC;AAACqD,EAAAA,aAAa,EAAC,CAAC;AAAhB,CAAD,CAAF,CAAD,EAAyB7C,CAAC,CAAC8C,SAA3B,EAAqC,WAArC,EAAiD,KAAK,CAAtD,CAAD,EAA0D7D,CAAC,CAAC,CAACO,CAAC,CAAC;AAACqD,EAAAA,aAAa,EAAC,CAAC;AAAhB,CAAD,CAAF,CAAD,EAAyB7C,CAAC,CAAC8C,SAA3B,EAAqC,UAArC,EAAgD,KAAK,CAArD,CAA3D,EAAmH7D,CAAC,CAAC,CAACO,CAAC,CAAC;AAACqD,EAAAA,aAAa,EAAC,CAAC;AAAhB,CAAD,CAAF,CAAD,EAAyB7C,CAAC,CAAC8C,SAA3B,EAAqC,cAArC,EAAoD,KAAK,CAAzD,CAApH,EAAgL7D,CAAC,CAAC,CAACO,CAAC,CAAC;AAACuD,EAAAA,QAAQ,EAAC,CAAC,CAAX;AAAaC,EAAAA,OAAO,EAAC;AAArB,CAAD,CAAF,CAAD,EAA8DhD,CAAC,CAAC8C,SAAhE,EAA0E,kBAA1E,EAA6F,KAAK,CAAlG,CAAjL,EAAsR7D,CAAC,CAAC,CAACO,CAAC,CAAC;AAACuD,EAAAA,QAAQ,EAAC,CAAC,CAAX;AAAaC,EAAAA,OAAO,EAAC;AAArB,CAAD,CAAF,CAAD,EAAiDhD,CAAC,CAAC8C,SAAnD,EAA6D,OAA7D,EAAqE,KAAK,CAA1E,CAAvR,EAAoW7D,CAAC,CAAC,CAACO,CAAC,CAAC;AAACuD,EAAAA,QAAQ,EAAC,CAAC;AAAX,CAAD,CAAF,CAAD,EAAoB/C,CAAC,CAAC8C,SAAtB,EAAgC,kBAAhC,EAAmD,IAAnD,CAArW,EAA8Z9C,CAAC,GAACf,CAAC,CAAC,CAACS,CAAC,CAAC,yCAAD,CAAF,CAAD,EAAgDM,CAAhD,CAAja;AAAod,IAAIiD,CAAC,GAACjD,CAAN;AAAQ,eAAeiD,CAAf;AAAiB,SAAOjD,CAAC,IAAIkD,cAAZ","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../chunks/tslib.es6.js\";import r from\"../../../../core/Accessor.js\";import t from\"../../../../core/Error.js\";import s from\"../../../../core/Handles.js\";import{isNone as n}from\"../../../../core/maybe.js\";import{property as o}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/ensureType.js\";import\"../../../../core/Logger.js\";import{subclass as i}from\"../../../../core/accessorSupport/decorators/subclass.js\";import a from\"../../../../geometry/Extent.js\";import u from\"../../../../layers/graphics/data/QueryEngine.js\";import y from\"../../../../rest/support/FeatureSet.js\";import c from\"../../../../rest/support/Query.js\";const l=u;let p=class extends r{constructor(e){super(e),this._dataQueryEngineInstance=null,this._handles=new s}get defaultQueryJSON(){return new c({outSpatialReference:this.spatialReference}).toJSON()}get dataQueryEngine(){return this.ensureDataQueryEngine()}initialize(){this._handles.add(this.layerView.on(\"visible-geometry-changed\",(()=>this.spatialIndex.events.emit(\"changed\"))))}destroy(){this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null),this._handles&&(this._handles.destroy(),this._handles=null),this._set(\"layerView\",null)}async executeQueryForCount(e,r){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),r)}async executeQueryForExtent(e,r){const{count:t,extent:s}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),r);return{count:t,extent:a.fromJSON(s)}}async executeQueryForIds(e,r){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),r)}async executeQuery(e,r){const s=this._ensureQueryJSON(e);if(s.returnGeometry)throw new t(\"feature-store:unsupported-query\",\"returnGeometry is not yet supported for mesh scene layer queries\");if(s.returnCentroid)throw new t(\"feature-store:unsupported-query\",\"returnCentroid is not yet supported for mesh scene layer queries\");const n=await this.dataQueryEngine.executeQuery(s,r),o=y.fromJSON(n);return o.features.forEach((e=>{e.geometry=null})),o}_ensureQueryJSON(e){if(n(e))return this.defaultQueryJSON;const r=e.toJSON();return r.outSpatialReference||(e.outSpatialReference=this.spatialReference),r}ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e=this.layer.objectIdField||\"OBJECTID\",r=\"esriGeometryPolygon\",t=this.layer.fields.map((e=>e.toJSON())),s=this.layerView.view.resourceController.scheduler,n=this.spatialReference.toJSON(),o=this.priority,i=this.spatialIndex;return this._dataQueryEngineInstance=new l({hasZ:!0,hasM:!1,geometryType:r,fields:t,timeInfo:null,spatialReference:n,objectIdField:e,featureStore:i,scheduler:s,priority:o}),this._dataQueryEngineInstance}};e([o({constructOnly:!0})],p.prototype,\"layerView\",void 0),e([o({constructOnly:!0})],p.prototype,\"priority\",void 0),e([o({constructOnly:!0})],p.prototype,\"spatialIndex\",void 0),e([o({readOnly:!0,aliasOf:\"layerView.view.spatialReference\"})],p.prototype,\"spatialReference\",void 0),e([o({readOnly:!0,aliasOf:\"layerView.i3slayer\"})],p.prototype,\"layer\",void 0),e([o({readOnly:!0})],p.prototype,\"defaultQueryJSON\",null),p=e([i(\"esri.views.3d.layers.i3s.I3SQueryEngine\")],p);var d=p;export default d;export{p as I3SQueryEngine};\n"]},"metadata":{},"sourceType":"module"}