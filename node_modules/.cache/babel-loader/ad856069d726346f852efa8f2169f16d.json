{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isSome as s } from \"../../../../../core/maybe.js\";\nimport { f as a, t as e, e as i } from \"../../../../../chunks/mat3.js\";\nimport { c as t } from \"../../../../../chunks/mat3f64.js\";\nimport { d as r } from \"../../../../../chunks/mat4.js\";\nimport { s as h } from \"../../../../../chunks/vec2.js\";\nimport { b as m, s as n, g as o, f as l } from \"../../../../../chunks/vec3.js\";\nimport { c as P } from \"../../../../../chunks/vec3f64.js\";\nimport { c as p } from \"../../../../../chunks/vec4.js\";\nimport { d as c } from \"../../../../../chunks/boundedPlane.js\";\nimport { MaterialPassesParameters as d, ShadowMapPassParameters as _, HighlightPassParameters as u } from \"./AllRenderPasses.js\";\nimport { RenderPass as g } from \"./RenderPass.js\";\nimport { TwoVectorPosition as w } from \"../util/TwoVectorPosition.js\";\nimport { union as f } from \"../../lib/depthRange.js\";\n\nclass b {\n  constructor(s, a) {\n    this.rctx = s, this.shaderTechniqueRepository = a, this.canRender = !0, this._materialPassParams = new d(), this._shadowPassParams = new _(), this._highlightPassParams = new u(), this._systems = new Set(), this._passes = new Array(), this._shadowMapPass = this._registerPass(new g(s, this.shaderTechniqueRepository)), this.passes = {\n      materialOpaque: this._registerPass(new g(s, this.shaderTechniqueRepository)),\n      materialTransparent: this._registerPass(new g(s, this.shaderTechniqueRepository, 1)),\n      materialIntegratedMesh: this._registerPass(new g(s, this.shaderTechniqueRepository)),\n      shadowMap: this._shadowMapPass,\n      highlight: this._registerPass(new g(s, this.shaderTechniqueRepository)),\n      highlightIntegratedMesh: this._registerPass(new g(s, this.shaderTechniqueRepository)),\n      highlightShadowMap: this._registerPass(new g(s, this.shaderTechniqueRepository)),\n      defaultShadowMap: this._registerPass(new g(s, this.shaderTechniqueRepository))\n    };\n  }\n\n  register(s) {\n    this._systems.add(s);\n  }\n\n  prepareRender(s) {\n    0 !== this._systems.size && (this._passes.forEach(s => s.prepareSubmit()), this._systems.forEach(a => a.submit(this.passes, {\n      camera: s\n    })), this._passes.forEach(s => s.finishSubmit()), this.shaderTechniqueRepository.frameUpdate());\n  }\n\n  render(a) {\n    if (0 === this._systems.size) return !1;\n    if (4 === a.slot) switch (this._configure(a), a.pass) {\n      case 0:\n        this._materialPassParams.subPass = 0, this._configureMaterialColorPass(a), this.passes.materialOpaque.dispatch(this._materialPassParams);\n        break;\n\n      case 2:\n        this._materialPassParams.subPass = 2, this.passes.materialOpaque.dispatch(this._materialPassParams);\n        break;\n\n      case 3:\n        this._materialPassParams.subPass = 3, this.passes.materialOpaque.dispatch(this._materialPassParams);\n        break;\n\n      case 5:\n        this.passes.highlight.dispatch(this._highlightPassParams);\n        break;\n\n      case 4:\n        this._shadowMapPass.dispatch(this._shadowPassParams);\n\n        break;\n\n      case 7:\n        s(this.passes.highlightShadowMap) && this.passes.highlightShadowMap.dispatch(this._shadowPassParams);\n        break;\n\n      case 6:\n        s(this.passes.defaultShadowMap) && this.passes.defaultShadowMap.dispatch(this._shadowPassParams);\n    }\n    if (6 === a.slot) switch (this._configure(a), a.pass) {\n      case 0:\n        this._materialPassParams.subPass = 0, this._configureMaterialColorPass(a), this.passes.materialTransparent.dispatch(this._materialPassParams);\n        break;\n\n      case 1:\n        this._materialPassParams.subPass = 1, this._configureMaterialColorPass(a), this.passes.materialTransparent.dispatch(this._materialPassParams);\n        break;\n\n      case 2:\n        this._materialPassParams.subPass = 2, this.passes.materialTransparent.dispatch(this._materialPassParams);\n        break;\n\n      case 3:\n        this._materialPassParams.subPass = 3, this.passes.materialTransparent.dispatch(this._materialPassParams);\n    }\n    if (1 === a.slot) switch (this._configure(a), a.pass) {\n      case 0:\n        this._materialPassParams.subPass = 0, this._configureMaterialColorPass(a), this._materialPassParams.ssrParams = a.ssrParams, this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);\n        break;\n\n      case 2:\n        this._materialPassParams.subPass = 2, this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);\n        break;\n\n      case 3:\n        this._materialPassParams.subPass = 3, this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);\n        break;\n\n      case 5:\n        this.passes.highlightIntegratedMesh.dispatch(this._highlightPassParams);\n    }\n    return !0;\n  }\n\n  notifyDirty() {\n    this.context.requestRender();\n  }\n\n  slots() {\n    return [4, 6, 1];\n  }\n\n  initializeRenderContext(s) {\n    this.context = s;\n  }\n\n  uninitializeRenderContext() {}\n\n  queryDepthRange(a) {\n    const e = {\n      near: 1 / 0,\n      far: -1 / 0\n    };\n    return this._systems.forEach(i => {\n      const t = i.queryShadowCasterDepthRange(a);\n      s(t) && f(e, t, e);\n    }), e;\n  }\n\n  get shadowCastingEnabled() {\n    return s(this.passes.shadowMap);\n  }\n\n  set shadowCastingEnabled(s) {\n    s ? (this._materialPassParams.shadowsEnabled = !0, this.passes.shadowMap = this._shadowMapPass) : (this._materialPassParams.shadowsEnabled = !1, this.passes.shadowMap = null);\n  }\n\n  get screenSpaceReflectionsEnabled() {\n    return s(this._materialPassParams.ssrParams.ssrEnabled);\n  }\n\n  set screenSpaceReflectionsEnabled(s) {\n    this._materialPassParams.ssrParams.ssrEnabled = !!s;\n  }\n\n  _configureMaterialColorPass(s) {\n    this._materialPassParams.bindShadowMap = a => {\n      s.shadowMap.bind(a);\n      const e = this._materialPassParams.viewTransform;\n      m(M, e.worldFromView_TL, e.worldFromView_TH), s.shadowMap.bindView(a, M);\n    }, this._materialPassParams.bindAmbientOcclusion = a => s.ssaoHelper.bind(a), this._materialPassParams.ambientOcclusionEnabled = !!s.ssaoHelper && s.ssaoHelper.ready, this._materialPassParams.sceneHasOcludees = s.hasOccludees;\n  }\n\n  _configure(s) {\n    const a = 4 === s.pass || 7 === s.pass || 6 === s.pass ? this._shadowPassParams : 5 === s.pass ? this._highlightPassParams : this._materialPassParams;\n\n    this._updateParameters(s, a);\n  }\n\n  _updateParameters(s, t) {\n    const m = s.camera,\n          P = m.viewInverseTransposeMatrix;\n    n(M, P[3], P[7], P[11]), y.set(M), o(t.viewTransform.worldFromView_TH, y.high), o(t.viewTransform.worldFromView_TL, y.low), a(t.viewTransform.viewFromCameraRelative_RS, m.viewMatrix), r(t.viewTransform.projFromView, m.projectionMatrix), 0 === t.identifier ? (this._materialPassParams.transparent = 6 === s.slot, this._materialPassParams.integratedMesh = 1 === s.slot, this._materialPassParams.lighting = s.scenelightingData, e(T, t.viewTransform.viewFromCameraRelative_RS), i(t.transformNormal_ViewFromGlobal, T), h(t.cameraNearFar, m.near, m.far)) : 1 === t.identifier ? h(t.cameraNearFar, m.near, m.far) : 2 === t.identifier && (t.highlightDepthTexture = s.highlightDepthTexture, p(t.viewport, m.fullViewport)), 0 !== t.identifier && 2 !== t.identifier || (t.inverseViewport[0] = 1 / m.fullViewport[2], t.inverseViewport[1] = 1 / m.fullViewport[3]), c(s.sliceHelper.plane, t.slicePlane), l(t.slicePlane.origin, t.slicePlane.origin, M), t.slicePlaneEnabled = s.sliceHelper.isEnabled, this._materialPassParams.transparencyPassType = s.transparencyPassType, this._materialPassParams.multipassTerrainParams = s.multipassTerrainParams;\n  }\n\n  _registerPass(s) {\n    return this._passes.push(s), s;\n  }\n\n  get needsHighlight() {\n    return this.passes.highlight.count > 0 || this.passes.highlightIntegratedMesh.count > 0;\n  }\n\n}\n\nconst M = P(),\n      T = t(),\n      y = new w();\nexport { b as RenderPassManager };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/webgl-engine/core/renderPasses/RenderPassManager.js"],"names":["isSome","s","f","a","t","e","i","c","d","r","h","b","m","n","g","o","l","P","p","MaterialPassesParameters","ShadowMapPassParameters","_","HighlightPassParameters","u","RenderPass","TwoVectorPosition","w","union","constructor","rctx","shaderTechniqueRepository","canRender","_materialPassParams","_shadowPassParams","_highlightPassParams","_systems","Set","_passes","Array","_shadowMapPass","_registerPass","passes","materialOpaque","materialTransparent","materialIntegratedMesh","shadowMap","highlight","highlightIntegratedMesh","highlightShadowMap","defaultShadowMap","register","add","prepareRender","size","forEach","prepareSubmit","submit","camera","finishSubmit","frameUpdate","render","slot","_configure","pass","subPass","_configureMaterialColorPass","dispatch","ssrParams","notifyDirty","context","requestRender","slots","initializeRenderContext","uninitializeRenderContext","queryDepthRange","near","far","queryShadowCasterDepthRange","shadowCastingEnabled","shadowsEnabled","screenSpaceReflectionsEnabled","ssrEnabled","bindShadowMap","bind","viewTransform","M","worldFromView_TL","worldFromView_TH","bindView","bindAmbientOcclusion","ssaoHelper","ambientOcclusionEnabled","ready","sceneHasOcludees","hasOccludees","_updateParameters","viewInverseTransposeMatrix","y","set","high","low","viewFromCameraRelative_RS","viewMatrix","projFromView","projectionMatrix","identifier","transparent","integratedMesh","lighting","scenelightingData","T","transformNormal_ViewFromGlobal","cameraNearFar","highlightDepthTexture","viewport","fullViewport","inverseViewport","sliceHelper","plane","slicePlane","origin","slicePlaneEnabled","isEnabled","transparencyPassType","multipassTerrainParams","push","needsHighlight","count","RenderPassManager"],"mappings":"AAAA;AACA;AACA;AACA;AACA,SAAOA,MAAM,IAAIC,CAAjB,QAAuB,8BAAvB;AAAsD,SAAOC,CAAC,IAAIC,CAAZ,EAAcC,CAAC,IAAIC,CAAnB,EAAqBA,CAAC,IAAIC,CAA1B,QAAgC,+BAAhC;AAAgE,SAAOC,CAAC,IAAIH,CAAZ,QAAkB,kCAAlB;AAAqD,SAAOI,CAAC,IAAIC,CAAZ,QAAkB,+BAAlB;AAAkD,SAAOR,CAAC,IAAIS,CAAZ,QAAkB,+BAAlB;AAAkD,SAAOC,CAAC,IAAIC,CAAZ,EAAcX,CAAC,IAAIY,CAAnB,EAAqBC,CAAC,IAAIC,CAA1B,EAA4Bb,CAAC,IAAIc,CAAjC,QAAuC,+BAAvC;AAAuE,SAAOT,CAAC,IAAIU,CAAZ,QAAkB,kCAAlB;AAAqD,SAAOV,CAAC,IAAIW,CAAZ,QAAkB,+BAAlB;AAAkD,SAAOV,CAAC,IAAID,CAAZ,QAAkB,uCAAlB;AAA0D,SAAOY,wBAAwB,IAAIX,CAAnC,EAAqCY,uBAAuB,IAAIC,CAAhE,EAAkEC,uBAAuB,IAAIC,CAA7F,QAAmG,sBAAnG;AAA0H,SAAOC,UAAU,IAAIV,CAArB,QAA2B,iBAA3B;AAA6C,SAAOW,iBAAiB,IAAIC,CAA5B,QAAkC,8BAAlC;AAAiE,SAAOC,KAAK,IAAIzB,CAAhB,QAAsB,yBAAtB;;AAAgD,MAAMS,CAAN,CAAO;AAACiB,EAAAA,WAAW,CAAC3B,CAAD,EAAGE,CAAH,EAAK;AAAC,SAAK0B,IAAL,GAAU5B,CAAV,EAAY,KAAK6B,yBAAL,GAA+B3B,CAA3C,EAA6C,KAAK4B,SAAL,GAAe,CAAC,CAA7D,EAA+D,KAAKC,mBAAL,GAAyB,IAAIxB,CAAJ,EAAxF,EAA8F,KAAKyB,iBAAL,GAAuB,IAAIZ,CAAJ,EAArH,EAA2H,KAAKa,oBAAL,GAA0B,IAAIX,CAAJ,EAArJ,EAA2J,KAAKY,QAAL,GAAc,IAAIC,GAAJ,EAAzK,EAAiL,KAAKC,OAAL,GAAa,IAAIC,KAAJ,EAA9L,EAAwM,KAAKC,cAAL,GAAoB,KAAKC,aAAL,CAAmB,IAAI1B,CAAJ,CAAMb,CAAN,EAAQ,KAAK6B,yBAAb,CAAnB,CAA5N,EAAwR,KAAKW,MAAL,GAAY;AAACC,MAAAA,cAAc,EAAC,KAAKF,aAAL,CAAmB,IAAI1B,CAAJ,CAAMb,CAAN,EAAQ,KAAK6B,yBAAb,CAAnB,CAAhB;AAA4Ea,MAAAA,mBAAmB,EAAC,KAAKH,aAAL,CAAmB,IAAI1B,CAAJ,CAAMb,CAAN,EAAQ,KAAK6B,yBAAb,EAAuC,CAAvC,CAAnB,CAAhG;AAA8Jc,MAAAA,sBAAsB,EAAC,KAAKJ,aAAL,CAAmB,IAAI1B,CAAJ,CAAMb,CAAN,EAAQ,KAAK6B,yBAAb,CAAnB,CAArL;AAAiPe,MAAAA,SAAS,EAAC,KAAKN,cAAhQ;AAA+QO,MAAAA,SAAS,EAAC,KAAKN,aAAL,CAAmB,IAAI1B,CAAJ,CAAMb,CAAN,EAAQ,KAAK6B,yBAAb,CAAnB,CAAzR;AAAqViB,MAAAA,uBAAuB,EAAC,KAAKP,aAAL,CAAmB,IAAI1B,CAAJ,CAAMb,CAAN,EAAQ,KAAK6B,yBAAb,CAAnB,CAA7W;AAAyakB,MAAAA,kBAAkB,EAAC,KAAKR,aAAL,CAAmB,IAAI1B,CAAJ,CAAMb,CAAN,EAAQ,KAAK6B,yBAAb,CAAnB,CAA5b;AAAwfmB,MAAAA,gBAAgB,EAAC,KAAKT,aAAL,CAAmB,IAAI1B,CAAJ,CAAMb,CAAN,EAAQ,KAAK6B,yBAAb,CAAnB;AAAzgB,KAApS;AAA02B;;AAAAoB,EAAAA,QAAQ,CAACjD,CAAD,EAAG;AAAC,SAAKkC,QAAL,CAAcgB,GAAd,CAAkBlD,CAAlB;AAAqB;;AAAAmD,EAAAA,aAAa,CAACnD,CAAD,EAAG;AAAC,UAAI,KAAKkC,QAAL,CAAckB,IAAlB,KAAyB,KAAKhB,OAAL,CAAaiB,OAAb,CAAsBrD,CAAC,IAAEA,CAAC,CAACsD,aAAF,EAAzB,GAA6C,KAAKpB,QAAL,CAAcmB,OAAd,CAAuBnD,CAAC,IAAEA,CAAC,CAACqD,MAAF,CAAS,KAAKf,MAAd,EAAqB;AAACgB,MAAAA,MAAM,EAACxD;AAAR,KAArB,CAA1B,CAA7C,EAA0G,KAAKoC,OAAL,CAAaiB,OAAb,CAAsBrD,CAAC,IAAEA,CAAC,CAACyD,YAAF,EAAzB,CAA1G,EAAsJ,KAAK5B,yBAAL,CAA+B6B,WAA/B,EAA/K;AAA6N;;AAAAC,EAAAA,MAAM,CAACzD,CAAD,EAAG;AAAC,QAAG,MAAI,KAAKgC,QAAL,CAAckB,IAArB,EAA0B,OAAM,CAAC,CAAP;AAAS,QAAG,MAAIlD,CAAC,CAAC0D,IAAT,EAAc,QAAO,KAAKC,UAAL,CAAgB3D,CAAhB,GAAmBA,CAAC,CAAC4D,IAA5B;AAAkC,WAAK,CAAL;AAAO,aAAK/B,mBAAL,CAAyBgC,OAAzB,GAAiC,CAAjC,EAAmC,KAAKC,2BAAL,CAAiC9D,CAAjC,CAAnC,EAAuE,KAAKsC,MAAL,CAAYC,cAAZ,CAA2BwB,QAA3B,CAAoC,KAAKlC,mBAAzC,CAAvE;AAAqI;;AAAM,WAAK,CAAL;AAAO,aAAKA,mBAAL,CAAyBgC,OAAzB,GAAiC,CAAjC,EAAmC,KAAKvB,MAAL,CAAYC,cAAZ,CAA2BwB,QAA3B,CAAoC,KAAKlC,mBAAzC,CAAnC;AAAiG;;AAAM,WAAK,CAAL;AAAO,aAAKA,mBAAL,CAAyBgC,OAAzB,GAAiC,CAAjC,EAAmC,KAAKvB,MAAL,CAAYC,cAAZ,CAA2BwB,QAA3B,CAAoC,KAAKlC,mBAAzC,CAAnC;AAAiG;;AAAM,WAAK,CAAL;AAAO,aAAKS,MAAL,CAAYK,SAAZ,CAAsBoB,QAAtB,CAA+B,KAAKhC,oBAApC;AAA0D;;AAAM,WAAK,CAAL;AAAO,aAAKK,cAAL,CAAoB2B,QAApB,CAA6B,KAAKjC,iBAAlC;;AAAqD;;AAAM,WAAK,CAAL;AAAOhC,QAAAA,CAAC,CAAC,KAAKwC,MAAL,CAAYO,kBAAb,CAAD,IAAmC,KAAKP,MAAL,CAAYO,kBAAZ,CAA+BkB,QAA/B,CAAwC,KAAKjC,iBAA7C,CAAnC;AAAmG;;AAAM,WAAK,CAAL;AAAOhC,QAAAA,CAAC,CAAC,KAAKwC,MAAL,CAAYQ,gBAAb,CAAD,IAAiC,KAAKR,MAAL,CAAYQ,gBAAZ,CAA6BiB,QAA7B,CAAsC,KAAKjC,iBAA3C,CAAjC;AAAhpB;AAA+uB,QAAG,MAAI9B,CAAC,CAAC0D,IAAT,EAAc,QAAO,KAAKC,UAAL,CAAgB3D,CAAhB,GAAmBA,CAAC,CAAC4D,IAA5B;AAAkC,WAAK,CAAL;AAAO,aAAK/B,mBAAL,CAAyBgC,OAAzB,GAAiC,CAAjC,EAAmC,KAAKC,2BAAL,CAAiC9D,CAAjC,CAAnC,EAAuE,KAAKsC,MAAL,CAAYE,mBAAZ,CAAgCuB,QAAhC,CAAyC,KAAKlC,mBAA9C,CAAvE;AAA0I;;AAAM,WAAK,CAAL;AAAO,aAAKA,mBAAL,CAAyBgC,OAAzB,GAAiC,CAAjC,EAAmC,KAAKC,2BAAL,CAAiC9D,CAAjC,CAAnC,EAAuE,KAAKsC,MAAL,CAAYE,mBAAZ,CAAgCuB,QAAhC,CAAyC,KAAKlC,mBAA9C,CAAvE;AAA0I;;AAAM,WAAK,CAAL;AAAO,aAAKA,mBAAL,CAAyBgC,OAAzB,GAAiC,CAAjC,EAAmC,KAAKvB,MAAL,CAAYE,mBAAZ,CAAgCuB,QAAhC,CAAyC,KAAKlC,mBAA9C,CAAnC;AAAsG;;AAAM,WAAK,CAAL;AAAO,aAAKA,mBAAL,CAAyBgC,OAAzB,GAAiC,CAAjC,EAAmC,KAAKvB,MAAL,CAAYE,mBAAZ,CAAgCuB,QAAhC,CAAyC,KAAKlC,mBAA9C,CAAnC;AAA1c;AAAgjB,QAAG,MAAI7B,CAAC,CAAC0D,IAAT,EAAc,QAAO,KAAKC,UAAL,CAAgB3D,CAAhB,GAAmBA,CAAC,CAAC4D,IAA5B;AAAkC,WAAK,CAAL;AAAO,aAAK/B,mBAAL,CAAyBgC,OAAzB,GAAiC,CAAjC,EAAmC,KAAKC,2BAAL,CAAiC9D,CAAjC,CAAnC,EAAuE,KAAK6B,mBAAL,CAAyBmC,SAAzB,GAAmChE,CAAC,CAACgE,SAA5G,EAAsH,KAAK1B,MAAL,CAAYG,sBAAZ,CAAmCsB,QAAnC,CAA4C,KAAKlC,mBAAjD,CAAtH;AAA4L;;AAAM,WAAK,CAAL;AAAO,aAAKA,mBAAL,CAAyBgC,OAAzB,GAAiC,CAAjC,EAAmC,KAAKvB,MAAL,CAAYG,sBAAZ,CAAmCsB,QAAnC,CAA4C,KAAKlC,mBAAjD,CAAnC;AAAyG;;AAAM,WAAK,CAAL;AAAO,aAAKA,mBAAL,CAAyBgC,OAAzB,GAAiC,CAAjC,EAAmC,KAAKvB,MAAL,CAAYG,sBAAZ,CAAmCsB,QAAnC,CAA4C,KAAKlC,mBAAjD,CAAnC;AAAyG;;AAAM,WAAK,CAAL;AAAO,aAAKS,MAAL,CAAYM,uBAAZ,CAAoCmB,QAApC,CAA6C,KAAKhC,oBAAlD;AAA9d;AAAsiB,WAAM,CAAC,CAAP;AAAS;;AAAAkC,EAAAA,WAAW,GAAE;AAAC,SAAKC,OAAL,CAAaC,aAAb;AAA6B;;AAAAC,EAAAA,KAAK,GAAE;AAAC,WAAM,CAAC,CAAD,EAAG,CAAH,EAAK,CAAL,CAAN;AAAc;;AAAAC,EAAAA,uBAAuB,CAACvE,CAAD,EAAG;AAAC,SAAKoE,OAAL,GAAapE,CAAb;AAAe;;AAAAwE,EAAAA,yBAAyB,GAAE,CAAE;;AAAAC,EAAAA,eAAe,CAACvE,CAAD,EAAG;AAAC,UAAME,CAAC,GAAC;AAACsE,MAAAA,IAAI,EAAC,IAAE,CAAR;AAAUC,MAAAA,GAAG,EAAC,CAAC,CAAD,GAAG;AAAjB,KAAR;AAA4B,WAAO,KAAKzC,QAAL,CAAcmB,OAAd,CAAuBhD,CAAC,IAAE;AAAC,YAAMF,CAAC,GAACE,CAAC,CAACuE,2BAAF,CAA8B1E,CAA9B,CAAR;AAAyCF,MAAAA,CAAC,CAACG,CAAD,CAAD,IAAMF,CAAC,CAACG,CAAD,EAAGD,CAAH,EAAKC,CAAL,CAAP;AAAe,KAAnF,GAAsFA,CAA7F;AAA+F;;AAAwB,MAApByE,oBAAoB,GAAE;AAAC,WAAO7E,CAAC,CAAC,KAAKwC,MAAL,CAAYI,SAAb,CAAR;AAAgC;;AAAwB,MAApBiC,oBAAoB,CAAC7E,CAAD,EAAG;AAACA,IAAAA,CAAC,IAAE,KAAK+B,mBAAL,CAAyB+C,cAAzB,GAAwC,CAAC,CAAzC,EAA2C,KAAKtC,MAAL,CAAYI,SAAZ,GAAsB,KAAKN,cAAxE,KAAyF,KAAKP,mBAAL,CAAyB+C,cAAzB,GAAwC,CAAC,CAAzC,EAA2C,KAAKtC,MAAL,CAAYI,SAAZ,GAAsB,IAA1J,CAAD;AAAiK;;AAAiC,MAA7BmC,6BAA6B,GAAE;AAAC,WAAO/E,CAAC,CAAC,KAAK+B,mBAAL,CAAyBmC,SAAzB,CAAmCc,UAApC,CAAR;AAAwD;;AAAiC,MAA7BD,6BAA6B,CAAC/E,CAAD,EAAG;AAAC,SAAK+B,mBAAL,CAAyBmC,SAAzB,CAAmCc,UAAnC,GAA8C,CAAC,CAAChF,CAAhD;AAAkD;;AAAAgE,EAAAA,2BAA2B,CAAChE,CAAD,EAAG;AAAC,SAAK+B,mBAAL,CAAyBkD,aAAzB,GAAuC/E,CAAC,IAAE;AAACF,MAAAA,CAAC,CAAC4C,SAAF,CAAYsC,IAAZ,CAAiBhF,CAAjB;AAAoB,YAAME,CAAC,GAAC,KAAK2B,mBAAL,CAAyBoD,aAAjC;AAA+CxE,MAAAA,CAAC,CAACyE,CAAD,EAAGhF,CAAC,CAACiF,gBAAL,EAAsBjF,CAAC,CAACkF,gBAAxB,CAAD,EAA2CtF,CAAC,CAAC4C,SAAF,CAAY2C,QAAZ,CAAqBrF,CAArB,EAAuBkF,CAAvB,CAA3C;AAAqE,KAAnL,EAAoL,KAAKrD,mBAAL,CAAyByD,oBAAzB,GAA8CtF,CAAC,IAAEF,CAAC,CAACyF,UAAF,CAAaP,IAAb,CAAkBhF,CAAlB,CAArO,EAA0P,KAAK6B,mBAAL,CAAyB2D,uBAAzB,GAAiD,CAAC,CAAC1F,CAAC,CAACyF,UAAJ,IAAgBzF,CAAC,CAACyF,UAAF,CAAaE,KAAxU,EAA8U,KAAK5D,mBAAL,CAAyB6D,gBAAzB,GAA0C5F,CAAC,CAAC6F,YAA1X;AAAuY;;AAAAhC,EAAAA,UAAU,CAAC7D,CAAD,EAAG;AAAC,UAAME,CAAC,GAAC,MAAIF,CAAC,CAAC8D,IAAN,IAAY,MAAI9D,CAAC,CAAC8D,IAAlB,IAAwB,MAAI9D,CAAC,CAAC8D,IAA9B,GAAmC,KAAK9B,iBAAxC,GAA0D,MAAIhC,CAAC,CAAC8D,IAAN,GAAW,KAAK7B,oBAAhB,GAAqC,KAAKF,mBAA5G;;AAAgI,SAAK+D,iBAAL,CAAuB9F,CAAvB,EAAyBE,CAAzB;AAA4B;;AAAA4F,EAAAA,iBAAiB,CAAC9F,CAAD,EAAGG,CAAH,EAAK;AAAC,UAAMQ,CAAC,GAACX,CAAC,CAACwD,MAAV;AAAA,UAAiBxC,CAAC,GAACL,CAAC,CAACoF,0BAArB;AAAgDnF,IAAAA,CAAC,CAACwE,CAAD,EAAGpE,CAAC,CAAC,CAAD,CAAJ,EAAQA,CAAC,CAAC,CAAD,CAAT,EAAaA,CAAC,CAAC,EAAD,CAAd,CAAD,EAAqBgF,CAAC,CAACC,GAAF,CAAMb,CAAN,CAArB,EAA8BtE,CAAC,CAACX,CAAC,CAACgF,aAAF,CAAgBG,gBAAjB,EAAkCU,CAAC,CAACE,IAApC,CAA/B,EAAyEpF,CAAC,CAACX,CAAC,CAACgF,aAAF,CAAgBE,gBAAjB,EAAkCW,CAAC,CAACG,GAApC,CAA1E,EAAmHjG,CAAC,CAACC,CAAC,CAACgF,aAAF,CAAgBiB,yBAAjB,EAA2CzF,CAAC,CAAC0F,UAA7C,CAApH,EAA6K7F,CAAC,CAACL,CAAC,CAACgF,aAAF,CAAgBmB,YAAjB,EAA8B3F,CAAC,CAAC4F,gBAAhC,CAA9K,EAAgO,MAAIpG,CAAC,CAACqG,UAAN,IAAkB,KAAKzE,mBAAL,CAAyB0E,WAAzB,GAAqC,MAAIzG,CAAC,CAAC4D,IAA3C,EAAgD,KAAK7B,mBAAL,CAAyB2E,cAAzB,GAAwC,MAAI1G,CAAC,CAAC4D,IAA9F,EAAmG,KAAK7B,mBAAL,CAAyB4E,QAAzB,GAAkC3G,CAAC,CAAC4G,iBAAvI,EAAyJxG,CAAC,CAACyG,CAAD,EAAG1G,CAAC,CAACgF,aAAF,CAAgBiB,yBAAnB,CAA1J,EAAwM/F,CAAC,CAACF,CAAC,CAAC2G,8BAAH,EAAkCD,CAAlC,CAAzM,EAA8OpG,CAAC,CAACN,CAAC,CAAC4G,aAAH,EAAiBpG,CAAC,CAAC+D,IAAnB,EAAwB/D,CAAC,CAACgE,GAA1B,CAAjQ,IAAiS,MAAIxE,CAAC,CAACqG,UAAN,GAAiB/F,CAAC,CAACN,CAAC,CAAC4G,aAAH,EAAiBpG,CAAC,CAAC+D,IAAnB,EAAwB/D,CAAC,CAACgE,GAA1B,CAAlB,GAAiD,MAAIxE,CAAC,CAACqG,UAAN,KAAmBrG,CAAC,CAAC6G,qBAAF,GAAwBhH,CAAC,CAACgH,qBAA1B,EAAgD/F,CAAC,CAACd,CAAC,CAAC8G,QAAH,EAAYtG,CAAC,CAACuG,YAAd,CAApE,CAAljB,EAAmpB,MAAI/G,CAAC,CAACqG,UAAN,IAAkB,MAAIrG,CAAC,CAACqG,UAAxB,KAAqCrG,CAAC,CAACgH,eAAF,CAAkB,CAAlB,IAAqB,IAAExG,CAAC,CAACuG,YAAF,CAAe,CAAf,CAAvB,EAAyC/G,CAAC,CAACgH,eAAF,CAAkB,CAAlB,IAAqB,IAAExG,CAAC,CAACuG,YAAF,CAAe,CAAf,CAArG,CAAnpB,EAA2wB5G,CAAC,CAACN,CAAC,CAACoH,WAAF,CAAcC,KAAf,EAAqBlH,CAAC,CAACmH,UAAvB,CAA5wB,EAA+yBvG,CAAC,CAACZ,CAAC,CAACmH,UAAF,CAAaC,MAAd,EAAqBpH,CAAC,CAACmH,UAAF,CAAaC,MAAlC,EAAyCnC,CAAzC,CAAhzB,EAA41BjF,CAAC,CAACqH,iBAAF,GAAoBxH,CAAC,CAACoH,WAAF,CAAcK,SAA93B,EAAw4B,KAAK1F,mBAAL,CAAyB2F,oBAAzB,GAA8C1H,CAAC,CAAC0H,oBAAx7B,EAA68B,KAAK3F,mBAAL,CAAyB4F,sBAAzB,GAAgD3H,CAAC,CAAC2H,sBAA//B;AAAshC;;AAAApF,EAAAA,aAAa,CAACvC,CAAD,EAAG;AAAC,WAAO,KAAKoC,OAAL,CAAawF,IAAb,CAAkB5H,CAAlB,GAAqBA,CAA5B;AAA8B;;AAAkB,MAAd6H,cAAc,GAAE;AAAC,WAAO,KAAKrF,MAAL,CAAYK,SAAZ,CAAsBiF,KAAtB,GAA4B,CAA5B,IAA+B,KAAKtF,MAAL,CAAYM,uBAAZ,CAAoCgF,KAApC,GAA0C,CAAhF;AAAkF;;AAApjL;;AAAqjL,MAAM1C,CAAC,GAACpE,CAAC,EAAT;AAAA,MAAY6F,CAAC,GAAC1G,CAAC,EAAf;AAAA,MAAkB6F,CAAC,GAAC,IAAIvE,CAAJ,EAApB;AAA0B,SAAOf,CAAC,IAAIqH,iBAAZ","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isSome as s}from\"../../../../../core/maybe.js\";import{f as a,t as e,e as i}from\"../../../../../chunks/mat3.js\";import{c as t}from\"../../../../../chunks/mat3f64.js\";import{d as r}from\"../../../../../chunks/mat4.js\";import{s as h}from\"../../../../../chunks/vec2.js\";import{b as m,s as n,g as o,f as l}from\"../../../../../chunks/vec3.js\";import{c as P}from\"../../../../../chunks/vec3f64.js\";import{c as p}from\"../../../../../chunks/vec4.js\";import{d as c}from\"../../../../../chunks/boundedPlane.js\";import{MaterialPassesParameters as d,ShadowMapPassParameters as _,HighlightPassParameters as u}from\"./AllRenderPasses.js\";import{RenderPass as g}from\"./RenderPass.js\";import{TwoVectorPosition as w}from\"../util/TwoVectorPosition.js\";import{union as f}from\"../../lib/depthRange.js\";class b{constructor(s,a){this.rctx=s,this.shaderTechniqueRepository=a,this.canRender=!0,this._materialPassParams=new d,this._shadowPassParams=new _,this._highlightPassParams=new u,this._systems=new Set,this._passes=new Array,this._shadowMapPass=this._registerPass(new g(s,this.shaderTechniqueRepository)),this.passes={materialOpaque:this._registerPass(new g(s,this.shaderTechniqueRepository)),materialTransparent:this._registerPass(new g(s,this.shaderTechniqueRepository,1)),materialIntegratedMesh:this._registerPass(new g(s,this.shaderTechniqueRepository)),shadowMap:this._shadowMapPass,highlight:this._registerPass(new g(s,this.shaderTechniqueRepository)),highlightIntegratedMesh:this._registerPass(new g(s,this.shaderTechniqueRepository)),highlightShadowMap:this._registerPass(new g(s,this.shaderTechniqueRepository)),defaultShadowMap:this._registerPass(new g(s,this.shaderTechniqueRepository))}}register(s){this._systems.add(s)}prepareRender(s){0!==this._systems.size&&(this._passes.forEach((s=>s.prepareSubmit())),this._systems.forEach((a=>a.submit(this.passes,{camera:s}))),this._passes.forEach((s=>s.finishSubmit())),this.shaderTechniqueRepository.frameUpdate())}render(a){if(0===this._systems.size)return!1;if(4===a.slot)switch(this._configure(a),a.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(a),this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 5:this.passes.highlight.dispatch(this._highlightPassParams);break;case 4:this._shadowMapPass.dispatch(this._shadowPassParams);break;case 7:s(this.passes.highlightShadowMap)&&this.passes.highlightShadowMap.dispatch(this._shadowPassParams);break;case 6:s(this.passes.defaultShadowMap)&&this.passes.defaultShadowMap.dispatch(this._shadowPassParams)}if(6===a.slot)switch(this._configure(a),a.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(a),this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 1:this._materialPassParams.subPass=1,this._configureMaterialColorPass(a),this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialTransparent.dispatch(this._materialPassParams)}if(1===a.slot)switch(this._configure(a),a.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(a),this._materialPassParams.ssrParams=a.ssrParams,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 5:this.passes.highlightIntegratedMesh.dispatch(this._highlightPassParams)}return!0}notifyDirty(){this.context.requestRender()}slots(){return[4,6,1]}initializeRenderContext(s){this.context=s}uninitializeRenderContext(){}queryDepthRange(a){const e={near:1/0,far:-1/0};return this._systems.forEach((i=>{const t=i.queryShadowCasterDepthRange(a);s(t)&&f(e,t,e)})),e}get shadowCastingEnabled(){return s(this.passes.shadowMap)}set shadowCastingEnabled(s){s?(this._materialPassParams.shadowsEnabled=!0,this.passes.shadowMap=this._shadowMapPass):(this._materialPassParams.shadowsEnabled=!1,this.passes.shadowMap=null)}get screenSpaceReflectionsEnabled(){return s(this._materialPassParams.ssrParams.ssrEnabled)}set screenSpaceReflectionsEnabled(s){this._materialPassParams.ssrParams.ssrEnabled=!!s}_configureMaterialColorPass(s){this._materialPassParams.bindShadowMap=a=>{s.shadowMap.bind(a);const e=this._materialPassParams.viewTransform;m(M,e.worldFromView_TL,e.worldFromView_TH),s.shadowMap.bindView(a,M)},this._materialPassParams.bindAmbientOcclusion=a=>s.ssaoHelper.bind(a),this._materialPassParams.ambientOcclusionEnabled=!!s.ssaoHelper&&s.ssaoHelper.ready,this._materialPassParams.sceneHasOcludees=s.hasOccludees}_configure(s){const a=4===s.pass||7===s.pass||6===s.pass?this._shadowPassParams:5===s.pass?this._highlightPassParams:this._materialPassParams;this._updateParameters(s,a)}_updateParameters(s,t){const m=s.camera,P=m.viewInverseTransposeMatrix;n(M,P[3],P[7],P[11]),y.set(M),o(t.viewTransform.worldFromView_TH,y.high),o(t.viewTransform.worldFromView_TL,y.low),a(t.viewTransform.viewFromCameraRelative_RS,m.viewMatrix),r(t.viewTransform.projFromView,m.projectionMatrix),0===t.identifier?(this._materialPassParams.transparent=6===s.slot,this._materialPassParams.integratedMesh=1===s.slot,this._materialPassParams.lighting=s.scenelightingData,e(T,t.viewTransform.viewFromCameraRelative_RS),i(t.transformNormal_ViewFromGlobal,T),h(t.cameraNearFar,m.near,m.far)):1===t.identifier?h(t.cameraNearFar,m.near,m.far):2===t.identifier&&(t.highlightDepthTexture=s.highlightDepthTexture,p(t.viewport,m.fullViewport)),0!==t.identifier&&2!==t.identifier||(t.inverseViewport[0]=1/m.fullViewport[2],t.inverseViewport[1]=1/m.fullViewport[3]),c(s.sliceHelper.plane,t.slicePlane),l(t.slicePlane.origin,t.slicePlane.origin,M),t.slicePlaneEnabled=s.sliceHelper.isEnabled,this._materialPassParams.transparencyPassType=s.transparencyPassType,this._materialPassParams.multipassTerrainParams=s.multipassTerrainParams}_registerPass(s){return this._passes.push(s),s}get needsHighlight(){return this.passes.highlight.count>0||this.passes.highlightIntegratedMesh.count>0}}const M=P(),T=t(),y=new w;export{b as RenderPassManager};\n"]},"metadata":{},"sourceType":"module"}