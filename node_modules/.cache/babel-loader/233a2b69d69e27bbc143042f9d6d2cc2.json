{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as t } from \"../../chunks/tslib.es6.js\";\nimport e from \"../../Graphic.js\";\nimport a from \"../../core/Collection.js\";\nimport i from \"../../core/Error.js\";\nimport { HandleOwner as r } from \"../../core/HandleOwner.js\";\nimport { isSome as n } from \"../../core/maybe.js\";\nimport { init as s } from \"../../core/watchUtils.js\";\nimport { property as o } from \"../../core/accessorSupport/decorators/property.js\";\nimport \"../../core/has.js\";\nimport { cast as c } from \"../../core/accessorSupport/decorators/cast.js\";\nimport \"../../core/Logger.js\";\nimport { subclass as h } from \"../../core/accessorSupport/decorators/subclass.js\";\nimport d from \"../../rest/query/support/AttachmentInfo.js\";\nimport m from \"../../rest/support/AttachmentQuery.js\";\nimport { getSourceLayer as l } from \"../Feature/support/featureUtils.js\";\nconst p = {\n  editing: !1,\n  operations: {\n    add: !0,\n    update: !0,\n    delete: !0\n  }\n},\n      u = a.ofType(d),\n      y = \"graphic.layer.capabilities.operations.supportsResizeAttachments\";\nlet f = class extends r {\n  constructor(t) {\n    super(t), this._getAttachmentsPromise = null, this._attachmentLayer = null, this.abilities = { ...p\n    }, this.activeAttachmentInfo = null, this.attachmentInfos = new u(), this.graphic = null, this.mode = \"view\", this.handles.add([s(this, \"graphic\", () => this._graphicChanged())]);\n  }\n\n  destroy() {\n    this._attachmentLayer = null, this.graphic = null;\n  }\n\n  castAbilities(t) {\n    return { ...p,\n      ...t\n    };\n  }\n\n  get state() {\n    return this._getAttachmentsPromise ? \"loading\" : this.graphic ? \"ready\" : \"disabled\";\n  }\n\n  get supportsResizeAttachments() {\n    return this.get(y) || !1;\n  }\n\n  async getAttachments() {\n    const {\n      _attachmentLayer: t,\n      attachmentInfos: e\n    } = this;\n    if (!t || \"function\" != typeof t.queryAttachments) throw new i(\"invalid-layer\", \"getAttachments(): A valid layer is required.\");\n\n    const a = this._getFeatureId(),\n          r = new m({\n      objectIds: [a],\n      returnMetadata: !0\n    }),\n          n = [],\n          s = t.queryAttachments(r).then(t => t[a] || n).catch(() => n);\n\n    this._getAttachmentsPromise = s, this.notifyChange(\"state\");\n    const o = await s;\n    return e.removeAll(), o.length && e.addMany(o), this._getAttachmentsPromise = null, this.notifyChange(\"state\"), o;\n  }\n\n  async addAttachment(t) {\n    const {\n      _attachmentLayer: e,\n      attachmentInfos: a,\n      graphic: r,\n      abilities: n\n    } = this;\n    if (!t) throw new i(\"invalid-attachment\", \"addAttachment(): An attachment is required.\", {\n      attachment: t\n    });\n    if (!n.operations.add) throw new i(\"invalid-abilities\", \"addAttachment(): add abilities are required.\");\n    if (!e || \"function\" != typeof e.addAttachment) throw new i(\"invalid-layer\", \"addAttachment(): A valid layer is required.\");\n    const s = e.addAttachment(r, t).then(t => this._queryAttachment(t.objectId)),\n          o = await s;\n    return a.add(o), o;\n  }\n\n  async deleteAttachment(t) {\n    const {\n      _attachmentLayer: e,\n      attachmentInfos: a,\n      graphic: r,\n      abilities: n\n    } = this;\n    if (!t) throw new i(\"invalid-attachment-info\", \"deleteAttachment(): An attachmentInfo is required.\", {\n      attachmentInfo: t\n    });\n    if (!n.operations.delete) throw new i(\"invalid-abilities\", \"deleteAttachment(): delete abilities are required.\");\n    if (!e || \"function\" != typeof e.deleteAttachments) throw new i(\"invalid-layer\", \"deleteAttachment(): A valid layer is required.\");\n    const s = e.deleteAttachments(r, [t.id]).then(() => t),\n          o = await s;\n    return a.remove(o), o;\n  }\n\n  async updateAttachment(t, e = this.activeAttachmentInfo) {\n    const {\n      _attachmentLayer: a,\n      attachmentInfos: r,\n      graphic: n,\n      abilities: s\n    } = this;\n    if (!t) throw new i(\"invalid-attachment\", \"updateAttachment(): An attachment is required.\", {\n      attachment: t\n    });\n    if (!e) throw new i(\"invalid-attachment-info\", \"updateAttachment(): An attachmentInfo is required.\", {\n      attachmentInfo: e\n    });\n    if (!s.operations.update) throw new i(\"invalid-abilities\", \"updateAttachment(): Update abilities are required.\");\n    const o = r.findIndex(t => t === e);\n    if (!a || \"function\" != typeof a.updateAttachment) throw new i(\"invalid-layer\", \"updateAttachment(): A valid layer is required.\");\n    const c = a.updateAttachment(n, e.id, t).then(t => this._queryAttachment(t.objectId)),\n          h = await c;\n    return r.splice(o, 1, h), h;\n  }\n\n  async _queryAttachment(t) {\n    if (!t) throw new i(\"invalid-attachment-id\", \"Could not query attachment.\");\n\n    const {\n      _attachmentLayer: e\n    } = this,\n          a = this._getFeatureId(),\n          r = new m({\n      objectIds: [a],\n      attachmentsWhere: `AttachmentId=${t}`,\n      returnMetadata: !0\n    });\n\n    return e.queryAttachments(r).then(t => t[a][0]);\n  }\n\n  _getFeatureId() {\n    const {\n      _attachmentLayer: t,\n      graphic: e\n    } = this;\n    if (!t || !e) return null;\n    const {\n      objectIdField: a\n    } = t,\n          {\n      attributes: i\n    } = e;\n    return i && i[a];\n  }\n\n  _graphicChanged() {\n    this.graphic && (this._setAttachmentLayer(), this.getAttachments().catch(() => {}));\n  }\n\n  _setAttachmentLayer() {\n    const {\n      graphic: t\n    } = this,\n          e = l(t);\n    this._attachmentLayer = e ? \"scene\" === e.type && n(e.associatedLayer) ? e.associatedLayer : e : null;\n  }\n\n};\nt([o()], f.prototype, \"abilities\", void 0), t([c(\"abilities\")], f.prototype, \"castAbilities\", null), t([o()], f.prototype, \"activeAttachmentInfo\", void 0), t([o({\n  readOnly: !0,\n  type: u\n})], f.prototype, \"attachmentInfos\", void 0), t([o({\n  type: e\n})], f.prototype, \"graphic\", void 0), t([o()], f.prototype, \"mode\", void 0), t([o({\n  readOnly: !0\n})], f.prototype, \"state\", null), t([o({\n  readOnly: !0\n})], f.prototype, \"supportsResizeAttachments\", null), f = t([h(\"esri.widgets.Attachments.AttachmentsViewModel\")], f);\nvar A = f;\nexport default A;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/widgets/Attachments/AttachmentsViewModel.js"],"names":["_","t","e","a","i","HandleOwner","r","isSome","n","init","s","property","o","cast","c","subclass","h","d","m","getSourceLayer","l","p","editing","operations","add","update","delete","u","ofType","y","f","constructor","_getAttachmentsPromise","_attachmentLayer","abilities","activeAttachmentInfo","attachmentInfos","graphic","mode","handles","_graphicChanged","destroy","castAbilities","state","supportsResizeAttachments","get","getAttachments","queryAttachments","_getFeatureId","objectIds","returnMetadata","then","catch","notifyChange","removeAll","length","addMany","addAttachment","attachment","_queryAttachment","objectId","deleteAttachment","attachmentInfo","deleteAttachments","id","remove","updateAttachment","findIndex","splice","attachmentsWhere","objectIdField","attributes","_setAttachmentLayer","type","associatedLayer","prototype","readOnly","A"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as t}from\"../../chunks/tslib.es6.js\";import e from\"../../Graphic.js\";import a from\"../../core/Collection.js\";import i from\"../../core/Error.js\";import{HandleOwner as r}from\"../../core/HandleOwner.js\";import{isSome as n}from\"../../core/maybe.js\";import{init as s}from\"../../core/watchUtils.js\";import{property as o}from\"../../core/accessorSupport/decorators/property.js\";import\"../../core/has.js\";import{cast as c}from\"../../core/accessorSupport/decorators/cast.js\";import\"../../core/Logger.js\";import{subclass as h}from\"../../core/accessorSupport/decorators/subclass.js\";import d from\"../../rest/query/support/AttachmentInfo.js\";import m from\"../../rest/support/AttachmentQuery.js\";import{getSourceLayer as l}from\"../Feature/support/featureUtils.js\";const p={editing:!1,operations:{add:!0,update:!0,delete:!0}},u=a.ofType(d),y=\"graphic.layer.capabilities.operations.supportsResizeAttachments\";let f=class extends r{constructor(t){super(t),this._getAttachmentsPromise=null,this._attachmentLayer=null,this.abilities={...p},this.activeAttachmentInfo=null,this.attachmentInfos=new u,this.graphic=null,this.mode=\"view\",this.handles.add([s(this,\"graphic\",(()=>this._graphicChanged()))])}destroy(){this._attachmentLayer=null,this.graphic=null}castAbilities(t){return{...p,...t}}get state(){return this._getAttachmentsPromise?\"loading\":this.graphic?\"ready\":\"disabled\"}get supportsResizeAttachments(){return this.get(y)||!1}async getAttachments(){const{_attachmentLayer:t,attachmentInfos:e}=this;if(!t||\"function\"!=typeof t.queryAttachments)throw new i(\"invalid-layer\",\"getAttachments(): A valid layer is required.\");const a=this._getFeatureId(),r=new m({objectIds:[a],returnMetadata:!0}),n=[],s=t.queryAttachments(r).then((t=>t[a]||n)).catch((()=>n));this._getAttachmentsPromise=s,this.notifyChange(\"state\");const o=await s;return e.removeAll(),o.length&&e.addMany(o),this._getAttachmentsPromise=null,this.notifyChange(\"state\"),o}async addAttachment(t){const{_attachmentLayer:e,attachmentInfos:a,graphic:r,abilities:n}=this;if(!t)throw new i(\"invalid-attachment\",\"addAttachment(): An attachment is required.\",{attachment:t});if(!n.operations.add)throw new i(\"invalid-abilities\",\"addAttachment(): add abilities are required.\");if(!e||\"function\"!=typeof e.addAttachment)throw new i(\"invalid-layer\",\"addAttachment(): A valid layer is required.\");const s=e.addAttachment(r,t).then((t=>this._queryAttachment(t.objectId))),o=await s;return a.add(o),o}async deleteAttachment(t){const{_attachmentLayer:e,attachmentInfos:a,graphic:r,abilities:n}=this;if(!t)throw new i(\"invalid-attachment-info\",\"deleteAttachment(): An attachmentInfo is required.\",{attachmentInfo:t});if(!n.operations.delete)throw new i(\"invalid-abilities\",\"deleteAttachment(): delete abilities are required.\");if(!e||\"function\"!=typeof e.deleteAttachments)throw new i(\"invalid-layer\",\"deleteAttachment(): A valid layer is required.\");const s=e.deleteAttachments(r,[t.id]).then((()=>t)),o=await s;return a.remove(o),o}async updateAttachment(t,e=this.activeAttachmentInfo){const{_attachmentLayer:a,attachmentInfos:r,graphic:n,abilities:s}=this;if(!t)throw new i(\"invalid-attachment\",\"updateAttachment(): An attachment is required.\",{attachment:t});if(!e)throw new i(\"invalid-attachment-info\",\"updateAttachment(): An attachmentInfo is required.\",{attachmentInfo:e});if(!s.operations.update)throw new i(\"invalid-abilities\",\"updateAttachment(): Update abilities are required.\");const o=r.findIndex((t=>t===e));if(!a||\"function\"!=typeof a.updateAttachment)throw new i(\"invalid-layer\",\"updateAttachment(): A valid layer is required.\");const c=a.updateAttachment(n,e.id,t).then((t=>this._queryAttachment(t.objectId))),h=await c;return r.splice(o,1,h),h}async _queryAttachment(t){if(!t)throw new i(\"invalid-attachment-id\",\"Could not query attachment.\");const{_attachmentLayer:e}=this,a=this._getFeatureId(),r=new m({objectIds:[a],attachmentsWhere:`AttachmentId=${t}`,returnMetadata:!0});return e.queryAttachments(r).then((t=>t[a][0]))}_getFeatureId(){const{_attachmentLayer:t,graphic:e}=this;if(!t||!e)return null;const{objectIdField:a}=t,{attributes:i}=e;return i&&i[a]}_graphicChanged(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch((()=>{})))}_setAttachmentLayer(){const{graphic:t}=this,e=l(t);this._attachmentLayer=e?\"scene\"===e.type&&n(e.associatedLayer)?e.associatedLayer:e:null}};t([o()],f.prototype,\"abilities\",void 0),t([c(\"abilities\")],f.prototype,\"castAbilities\",null),t([o()],f.prototype,\"activeAttachmentInfo\",void 0),t([o({readOnly:!0,type:u})],f.prototype,\"attachmentInfos\",void 0),t([o({type:e})],f.prototype,\"graphic\",void 0),t([o()],f.prototype,\"mode\",void 0),t([o({readOnly:!0})],f.prototype,\"state\",null),t([o({readOnly:!0})],f.prototype,\"supportsResizeAttachments\",null),f=t([h(\"esri.widgets.Attachments.AttachmentsViewModel\")],f);var A=f;export default A;\n"]},"metadata":{},"sourceType":"module"}