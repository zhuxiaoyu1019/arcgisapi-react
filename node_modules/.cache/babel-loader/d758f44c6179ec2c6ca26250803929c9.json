{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { neverReached as t } from \"../../../../core/compilerUtils.js\";\nimport e from \"../../../../core/Error.js\";\nimport r from \"../../../../core/Evented.js\";\nimport { isPowerOfTwo as i, nextHighestPowerOfTwo as s } from \"../../../../core/mathUtils.js\";\nimport { isNone as a, isSome as o } from \"../../../../core/maybe.js\";\nimport { createAbortController as n, onAbort as m, createAbortError as h } from \"../../../../core/promiseUtils.js\";\nimport { isArrayBuffer as l, isUint8Array as p } from \"../../../../core/typedArrayUtil.js\";\nimport { isBlobProtocol as d, isDataProtocol as c } from \"../../../../core/urlUtils.js\";\nimport { requestImage as u } from \"../../../../support/requestImageUtils.js\";\nimport { loadImageAsync as g } from \"../../../../support/requestUtils.js\";\nimport { estimateMemoryKTX2 as f, estimateMemoryBasis as w, createTextureKTX2 as T, createTextureBasis as x } from \"./BasisUtil.js\";\nimport { ContentObject as D } from \"./ContentObject.js\";\nimport { createDDSTexture as F } from \"./DDSUtil.js\";\nimport { createQuadVAO as M } from \"./glUtil3D.js\";\nimport { assert as y } from \"./Util.js\";\nimport I from \"../../../webgl/FramebufferObject.js\";\nimport E from \"../../../webgl/Texture.js\";\nimport { vertexCount as O } from \"../../../webgl/Util.js\";\nimport b from \"../../../webgl/capabilities/isWebGL2Context.js\";\n\nclass S extends D {\n  constructor(t, e) {\n    super(), this.data = t, this.type = 4, this.glTexture = null, this.powerOfTwoStretchInfo = null, this.loadingPromise = null, this.loadingController = null, this.events = new r(), this.params = e || {}, this.params.mipmap = !1 !== this.params.mipmap, this.params.noUnpackFlip = this.params.noUnpackFlip || !1, this.params.preMultiplyAlpha = this.params.preMultiplyAlpha || !1, this.params.wrap = this.params.wrap || {\n      s: 10497,\n      t: 10497\n    }, this.params.powerOfTwoResizeMode = this.params.powerOfTwoResizeMode || 1, this.estimatedTexMemRequired = S.estimateTexMemRequired(this.data, this.params), this.startPreload();\n  }\n\n  startPreload() {\n    const t = this.data;\n    a(t) || (t instanceof HTMLVideoElement ? this.startPreloadVideoElement(t) : t instanceof HTMLImageElement && this.startPreloadImageElement(t));\n  }\n\n  startPreloadVideoElement(t) {\n    d(t.src) || \"auto\" === t.preload && t.crossOrigin || (t.preload = \"auto\", t.crossOrigin = \"anonymous\", t.src = t.src);\n  }\n\n  startPreloadImageElement(t) {\n    c(t.src) || d(t.src) || t.crossOrigin || (t.crossOrigin = \"anonymous\", t.src = t.src);\n  }\n\n  static getDataDimensions(t) {\n    return t instanceof HTMLVideoElement ? {\n      width: t.videoWidth,\n      height: t.videoHeight\n    } : t;\n  }\n\n  static estimateTexMemRequired(t, e) {\n    if (a(t)) return 0;\n    if (l(t) || p(t)) return e.encoding === S.KTX2_ENCODING ? f(t, e.mipmap) : e.encoding === S.BASIS_ENCODING ? w(t, e.mipmap) : t.byteLength;\n    const {\n      width: r,\n      height: i\n    } = t instanceof Image || t instanceof ImageData || t instanceof HTMLCanvasElement || t instanceof HTMLVideoElement ? S.getDataDimensions(t) : e;\n    return (e.mipmap ? 4 / 3 : 1) * r * i * (e.components || 4) || 0;\n  }\n\n  dispose() {\n    this.data = void 0;\n  }\n\n  get width() {\n    return this.params.width;\n  }\n\n  get height() {\n    return this.params.height;\n  }\n\n  createDescriptor(t) {\n    var e;\n    return {\n      target: 3553,\n      pixelFormat: 6408,\n      dataType: 5121,\n      wrapMode: this.params.wrap,\n      flipped: !this.params.noUnpackFlip,\n      samplingMode: this.params.mipmap ? 9987 : 9729,\n      hasMipmap: this.params.mipmap,\n      preMultiplyAlpha: this.params.preMultiplyAlpha,\n      maxAnisotropy: null != (e = this.params.maxAnisotropy) ? e : this.params.mipmap ? t.parameters.maxMaxAnisotropy : 1\n    };\n  }\n\n  load(t, e) {\n    if (o(this.glTexture)) return this.glTexture;\n    if (o(this.loadingPromise)) return this.loadingPromise;\n    const r = this.data;\n    return a(r) ? (this.glTexture = new E(t, this.createDescriptor(t), null), this.glTexture) : \"string\" == typeof r ? this.loadFromURL(t, e, r) : r instanceof Image ? this.loadFromImageElement(t, e, r) : r instanceof HTMLVideoElement ? this.loadFromVideoElement(t, e, r) : r instanceof ImageData || r instanceof HTMLCanvasElement ? this.loadFromImage(t, r, e) : (l(r) || p(r)) && this.params.encoding === S.DDS_ENCODING ? this.loadFromDDSData(t, r) : (l(r) || p(r)) && this.params.encoding === S.KTX2_ENCODING ? this.loadFromKTX2(t, r) : (l(r) || p(r)) && this.params.encoding === S.BASIS_ENCODING ? this.loadFromBasis(t, r) : p(r) ? this.loadFromPixelData(t, r) : l(r) ? this.loadFromPixelData(t, new Uint8Array(r)) : null;\n  }\n\n  get requiresFrameUpdates() {\n    return this.data instanceof HTMLVideoElement;\n  }\n\n  frameUpdate(t, e, r) {\n    if (!(this.data instanceof HTMLVideoElement) || a(this.glTexture)) return r;\n    if (this.data.readyState < 2 || r === this.data.currentTime) return r;\n\n    if (o(this.powerOfTwoStretchInfo)) {\n      const {\n        framebuffer: r,\n        vao: i,\n        sourceTexture: s\n      } = this.powerOfTwoStretchInfo;\n      s.setData(this.data), this.drawStretchedTexture(t, e, r, i, s, this.glTexture);\n    } else {\n      const {\n        width: t,\n        height: e\n      } = this.data,\n            {\n        width: r,\n        height: i\n      } = this.glTexture.descriptor;\n      t !== r || e !== i ? this.glTexture.updateData(0, 0, 0, Math.min(t, r), Math.min(e, i), this.data) : this.glTexture.setData(this.data);\n    }\n\n    return this.glTexture.descriptor.hasMipmap && this.glTexture.generateMipmap(), this.data.currentTime;\n  }\n\n  loadFromDDSData(t, e) {\n    return this.glTexture = F(t, this.createDescriptor(t), e), this.glTexture;\n  }\n\n  loadFromKTX2(t, e) {\n    return this.loadAsync(() => T(t, this.createDescriptor(t), e).then(t => (this.glTexture = t, t)));\n  }\n\n  loadFromBasis(t, e) {\n    return this.loadAsync(() => x(t, this.createDescriptor(t), e).then(t => (this.glTexture = t, t)));\n  }\n\n  loadFromPixelData(t, e) {\n    y(this.params.width > 0 && this.params.height > 0);\n    const r = this.createDescriptor(t);\n    return r.pixelFormat = 1 === this.params.components ? 6409 : 3 === this.params.components ? 6407 : 6408, r.width = this.params.width, r.height = this.params.height, this.glTexture = new E(t, r, e), this.glTexture;\n  }\n\n  loadAsync(t) {\n    const e = n();\n    this.loadingController = e;\n    const r = t(e.signal);\n    this.loadingPromise = r;\n\n    const i = () => {\n      this.loadingController === e && (this.loadingController = null), this.loadingPromise === r && (this.loadingPromise = null);\n    };\n\n    return r.then(i, i), r;\n  }\n\n  loadFromURL(t, e, r) {\n    return this.loadAsync(async i => {\n      const s = await u(r, {\n        signal: i\n      });\n      return this.loadFromImage(t, s, e);\n    });\n  }\n\n  loadFromImageElement(t, e, r) {\n    return r.complete ? this.loadFromImage(t, r, e) : this.loadAsync(async i => {\n      const s = await g(r, r.src, !1, i);\n      return this.loadFromImage(t, s, e);\n    });\n  }\n\n  loadFromVideoElement(t, e, r) {\n    return r.readyState >= 2 ? this.loadFromImage(t, r, e) : this.loadFromVideoElementAsync(t, e, r);\n  }\n\n  loadFromVideoElementAsync(t, r, i) {\n    return this.loadAsync(s => new Promise((a, n) => {\n      const l = () => {\n        i.removeEventListener(\"loadeddata\", p), i.removeEventListener(\"error\", d), o(c) && c.remove();\n      },\n            p = () => {\n        i.readyState >= 2 && (l(), a(this.loadFromImage(t, i, r)));\n      },\n            d = t => {\n        l(), n(t || new e(\"Failed to load video\"));\n      };\n\n      i.addEventListener(\"loadeddata\", p), i.addEventListener(\"error\", d);\n      const c = m(s, () => d(h()));\n    }));\n  }\n\n  loadFromImage(t, e, r) {\n    const s = S.getDataDimensions(e);\n    this.params.width = s.width, this.params.height = s.height;\n    const a = this.createDescriptor(t);\n    return a.pixelFormat = 3 === this.params.components ? 6407 : 6408, !this.requiresPowerOfTwo(t, a) || i(s.width) && i(s.height) ? (a.width = s.width, a.height = s.height, this.glTexture = new E(t, a, e), this.glTexture) : (this.glTexture = this.makePowerOfTwoTexture(t, e, s, a, r), this.glTexture);\n  }\n\n  requiresPowerOfTwo(t, e) {\n    const r = 33071,\n          i = \"number\" == typeof e.wrapMode ? e.wrapMode === r : e.wrapMode.s === r && e.wrapMode.t === r;\n    return !b(t.gl) && (e.hasMipmap || !i);\n  }\n\n  makePowerOfTwoTexture(e, r, i, a, o) {\n    const {\n      width: n,\n      height: m\n    } = i,\n          h = s(n),\n          l = s(m);\n    let p;\n\n    switch (a.width = h, a.height = l, this.params.powerOfTwoResizeMode) {\n      case 2:\n        a.textureCoordinateScaleFactor = [n / h, m / l], p = new E(e, a), p.updateData(0, 0, 0, n, m, r);\n        break;\n\n      case 1:\n      case null:\n      case void 0:\n        p = this.stretchToPowerOfTwo(e, r, a, o);\n        break;\n\n      default:\n        t(this.params.powerOfTwoResizeMode);\n    }\n\n    return a.hasMipmap && p.generateMipmap(), p;\n  }\n\n  stretchToPowerOfTwo(t, e, r, i) {\n    const s = new E(t, r),\n          a = new I(t, {\n      colorTarget: 0,\n      depthStencilTarget: 0\n    }, s),\n          o = new E(t, {\n      target: 3553,\n      pixelFormat: r.pixelFormat,\n      dataType: 5121,\n      wrapMode: 33071,\n      samplingMode: 9729,\n      flipped: !!r.flipped,\n      maxAnisotropy: 8,\n      preMultiplyAlpha: r.preMultiplyAlpha\n    }, e),\n          n = M(t);\n    return this.drawStretchedTexture(t, i, a, n, o, s), this.requiresFrameUpdates ? this.powerOfTwoStretchInfo = {\n      vao: n,\n      sourceTexture: o,\n      framebuffer: a\n    } : (n.dispose(!0), o.dispose(), a.detachColorTexture(), t.bindFramebuffer(null), a.dispose()), s;\n  }\n\n  drawStretchedTexture(t, e, r, i, s, a) {\n    t.bindFramebuffer(r);\n    const o = t.getViewport();\n    t.setViewport(0, 0, a.descriptor.width, a.descriptor.height);\n    const n = e.program;\n    t.useProgram(n), n.setUniform4f(\"color\", 1, 1, 1, 1), n.bindTexture(s, \"tex\"), t.bindVAO(i), t.setPipelineState(e.pipeline), t.drawArrays(5, 0, O(i, \"geometry\")), t.bindFramebuffer(null), t.setViewport(o.x, o.y, o.width, o.height);\n  }\n\n  unload() {\n    if (o(this.powerOfTwoStretchInfo)) {\n      const {\n        framebuffer: t,\n        vao: e,\n        sourceTexture: r\n      } = this.powerOfTwoStretchInfo;\n      e.dispose(!0), r.dispose(), t.dispose(), this.glTexture = null, this.powerOfTwoStretchInfo = null;\n    }\n\n    if (o(this.glTexture) && (this.glTexture.dispose(), this.glTexture = null), o(this.loadingController)) {\n      const t = this.loadingController;\n      this.loadingController = null, this.loadingPromise = null, t.abort();\n    }\n\n    this.events.emit(\"unloaded\");\n  }\n\n}\n\nS.DDS_ENCODING = \"image/vnd-ms.dds\", S.KTX2_ENCODING = \"image/ktx2\", S.BASIS_ENCODING = \"image/x.basis\";\nexport { S as Texture };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/webgl-engine/lib/Texture.js"],"names":["neverReached","t","e","r","isPowerOfTwo","i","nextHighestPowerOfTwo","s","isNone","a","isSome","o","createAbortController","n","onAbort","m","createAbortError","h","isArrayBuffer","l","isUint8Array","p","isBlobProtocol","d","isDataProtocol","c","requestImage","u","loadImageAsync","g","estimateMemoryKTX2","f","estimateMemoryBasis","w","createTextureKTX2","T","createTextureBasis","x","ContentObject","D","createDDSTexture","F","createQuadVAO","M","assert","y","I","E","vertexCount","O","b","S","constructor","data","type","glTexture","powerOfTwoStretchInfo","loadingPromise","loadingController","events","params","mipmap","noUnpackFlip","preMultiplyAlpha","wrap","powerOfTwoResizeMode","estimatedTexMemRequired","estimateTexMemRequired","startPreload","HTMLVideoElement","startPreloadVideoElement","HTMLImageElement","startPreloadImageElement","src","preload","crossOrigin","getDataDimensions","width","videoWidth","height","videoHeight","encoding","KTX2_ENCODING","BASIS_ENCODING","byteLength","Image","ImageData","HTMLCanvasElement","components","dispose","createDescriptor","target","pixelFormat","dataType","wrapMode","flipped","samplingMode","hasMipmap","maxAnisotropy","parameters","maxMaxAnisotropy","load","loadFromURL","loadFromImageElement","loadFromVideoElement","loadFromImage","DDS_ENCODING","loadFromDDSData","loadFromKTX2","loadFromBasis","loadFromPixelData","Uint8Array","requiresFrameUpdates","frameUpdate","readyState","currentTime","framebuffer","vao","sourceTexture","setData","drawStretchedTexture","descriptor","updateData","Math","min","generateMipmap","loadAsync","then","signal","complete","loadFromVideoElementAsync","Promise","removeEventListener","remove","addEventListener","requiresPowerOfTwo","makePowerOfTwoTexture","gl","textureCoordinateScaleFactor","stretchToPowerOfTwo","colorTarget","depthStencilTarget","detachColorTexture","bindFramebuffer","getViewport","setViewport","program","useProgram","setUniform4f","bindTexture","bindVAO","setPipelineState","pipeline","drawArrays","unload","abort","emit","Texture"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{neverReached as t}from\"../../../../core/compilerUtils.js\";import e from\"../../../../core/Error.js\";import r from\"../../../../core/Evented.js\";import{isPowerOfTwo as i,nextHighestPowerOfTwo as s}from\"../../../../core/mathUtils.js\";import{isNone as a,isSome as o}from\"../../../../core/maybe.js\";import{createAbortController as n,onAbort as m,createAbortError as h}from\"../../../../core/promiseUtils.js\";import{isArrayBuffer as l,isUint8Array as p}from\"../../../../core/typedArrayUtil.js\";import{isBlobProtocol as d,isDataProtocol as c}from\"../../../../core/urlUtils.js\";import{requestImage as u}from\"../../../../support/requestImageUtils.js\";import{loadImageAsync as g}from\"../../../../support/requestUtils.js\";import{estimateMemoryKTX2 as f,estimateMemoryBasis as w,createTextureKTX2 as T,createTextureBasis as x}from\"./BasisUtil.js\";import{ContentObject as D}from\"./ContentObject.js\";import{createDDSTexture as F}from\"./DDSUtil.js\";import{createQuadVAO as M}from\"./glUtil3D.js\";import{assert as y}from\"./Util.js\";import I from\"../../../webgl/FramebufferObject.js\";import E from\"../../../webgl/Texture.js\";import{vertexCount as O}from\"../../../webgl/Util.js\";import b from\"../../../webgl/capabilities/isWebGL2Context.js\";class S extends D{constructor(t,e){super(),this.data=t,this.type=4,this.glTexture=null,this.powerOfTwoStretchInfo=null,this.loadingPromise=null,this.loadingController=null,this.events=new r,this.params=e||{},this.params.mipmap=!1!==this.params.mipmap,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:10497,t:10497},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||1,this.estimatedTexMemRequired=S.estimateTexMemRequired(this.data,this.params),this.startPreload()}startPreload(){const t=this.data;a(t)||(t instanceof HTMLVideoElement?this.startPreloadVideoElement(t):t instanceof HTMLImageElement&&this.startPreloadImageElement(t))}startPreloadVideoElement(t){d(t.src)||\"auto\"===t.preload&&t.crossOrigin||(t.preload=\"auto\",t.crossOrigin=\"anonymous\",t.src=t.src)}startPreloadImageElement(t){c(t.src)||d(t.src)||t.crossOrigin||(t.crossOrigin=\"anonymous\",t.src=t.src)}static getDataDimensions(t){return t instanceof HTMLVideoElement?{width:t.videoWidth,height:t.videoHeight}:t}static estimateTexMemRequired(t,e){if(a(t))return 0;if(l(t)||p(t))return e.encoding===S.KTX2_ENCODING?f(t,e.mipmap):e.encoding===S.BASIS_ENCODING?w(t,e.mipmap):t.byteLength;const{width:r,height:i}=t instanceof Image||t instanceof ImageData||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement?S.getDataDimensions(t):e;return(e.mipmap?4/3:1)*r*i*(e.components||4)||0}dispose(){this.data=void 0}get width(){return this.params.width}get height(){return this.params.height}createDescriptor(t){var e;return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?9987:9729,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:null!=(e=this.params.maxAnisotropy)?e:this.params.mipmap?t.parameters.maxMaxAnisotropy:1}}load(t,e){if(o(this.glTexture))return this.glTexture;if(o(this.loadingPromise))return this.loadingPromise;const r=this.data;return a(r)?(this.glTexture=new E(t,this.createDescriptor(t),null),this.glTexture):\"string\"==typeof r?this.loadFromURL(t,e,r):r instanceof Image?this.loadFromImageElement(t,e,r):r instanceof HTMLVideoElement?this.loadFromVideoElement(t,e,r):r instanceof ImageData||r instanceof HTMLCanvasElement?this.loadFromImage(t,r,e):(l(r)||p(r))&&this.params.encoding===S.DDS_ENCODING?this.loadFromDDSData(t,r):(l(r)||p(r))&&this.params.encoding===S.KTX2_ENCODING?this.loadFromKTX2(t,r):(l(r)||p(r))&&this.params.encoding===S.BASIS_ENCODING?this.loadFromBasis(t,r):p(r)?this.loadFromPixelData(t,r):l(r)?this.loadFromPixelData(t,new Uint8Array(r)):null}get requiresFrameUpdates(){return this.data instanceof HTMLVideoElement}frameUpdate(t,e,r){if(!(this.data instanceof HTMLVideoElement)||a(this.glTexture))return r;if(this.data.readyState<2||r===this.data.currentTime)return r;if(o(this.powerOfTwoStretchInfo)){const{framebuffer:r,vao:i,sourceTexture:s}=this.powerOfTwoStretchInfo;s.setData(this.data),this.drawStretchedTexture(t,e,r,i,s,this.glTexture)}else{const{width:t,height:e}=this.data,{width:r,height:i}=this.glTexture.descriptor;t!==r||e!==i?this.glTexture.updateData(0,0,0,Math.min(t,r),Math.min(e,i),this.data):this.glTexture.setData(this.data)}return this.glTexture.descriptor.hasMipmap&&this.glTexture.generateMipmap(),this.data.currentTime}loadFromDDSData(t,e){return this.glTexture=F(t,this.createDescriptor(t),e),this.glTexture}loadFromKTX2(t,e){return this.loadAsync((()=>T(t,this.createDescriptor(t),e).then((t=>(this.glTexture=t,t)))))}loadFromBasis(t,e){return this.loadAsync((()=>x(t,this.createDescriptor(t),e).then((t=>(this.glTexture=t,t)))))}loadFromPixelData(t,e){y(this.params.width>0&&this.params.height>0);const r=this.createDescriptor(t);return r.pixelFormat=1===this.params.components?6409:3===this.params.components?6407:6408,r.width=this.params.width,r.height=this.params.height,this.glTexture=new E(t,r,e),this.glTexture}loadAsync(t){const e=n();this.loadingController=e;const r=t(e.signal);this.loadingPromise=r;const i=()=>{this.loadingController===e&&(this.loadingController=null),this.loadingPromise===r&&(this.loadingPromise=null)};return r.then(i,i),r}loadFromURL(t,e,r){return this.loadAsync((async i=>{const s=await u(r,{signal:i});return this.loadFromImage(t,s,e)}))}loadFromImageElement(t,e,r){return r.complete?this.loadFromImage(t,r,e):this.loadAsync((async i=>{const s=await g(r,r.src,!1,i);return this.loadFromImage(t,s,e)}))}loadFromVideoElement(t,e,r){return r.readyState>=2?this.loadFromImage(t,r,e):this.loadFromVideoElementAsync(t,e,r)}loadFromVideoElementAsync(t,r,i){return this.loadAsync((s=>new Promise(((a,n)=>{const l=()=>{i.removeEventListener(\"loadeddata\",p),i.removeEventListener(\"error\",d),o(c)&&c.remove()},p=()=>{i.readyState>=2&&(l(),a(this.loadFromImage(t,i,r)))},d=t=>{l(),n(t||new e(\"Failed to load video\"))};i.addEventListener(\"loadeddata\",p),i.addEventListener(\"error\",d);const c=m(s,(()=>d(h())))}))))}loadFromImage(t,e,r){const s=S.getDataDimensions(e);this.params.width=s.width,this.params.height=s.height;const a=this.createDescriptor(t);return a.pixelFormat=3===this.params.components?6407:6408,!this.requiresPowerOfTwo(t,a)||i(s.width)&&i(s.height)?(a.width=s.width,a.height=s.height,this.glTexture=new E(t,a,e),this.glTexture):(this.glTexture=this.makePowerOfTwoTexture(t,e,s,a,r),this.glTexture)}requiresPowerOfTwo(t,e){const r=33071,i=\"number\"==typeof e.wrapMode?e.wrapMode===r:e.wrapMode.s===r&&e.wrapMode.t===r;return!b(t.gl)&&(e.hasMipmap||!i)}makePowerOfTwoTexture(e,r,i,a,o){const{width:n,height:m}=i,h=s(n),l=s(m);let p;switch(a.width=h,a.height=l,this.params.powerOfTwoResizeMode){case 2:a.textureCoordinateScaleFactor=[n/h,m/l],p=new E(e,a),p.updateData(0,0,0,n,m,r);break;case 1:case null:case void 0:p=this.stretchToPowerOfTwo(e,r,a,o);break;default:t(this.params.powerOfTwoResizeMode)}return a.hasMipmap&&p.generateMipmap(),p}stretchToPowerOfTwo(t,e,r,i){const s=new E(t,r),a=new I(t,{colorTarget:0,depthStencilTarget:0},s),o=new E(t,{target:3553,pixelFormat:r.pixelFormat,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!!r.flipped,maxAnisotropy:8,preMultiplyAlpha:r.preMultiplyAlpha},e),n=M(t);return this.drawStretchedTexture(t,i,a,n,o,s),this.requiresFrameUpdates?this.powerOfTwoStretchInfo={vao:n,sourceTexture:o,framebuffer:a}:(n.dispose(!0),o.dispose(),a.detachColorTexture(),t.bindFramebuffer(null),a.dispose()),s}drawStretchedTexture(t,e,r,i,s,a){t.bindFramebuffer(r);const o=t.getViewport();t.setViewport(0,0,a.descriptor.width,a.descriptor.height);const n=e.program;t.useProgram(n),n.setUniform4f(\"color\",1,1,1,1),n.bindTexture(s,\"tex\"),t.bindVAO(i),t.setPipelineState(e.pipeline),t.drawArrays(5,0,O(i,\"geometry\")),t.bindFramebuffer(null),t.setViewport(o.x,o.y,o.width,o.height)}unload(){if(o(this.powerOfTwoStretchInfo)){const{framebuffer:t,vao:e,sourceTexture:r}=this.powerOfTwoStretchInfo;e.dispose(!0),r.dispose(),t.dispose(),this.glTexture=null,this.powerOfTwoStretchInfo=null}if(o(this.glTexture)&&(this.glTexture.dispose(),this.glTexture=null),o(this.loadingController)){const t=this.loadingController;this.loadingController=null,this.loadingPromise=null,t.abort()}this.events.emit(\"unloaded\")}}S.DDS_ENCODING=\"image/vnd-ms.dds\",S.KTX2_ENCODING=\"image/ktx2\",S.BASIS_ENCODING=\"image/x.basis\";export{S as Texture};\n"]},"metadata":{},"sourceType":"module"}