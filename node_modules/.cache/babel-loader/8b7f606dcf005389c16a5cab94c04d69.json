{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../chunks/tslib.es6.js\";\nimport t from \"../../../../core/Accessor.js\";\nimport { someMap as r } from \"../../../../core/MapUtils.js\";\nimport { unwrapOr as o, isSome as s } from \"../../../../core/maybe.js\";\nimport { NullUID as d } from \"../../../../core/uid.js\";\nimport { property as i } from \"../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../core/has.js\";\nimport \"../../../../core/accessorSupport/ensureType.js\";\nimport \"../../../../core/Logger.js\";\nimport { subclass as c } from \"../../../../core/accessorSupport/decorators/subclass.js\";\nimport { GeometryRecord as a } from \"./GeometryRecord.js\";\nimport { assert as n } from \"./Util.js\";\nlet m = class extends t {\n  constructor(e) {\n    super(e), this._residentGeomRecords = new Map(), this._dirtyGeomRecords = new Map(), this.dirty = !1;\n  }\n\n  commit(e) {\n    this.dirty = !1, this._dirtyGeomRecords.forEach((t, r) => this.commitLayer(r, e));\n  }\n\n  commitLayer(e, t) {\n    const r = this._dirtyGeomRecords.get(e);\n\n    r && (r.forEach((r, o) => {\n      const s = this._ensureGeomRecord(e, o);\n\n      r.forEach((e, r) => {\n        const d = e[0],\n              i = e[1],\n              c = e[2];\n        let m = !1;\n\n        if (2 & i) {\n          const e = s.get(r);\n\n          if (e) {\n            const r = e[1];\n\n            if (4 & c) {\n              const e = this.model.getObject(o);\n              this.model.updateRenderGeometryTransformation(e, d, r) && (m = !0);\n            }\n\n            m || t.updates.push({\n              renderGeometry: r,\n              updateType: c\n            });\n          } else n(!1, \"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update\");\n        }\n\n        if (4 & i || m) {\n          const e = s.get(r);\n          e ? (t.removes.push(e[1]), s.delete(r), e[0].disposed && a.pool.release(e[0])) : 4 === i && n(!1, \"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove\");\n        }\n\n        if (1 & i || m) {\n          const e = this.model.getObject(o),\n                i = this.model.getRenderGeometry(e, d),\n                c = [d, i];\n          t.adds.push(i), s.set(r, c);\n        }\n      }), 0 === s.size && this._residentGeomRecords.get(e).delete(o);\n    }), 0 === this._residentGeomRecords.get(e).size && this._residentGeomRecords.delete(e), this._dirtyGeomRecords.delete(e));\n  }\n\n  getResidentRenderGeometries(e, t) {\n    const r = this._residentGeomRecords.get(e);\n\n    r && r.forEach(e => e.forEach(e => t.push(e[1])));\n  }\n\n  _objectStateChanged(e, t) {\n    for (const r of t.geometryRecords) this._updateOrCreateDirtyRecord(t, r, null, 2, 0, 0, 2, 5, e);\n  }\n\n  visibilityChanged(e) {\n    this._objectStateChanged(1, e);\n  }\n\n  highlightChanged(e) {\n    this._objectStateChanged(8, e);\n  }\n\n  occlusionChanged(e) {\n    this._objectStateChanged(16, e);\n  }\n\n  vertexAttrsUpdated(e) {\n    this._updateOrCreateDirtyRecord(e.object, e.record, null, 2, 0, 0, 2, 5, 2);\n  }\n\n  layerAdded(e) {\n    e.objects.forAll(t => this._layerObjectAdded(e, t));\n  }\n\n  layerRemoved(e) {\n    e.objects.forAll(t => this._layerObjectRemoved(e, t));\n  }\n\n  layerObjectAdded(e) {\n    this._layerObjectAdded(e.layer, e.object);\n  }\n\n  _layerObjectAdded(e, t) {\n    const r = e.id,\n          o = t.geometryRecords;\n\n    for (let s = 0; s < o.length; s++) this._objectGeometryAdded(t, o[s], r);\n  }\n\n  layerObjectRemoved(e) {\n    this._layerObjectRemoved(e.layer, e.object);\n  }\n\n  layerObjectsAdded(e) {\n    for (const t of e.objects) this._layerObjectAdded(e.layer, t);\n  }\n\n  layerObjectsRemoved(e) {\n    for (const t of e.objects) this._layerObjectRemoved(e.layer, t);\n  }\n\n  _layerObjectRemoved(e, t) {\n    const r = e.id,\n          o = t.geometryRecords;\n\n    for (let s = 0; s < o.length; s++) this._objectGeometryRemoved(t, o[s], r);\n  }\n\n  shaderTransformationChanged(e) {\n    const t = this._residentGeomRecords.get(e.id);\n\n    t && t.forEach((e, t) => {\n      const r = this.model.getObject(t);\n      r && r.hasVolativeTransformation() && e.forEach(e => {\n        e[1].shaderTransformationChanged();\n      });\n    });\n  }\n\n  objectTransformation(e) {\n    const t = this._getParentLayerId(e),\n          r = e.id;\n\n    this._ensureGeomRecord(t, r).forEach(r => {\n      this._updateOrCreateDirtyRecord(e, r[0], t, 2, 0, 0, 2, 5, 4);\n    });\n  }\n\n  objectGeometryAdded(e) {\n    this._objectGeometryAdded(e.object, e.record);\n  }\n\n  _objectGeometryAdded(e, t, r = null) {\n    this._updateOrCreateDirtyRecord(e, t, r, 1, 4, 0, 0, 0);\n  }\n\n  objectGeometryRemoved(e) {\n    this._objectGeometryRemoved(e.object, e.record);\n  }\n\n  _objectGeometryRemoved(e, t, r = null) {\n    this._updateOrCreateDirtyRecord(e, t, r, 4, 1, 2, 0, 0);\n  }\n\n  _updateOrCreateDirtyRecord(e, t, r, s, d, i, c, m, h) {\n    r = o(r, this._getParentLayerId(e));\n\n    const l = e.id,\n          y = t.id,\n          p = this._ensureDirtyRecord(r, l),\n          R = p.get(y);\n\n    if (R) {\n      const e = R[1];\n      e & d ? (p.delete(y), R[0].disposed && a.pool.release(R[0])) : e & i ? (R[1] = s, R[2] = h) : e & c ? R[2] |= h : e & m || n(!1, \"ModelDirtySet.objectGeometryAdded: inconsistent state\");\n    } else p.set(y, [t, s, h]);\n\n    this.dirty = this._hasDirtyGeometryRecords;\n  }\n\n  _ensureGeomRecord(e, t) {\n    let r = this._residentGeomRecords.get(e);\n\n    r || (r = new Map(), this._residentGeomRecords.set(e, r));\n    let o = r.get(t);\n    return o || (o = new Map(), r.set(t, o)), o;\n  }\n\n  get _hasDirtyGeometryRecords() {\n    return r(this._dirtyGeomRecords, e => r(e, e => e && e.size > 0));\n  }\n\n  _ensureDirtyRecord(e, t) {\n    let r = this._dirtyGeomRecords.get(e);\n\n    r || (r = new Map(), this._dirtyGeomRecords.set(e, r));\n    let o = r.get(t);\n    return o || (o = new Map(), r.set(t, o)), o;\n  }\n\n  _getParentLayerId(e) {\n    return s(e.parentLayer) ? e.parentLayer.id : d;\n  }\n\n  formatDebugInfo() {\n    const e = [\"ADD\", \"UPD\", void 0, \"REM\"];\n    let t = \"\";\n    return this._dirtyGeomRecords.forEach((r, o) => {\n      r.forEach((r, s) => {\n        t.length > 0 && (t += \"\\n\"), t += o + \".\" + s;\n        const d = [];\n        r.forEach(e => {\n          const t = e[1];\n          d[t] || (d[t] = []), d[t].push(e[0].geometry.id);\n        });\n\n        for (let o = 0; o < d.length; o++) if (d[o]) {\n          t += \" \" + e[o - 1] + \": \";\n\n          for (let e = 0; e < d[o].length; e++) t += d[o][e] + \", \";\n        }\n      });\n    }), t;\n  }\n\n  get test() {\n    const e = this;\n    return {\n      get residentLayerCount() {\n        return e._residentGeomRecords.size;\n      },\n\n      get residentObjectCount() {\n        return Array.from(e._residentGeomRecords.values()).reduce((e, t) => e + t.size, 0);\n      }\n\n    };\n  }\n\n};\ne([i({\n  constructOnly: !0\n})], m.prototype, \"model\", void 0), e([i()], m.prototype, \"dirty\", void 0), m = e([c(\"esri.views.3d.webgl-engine.lib.ModelDirtySet\")], m);\nvar h = m;\nexport default h;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/webgl-engine/lib/ModelDirtySet.js"],"names":["_","e","t","someMap","r","unwrapOr","o","isSome","s","NullUID","d","property","i","subclass","c","GeometryRecord","a","assert","n","m","constructor","_residentGeomRecords","Map","_dirtyGeomRecords","dirty","commit","forEach","commitLayer","get","_ensureGeomRecord","model","getObject","updateRenderGeometryTransformation","updates","push","renderGeometry","updateType","removes","delete","disposed","pool","release","getRenderGeometry","adds","set","size","getResidentRenderGeometries","_objectStateChanged","geometryRecords","_updateOrCreateDirtyRecord","visibilityChanged","highlightChanged","occlusionChanged","vertexAttrsUpdated","object","record","layerAdded","objects","forAll","_layerObjectAdded","layerRemoved","_layerObjectRemoved","layerObjectAdded","layer","id","length","_objectGeometryAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","_objectGeometryRemoved","shaderTransformationChanged","hasVolativeTransformation","objectTransformation","_getParentLayerId","objectGeometryAdded","objectGeometryRemoved","h","l","y","p","_ensureDirtyRecord","R","_hasDirtyGeometryRecords","parentLayer","formatDebugInfo","geometry","test","residentLayerCount","residentObjectCount","Array","from","values","reduce","constructOnly","prototype"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../chunks/tslib.es6.js\";import t from\"../../../../core/Accessor.js\";import{someMap as r}from\"../../../../core/MapUtils.js\";import{unwrapOr as o,isSome as s}from\"../../../../core/maybe.js\";import{NullUID as d}from\"../../../../core/uid.js\";import{property as i}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/ensureType.js\";import\"../../../../core/Logger.js\";import{subclass as c}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{GeometryRecord as a}from\"./GeometryRecord.js\";import{assert as n}from\"./Util.js\";let m=class extends t{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commit(e){this.dirty=!1,this._dirtyGeomRecords.forEach(((t,r)=>this.commitLayer(r,e)))}commitLayer(e,t){const r=this._dirtyGeomRecords.get(e);r&&(r.forEach(((r,o)=>{const s=this._ensureGeomRecord(e,o);r.forEach(((e,r)=>{const d=e[0],i=e[1],c=e[2];let m=!1;if(2&i){const e=s.get(r);if(e){const r=e[1];if(4&c){const e=this.model.getObject(o);this.model.updateRenderGeometryTransformation(e,d,r)&&(m=!0)}m||t.updates.push({renderGeometry:r,updateType:c})}else n(!1,\"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update\")}if(4&i||m){const e=s.get(r);e?(t.removes.push(e[1]),s.delete(r),e[0].disposed&&a.pool.release(e[0])):4===i&&n(!1,\"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove\")}if(1&i||m){const e=this.model.getObject(o),i=this.model.getRenderGeometry(e,d),c=[d,i];t.adds.push(i),s.set(r,c)}})),0===s.size&&this._residentGeomRecords.get(e).delete(o)})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e))}getResidentRenderGeometries(e,t){const r=this._residentGeomRecords.get(e);r&&r.forEach((e=>e.forEach((e=>t.push(e[1])))))}_objectStateChanged(e,t){for(const r of t.geometryRecords)this._updateOrCreateDirtyRecord(t,r,null,2,0,0,2,5,e)}visibilityChanged(e){this._objectStateChanged(1,e)}highlightChanged(e){this._objectStateChanged(8,e)}occlusionChanged(e){this._objectStateChanged(16,e)}vertexAttrsUpdated(e){this._updateOrCreateDirtyRecord(e.object,e.record,null,2,0,0,2,5,2)}layerAdded(e){e.objects.forAll((t=>this._layerObjectAdded(e,t)))}layerRemoved(e){e.objects.forAll((t=>this._layerObjectRemoved(e,t)))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const r=e.id,o=t.geometryRecords;for(let s=0;s<o.length;s++)this._objectGeometryAdded(t,o[s],r)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const r=e.id,o=t.geometryRecords;for(let s=0;s<o.length;s++)this._objectGeometryRemoved(t,o[s],r)}shaderTransformationChanged(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach(((e,t)=>{const r=this.model.getObject(t);r&&r.hasVolativeTransformation()&&e.forEach((e=>{e[1].shaderTransformationChanged()}))}))}objectTransformation(e){const t=this._getParentLayerId(e),r=e.id;this._ensureGeomRecord(t,r).forEach((r=>{this._updateOrCreateDirtyRecord(e,r[0],t,2,0,0,2,5,4)}))}objectGeometryAdded(e){this._objectGeometryAdded(e.object,e.record)}_objectGeometryAdded(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,1,4,0,0,0)}objectGeometryRemoved(e){this._objectGeometryRemoved(e.object,e.record)}_objectGeometryRemoved(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,4,1,2,0,0)}_updateOrCreateDirtyRecord(e,t,r,s,d,i,c,m,h){r=o(r,this._getParentLayerId(e));const l=e.id,y=t.id,p=this._ensureDirtyRecord(r,l),R=p.get(y);if(R){const e=R[1];e&d?(p.delete(y),R[0].disposed&&a.pool.release(R[0])):e&i?(R[1]=s,R[2]=h):e&c?R[2]|=h:e&m||n(!1,\"ModelDirtySet.objectGeometryAdded: inconsistent state\")}else p.set(y,[t,s,h]);this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(e,t){let r=this._residentGeomRecords.get(e);r||(r=new Map,this._residentGeomRecords.set(e,r));let o=r.get(t);return o||(o=new Map,r.set(t,o)),o}get _hasDirtyGeometryRecords(){return r(this._dirtyGeomRecords,(e=>r(e,(e=>e&&e.size>0))))}_ensureDirtyRecord(e,t){let r=this._dirtyGeomRecords.get(e);r||(r=new Map,this._dirtyGeomRecords.set(e,r));let o=r.get(t);return o||(o=new Map,r.set(t,o)),o}_getParentLayerId(e){return s(e.parentLayer)?e.parentLayer.id:d}formatDebugInfo(){const e=[\"ADD\",\"UPD\",void 0,\"REM\"];let t=\"\";return this._dirtyGeomRecords.forEach(((r,o)=>{r.forEach(((r,s)=>{t.length>0&&(t+=\"\\n\"),t+=o+\".\"+s;const d=[];r.forEach((e=>{const t=e[1];d[t]||(d[t]=[]),d[t].push(e[0].geometry.id)}));for(let o=0;o<d.length;o++)if(d[o]){t+=\" \"+e[o-1]+\": \";for(let e=0;e<d[o].length;e++)t+=d[o][e]+\", \"}}))})),t}get test(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce(((e,t)=>e+t.size),0)}}}};e([i({constructOnly:!0})],m.prototype,\"model\",void 0),e([i()],m.prototype,\"dirty\",void 0),m=e([c(\"esri.views.3d.webgl-engine.lib.ModelDirtySet\")],m);var h=m;export default h;\n"]},"metadata":{},"sourceType":"module"}