{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../../chunks/tslib.es6.js\";\nimport \"../../../../../core/Error.js\";\nimport t from \"../../../../../core/has.js\";\nimport s from \"../../../../../core/Logger.js\";\nimport { isSome as r, andThen as i, isNone as a, unwrapOrThrow as o, unwrap as n } from \"../../../../../core/maybe.js\";\nimport { throwIfAborted as l, all as c, isAbortError as d } from \"../../../../../core/promiseUtils.js\";\nimport \"../../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../../core/accessorSupport/ensureType.js\";\nimport { subclass as m } from \"../../../../../core/accessorSupport/decorators/subclass.js\";\nimport { diff as u, hasDiff as f } from \"../../../../../core/accessorSupport/diffUtils.js\";\nimport h from \"../../../../../geometry/SpatialReference.js\";\nimport { forEachGeometryType as p } from \"../../../engine/webgl/Utils.js\";\nimport { DisplayRecordReader as g } from \"../../../engine/webgl/cpuMapped/DisplayRecordReader.js\";\nimport { MeshData as y } from \"../../../engine/webgl/mesh/MeshData.js\";\nimport { WGLMeshFactory as _ } from \"../../../engine/webgl/mesh/factories/WGLMeshFactory.js\";\nimport { WGLTemplateStore as b } from \"../../../engine/webgl/mesh/templates/WGLTemplateStore.js\";\nimport { bidiText as S } from \"../../../engine/webgl/util/BidiText.js\";\nimport { createMatcher as w } from \"../../../engine/webgl/util/Matcher.js\";\nimport { codepoints as v } from \"../textUtils.js\";\nimport D from \"./BaseProcessor.js\";\nimport { isAggregateId as T } from \"../support/AttributeStore.js\";\n\nfunction j(e, t) {\n  return (!e.minScale || e.minScale >= t) && (!e.maxScale || e.maxScale <= t);\n}\n\nfunction k(e) {\n  const t = e.message,\n        s = {\n    message: {\n      data: {},\n      tileKey: t.tileKey\n    },\n    transferList: new Array()\n  };\n\n  for (const a in t.data) {\n    const e = t.data[a];\n\n    if (s.message.data[a] = null, r(e)) {\n      const t = e.stride,\n            r = e.indices.slice(0),\n            o = e.vertices.slice(0),\n            n = e.records.slice(0),\n            l = {\n        stride: t,\n        indices: r,\n        vertices: o,\n        records: n,\n        metrics: i(e.metrics, e => e.slice(0))\n      };\n      s.transferList.push(r, o, n), s.message.data[a] = l;\n    }\n  }\n\n  return s;\n}\n\ns.getLogger(\"esri.views.2d.layers.features.processors.SymbolProcessor\");\nlet x = class extends D {\n  constructor() {\n    super(...arguments), this.type = \"symbol\", this._matchers = {\n      feature: null,\n      aggregate: null\n    }, this._bufferData = new Map();\n  }\n\n  initialize() {\n    this.handles.add([this.tileStore.on(\"update\", this.onTileUpdate.bind(this))]);\n  }\n\n  destroy() {}\n\n  get supportsTileUpdates() {\n    return !0;\n  }\n\n  async update(e, s) {\n    const r = s.schema.processors[0];\n    if (\"symbol\" !== r.type) return;\n    const i = u(this._schema, r);\n    f(i, \"mesh\") && (t(\"esri-2d-update-debug\") && console.debug(\"Applying Update - Processor:\", i), e.mesh = !0, e.why.mesh.push(\"Symbology changed\"), this._schema = r, this._factory = this._createFactory(r), this._factory.update(r, this.tileStore.tileScheme.tileInfo));\n  }\n\n  onTileMessage(e, t, s, r) {\n    return l(r), this._onTileData(e, t, s, r);\n  }\n\n  onTileClear(e) {\n    const t = {\n      clear: !0\n    };\n    return this._bufferData.delete(e.key.id), this.remoteClient.invoke(\"tileRenderer.onTileData\", {\n      tileKey: e.id,\n      data: t\n    });\n  }\n\n  onTileError(e, t, s) {\n    const r = s.signal,\n          i = {\n      tileKey: e.id,\n      error: t\n    };\n    return this.remoteClient.invoke(\"tileRenderer.onTileError\", i, {\n      signal: r\n    });\n  }\n\n  onTileUpdate(e) {\n    for (const t of e.removed) {\n      if (!this._bufferData.has(t.key.id)) continue;\n      this._bufferData.get(t.key.id).forEach(e => {\n        const t = new Set();\n        p(s => {\n          const i = e.message.data[s];\n\n          if (r(i)) {\n            const e = g.from(i.records).getCursor();\n\n            for (; e.next();) t.add(e.id);\n          }\n        });\n        const s = e.message.tileKey,\n              i = {\n          type: \"update\",\n          addOrUpdate: null\n        };\n        return this.remoteClient.invoke(\"tileRenderer.onTileData\", {\n          tileKey: s,\n          data: i\n        });\n      }), this._bufferData.delete(t.key.id);\n    }\n\n    for (const t of e.added) this._bufferData.forEach(e => {\n      for (const s of e) s.message.tileKey === t.id && this._updateTileMesh(\"append\", t, k(s), [], !1, !1, null);\n    });\n  }\n\n  _addBufferData(e, t) {\n    this._bufferData.has(e) || this._bufferData.set(e, []), this._bufferData.get(e).push(k(t));\n  }\n\n  _createFactory(e) {\n    const {\n      geometryType: t,\n      objectIdField: s,\n      fields: r\n    } = this.service,\n          a = (e, t) => this.remoteClient.invoke(\"tileRenderer.getMaterialItems\", e, t),\n          o = {\n      geometryType: t,\n      fields: r,\n      spatialReference: h.fromJSON(this.spatialReference)\n    },\n          n = new b(a, this.tileStore.tileScheme.tileInfo),\n          {\n      matcher: l,\n      aggregateMatcher: c\n    } = e.mesh;\n\n    return this._store = n, this._matchers.feature = w(l, n, o), this._matchers.aggregate = i(c, e => w(e, n, o)), new _(t, s, n);\n  }\n\n  async _onTileData(e, t, s, r) {\n    const {\n      type: i,\n      addOrUpdate: o,\n      remove: n\n    } = t,\n          l = t.end;\n\n    if (!o) {\n      const t = {\n        type: i,\n        addOrUpdate: null,\n        remove: n,\n        clear: !1,\n        end: l\n      };\n      return this.remoteClient.invoke(\"tileRenderer.onTileData\", {\n        tileKey: e.id,\n        data: t\n      }, r);\n    }\n\n    const d = this._processFeatures(e, o, s, r);\n\n    try {\n      const s = await d;\n\n      if (a(s)) {\n        const t = {\n          type: i,\n          addOrUpdate: null,\n          remove: n,\n          clear: !1,\n          end: l\n        };\n        return this.remoteClient.invoke(\"tileRenderer.onTileData\", {\n          tileKey: e.id,\n          data: t\n        }, r);\n      }\n\n      for (const t of s) e.key.id !== t.message.tileKey && this._addBufferData(e.key.id, t);\n\n      await c(s.map(s => {\n        const a = e.key.id === s.message.tileKey,\n              o = a ? t.remove : [],\n              n = a && t.end;\n        return this._updateTileMesh(i, e, s, o, n, t.clear, r.signal);\n      }));\n    } catch (m) {\n      this._handleError(e, m, r);\n    }\n  }\n\n  async _updateTileMesh(e, t, s, r, a, o, c) {\n    const d = e,\n          m = s.message.tileKey;\n    m !== t.key.id && (a = !1);\n    const u = i(s, e => e.message),\n          f = i(s, e => e.transferList) || [],\n          h = {\n      type: d,\n      addOrUpdate: u,\n      remove: r,\n      clear: !1,\n      end: a\n    },\n          p = {\n      transferList: n(f) || [],\n      signal: c\n    };\n    return l(p), this.remoteClient.invoke(\"tileRenderer.onTileData\", {\n      tileKey: m,\n      data: h\n    }, p);\n  }\n\n  async _processFeatures(e, t, s, r) {\n    if (a(t) || !t.hasFeatures) return null;\n    const i = {\n      transform: e.transform,\n      hasZ: !1,\n      hasM: !1\n    },\n          o = this._factory,\n          n = {\n      viewingMode: \"\",\n      scale: e.scale\n    },\n          c = await this._matchers.feature,\n          d = await this._matchers.aggregate;\n    l(r);\n\n    const m = this._getLabelInfos(e, t);\n\n    return await o.analyze(t.getCursor(), c, d, i, n), l(r), this._writeFeatureSet(e, t, i, m, o, s);\n  }\n\n  _writeFeatureSet(e, t, s, i, a, o) {\n    const n = t.getSize(),\n          l = \"simple\" === this._schema.mesh.matcher.type && this._schema.mesh.matcher.isDotDensity,\n          c = new y(e.key.id, {\n      features: n,\n      records: n,\n      metrics: 0\n    }, l, o, !0),\n          d = {\n      viewingMode: \"\",\n      scale: e.scale\n    },\n          m = t.getCursor();\n\n    for (; m.next();) try {\n      const t = m.getDisplayId(),\n            o = r(i) ? i.get(t) : null;\n      a.writeCursor(c, m, s, d, e.level, o);\n    } catch (f) {}\n\n    const u = e.tileInfoView.tileInfo.isWrappable;\n    return c.serialize(u);\n  }\n\n  _handleError(e, t, s) {\n    if (!d(t)) {\n      const r = {\n        tileKey: e.id,\n        error: t.message\n      };\n      return this.remoteClient.invoke(\"tileRenderer.onTileError\", r, {\n        signal: s.signal\n      });\n    }\n  }\n\n  _getLabelingSchemaForScale(e) {\n    const t = this._schema.mesh.labels;\n    if (a(t)) return null;\n\n    if (\"subtype\" === t.type) {\n      const s = {\n        type: \"subtype\",\n        classes: {}\n      };\n      let r = !1;\n\n      for (const i in t.classes) {\n        const a = t.classes[i].filter(t => j(t, e.scale));\n        r = r || !!a.length, s.classes[i] = a;\n      }\n\n      return r ? s : null;\n    }\n\n    const s = t.classes.filter(t => j(t, e.scale));\n    return s.length ? {\n      type: \"simple\",\n      classes: s\n    } : null;\n  }\n\n  _getLabels(e, t) {\n    if (\"subtype\" === t.type) {\n      var s;\n      const r = this.service.subtypeField,\n            i = o(r, \"Expected to find subtype Field\"),\n            a = e.readAttribute(i);\n      return null == a ? [] : null != (s = t.classes[a]) ? s : [];\n    }\n\n    return t.classes;\n  }\n\n  _getLabelInfos(e, t) {\n    const s = this._getLabelingSchemaForScale(e);\n\n    if (a(s)) return null;\n    const r = new Map(),\n          i = t.getCursor();\n\n    for (; i.next();) {\n      const e = i.getDisplayId(),\n            t = [],\n            a = T(e),\n            o = a && 1 !== i.readAttribute(\"cluster_count\") ? \"aggregate\" : \"feature\",\n            n = this._getLabels(i, s);\n\n      for (const s of n) {\n        if (s.target !== o) continue;\n        const r = i.getStorage(),\n              n = a && \"feature\" === o ? r.getComputedStringAtIndex(i.readAttribute(\"referenceId\"), s.fieldIndex) : r.getComputedStringAtIndex(e, s.fieldIndex);\n        if (!n) continue;\n        const l = S(n.toString()),\n              c = l[0],\n              d = l[1];\n\n        this._store.getMosaicItem(s.symbol, v(c)).then(e => {\n          t[s.index] = {\n            glyphs: e.glyphMosaicItems,\n            rtl: d,\n            index: s.index\n          };\n        });\n      }\n\n      r.set(e, t);\n    }\n\n    return r;\n  }\n\n};\nx = e([m(\"esri.views.2d.layers.features.processors.SymbolProcessor\")], x);\nvar I = x;\nexport default I;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/2d/layers/features/processors/SymbolProcessor.js"],"names":["_","e","t","s","isSome","r","andThen","i","isNone","a","unwrapOrThrow","o","unwrap","n","throwIfAborted","l","all","c","isAbortError","d","subclass","m","diff","u","hasDiff","f","h","forEachGeometryType","p","DisplayRecordReader","g","MeshData","y","WGLMeshFactory","WGLTemplateStore","b","bidiText","S","createMatcher","w","codepoints","v","D","isAggregateId","T","j","minScale","maxScale","k","message","data","tileKey","transferList","Array","stride","indices","slice","vertices","records","metrics","push","getLogger","x","constructor","arguments","type","_matchers","feature","aggregate","_bufferData","Map","initialize","handles","add","tileStore","on","onTileUpdate","bind","destroy","supportsTileUpdates","update","schema","processors","_schema","console","debug","mesh","why","_factory","_createFactory","tileScheme","tileInfo","onTileMessage","_onTileData","onTileClear","clear","delete","key","id","remoteClient","invoke","onTileError","signal","error","removed","has","get","forEach","Set","from","getCursor","next","addOrUpdate","added","_updateTileMesh","_addBufferData","set","geometryType","objectIdField","fields","service","spatialReference","fromJSON","matcher","aggregateMatcher","_store","remove","end","_processFeatures","map","_handleError","hasFeatures","transform","hasZ","hasM","viewingMode","scale","_getLabelInfos","analyze","_writeFeatureSet","getSize","isDotDensity","features","getDisplayId","writeCursor","level","tileInfoView","isWrappable","serialize","_getLabelingSchemaForScale","labels","classes","filter","length","_getLabels","subtypeField","readAttribute","target","getStorage","getComputedStringAtIndex","fieldIndex","toString","getMosaicItem","symbol","then","index","glyphs","glyphMosaicItems","rtl","I"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../../chunks/tslib.es6.js\";import\"../../../../../core/Error.js\";import t from\"../../../../../core/has.js\";import s from\"../../../../../core/Logger.js\";import{isSome as r,andThen as i,isNone as a,unwrapOrThrow as o,unwrap as n}from\"../../../../../core/maybe.js\";import{throwIfAborted as l,all as c,isAbortError as d}from\"../../../../../core/promiseUtils.js\";import\"../../../../../core/accessorSupport/decorators/property.js\";import\"../../../../../core/accessorSupport/ensureType.js\";import{subclass as m}from\"../../../../../core/accessorSupport/decorators/subclass.js\";import{diff as u,hasDiff as f}from\"../../../../../core/accessorSupport/diffUtils.js\";import h from\"../../../../../geometry/SpatialReference.js\";import{forEachGeometryType as p}from\"../../../engine/webgl/Utils.js\";import{DisplayRecordReader as g}from\"../../../engine/webgl/cpuMapped/DisplayRecordReader.js\";import{MeshData as y}from\"../../../engine/webgl/mesh/MeshData.js\";import{WGLMeshFactory as _}from\"../../../engine/webgl/mesh/factories/WGLMeshFactory.js\";import{WGLTemplateStore as b}from\"../../../engine/webgl/mesh/templates/WGLTemplateStore.js\";import{bidiText as S}from\"../../../engine/webgl/util/BidiText.js\";import{createMatcher as w}from\"../../../engine/webgl/util/Matcher.js\";import{codepoints as v}from\"../textUtils.js\";import D from\"./BaseProcessor.js\";import{isAggregateId as T}from\"../support/AttributeStore.js\";function j(e,t){return(!e.minScale||e.minScale>=t)&&(!e.maxScale||e.maxScale<=t)}function k(e){const t=e.message,s={message:{data:{},tileKey:t.tileKey},transferList:new Array};for(const a in t.data){const e=t.data[a];if(s.message.data[a]=null,r(e)){const t=e.stride,r=e.indices.slice(0),o=e.vertices.slice(0),n=e.records.slice(0),l={stride:t,indices:r,vertices:o,records:n,metrics:i(e.metrics,(e=>e.slice(0)))};s.transferList.push(r,o,n),s.message.data[a]=l}}return s}s.getLogger(\"esri.views.2d.layers.features.processors.SymbolProcessor\");let x=class extends D{constructor(){super(...arguments),this.type=\"symbol\",this._matchers={feature:null,aggregate:null},this._bufferData=new Map}initialize(){this.handles.add([this.tileStore.on(\"update\",this.onTileUpdate.bind(this))])}destroy(){}get supportsTileUpdates(){return!0}async update(e,s){const r=s.schema.processors[0];if(\"symbol\"!==r.type)return;const i=u(this._schema,r);f(i,\"mesh\")&&(t(\"esri-2d-update-debug\")&&console.debug(\"Applying Update - Processor:\",i),e.mesh=!0,e.why.mesh.push(\"Symbology changed\"),this._schema=r,this._factory=this._createFactory(r),this._factory.update(r,this.tileStore.tileScheme.tileInfo))}onTileMessage(e,t,s,r){return l(r),this._onTileData(e,t,s,r)}onTileClear(e){const t={clear:!0};return this._bufferData.delete(e.key.id),this.remoteClient.invoke(\"tileRenderer.onTileData\",{tileKey:e.id,data:t})}onTileError(e,t,s){const r=s.signal,i={tileKey:e.id,error:t};return this.remoteClient.invoke(\"tileRenderer.onTileError\",i,{signal:r})}onTileUpdate(e){for(const t of e.removed){if(!this._bufferData.has(t.key.id))continue;this._bufferData.get(t.key.id).forEach((e=>{const t=new Set;p((s=>{const i=e.message.data[s];if(r(i)){const e=g.from(i.records).getCursor();for(;e.next();)t.add(e.id)}}));const s=e.message.tileKey,i={type:\"update\",addOrUpdate:null};return this.remoteClient.invoke(\"tileRenderer.onTileData\",{tileKey:s,data:i})})),this._bufferData.delete(t.key.id)}for(const t of e.added)this._bufferData.forEach((e=>{for(const s of e)s.message.tileKey===t.id&&this._updateTileMesh(\"append\",t,k(s),[],!1,!1,null)}))}_addBufferData(e,t){this._bufferData.has(e)||this._bufferData.set(e,[]),this._bufferData.get(e).push(k(t))}_createFactory(e){const{geometryType:t,objectIdField:s,fields:r}=this.service,a=(e,t)=>this.remoteClient.invoke(\"tileRenderer.getMaterialItems\",e,t),o={geometryType:t,fields:r,spatialReference:h.fromJSON(this.spatialReference)},n=new b(a,this.tileStore.tileScheme.tileInfo),{matcher:l,aggregateMatcher:c}=e.mesh;return this._store=n,this._matchers.feature=w(l,n,o),this._matchers.aggregate=i(c,(e=>w(e,n,o))),new _(t,s,n)}async _onTileData(e,t,s,r){const{type:i,addOrUpdate:o,remove:n}=t,l=t.end;if(!o){const t={type:i,addOrUpdate:null,remove:n,clear:!1,end:l};return this.remoteClient.invoke(\"tileRenderer.onTileData\",{tileKey:e.id,data:t},r)}const d=this._processFeatures(e,o,s,r);try{const s=await d;if(a(s)){const t={type:i,addOrUpdate:null,remove:n,clear:!1,end:l};return this.remoteClient.invoke(\"tileRenderer.onTileData\",{tileKey:e.id,data:t},r)}for(const t of s)e.key.id!==t.message.tileKey&&this._addBufferData(e.key.id,t);await c(s.map((s=>{const a=e.key.id===s.message.tileKey,o=a?t.remove:[],n=a&&t.end;return this._updateTileMesh(i,e,s,o,n,t.clear,r.signal)})))}catch(m){this._handleError(e,m,r)}}async _updateTileMesh(e,t,s,r,a,o,c){const d=e,m=s.message.tileKey;m!==t.key.id&&(a=!1);const u=i(s,(e=>e.message)),f=i(s,(e=>e.transferList))||[],h={type:d,addOrUpdate:u,remove:r,clear:!1,end:a},p={transferList:n(f)||[],signal:c};return l(p),this.remoteClient.invoke(\"tileRenderer.onTileData\",{tileKey:m,data:h},p)}async _processFeatures(e,t,s,r){if(a(t)||!t.hasFeatures)return null;const i={transform:e.transform,hasZ:!1,hasM:!1},o=this._factory,n={viewingMode:\"\",scale:e.scale},c=await this._matchers.feature,d=await this._matchers.aggregate;l(r);const m=this._getLabelInfos(e,t);return await o.analyze(t.getCursor(),c,d,i,n),l(r),this._writeFeatureSet(e,t,i,m,o,s)}_writeFeatureSet(e,t,s,i,a,o){const n=t.getSize(),l=\"simple\"===this._schema.mesh.matcher.type&&this._schema.mesh.matcher.isDotDensity,c=new y(e.key.id,{features:n,records:n,metrics:0},l,o,!0),d={viewingMode:\"\",scale:e.scale},m=t.getCursor();for(;m.next();)try{const t=m.getDisplayId(),o=r(i)?i.get(t):null;a.writeCursor(c,m,s,d,e.level,o)}catch(f){}const u=e.tileInfoView.tileInfo.isWrappable;return c.serialize(u)}_handleError(e,t,s){if(!d(t)){const r={tileKey:e.id,error:t.message};return this.remoteClient.invoke(\"tileRenderer.onTileError\",r,{signal:s.signal})}}_getLabelingSchemaForScale(e){const t=this._schema.mesh.labels;if(a(t))return null;if(\"subtype\"===t.type){const s={type:\"subtype\",classes:{}};let r=!1;for(const i in t.classes){const a=t.classes[i].filter((t=>j(t,e.scale)));r=r||!!a.length,s.classes[i]=a}return r?s:null}const s=t.classes.filter((t=>j(t,e.scale)));return s.length?{type:\"simple\",classes:s}:null}_getLabels(e,t){if(\"subtype\"===t.type){var s;const r=this.service.subtypeField,i=o(r,\"Expected to find subtype Field\"),a=e.readAttribute(i);return null==a?[]:null!=(s=t.classes[a])?s:[]}return t.classes}_getLabelInfos(e,t){const s=this._getLabelingSchemaForScale(e);if(a(s))return null;const r=new Map,i=t.getCursor();for(;i.next();){const e=i.getDisplayId(),t=[],a=T(e),o=a&&1!==i.readAttribute(\"cluster_count\")?\"aggregate\":\"feature\",n=this._getLabels(i,s);for(const s of n){if(s.target!==o)continue;const r=i.getStorage(),n=a&&\"feature\"===o?r.getComputedStringAtIndex(i.readAttribute(\"referenceId\"),s.fieldIndex):r.getComputedStringAtIndex(e,s.fieldIndex);if(!n)continue;const l=S(n.toString()),c=l[0],d=l[1];this._store.getMosaicItem(s.symbol,v(c)).then((e=>{t[s.index]={glyphs:e.glyphMosaicItems,rtl:d,index:s.index}}))}r.set(e,t)}return r}};x=e([m(\"esri.views.2d.layers.features.processors.SymbolProcessor\")],x);var I=x;export default I;\n"]},"metadata":{},"sourceType":"module"}