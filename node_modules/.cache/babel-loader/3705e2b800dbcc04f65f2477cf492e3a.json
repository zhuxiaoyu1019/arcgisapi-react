{"ast":null,"code":"import Map from '@arcgis/core/Map';\nimport Color from \"@arcgis/core/Color\";\nimport SceneView from \"@arcgis/core/views/SceneView\";\nimport SceneLayer from '@arcgis/core/layers/SceneLayer';\nimport MeshSymbol3D from '@arcgis/core/symbols/MeshSymbol3D';\nimport SolidEdges3D from '@arcgis/core/symbols/edges/SolidEdges3D';\nimport SimpleRenderer from '@arcgis/core/renderers/SimpleRenderer';\nimport FillSymbol3DLayer from '@arcgis/core/symbols/FillSymbol3DLayer';\nimport GraphicsLayer from '@arcgis/core/layers/GraphicsLayer';\nimport * as promiseUtils from '@arcgis/core/core/promiseUtils';\nimport Polygon from '@arcgis/core/geometry/Polygon';\nimport SpatialReference from '@arcgis/core/geometry/SpatialReference';\nimport Graphic from '@arcgis/core/Graphic';\nimport PolygonSymbol3D from '@arcgis/core/symbols/PolygonSymbol3D';\n\nconst ArcGISMap = (basemap, ref) => {\n  const buildings = new SceneLayer({\n    url: 'https://services.arcgis.com/V6ZHFr6zdgNZuVG0/ArcGIS/rest/services/NYC/SceneServer/layers/0',\n    opacity: 1,\n    popupEnabled: false,\n    renderer: new SimpleRenderer({\n      symbol: new MeshSymbol3D({\n        symbolLayers: [new FillSymbol3DLayer({\n          material: {\n            color: new Color([200, 200, 200]),\n            colorMixMode: \"replace\"\n          },\n          edges: new SolidEdges3D({\n            color: new Color([100, 100, 100, 0.5])\n          })\n        })]\n      })\n    })\n  });\n  const walls = new GraphicsLayer({\n    elevationInfo: {\n      mode: \"absolute-height\"\n    }\n  });\n  const map = new Map({\n    basemap,\n    layers: [buildings, walls]\n  });\n  const view = new SceneView({\n    container: ref,\n    map,\n    qualityProfile: \"high\",\n    camera: {\n      position: [-73.98564294432742, 40.748586782824624, 601.67648],\n      heading: 330.47,\n      tilt: 64.02\n    },\n    environment: {\n      lighting: {\n        directShadowsEnabled: true\n      }\n    }\n  });\n\n  function getCageGraphic(wall, opacity, height) {\n    const geometry = new Polygon({\n      rings: [wall.rings[0].map(coords => [...coords, height])],\n      spatialReference: SpatialReference.WebMercator\n    });\n    return new Graphic({\n      geometry: geometry,\n      symbol: new PolygonSymbol3D({\n        symbolLayers: [new FillSymbol3DLayer({\n          outline: {\n            size: 1.5,\n            color: [153, 255, 253, opacity]\n          },\n          material: {\n            color: [0, 0, 0, 0]\n          }\n        })]\n      })\n    });\n  }\n\n  async function animateFootprint(building, extent, popmotion) {\n    const objectId = building.getObjectId();\n    const query = footprints.createQuery();\n    query.objectIds = [objectId];\n    query.outFields = [\"*\"];\n    query.multipatchOption = \"xyFootprint\";\n    query.returnGeometry = true;\n    const result = await footprints.queryFeatures(query);\n\n    if (result.features.length === 0) {\n      return;\n    }\n\n    const footprint = result.features[0];\n    const hull = geometryEngine.convexHull(footprint.geometry, true);\n    const buffer = geometryEngine.buffer(hull, 10, \"meters\");\n    const wall = geometryEngine.generalize(buffer, 10, true, \"meters\");\n    const size = (extent.zmax - extent.zmin) * 0.9;\n    walls.removeAll();\n\n    function createWall(s) {\n      const mesh = createMesh(wall, extent.zmin, size * s);\n      walls.removeAll();\n      const fill = new FillSymbol3DLayer({\n        material: {\n          color: wallColor,\n          colorMixMode: \"tint\"\n        },\n        castShadows: false\n      });\n      walls.addMany([getCageGraphic(wall, 1, (extent.zmin + 0.5) * s), getCageGraphic(wall, 0.2, (extent.zmin + size / 2) * s), getCageGraphic(wall, 0.6, (extent.zmin + size / 4) * s), getCageGraphic(wall, 0.8, (extent.zmin + size / 8) * s)]);\n      walls.add(new Graphic({\n        geometry: mesh,\n        symbol: new MeshSymbol3D({\n          symbolLayers: [fill]\n        })\n      }));\n    }\n\n    return new Promise(resolve => {\n      popmotion.spring({\n        from: 0,\n        velocity: 0,\n        to: 1,\n        stiffness: 200 // mass: 1,\n        // damping: 10\n\n      }).start({\n        update: createWall,\n        complete: resolve\n      });\n    });\n  }\n\n  function createMesh(polygon, zmin, height = 100) {\n    const ring = polygon.rings[0];\n    const triangles = [];\n    const vertices = [];\n    const colors = [];\n\n    for (let i = 0; i < ring.length; i++) {\n      const vIdx0 = 2 * i;\n      const vIdx1 = 2 * i + 1;\n      const vIdx2 = (2 * i + 2) % (2 * ring.length);\n      const vIdx3 = (2 * i + 3) % (2 * ring.length); // Add new wall vertex\n\n      vertices.push(ring[i][0], ring[i][1], zmin);\n      vertices.push(ring[i][0], ring[i][1], height); // Colors\n\n      colors.push(255, 255, 255, 255);\n      colors.push(255, 255, 255, 0);\n      triangles.push(vIdx0, vIdx1, vIdx2, vIdx2, vIdx1, vIdx3);\n    }\n\n    const wall = new MeshComponent({\n      faces: triangles,\n      shading: \"flat\",\n      material: new MeshMaterialMetallicRoughness({\n        emissiveColor: wallColor,\n        metallic: 0.5,\n        roughness: 0.8,\n        doubleSided: true\n      })\n    });\n    return new Mesh({\n      components: [wall],\n      vertexAttributes: {\n        position: vertices,\n        color: colors\n      },\n      spatialReference: polygon.spatialReference\n    });\n  }\n\n  view.when(async () => {\n    const buildingsLV = await view.whenLayerView(buildings);\n    view.on(\"click\", promiseUtils.debounce(async e => {\n      const ht = await view.hitTest(e, {\n        include: [buildings]\n      });\n      walls.removeAll();\n\n      for (const result of ht.results) {\n        const graphic = result.graphic;\n\n        if (graphic && graphic.layer === buildings) {\n          const extentResult = await buildingsLV.queryExtent({\n            objectIds: [graphic.getObjectId()],\n            returnGeometry: true\n          });\n          await animateFootprint(graphic, extentResult.extent, popmotion);\n          return;\n        }\n      }\n    }));\n  });\n  return view;\n};\n\n_c = ArcGISMap;\nexport default ArcGISMap;\n\nvar _c;\n\n$RefreshReg$(_c, \"ArcGISMap\");","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/src/untils/ArcGISMap.js"],"names":["Map","Color","SceneView","SceneLayer","MeshSymbol3D","SolidEdges3D","SimpleRenderer","FillSymbol3DLayer","GraphicsLayer","promiseUtils","Polygon","SpatialReference","Graphic","PolygonSymbol3D","ArcGISMap","basemap","ref","buildings","url","opacity","popupEnabled","renderer","symbol","symbolLayers","material","color","colorMixMode","edges","walls","elevationInfo","mode","map","layers","view","container","qualityProfile","camera","position","heading","tilt","environment","lighting","directShadowsEnabled","getCageGraphic","wall","height","geometry","rings","coords","spatialReference","WebMercator","outline","size","animateFootprint","building","extent","popmotion","objectId","getObjectId","query","footprints","createQuery","objectIds","outFields","multipatchOption","returnGeometry","result","queryFeatures","features","length","footprint","hull","geometryEngine","convexHull","buffer","generalize","zmax","zmin","removeAll","createWall","s","mesh","createMesh","fill","wallColor","castShadows","addMany","add","Promise","resolve","spring","from","velocity","to","stiffness","start","update","complete","polygon","ring","triangles","vertices","colors","i","vIdx0","vIdx1","vIdx2","vIdx3","push","MeshComponent","faces","shading","MeshMaterialMetallicRoughness","emissiveColor","metallic","roughness","doubleSided","Mesh","components","vertexAttributes","when","buildingsLV","whenLayerView","on","debounce","e","ht","hitTest","include","results","graphic","layer","extentResult","queryExtent"],"mappings":"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","sourcesContent":["import Map from '@arcgis/core/Map'\nimport Color from \"@arcgis/core/Color\"\nimport SceneView from \"@arcgis/core/views/SceneView\"\nimport SceneLayer from '@arcgis/core/layers/SceneLayer'\nimport MeshSymbol3D from '@arcgis/core/symbols/MeshSymbol3D'\nimport SolidEdges3D from '@arcgis/core/symbols/edges/SolidEdges3D'\nimport SimpleRenderer from '@arcgis/core/renderers/SimpleRenderer'\nimport FillSymbol3DLayer from '@arcgis/core/symbols/FillSymbol3DLayer'\n\nimport GraphicsLayer from '@arcgis/core/layers/GraphicsLayer'\n\nimport * as promiseUtils from '@arcgis/core/core/promiseUtils'\nimport Polygon from '@arcgis/core/geometry/Polygon';\nimport SpatialReference from '@arcgis/core/geometry/SpatialReference'\nimport Graphic from '@arcgis/core/Graphic'\nimport PolygonSymbol3D from '@arcgis/core/symbols/PolygonSymbol3D'\n\n\nconst ArcGISMap = (basemap, ref) => {\n    const buildings = new SceneLayer({\n        url: 'https://services.arcgis.com/V6ZHFr6zdgNZuVG0/ArcGIS/rest/services/NYC/SceneServer/layers/0',\n        opacity: 1,\n        popupEnabled: false,\n        renderer: new SimpleRenderer({\n            symbol: new MeshSymbol3D({\n                symbolLayers: [\n                    new FillSymbol3DLayer({\n                        material: {\n                            color: new Color([200, 200, 200]),\n                            colorMixMode: \"replace\"\n                        },\n                        edges: new SolidEdges3D({\n                            color: new Color([100, 100, 100, 0.5])\n                        })\n                    })\n                ]\n            })\n        })\n    });\n\n    const walls = new GraphicsLayer({\n        elevationInfo: {\n            mode: \"absolute-height\"\n        }\n    });\n\n    const map = new Map({\n        basemap,\n        layers: [buildings, walls]\n    });\n\n    const view = new SceneView({\n        container: ref,\n        map,\n        qualityProfile: \"high\",\n        camera: {\n            position: [-73.98564294432742, 40.748586782824624, 601.67648],\n            heading: 330.47,\n            tilt: 64.02\n        },\n        environment: {\n            lighting: {\n                directShadowsEnabled: true\n            }\n        },\n    })\n\n    function getCageGraphic(wall, opacity, height) {\n        const geometry = new Polygon({\n            rings: [wall.rings[0].map((coords) => [...coords, height])],\n            spatialReference: SpatialReference.WebMercator\n        });\n        return new Graphic({\n            geometry: geometry,\n            symbol: new PolygonSymbol3D({\n                symbolLayers: [\n                    new FillSymbol3DLayer({\n                        outline: {\n                            size: 1.5,\n                            color: [153, 255, 253, opacity]\n                        },\n                        material: {\n                            color: [0, 0, 0, 0]\n                        }\n                    })\n                ]\n            })\n        });\n    }\n\n    async function animateFootprint(building, extent, popmotion) {\n        const objectId = building.getObjectId();\n\n        const query = footprints.createQuery();\n        query.objectIds = [objectId];\n        query.outFields = [\"*\"];\n        query.multipatchOption = \"xyFootprint\";\n        query.returnGeometry = true;\n\n        const result = await footprints.queryFeatures(query);\n        if (result.features.length === 0) {\n            return;\n        }\n\n        const footprint = result.features[0];\n\n        const hull = geometryEngine.convexHull(footprint.geometry, true);\n        const buffer = geometryEngine.buffer(hull, 10, \"meters\");\n        const wall = geometryEngine.generalize(buffer, 10, true, \"meters\");\n        const size = (extent.zmax - extent.zmin) * 0.9;\n\n        walls.removeAll();\n\n        function createWall(s) {\n            const mesh = createMesh(wall, extent.zmin, size * s);\n            walls.removeAll();\n\n            const fill = new FillSymbol3DLayer({\n                material: {\n                    color: wallColor,\n                    colorMixMode: \"tint\"\n                },\n                castShadows: false\n            });\n\n            walls.addMany([\n                getCageGraphic(wall, 1, (extent.zmin + 0.5) * s),\n                getCageGraphic(wall, 0.2, (extent.zmin + size / 2) * s),\n                getCageGraphic(wall, 0.6, (extent.zmin + size / 4) * s),\n                getCageGraphic(wall, 0.8, (extent.zmin + size / 8) * s)\n            ]);\n\n            walls.add(\n                new Graphic({\n                    geometry: mesh,\n                    symbol: new MeshSymbol3D({\n                        symbolLayers: [fill]\n                    })\n                })\n            );\n        }\n\n        return new Promise((resolve) => {\n            popmotion\n                .spring({\n                    from: 0,\n                    velocity: 0,\n                    to: 1,\n                    stiffness: 200\n                    // mass: 1,\n                    // damping: 10\n                })\n                .start({\n                    update: createWall,\n                    complete: resolve\n                });\n        });\n    }\n\n    function createMesh(polygon, zmin, height = 100) {\n        const ring = polygon.rings[0];\n        const triangles = [];\n        const vertices = [];\n        const colors = [];\n\n        for (let i = 0; i < ring.length; i++) {\n            const vIdx0 = 2 * i;\n            const vIdx1 = 2 * i + 1;\n\n            const vIdx2 = (2 * i + 2) % (2 * ring.length);\n            const vIdx3 = (2 * i + 3) % (2 * ring.length);\n\n            // Add new wall vertex\n            vertices.push(ring[i][0], ring[i][1], zmin);\n            vertices.push(ring[i][0], ring[i][1], height);\n\n            // Colors\n            colors.push(255, 255, 255, 255);\n            colors.push(255, 255, 255, 0);\n\n            triangles.push(vIdx0, vIdx1, vIdx2, vIdx2, vIdx1, vIdx3);\n        }\n\n        const wall = new MeshComponent({\n            faces: triangles,\n            shading: \"flat\",\n            material: new MeshMaterialMetallicRoughness({\n                emissiveColor: wallColor,\n                metallic: 0.5,\n                roughness: 0.8,\n                doubleSided: true\n            })\n        });\n\n        return new Mesh({\n            components: [wall],\n            vertexAttributes: {\n                position: vertices,\n                color: colors\n            },\n            spatialReference: polygon.spatialReference\n        });\n    }\n\n    view.when(async () => {\n        const buildingsLV = await view.whenLayerView(buildings);\n\n        view.on(\n            \"click\",\n            promiseUtils.debounce(async (e) => {\n                const ht = await view.hitTest(e, {\n                    include: [buildings]\n                });\n\n                walls.removeAll();\n\n                for (const result of ht.results) {\n                    const graphic = result.graphic;\n                    if (graphic && graphic.layer === buildings) {\n                        const extentResult = await buildingsLV.queryExtent({\n                            objectIds: [graphic.getObjectId()],\n                            returnGeometry: true\n                        });\n\n                        await animateFootprint(graphic, extentResult.extent, popmotion);\n\n                        return;\n                    }\n                }\n            })\n        );\n    });\n\n    return view\n}\n\nexport default ArcGISMap\n"]},"metadata":{},"sourceType":"module"}