{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../chunks/tslib.es6.js\";\nimport r from \"../../../../core/Accessor.js\";\nimport { someMap as t } from \"../../../../core/MapUtils.js\";\nimport { applySome as s } from \"../../../../core/maybe.js\";\nimport i from \"../../../../core/PooledArray.js\";\nimport { property as a } from \"../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../core/has.js\";\nimport \"../../../../core/accessorSupport/ensureType.js\";\nimport \"../../../../core/Logger.js\";\nimport { subclass as n } from \"../../../../core/accessorSupport/decorators/subclass.js\";\nimport { ChangeSet as d } from \"./ChangeSet.js\";\nimport { materialPredicate as h } from \"./Material.js\";\nimport { splitRenderGeometryChangeSetByMaterial as o } from \"./rendererUtils.js\";\nimport l from \"../materials/renderers/MergedRenderer.js\";\nlet p = class extends r {\n  constructor() {\n    super(...arguments), this._pending = new m(), this._changes = new d(), this._materialRenderers = new Map(), this._sortedMaterialRenderers = new i(), this._hasHighlights = !1, this._hasWater = !1;\n  }\n\n  dispose() {\n    this._changes.prune(), this._materialRenderers.forEach(e => e.dispose()), this._materialRenderers.clear(), this._sortedMaterialRenderers.clear();\n  }\n\n  get updating() {\n    return !this._pending.empty || this._changes.updates.length > 0;\n  }\n\n  get hasHighlights() {\n    return this._hasHighlights;\n  }\n\n  get hasWater() {\n    return this._hasWater;\n  }\n\n  get rendersOccluded() {\n    return t(this._materialRenderers, e => e.rendersOccluded);\n  }\n\n  stopAnimationsAtTime(e) {\n    this._sortedMaterialRenderers.forAll(r => s(r.material.animation, r => r.stopAtTime(e)));\n  }\n\n  get isEmpty() {\n    return !this.updating && 0 === this._materialRenderers.size;\n  }\n\n  commitChanges() {\n    if (!this.updating) return !1;\n\n    this._processAddsRemoves();\n\n    const e = o(this._changes);\n    let r = !1,\n        s = !1,\n        i = !1;\n    return e.forEach((e, t) => {\n      let a = this._materialRenderers.get(t);\n\n      if (!a && e.adds.length > 0 && (a = new l(this.rctx, this.materialRepository, t), this._materialRenderers.set(t, a), r = !0, s = !0, i = !0), !a) return;\n      const n = s || a.hasHighlights,\n            d = i || a.hasWater;\n      a.modify(e), s = s || n !== a.hasHighlights, i = i || d !== a.hasWater, a.isEmpty && (this._materialRenderers.delete(t), a.dispose(), r = !0);\n    }), this._changes.clear(), r && this.updateSortedMaterialRenderers(), s && (this._hasHighlights = t(this._materialRenderers, e => e.hasHighlights)), i && (this._hasWater = t(this._materialRenderers, e => e.hasWater)), this.notifyChange(\"updating\"), !0;\n  }\n\n  add(e) {\n    if (0 === e.length) return;\n    const r = this._pending.empty;\n\n    for (const t of e) this._pending.adds.add(t);\n\n    r && this.notifyChange(\"updating\");\n  }\n\n  remove(e) {\n    const r = this._pending.empty;\n\n    for (const t of e) this._pending.adds.has(t) ? (this._pending.removed.add(t), this._pending.adds.delete(t)) : this._pending.removed.has(t) || this._pending.removes.add(t);\n\n    r && !this._pending.empty && this.notifyChange(\"updating\");\n  }\n\n  modify(e, r) {\n    const t = 0 === this._changes.updates.length;\n\n    for (const s of e) {\n      const e = this._changes.updates.pushNew();\n\n      e.renderGeometry = s, e.updateType = r;\n    }\n\n    t && this._changes.updates.length > 0 && this.notifyChange(\"updating\");\n  }\n\n  updateLogic(e) {\n    let r = !1;\n    return this._sortedMaterialRenderers.forAll(({\n      materialRenderer: t\n    }) => {\n      t.updateLogic && t.updateLogic(e) && (r = !0);\n    }), r;\n  }\n\n  render(e, r) {\n    for (let t = 0; t < this._sortedMaterialRenderers.length; t++) {\n      const s = this._sortedMaterialRenderers.data[t];\n      h(s.material, e) && s.materialRenderer.render(null, e.pass, r, null);\n    }\n  }\n\n  updateSortedMaterialRenderers() {\n    this._sortedMaterialRenderers.clear();\n\n    let e = 0;\n    this._materialRenderers.forEach((r, t) => {\n      t.insertOrder = e++, this._sortedMaterialRenderers.push({\n        material: t,\n        materialRenderer: r\n      });\n    }), this._sortedMaterialRenderers.sort((e, r) => {\n      const t = r.material.renderPriority - e.material.renderPriority;\n      return 0 !== t ? t : e.material.insertOrder - r.material.insertOrder;\n    });\n  }\n\n  _processAddsRemoves() {\n    this._changes.adds.clear(), this._changes.removes.clear(), this._changes.adds.pushArray(Array.from(this._pending.adds)), this._changes.removes.pushArray(Array.from(this._pending.removes));\n\n    for (let e = 0; e < this._changes.updates.length;) {\n      const r = this._changes.updates.data[e];\n      this._pending.has(r.renderGeometry) ? this._changes.updates.removeUnorderedIndex(e) : e++;\n    }\n\n    this._pending.clear();\n  }\n\n  get test() {\n    return {\n      sortedMaterialRenderers: this._sortedMaterialRenderers\n    };\n  }\n\n};\ne([a()], p.prototype, \"rctx\", void 0), e([a()], p.prototype, \"materialRepository\", void 0), e([a()], p.prototype, \"updating\", null), p = e([n(\"esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer\")], p);\n\nclass m {\n  constructor() {\n    this.adds = new Set(), this.removes = new Set(), this.removed = new Set();\n  }\n\n  get empty() {\n    return 0 === this.adds.size && 0 === this.removes.size && 0 === this.removed.size;\n  }\n\n  has(e) {\n    return this.adds.has(e) || this.removes.has(e) || this.removed.has(e);\n  }\n\n  clear() {\n    this.adds.clear(), this.removes.clear(), this.removed.clear();\n  }\n\n}\n\nexport { p as SortedRenderGeometryRenderer };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/webgl-engine/lib/SortedRenderGeometryRenderer.js"],"names":["_","e","r","someMap","t","applySome","s","i","property","a","subclass","n","ChangeSet","d","materialPredicate","h","splitRenderGeometryChangeSetByMaterial","o","l","p","constructor","arguments","_pending","m","_changes","_materialRenderers","Map","_sortedMaterialRenderers","_hasHighlights","_hasWater","dispose","prune","forEach","clear","updating","empty","updates","length","hasHighlights","hasWater","rendersOccluded","stopAnimationsAtTime","forAll","material","animation","stopAtTime","isEmpty","size","commitChanges","_processAddsRemoves","get","adds","rctx","materialRepository","set","modify","delete","updateSortedMaterialRenderers","notifyChange","add","remove","has","removed","removes","pushNew","renderGeometry","updateType","updateLogic","materialRenderer","render","data","pass","insertOrder","push","sort","renderPriority","pushArray","Array","from","removeUnorderedIndex","test","sortedMaterialRenderers","prototype","Set","SortedRenderGeometryRenderer"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../chunks/tslib.es6.js\";import r from\"../../../../core/Accessor.js\";import{someMap as t}from\"../../../../core/MapUtils.js\";import{applySome as s}from\"../../../../core/maybe.js\";import i from\"../../../../core/PooledArray.js\";import{property as a}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/ensureType.js\";import\"../../../../core/Logger.js\";import{subclass as n}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{ChangeSet as d}from\"./ChangeSet.js\";import{materialPredicate as h}from\"./Material.js\";import{splitRenderGeometryChangeSetByMaterial as o}from\"./rendererUtils.js\";import l from\"../materials/renderers/MergedRenderer.js\";let p=class extends r{constructor(){super(...arguments),this._pending=new m,this._changes=new d,this._materialRenderers=new Map,this._sortedMaterialRenderers=new i,this._hasHighlights=!1,this._hasWater=!1}dispose(){this._changes.prune(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return t(this._materialRenderers,(e=>e.rendersOccluded))}stopAnimationsAtTime(e){this._sortedMaterialRenderers.forAll((r=>s(r.material.animation,(r=>r.stopAtTime(e)))))}get isEmpty(){return!this.updating&&0===this._materialRenderers.size}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=o(this._changes);let r=!1,s=!1,i=!1;return e.forEach(((e,t)=>{let a=this._materialRenderers.get(t);if(!a&&e.adds.length>0&&(a=new l(this.rctx,this.materialRepository,t),this._materialRenderers.set(t,a),r=!0,s=!0,i=!0),!a)return;const n=s||a.hasHighlights,d=i||a.hasWater;a.modify(e),s=s||n!==a.hasHighlights,i=i||d!==a.hasWater,a.isEmpty&&(this._materialRenderers.delete(t),a.dispose(),r=!0)})),this._changes.clear(),r&&this.updateSortedMaterialRenderers(),s&&(this._hasHighlights=t(this._materialRenderers,(e=>e.hasHighlights))),i&&(this._hasWater=t(this._materialRenderers,(e=>e.hasWater))),this.notifyChange(\"updating\"),!0}add(e){if(0===e.length)return;const r=this._pending.empty;for(const t of e)this._pending.adds.add(t);r&&this.notifyChange(\"updating\")}remove(e){const r=this._pending.empty;for(const t of e)this._pending.adds.has(t)?(this._pending.removed.add(t),this._pending.adds.delete(t)):this._pending.removed.has(t)||this._pending.removes.add(t);r&&!this._pending.empty&&this.notifyChange(\"updating\")}modify(e,r){const t=0===this._changes.updates.length;for(const s of e){const e=this._changes.updates.pushNew();e.renderGeometry=s,e.updateType=r}t&&this._changes.updates.length>0&&this.notifyChange(\"updating\")}updateLogic(e){let r=!1;return this._sortedMaterialRenderers.forAll((({materialRenderer:t})=>{t.updateLogic&&t.updateLogic(e)&&(r=!0)})),r}render(e,r){for(let t=0;t<this._sortedMaterialRenderers.length;t++){const s=this._sortedMaterialRenderers.data[t];h(s.material,e)&&s.materialRenderer.render(null,e.pass,r,null)}}updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach(((r,t)=>{t.insertOrder=e++,this._sortedMaterialRenderers.push({material:t,materialRenderer:r})})),this._sortedMaterialRenderers.sort(((e,r)=>{const t=r.material.renderPriority-e.material.renderPriority;return 0!==t?t:e.material.insertOrder-r.material.insertOrder}))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const r=this._changes.updates.data[e];this._pending.has(r.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};e([a()],p.prototype,\"rctx\",void 0),e([a()],p.prototype,\"materialRepository\",void 0),e([a()],p.prototype,\"updating\",null),p=e([n(\"esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer\")],p);class m{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}export{p as SortedRenderGeometryRenderer};\n"]},"metadata":{},"sourceType":"module"}