{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as i } from \"../../../../chunks/tslib.es6.js\";\nimport t from \"../../../../core/Accessor.js\";\nimport { lerp as s } from \"../../../../core/mathUtils.js\";\nimport { isNone as e, isSome as r } from \"../../../../core/maybe.js\";\nimport a from \"../../../../core/PooledArray.js\";\nimport { property as o } from \"../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../core/has.js\";\nimport \"../../../../core/accessorSupport/ensureType.js\";\nimport \"../../../../core/Logger.js\";\nimport { subclass as c } from \"../../../../core/accessorSupport/decorators/subclass.js\";\nimport { a as n } from \"../../../../chunks/mat4.js\";\nimport { c as h } from \"../../../../chunks/mat4f64.js\";\nimport { a as l } from \"../../../../chunks/vec2f64.js\";\nimport { m as p, a as u, s as d, g as f } from \"../../../../chunks/vec3.js\";\nimport { Z as m, c as g } from \"../../../../chunks/vec3f64.js\";\nimport { s as b, t as v, b as y } from \"../../../../chunks/vec4.js\";\nimport { c as G } from \"../../../../chunks/vec4f64.js\";\nimport { getReferenceEllipsoid as S } from \"../../../../geometry/projectionEllipsoid.js\";\nimport { create as B, empty as w, offset as D, width as V, height as j, expand as N, intersects as _ } from \"../../../../geometry/support/aaBoundingRect.js\";\nimport { a as P, c as C, e as I } from \"../../../../chunks/boundedPlane.js\";\nimport { create as x } from \"../../../../geometry/support/ray.js\";\nimport { d as A, g as M, i as z, c as O } from \"../../../../chunks/sphere.js\";\nimport { drawAccelerationStruct as T, prepare as E, drawPoly as F } from \"./deconflictorDebug.js\";\nimport X from \"../../support/debugFlags.js\";\nimport Y from \"../../webgl-engine/lib/Camera.js\";\nimport { applyPrecomputedScaleFactor as R } from \"../../webgl-engine/lib/screenSizePerspectiveUtils.js\";\nimport { HUDMaterial as k } from \"../../webgl-engine/materials/HUDMaterial.js\";\nconst W = g(),\n      L = G(),\n      U = G(),\n      H = g(),\n      Z = h(),\n      q = O(),\n      J = x(),\n      K = g(),\n      Q = B();\n\nclass $ {\n  constructor() {\n    this.aabr = B(), this.distance = 0, this.culled = !1, this.visible = !1;\n  }\n\n}\n\nclass ii {\n  constructor(i, t, s = {}) {\n    this.graphics3DGraphic = i, this.slicePlaneEnabled = t, this.info = s;\n  }\n\n}\n\nclass ti {\n  constructor() {\n    this.active = new Map(), this.visible = new Map();\n  }\n\n  clear() {\n    this.active.clear(), this.visible.clear();\n  }\n\n}\n\nclass si {}\n\nclass ei {\n  constructor() {\n    this.sortArray = new a({\n      allocator: i => i || new si()\n    });\n  }\n\n}\n\nclass ri {\n  constructor() {\n    this.camera = new Y(), this.slicePlane = P(), this.slicePlaneEnabled = !1;\n  }\n\n  copyFrom(i) {\n    this.camera.copyFrom(i.camera), C(i.slicePlane, this.slicePlane), this.slicePlaneEnabled = i.slicePlaneEnabled;\n  }\n\n}\n\nlet ai = class extends t {\n  constructor() {\n    super(...arguments), this._dirty = !1, this._runningViewState = new ri(), this._state = 0, this.graphics = new ti(), this.iterators = new ei(), this.accBinsNumX = 15, this.accBinsNumY = 20, this.accBinsSizeX = 0, this.accBinsSizeY = 0, this.accBins = null, this.accNumTests = 0;\n  }\n\n  get dirty() {\n    return this._dirty;\n  }\n\n  get state() {\n    return this._state;\n  }\n\n  destroy() {\n    this.graphics.clear(), this.iterators = null;\n  }\n\n  setDirty() {\n    !this._dirty && this.graphics.active.size > 0 && (this._dirty = !0, this.notifyChange(\"updating\"));\n  }\n\n  get updating() {\n    return 0 !== this._state || this._dirty;\n  }\n\n  get updatingProgress() {\n    if (!this.updating) return 1;\n    const i = this._state / 4;\n    return this._dirty ? .5 * i : i;\n  }\n\n  get running() {\n    return this.view.ready && null != this.view.state && this.updating;\n  }\n\n  runTask(i) {\n    switch (this._state) {\n      case 0:\n        this.startUpdate(), i.madeProgress();\n\n      case 1:\n        if (this._state = 1, !this.processActiveGraphics(i)) return;\n\n      case 2:\n        if (this._state = 2, !this.sortVisibleGraphics(i)) return;\n\n      case 3:\n        if (this._state = 3, !this.deconflictVisibleGraphics(i)) return;\n\n      default:\n        T(this, this.graphics.visible), this._state = 0, this.notifyChange(\"updating\");\n    }\n  }\n\n  modifyGraphics(i, t) {\n    t ? i.forEach(i => this.addToActiveGraphics(i)) : i.forEach(i => this.removeFromActiveGraphics(i)), this.setDirty();\n  }\n\n  layerSupportsDeconfliction(i) {\n    if (e(i) || \"object3d\" !== i.type) return !1;\n    const t = i.stageObject;\n    if (1 !== (t ? t.getNumGeometryRecords() : 0)) return !1;\n    return t.getGeometryRecord(0).material instanceof k;\n  }\n\n  startUpdate() {\n    E(this.view), this._dirty = !1, this._runningViewState.copyFrom(this.viewState);\n    const {\n      fullWidth: i,\n      fullHeight: t\n    } = this._runningViewState.camera;\n    this.initBins(i, t), this.resetIterators();\n  }\n\n  addToActiveGraphics(i) {\n    i.info[this.visibilityGroup] = new $(), this.graphics.active.set(i.graphics3DGraphic.graphic.uid, i), this.setDirty();\n  }\n\n  removeFromActiveGraphics(i) {\n    this.removeFromVisibleGraphics(i), oi(i, this.visibilityGroup), delete i.info[this.visibilityGroup], this.graphics.active.delete(i.graphics3DGraphic.graphic.uid), this.setDirty();\n  }\n\n  addToVisibleGraphics(i) {\n    this.graphics.visible.set(i.graphics3DGraphic.graphic.uid, i);\n  }\n\n  removeFromVisibleGraphics(i) {\n    this.graphics.visible.delete(i.graphics3DGraphic.graphic.uid);\n  }\n\n  processActiveGraphics(i) {\n    const t = this.ensureActiveGraphicsIterator(),\n          s = n(Z, this._runningViewState.camera.projectionMatrix),\n          e = \"global\" === this.view.viewingMode && 1 === this.view.map.ground.opacity && this._runningViewState.camera.relativeElevation > 0 ? q : null;\n    let a = 0;\n\n    for (r(e) && (p(e, m, this._runningViewState.camera.viewMatrix), e[3] = S(this.view.spatialReference).radius, a = A(e, m)); !i.done;) {\n      i.madeProgress();\n      const r = t.next();\n      if (r.done) return this.resetActiveGraphicsIterator(), !0;\n      const o = r.value,\n            c = o && o.info[this.visibilityGroup];\n      c && (this.collectGraphics3DGraphics(o, s, e, a), c.culled ? this.removeFromVisibleGraphics(o) : this.addToVisibleGraphics(o));\n    }\n\n    return !1;\n  }\n\n  sortVisibleGraphics(i) {\n    const t = this.ensureSortGraphicsIterator();\n\n    for (; !i.done;) {\n      const s = t.next();\n      if (i.madeProgress(), s.done) return this.resetSortGraphicsIterator(), !0;\n    }\n\n    return !1;\n  }\n\n  deconflictVisibleGraphics(i) {\n    const t = this.ensureVisibleGraphicsIterator(),\n          s = 1 === this.visibilityGroup;\n\n    for (; !i.done;) {\n      i.madeProgress();\n      const e = t.next();\n      if (e.done) return this.resetVisibleGraphicsIterator(), !0;\n      const r = e.value,\n            a = r.info[this.visibilityGroup];\n      if (!a || a.culled) continue;\n      const o = r.graphics3DGraphic,\n            c = (!s || o.isVisible()) && !this.isConflicted(r);\n      c && this.addToBins(r), a.visible = c, this.setGraphicVisibility(r, c), F(a, c);\n    }\n\n    return !1;\n  }\n\n  resetIterators() {\n    this.iterators.active = null, this.iterators.visible = null, this.iterators.sort = null;\n  }\n\n  ensureActiveGraphicsIterator() {\n    return this.iterators.active || (this.iterators.active = ci(this.graphics.active)), this.iterators.active;\n  }\n\n  resetActiveGraphicsIterator() {\n    this.iterators.active = null;\n  }\n\n  ensureVisibleGraphicsIterator() {\n    return this.iterators.visible || (this.iterators.visible = ci(this.graphics.visible)), this.iterators.visible;\n  }\n\n  resetVisibleGraphicsIterator() {\n    this.iterators.visible = null;\n  }\n\n  ensureSortGraphicsIterator() {\n    return this.iterators.sort || (this.iterators.sort = ni(this.graphics.visible, this.iterators.sortArray, this.visibilityGroup)), this.iterators.sort;\n  }\n\n  resetSortGraphicsIterator() {\n    this.iterators.sort = null;\n  }\n\n  collectGraphics3DGraphics(i, t, s, a) {\n    const o = i.graphics3DGraphic;\n    if (o.destroyed) return;\n    const c = i.info[this.visibilityGroup];\n    if (!o.isVisible(0, 3)) return void (c.culled = !0);\n    const n = this.getGraphicsLayers(o);\n    w(c.aabr);\n    let h = null;\n\n    for (const l of n) {\n      if (!this.layerSupportsDeconfliction(l)) continue;\n      const o = l.stageObject.getGeometryRecord(0).material;\n\n      if (e(h)) {\n        if (h = this.getProjectionInfo(l, t, pi), h.isOutsideScreen || this.isCulledBySlice(i, W) || r(s) && this.isCulledByHorizon(h, s, a)) return void (c.culled = !0);\n        !X.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET && c.visible && (h.distance *= .7);\n      }\n\n      this.expandBoundingRect(c, l, o, h);\n    }\n\n    e(h) ? c.culled = !0 : (c.distance = h.distance, c.culled = !1);\n  }\n\n  getProjectionInfo(i, t, s) {\n    const e = this._runningViewState.camera,\n          r = i.stageObject,\n          a = r.getGeometryRecord(0),\n          o = a.material,\n          c = M(r.boundingVolumeWorldSpace.bounds);\n    p(W, c, e.viewMatrix);\n    const n = a.geometry.vertexAttributes,\n          h = n.get(\"normal\").data,\n          l = n.get(\"auxpos1\").data;\n    return o.applyShaderOffsetsView(W, h, r.transformation, l, e, s.scaleInfo, W), b(L, W[0], W[1], W[2], 1), v(U, L, e.projectionMatrix), u(s.positionNDC, U, 1 / U[3]), o.applyShaderOffsetsNDC(s.positionNDC, l, e, s.positionNDC, H), s.distanceWithoutPolygonOffset = e.depthNDCToWorld(H[2]), s.distance = H[2] === s.positionNDC[2] ? s.distanceWithoutPolygonOffset : e.depthNDCToWorld(s.positionNDC[2]), b(U, s.positionNDC[0], s.positionNDC[1], s.positionNDC[2], 1), v(L, U, t), y(L, L, 1 / L[3]), d(s.positionView, W[0], W[1], W[2]), s;\n  }\n\n  isCulledByHorizon(i, t, s) {\n    return f(J.direction, i.positionView), d(J.origin, 0, 0, 0), !!z(t, J, K) && i.distanceWithoutPolygonOffset > s;\n  }\n\n  isCulledBySlice(i, t) {\n    return i.slicePlaneEnabled && this._runningViewState.slicePlaneEnabled && I(this._runningViewState.slicePlane, t);\n  }\n\n  expandBoundingRect(i, t, e, {\n    positionNDC: r,\n    scaleInfo: a\n  }) {\n    const o = this._runningViewState.camera,\n          c = t.getScreenSize(hi);\n    R(c, a.factor, c), c[0] *= o.pixelRatio, c[1] *= o.pixelRatio;\n    const n = D(e.calculateRelativeScreenBounds(c, a.factorAlignment.scale, Q), s(0, o.fullWidth, .5 + .5 * r[0]), s(0, o.fullHeight, .5 + .5 * r[1])),\n          h = this.iconMarginFactor;\n\n    if (0 !== h) {\n      const i = h * Math.min(V(n), j(n));\n      n[0] -= i, n[1] -= i, n[2] += i, n[3] += i;\n    }\n\n    N(i.aabr, n);\n  }\n\n  isConflicted(i) {\n    const t = i.graphics3DGraphic.graphic.uid,\n          s = i.info[this.visibilityGroup];\n\n    for (let e = Math.floor(s.aabr[0] / this.accBinsSizeX); e <= Math.floor(s.aabr[2] / this.accBinsSizeX); e++) if (!(e < 0 || e >= this.accBinsNumX)) for (let i = Math.floor(s.aabr[1] / this.accBinsSizeY); i <= Math.floor(s.aabr[3] / this.accBinsSizeY); i++) {\n      if (i < 0 || i >= this.accBinsNumY) continue;\n      const r = this.accBins[e][i];\n\n      for (let i = 0; i < r.length; i++) {\n        const e = r.data[i],\n              a = e.info[this.visibilityGroup];\n        if (a && a.visible && e.graphics3DGraphic.graphic.uid !== t && (this.accNumTests++, _(a.aabr, s.aabr))) return !0;\n      }\n    }\n\n    return !1;\n  }\n\n  initBins(i, t) {\n    if (null == this.accBins) {\n      this.accBins = [];\n\n      for (let i = 0; i < this.accBinsNumX; i++) {\n        this.accBins.push([]);\n        const i = this.accBins[this.accBins.length - 1];\n\n        for (let t = 0; t < this.accBinsNumY; t++) i.push(new a());\n      }\n    } else for (let s = 0; s < this.accBinsNumX; s++) for (let i = 0; i < this.accBinsNumY; i++) this.accBins[s][i].clear();\n\n    this.accBinsSizeX = i / this.accBinsNumX, this.accBinsSizeY = t / this.accBinsNumY, this.accNumTests = 0;\n  }\n\n  addToBins(i) {\n    const t = i.info[this.visibilityGroup],\n          s = Math.floor(t.aabr[0] / this.accBinsSizeX),\n          e = Math.floor(t.aabr[2] / this.accBinsSizeX),\n          r = Math.floor(t.aabr[1] / this.accBinsSizeY),\n          a = Math.floor(t.aabr[3] / this.accBinsSizeY);\n\n    for (let o = s; o <= e; o++) if (!(o < 0 || o >= this.accBinsNumX)) for (let t = r; t <= a; t++) t < 0 || t >= this.accBinsNumY || this.accBins[o][t].push(i);\n  }\n\n  setGraphicVisibility(i, t) {\n    const s = i.graphics3DGraphic;\n    s.destroyed || (s.setVisibilityFlag(3, t, this.visibilityGroup), 1 === this.visibilityGroup && this.view.labeler.setLabelGraphicVisibility(s, t));\n  }\n\n};\n\nfunction oi(i, t) {\n  const s = i.graphics3DGraphic;\n  s.destroyed || s.clearVisibilityFlag(3, t);\n}\n\nfunction* ci(i) {\n  if (Map.prototype.entries) {\n    const t = i.entries();\n\n    for (let i = t.next(); !i.done; i = t.next()) yield i.value[1];\n  } else yield* i.values();\n}\n\nfunction* ni(i, t, s) {\n  t.clear(), i.forEach((i, e) => {\n    const r = t.pushNew();\n    r.id = e, r.prio = i.info ? -i.info[s].distance : Number.MAX_VALUE;\n  }), yield;\n  const e = t.iterableSort((i, t) => t.prio - i.prio);\n\n  for (let r = e.next(); !r.done; r = e.next()) yield;\n\n  t.forAll(t => {\n    const s = i.get(t.id);\n    s && (i.delete(t.id), i.set(t.id, s));\n  }), t.clear();\n}\n\ni([o({\n  constructOnly: !0\n})], ai.prototype, \"view\", void 0), i([o({\n  type: Boolean,\n  readOnly: !0\n})], ai.prototype, \"updating\", null), ai = i([c(\"esri.views.3d.layers.graphics.Deconflictor\")], ai);\nconst hi = l();\n\nclass li {\n  constructor() {\n    this.positionView = g(), this.positionNDC = g(), this.distance = 0, this.distanceWithoutPolygonOffset = 0, this.scaleInfo = {\n      factor: {\n        scale: 0,\n        factor: 0,\n        minPixelSize: 0,\n        paddingPixels: 0\n      },\n      factorAlignment: {\n        scale: 0,\n        factor: 0,\n        minPixelSize: 0,\n        paddingPixels: 0\n      }\n    };\n  }\n\n  get isOutsideScreen() {\n    const i = this.positionNDC;\n    return i[0] < -1 || i[1] < -1 || i[2] < -1 || i[0] >= 1 || i[1] >= 1;\n  }\n\n}\n\nconst pi = new li();\nexport { ai as Deconflictor, ii as DeconflictorGraphic, ri as DeconflictorViewState };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/layers/graphics/Deconflictor.js"],"names":["_","i","t","lerp","s","isNone","e","isSome","r","a","property","o","subclass","c","n","h","l","m","p","u","d","g","f","Z","b","v","y","G","getReferenceEllipsoid","S","create","B","empty","w","offset","D","width","V","height","j","expand","N","intersects","P","C","I","x","A","M","z","O","drawAccelerationStruct","T","prepare","E","drawPoly","F","X","Y","applyPrecomputedScaleFactor","R","HUDMaterial","k","W","L","U","H","q","J","K","Q","$","constructor","aabr","distance","culled","visible","ii","graphics3DGraphic","slicePlaneEnabled","info","ti","active","Map","clear","si","ei","sortArray","allocator","ri","camera","slicePlane","copyFrom","ai","arguments","_dirty","_runningViewState","_state","graphics","iterators","accBinsNumX","accBinsNumY","accBinsSizeX","accBinsSizeY","accBins","accNumTests","dirty","state","destroy","setDirty","size","notifyChange","updating","updatingProgress","running","view","ready","runTask","startUpdate","madeProgress","processActiveGraphics","sortVisibleGraphics","deconflictVisibleGraphics","modifyGraphics","forEach","addToActiveGraphics","removeFromActiveGraphics","layerSupportsDeconfliction","type","stageObject","getNumGeometryRecords","getGeometryRecord","material","viewState","fullWidth","fullHeight","initBins","resetIterators","visibilityGroup","set","graphic","uid","removeFromVisibleGraphics","oi","delete","addToVisibleGraphics","ensureActiveGraphicsIterator","projectionMatrix","viewingMode","map","ground","opacity","relativeElevation","viewMatrix","spatialReference","radius","done","next","resetActiveGraphicsIterator","value","collectGraphics3DGraphics","ensureSortGraphicsIterator","resetSortGraphicsIterator","ensureVisibleGraphicsIterator","resetVisibleGraphicsIterator","isVisible","isConflicted","addToBins","setGraphicVisibility","sort","ci","ni","destroyed","getGraphicsLayers","getProjectionInfo","pi","isOutsideScreen","isCulledBySlice","isCulledByHorizon","DISABLE_DECONFLICTOR_VISIBILITY_OFFSET","expandBoundingRect","boundingVolumeWorldSpace","bounds","geometry","vertexAttributes","get","data","applyShaderOffsetsView","transformation","scaleInfo","positionNDC","applyShaderOffsetsNDC","distanceWithoutPolygonOffset","depthNDCToWorld","positionView","direction","origin","getScreenSize","hi","factor","pixelRatio","calculateRelativeScreenBounds","factorAlignment","scale","iconMarginFactor","Math","min","floor","length","push","setVisibilityFlag","labeler","setLabelGraphicVisibility","clearVisibilityFlag","prototype","entries","values","pushNew","id","prio","Number","MAX_VALUE","iterableSort","forAll","constructOnly","Boolean","readOnly","li","minPixelSize","paddingPixels","Deconflictor","DeconflictorGraphic","DeconflictorViewState"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as i}from\"../../../../chunks/tslib.es6.js\";import t from\"../../../../core/Accessor.js\";import{lerp as s}from\"../../../../core/mathUtils.js\";import{isNone as e,isSome as r}from\"../../../../core/maybe.js\";import a from\"../../../../core/PooledArray.js\";import{property as o}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/ensureType.js\";import\"../../../../core/Logger.js\";import{subclass as c}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{a as n}from\"../../../../chunks/mat4.js\";import{c as h}from\"../../../../chunks/mat4f64.js\";import{a as l}from\"../../../../chunks/vec2f64.js\";import{m as p,a as u,s as d,g as f}from\"../../../../chunks/vec3.js\";import{Z as m,c as g}from\"../../../../chunks/vec3f64.js\";import{s as b,t as v,b as y}from\"../../../../chunks/vec4.js\";import{c as G}from\"../../../../chunks/vec4f64.js\";import{getReferenceEllipsoid as S}from\"../../../../geometry/projectionEllipsoid.js\";import{create as B,empty as w,offset as D,width as V,height as j,expand as N,intersects as _}from\"../../../../geometry/support/aaBoundingRect.js\";import{a as P,c as C,e as I}from\"../../../../chunks/boundedPlane.js\";import{create as x}from\"../../../../geometry/support/ray.js\";import{d as A,g as M,i as z,c as O}from\"../../../../chunks/sphere.js\";import{drawAccelerationStruct as T,prepare as E,drawPoly as F}from\"./deconflictorDebug.js\";import X from\"../../support/debugFlags.js\";import Y from\"../../webgl-engine/lib/Camera.js\";import{applyPrecomputedScaleFactor as R}from\"../../webgl-engine/lib/screenSizePerspectiveUtils.js\";import{HUDMaterial as k}from\"../../webgl-engine/materials/HUDMaterial.js\";const W=g(),L=G(),U=G(),H=g(),Z=h(),q=O(),J=x(),K=g(),Q=B();class ${constructor(){this.aabr=B(),this.distance=0,this.culled=!1,this.visible=!1}}class ii{constructor(i,t,s={}){this.graphics3DGraphic=i,this.slicePlaneEnabled=t,this.info=s}}class ti{constructor(){this.active=new Map,this.visible=new Map}clear(){this.active.clear(),this.visible.clear()}}class si{}class ei{constructor(){this.sortArray=new a({allocator:i=>i||new si})}}class ri{constructor(){this.camera=new Y,this.slicePlane=P(),this.slicePlaneEnabled=!1}copyFrom(i){this.camera.copyFrom(i.camera),C(i.slicePlane,this.slicePlane),this.slicePlaneEnabled=i.slicePlaneEnabled}}let ai=class extends t{constructor(){super(...arguments),this._dirty=!1,this._runningViewState=new ri,this._state=0,this.graphics=new ti,this.iterators=new ei,this.accBinsNumX=15,this.accBinsNumY=20,this.accBinsSizeX=0,this.accBinsSizeY=0,this.accBins=null,this.accNumTests=0}get dirty(){return this._dirty}get state(){return this._state}destroy(){this.graphics.clear(),this.iterators=null}setDirty(){!this._dirty&&this.graphics.active.size>0&&(this._dirty=!0,this.notifyChange(\"updating\"))}get updating(){return 0!==this._state||this._dirty}get updatingProgress(){if(!this.updating)return 1;const i=this._state/4;return this._dirty?.5*i:i}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(i){switch(this._state){case 0:this.startUpdate(),i.madeProgress();case 1:if(this._state=1,!this.processActiveGraphics(i))return;case 2:if(this._state=2,!this.sortVisibleGraphics(i))return;case 3:if(this._state=3,!this.deconflictVisibleGraphics(i))return;default:T(this,this.graphics.visible),this._state=0,this.notifyChange(\"updating\")}}modifyGraphics(i,t){t?i.forEach((i=>this.addToActiveGraphics(i))):i.forEach((i=>this.removeFromActiveGraphics(i))),this.setDirty()}layerSupportsDeconfliction(i){if(e(i)||\"object3d\"!==i.type)return!1;const t=i.stageObject;if(1!==(t?t.getNumGeometryRecords():0))return!1;return t.getGeometryRecord(0).material instanceof k}startUpdate(){E(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:i,fullHeight:t}=this._runningViewState.camera;this.initBins(i,t),this.resetIterators()}addToActiveGraphics(i){i.info[this.visibilityGroup]=new $,this.graphics.active.set(i.graphics3DGraphic.graphic.uid,i),this.setDirty()}removeFromActiveGraphics(i){this.removeFromVisibleGraphics(i),oi(i,this.visibilityGroup),delete i.info[this.visibilityGroup],this.graphics.active.delete(i.graphics3DGraphic.graphic.uid),this.setDirty()}addToVisibleGraphics(i){this.graphics.visible.set(i.graphics3DGraphic.graphic.uid,i)}removeFromVisibleGraphics(i){this.graphics.visible.delete(i.graphics3DGraphic.graphic.uid)}processActiveGraphics(i){const t=this.ensureActiveGraphicsIterator(),s=n(Z,this._runningViewState.camera.projectionMatrix),e=\"global\"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._runningViewState.camera.relativeElevation>0?q:null;let a=0;for(r(e)&&(p(e,m,this._runningViewState.camera.viewMatrix),e[3]=S(this.view.spatialReference).radius,a=A(e,m));!i.done;){i.madeProgress();const r=t.next();if(r.done)return this.resetActiveGraphicsIterator(),!0;const o=r.value,c=o&&o.info[this.visibilityGroup];c&&(this.collectGraphics3DGraphics(o,s,e,a),c.culled?this.removeFromVisibleGraphics(o):this.addToVisibleGraphics(o))}return!1}sortVisibleGraphics(i){const t=this.ensureSortGraphicsIterator();for(;!i.done;){const s=t.next();if(i.madeProgress(),s.done)return this.resetSortGraphicsIterator(),!0}return!1}deconflictVisibleGraphics(i){const t=this.ensureVisibleGraphicsIterator(),s=1===this.visibilityGroup;for(;!i.done;){i.madeProgress();const e=t.next();if(e.done)return this.resetVisibleGraphicsIterator(),!0;const r=e.value,a=r.info[this.visibilityGroup];if(!a||a.culled)continue;const o=r.graphics3DGraphic,c=(!s||o.isVisible())&&!this.isConflicted(r);c&&this.addToBins(r),a.visible=c,this.setGraphicVisibility(r,c),F(a,c)}return!1}resetIterators(){this.iterators.active=null,this.iterators.visible=null,this.iterators.sort=null}ensureActiveGraphicsIterator(){return this.iterators.active||(this.iterators.active=ci(this.graphics.active)),this.iterators.active}resetActiveGraphicsIterator(){this.iterators.active=null}ensureVisibleGraphicsIterator(){return this.iterators.visible||(this.iterators.visible=ci(this.graphics.visible)),this.iterators.visible}resetVisibleGraphicsIterator(){this.iterators.visible=null}ensureSortGraphicsIterator(){return this.iterators.sort||(this.iterators.sort=ni(this.graphics.visible,this.iterators.sortArray,this.visibilityGroup)),this.iterators.sort}resetSortGraphicsIterator(){this.iterators.sort=null}collectGraphics3DGraphics(i,t,s,a){const o=i.graphics3DGraphic;if(o.destroyed)return;const c=i.info[this.visibilityGroup];if(!o.isVisible(0,3))return void(c.culled=!0);const n=this.getGraphicsLayers(o);w(c.aabr);let h=null;for(const l of n){if(!this.layerSupportsDeconfliction(l))continue;const o=l.stageObject.getGeometryRecord(0).material;if(e(h)){if(h=this.getProjectionInfo(l,t,pi),h.isOutsideScreen||this.isCulledBySlice(i,W)||r(s)&&this.isCulledByHorizon(h,s,a))return void(c.culled=!0);!X.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET&&c.visible&&(h.distance*=.7)}this.expandBoundingRect(c,l,o,h)}e(h)?c.culled=!0:(c.distance=h.distance,c.culled=!1)}getProjectionInfo(i,t,s){const e=this._runningViewState.camera,r=i.stageObject,a=r.getGeometryRecord(0),o=a.material,c=M(r.boundingVolumeWorldSpace.bounds);p(W,c,e.viewMatrix);const n=a.geometry.vertexAttributes,h=n.get(\"normal\").data,l=n.get(\"auxpos1\").data;return o.applyShaderOffsetsView(W,h,r.transformation,l,e,s.scaleInfo,W),b(L,W[0],W[1],W[2],1),v(U,L,e.projectionMatrix),u(s.positionNDC,U,1/U[3]),o.applyShaderOffsetsNDC(s.positionNDC,l,e,s.positionNDC,H),s.distanceWithoutPolygonOffset=e.depthNDCToWorld(H[2]),s.distance=H[2]===s.positionNDC[2]?s.distanceWithoutPolygonOffset:e.depthNDCToWorld(s.positionNDC[2]),b(U,s.positionNDC[0],s.positionNDC[1],s.positionNDC[2],1),v(L,U,t),y(L,L,1/L[3]),d(s.positionView,W[0],W[1],W[2]),s}isCulledByHorizon(i,t,s){return f(J.direction,i.positionView),d(J.origin,0,0,0),!!z(t,J,K)&&i.distanceWithoutPolygonOffset>s}isCulledBySlice(i,t){return i.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&I(this._runningViewState.slicePlane,t)}expandBoundingRect(i,t,e,{positionNDC:r,scaleInfo:a}){const o=this._runningViewState.camera,c=t.getScreenSize(hi);R(c,a.factor,c),c[0]*=o.pixelRatio,c[1]*=o.pixelRatio;const n=D(e.calculateRelativeScreenBounds(c,a.factorAlignment.scale,Q),s(0,o.fullWidth,.5+.5*r[0]),s(0,o.fullHeight,.5+.5*r[1])),h=this.iconMarginFactor;if(0!==h){const i=h*Math.min(V(n),j(n));n[0]-=i,n[1]-=i,n[2]+=i,n[3]+=i}N(i.aabr,n)}isConflicted(i){const t=i.graphics3DGraphic.graphic.uid,s=i.info[this.visibilityGroup];for(let e=Math.floor(s.aabr[0]/this.accBinsSizeX);e<=Math.floor(s.aabr[2]/this.accBinsSizeX);e++)if(!(e<0||e>=this.accBinsNumX))for(let i=Math.floor(s.aabr[1]/this.accBinsSizeY);i<=Math.floor(s.aabr[3]/this.accBinsSizeY);i++){if(i<0||i>=this.accBinsNumY)continue;const r=this.accBins[e][i];for(let i=0;i<r.length;i++){const e=r.data[i],a=e.info[this.visibilityGroup];if(a&&a.visible&&(e.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,_(a.aabr,s.aabr))))return!0}}return!1}initBins(i,t){if(null==this.accBins){this.accBins=[];for(let i=0;i<this.accBinsNumX;i++){this.accBins.push([]);const i=this.accBins[this.accBins.length-1];for(let t=0;t<this.accBinsNumY;t++)i.push(new a)}}else for(let s=0;s<this.accBinsNumX;s++)for(let i=0;i<this.accBinsNumY;i++)this.accBins[s][i].clear();this.accBinsSizeX=i/this.accBinsNumX,this.accBinsSizeY=t/this.accBinsNumY,this.accNumTests=0}addToBins(i){const t=i.info[this.visibilityGroup],s=Math.floor(t.aabr[0]/this.accBinsSizeX),e=Math.floor(t.aabr[2]/this.accBinsSizeX),r=Math.floor(t.aabr[1]/this.accBinsSizeY),a=Math.floor(t.aabr[3]/this.accBinsSizeY);for(let o=s;o<=e;o++)if(!(o<0||o>=this.accBinsNumX))for(let t=r;t<=a;t++)t<0||t>=this.accBinsNumY||this.accBins[o][t].push(i)}setGraphicVisibility(i,t){const s=i.graphics3DGraphic;s.destroyed||(s.setVisibilityFlag(3,t,this.visibilityGroup),1===this.visibilityGroup&&this.view.labeler.setLabelGraphicVisibility(s,t))}};function oi(i,t){const s=i.graphics3DGraphic;s.destroyed||s.clearVisibilityFlag(3,t)}function*ci(i){if(Map.prototype.entries){const t=i.entries();for(let i=t.next();!i.done;i=t.next())yield i.value[1]}else yield*i.values()}function*ni(i,t,s){t.clear(),i.forEach(((i,e)=>{const r=t.pushNew();r.id=e,r.prio=i.info?-i.info[s].distance:Number.MAX_VALUE})),yield;const e=t.iterableSort(((i,t)=>t.prio-i.prio));for(let r=e.next();!r.done;r=e.next())yield;t.forAll((t=>{const s=i.get(t.id);s&&(i.delete(t.id),i.set(t.id,s))})),t.clear()}i([o({constructOnly:!0})],ai.prototype,\"view\",void 0),i([o({type:Boolean,readOnly:!0})],ai.prototype,\"updating\",null),ai=i([c(\"esri.views.3d.layers.graphics.Deconflictor\")],ai);const hi=l();class li{constructor(){this.positionView=g(),this.positionNDC=g(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}}}get isOutsideScreen(){const i=this.positionNDC;return i[0]<-1||i[1]<-1||i[2]<-1||i[0]>=1||i[1]>=1}}const pi=new li;export{ai as Deconflictor,ii as DeconflictorGraphic,ri as DeconflictorViewState};\n"]},"metadata":{},"sourceType":"module"}