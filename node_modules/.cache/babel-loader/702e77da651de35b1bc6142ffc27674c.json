{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../chunks/tslib.es6.js\";\nimport t from \"../../../core/Accessor.js\";\nimport i from \"../../../core/Handles.js\";\nimport s from \"../../../core/has.js\";\nimport a from \"../../../core/Logger.js\";\nimport { isSome as r, isNone as d } from \"../../../core/maybe.js\";\nimport o from \"../../../core/PooledArray.js\";\nimport { EsriPromiseMixin as n } from \"../../../core/Promise.js\";\nimport { createAbortController as h, isAbortError as l } from \"../../../core/promiseUtils.js\";\nimport { init as u } from \"../../../core/watchUtils.js\";\nimport { property as c } from \"../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../core/accessorSupport/ensureType.js\";\nimport { subclass as _ } from \"../../../core/accessorSupport/decorators/subclass.js\";\nimport { projectBoundingRect as p } from \"../../../geometry/projection.js\";\nimport { create as g } from \"../../../geometry/support/aaBoundingBox.js\";\nimport { containsPoint as m, create as y } from \"../../../geometry/support/aaBoundingRect.js\";\nimport { makeDehydratedPoint as x } from \"../dehydratedFeatures.js\";\nimport f from \"../../support/PromiseQueue.js\";\nimport { addTask as b } from \"../../../views/3d/layers/i3s/I3SFrameTask.js\";\nimport { I3SIndex as w } from \"../../../views/3d/layers/i3s/I3SIndex.js\";\nimport N from \"../../../views/3d/layers/i3s/I3SLodHandling.js\";\nimport v from \"../../../views/3d/layers/i3s/I3SNodeLoader.js\";\nimport { I3SStreamDataController as C } from \"../../../views/3d/layers/i3s/I3SStreamDataController.js\";\nimport { getVertexCrs as D, getIndexCrs as L, findIntersectingNodes as S } from \"../../../views/3d/layers/i3s/I3SUtil.js\";\nimport V from \"../../../views/3d/layers/i3s/I3SViewportQueries.js\";\nimport { projectToBoundingBox as I } from \"../../../views/3d/support/extentUtils.js\";\nimport { maxDownloadSlots as A } from \"../../../views/3d/support/index.js\";\nimport { extractSafeScaleBounds as F, scaleBoundsPredicate as P } from \"../../../views/support/layerViewUtils.js\";\nimport { noBudget as U } from \"../../../views/support/Scheduler.js\";\nconst O = a.getLogger(\"esri.layers.graphics.controllers.I3SOnDemandController\"),\n      M = 100,\n      q = 2,\n      G = 1e4,\n      Q = 1e-4,\n      j = 1.2,\n      T = 500,\n      B = 1.5;\nlet E = class extends n(t) {\n  constructor(e) {\n    super(e), this.screenSizeFactor = 0, this.featureTarget = 5e4, this.fixedFeatureTarget = !1, this.updating = !0, this.updatingProgress = 1, this.leavesReached = !1, this.scaleVisibilityEnabled = !0, this._featureLOD = 1, this._stableFeatureLOD = !1, this._isIdle = !1, this._cameraDirty = !0, this._invisibleDirty = !1, this._newLoadingNodes = new o({\n      deallocator: null\n    }), this._loadedNodeScales = new Map(), this._modificationsNodeFilteringArray = new o(), this._downloadingCount = 0, this._loadingNodes = new Map(), this._updatingNodes = new Map(), this._progressMaxNumNodes = 1, this._requiredAttributes = new Array(), this._requiredAttributesDirty = !0, this._updatesDisabled = !1, this.disableIDBCache = !1, this._disableMemCache = !1, this._restartNodeLoading = !1, this._fields = null, this._attributeStorageInfo = null, this._handles = new i(), this._idleQueue = new f(), this._elevationUpdateNodes = new o({\n      deallocator: null\n    }), this._errorCount = 0;\n  }\n\n  get isMeshPyramid() {\n    return \"mesh-pyramids\" === this.layer.profile || \"MeshPyramid\" === this.layer.store.lodType;\n  }\n\n  get isGraphics3D() {\n    return \"points\" === this.layer.profile;\n  }\n\n  get indexStreamController() {\n    const e = this.layerView.view.resourceController.createStreamDataRequester(2);\n    return new C(e, this.layer.apiKey);\n  }\n\n  get dataStreamController() {\n    const e = this.layerView.view.resourceController.createStreamDataRequester(3);\n    return new C(e, this.layer.apiKey);\n  }\n\n  get crsVertex() {\n    return D(this.layer);\n  }\n\n  get crsIndex() {\n    return L(this.layer);\n  }\n\n  get rootNodeVisible() {\n    if (r(this._index)) {\n      const e = this._index.rootNode;\n      if (r(e)) return this._updateViewData(), this._index.isNodeVisible(e.index);\n    }\n\n    return !0;\n  }\n\n  initialize() {\n    this._disableMemCache = !this.layerView.loadCachedGPUData || !this.layerView.addCachedGPUData, this._lodHandling = new N(this.layerView);\n    const e = this.layerView.i3slayer;\n    this.layer = e, this._defaultGeometrySchema = e.store.defaultGeometrySchema, this.disableIDBCache = s(\"disable-feature:idb-cache\"), \"fields\" in e && (this._fields = e.fields, this._attributeStorageInfo = e.attributeStorageInfo), this.addResolvingPromise(Promise.all([this.layer.indexInfo, this.layer.when(), this.layerView.when()]).then(([t]) => {\n      var i;\n      if (this.destroyed || !this.layerView || this.layerView.destroyed) return;\n      const s = this.layerView.view;\n\n      this._setClippingArea(s.clippingArea);\n\n      const a = this.layerView.view.resourceController;\n      this._handles.add([u(s, \"pointsOfInterest.focus.renderLocation\", e => this._pointOfInterestChanged(e)), a.memoryController.events.on(\"quality-changed\", () => this._setCameraDirty()), u(this.layerView, \"suspended\", e => {\n        const t = e ? () => this._updateViewData() : () => this._updateIdleState(!0),\n              i = e ? () => {} : () => this._updateIdleState(!1);\n        this._idleStateCallbacks ? (e && this.cancelNodeLoading(), this.restartNodeLoading(), this._idleStateCallbacks.idleBegin = t, this._idleStateCallbacks.idleEnd = i) : this._idleStateCallbacks = a.scheduler.registerIdleStateCallbacks(t, i);\n      }), b(this.layerView.view.resourceController.scheduler, {\n        update: (e, t) => this._frame(e, t),\n        needsUpdate: () => this.updating\n      }), this.watch(\"uncompressedTextureDownsamplingEnabled\", () => this.restartNodeLoading()), this.watch([\"featureTarget\", \"fixedFeatureTarget\"], () => {\n        this._setCameraDirty(), this._stableFeatureLOD = !1;\n      }), s.state.watch(\"contentCamera\", () => this._setCameraDirty()), this.layer.watch(\"elevationInfo\", () => this._elevationInfoChanged()), this.layer.watch([\"minScale\", \"maxScale\"], () => this._scaleBoundsChanged()), this.layerView.watch(\"lodFactor\", () => this._setCameraDirty()), this.layerView.watch(\"availableFields?\", () => this._requiredFieldsChange()), this.layerView.watch(\"holeFilling\", e => r(this._index) && (this._index.holeFilling = e))]), this._updateScaleHandles(), this._viewportQueries = new V(this.crsIndex, s.renderCoordsHelper, s.state.contentCamera, !s.state.fixedContentCamera || this.isGraphics3D, this._clippingArea, s.elevationProvider, this.layer.elevationInfo, {\n        progressiveLoadFactor: this._getProgressiveLoadFactor(),\n        screenspaceErrorBias: this.lod,\n        angleDependentLoD: this.lod < .5\n      }), this._index = new w(e, t, this.indexStreamController, this._viewportQueries, O, this.layerView.holeFilling, e => this.layerView.isNodeLoaded(e), e => this.layerView.isNodeReloading(e), e => this._shouldLoadNode(e), e => this._enableFromGPUCache(e, 1), e => this._needsUpdate(e), () => !this.indexStreamController.busy, e => this.layerView.computeVisibilityObb ? this.layerView.computeVisibilityObb(e) : null, null != (i = this.layerView) && i.computeNodeFiltering ? e => this.layerView.computeNodeFiltering(e) : void 0);\n      const d = r(this.layer.modifications) && this.layer.modifications && this.layer.modifications.length > 0;\n      this._index.imModificationsChanged(d), this._startNodeLoading();\n    })), this._tmpPoint = x(0, 0, 0, this.crsIndex);\n  }\n\n  updateNodeModificationStatus(e) {\n    const t = this._index,\n          i = this.layerView;\n    r(t) && i && i.updateNodeModificationStatus && (this._modificationsNodeFilteringArray.clear(), e.forAll(e => {\n      const i = t.getNode(e);\n      r(i) && this._modificationsNodeFilteringArray.push(i);\n    }), i.updateNodeModificationStatus(this._modificationsNodeFilteringArray), this._invisibleDirty = !0);\n  }\n\n  destroy() {\n    this.cancelNodeLoading(), this._idleStateCallbacks && (this._isIdle = !1, this._idleStateCallbacks.remove(), this._idleStateCallbacks = null), this._handles.destroy(), this._nodeLoader = null, H.prune(), r(k) && (k.remove(), k = null);\n  }\n\n  _getRequiredAttributes() {\n    if (null == this._attributeStorageInfo || !this._fields || !this.layerView.availableFields) return [];\n    const e = this._attributeStorageInfo,\n          t = this._fields,\n          i = this.layer.objectIdField;\n    return this.layerView.availableFields.map(i => {\n      const s = z(e, i),\n            a = z(t, i);\n      return s >= 0 && a >= 0 ? {\n        index: s,\n        name: t[a].name,\n        field: t[a],\n        attributeStorageInfo: e[s]\n      } : null;\n    }).filter(e => null != e && e.name !== i);\n  }\n\n  _requiredFieldsChange() {\n    const e = this._getRequiredAttributes();\n\n    R(this._requiredAttributes, e) || (this._requiredAttributes = e, this._requiredAttributesDirty = !1, this.restartNodeLoading());\n  }\n\n  requestUpdate() {\n    this._requiredAttributesDirty = !0, this.restartNodeLoading();\n  }\n\n  _setClippingArea(e) {\n    const t = g();\n    I(e, t, this.layerView.view.renderSpatialReference) ? this._clippingArea = t : this._clippingArea = null;\n  }\n\n  _pointOfInterestChanged(e) {\n    r(this._viewportQueries) && (this._viewportQueries.setPointOfInterest(e), r(this._index) && (this._index.progressiveLoadPenalty = K.distancePenalty * this._viewportQueries.distCameraToPOI(), this._index.requestUpdate()));\n  }\n\n  updateClippingArea(e) {\n    this._setClippingArea(e), r(this._viewportQueries) && r(this._index) && (this._viewportQueries.updateExtent(this._clippingArea), this._index.invalidateVisibilityCache()), this._setCameraDirty();\n  }\n\n  _setCameraDirty() {\n    this._cameraDirty = !0, this.notifyChange(\"rootNodeVisible\"), this._lodHandling.setLodGlobalDirty(), this._evaluateUpdating();\n  }\n\n  updateElevationChanged(e, t) {\n    const i = this._index;\n    if (d(i)) return;\n    const s = i.rootNode;\n    if (d(s)) return;\n    const a = this._elevationUpdateNodes;\n    a.clear(), S(e, t, s, this.crsIndex, i, e => a.push(e.index)), a.forAll(e => {\n      i.invalidateBoundingVolumeCache(e), e === s.index && this.notifyChange(\"rootNodeVisible\");\n    }), a.length && this.restartNodeLoading();\n  }\n\n  getParentIndex(e) {\n    return r(this._index) && this._index.getParentIndex(e);\n  }\n\n  _elevationInfoChanged() {\n    r(this._index) && this._index.updateElevationInfo(this.layer.elevationInfo), this._setCameraDirty();\n  }\n\n  _updateScaleHandles() {\n    const e = \"scale-bounds\";\n    this._handles.remove(e), this.areScaleBoundsActive && this._handles.add(this.layerView.view.basemapTerrain.on(\"scale-change\", e => this._scaleUpdateHandler(e)), e);\n  }\n\n  _scaleBoundsChanged() {\n    this.areScaleBoundsActive || this._loadedNodeScales.clear(), this._updateScaleHandles(), this._setCameraDirty();\n  }\n\n  _scaleUpdateHandler(e) {\n    this._updateScaleInBoundingRect(e.scale, e.extent, e.spatialReference), this._setCameraDirty();\n  }\n\n  _updateScaleInBoundingRect(e, t, i) {\n    const s = this._index;\n    if (d(s)) return;\n    const a = s.rootNode;\n    !d(a) && p(t, i, $, this.crsIndex) && this._loadedNodeScales.forEach((t, i) => {\n      const a = s.getNode(i);\n      r(a) && m($, a.mbs) && this._loadedNodeScales.set(i, e);\n    });\n  }\n\n  restartNodeLoading() {\n    this._restartNodeLoading = !0, this.cancelNodeLoading(), this._evaluateUpdating();\n  }\n\n  schedule(e, t) {\n    return this._idleQueue.push(e, t);\n  }\n\n  reschedule(e, t) {\n    return this._idleQueue.unshift(e, t);\n  }\n\n  get isIntegratedMesh() {\n    return \"integrated-mesh\" === this.layer.type;\n  }\n\n  get areScaleBoundsActive() {\n    const {\n      minScale: e,\n      maxScale: t\n    } = F(this.layer);\n    return this.scaleVisibilityEnabled && (e > 0 || t > 0);\n  }\n\n  get unloadedMemoryEstimate() {\n    return d(this._index) || this.layerView.suspended ? 0 : this._index.getUnloadedMemoryEstimate() * this.lodDropFactor;\n  }\n\n  get indexDepth() {\n    return r(this._index) ? this._index.maxLevel : 0;\n  }\n\n  set disableMemCache(e) {\n    this.layerView.loadCachedGPUData && this.layerView.addCachedGPUData || (this._disableMemCache = !0), this._disableMemCache = e;\n  }\n\n  _frame(e, t) {\n    return this.layerView.suspended ? (this._updateViewData(), this._evaluateUpdating(), -1 / 0) : !this.layerView.visible || d(this._index) ? -1 / 0 : (this._processLogError(e, t), this._index.getPriority());\n  }\n\n  _processLogError(e, t) {\n    try {\n      this._process(e, t);\n    } catch (i) {\n      this._errorCount < 50 ? O.error(\"Error during processing: \" + i) : 50 === this._errorCount && O.error(\"Too many errors for this layer. Further errors will not be displayed.\"), this._errorCount++;\n    }\n  }\n\n  _process(e, t) {\n    if (this._restartNodeLoading && this._startNodeLoading(), null != this._nodeLoader && !d(this._index)) {\n      for (this._updateViewData(), this._invisibleDirty && this._removeInvisibleNodes(e) && (this._invisibleDirty = !1), this.isIntegratedMesh && (e.enabled = !1), e.run(() => this._processIndex(e)), this._updateFeatureLOD(), e.run(() => this._processCache(e)), this.isIntegratedMesh && (e.enabled = !0), e.run(() => this._processNodes(e, t)); !e.done && this._idleQueue.process();) e.madeProgress();\n\n      e.run(() => this._prefetchIndex()), t.numIndexLoading += this._index.getIndexLoading(), t.numNodesLoading += this._downloadingCount, e.run(() => this._lodHandling.lodGlobalHandling(e)), this._evaluateUpdating();\n    }\n  }\n\n  _processIndex(e) {\n    if (d(this._index)) return !1;\n\n    if (this._index.dirty) {\n      this._newLoadingNodes.clear(), this._index.update([...this._loadingNodes.keys()], e, e => this.updateNodeModificationStatus(e)), this._disableMemCache || (this._newLoadingNodes.pushArray(this._index.updates.add.data, this._index.updates.add.length), this._newLoadingNodes.pushArray(this._index.updates.missing.data, this._index.updates.missing.length));\n      const t = this._index.featureEstimate.leavesReached;\n      this._index.isLoading() || t === this._get(\"leavesReached\") || this._set(\"leavesReached\", t);\n    }\n\n    return this._index.load();\n  }\n\n  _prefetchIndex() {\n    return !(d(this._index) || this._loadingNodes.size > 0 || this._index.updates.add.length > 0) && this._index.prefetch();\n  }\n\n  _updateFeatureLOD() {\n    if (!this.isGraphics3D || d(this._index) || d(this._viewportQueries)) return;\n    const e = !this._index.isLoading(),\n          t = this.featureTarget * this.baseLOD,\n          i = this._index.featureEstimate;\n\n    if (i.estimate = i.estimate || t / 2, this._index.getIndexMissing() > T) {\n      if (this._featureLOD <= Q) return;\n      this._featureLOD /= B, this._stableFeatureLOD = !1;\n    } else if (e && i.estimate < t) {\n      if (i.leavesReached || this._featureLOD >= G || this._stableFeatureLOD) return;\n      const e = Math.min(10, Math.max(t / i.estimate, 1.001));\n      this._featureLOD *= e;\n\n      const s = this.lod,\n            a = this._index.checkFeatureTarget(t, s);\n\n      a !== s && (this._featureLOD = a / this.baseLOD, this._stableFeatureLOD = !0);\n    } else {\n      if (!(i.estimate > t * j || e && i.estimate > t)) return;\n      if (this._featureLOD <= Q) return;\n      this._featureLOD /= 1 + .25 * (i.estimate / t - 1), this._stableFeatureLOD = !1;\n    }\n\n    this._featureLOD = Math.min(G, Math.max(Q, this._featureLOD)), this._viewportQueries.updateScreenSpaceErrorBias(this.lod), this._index.requestUpdate();\n  }\n\n  _processCache(e) {\n    const t = this._index;\n    if (d(t)) return !1;\n\n    for (; this._newLoadingNodes.length > 0 && !e.done;) {\n      const i = this._newLoadingNodes.pop();\n\n      for (let s = t.getParent(i); r(s) && !this.layerView.isNodeLoaded(s.index) && this._isNodeInScaleBounds(s); s = t.getParent(s.index)) if (this._enableFromGPUCache(s, 0)) {\n        e.madeProgress();\n        break;\n      }\n    }\n\n    return e.hasProgressed;\n  }\n\n  _processNodes(e, t) {\n    if (d(this._index)) return !1;\n    let i = (this._isIdle ? M : q) - this._loadingNodes.size;\n    const s = this._index.updates;\n\n    for (s.cancel.forEach(this._cancelNode, this), s.cancel = []; s.remove.length > 0 && !e.done;) this.layerView.removeNode(s.remove.pop()), e.madeProgress();\n\n    for (; s.update.length > 0 && !e.done;) {\n      const t = this._index.getNode(s.update.pop());\n\n      r(t) && (this._updateLoadedNode(t), e.madeProgress());\n    }\n\n    for (; s.add.length > 0 && !e.done && i > 0;) {\n      --i;\n\n      const a = this._index.getNode(s.add.back());\n\n      if (d(a) || 2 !== a.cacheState && !this._hasNodeLoadToken(t)) break;\n      s.add.pop(), this._loadNode(a), e.madeProgress();\n    }\n\n    return e.hasProgressed;\n  }\n\n  _cancelAllNodes() {\n    this._loadingNodes.forEach(e => e.abort()), this._loadingNodes.clear(), this._updatingNodes.forEach(e => e.abort()), this._updatingNodes.clear();\n  }\n\n  _cancelNode(e) {\n    const t = this._loadingNodes.get(e);\n\n    t && (t.abort(), this._loadingNodes.delete(e));\n  }\n\n  _hasNodeLoadToken(e) {\n    return !(!this._isIdle && e.numNodesLoading + this._loadingNodes.size >= q) && this._downloadingCount < A && !this.dataStreamController.busy;\n  }\n\n  _evaluateUpdating() {\n    let e = !1,\n        t = 0;\n    if (this.layerView.suspended) e = this._cameraDirty, t = e ? 0 : 1;else {\n      const i = (r(this._index) ? this._index.getIndexMissing() : 0) + 3 * (r(this._index) ? this._index.updates.add.length : 0) + 2 * this._loadingNodes.size;\n      e = !!(i > 0 || this._updatingNodes.size > 0 || this._restartNodeLoading || this._cameraDirty || this._idleQueue.length > 0 || this._lodHandling && this._lodHandling.requiresLODGlobalHandling), 0 === i && (this._progressMaxNumNodes = 1), this._progressMaxNumNodes = Math.max(i, this._progressMaxNumNodes), t = 1 - i / this._progressMaxNumNodes;\n    }\n    this.updating = e, this.updatingProgress = t;\n  }\n\n  _updateViewData() {\n    if (!this._cameraDirty || d(this._index) || d(this._viewportQueries)) return;\n    const e = this.layerView.view,\n          {\n      contentCamera: t,\n      fixedContentCamera: i\n    } = e.state;\n    this.screenSizeFactor = 1 / (t.perScreenPixelRatio / 2), this._viewportQueries.updateCamera(t, !i || this.isGraphics3D), this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation), this._viewportQueries.updateScreenSpaceErrorBias(this.lod), this._index.invalidateVisibilityCache(), this._index.progressiveLoadPenalty = K.distancePenalty * this._viewportQueries.distCameraToPOI(), this._index.requestUpdate(), this._stableFeatureLOD = !1, this._invisibleDirty = !0, this._cameraDirty = !1, this.notifyChange(\"rootNodeVisible\");\n  }\n\n  _getProgressiveLoadFactor() {\n    return this.layerView.view.resourceController.memoryController.memoryFactor < 1 ? 1 : this.layerView.progressiveLoadFactor;\n  }\n\n  get lod() {\n    return this._featureLOD * this.baseLOD;\n  }\n\n  get baseLOD() {\n    const e = this.layerView.lodFactor,\n          t = this.layerView.view.resourceController.memoryController.memoryFactor;\n    return this.fixedFeatureTarget ? 1 : (e > 0 ? e : 1) * t;\n  }\n\n  get lodDropFactor() {\n    if (this.fixedFeatureTarget) return 1;\n    const e = this.layerView.view.resourceController.memoryController;\n    return (Math.min(e.memoryFactor, .5) - e.minQuality) / (.5 - e.minQuality);\n  }\n\n  isGeometryVisible(e) {\n    return r(this._index) && this._index.isGeometryVisible(e.index);\n  }\n\n  updateVisibility(e) {\n    r(this._index) && this._index.invalidateNodeVisibilityCache(e);\n  }\n\n  updateBoundingVolume(e) {\n    r(this._index) && this._index.invalidateBoundingVolumeCache(e);\n  }\n\n  invalidateGeometryVisibility(e) {\n    r(this._index) && this._index.invalidateGeometryVisibility(e);\n  }\n\n  invalidateVisibilityObbs() {\n    r(this._index) && this._index.invalidateVisibilityObbs();\n  }\n\n  modificationsChanged() {\n    if (r(this._index)) {\n      const e = r(this.layer.modifications) && this.layer.modifications && this.layer.modifications.length > 0;\n\n      this._index.imModificationsChanged(e);\n    }\n\n    this._invisibleDirty = !0;\n  }\n\n  _shouldLoadNode(e) {\n    return !(!this._lodHandling.shouldLoadNode(e) || this._shouldDropNode(e) || !this._isNodeInScaleBounds(e)) && !!r(this._index) && this._index.isGeometryVisible(e.index);\n  }\n\n  _shouldDropNode(e) {\n    if (d(this._viewportQueries)) return !1;\n    const t = this.lodDropFactor;\n    if (t >= 1 || !this._lodHandling.hasNoVisibleChildren(e)) return !1;\n    return Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e)) - this._viewportQueries.minDistance > (this._viewportQueries.maxDistance - this._viewportQueries.minDistance) * t;\n  }\n\n  _startNodeLoading() {\n    this._restartNodeLoading = !1;\n    const e = this._index;\n    if (this._updatesDisabled || d(e) || d(this._viewportQueries)) return;\n    this._updateViewData(), this._requiredAttributesDirty && (this._requiredAttributes = this._getRequiredAttributes(), this._requiredAttributesDirty = !1);\n    const t = {\n      textureEncodings: this.layerView.supportedTextureEncodings,\n      uncompressedTextureDownsamplingEnabled: this.layerView.uncompressedTextureDownsamplingEnabled,\n      textureUsageMask: this.layerView.rendererTextureUsage,\n      loadFeatureData: !this.isMeshPyramid\n    };\n    this._nodeLoader = new v(this.layer, this.dataStreamController, O, this._defaultGeometrySchema, this._requiredAttributes, t), e.requestUpdate(), this._lodHandling.startNodeLoading(e => this._isNodeInScaleBounds(e), (e, t) => this._removeNodes(e, t, 1), e, {\n      maxLodLevel: this._viewportQueries.maxLodLevel\n    }), this._evaluateUpdating();\n  }\n\n  isNodeLoading() {\n    return null != this._nodeLoader && null != this._index;\n  }\n\n  cancelNodeLoading() {\n    this.isNodeLoading() && (this.indexStreamController.cancelAll(), this.dataStreamController.cancelAll(), this._idleQueue.cancelAll(), this._cancelAllNodes(), this._nodeLoader = null, this._evaluateUpdating());\n  }\n\n  _removeInvisibleNodes(e) {\n    const t = this._index;\n    if (d(t) || d(this._viewportQueries)) return !1;\n    H.clear(), this.layerView.getLoadedNodeIndices(H);\n    const i = 0 === this._viewportQueries.maxDistance,\n          s = i ? () => !1 : e => this._shouldDropNode(e);\n    return H.filterInPlace(e => {\n      const i = t.getNode(e);\n      return d(i) || !t.isGeometryVisible(e) || s(i) || !this._isNodeInScaleBounds(i);\n    }), H.length > 0 && this._lodHandling.setLodGlobalDirty(), this._removeNodes(H, e, 0), !(i && this.lodDropFactor < 1) && (0 === H.length || (H.clear(), !1));\n  }\n\n  markNodeToRemove(e) {\n    H.push(e);\n  }\n\n  removeMarkedNodes() {\n    this._removeNodes(H, U, 0);\n  }\n\n  _removeNodes(e, t, i) {\n    const s = e.length;\n\n    if (0 !== s && !t.done) {\n      for (r(this._index) && this._index.requestUpdate(); e.length > 0 && !t.done;) {\n        const s = e.pop(),\n              a = this._index;\n        1 === i && this.layerView.nodeFadeoutEnabled && r(a) && a.isGeometryVisible(s) ? this.layerView.fadeNode(s, 1, !0) : this.layerView.removeNode(s), t.madeProgress();\n      }\n\n      if (this._loadedNodeScales.size > 0) for (let t = e.length; t < s; t++) {\n        const i = e.data[t];\n\n        this._loadedNodeScales.delete(i);\n      }\n    }\n  }\n\n  _needsUpdate(e) {\n    if (!e.resources.hasFeatureData || this._updatingNodes.has(e.index)) return !1;\n    const t = this.layerView.getLoadedAttributes(e.index);\n    return null != t && t !== this._requiredAttributes;\n  }\n\n  _updateLoadedNode(e) {\n    const t = h();\n\n    this._updatingNodes.set(e.index, t);\n\n    (R(this.layerView.getLoadedAttributes(e.index), this._requiredAttributes) ? Promise.resolve(this.layerView.getAttributeData(e.index)) : this._nodeLoader.loadAttributes(e, this._requiredAttributes, t.signal)).then(i => this.schedule(() => this.layerView.updateAttributes(e.index, {\n      loadedAttributes: this._requiredAttributes,\n      attributeData: i\n    }, t.signal), t.signal)).catch(i => {\n      if (!l(i)) return this.layerView.updateAttributes(e.index, {\n        loadedAttributes: this._requiredAttributes,\n        attributeData: {}\n      }, t.signal);\n    }).catch(() => {}).then(() => {\n      this._updatingNodes.delete(e.index), this._evaluateUpdating();\n    }), this._evaluateUpdating();\n  }\n\n  _loadNode(e) {\n    if (this._loadingNodes.has(e.index)) return void O.error(\"already loading node \" + e.index);\n    const t = h();\n\n    this._loadingNodes.set(e.index, t);\n\n    const i = () => {\n      this._loadingNodes.get(e.index) === t && this._loadingNodes.delete(e.index), this._evaluateUpdating();\n    };\n\n    this._evaluateUpdating(), this._loadAndAddNode(e, t.signal).then(i).catch(e => {\n      if (i(), !l(e)) throw e;\n    });\n  }\n\n  _loadAndAddNode(e, t) {\n    return 1 === e.cacheState ? this._loadUncached(e, t) : this._loadCached(e, t).then(t => {\n      t || (e.cacheState = 1, r(this._index) && this._index.updates.add.push(e.index));\n    }).catch(t => {\n      if (!l(t)) throw e.cacheState = 1, t;\n    });\n  }\n\n  _enableFromGPUCache(e, t) {\n    if (this._disableMemCache || d(this._index)) return !1;\n    if (0 === t && !this._index.useNodeAsHole(e.index)) return !0;\n\n    const i = this._loadCachedGPUData(e);\n\n    return !!i && (this.layerView.addCachedGPUData(e, i, t), this._nodeAdded(), !0);\n  }\n\n  _loadCachedGPUData(e) {\n    const t = this.layerView.loadCachedGPUData(e);\n    return r(t) && r(t.attributeInfo) && R(t.attributeInfo.loadedAttributes, this._requiredAttributes) ? t : (this.layerView.deleteCachedGPUData(t), null);\n  }\n\n  _nodeAdded() {\n    r(this._index) && this._index.requestUpdate(), this._lodHandling.setLodGlobalDirty(), this._evaluateUpdating();\n  }\n\n  _loadCached(e, t) {\n    if (this._enableFromGPUCache(e, 1)) return Promise.resolve(!0);\n    const i = this.layerView;\n    return !this.disableIDBCache && i.loadCachedNodeData && i.addCachedNodeData ? this.schedule(() => i.loadCachedNodeData(e, t, (t, i) => this._nodeLoader.loadTextures(e, t, i)), t).then(s => {\n      if (d(s)) return !1;\n      const a = this._requiredAttributes;\n      return this.reschedule(() => this._nodeLoader.loadAttributes(e, a, t), t).then(r => this.reschedule(() => i.addCachedNodeData(e, s, {\n        loadedAttributes: a,\n        attributeData: r\n      }, t), t)).then(() => (this._nodeAdded(), !0));\n    }) : Promise.resolve(!1);\n  }\n\n  _loadUncached(e, t) {\n    return this._downloadingCount++, this._nodeLoader.loadNodeData(e, t).catch(e => {\n      throw this._downloadingCount--, e;\n    }).then(i => (this._downloadingCount--, this.schedule(() => this.layerView.addNode(e, i, t), t))).then(() => {\n      this._nodeAdded(), e.cacheState = 2;\n    }).catch(t => {\n      if (!l(t)) throw O.error(\"#loadNodeData()\", this.layer, `Failed to load node '${e.id}'`, t), e.failed = !0, r(this._index) && this._index.requestUpdate(), t;\n    });\n  }\n\n  _updateIdleState(e) {\n    e !== this._isIdle && (this._isIdle = e, this._evaluateUpdating(), e && this._index && r(this._index) && this._index.resetFailedNodes());\n  }\n\n  _getScale(e) {\n    if (this._loadedNodeScales.has(e.index)) return this._loadedNodeScales.get(e.index);\n    this._tmpPoint.x = e.mbs[0], this._tmpPoint.y = e.mbs[1], this._tmpPoint.z = e.mbs[2];\n    const t = this.layerView.view.basemapTerrain.getScale(this._tmpPoint);\n    return this.layerView.isNodeLoaded(e.index) && this._loadedNodeScales.set(e.index, t), t;\n  }\n\n  _isNodeInScaleBounds(e) {\n    if (!this.areScaleBoundsActive) return !0;\n\n    const t = this._getScale(e),\n          {\n      minScale: i,\n      maxScale: s\n    } = F(this.layer);\n\n    return P(t, i, s);\n  }\n\n  updateStats(e) {\n    e.index = r(this._index) ? this._index.size : 0, this.isGraphics3D && (e.detail = this._featureLOD, e.target = this.featureTarget * this.baseLOD), r(this._index) && this._index.updateStats(e);\n  }\n\n  get test() {\n    const e = this;\n    return {\n      index: this._index,\n\n      set disableUpdates(t) {\n        e._updatesDisabled = t, t ? e.cancelNodeLoading() : e.requestUpdate();\n      },\n\n      set disableIDBCache(t) {\n        e.disableIDBCache = t;\n      },\n\n      set ignoreServiceObb(t) {\n        r(e._index) && (e._index.ignoreServiceObb = t);\n      },\n\n      shouldLoadNode: t => e._shouldLoadNode(t)\n    };\n  }\n\n  notifyLODUpdate() {\n    this._lodHandling.setLodGlobalDirty(), this._evaluateUpdating(), r(this._index) && this._index.requestUpdate();\n  }\n\n  geometryFilterChanged(e) {\n    const t = this._index;\n    r(t) && t.layerFilterChanged(e), this.requestUpdate();\n  }\n\n};\ne([c({\n  readOnly: !0\n})], E.prototype, \"isMeshPyramid\", null), e([c({\n  readOnly: !0\n})], E.prototype, \"isGraphics3D\", null), e([c({\n  readOnly: !0\n})], E.prototype, \"indexStreamController\", null), e([c({\n  readOnly: !0\n})], E.prototype, \"dataStreamController\", null), e([c({\n  readOnly: !0\n})], E.prototype, \"crsVertex\", null), e([c({\n  readOnly: !0\n})], E.prototype, \"crsIndex\", null), e([c()], E.prototype, \"screenSizeFactor\", void 0), e([c()], E.prototype, \"featureTarget\", void 0), e([c()], E.prototype, \"fixedFeatureTarget\", void 0), e([c()], E.prototype, \"layerView\", void 0), e([c()], E.prototype, \"layer\", void 0), e([c({})], E.prototype, \"updating\", void 0), e([c({})], E.prototype, \"updatingProgress\", void 0), e([c({\n  readOnly: !0\n})], E.prototype, \"leavesReached\", void 0), e([c({\n  constructOnly: !0\n})], E.prototype, \"scaleVisibilityEnabled\", void 0), e([c({\n  readOnly: !0,\n  dependsOn: []\n})], E.prototype, \"rootNodeVisible\", null), E = e([_(\"esri.layers.graphics.controllers.I3SOnDemandController\")], E);\nconst H = new o({\n  deallocator: null\n});\nlet k;\n\nfunction R(e, t) {\n  return r(e) && e.length === t.length && e.every(e => z(t, e.name) >= 0);\n}\n\nfunction z(e, t) {\n  const i = t.toLowerCase();\n\n  for (let s = 0; s < e.length; s++) if (e[s].name.toLowerCase() === i) return s;\n\n  return -1;\n}\n\nconst K = {\n  factorIM: .2,\n  factor3dObject: .05,\n  distancePenalty: 10\n},\n      $ = y();\nvar J = E;\nexport default J;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/layers/graphics/controllers/I3SOnDemandController.js"],"names":["_","e","t","i","s","a","isSome","r","isNone","d","o","EsriPromiseMixin","n","createAbortController","h","isAbortError","l","init","u","property","c","subclass","projectBoundingRect","p","create","g","containsPoint","m","y","makeDehydratedPoint","x","f","addTask","b","I3SIndex","w","N","v","I3SStreamDataController","C","getVertexCrs","D","getIndexCrs","L","findIntersectingNodes","S","V","projectToBoundingBox","I","maxDownloadSlots","A","extractSafeScaleBounds","F","scaleBoundsPredicate","P","noBudget","U","O","getLogger","M","q","G","Q","j","T","B","E","constructor","screenSizeFactor","featureTarget","fixedFeatureTarget","updating","updatingProgress","leavesReached","scaleVisibilityEnabled","_featureLOD","_stableFeatureLOD","_isIdle","_cameraDirty","_invisibleDirty","_newLoadingNodes","deallocator","_loadedNodeScales","Map","_modificationsNodeFilteringArray","_downloadingCount","_loadingNodes","_updatingNodes","_progressMaxNumNodes","_requiredAttributes","Array","_requiredAttributesDirty","_updatesDisabled","disableIDBCache","_disableMemCache","_restartNodeLoading","_fields","_attributeStorageInfo","_handles","_idleQueue","_elevationUpdateNodes","_errorCount","isMeshPyramid","layer","profile","store","lodType","isGraphics3D","indexStreamController","layerView","view","resourceController","createStreamDataRequester","apiKey","dataStreamController","crsVertex","crsIndex","rootNodeVisible","_index","rootNode","_updateViewData","isNodeVisible","index","initialize","loadCachedGPUData","addCachedGPUData","_lodHandling","i3slayer","_defaultGeometrySchema","defaultGeometrySchema","fields","attributeStorageInfo","addResolvingPromise","Promise","all","indexInfo","when","then","destroyed","_setClippingArea","clippingArea","add","_pointOfInterestChanged","memoryController","events","on","_setCameraDirty","_updateIdleState","_idleStateCallbacks","cancelNodeLoading","restartNodeLoading","idleBegin","idleEnd","scheduler","registerIdleStateCallbacks","update","_frame","needsUpdate","watch","state","_elevationInfoChanged","_scaleBoundsChanged","_requiredFieldsChange","holeFilling","_updateScaleHandles","_viewportQueries","renderCoordsHelper","contentCamera","fixedContentCamera","_clippingArea","elevationProvider","elevationInfo","progressiveLoadFactor","_getProgressiveLoadFactor","screenspaceErrorBias","lod","angleDependentLoD","isNodeLoaded","isNodeReloading","_shouldLoadNode","_enableFromGPUCache","_needsUpdate","busy","computeVisibilityObb","computeNodeFiltering","modifications","length","imModificationsChanged","_startNodeLoading","_tmpPoint","updateNodeModificationStatus","clear","forAll","getNode","push","destroy","remove","_nodeLoader","H","prune","k","_getRequiredAttributes","availableFields","objectIdField","map","z","name","field","filter","R","requestUpdate","renderSpatialReference","setPointOfInterest","progressiveLoadPenalty","K","distancePenalty","distCameraToPOI","updateClippingArea","updateExtent","invalidateVisibilityCache","notifyChange","setLodGlobalDirty","_evaluateUpdating","updateElevationChanged","invalidateBoundingVolumeCache","getParentIndex","updateElevationInfo","areScaleBoundsActive","basemapTerrain","_scaleUpdateHandler","_updateScaleInBoundingRect","scale","extent","spatialReference","$","forEach","mbs","set","schedule","reschedule","unshift","isIntegratedMesh","type","minScale","maxScale","unloadedMemoryEstimate","suspended","getUnloadedMemoryEstimate","lodDropFactor","indexDepth","maxLevel","disableMemCache","visible","_processLogError","getPriority","_process","error","_removeInvisibleNodes","enabled","run","_processIndex","_updateFeatureLOD","_processCache","_processNodes","done","process","madeProgress","_prefetchIndex","numIndexLoading","getIndexLoading","numNodesLoading","lodGlobalHandling","dirty","keys","pushArray","updates","data","missing","featureEstimate","isLoading","_get","_set","load","size","prefetch","baseLOD","estimate","getIndexMissing","Math","min","max","checkFeatureTarget","updateScreenSpaceErrorBias","pop","getParent","_isNodeInScaleBounds","hasProgressed","cancel","_cancelNode","removeNode","_updateLoadedNode","back","cacheState","_hasNodeLoadToken","_loadNode","_cancelAllNodes","abort","get","delete","requiresLODGlobalHandling","perScreenPixelRatio","updateCamera","pointsOfInterest","focus","renderLocation","memoryFactor","lodFactor","minQuality","isGeometryVisible","updateVisibility","invalidateNodeVisibilityCache","updateBoundingVolume","invalidateGeometryVisibility","invalidateVisibilityObbs","modificationsChanged","shouldLoadNode","_shouldDropNode","hasNoVisibleChildren","abs","calcCameraDistanceToCenter","minDistance","maxDistance","textureEncodings","supportedTextureEncodings","uncompressedTextureDownsamplingEnabled","textureUsageMask","rendererTextureUsage","loadFeatureData","startNodeLoading","_removeNodes","maxLodLevel","isNodeLoading","cancelAll","getLoadedNodeIndices","filterInPlace","markNodeToRemove","removeMarkedNodes","nodeFadeoutEnabled","fadeNode","resources","hasFeatureData","has","getLoadedAttributes","resolve","getAttributeData","loadAttributes","signal","updateAttributes","loadedAttributes","attributeData","catch","_loadAndAddNode","_loadUncached","_loadCached","useNodeAsHole","_loadCachedGPUData","_nodeAdded","attributeInfo","deleteCachedGPUData","loadCachedNodeData","addCachedNodeData","loadTextures","loadNodeData","addNode","id","failed","resetFailedNodes","_getScale","getScale","updateStats","detail","target","test","disableUpdates","ignoreServiceObb","notifyLODUpdate","geometryFilterChanged","layerFilterChanged","readOnly","prototype","constructOnly","dependsOn","every","toLowerCase","factorIM","factor3dObject","J"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import t from\"../../../core/Accessor.js\";import i from\"../../../core/Handles.js\";import s from\"../../../core/has.js\";import a from\"../../../core/Logger.js\";import{isSome as r,isNone as d}from\"../../../core/maybe.js\";import o from\"../../../core/PooledArray.js\";import{EsriPromiseMixin as n}from\"../../../core/Promise.js\";import{createAbortController as h,isAbortError as l}from\"../../../core/promiseUtils.js\";import{init as u}from\"../../../core/watchUtils.js\";import{property as c}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/accessorSupport/ensureType.js\";import{subclass as _}from\"../../../core/accessorSupport/decorators/subclass.js\";import{projectBoundingRect as p}from\"../../../geometry/projection.js\";import{create as g}from\"../../../geometry/support/aaBoundingBox.js\";import{containsPoint as m,create as y}from\"../../../geometry/support/aaBoundingRect.js\";import{makeDehydratedPoint as x}from\"../dehydratedFeatures.js\";import f from\"../../support/PromiseQueue.js\";import{addTask as b}from\"../../../views/3d/layers/i3s/I3SFrameTask.js\";import{I3SIndex as w}from\"../../../views/3d/layers/i3s/I3SIndex.js\";import N from\"../../../views/3d/layers/i3s/I3SLodHandling.js\";import v from\"../../../views/3d/layers/i3s/I3SNodeLoader.js\";import{I3SStreamDataController as C}from\"../../../views/3d/layers/i3s/I3SStreamDataController.js\";import{getVertexCrs as D,getIndexCrs as L,findIntersectingNodes as S}from\"../../../views/3d/layers/i3s/I3SUtil.js\";import V from\"../../../views/3d/layers/i3s/I3SViewportQueries.js\";import{projectToBoundingBox as I}from\"../../../views/3d/support/extentUtils.js\";import{maxDownloadSlots as A}from\"../../../views/3d/support/index.js\";import{extractSafeScaleBounds as F,scaleBoundsPredicate as P}from\"../../../views/support/layerViewUtils.js\";import{noBudget as U}from\"../../../views/support/Scheduler.js\";const O=a.getLogger(\"esri.layers.graphics.controllers.I3SOnDemandController\"),M=100,q=2,G=1e4,Q=1e-4,j=1.2,T=500,B=1.5;let E=class extends(n(t)){constructor(e){super(e),this.screenSizeFactor=0,this.featureTarget=5e4,this.fixedFeatureTarget=!1,this.updating=!0,this.updatingProgress=1,this.leavesReached=!1,this.scaleVisibilityEnabled=!0,this._featureLOD=1,this._stableFeatureLOD=!1,this._isIdle=!1,this._cameraDirty=!0,this._invisibleDirty=!1,this._newLoadingNodes=new o({deallocator:null}),this._loadedNodeScales=new Map,this._modificationsNodeFilteringArray=new o,this._downloadingCount=0,this._loadingNodes=new Map,this._updatingNodes=new Map,this._progressMaxNumNodes=1,this._requiredAttributes=new Array,this._requiredAttributesDirty=!0,this._updatesDisabled=!1,this.disableIDBCache=!1,this._disableMemCache=!1,this._restartNodeLoading=!1,this._fields=null,this._attributeStorageInfo=null,this._handles=new i,this._idleQueue=new f,this._elevationUpdateNodes=new o({deallocator:null}),this._errorCount=0}get isMeshPyramid(){return\"mesh-pyramids\"===this.layer.profile||\"MeshPyramid\"===this.layer.store.lodType}get isGraphics3D(){return\"points\"===this.layer.profile}get indexStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(2);return new C(e,this.layer.apiKey)}get dataStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(3);return new C(e,this.layer.apiKey)}get crsVertex(){return D(this.layer)}get crsIndex(){return L(this.layer)}get rootNodeVisible(){if(r(this._index)){const e=this._index.rootNode;if(r(e))return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0}initialize(){this._disableMemCache=!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData,this._lodHandling=new N(this.layerView);const e=this.layerView.i3slayer;this.layer=e,this._defaultGeometrySchema=e.store.defaultGeometrySchema,this.disableIDBCache=s(\"disable-feature:idb-cache\"),\"fields\"in e&&(this._fields=e.fields,this._attributeStorageInfo=e.attributeStorageInfo),this.addResolvingPromise(Promise.all([this.layer.indexInfo,this.layer.when(),this.layerView.when()]).then((([t])=>{var i;if(this.destroyed||!this.layerView||this.layerView.destroyed)return;const s=this.layerView.view;this._setClippingArea(s.clippingArea);const a=this.layerView.view.resourceController;this._handles.add([u(s,\"pointsOfInterest.focus.renderLocation\",(e=>this._pointOfInterestChanged(e))),a.memoryController.events.on(\"quality-changed\",(()=>this._setCameraDirty())),u(this.layerView,\"suspended\",(e=>{const t=e?()=>this._updateViewData():()=>this._updateIdleState(!0),i=e?()=>{}:()=>this._updateIdleState(!1);this._idleStateCallbacks?(e&&this.cancelNodeLoading(),this.restartNodeLoading(),this._idleStateCallbacks.idleBegin=t,this._idleStateCallbacks.idleEnd=i):this._idleStateCallbacks=a.scheduler.registerIdleStateCallbacks(t,i)})),b(this.layerView.view.resourceController.scheduler,{update:(e,t)=>this._frame(e,t),needsUpdate:()=>this.updating}),this.watch(\"uncompressedTextureDownsamplingEnabled\",(()=>this.restartNodeLoading())),this.watch([\"featureTarget\",\"fixedFeatureTarget\"],(()=>{this._setCameraDirty(),this._stableFeatureLOD=!1})),s.state.watch(\"contentCamera\",(()=>this._setCameraDirty())),this.layer.watch(\"elevationInfo\",(()=>this._elevationInfoChanged())),this.layer.watch([\"minScale\",\"maxScale\"],(()=>this._scaleBoundsChanged())),this.layerView.watch(\"lodFactor\",(()=>this._setCameraDirty())),this.layerView.watch(\"availableFields?\",(()=>this._requiredFieldsChange())),this.layerView.watch(\"holeFilling\",(e=>r(this._index)&&(this._index.holeFilling=e)))]),this._updateScaleHandles(),this._viewportQueries=new V(this.crsIndex,s.renderCoordsHelper,s.state.contentCamera,!s.state.fixedContentCamera||this.isGraphics3D,this._clippingArea,s.elevationProvider,this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this.lod,angleDependentLoD:this.lod<.5}),this._index=new w(e,t,this.indexStreamController,this._viewportQueries,O,this.layerView.holeFilling,(e=>this.layerView.isNodeLoaded(e)),(e=>this.layerView.isNodeReloading(e)),(e=>this._shouldLoadNode(e)),(e=>this._enableFromGPUCache(e,1)),(e=>this._needsUpdate(e)),(()=>!this.indexStreamController.busy),(e=>this.layerView.computeVisibilityObb?this.layerView.computeVisibilityObb(e):null),null!=(i=this.layerView)&&i.computeNodeFiltering?e=>this.layerView.computeNodeFiltering(e):void 0);const d=r(this.layer.modifications)&&this.layer.modifications&&this.layer.modifications.length>0;this._index.imModificationsChanged(d),this._startNodeLoading()}))),this._tmpPoint=x(0,0,0,this.crsIndex)}updateNodeModificationStatus(e){const t=this._index,i=this.layerView;r(t)&&i&&i.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),e.forAll((e=>{const i=t.getNode(e);r(i)&&this._modificationsNodeFilteringArray.push(i)})),i.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}destroy(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,H.prune(),r(k)&&(k.remove(),k=null)}_getRequiredAttributes(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];const e=this._attributeStorageInfo,t=this._fields,i=this.layer.objectIdField;return this.layerView.availableFields.map((i=>{const s=z(e,i),a=z(t,i);return s>=0&&a>=0?{index:s,name:t[a].name,field:t[a],attributeStorageInfo:e[s]}:null})).filter((e=>null!=e&&e.name!==i))}_requiredFieldsChange(){const e=this._getRequiredAttributes();R(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())}requestUpdate(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}_setClippingArea(e){const t=g();I(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null}_pointOfInterestChanged(e){r(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(e),r(this._index)&&(this._index.progressiveLoadPenalty=K.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}updateClippingArea(e){this._setClippingArea(e),r(this._viewportQueries)&&r(this._index)&&(this._viewportQueries.updateExtent(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}_setCameraDirty(){this._cameraDirty=!0,this.notifyChange(\"rootNodeVisible\"),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}updateElevationChanged(e,t){const i=this._index;if(d(i))return;const s=i.rootNode;if(d(s))return;const a=this._elevationUpdateNodes;a.clear(),S(e,t,s,this.crsIndex,i,(e=>a.push(e.index))),a.forAll((e=>{i.invalidateBoundingVolumeCache(e),e===s.index&&this.notifyChange(\"rootNodeVisible\")})),a.length&&this.restartNodeLoading()}getParentIndex(e){return r(this._index)&&this._index.getParentIndex(e)}_elevationInfoChanged(){r(this._index)&&this._index.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()}_updateScaleHandles(){const e=\"scale-bounds\";this._handles.remove(e),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on(\"scale-change\",(e=>this._scaleUpdateHandler(e))),e)}_scaleBoundsChanged(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}_scaleUpdateHandler(e){this._updateScaleInBoundingRect(e.scale,e.extent,e.spatialReference),this._setCameraDirty()}_updateScaleInBoundingRect(e,t,i){const s=this._index;if(d(s))return;const a=s.rootNode;!d(a)&&p(t,i,$,this.crsIndex)&&this._loadedNodeScales.forEach(((t,i)=>{const a=s.getNode(i);r(a)&&m($,a.mbs)&&this._loadedNodeScales.set(i,e)}))}restartNodeLoading(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}schedule(e,t){return this._idleQueue.push(e,t)}reschedule(e,t){return this._idleQueue.unshift(e,t)}get isIntegratedMesh(){return\"integrated-mesh\"===this.layer.type}get areScaleBoundsActive(){const{minScale:e,maxScale:t}=F(this.layer);return this.scaleVisibilityEnabled&&(e>0||t>0)}get unloadedMemoryEstimate(){return d(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor}get indexDepth(){return r(this._index)?this._index.maxLevel:0}set disableMemCache(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=e}_frame(e,t){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||d(this._index)?-1/0:(this._processLogError(e,t),this._index.getPriority())}_processLogError(e,t){try{this._process(e,t)}catch(i){this._errorCount<50?O.error(\"Error during processing: \"+i):50===this._errorCount&&O.error(\"Too many errors for this layer. Further errors will not be displayed.\"),this._errorCount++}}_process(e,t){if(this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&!d(this._index)){for(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this.isIntegratedMesh&&(e.enabled=!1),e.run((()=>this._processIndex(e))),this._updateFeatureLOD(),e.run((()=>this._processCache(e))),this.isIntegratedMesh&&(e.enabled=!0),e.run((()=>this._processNodes(e,t)));!e.done&&this._idleQueue.process();)e.madeProgress();e.run((()=>this._prefetchIndex())),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingCount,e.run((()=>this._lodHandling.lodGlobalHandling(e))),this._evaluateUpdating()}}_processIndex(e){if(d(this._index))return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update([...this._loadingNodes.keys()],e,(e=>this.updateNodeModificationStatus(e))),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));const t=this._index.featureEstimate.leavesReached;this._index.isLoading()||t===this._get(\"leavesReached\")||this._set(\"leavesReached\",t)}return this._index.load()}_prefetchIndex(){return!(d(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}_updateFeatureLOD(){if(!this.isGraphics3D||d(this._index)||d(this._viewportQueries))return;const e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,i=this._index.featureEstimate;if(i.estimate=i.estimate||t/2,this._index.getIndexMissing()>T){if(this._featureLOD<=Q)return;this._featureLOD/=B,this._stableFeatureLOD=!1}else if(e&&i.estimate<t){if(i.leavesReached||this._featureLOD>=G||this._stableFeatureLOD)return;const e=Math.min(10,Math.max(t/i.estimate,1.001));this._featureLOD*=e;const s=this.lod,a=this._index.checkFeatureTarget(t,s);a!==s&&(this._featureLOD=a/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(i.estimate>t*j||e&&i.estimate>t))return;if(this._featureLOD<=Q)return;this._featureLOD/=1+.25*(i.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(G,Math.max(Q,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}_processCache(e){const t=this._index;if(d(t))return!1;for(;this._newLoadingNodes.length>0&&!e.done;){const i=this._newLoadingNodes.pop();for(let s=t.getParent(i);r(s)&&(!this.layerView.isNodeLoaded(s.index)&&this._isNodeInScaleBounds(s));s=t.getParent(s.index))if(this._enableFromGPUCache(s,0)){e.madeProgress();break}}return e.hasProgressed}_processNodes(e,t){if(d(this._index))return!1;let i=(this._isIdle?M:q)-this._loadingNodes.size;const s=this._index.updates;for(s.cancel.forEach(this._cancelNode,this),s.cancel=[];s.remove.length>0&&!e.done;)this.layerView.removeNode(s.remove.pop()),e.madeProgress();for(;s.update.length>0&&!e.done;){const t=this._index.getNode(s.update.pop());r(t)&&(this._updateLoadedNode(t),e.madeProgress())}for(;s.add.length>0&&!e.done&&i>0;){--i;const a=this._index.getNode(s.add.back());if(d(a)||2!==a.cacheState&&!this._hasNodeLoadToken(t))break;s.add.pop(),this._loadNode(a),e.madeProgress()}return e.hasProgressed}_cancelAllNodes(){this._loadingNodes.forEach((e=>e.abort())),this._loadingNodes.clear(),this._updatingNodes.forEach((e=>e.abort())),this._updatingNodes.clear()}_cancelNode(e){const t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))}_hasNodeLoadToken(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=q)&&(this._downloadingCount<A&&!this.dataStreamController.busy)}_evaluateUpdating(){let e=!1,t=0;if(this.layerView.suspended)e=this._cameraDirty,t=e?0:1;else{const i=(r(this._index)?this._index.getIndexMissing():0)+3*(r(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(i>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===i&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(i,this._progressMaxNumNodes),t=1-i/this._progressMaxNumNodes}this.updating=e,this.updatingProgress=t}_updateViewData(){if(!this._cameraDirty||d(this._index)||d(this._viewportQueries))return;const e=this.layerView.view,{contentCamera:t,fixedContentCamera:i}=e.state;this.screenSizeFactor=1/(t.perScreenPixelRatio/2),this._viewportQueries.updateCamera(t,!i||this.isGraphics3D),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=K.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange(\"rootNodeVisible\")}_getProgressiveLoadFactor(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor}get lod(){return this._featureLOD*this.baseLOD}get baseLOD(){const e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t}get lodDropFactor(){if(this.fixedFeatureTarget)return 1;const e=this.layerView.view.resourceController.memoryController;return(Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)}isGeometryVisible(e){return r(this._index)&&this._index.isGeometryVisible(e.index)}updateVisibility(e){r(this._index)&&this._index.invalidateNodeVisibilityCache(e)}updateBoundingVolume(e){r(this._index)&&this._index.invalidateBoundingVolumeCache(e)}invalidateGeometryVisibility(e){r(this._index)&&this._index.invalidateGeometryVisibility(e)}invalidateVisibilityObbs(){r(this._index)&&this._index.invalidateVisibilityObbs()}modificationsChanged(){if(r(this._index)){const e=r(this.layer.modifications)&&this.layer.modifications&&this.layer.modifications.length>0;this._index.imModificationsChanged(e)}this._invisibleDirty=!0}_shouldLoadNode(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e)||!this._isNodeInScaleBounds(e))&&(!!r(this._index)&&this._index.isGeometryVisible(e.index))}_shouldDropNode(e){if(d(this._viewportQueries))return!1;const t=this.lodDropFactor;if(t>=1||!this._lodHandling.hasNoVisibleChildren(e))return!1;return Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}_startNodeLoading(){this._restartNodeLoading=!1;const e=this._index;if(this._updatesDisabled||d(e)||d(this._viewportQueries))return;this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);const t={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:!this.isMeshPyramid};this._nodeLoader=new v(this.layer,this.dataStreamController,O,this._defaultGeometrySchema,this._requiredAttributes,t),e.requestUpdate(),this._lodHandling.startNodeLoading((e=>this._isNodeInScaleBounds(e)),((e,t)=>this._removeNodes(e,t,1)),e,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}isNodeLoading(){return null!=this._nodeLoader&&null!=this._index}cancelNodeLoading(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}_removeInvisibleNodes(e){const t=this._index;if(d(t)||d(this._viewportQueries))return!1;H.clear(),this.layerView.getLoadedNodeIndices(H);const i=0===this._viewportQueries.maxDistance,s=i?()=>!1:e=>this._shouldDropNode(e);return H.filterInPlace((e=>{const i=t.getNode(e);return d(i)||!t.isGeometryVisible(e)||s(i)||!this._isNodeInScaleBounds(i)})),H.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(H,e,0),!(i&&this.lodDropFactor<1)&&(0===H.length||(H.clear(),!1))}markNodeToRemove(e){H.push(e)}removeMarkedNodes(){this._removeNodes(H,U,0)}_removeNodes(e,t,i){const s=e.length;if(0!==s&&!t.done){for(r(this._index)&&this._index.requestUpdate();e.length>0&&!t.done;){const s=e.pop(),a=this._index;1===i&&this.layerView.nodeFadeoutEnabled&&r(a)&&a.isGeometryVisible(s)?this.layerView.fadeNode(s,1,!0):this.layerView.removeNode(s),t.madeProgress()}if(this._loadedNodeScales.size>0)for(let t=e.length;t<s;t++){const i=e.data[t];this._loadedNodeScales.delete(i)}}}_needsUpdate(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return!1;const t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}_updateLoadedNode(e){const t=h();this._updatingNodes.set(e.index,t);(R(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?Promise.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,t.signal)).then((i=>this.schedule((()=>this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:i},t.signal)),t.signal))).catch((i=>{if(!l(i))return this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},t.signal)})).catch((()=>{})).then((()=>{this._updatingNodes.delete(e.index),this._evaluateUpdating()})),this._evaluateUpdating()}_loadNode(e){if(this._loadingNodes.has(e.index))return void O.error(\"already loading node \"+e.index);const t=h();this._loadingNodes.set(e.index,t);const i=()=>{this._loadingNodes.get(e.index)===t&&this._loadingNodes.delete(e.index),this._evaluateUpdating()};this._evaluateUpdating(),this._loadAndAddNode(e,t.signal).then(i).catch((e=>{if(i(),!l(e))throw e}))}_loadAndAddNode(e,t){return 1===e.cacheState?this._loadUncached(e,t):this._loadCached(e,t).then((t=>{t||(e.cacheState=1,r(this._index)&&this._index.updates.add.push(e.index))})).catch((t=>{if(!l(t))throw e.cacheState=1,t}))}_enableFromGPUCache(e,t){if(this._disableMemCache||d(this._index))return!1;if(0===t&&!this._index.useNodeAsHole(e.index))return!0;const i=this._loadCachedGPUData(e);return!!i&&(this.layerView.addCachedGPUData(e,i,t),this._nodeAdded(),!0)}_loadCachedGPUData(e){const t=this.layerView.loadCachedGPUData(e);return r(t)&&r(t.attributeInfo)&&R(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}_nodeAdded(){r(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}_loadCached(e,t){if(this._enableFromGPUCache(e,1))return Promise.resolve(!0);const i=this.layerView;return!this.disableIDBCache&&i.loadCachedNodeData&&i.addCachedNodeData?this.schedule((()=>i.loadCachedNodeData(e,t,((t,i)=>this._nodeLoader.loadTextures(e,t,i)))),t).then((s=>{if(d(s))return!1;const a=this._requiredAttributes;return this.reschedule((()=>this._nodeLoader.loadAttributes(e,a,t)),t).then((r=>this.reschedule((()=>i.addCachedNodeData(e,s,{loadedAttributes:a,attributeData:r},t)),t))).then((()=>(this._nodeAdded(),!0)))})):Promise.resolve(!1)}_loadUncached(e,t){return this._downloadingCount++,this._nodeLoader.loadNodeData(e,t).catch((e=>{throw this._downloadingCount--,e})).then((i=>(this._downloadingCount--,this.schedule((()=>this.layerView.addNode(e,i,t)),t)))).then((()=>{this._nodeAdded(),e.cacheState=2})).catch((t=>{if(!l(t))throw O.error(\"#loadNodeData()\",this.layer,`Failed to load node '${e.id}'`,t),e.failed=!0,r(this._index)&&this._index.requestUpdate(),t}))}_updateIdleState(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&r(this._index)&&this._index.resetFailedNodes())}_getScale(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);this._tmpPoint.x=e.mbs[0],this._tmpPoint.y=e.mbs[1],this._tmpPoint.z=e.mbs[2];const t=this.layerView.view.basemapTerrain.getScale(this._tmpPoint);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,t),t}_isNodeInScaleBounds(e){if(!this.areScaleBoundsActive)return!0;const t=this._getScale(e),{minScale:i,maxScale:s}=F(this.layer);return P(t,i,s)}updateStats(e){e.index=r(this._index)?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),r(this._index)&&this._index.updateStats(e)}get test(){const e=this;return{index:this._index,set disableUpdates(t){e._updatesDisabled=t,t?e.cancelNodeLoading():e.requestUpdate()},set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceObb(t){r(e._index)&&(e._index.ignoreServiceObb=t)},shouldLoadNode:t=>e._shouldLoadNode(t)}}notifyLODUpdate(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),r(this._index)&&this._index.requestUpdate()}geometryFilterChanged(e){const t=this._index;r(t)&&t.layerFilterChanged(e),this.requestUpdate()}};e([c({readOnly:!0})],E.prototype,\"isMeshPyramid\",null),e([c({readOnly:!0})],E.prototype,\"isGraphics3D\",null),e([c({readOnly:!0})],E.prototype,\"indexStreamController\",null),e([c({readOnly:!0})],E.prototype,\"dataStreamController\",null),e([c({readOnly:!0})],E.prototype,\"crsVertex\",null),e([c({readOnly:!0})],E.prototype,\"crsIndex\",null),e([c()],E.prototype,\"screenSizeFactor\",void 0),e([c()],E.prototype,\"featureTarget\",void 0),e([c()],E.prototype,\"fixedFeatureTarget\",void 0),e([c()],E.prototype,\"layerView\",void 0),e([c()],E.prototype,\"layer\",void 0),e([c({})],E.prototype,\"updating\",void 0),e([c({})],E.prototype,\"updatingProgress\",void 0),e([c({readOnly:!0})],E.prototype,\"leavesReached\",void 0),e([c({constructOnly:!0})],E.prototype,\"scaleVisibilityEnabled\",void 0),e([c({readOnly:!0,dependsOn:[]})],E.prototype,\"rootNodeVisible\",null),E=e([_(\"esri.layers.graphics.controllers.I3SOnDemandController\")],E);const H=new o({deallocator:null});let k;function R(e,t){return r(e)&&e.length===t.length&&e.every((e=>z(t,e.name)>=0))}function z(e,t){const i=t.toLowerCase();for(let s=0;s<e.length;s++)if(e[s].name.toLowerCase()===i)return s;return-1}const K={factorIM:.2,factor3dObject:.05,distancePenalty:10},$=y();var J=E;export default J;\n"]},"metadata":{},"sourceType":"module"}