{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isNone as e, isSome as i } from \"../../../../core/maybe.js\";\nimport o from \"../../../../core/PooledArray.js\";\n\nclass s {\n  constructor(e) {\n    this.layerView = e, this._lodGlobalDirty = !1;\n  }\n\n  startNodeLoading(e, i, o, s) {\n    this._maxLodLevel = s.maxLodLevel, this._index = o, this._isNodeInScaleBounds = e, this._removeNodes = i;\n  }\n\n  shouldLoadNode(i) {\n    if (e(i)) return !1;\n\n    const o = this._index.nodeTraversalState(i);\n\n    return !!this.isChosenMaxLOD(o) || !!o.isChosen && this._childrenRequireLoading(i);\n  }\n\n  setLodGlobalDirty() {\n    this._lodGlobalDirty = !0;\n  }\n\n  get requiresLODGlobalHandling() {\n    return null != this._index && !0 === this._lodGlobalDirty;\n  }\n\n  lodGlobalHandling(e) {\n    if (!this.requiresLODGlobalHandling) return !1;\n    this._lodGlobalDirty = !1;\n    const i = this.layerView.view.resourceController.memoryController.usedMemory,\n          o = Math.max(0, Math.floor(10 * (i - 1)));\n    t.clear(), this._lodGlobalHandling(this._index.rootNode, o, !1);\n    const s = t.length;\n\n    this._removeNodes(t, e);\n\n    const d = t.length < s;\n    return 0 !== t.length && (this._lodGlobalDirty = !0), t.clear(), d;\n  }\n\n  _lodGlobalHandling(o, s, d) {\n    if (e(o)) return !1;\n    const l = o.index,\n          n = this._index,\n          r = this.layerView,\n          a = n.nodeTraversalState(o),\n          h = this.isChosenMaxLOD(a),\n          u = r.isNodeLoaded(l),\n          c = r.nodeCrossfadingEnabled;\n\n    if (c && u && h) {\n      const e = !d && this.hasNoVisibleChildren(o);\n      r.fadeNode(l, 0, !e);\n    }\n\n    const x = u && (!r.isNodeFullyFadedIn || r.isNodeFullyFadedIn(l));\n    if (u && (r.updateNodeState(l, h ? 1 : 0), h)) return x && this._removeChildrenRecursive(o), x;\n\n    const _ = o.childCount > 0;\n\n    let L = _;\n    if (_) for (let e = 0; e < o.childCount; e++) {\n      const t = n.getChildIndex(o, e),\n            l = n.getNode(t);\n\n      if (i(l)) {\n        !(!n.isGeometryVisible(t) || this._lodGlobalHandling(l, s, d || x)) && this._isNodeInScaleBounds(l) && (L = !1);\n      } else n.isNodeVisible(t) && (L = !1);\n    }\n    const N = u && !h && (L || t.length < s);\n    N && t.push(l), !c || N || !u || d || L || r.fadeNode(l, 0, !1);\n    const b = !o.resources.hasFeatureData;\n    return L || x && !N || b;\n  }\n\n  _removeChildrenRecursive(e) {\n    this._index.traverseChildren(e, e => ((this.layerView.isNodeLoaded(e.index) || this.layerView.isNodeReloading(e.index)) && t.push(e.index), !0));\n  }\n\n  hasNoVisibleChildren(e) {\n    let i = !0;\n    return this._index.traverseChildren(e, e => !(!i || !this._index.isNodeVisible(e.index)) && (!this.layerView.isNodeLoaded(e.index) || (i = !1, !1))), i;\n  }\n\n  _childrenRequireLoading(e) {\n    let i = !1,\n        o = !0;\n    return this._index.traverseChildren(e, e => {\n      if (!o || !this._index.isNodeVisible(e.index)) return !1;\n\n      const s = this._index.nodeTraversalState(e);\n\n      return this.isChosenMaxLOD(s) && this._index.isGeometryVisible(e.index) && (i = !0), !this.layerView.isNodeLoaded(e.index) || (o = !1, !1);\n    }), o && i;\n  }\n\n  isChosenMaxLOD(e) {\n    return e.isChosen && (!e.nodeHasLOD || e.lodLevel === this._maxLodLevel);\n  }\n\n}\n\nconst t = new o({\n  deallocator: null\n});\nexport default s;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/layers/i3s/I3SLodHandling.js"],"names":["isNone","e","isSome","i","o","s","constructor","layerView","_lodGlobalDirty","startNodeLoading","_maxLodLevel","maxLodLevel","_index","_isNodeInScaleBounds","_removeNodes","shouldLoadNode","nodeTraversalState","isChosenMaxLOD","isChosen","_childrenRequireLoading","setLodGlobalDirty","requiresLODGlobalHandling","lodGlobalHandling","view","resourceController","memoryController","usedMemory","Math","max","floor","t","clear","_lodGlobalHandling","rootNode","length","d","l","index","n","r","a","h","u","isNodeLoaded","c","nodeCrossfadingEnabled","hasNoVisibleChildren","fadeNode","x","isNodeFullyFadedIn","updateNodeState","_removeChildrenRecursive","_","childCount","L","getChildIndex","getNode","isGeometryVisible","isNodeVisible","N","push","b","resources","hasFeatureData","traverseChildren","isNodeReloading","nodeHasLOD","lodLevel","deallocator"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isNone as e,isSome as i}from\"../../../../core/maybe.js\";import o from\"../../../../core/PooledArray.js\";class s{constructor(e){this.layerView=e,this._lodGlobalDirty=!1}startNodeLoading(e,i,o,s){this._maxLodLevel=s.maxLodLevel,this._index=o,this._isNodeInScaleBounds=e,this._removeNodes=i}shouldLoadNode(i){if(e(i))return!1;const o=this._index.nodeTraversalState(i);return!!this.isChosenMaxLOD(o)||!!o.isChosen&&this._childrenRequireLoading(i)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const i=this.layerView.view.resourceController.memoryController.usedMemory,o=Math.max(0,Math.floor(10*(i-1)));t.clear(),this._lodGlobalHandling(this._index.rootNode,o,!1);const s=t.length;this._removeNodes(t,e);const d=t.length<s;return 0!==t.length&&(this._lodGlobalDirty=!0),t.clear(),d}_lodGlobalHandling(o,s,d){if(e(o))return!1;const l=o.index,n=this._index,r=this.layerView,a=n.nodeTraversalState(o),h=this.isChosenMaxLOD(a),u=r.isNodeLoaded(l),c=r.nodeCrossfadingEnabled;if(c&&u&&h){const e=!d&&this.hasNoVisibleChildren(o);r.fadeNode(l,0,!e)}const x=u&&(!r.isNodeFullyFadedIn||r.isNodeFullyFadedIn(l));if(u&&(r.updateNodeState(l,h?1:0),h))return x&&this._removeChildrenRecursive(o),x;const _=o.childCount>0;let L=_;if(_)for(let e=0;e<o.childCount;e++){const t=n.getChildIndex(o,e),l=n.getNode(t);if(i(l)){!(!n.isGeometryVisible(t)||this._lodGlobalHandling(l,s,d||x))&&this._isNodeInScaleBounds(l)&&(L=!1)}else n.isNodeVisible(t)&&(L=!1)}const N=u&&!h&&(L||t.length<s);N&&t.push(l),!c||N||!u||d||L||r.fadeNode(l,0,!1);const b=!o.resources.hasFeatureData;return L||x&&!N||b}_removeChildrenRecursive(e){this._index.traverseChildren(e,(e=>((this.layerView.isNodeLoaded(e.index)||this.layerView.isNodeReloading(e.index))&&t.push(e.index),!0)))}hasNoVisibleChildren(e){let i=!0;return this._index.traverseChildren(e,(e=>!(!i||!this._index.isNodeVisible(e.index))&&(!this.layerView.isNodeLoaded(e.index)||(i=!1,!1)))),i}_childrenRequireLoading(e){let i=!1,o=!0;return this._index.traverseChildren(e,(e=>{if(!o||!this._index.isNodeVisible(e.index))return!1;const s=this._index.nodeTraversalState(e);return this.isChosenMaxLOD(s)&&this._index.isGeometryVisible(e.index)&&(i=!0),!this.layerView.isNodeLoaded(e.index)||(o=!1,!1)})),o&&i}isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}const t=new o({deallocator:null});export default s;\n"]},"metadata":{},"sourceType":"module"}