{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from \"../../../core/Error.js\";\nimport e from \"../../../core/Logger.js\";\nimport { isSome as i } from \"../../../core/maybe.js\";\nimport { create as s } from \"../../../geometry/support/aaBoundingRect.js\";\nimport { getBoundsXY as r } from \"../../../geometry/support/boundsUtils.js\";\nimport { getSpatialQueryOperator as o } from \"./spatialQuerySupport.js\";\nimport { getTimeOperator as h } from \"./timeSupport.js\";\nimport { normalizeQueryLike as l } from \"./utils.js\";\nimport a from \"../../../rest/support/Query.js\";\nimport { featureAdapter as n } from \"../../../views/2d/layers/features/FeatureStore2D.js\";\nimport { createWhereClause as d } from \"../../../views/2d/layers/features/support/whereUtils.js\";\nconst m = e.getLogger(\"esri.views.2d.layers.features.controllers.FeatureFilter\"),\n      _ = 1,\n      u = 2;\n\nclass p {\n  constructor(t) {\n    this._geometryBounds = s(), this._idToVisibility = new Map(), this._serviceInfo = t;\n  }\n\n  get hash() {\n    return this._hash;\n  }\n\n  check(t) {\n    return this._applyFilter(t);\n  }\n\n  clear() {\n    const t = this._resetAllHiddenIds();\n\n    return this.update(), {\n      show: t,\n      hide: []\n    };\n  }\n\n  invalidate() {\n    this._idToVisibility.forEach((t, e) => {\n      this._idToVisibility.set(e, 0);\n    });\n  }\n\n  setKnownIds(t) {\n    for (const e of t) this._idToVisibility.set(e, _);\n  }\n\n  setTrue(t) {\n    const e = [],\n          i = [],\n          s = new Set(t);\n    return this._idToVisibility.forEach((t, r) => {\n      const o = !!(this._idToVisibility.get(r) & _),\n            h = s.has(r);\n      !o && h ? e.push(r) : o && !h && i.push(r), this._idToVisibility.set(r, h ? _ | u : 0);\n    }), {\n      show: e,\n      hide: i\n    };\n  }\n\n  createQuery() {\n    const {\n      geometry: t,\n      spatialRel: e,\n      where: i,\n      timeExtent: s,\n      objectIds: r\n    } = this;\n    return a.fromJSON({\n      geometry: t,\n      spatialRel: e,\n      where: i,\n      timeExtent: s,\n      objectIds: r\n    });\n  }\n\n  async update(t, e) {\n    this._hash = JSON.stringify(t);\n    const i = await l(t, null, e);\n    await Promise.all([this._setGeometryFilter(i), this._setIdFilter(i), this._setAttributeFilter(i), this._setTimeFilter(i)]);\n  }\n\n  async _setAttributeFilter(t) {\n    if (!t || !t.where) return this._clause = null, void (this.where = null);\n    this._clause = await d(t.where, this._serviceInfo.fieldsIndex), this.where = t.where;\n  }\n\n  _setIdFilter(t) {\n    this._idsToShow = t && t.objectIds && new Set(t.objectIds), this._idsToHide = t && t.hiddenIds && new Set(t.hiddenIds), this.objectIds = t && t.objectIds;\n  }\n\n  async _setGeometryFilter(t) {\n    if (!t || !t.geometry) return this._spatialQueryOperator = null, this.geometry = null, void (this.spatialRel = null);\n    const e = t.geometry,\n          i = t.spatialRel || \"esriSpatialRelIntersects\",\n          s = await o(i, e, this._serviceInfo.geometryType, this._serviceInfo.hasZ, this._serviceInfo.hasM);\n    r(this._geometryBounds, e), this._spatialQueryOperator = s, this.geometry = e, this.spatialRel = i;\n  }\n\n  _setTimeFilter(e) {\n    if (this.timeExtent = this._timeOperator = null, e && e.timeExtent) if (this._serviceInfo.timeInfo) this.timeExtent = e.timeExtent, this._timeOperator = h(this._serviceInfo.timeInfo, e.timeExtent, n);else {\n      const i = new t(\"feature-layer-view:time-filter-not-available\", \"Unable to apply time filter, as layer doesn't have time metadata.\", e.timeExtent);\n      m.error(i);\n    }\n  }\n\n  _applyFilter(t) {\n    return this._filterByGeometry(t) && this._filterById(t) && this._filterByTime(t) && this._filterByExpression(t);\n  }\n\n  _filterByExpression(t) {\n    return !this.where || this._clause(t);\n  }\n\n  _filterById(t) {\n    return (!this._idsToHide || !this._idsToHide.size || !this._idsToHide.has(t.getObjectId())) && (!this._idsToShow || !this._idsToShow.size || this._idsToShow.has(t.getObjectId()));\n  }\n\n  _filterByGeometry(t) {\n    if (!this.geometry) return !0;\n    const e = t.readHydratedGeometry();\n    return !!e && this._spatialQueryOperator(e);\n  }\n\n  _filterByTime(t) {\n    return !i(this._timeOperator) || this._timeOperator(t);\n  }\n\n  _resetAllHiddenIds() {\n    const t = [];\n    return this._idToVisibility.forEach((e, i) => {\n      e & _ || (this._idToVisibility.set(i, _), t.push(i));\n    }), t;\n  }\n\n}\n\nexport default p;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/layers/graphics/data/FeatureFilter.js"],"names":["t","e","isSome","i","create","s","getBoundsXY","r","getSpatialQueryOperator","o","getTimeOperator","h","normalizeQueryLike","l","a","featureAdapter","n","createWhereClause","d","m","getLogger","_","u","p","constructor","_geometryBounds","_idToVisibility","Map","_serviceInfo","hash","_hash","check","_applyFilter","clear","_resetAllHiddenIds","update","show","hide","invalidate","forEach","set","setKnownIds","setTrue","Set","get","has","push","createQuery","geometry","spatialRel","where","timeExtent","objectIds","fromJSON","JSON","stringify","Promise","all","_setGeometryFilter","_setIdFilter","_setAttributeFilter","_setTimeFilter","_clause","fieldsIndex","_idsToShow","_idsToHide","hiddenIds","_spatialQueryOperator","geometryType","hasZ","hasM","_timeOperator","timeInfo","error","_filterByGeometry","_filterById","_filterByTime","_filterByExpression","size","getObjectId","readHydratedGeometry"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from\"../../../core/Error.js\";import e from\"../../../core/Logger.js\";import{isSome as i}from\"../../../core/maybe.js\";import{create as s}from\"../../../geometry/support/aaBoundingRect.js\";import{getBoundsXY as r}from\"../../../geometry/support/boundsUtils.js\";import{getSpatialQueryOperator as o}from\"./spatialQuerySupport.js\";import{getTimeOperator as h}from\"./timeSupport.js\";import{normalizeQueryLike as l}from\"./utils.js\";import a from\"../../../rest/support/Query.js\";import{featureAdapter as n}from\"../../../views/2d/layers/features/FeatureStore2D.js\";import{createWhereClause as d}from\"../../../views/2d/layers/features/support/whereUtils.js\";const m=e.getLogger(\"esri.views.2d.layers.features.controllers.FeatureFilter\"),_=1,u=2;class p{constructor(t){this._geometryBounds=s(),this._idToVisibility=new Map,this._serviceInfo=t}get hash(){return this._hash}check(t){return this._applyFilter(t)}clear(){const t=this._resetAllHiddenIds();return this.update(),{show:t,hide:[]}}invalidate(){this._idToVisibility.forEach(((t,e)=>{this._idToVisibility.set(e,0)}))}setKnownIds(t){for(const e of t)this._idToVisibility.set(e,_)}setTrue(t){const e=[],i=[],s=new Set(t);return this._idToVisibility.forEach(((t,r)=>{const o=!!(this._idToVisibility.get(r)&_),h=s.has(r);!o&&h?e.push(r):o&&!h&&i.push(r),this._idToVisibility.set(r,h?_|u:0)})),{show:e,hide:i}}createQuery(){const{geometry:t,spatialRel:e,where:i,timeExtent:s,objectIds:r}=this;return a.fromJSON({geometry:t,spatialRel:e,where:i,timeExtent:s,objectIds:r})}async update(t,e){this._hash=JSON.stringify(t);const i=await l(t,null,e);await Promise.all([this._setGeometryFilter(i),this._setIdFilter(i),this._setAttributeFilter(i),this._setTimeFilter(i)])}async _setAttributeFilter(t){if(!t||!t.where)return this._clause=null,void(this.where=null);this._clause=await d(t.where,this._serviceInfo.fieldsIndex),this.where=t.where}_setIdFilter(t){this._idsToShow=t&&t.objectIds&&new Set(t.objectIds),this._idsToHide=t&&t.hiddenIds&&new Set(t.hiddenIds),this.objectIds=t&&t.objectIds}async _setGeometryFilter(t){if(!t||!t.geometry)return this._spatialQueryOperator=null,this.geometry=null,void(this.spatialRel=null);const e=t.geometry,i=t.spatialRel||\"esriSpatialRelIntersects\",s=await o(i,e,this._serviceInfo.geometryType,this._serviceInfo.hasZ,this._serviceInfo.hasM);r(this._geometryBounds,e),this._spatialQueryOperator=s,this.geometry=e,this.spatialRel=i}_setTimeFilter(e){if(this.timeExtent=this._timeOperator=null,e&&e.timeExtent)if(this._serviceInfo.timeInfo)this.timeExtent=e.timeExtent,this._timeOperator=h(this._serviceInfo.timeInfo,e.timeExtent,n);else{const i=new t(\"feature-layer-view:time-filter-not-available\",\"Unable to apply time filter, as layer doesn't have time metadata.\",e.timeExtent);m.error(i)}}_applyFilter(t){return this._filterByGeometry(t)&&this._filterById(t)&&this._filterByTime(t)&&this._filterByExpression(t)}_filterByExpression(t){return!this.where||this._clause(t)}_filterById(t){return(!this._idsToHide||!this._idsToHide.size||!this._idsToHide.has(t.getObjectId()))&&(!this._idsToShow||!this._idsToShow.size||this._idsToShow.has(t.getObjectId()))}_filterByGeometry(t){if(!this.geometry)return!0;const e=t.readHydratedGeometry();return!!e&&this._spatialQueryOperator(e)}_filterByTime(t){return!i(this._timeOperator)||this._timeOperator(t)}_resetAllHiddenIds(){const t=[];return this._idToVisibility.forEach(((e,i)=>{e&_||(this._idToVisibility.set(i,_),t.push(i))})),t}}export default p;\n"]},"metadata":{},"sourceType":"module"}