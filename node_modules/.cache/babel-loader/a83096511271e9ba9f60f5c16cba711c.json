{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../chunks/tslib.es6.js\";\nimport t from \"../../../request.js\";\nimport s from \"../../../core/Accessor.js\";\nimport { removeUnordered as r } from \"../../../core/arrayUtils.js\";\nimport o from \"../../../core/Error.js\";\nimport { clone as a } from \"../../../core/lang.js\";\nimport { removeMaybe as n, isSome as i } from \"../../../core/maybe.js\";\nimport { createResolver as u, onAbort as l, createAbortError as d, throwIfAborted as h, isAbortError as c, createAbortController as p } from \"../../../core/promiseUtils.js\";\nimport { property as m } from \"../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../core/accessorSupport/ensureType.js\";\nimport \"../../../core/has.js\";\nimport \"../../../core/Logger.js\";\nimport { subclass as g } from \"../../../core/accessorSupport/decorators/subclass.js\";\nimport { AsyncWorkerQueue as k } from \"./AsyncWorkerQueue.js\";\nimport f from \"./StreamDataLoaderTask.js\";\nimport { assert as b } from \"../webgl-engine/lib/Util.js\";\nimport { TaskPriority as y } from \"../../support/Scheduler.js\";\nlet L = class extends s {\n  constructor() {\n    super(...arguments), this.tasks = new Map(), this.onLoadQueue = new Array(), this.doneQueue = new Array(), this.updating = !1;\n  }\n\n  setup(e, t, s) {\n    this.loadQueue = new k((e, t) => this.startLoading(e, t), (e, t) => this.doneLoadingCallback(e, t), e, t), s && (this.taskHandle = s.registerTask(y.STREAM_DATA_LOADER, this));\n  }\n\n  destroy() {\n    this.taskHandle = n(this.taskHandle), this.tasks.forEach(e => {\n      e.abortController && e.abortController.abort();\n    }), this.loadQueue.destroy(), this.loadQueue = null, this.onLoadQueue = null, this.doneQueue = null, this.tasks = null;\n  }\n\n  hasDownloadSlots(e) {\n    return this.loadQueue.hasQuota(e);\n  }\n\n  request(e, t, s, r = {}) {\n    const o = u();\n    o.__signal = i(r) ? r.signal : null;\n    const a = this.createOrUpdateTask(e, t, s, r, o);\n    return l(r, () => this.cancelRequest(a, o)), o.promise;\n  }\n\n  createTask(e, t, s, r, o, a) {\n    const n = new f(e, t, s, r, o);\n    return this.updateTask(n, a), this.tasks.set(o, n), 1 === this.tasks.size && this._set(\"updating\", !0), this.loadQueue.push(n), n;\n  }\n\n  cancelRequest(e, t) {\n    r(e.resolvers, t), t.reject(d()), 0 === e.resolvers.length && (2 === e.status && (e.status = 4, this.loadQueue.cancel(e), e.abortController.abort(), e.request = null, e.abortController = null), e.status = 4, this.tasks.delete(e.key), 0 === this.tasks.size && this._set(\"updating\", !1));\n  }\n\n  taskKey(e, t, s) {\n    return `${e}:${t}:${s}`;\n  }\n\n  updateTask(e, t) {\n    e.resolvers.push(t);\n  }\n\n  createOrUpdateTask(e, t, s, r, o) {\n    const a = i(r) && r.uid || e,\n          n = this.taskKey(a, t, s),\n          u = this.tasks.get(n);\n    return u ? (this.updateTask(u, o), u) : this.createTask(e, r, t, s, n, o);\n  }\n\n  doneLoadingCallback(e, t) {\n    this.loadQueue && (b(2 === e.status), e.status = 3, this.taskHandle ? this.doneQueue.push({\n      task: e,\n      err: t\n    }) : this.doneLoading(e, t));\n  }\n\n  get running() {\n    return this.doneQueue.length > 0 || this.onLoadQueue.length > 0;\n  }\n\n  runTask(e) {\n    for (; !e.done && this.onLoadQueue.length > 0;) {\n      const t = this.onLoadQueue.shift();\n      h(t.task.abortController), t.task.abortController = null, t.callback(t.task), e.madeProgress();\n    }\n\n    for (; !e.done && this.doneQueue.length > 0;) {\n      const t = this.doneQueue.shift();\n      3 !== t.task.status && (t.err = t.err || d()), this.doneLoading(t.task, t.err), e.madeProgress();\n    }\n  }\n\n  doneLoading(e, t) {\n    let s = e.result instanceof HTMLImageElement ? 0 : e.resolvers.length;\n\n    for (const r of e.resolvers) if (t) c(t) ? r.reject(t) : r.reject(new o(\"stream-data-loader:request-error\", `Failed to request resource at '${e.url}'. ${t}`, {\n      url: e.url,\n      error: t\n    }));else {\n      --s;\n      const t = s <= 0 ? e.result : a(e.result);\n      r.resolve(t);\n    }\n\n    this.tasks.delete(e.key), 0 === this.tasks.size && this._set(\"updating\", !1);\n  }\n\n  startLoading(e, s) {\n    if (4 === e.status) return !1;\n    let r, o;\n\n    switch (e.startTime = performance.now(), e.status = 2, e.docType) {\n      case \"binary\":\n        o = \"array-buffer\", r = 0;\n        break;\n\n      case \"image\":\n        o = \"image\";\n        break;\n\n      case \"image+type\":\n        o = \"array-buffer\";\n        break;\n\n      default:\n        o = \"json\";\n    }\n\n    e.abortController = p();\n    const a = e.abortController.signal;\n    e.request = t(e.url, { ...e.options,\n      responseType: o,\n      timeout: r,\n      signal: a\n    });\n\n    let n = () => {};\n\n    const i = t => {\n      e.duration = performance.now() - e.startTime, e.size = t instanceof ArrayBuffer ? t.byteLength : e.size || 0, e.result = t, this.taskHandle ? this.onLoadQueue.push({\n        callback: s,\n        task: e\n      }) : (e.abortController = null, s(e));\n    },\n          u = t => {\n      2 === e.status && s(e, t), n();\n    };\n\n    return \"image+type\" !== e.docType ? (e.request.then(e => i(e.data), u), !0) : (e.request.then(s => {\n      const l = s.data,\n            d = j(l);\n      if (o = \"image\", e.size = l.byteLength, \"unknown\" === d) return e.request = t(e.url, {\n        responseType: o,\n        timeout: r,\n        signal: a\n      }), void e.request.then(e => i(e.data), u);\n      const h = new Blob([l], {\n        type: d\n      }),\n            c = window.URL.createObjectURL(h);\n      n = () => window.URL.revokeObjectURL(c), e.request = t(c, {\n        responseType: o,\n        timeout: r,\n        signal: a\n      }), e.request.then(e => i(new Q(e.data, d, n)), u);\n    }, u), !0);\n  }\n\n  get test() {\n    return {\n      loadQueue: this.loadQueue\n    };\n  }\n\n};\n\nfunction j(e) {\n  if (e.byteLength < 2) return \"unknown\";\n  const t = new Uint8Array(e, 0, e.byteLength);\n  return 137 === t[0] && 80 === t[1] ? \"image/png\" : 71 === t[0] && 73 === t[1] ? \"image/gif\" : 66 === t[0] && 77 === t[1] ? \"image/bmp\" : 255 === t[0] && 216 === t[1] ? \"image/jpeg\" : \"unknown\";\n}\n\ne([m({\n  readOnly: !0\n})], L.prototype, \"updating\", void 0), L = e([g(\"esri.views.3d.support.StreamDataLoader\")], L);\n\nclass Q {\n  constructor(e, t, s) {\n    this.image = e, this.type = t, this.release = s;\n  }\n\n  get isOpaque() {\n    return \"image/jpeg\" === this.type;\n  }\n\n}\n\nvar w = L;\nexport default w;\nexport { Q as ImageWithType, L as StreamDataLoader };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/support/StreamDataLoader.js"],"names":["_","e","t","s","removeUnordered","r","o","clone","a","removeMaybe","n","isSome","i","createResolver","u","onAbort","l","createAbortError","d","throwIfAborted","h","isAbortError","c","createAbortController","p","property","m","subclass","g","AsyncWorkerQueue","k","f","assert","b","TaskPriority","y","L","constructor","arguments","tasks","Map","onLoadQueue","Array","doneQueue","updating","setup","loadQueue","startLoading","doneLoadingCallback","taskHandle","registerTask","STREAM_DATA_LOADER","destroy","forEach","abortController","abort","hasDownloadSlots","hasQuota","request","__signal","signal","createOrUpdateTask","cancelRequest","promise","createTask","updateTask","set","size","_set","push","resolvers","reject","length","status","cancel","delete","key","taskKey","uid","get","task","err","doneLoading","running","runTask","done","shift","callback","madeProgress","result","HTMLImageElement","url","error","resolve","startTime","performance","now","docType","options","responseType","timeout","duration","ArrayBuffer","byteLength","then","data","j","Blob","type","window","URL","createObjectURL","revokeObjectURL","Q","test","Uint8Array","readOnly","prototype","image","release","isOpaque","w","ImageWithType","StreamDataLoader"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import t from\"../../../request.js\";import s from\"../../../core/Accessor.js\";import{removeUnordered as r}from\"../../../core/arrayUtils.js\";import o from\"../../../core/Error.js\";import{clone as a}from\"../../../core/lang.js\";import{removeMaybe as n,isSome as i}from\"../../../core/maybe.js\";import{createResolver as u,onAbort as l,createAbortError as d,throwIfAborted as h,isAbortError as c,createAbortController as p}from\"../../../core/promiseUtils.js\";import{property as m}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/accessorSupport/ensureType.js\";import\"../../../core/has.js\";import\"../../../core/Logger.js\";import{subclass as g}from\"../../../core/accessorSupport/decorators/subclass.js\";import{AsyncWorkerQueue as k}from\"./AsyncWorkerQueue.js\";import f from\"./StreamDataLoaderTask.js\";import{assert as b}from\"../webgl-engine/lib/Util.js\";import{TaskPriority as y}from\"../../support/Scheduler.js\";let L=class extends s{constructor(){super(...arguments),this.tasks=new Map,this.onLoadQueue=new Array,this.doneQueue=new Array,this.updating=!1}setup(e,t,s){this.loadQueue=new k(((e,t)=>this.startLoading(e,t)),((e,t)=>this.doneLoadingCallback(e,t)),e,t),s&&(this.taskHandle=s.registerTask(y.STREAM_DATA_LOADER,this))}destroy(){this.taskHandle=n(this.taskHandle),this.tasks.forEach((e=>{e.abortController&&e.abortController.abort()})),this.loadQueue.destroy(),this.loadQueue=null,this.onLoadQueue=null,this.doneQueue=null,this.tasks=null}hasDownloadSlots(e){return this.loadQueue.hasQuota(e)}request(e,t,s,r={}){const o=u();o.__signal=i(r)?r.signal:null;const a=this.createOrUpdateTask(e,t,s,r,o);return l(r,(()=>this.cancelRequest(a,o))),o.promise}createTask(e,t,s,r,o,a){const n=new f(e,t,s,r,o);return this.updateTask(n,a),this.tasks.set(o,n),1===this.tasks.size&&this._set(\"updating\",!0),this.loadQueue.push(n),n}cancelRequest(e,t){r(e.resolvers,t),t.reject(d()),0===e.resolvers.length&&(2===e.status&&(e.status=4,this.loadQueue.cancel(e),e.abortController.abort(),e.request=null,e.abortController=null),e.status=4,this.tasks.delete(e.key),0===this.tasks.size&&this._set(\"updating\",!1))}taskKey(e,t,s){return`${e}:${t}:${s}`}updateTask(e,t){e.resolvers.push(t)}createOrUpdateTask(e,t,s,r,o){const a=i(r)&&r.uid||e,n=this.taskKey(a,t,s),u=this.tasks.get(n);return u?(this.updateTask(u,o),u):this.createTask(e,r,t,s,n,o)}doneLoadingCallback(e,t){this.loadQueue&&(b(2===e.status),e.status=3,this.taskHandle?this.doneQueue.push({task:e,err:t}):this.doneLoading(e,t))}get running(){return this.doneQueue.length>0||this.onLoadQueue.length>0}runTask(e){for(;!e.done&&this.onLoadQueue.length>0;){const t=this.onLoadQueue.shift();h(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this.doneQueue.length>0;){const t=this.doneQueue.shift();3!==t.task.status&&(t.err=t.err||d()),this.doneLoading(t.task,t.err),e.madeProgress()}}doneLoading(e,t){let s=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)c(t)?r.reject(t):r.reject(new o(\"stream-data-loader:request-error\",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--s;const t=s<=0?e.result:a(e.result);r.resolve(t)}this.tasks.delete(e.key),0===this.tasks.size&&this._set(\"updating\",!1)}startLoading(e,s){if(4===e.status)return!1;let r,o;switch(e.startTime=performance.now(),e.status=2,e.docType){case\"binary\":o=\"array-buffer\",r=0;break;case\"image\":o=\"image\";break;case\"image+type\":o=\"array-buffer\";break;default:o=\"json\"}e.abortController=p();const a=e.abortController.signal;e.request=t(e.url,{...e.options,responseType:o,timeout:r,signal:a});let n=()=>{};const i=t=>{e.duration=performance.now()-e.startTime,e.size=t instanceof ArrayBuffer?t.byteLength:e.size||0,e.result=t,this.taskHandle?this.onLoadQueue.push({callback:s,task:e}):(e.abortController=null,s(e))},u=t=>{2===e.status&&s(e,t),n()};return\"image+type\"!==e.docType?(e.request.then((e=>i(e.data)),u),!0):(e.request.then((s=>{const l=s.data,d=j(l);if(o=\"image\",e.size=l.byteLength,\"unknown\"===d)return e.request=t(e.url,{responseType:o,timeout:r,signal:a}),void e.request.then((e=>i(e.data)),u);const h=new Blob([l],{type:d}),c=window.URL.createObjectURL(h);n=()=>window.URL.revokeObjectURL(c),e.request=t(c,{responseType:o,timeout:r,signal:a}),e.request.then((e=>i(new Q(e.data,d,n))),u)}),u),!0)}get test(){return{loadQueue:this.loadQueue}}};function j(e){if(e.byteLength<2)return\"unknown\";const t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?\"image/png\":71===t[0]&&73===t[1]?\"image/gif\":66===t[0]&&77===t[1]?\"image/bmp\":255===t[0]&&216===t[1]?\"image/jpeg\":\"unknown\"}e([m({readOnly:!0})],L.prototype,\"updating\",void 0),L=e([g(\"esri.views.3d.support.StreamDataLoader\")],L);class Q{constructor(e,t,s){this.image=e,this.type=t,this.release=s}get isOpaque(){return\"image/jpeg\"===this.type}}var w=L;export default w;export{Q as ImageWithType,L as StreamDataLoader};\n"]},"metadata":{},"sourceType":"module"}