{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../chunks/tslib.es6.js\";\nimport t from \"../../../core/Accessor.js\";\nimport r from \"../../../core/Handles.js\";\nimport { destroyMaybe as s, removeMaybe as o } from \"../../../core/maybe.js\";\nimport { addFrameTask as a } from \"../../../core/scheduling.js\";\nimport { SecondsFromMilliseconds as i } from \"../../../core/time.js\";\nimport { property as h } from \"../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../core/has.js\";\nimport \"../../../core/accessorSupport/ensureType.js\";\nimport \"../../../core/Logger.js\";\nimport { subclass as n } from \"../../../core/accessorSupport/decorators/subclass.js\";\nimport { maxDownloadSlots as l, downloadSlotsPerClient as m } from \"./index.js\";\nimport { newMemoryController as u } from \"./MemoryController.js\";\nimport d from \"./StreamDataLoader.js\";\nimport { ImmediateTask as c, newScheduler as p, TaskPriority as _ } from \"../../support/Scheduler.js\";\nlet y = class extends t {\n  constructor() {\n    super(...arguments), this.updating = !1;\n  }\n\n};\n\nfunction g(e, t = () => performance.now()) {\n  return new C.ResourceController({\n    view: e,\n    now: t\n  });\n}\n\nvar C;\ne([h({\n  readOnly: !0\n})], y.prototype, \"updating\", void 0), y = e([n(\"esri.views.3d.support.ResourceController\")], y), function (t) {\n  let g = class extends y {\n    constructor() {\n      super(...arguments), this._scheduler = null, this._memoryController = null, this._streamDataLoader = null, this._cameraChangeTime = 0, this._handles = new r(), this._frameTask = null, this._scheduleTask = c;\n    }\n\n    initialize() {\n      this._cameraChangeTime = this.now(), this._scheduler = p(this.now), this._memoryController = u(this.view), this._streamDataLoader = new d(), this._streamDataLoader.setup(l, m, this._scheduler), this._handles.add([this.view.watch(\"state.camera\", (e, t) => this._cameraChangedHandler(e, t), !0), this.view.watch(\"stationary\", () => this._stationaryChangedHandler()), this._memoryController.events.on(\"updating-changed\", () => this.notifyChange(\"updating\"))]), this._frameTask = a({\n        update: e => this.frame(e)\n      }), this._scheduleTask = this._scheduler.registerTask(_.RESOURCE_CONTROLLER);\n    }\n\n    destroy() {\n      this._handles = s(this._handles), this._scheduleTask.remove(), this._frameTask = o(this._frameTask), this._streamDataLoader = s(this._streamDataLoader), this._memoryController = s(this._memoryController), this._scheduler = s(this._scheduler);\n    }\n\n    get updating() {\n      var e, t;\n      return !!(null != (e = this._memoryController) && e.updating || null != (t = this._streamDataLoader) && t.updating);\n    }\n\n    get scheduler() {\n      return this._scheduler;\n    }\n\n    get memoryController() {\n      return this._memoryController;\n    }\n\n    schedule(e, t, r) {\n      return this._scheduleTask.schedule(e, t, r);\n    }\n\n    createStreamDataRequester(e) {\n      const t = this._streamDataLoader;\n      return {\n        request: (r, s, o) => t.request(r, s, e, o),\n\n        get busy() {\n          return !t.hasDownloadSlots(e);\n        }\n\n      };\n    }\n\n    frame(e) {\n      this.view.suspended || this.view.stateManager && (this.view.stateManager.step(i(e.deltaTime)), !this._scheduler) || (this._scheduler.state = this.state, this._scheduler.updateBudget(e) ? (this._memoryController.update(), this._scheduler.frame()) : this._memoryController.updating && this._memoryController.update());\n    }\n\n    _cameraChangedHandler(e, t) {\n      e && t && e.almostEquals(t) || (this._cameraChangeTime = this._scheduler.now, this._scheduler.state = this.state);\n    }\n\n    _stationaryChangedHandler() {\n      this.memoryController.resetStableQuality();\n    }\n\n    get state() {\n      const e = this.view;\n      return e.animation ? 0 : e.interacting || this._scheduler.now - this._cameraChangeTime <= C ? 1 : 2;\n    }\n\n    get test() {\n      return {\n        getQueueStats: e => this._streamDataLoader.test.loadQueue.getStatsForType(e),\n        state: this.state\n      };\n    }\n\n  };\n  e([h({\n    constructOnly: !0\n  })], g.prototype, \"view\", void 0), e([h({\n    constructOnly: !0\n  })], g.prototype, \"now\", void 0), e([h()], g.prototype, \"_scheduler\", void 0), e([h()], g.prototype, \"_memoryController\", void 0), e([h()], g.prototype, \"_streamDataLoader\", void 0), e([h({\n    readOnly: !0\n  })], g.prototype, \"updating\", null), g = e([n(\"esri.views.3d.support.ResourceController\")], g), t.ResourceController = g;\n  const C = 300;\n}(C || (C = {}));\nexport { y as ResourceControllerMain, g as newResourceController };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/support/ResourceController.js"],"names":["_","e","t","r","destroyMaybe","s","removeMaybe","o","addFrameTask","a","SecondsFromMilliseconds","i","property","h","subclass","n","maxDownloadSlots","l","downloadSlotsPerClient","m","newMemoryController","u","d","ImmediateTask","c","newScheduler","p","TaskPriority","y","constructor","arguments","updating","g","performance","now","C","ResourceController","view","readOnly","prototype","_scheduler","_memoryController","_streamDataLoader","_cameraChangeTime","_handles","_frameTask","_scheduleTask","initialize","setup","add","watch","_cameraChangedHandler","_stationaryChangedHandler","events","on","notifyChange","update","frame","registerTask","RESOURCE_CONTROLLER","destroy","remove","scheduler","memoryController","schedule","createStreamDataRequester","request","busy","hasDownloadSlots","suspended","stateManager","step","deltaTime","state","updateBudget","almostEquals","resetStableQuality","animation","interacting","test","getQueueStats","loadQueue","getStatsForType","constructOnly","ResourceControllerMain","newResourceController"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import t from\"../../../core/Accessor.js\";import r from\"../../../core/Handles.js\";import{destroyMaybe as s,removeMaybe as o}from\"../../../core/maybe.js\";import{addFrameTask as a}from\"../../../core/scheduling.js\";import{SecondsFromMilliseconds as i}from\"../../../core/time.js\";import{property as h}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import\"../../../core/Logger.js\";import{subclass as n}from\"../../../core/accessorSupport/decorators/subclass.js\";import{maxDownloadSlots as l,downloadSlotsPerClient as m}from\"./index.js\";import{newMemoryController as u}from\"./MemoryController.js\";import d from\"./StreamDataLoader.js\";import{ImmediateTask as c,newScheduler as p,TaskPriority as _}from\"../../support/Scheduler.js\";let y=class extends t{constructor(){super(...arguments),this.updating=!1}};function g(e,t=(()=>performance.now())){return new C.ResourceController({view:e,now:t})}var C;e([h({readOnly:!0})],y.prototype,\"updating\",void 0),y=e([n(\"esri.views.3d.support.ResourceController\")],y),function(t){let g=class extends y{constructor(){super(...arguments),this._scheduler=null,this._memoryController=null,this._streamDataLoader=null,this._cameraChangeTime=0,this._handles=new r,this._frameTask=null,this._scheduleTask=c}initialize(){this._cameraChangeTime=this.now(),this._scheduler=p(this.now),this._memoryController=u(this.view),this._streamDataLoader=new d,this._streamDataLoader.setup(l,m,this._scheduler),this._handles.add([this.view.watch(\"state.camera\",((e,t)=>this._cameraChangedHandler(e,t)),!0),this.view.watch(\"stationary\",(()=>this._stationaryChangedHandler())),this._memoryController.events.on(\"updating-changed\",(()=>this.notifyChange(\"updating\")))]),this._frameTask=a({update:e=>this.frame(e)}),this._scheduleTask=this._scheduler.registerTask(_.RESOURCE_CONTROLLER)}destroy(){this._handles=s(this._handles),this._scheduleTask.remove(),this._frameTask=o(this._frameTask),this._streamDataLoader=s(this._streamDataLoader),this._memoryController=s(this._memoryController),this._scheduler=s(this._scheduler)}get updating(){var e,t;return!!(null!=(e=this._memoryController)&&e.updating||null!=(t=this._streamDataLoader)&&t.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}schedule(e,t,r){return this._scheduleTask.schedule(e,t,r)}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(r,s,o)=>t.request(r,s,e,o),get busy(){return!t.hasDownloadSlots(e)}}}frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(i(e.deltaTime)),!this._scheduler)||(this._scheduler.state=this.state,this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=this._scheduler.now,this._scheduler.state=this.state)}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get state(){const e=this.view;return e.animation?0:e.interacting||this._scheduler.now-this._cameraChangeTime<=C?1:2}get test(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e),state:this.state}}};e([h({constructOnly:!0})],g.prototype,\"view\",void 0),e([h({constructOnly:!0})],g.prototype,\"now\",void 0),e([h()],g.prototype,\"_scheduler\",void 0),e([h()],g.prototype,\"_memoryController\",void 0),e([h()],g.prototype,\"_streamDataLoader\",void 0),e([h({readOnly:!0})],g.prototype,\"updating\",null),g=e([n(\"esri.views.3d.support.ResourceController\")],g),t.ResourceController=g;const C=300}(C||(C={}));export{y as ResourceControllerMain,g as newResourceController};\n"]},"metadata":{},"sourceType":"module"}