{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isNone as e, unwrap as i, disposeMaybe as t, isSome as s } from \"../../../../core/maybe.js\";\nimport r from \"../../../../core/PooledArray.js\";\nimport { i as n, t as o, m as a } from \"../../../../chunks/mat4.js\";\nimport { c as h } from \"../../../../chunks/mat4f32.js\";\nimport { I as l } from \"../../../../chunks/mat4f64.js\";\nimport { f as c, l as d, a as u, o as m, d as p, p as g, s as f } from \"../../../../chunks/vec3.js\";\nimport { c as _ } from \"../../../../chunks/vec3f32.js\";\nimport { c as x } from \"../../../../chunks/vec3f64.js\";\nimport { s as S } from \"../../../../chunks/vec4.js\";\nimport { create as z, POSITIVE_INFINITY as P, offset as b, contains as w, containsPoint as R, equals as y, set as q } from \"../../../../geometry/support/aaBoundingBox.js\";\nimport { create as v } from \"../../../../geometry/support/plane.js\";\nimport { fromPoints as M } from \"../../../../geometry/support/ray.js\";\nimport { PointHighlights as j } from \"./PointHighlights.js\";\nimport { minimumDistancePlane as F, maximumDistancePlane as H, intersectLine as V, toAaBoundingBox as U } from \"../../support/orientedBoundingBox.js\";\nimport { bindSliceUniforms as A } from \"../../webgl-engine/core/shaderLibrary/Slice.glsl.js\";\nimport { bindOutputHighlight as C } from \"../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl.js\";\nimport { Default3D as B } from \"../../webgl-engine/lib/DefaultVertexAttributeLocations.js\";\nimport { IntersectorResult as E } from \"../../webgl-engine/lib/intersectorUtils.js\";\nimport { PointRendererTechniqueConfiguration as L, PointRendererTechnique as I } from \"../../webgl-engine/shaders/PointRendererTechnique.js\";\nimport N from \"../../../webgl/BufferObject.js\";\nimport O from \"../../../webgl/VertexArrayObject.js\";\nconst k = {\n  positions: [{\n    name: \"position\",\n    count: 3,\n    type: 5126,\n    offset: 0,\n    stride: 12,\n    normalized: !1\n  }],\n  colors: [{\n    name: \"color\",\n    count: 3,\n    type: 5121,\n    offset: 0,\n    stride: 3,\n    normalized: !0\n  }]\n};\n\nclass T {\n  constructor(e) {\n    this._params = e, this.type = \"Point\", this.isGround = !1, this._bindParameters = {\n      inverseViewport: [0, 0],\n      highlightDepthTexture: null\n    }, this._highlights = new j({\n      forEachNode: e => this.forEachNode(e),\n      addHighlight: (e, i, t) => this.addHighlight(e, i, t),\n      removeHighlight: (e, i) => this.removeHighlight(e, i)\n    }), this.canRender = !0, this.layerUid = \"\", this._useFixedSizes = !1, this._scaleFactor = 1, this._minSizePx = 0, this._useRealWorldSymbolSizes = !1, this._size = 0, this._sizePx = 0, this._slicePlaneEnabled = !1, this._clipBox = z(P), this._techniqueConfig = new L(), this.tempMatrix4 = h(), this.tempVec3 = _(), this.nodes = new r();\n  }\n\n  get needsHighlight() {\n    return this._highlights.hasHighlights;\n  }\n\n  initializeRenderContext(e) {\n    this._context = e, this._techniqueRep = this._context.shaderTechniqueRep, e.requestRender();\n  }\n\n  uninitializeRenderContext() {}\n\n  intersect(e, i, t, s) {\n    const r = x(),\n          n = x(),\n          o = x(),\n          a = x(),\n          h = v(),\n          f = e.camera.perScreenPixelRatio / 2,\n          _ = e.camera.near,\n          P = this._getSizeParams();\n\n    c(n, s, t);\n    const y = 1 / d(n);\n    u(n, n, y), m(o, n), S(h, n[0], n[1], n[2], -p(n, t));\n\n    class q {\n      constructor() {\n        this.node = null, this.pointId = null, this.point = null, this.dist = null, this.normal = null, this.layerUid = \"\";\n      }\n\n    }\n\n    const j = new q(),\n          A = new q(),\n          C = [],\n          B = z(),\n          L = z(this._clipBox);\n    b(L, -t[0], -t[1], -t[2], L), this.nodes.forAll(l => {\n      const d = l.splatSize * this._scaleFactor;\n      let u = F(l.obb, h),\n          m = H(l.obb, h);\n      u -= G(d, u + _, P, f, l.isLeaf), m -= G(d, m + _, P, f, l.isLeaf);\n      const x = m < 0,\n            S = null != j.dist && null != A.dist && j.dist < u * y && A.dist > m * y;\n      if (x || S) return;\n      const z = D(d, m + _, P, f, l.isLeaf);\n      if (!V(l.obb, t, n, z)) return;\n      const v = z * z;\n      U(l.obb, B), b(B, -t[0], -t[1], -t[2], B);\n      const M = !w(L, B);\n      c(a, l.origin, t);\n      const E = l.coordinates.length / 3;\n\n      for (let h = 0; h < E; h++) {\n        if (r[0] = a[0] + l.coordinates[3 * h], r[1] = a[1] + l.coordinates[3 * h + 1], r[2] = a[2] + l.coordinates[3 * h + 2], M && !R(L, r)) continue;\n        const c = p(r, n),\n              u = g(r) - c * c;\n        if (u > v) continue;\n        let m = c + _;\n        const x = G(d, m, P, f, l.isLeaf);\n        if (c - x < 0) continue;\n        m -= x;\n        const S = D(d, m, P, f, l.isLeaf);\n        if (u > S * S) continue;\n\n        const z = (c - x) * y,\n              b = e => {\n          e.point = $(l, h, e.point), e.dist = z, e.normal = o, e.node = l, e.pointId = h, e.layerUid = this.layerUid;\n        };\n\n        if ((null == j.dist || z < j.dist) && (null == i || i(t, s, z)) && b(j), 0 !== e.options.store && (null == A.dist || z > A.dist) && (null == i || i(t, s, z)) && b(A), 2 === e.options.store && (null == i || i(t, s, z))) {\n          const e = new q();\n          b(e), C.push(e);\n        }\n      }\n    });\n\n    const I = e => {\n      const {\n        layerUid: i,\n        node: t,\n        pointId: s\n      } = e;\n      return {\n        type: \"external\",\n        point: e.point,\n        metadata: {\n          layerUid: i,\n          createGraphic: () => this._params.createGraphic(t, s, e.point)\n        }\n      };\n    },\n          N = (e, i) => {\n      const t = I(i),\n            s = `${i.layerUid}/${i.node.id}/${i.pointId}`;\n      e.set(t, s, i.dist, i.normal, l, void 0), e.intersector = \"PointRenderer\";\n    };\n\n    if (null != j.dist) {\n      const i = e.results.min;\n      (null == i.dist || j.dist < i.dist) && N(i, j);\n    }\n\n    if (null != A.dist && 0 !== e.options.store) {\n      const i = e.results.max;\n      (null == i.dist || A.dist > i.dist) && N(i, A);\n    }\n\n    if (2 === e.options.store) {\n      const i = M(t, s);\n\n      for (const t of C) {\n        const s = new E(i);\n        N(s, t), e.results.all.push(s);\n      }\n    }\n  }\n\n  render(e) {\n    if (0 !== e.pass && 2 !== e.pass && 5 !== e.pass) return !1;\n    const i = 2 === e.pass,\n          t = e.rctx;\n    this.nodes.forAll(i => {\n      null == i.vao && this._initNode(e, i);\n    });\n\n    const s = this._getSizeParams(),\n          r = this.selectTechnique(e, s),\n          h = r.program;\n\n    if (null == h || 0 === this.nodes.length) return !0;\n    const l = this._clipBox,\n          c = !y(l, P, (e, i) => e === i);\n    c || (f(this.tempVec3, -1 / 0, -1 / 0, -1 / 0), h.setUniform3fv(\"uClipMin\", this.tempVec3), f(this.tempVec3, 1 / 0, 1 / 0, 1 / 0), h.setUniform3fv(\"uClipMax\", this.tempVec3)), t.useProgram(h), r.bindPipelineState(t), h.setUniformMatrix4fv(\"uProjectionMatrix\", e.camera.projectionMatrix), i && h.setUniform2f(\"nearFar\", e.camera.near, e.camera.far), e.isHighlightPass && (this._bindParameters.inverseViewport[0] = 1 / e.camera.fullViewport[2], this._bindParameters.inverseViewport[1] = 1 / e.camera.fullViewport[3], this._bindParameters.highlightDepthTexture = e.highlightDepthTexture, C(h, this._bindParameters));\n    const d = e.camera.pixelRatio;\n    s.drawFixedSize && h.setUniform2f(\"uPointScale\", s.fixedSize * d, e.camera.fullHeight);\n    const u = this._slicePlaneEnabled ? e.sliceHelper && e.sliceHelper.plane : null;\n    return this.nodes.forAll(i => {\n      if (0 === i.coordinates.length || e.isHighlightPass && !i.highlights) return;\n\n      if (h.setUniform2f(\"uScreenMinMaxSize\", s.screenMinSize * d, W(i.isLeaf) * d), !s.drawFixedSize) {\n        const t = i.splatSize * this._scaleFactor;\n        h.setUniform2f(\"uPointScale\", t * d, e.camera.fullHeight / d);\n      }\n\n      const m = i.origin;\n      c && (f(this.tempVec3, l[0] - m[0], l[1] - m[1], l[2] - m[2]), h.setUniform3fv(\"uClipMin\", this.tempVec3), f(this.tempVec3, l[3] - m[0], l[4] - m[1], l[5] - m[2]), h.setUniform3fv(\"uClipMax\", this.tempVec3)), n(this.tempMatrix4), o(this.tempMatrix4, this.tempMatrix4, m), a(this.tempMatrix4, e.camera.viewMatrix, this.tempMatrix4), h.setUniformMatrix4fv(\"uModelViewMatrix\", this.tempMatrix4), A(h, r.configuration, u, m), t.bindVAO(i.vao), e.isHighlightPass ? this._renderHighlightFragments(t, i) : t.drawArrays(0, 0, i.coordinates.length / 3);\n    }), !0;\n  }\n\n  _renderHighlightFragments(t, s) {\n    const r = s.highlights;\n    if (e(r)) return;\n    let n = i(r[0].component),\n        o = n + 1;\n\n    for (let e = 1; e < r.length; e++) {\n      const s = i(r[e].component);\n\n      if (s !== o) {\n        const e = o - n;\n        e > 0 && t.drawArrays(0, n, e), n = s;\n      }\n\n      o = s + 1;\n    }\n\n    const a = o - n;\n    a > 0 && t.drawArrays(0, n, a);\n  }\n\n  set useFixedSizes(e) {\n    this._useFixedSizes !== e && (this._useFixedSizes = e, this._requestRender());\n  }\n\n  get useFixedSizes() {\n    return this._useFixedSizes;\n  }\n\n  set scaleFactor(e) {\n    this._scaleFactor !== e && (this._scaleFactor = e, this._requestRender());\n  }\n\n  get scaleFactor() {\n    return this._scaleFactor;\n  }\n\n  set minSizePx(e) {\n    this._minSizePx !== e && (this._minSizePx = e, this._requestRender());\n  }\n\n  get minSizePx() {\n    return this._minSizePx;\n  }\n\n  set useRealWorldSymbolSizes(e) {\n    this._useRealWorldSymbolSizes !== e && (this._useRealWorldSymbolSizes = e, this._requestRender());\n  }\n\n  get useRealWorldSymbolSizes() {\n    return this._useRealWorldSymbolSizes;\n  }\n\n  set size(e) {\n    this._size !== e && (this._size = e, this._requestRender());\n  }\n\n  get size() {\n    return this._size;\n  }\n\n  set sizePx(e) {\n    this._sizePx !== e && (this._sizePx = e, this._requestRender());\n  }\n\n  get sizePx() {\n    return this._sizePx;\n  }\n\n  set clippingBox(e) {\n    q(this._clipBox, e || P);\n  }\n\n  get slicePlane() {\n    return this._slicePlaneEnabled;\n  }\n\n  set slicePlane(e) {\n    this._slicePlaneEnabled !== e && (this._slicePlaneEnabled = e, this._requestRender());\n  }\n\n  get intersectionHandlerId() {\n    return this.layerUid;\n  }\n\n  addNode(e) {\n    this.nodes.push(e), this._highlights.nodeAdded(e), this._requestRender();\n  }\n\n  removeNode(e) {\n    let i = null;\n    return this.nodes.filterInPlace(s => s.id !== e || (i = s, s.vao = t(s.vao), this._highlights.nodeRemoved(s), !1)), this._requestRender(), i;\n  }\n\n  forEachNode(e) {\n    this.nodes.forAll(e);\n  }\n\n  removeAll() {\n    this.nodes.forAll(e => e.vao = t(e.vao)), this._highlights.removeAll(), this.nodes.clear(), this._requestRender();\n  }\n\n  highlight(e) {\n    return this._highlights.add(e);\n  }\n\n  addHighlight(e, i, t) {\n    e.highlights = K(e.highlights, i, t), this._requestRender();\n  }\n\n  removeHighlight(e, i) {\n    e.highlights = Q(e.highlights, i), this._requestRender();\n  }\n\n  _initNode(e, i) {\n    const t = e.rctx;\n    i.vao = new O(t, B, k, {\n      positions: N.createVertex(t, 35044, i.coordinates),\n      colors: N.createVertex(t, 35044, i.rgb)\n    });\n  }\n\n  _requestRender() {\n    this._context && this._context.requestRender();\n  }\n\n  _getSizeParams() {\n    const e = this._useFixedSizes,\n          i = e && !this._useRealWorldSymbolSizes;\n    return {\n      drawScreenSpace: i,\n      drawFixedSize: e,\n      fixedSize: i ? this._sizePx : this._size,\n      screenMinSize: e ? 0 : this._minSizePx\n    };\n  }\n\n  selectTechnique(e, i) {\n    return this._techniqueConfig.drawScreenSize = i.drawScreenSpace, this._techniqueConfig.slicePlaneEnabled = this._slicePlaneEnabled, this._techniqueConfig.sceneHasOcludees = e.hasOccludees, this._techniqueConfig.output = 2 === e.pass ? 1 : 5 === e.pass ? 4 : 0, this._techniqueRep.releaseAndAcquire(I, this._techniqueConfig, this._technique);\n  }\n\n}\n\nfunction W(e) {\n  return e ? 256 : 64;\n}\n\nfunction D(e, i, t, s, r) {\n  if (t.drawScreenSpace) return t.fixedSize * i * s;\n  const n = W(r) * i * s;\n  return t.drawFixedSize ? Math.min(t.fixedSize / 2, n) : t.screenMinSize > 0 ? Math.min(Math.max(t.screenMinSize * i * s, e / 2), n) : Math.min(e / 2, n);\n}\n\nfunction G(e, i, t, s, r) {\n  return t.drawScreenSpace ? 0 : D(e, i, t, s, r);\n}\n\nfunction $(e, i, t) {\n  return null == t && (t = x()), t[0] = e.origin[0] + e.coordinates[3 * i], t[1] = e.origin[1] + e.coordinates[3 * i + 1], t[2] = e.origin[2] + e.coordinates[3 * i + 2], t;\n}\n\nfunction J(e) {\n  return s(e.component) ? e.component : -1;\n}\n\nfunction K(i, t, s) {\n  e(i) && (i = []);\n  const r = {\n    component: t,\n    id: s\n  };\n  i.push(r);\n  const n = J(r);\n  let o = i.length - 1;\n\n  for (; o > 0 && n < J(i[o - 1]);) [i[o - 1], i[o]] = [i[o], i[o - 1]], --o;\n\n  return i;\n}\n\nfunction Q(i, t) {\n  if (e(i)) return i;\n  const s = i.filter(e => e.id !== t);\n  return 0 === s.length ? null : s;\n}\n\n!function (e) {\n  function i(e) {\n    return e.hasOwnProperty(\"splatSize\");\n  }\n\n  e.isInstanceOfNode = i;\n}(T || (T = {}));\nexport { T as PointRenderer };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/layers/i3s/PointRenderer.js"],"names":["isNone","e","unwrap","i","disposeMaybe","t","isSome","s","r","n","o","m","a","c","h","I","l","f","d","u","p","g","_","x","S","create","z","POSITIVE_INFINITY","P","offset","b","contains","w","containsPoint","R","equals","y","set","q","v","fromPoints","M","PointHighlights","j","minimumDistancePlane","F","maximumDistancePlane","H","intersectLine","V","toAaBoundingBox","U","bindSliceUniforms","A","bindOutputHighlight","C","Default3D","B","IntersectorResult","E","PointRendererTechniqueConfiguration","L","PointRendererTechnique","N","O","k","positions","name","count","type","stride","normalized","colors","T","constructor","_params","isGround","_bindParameters","inverseViewport","highlightDepthTexture","_highlights","forEachNode","addHighlight","removeHighlight","canRender","layerUid","_useFixedSizes","_scaleFactor","_minSizePx","_useRealWorldSymbolSizes","_size","_sizePx","_slicePlaneEnabled","_clipBox","_techniqueConfig","tempMatrix4","tempVec3","nodes","needsHighlight","hasHighlights","initializeRenderContext","_context","_techniqueRep","shaderTechniqueRep","requestRender","uninitializeRenderContext","intersect","camera","perScreenPixelRatio","near","_getSizeParams","node","pointId","point","dist","normal","forAll","splatSize","obb","G","isLeaf","D","origin","coordinates","length","$","options","store","push","metadata","createGraphic","id","intersector","results","min","max","all","render","pass","rctx","vao","_initNode","selectTechnique","program","setUniform3fv","useProgram","bindPipelineState","setUniformMatrix4fv","projectionMatrix","setUniform2f","far","isHighlightPass","fullViewport","pixelRatio","drawFixedSize","fixedSize","fullHeight","sliceHelper","plane","highlights","screenMinSize","W","viewMatrix","configuration","bindVAO","_renderHighlightFragments","drawArrays","component","useFixedSizes","_requestRender","scaleFactor","minSizePx","useRealWorldSymbolSizes","size","sizePx","clippingBox","slicePlane","intersectionHandlerId","addNode","nodeAdded","removeNode","filterInPlace","nodeRemoved","removeAll","clear","highlight","add","K","Q","createVertex","rgb","drawScreenSpace","drawScreenSize","slicePlaneEnabled","sceneHasOcludees","hasOccludees","output","releaseAndAcquire","_technique","Math","J","filter","hasOwnProperty","isInstanceOfNode","PointRenderer"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isNone as e,unwrap as i,disposeMaybe as t,isSome as s}from\"../../../../core/maybe.js\";import r from\"../../../../core/PooledArray.js\";import{i as n,t as o,m as a}from\"../../../../chunks/mat4.js\";import{c as h}from\"../../../../chunks/mat4f32.js\";import{I as l}from\"../../../../chunks/mat4f64.js\";import{f as c,l as d,a as u,o as m,d as p,p as g,s as f}from\"../../../../chunks/vec3.js\";import{c as _}from\"../../../../chunks/vec3f32.js\";import{c as x}from\"../../../../chunks/vec3f64.js\";import{s as S}from\"../../../../chunks/vec4.js\";import{create as z,POSITIVE_INFINITY as P,offset as b,contains as w,containsPoint as R,equals as y,set as q}from\"../../../../geometry/support/aaBoundingBox.js\";import{create as v}from\"../../../../geometry/support/plane.js\";import{fromPoints as M}from\"../../../../geometry/support/ray.js\";import{PointHighlights as j}from\"./PointHighlights.js\";import{minimumDistancePlane as F,maximumDistancePlane as H,intersectLine as V,toAaBoundingBox as U}from\"../../support/orientedBoundingBox.js\";import{bindSliceUniforms as A}from\"../../webgl-engine/core/shaderLibrary/Slice.glsl.js\";import{bindOutputHighlight as C}from\"../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl.js\";import{Default3D as B}from\"../../webgl-engine/lib/DefaultVertexAttributeLocations.js\";import{IntersectorResult as E}from\"../../webgl-engine/lib/intersectorUtils.js\";import{PointRendererTechniqueConfiguration as L,PointRendererTechnique as I}from\"../../webgl-engine/shaders/PointRendererTechnique.js\";import N from\"../../../webgl/BufferObject.js\";import O from\"../../../webgl/VertexArrayObject.js\";const k={positions:[{name:\"position\",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:\"color\",count:3,type:5121,offset:0,stride:3,normalized:!0}]};class T{constructor(e){this._params=e,this.type=\"Point\",this.isGround=!1,this._bindParameters={inverseViewport:[0,0],highlightDepthTexture:null},this._highlights=new j({forEachNode:e=>this.forEachNode(e),addHighlight:(e,i,t)=>this.addHighlight(e,i,t),removeHighlight:(e,i)=>this.removeHighlight(e,i)}),this.canRender=!0,this.layerUid=\"\",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=z(P),this._techniqueConfig=new L,this.tempMatrix4=h(),this.tempVec3=_(),this.nodes=new r}get needsHighlight(){return this._highlights.hasHighlights}initializeRenderContext(e){this._context=e,this._techniqueRep=this._context.shaderTechniqueRep,e.requestRender()}uninitializeRenderContext(){}intersect(e,i,t,s){const r=x(),n=x(),o=x(),a=x(),h=v(),f=e.camera.perScreenPixelRatio/2,_=e.camera.near,P=this._getSizeParams();c(n,s,t);const y=1/d(n);u(n,n,y),m(o,n),S(h,n[0],n[1],n[2],-p(n,t));class q{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=\"\"}}const j=new q,A=new q,C=[],B=z(),L=z(this._clipBox);b(L,-t[0],-t[1],-t[2],L),this.nodes.forAll((l=>{const d=l.splatSize*this._scaleFactor;let u=F(l.obb,h),m=H(l.obb,h);u-=G(d,u+_,P,f,l.isLeaf),m-=G(d,m+_,P,f,l.isLeaf);const x=m<0,S=null!=j.dist&&null!=A.dist&&j.dist<u*y&&A.dist>m*y;if(x||S)return;const z=D(d,m+_,P,f,l.isLeaf);if(!V(l.obb,t,n,z))return;const v=z*z;U(l.obb,B),b(B,-t[0],-t[1],-t[2],B);const M=!w(L,B);c(a,l.origin,t);const E=l.coordinates.length/3;for(let h=0;h<E;h++){if(r[0]=a[0]+l.coordinates[3*h],r[1]=a[1]+l.coordinates[3*h+1],r[2]=a[2]+l.coordinates[3*h+2],M&&!R(L,r))continue;const c=p(r,n),u=g(r)-c*c;if(u>v)continue;let m=c+_;const x=G(d,m,P,f,l.isLeaf);if(c-x<0)continue;m-=x;const S=D(d,m,P,f,l.isLeaf);if(u>S*S)continue;const z=(c-x)*y,b=e=>{e.point=$(l,h,e.point),e.dist=z,e.normal=o,e.node=l,e.pointId=h,e.layerUid=this.layerUid};if((null==j.dist||z<j.dist)&&(null==i||i(t,s,z))&&b(j),0!==e.options.store&&(null==A.dist||z>A.dist)&&(null==i||i(t,s,z))&&b(A),2===e.options.store&&(null==i||i(t,s,z))){const e=new q;b(e),C.push(e)}}}));const I=e=>{const{layerUid:i,node:t,pointId:s}=e;return{type:\"external\",point:e.point,metadata:{layerUid:i,createGraphic:()=>this._params.createGraphic(t,s,e.point)}}},N=(e,i)=>{const t=I(i),s=`${i.layerUid}/${i.node.id}/${i.pointId}`;e.set(t,s,i.dist,i.normal,l,void 0),e.intersector=\"PointRenderer\"};if(null!=j.dist){const i=e.results.min;(null==i.dist||j.dist<i.dist)&&N(i,j)}if(null!=A.dist&&0!==e.options.store){const i=e.results.max;(null==i.dist||A.dist>i.dist)&&N(i,A)}if(2===e.options.store){const i=M(t,s);for(const t of C){const s=new E(i);N(s,t),e.results.all.push(s)}}}render(e){if(0!==e.pass&&2!==e.pass&&5!==e.pass)return!1;const i=2===e.pass,t=e.rctx;this.nodes.forAll((i=>{null==i.vao&&this._initNode(e,i)}));const s=this._getSizeParams(),r=this.selectTechnique(e,s),h=r.program;if(null==h||0===this.nodes.length)return!0;const l=this._clipBox,c=!y(l,P,((e,i)=>e===i));c||(f(this.tempVec3,-1/0,-1/0,-1/0),h.setUniform3fv(\"uClipMin\",this.tempVec3),f(this.tempVec3,1/0,1/0,1/0),h.setUniform3fv(\"uClipMax\",this.tempVec3)),t.useProgram(h),r.bindPipelineState(t),h.setUniformMatrix4fv(\"uProjectionMatrix\",e.camera.projectionMatrix),i&&h.setUniform2f(\"nearFar\",e.camera.near,e.camera.far),e.isHighlightPass&&(this._bindParameters.inverseViewport[0]=1/e.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/e.camera.fullViewport[3],this._bindParameters.highlightDepthTexture=e.highlightDepthTexture,C(h,this._bindParameters));const d=e.camera.pixelRatio;s.drawFixedSize&&h.setUniform2f(\"uPointScale\",s.fixedSize*d,e.camera.fullHeight);const u=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null;return this.nodes.forAll((i=>{if(0===i.coordinates.length||e.isHighlightPass&&!i.highlights)return;if(h.setUniform2f(\"uScreenMinMaxSize\",s.screenMinSize*d,W(i.isLeaf)*d),!s.drawFixedSize){const t=i.splatSize*this._scaleFactor;h.setUniform2f(\"uPointScale\",t*d,e.camera.fullHeight/d)}const m=i.origin;c&&(f(this.tempVec3,l[0]-m[0],l[1]-m[1],l[2]-m[2]),h.setUniform3fv(\"uClipMin\",this.tempVec3),f(this.tempVec3,l[3]-m[0],l[4]-m[1],l[5]-m[2]),h.setUniform3fv(\"uClipMax\",this.tempVec3)),n(this.tempMatrix4),o(this.tempMatrix4,this.tempMatrix4,m),a(this.tempMatrix4,e.camera.viewMatrix,this.tempMatrix4),h.setUniformMatrix4fv(\"uModelViewMatrix\",this.tempMatrix4),A(h,r.configuration,u,m),t.bindVAO(i.vao),e.isHighlightPass?this._renderHighlightFragments(t,i):t.drawArrays(0,0,i.coordinates.length/3)})),!0}_renderHighlightFragments(t,s){const r=s.highlights;if(e(r))return;let n=i(r[0].component),o=n+1;for(let e=1;e<r.length;e++){const s=i(r[e].component);if(s!==o){const e=o-n;e>0&&t.drawArrays(0,n,e),n=s}o=s+1}const a=o-n;a>0&&t.drawArrays(0,n,a)}set useFixedSizes(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())}get useFixedSizes(){return this._useFixedSizes}set scaleFactor(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())}get scaleFactor(){return this._scaleFactor}set minSizePx(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())}get minSizePx(){return this._minSizePx}set useRealWorldSymbolSizes(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())}get useRealWorldSymbolSizes(){return this._useRealWorldSymbolSizes}set size(e){this._size!==e&&(this._size=e,this._requestRender())}get size(){return this._size}set sizePx(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())}get sizePx(){return this._sizePx}set clippingBox(e){q(this._clipBox,e||P)}get slicePlane(){return this._slicePlaneEnabled}set slicePlane(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}get intersectionHandlerId(){return this.layerUid}addNode(e){this.nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()}removeNode(e){let i=null;return this.nodes.filterInPlace((s=>s.id!==e||(i=s,s.vao=t(s.vao),this._highlights.nodeRemoved(s),!1))),this._requestRender(),i}forEachNode(e){this.nodes.forAll(e)}removeAll(){this.nodes.forAll((e=>e.vao=t(e.vao))),this._highlights.removeAll(),this.nodes.clear(),this._requestRender()}highlight(e){return this._highlights.add(e)}addHighlight(e,i,t){e.highlights=K(e.highlights,i,t),this._requestRender()}removeHighlight(e,i){e.highlights=Q(e.highlights,i),this._requestRender()}_initNode(e,i){const t=e.rctx;i.vao=new O(t,B,k,{positions:N.createVertex(t,35044,i.coordinates),colors:N.createVertex(t,35044,i.rgb)})}_requestRender(){this._context&&this._context.requestRender()}_getSizeParams(){const e=this._useFixedSizes,i=e&&!this._useRealWorldSymbolSizes;return{drawScreenSpace:i,drawFixedSize:e,fixedSize:i?this._sizePx:this._size,screenMinSize:e?0:this._minSizePx}}selectTechnique(e,i){return this._techniqueConfig.drawScreenSize=i.drawScreenSpace,this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled,this._techniqueConfig.sceneHasOcludees=e.hasOccludees,this._techniqueConfig.output=2===e.pass?1:5===e.pass?4:0,this._techniqueRep.releaseAndAcquire(I,this._techniqueConfig,this._technique)}}function W(e){return e?256:64}function D(e,i,t,s,r){if(t.drawScreenSpace)return t.fixedSize*i*s;const n=W(r)*i*s;return t.drawFixedSize?Math.min(t.fixedSize/2,n):t.screenMinSize>0?Math.min(Math.max(t.screenMinSize*i*s,e/2),n):Math.min(e/2,n)}function G(e,i,t,s,r){return t.drawScreenSpace?0:D(e,i,t,s,r)}function $(e,i,t){return null==t&&(t=x()),t[0]=e.origin[0]+e.coordinates[3*i],t[1]=e.origin[1]+e.coordinates[3*i+1],t[2]=e.origin[2]+e.coordinates[3*i+2],t}function J(e){return s(e.component)?e.component:-1}function K(i,t,s){e(i)&&(i=[]);const r={component:t,id:s};i.push(r);const n=J(r);let o=i.length-1;for(;o>0&&n<J(i[o-1]);)[i[o-1],i[o]]=[i[o],i[o-1]],--o;return i}function Q(i,t){if(e(i))return i;const s=i.filter((e=>e.id!==t));return 0===s.length?null:s}!function(e){function i(e){return e.hasOwnProperty(\"splatSize\")}e.isInstanceOfNode=i}(T||(T={}));export{T as PointRenderer};\n"]},"metadata":{},"sourceType":"module"}