{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../core/Logger.js\";\nimport { lerp as t, clamp as r } from \"../../../core/mathUtils.js\";\nimport { createResolver as i, createAbortController as s, isAbortError as a } from \"../../../core/promiseUtils.js\";\nimport { init as o } from \"../../../core/watchUtils.js\";\nimport { l as n } from \"../../../chunks/mat4.js\";\nimport { c as h } from \"../../../chunks/mat4f64.js\";\nimport { s as l } from \"../../../chunks/vec2.js\";\nimport { a as m } from \"../../../chunks/vec2f64.js\";\nimport { l as c, a as d, b as u, i as p, c as f, p as _ } from \"../../../chunks/vec3.js\";\nimport { c as g } from \"../../../chunks/vec3f64.js\";\nimport { getReferenceEllipsoid as x } from \"../../../geometry/projectionEllipsoid.js\";\nimport { isMars as V } from \"../../../geometry/support/spatialReferenceUtils.js\";\nimport { requestImage as C } from \"../../../support/requestImageUtils.js\";\nimport { computeInnerAltitudeFade as R, INNER_ATMOSPHERE_DEPTH as j } from \"./atmosphereUtils.js\";\nimport { SimpleAtmosphereTechniqueConfiguration as v, SimpleAtmosphereTechnique as y } from \"./SimpleAtmosphereTechnique.js\";\nimport b from \"./resources/MarsAtmosphereTexture.js\";\nimport U from \"./resources/SimpleAtmosphereTexture.js\";\nimport { makePiecewiseLinearFunction as D } from \"../support/mathUtils.js\";\nimport { glLayout as w } from \"../support/buffer/glUtil.js\";\nimport { newLayout as A } from \"../support/buffer/InterleavedLayout.js\";\nimport { Default3D as F } from \"../webgl-engine/lib/DefaultVertexAttributeLocations.js\";\nimport { createQuadVAO as q } from \"../webgl-engine/lib/glUtil3D.js\";\nimport { project as M } from \"../webgl-engine/lib/Util.js\";\nimport S from \"../../webgl/BufferObject.js\";\nimport T from \"../../webgl/Texture.js\";\nimport { vertexCount as W } from \"../../webgl/Util.js\";\nimport k from \"../../webgl/VertexArrayObject.js\";\n\nconst L = e.getLogger(\"esri.views.3d.environment.SimpleAtmosphere\"),\n      O = 128,\n      H = -j,\n      P = 0,\n      z = 50,\n      B = () => 1 - 511 / 512,\n      I = D([[50, .1015625], [500, .21875], [5e3, 1 - 250 / 512], [5e4, .4140625]]);\n\nclass E {\n  constructor(e) {\n    this.view = e, this.slot = 14, this._renderData = {\n      texV: m(),\n      silCircleCenter: g(),\n      silCircleV1: g(),\n      silCircleV2: g(),\n      altitudeFade: 0,\n      innerScale: 0,\n      undergroundFadeAlpha: 0\n    }, this._fadeVaoCount = 0, this._readyResolver = i(), this._readyController = s(), this.texV1 = 1, this.isOnMars = V(e.spatialReference);\n    const t = x(e.spatialReference);\n    this.planetRadius = t.radius, this.outerRimWidth = t.outerAtmosphereRimWidth, this.innerRimFactor = (this.planetRadius + H) / this.planetRadius, this.middleRimFactor = (this.planetRadius + P) / this.planetRadius, this.outerRimFactor = (this.planetRadius + this.outerRimWidth) / this.planetRadius, this.texV0 = P / this.outerRimWidth, this.texVScale = this.texV1 - this.texV0;\n  }\n\n  get canRender() {\n    return null != this._texture;\n  }\n\n  when() {\n    return this._readyResolver.promise;\n  }\n\n  initializeRenderContext(e) {\n    const t = e.renderContext.rctx;\n    this._cameraChangeHandle = o(this.view, \"state.camera\", () => e.requestRender(), !0);\n    const r = new v();\n    r.geometry = 0, this._atmosphereConeTechnique = e.shaderTechniqueRep.acquire(y, r), r.geometry = 2, this._atmosphereUndergroundTechnique = e.shaderTechniqueRep.acquire(y, r), this._vao = this._createRibbon(t), this._vaoCount = W(this._vao, \"geometry\"), this._fadeVao = q(t), this._fadeVaoCount = W(this._fadeVao, \"geometry\"), C(this.isOnMars ? b : U, {\n      signal: this._readyController.signal\n    }).then(r => {\n      this._texture = new T(t, {\n        pixelFormat: 6408,\n        dataType: 5121,\n        wrapMode: 33071,\n        samplingMode: 9729,\n        flipped: !0\n      }, r), e.requestRender(), this._readyController = null, this._readyResolver.resolve();\n    }).catch(e => {\n      a(e) || L.error(\"Unable to initialize simple atmosphere: image request failed\", e), this._readyResolver.reject();\n    });\n  }\n\n  uninitializeRenderContext() {\n    this.destroy();\n  }\n\n  destroy() {\n    this._readyResolver.reject(), this._cameraChangeHandle && (this._cameraChangeHandle.remove(), this._cameraChangeHandle = null), this._texture && (this._texture.dispose(), this._texture = null), this._fadeVao && (this._fadeVao.dispose(), this._fadeVao = null), this._vao && (this._vao.dispose(), this._vao = null), this._readyController && (this._readyController.abort(), this._readyController = null);\n  }\n\n  render(e) {\n    if (e.slot !== this.slot || 0 !== e.pass) return !1;\n\n    this._update(e.camera);\n\n    const t = e.rctx;\n\n    if (this._atmosphereConeTechnique.bindPipelineState(t), this._renderData.undergroundFadeAlpha < 1) {\n      const r = this._atmosphereConeTechnique.program;\n      t.useProgram(r), r.setUniformMatrix4fv(\"proj\", e.camera.projectionMatrix), r.setUniformMatrix4fv(\"view\", e.camera.viewMatrix), r.setUniform3fv(\"silCircleCenter\", this._renderData.silCircleCenter), r.setUniform3fv(\"silCircleV1\", this._renderData.silCircleV1), r.setUniform3fv(\"silCircleV2\", this._renderData.silCircleV2), r.setUniform2fv(\"texV\", this._renderData.texV), r.bindTexture(this._texture, \"tex\"), e.scenelightingData.setLightDirectionUniform(r), r.setUniform1f(\"altitudeFade\", this._renderData.altitudeFade), r.setUniform1f(\"innerScale\", this._renderData.innerScale), t.bindVAO(this._vao), t.drawArrays(4, 0, this._vaoCount);\n    }\n\n    if (this._renderData.undergroundFadeAlpha > 0) {\n      const r = this._atmosphereUndergroundTechnique.program;\n      t.useProgram(r), r.setUniform1f(\"undergroundFadeAlpha\", this._renderData.undergroundFadeAlpha), e.scenelightingData.setLightDirectionUniform(r), r.setUniform3fv(\"cameraPosition\", e.camera.eye), t.bindVAO(this._fadeVao), t.drawArrays(5, 0, this._fadeVaoCount);\n    }\n\n    return !0;\n  }\n\n  _update(e) {\n    const i = g(),\n          s = this.planetRadius,\n          a = c(e.eye),\n          o = a - s;\n\n    if (o < 0) {\n      const e = Math.min(-o / 5e3, 1);\n      this._renderData.undergroundFadeAlpha = e;\n    } else this._renderData.undergroundFadeAlpha = 0;\n\n    const n = Math.max(z, o),\n          h = s + H;\n    this._renderData.innerScale = Q(s + n, s, h) - 1, this._renderData.altitudeFade = R(o), d(i, e.eye, (s + z) / a), G(i, e.center, e.up, s, this._renderData);\n\n    const m = this._computeScreenRimWidth(e, i, e.up, this._renderData),\n          u = B(),\n          p = I(o);\n\n    let f = this.texV0 + u * this.texVScale,\n        _ = this.texV0 + m * p * this.texVScale;\n\n    if (o > z) {\n      G(e.eye, e.center, e.up, s, this._renderData);\n\n      const i = this._computeScreenRimWidth(e, e.eye, e.up, this._renderData),\n            a = r((i - 1.5) / (m - 1.5), 0, 1);\n\n      f = this.texV0 + a * u * this.texVScale, _ = this.texV0 + t(this.texV1, m * p, a) * this.texVScale;\n    }\n\n    l(this._renderData.texV, f, _);\n  }\n\n  _createRibbon(e) {\n    const t = new Float32Array(3 + 3 * O * 3),\n          r = new Uint32Array(3 * O * 5);\n    t[0] = 0, t[1] = 0, t[2] = -1;\n\n    for (let a = 0; a < O; a++) {\n      const e = 9 * a + 3;\n      t[e + 0] = a, t[e + 1] = this.innerRimFactor, t[e + 2] = -1, t[e + 3] = a, t[e + 4] = this.middleRimFactor, t[e + 5] = 0, t[e + 6] = a, t[e + 7] = this.outerRimFactor, t[e + 8] = 1;\n      const i = 3 * a + 1,\n            s = a === O - 1 ? 1 : i + 3,\n            o = 15 * a;\n      r[o + 0] = i, r[o + 1] = i + 1, r[o + 2] = s + 1, r[o + 3] = s + 1, r[o + 4] = s, r[o + 5] = i, r[o + 6] = i + 1, r[o + 7] = i + 2, r[o + 8] = s + 2, r[o + 9] = s + 2, r[o + 10] = s + 1, r[o + 11] = i + 1, r[o + 12] = i, r[o + 13] = s, r[o + 14] = 0;\n    }\n\n    const i = X.createBuffer(r.length),\n          s = i.position;\n\n    for (let a = 0; a < r.length; ++a) {\n      const e = 3 * r[a];\n      s.set(a, 0, t[e]), s.set(a, 1, t[e + 1]), s.set(a, 2, t[e + 2]);\n    }\n\n    return new k(e, F, {\n      geometry: w(X)\n    }, {\n      geometry: S.createVertex(e, 35044, i.buffer)\n    });\n  }\n\n  _computeScreenRimWidth(e, t, r, i) {\n    return u(K, i.silCircleCenter, i.silCircleV2), d(N, K, this.outerRimFactor), n(J, t, K, r), M(K, J, e.projectionMatrix, e.viewport), M(N, J, e.projectionMatrix, e.viewport), p(K, N) / e.height;\n  }\n\n}\n\nfunction G(e, t, r, i, s) {\n  const a = c(e),\n        o = i * Math.sqrt(a * a - i * i) / a,\n        n = Math.sqrt(i * i - o * o),\n        h = s.silCircleV1,\n        l = s.silCircleV2;\n  return d(s.silCircleCenter, e, n / a), f(h, e, t), _(h) < 1 && f(h, e, r), d(h, h, o / c(h)), f(l, h, e), d(l, l, o / c(l)), o;\n}\n\nconst J = h(),\n      K = g(),\n      N = g();\n\nfunction Q(e, t, r) {\n  return e * e / (Math.sqrt(e * e - t * t) * Math.sqrt(e * e - r * r) + t * r);\n}\n\nconst X = A().vec3f(\"position\");\nexport default E;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/environment/SimpleAtmosphere.js"],"names":["e","lerp","t","clamp","r","createResolver","i","createAbortController","s","isAbortError","a","init","o","l","n","c","h","m","d","b","u","p","f","_","g","getReferenceEllipsoid","x","isMars","V","requestImage","C","computeInnerAltitudeFade","R","INNER_ATMOSPHERE_DEPTH","j","SimpleAtmosphereTechniqueConfiguration","v","SimpleAtmosphereTechnique","y","U","makePiecewiseLinearFunction","D","glLayout","w","newLayout","A","Default3D","F","createQuadVAO","q","project","M","S","T","vertexCount","W","k","L","getLogger","O","H","P","z","B","I","E","constructor","view","slot","_renderData","texV","silCircleCenter","silCircleV1","silCircleV2","altitudeFade","innerScale","undergroundFadeAlpha","_fadeVaoCount","_readyResolver","_readyController","texV1","isOnMars","spatialReference","planetRadius","radius","outerRimWidth","outerAtmosphereRimWidth","innerRimFactor","middleRimFactor","outerRimFactor","texV0","texVScale","canRender","_texture","when","promise","initializeRenderContext","renderContext","rctx","_cameraChangeHandle","requestRender","geometry","_atmosphereConeTechnique","shaderTechniqueRep","acquire","_atmosphereUndergroundTechnique","_vao","_createRibbon","_vaoCount","_fadeVao","signal","then","pixelFormat","dataType","wrapMode","samplingMode","flipped","resolve","catch","error","reject","uninitializeRenderContext","destroy","remove","dispose","abort","render","pass","_update","camera","bindPipelineState","program","useProgram","setUniformMatrix4fv","projectionMatrix","viewMatrix","setUniform3fv","setUniform2fv","bindTexture","scenelightingData","setLightDirectionUniform","setUniform1f","bindVAO","drawArrays","eye","Math","min","max","Q","G","center","up","_computeScreenRimWidth","Float32Array","Uint32Array","X","createBuffer","length","position","set","createVertex","buffer","K","N","J","viewport","height","sqrt","vec3f"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../core/Logger.js\";import{lerp as t,clamp as r}from\"../../../core/mathUtils.js\";import{createResolver as i,createAbortController as s,isAbortError as a}from\"../../../core/promiseUtils.js\";import{init as o}from\"../../../core/watchUtils.js\";import{l as n}from\"../../../chunks/mat4.js\";import{c as h}from\"../../../chunks/mat4f64.js\";import{s as l}from\"../../../chunks/vec2.js\";import{a as m}from\"../../../chunks/vec2f64.js\";import{l as c,a as d,b as u,i as p,c as f,p as _}from\"../../../chunks/vec3.js\";import{c as g}from\"../../../chunks/vec3f64.js\";import{getReferenceEllipsoid as x}from\"../../../geometry/projectionEllipsoid.js\";import{isMars as V}from\"../../../geometry/support/spatialReferenceUtils.js\";import{requestImage as C}from\"../../../support/requestImageUtils.js\";import{computeInnerAltitudeFade as R,INNER_ATMOSPHERE_DEPTH as j}from\"./atmosphereUtils.js\";import{SimpleAtmosphereTechniqueConfiguration as v,SimpleAtmosphereTechnique as y}from\"./SimpleAtmosphereTechnique.js\";import b from\"./resources/MarsAtmosphereTexture.js\";import U from\"./resources/SimpleAtmosphereTexture.js\";import{makePiecewiseLinearFunction as D}from\"../support/mathUtils.js\";import{glLayout as w}from\"../support/buffer/glUtil.js\";import{newLayout as A}from\"../support/buffer/InterleavedLayout.js\";import{Default3D as F}from\"../webgl-engine/lib/DefaultVertexAttributeLocations.js\";import{createQuadVAO as q}from\"../webgl-engine/lib/glUtil3D.js\";import{project as M}from\"../webgl-engine/lib/Util.js\";import S from\"../../webgl/BufferObject.js\";import T from\"../../webgl/Texture.js\";import{vertexCount as W}from\"../../webgl/Util.js\";import k from\"../../webgl/VertexArrayObject.js\";const L=e.getLogger(\"esri.views.3d.environment.SimpleAtmosphere\"),O=128,H=-j,P=0,z=50,B=()=>1-511/512,I=D([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);class E{constructor(e){this.view=e,this.slot=14,this._renderData={texV:m(),silCircleCenter:g(),silCircleV1:g(),silCircleV2:g(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0},this._fadeVaoCount=0,this._readyResolver=i(),this._readyController=s(),this.texV1=1,this.isOnMars=V(e.spatialReference);const t=x(e.spatialReference);this.planetRadius=t.radius,this.outerRimWidth=t.outerAtmosphereRimWidth,this.innerRimFactor=(this.planetRadius+H)/this.planetRadius,this.middleRimFactor=(this.planetRadius+P)/this.planetRadius,this.outerRimFactor=(this.planetRadius+this.outerRimWidth)/this.planetRadius,this.texV0=P/this.outerRimWidth,this.texVScale=this.texV1-this.texV0}get canRender(){return null!=this._texture}when(){return this._readyResolver.promise}initializeRenderContext(e){const t=e.renderContext.rctx;this._cameraChangeHandle=o(this.view,\"state.camera\",(()=>e.requestRender()),!0);const r=new v;r.geometry=0,this._atmosphereConeTechnique=e.shaderTechniqueRep.acquire(y,r),r.geometry=2,this._atmosphereUndergroundTechnique=e.shaderTechniqueRep.acquire(y,r),this._vao=this._createRibbon(t),this._vaoCount=W(this._vao,\"geometry\"),this._fadeVao=q(t),this._fadeVaoCount=W(this._fadeVao,\"geometry\"),C(this.isOnMars?b:U,{signal:this._readyController.signal}).then((r=>{this._texture=new T(t,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},r),e.requestRender(),this._readyController=null,this._readyResolver.resolve()})).catch((e=>{a(e)||L.error(\"Unable to initialize simple atmosphere: image request failed\",e),this._readyResolver.reject()}))}uninitializeRenderContext(){this.destroy()}destroy(){this._readyResolver.reject(),this._cameraChangeHandle&&(this._cameraChangeHandle.remove(),this._cameraChangeHandle=null),this._texture&&(this._texture.dispose(),this._texture=null),this._fadeVao&&(this._fadeVao.dispose(),this._fadeVao=null),this._vao&&(this._vao.dispose(),this._vao=null),this._readyController&&(this._readyController.abort(),this._readyController=null)}render(e){if(e.slot!==this.slot||0!==e.pass)return!1;this._update(e.camera);const t=e.rctx;if(this._atmosphereConeTechnique.bindPipelineState(t),this._renderData.undergroundFadeAlpha<1){const r=this._atmosphereConeTechnique.program;t.useProgram(r),r.setUniformMatrix4fv(\"proj\",e.camera.projectionMatrix),r.setUniformMatrix4fv(\"view\",e.camera.viewMatrix),r.setUniform3fv(\"silCircleCenter\",this._renderData.silCircleCenter),r.setUniform3fv(\"silCircleV1\",this._renderData.silCircleV1),r.setUniform3fv(\"silCircleV2\",this._renderData.silCircleV2),r.setUniform2fv(\"texV\",this._renderData.texV),r.bindTexture(this._texture,\"tex\"),e.scenelightingData.setLightDirectionUniform(r),r.setUniform1f(\"altitudeFade\",this._renderData.altitudeFade),r.setUniform1f(\"innerScale\",this._renderData.innerScale),t.bindVAO(this._vao),t.drawArrays(4,0,this._vaoCount)}if(this._renderData.undergroundFadeAlpha>0){const r=this._atmosphereUndergroundTechnique.program;t.useProgram(r),r.setUniform1f(\"undergroundFadeAlpha\",this._renderData.undergroundFadeAlpha),e.scenelightingData.setLightDirectionUniform(r),r.setUniform3fv(\"cameraPosition\",e.camera.eye),t.bindVAO(this._fadeVao),t.drawArrays(5,0,this._fadeVaoCount)}return!0}_update(e){const i=g(),s=this.planetRadius,a=c(e.eye),o=a-s;if(o<0){const e=Math.min(-o/5e3,1);this._renderData.undergroundFadeAlpha=e}else this._renderData.undergroundFadeAlpha=0;const n=Math.max(z,o),h=s+H;this._renderData.innerScale=Q(s+n,s,h)-1,this._renderData.altitudeFade=R(o),d(i,e.eye,(s+z)/a),G(i,e.center,e.up,s,this._renderData);const m=this._computeScreenRimWidth(e,i,e.up,this._renderData),u=B(),p=I(o);let f=this.texV0+u*this.texVScale,_=this.texV0+m*p*this.texVScale;if(o>z){G(e.eye,e.center,e.up,s,this._renderData);const i=this._computeScreenRimWidth(e,e.eye,e.up,this._renderData),a=r((i-1.5)/(m-1.5),0,1);f=this.texV0+a*u*this.texVScale,_=this.texV0+t(this.texV1,m*p,a)*this.texVScale}l(this._renderData.texV,f,_)}_createRibbon(e){const t=new Float32Array(3+3*O*3),r=new Uint32Array(3*O*5);t[0]=0,t[1]=0,t[2]=-1;for(let a=0;a<O;a++){const e=9*a+3;t[e+0]=a,t[e+1]=this.innerRimFactor,t[e+2]=-1,t[e+3]=a,t[e+4]=this.middleRimFactor,t[e+5]=0,t[e+6]=a,t[e+7]=this.outerRimFactor,t[e+8]=1;const i=3*a+1,s=a===O-1?1:i+3,o=15*a;r[o+0]=i,r[o+1]=i+1,r[o+2]=s+1,r[o+3]=s+1,r[o+4]=s,r[o+5]=i,r[o+6]=i+1,r[o+7]=i+2,r[o+8]=s+2,r[o+9]=s+2,r[o+10]=s+1,r[o+11]=i+1,r[o+12]=i,r[o+13]=s,r[o+14]=0}const i=X.createBuffer(r.length),s=i.position;for(let a=0;a<r.length;++a){const e=3*r[a];s.set(a,0,t[e]),s.set(a,1,t[e+1]),s.set(a,2,t[e+2])}return new k(e,F,{geometry:w(X)},{geometry:S.createVertex(e,35044,i.buffer)})}_computeScreenRimWidth(e,t,r,i){return u(K,i.silCircleCenter,i.silCircleV2),d(N,K,this.outerRimFactor),n(J,t,K,r),M(K,J,e.projectionMatrix,e.viewport),M(N,J,e.projectionMatrix,e.viewport),p(K,N)/e.height}}function G(e,t,r,i,s){const a=c(e),o=i*Math.sqrt(a*a-i*i)/a,n=Math.sqrt(i*i-o*o),h=s.silCircleV1,l=s.silCircleV2;return d(s.silCircleCenter,e,n/a),f(h,e,t),_(h)<1&&f(h,e,r),d(h,h,o/c(h)),f(l,h,e),d(l,l,o/c(l)),o}const J=h(),K=g(),N=g();function Q(e,t,r){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-r*r)+t*r)}const X=A().vec3f(\"position\");export default E;\n"]},"metadata":{},"sourceType":"module"}