{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../../../../core/Error.js\";\nimport t from \"../../../../../../core/Logger.js\";\nimport { isAbortError as r } from \"../../../../../../core/promiseUtils.js\";\nimport { errorPolygonSymbol2D as s, errorPointSymbol2D as i, errorPolylineSymbol2D as a } from \"../../../../../../symbols/support/defaults.js\";\nimport o from \"./WGLDynamicFillTemplate.js\";\nimport m from \"./WGLDynamicLineTemplate.js\";\nimport c from \"./WGLDynamicMarkerTemplate.js\";\nimport l from \"./WGLDynamicTextTemplate.js\";\nimport n from \"./WGLFillTemplate.js\";\nimport h from \"./WGLLineTemplate.js\";\nimport p from \"./WGLMarkerTemplate.js\";\nimport _ from \"./WGLTextTemplate.js\";\nimport u, { withLock as f } from \"../../util/Lock.js\";\nimport { ok as M } from \"../../util/Result.js\";\nimport { createSymbolSchema as T } from \"../../../../layers/features/schemaUtils.js\";\nimport { codepoints as I } from \"../../../../layers/features/textUtils.js\";\nconst y = t.getLogger(\"esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore\"),\n      d = new Array();\n\nfunction g(e, t) {\n  const r = e.length;\n  return e.push(null), t.then(t => e[r] = t), e;\n}\n\nfunction S(e) {\n  return !!(1 & e);\n}\n\nfunction w(e) {\n  return \"worker:port-closed\" === e.name;\n}\n\nclass k {\n  constructor(e, t) {\n    this._idCounter = 1, this._templateIdCounter = 1, this._idToTemplateGroup = new Map(), this._symbolToTemplate = new Map(), this._fetchQueue = [], this._idToResolver = new Map(), this._cimTemplateCache = new Map(), this._cimAnalyses = [], this._lock = new u(), this._fetchResource = e, this._tileInfo = t;\n  }\n\n  get _markerError() {\n    return this._errorTemplates.marker[0];\n  }\n\n  get _fillError() {\n    return this._errorTemplates.fill[0];\n  }\n\n  get _lineError() {\n    return this._errorTemplates.line[0];\n  }\n\n  get _textError() {\n    return this._errorTemplates.line[0];\n  }\n\n  createTemplateGroup(e, t) {\n    this._initErrorTemplates();\n\n    const r = e.hash;\n    if (this._symbolToTemplate.has(r)) return this._symbolToTemplate.get(r);\n    const s = new Array();\n    t && this._createMeshTemplates(s, t, !0), this._createMeshTemplates(s, e, !1);\n\n    const i = this._createGroupId(\"expanded-cim\" === e.type);\n\n    return this._idToTemplateGroup.set(i, s), this._symbolToTemplate.set(r, i), i;\n  }\n\n  getTemplateGroup(e) {\n    return this._idToTemplateGroup.has(e) ? this._idToTemplateGroup.get(e) : d;\n  }\n\n  getDynamicTemplateGroup(e) {\n    return this._idToTemplateGroup.has(e) ? (S(e) || y.error(\"mapview-template-store\", `Id ${e} does not refer to a dynamic template`), this._idToTemplateGroup.get(e)) : d;\n  }\n\n  getMosaicItem(e, t) {\n    const r = this._createTemplateId(),\n          s = new Promise(e => this._idToResolver.set(r, e));\n\n    return this._fetchQueue.push({\n      symbol: e,\n      id: r,\n      glyphIds: t\n    }), s;\n  }\n\n  finalize(e) {\n    return this._fetchQueue.length || this._lock.isHeld() ? f(this._lock, this._fetchAllQueuedResources.bind(this), e) : Promise.resolve();\n  }\n\n  _initErrorTemplates() {\n    this._errorTemplates || (this._errorTemplates = {\n      fill: this._createMeshTemplates([], T(s), !1),\n      marker: this._createMeshTemplates([], T(i), !1),\n      line: this._createMeshTemplates([], T(a), !1)\n    });\n  }\n\n  _fetchAllQueuedResources(t) {\n    if (!this._fetchQueue.length) return Promise.resolve();\n    const s = this._fetchQueue,\n          i = this._cimAnalyses;\n    return this._fetchQueue = [], this._cimAnalyses = [], Promise.all(i).then(() => this._fetchResource(s, t).then(e => {\n      for (const {\n        id: t,\n        mosaicItem: r\n      } of e) {\n        this._idToResolver.get(t)(r), this._idToResolver.delete(t);\n      }\n    })).catch(t => {\n      r(t) ? this._fetchQueue = this._fetchQueue.concat(s) : w(t) || y.error(new e(\"mapview-template-store\", \"Unable to fetch requested texture resources\", t));\n    });\n  }\n\n  _createGroupId(e) {\n    return this._idCounter++ << 1 | (e ? 1 : 0);\n  }\n\n  _createTemplateId() {\n    return this._templateIdCounter++;\n  }\n\n  async _createSMS(e) {\n    const {\n      spriteMosaicItem: t\n    } = await this.getMosaicItem(e);\n    return M(t, y) ? p.fromSimpleMarker(e, t) : this._markerError;\n  }\n\n  async _createPMS(e) {\n    const {\n      spriteMosaicItem: t\n    } = await this.getMosaicItem(e);\n    return M(t, y) ? p.fromPictureMarker(e, t) : this._markerError;\n  }\n\n  async _createSFS(e, t) {\n    const {\n      spriteMosaicItem: r\n    } = await this.getMosaicItem(e);\n    return M(r, y) ? n.fromSimpleFill(e, r, t) : this._fillError;\n  }\n\n  async _createPFS(e, t) {\n    const {\n      spriteMosaicItem: r\n    } = await this.getMosaicItem(e);\n    return M(r, y) ? n.fromPictureFill(e, r, t) : this._fillError;\n  }\n\n  async _createSLS(e, t) {\n    const {\n      spriteMosaicItem: r\n    } = await this.getMosaicItem(e);\n    return M(r, y) ? h.fromSimpleLine(e, r) : this._lineError;\n  }\n\n  async _createLMS(e) {\n    const {\n      spriteMosaicItem: t\n    } = await this.getMosaicItem(e);\n    return M(t, y) ? p.fromLineSymbolMarker(e, t) : this._markerError;\n  }\n\n  async _createTS(e) {\n    const {\n      glyphMosaicItems: t\n    } = await this.getMosaicItem(e);\n    return _.fromText(e, t);\n  }\n\n  async _createCIMText(e) {\n    const {\n      glyphMosaicItems: t\n    } = await this.getMosaicItem(e.cim, I(e.text));\n    return M(t, y) ? _.fromCIMText(e, t, this._tileInfo) : this._textError;\n  }\n\n  async _createCIMFill(e) {\n    const {\n      spriteMosaicItem: t\n    } = await this.getMosaicItem(e.cim);\n    return M(t, y) ? n.fromCIMFill(e, t, this._tileInfo) : this._fillError;\n  }\n\n  async _createCIMLine(e) {\n    const {\n      spriteMosaicItem: t\n    } = await this.getMosaicItem(e.cim);\n    return M(t, y) ? h.fromCIMLine(e, t, this._tileInfo) : this._lineError;\n  }\n\n  async _createCIMMarker(e) {\n    const {\n      spriteMosaicItem: t\n    } = await this.getMosaicItem(e.cim);\n    return M(t, y) ? p.fromCIMMarker(e, t, this._tileInfo) : this._markerError;\n  }\n\n  async _createCIM(e) {\n    const t = e.templateHash;\n    if (this._cimTemplateCache.has(t)) return this._cimTemplateCache.get(t);\n    const r = { ...e,\n      cim: { ...e.cim,\n        mosaicHash: e.materialHash\n      }\n    };\n    let s;\n\n    switch (r.type) {\n      case \"marker\":\n        s = this._createCIMMarker(r);\n        break;\n\n      case \"line\":\n        s = this._createCIMLine(r);\n        break;\n\n      case \"fill\":\n        s = this._createCIMFill(r);\n        break;\n\n      case \"text\":\n        s = this._createCIMText(r);\n    }\n\n    return s.then(e => this._cimTemplateCache.set(t, e)), s;\n  }\n\n  _createDynamicCIM(e) {\n    const t = e.templateHash;\n    if (this._cimTemplateCache.has(t)) return this._cimTemplateCache.get(t);\n    let r;\n\n    switch (e.type) {\n      case \"marker\":\n        r = c.fromCIMMarker(e, this._tileInfo);\n        break;\n\n      case \"line\":\n        r = m.fromCIMLine(e, this._tileInfo);\n        break;\n\n      case \"fill\":\n        r = o.fromCIMFill(e, this._tileInfo);\n        break;\n\n      case \"text\":\n        r = l.fromCIMText(e, this._tileInfo);\n    }\n\n    return this._cimTemplateCache.set(t, r), r;\n  }\n\n  _createPrimitiveMeshTemplates(e, t, r) {\n    switch (t.type) {\n      case \"esriSMS\":\n        return g(e, this._createSMS(t));\n\n      case \"esriPMS\":\n        return g(e, this._createPMS(t));\n\n      case \"esriSFS\":\n        return g(e, this._createSFS(t, r));\n\n      case \"line-marker\":\n        return g(e, this._createLMS(t));\n\n      case \"esriPFS\":\n        return g(e, this._createPFS(t, r));\n\n      case \"esriSLS\":\n        return g(e, this._createSLS(t, !1));\n\n      case \"esriTS\":\n        return g(e, this._createTS(t));\n\n      default:\n        return y.error(\"Unable to create mesh template for unknown symbol type {: $ }{symbol.type}\"), e;\n    }\n  }\n\n  _createMeshTemplates(e, t, r) {\n    if (-1 !== t.type.indexOf(\"3d\")) return y.error(\"3D symbols are not supported with MapView\"), e;\n\n    if (\"expanded-cim\" === t.type) {\n      for (const r of t.layers) \"function\" == typeof r.materialHash ? e.push(this._createDynamicCIM(r)) : g(e, this._createCIM(r));\n\n      return e;\n    }\n\n    if (\"composite-symbol\" === t.type) {\n      for (const s of t.layers) this._createPrimitiveMeshTemplates(e, s, r);\n\n      return e;\n    }\n\n    return \"cim\" === t.type || \"label\" === t.type || \"web-style\" === t.type ? e : this._createPrimitiveMeshTemplates(e, t, r);\n  }\n\n}\n\nexport { k as WGLTemplateStore, S as isDynamicId };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/2d/engine/webgl/mesh/templates/WGLTemplateStore.js"],"names":["e","t","isAbortError","r","errorPolygonSymbol2D","s","errorPointSymbol2D","i","errorPolylineSymbol2D","a","o","m","c","l","n","h","p","_","u","withLock","f","ok","M","createSymbolSchema","T","codepoints","I","y","getLogger","d","Array","g","length","push","then","S","w","name","k","constructor","_idCounter","_templateIdCounter","_idToTemplateGroup","Map","_symbolToTemplate","_fetchQueue","_idToResolver","_cimTemplateCache","_cimAnalyses","_lock","_fetchResource","_tileInfo","_markerError","_errorTemplates","marker","_fillError","fill","_lineError","line","_textError","createTemplateGroup","_initErrorTemplates","hash","has","get","_createMeshTemplates","_createGroupId","type","set","getTemplateGroup","getDynamicTemplateGroup","error","getMosaicItem","_createTemplateId","Promise","symbol","id","glyphIds","finalize","isHeld","_fetchAllQueuedResources","bind","resolve","all","mosaicItem","delete","catch","concat","_createSMS","spriteMosaicItem","fromSimpleMarker","_createPMS","fromPictureMarker","_createSFS","fromSimpleFill","_createPFS","fromPictureFill","_createSLS","fromSimpleLine","_createLMS","fromLineSymbolMarker","_createTS","glyphMosaicItems","fromText","_createCIMText","cim","text","fromCIMText","_createCIMFill","fromCIMFill","_createCIMLine","fromCIMLine","_createCIMMarker","fromCIMMarker","_createCIM","templateHash","mosaicHash","materialHash","_createDynamicCIM","_createPrimitiveMeshTemplates","indexOf","layers","WGLTemplateStore","isDynamicId"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../../../../core/Error.js\";import t from\"../../../../../../core/Logger.js\";import{isAbortError as r}from\"../../../../../../core/promiseUtils.js\";import{errorPolygonSymbol2D as s,errorPointSymbol2D as i,errorPolylineSymbol2D as a}from\"../../../../../../symbols/support/defaults.js\";import o from\"./WGLDynamicFillTemplate.js\";import m from\"./WGLDynamicLineTemplate.js\";import c from\"./WGLDynamicMarkerTemplate.js\";import l from\"./WGLDynamicTextTemplate.js\";import n from\"./WGLFillTemplate.js\";import h from\"./WGLLineTemplate.js\";import p from\"./WGLMarkerTemplate.js\";import _ from\"./WGLTextTemplate.js\";import u,{withLock as f}from\"../../util/Lock.js\";import{ok as M}from\"../../util/Result.js\";import{createSymbolSchema as T}from\"../../../../layers/features/schemaUtils.js\";import{codepoints as I}from\"../../../../layers/features/textUtils.js\";const y=t.getLogger(\"esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore\"),d=new Array;function g(e,t){const r=e.length;return e.push(null),t.then((t=>e[r]=t)),e}function S(e){return!!(1&e)}function w(e){return\"worker:port-closed\"===e.name}class k{constructor(e,t){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new u,this._fetchResource=e,this._tileInfo=t}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(e,t){this._initErrorTemplates();const r=e.hash;if(this._symbolToTemplate.has(r))return this._symbolToTemplate.get(r);const s=new Array;t&&this._createMeshTemplates(s,t,!0),this._createMeshTemplates(s,e,!1);const i=this._createGroupId(\"expanded-cim\"===e.type);return this._idToTemplateGroup.set(i,s),this._symbolToTemplate.set(r,i),i}getTemplateGroup(e){return this._idToTemplateGroup.has(e)?this._idToTemplateGroup.get(e):d}getDynamicTemplateGroup(e){return this._idToTemplateGroup.has(e)?(S(e)||y.error(\"mapview-template-store\",`Id ${e} does not refer to a dynamic template`),this._idToTemplateGroup.get(e)):d}getMosaicItem(e,t){const r=this._createTemplateId(),s=new Promise((e=>this._idToResolver.set(r,e)));return this._fetchQueue.push({symbol:e,id:r,glyphIds:t}),s}finalize(e){return this._fetchQueue.length||this._lock.isHeld()?f(this._lock,this._fetchAllQueuedResources.bind(this),e):Promise.resolve()}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],T(s),!1),marker:this._createMeshTemplates([],T(i),!1),line:this._createMeshTemplates([],T(a),!1)})}_fetchAllQueuedResources(t){if(!this._fetchQueue.length)return Promise.resolve();const s=this._fetchQueue,i=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],Promise.all(i).then((()=>this._fetchResource(s,t).then((e=>{for(const{id:t,mosaicItem:r}of e){this._idToResolver.get(t)(r),this._idToResolver.delete(t)}})))).catch((t=>{r(t)?this._fetchQueue=this._fetchQueue.concat(s):w(t)||y.error(new e(\"mapview-template-store\",\"Unable to fetch requested texture resources\",t))}))}_createGroupId(e){return this._idCounter++<<1|(e?1:0)}_createTemplateId(){return this._templateIdCounter++}async _createSMS(e){const{spriteMosaicItem:t}=await this.getMosaicItem(e);return M(t,y)?p.fromSimpleMarker(e,t):this._markerError}async _createPMS(e){const{spriteMosaicItem:t}=await this.getMosaicItem(e);return M(t,y)?p.fromPictureMarker(e,t):this._markerError}async _createSFS(e,t){const{spriteMosaicItem:r}=await this.getMosaicItem(e);return M(r,y)?n.fromSimpleFill(e,r,t):this._fillError}async _createPFS(e,t){const{spriteMosaicItem:r}=await this.getMosaicItem(e);return M(r,y)?n.fromPictureFill(e,r,t):this._fillError}async _createSLS(e,t){const{spriteMosaicItem:r}=await this.getMosaicItem(e);return M(r,y)?h.fromSimpleLine(e,r):this._lineError}async _createLMS(e){const{spriteMosaicItem:t}=await this.getMosaicItem(e);return M(t,y)?p.fromLineSymbolMarker(e,t):this._markerError}async _createTS(e){const{glyphMosaicItems:t}=await this.getMosaicItem(e);return _.fromText(e,t)}async _createCIMText(e){const{glyphMosaicItems:t}=await this.getMosaicItem(e.cim,I(e.text));return M(t,y)?_.fromCIMText(e,t,this._tileInfo):this._textError}async _createCIMFill(e){const{spriteMosaicItem:t}=await this.getMosaicItem(e.cim);return M(t,y)?n.fromCIMFill(e,t,this._tileInfo):this._fillError}async _createCIMLine(e){const{spriteMosaicItem:t}=await this.getMosaicItem(e.cim);return M(t,y)?h.fromCIMLine(e,t,this._tileInfo):this._lineError}async _createCIMMarker(e){const{spriteMosaicItem:t}=await this.getMosaicItem(e.cim);return M(t,y)?p.fromCIMMarker(e,t,this._tileInfo):this._markerError}async _createCIM(e){const t=e.templateHash;if(this._cimTemplateCache.has(t))return this._cimTemplateCache.get(t);const r={...e,cim:{...e.cim,mosaicHash:e.materialHash}};let s;switch(r.type){case\"marker\":s=this._createCIMMarker(r);break;case\"line\":s=this._createCIMLine(r);break;case\"fill\":s=this._createCIMFill(r);break;case\"text\":s=this._createCIMText(r)}return s.then((e=>this._cimTemplateCache.set(t,e))),s}_createDynamicCIM(e){const t=e.templateHash;if(this._cimTemplateCache.has(t))return this._cimTemplateCache.get(t);let r;switch(e.type){case\"marker\":r=c.fromCIMMarker(e,this._tileInfo);break;case\"line\":r=m.fromCIMLine(e,this._tileInfo);break;case\"fill\":r=o.fromCIMFill(e,this._tileInfo);break;case\"text\":r=l.fromCIMText(e,this._tileInfo)}return this._cimTemplateCache.set(t,r),r}_createPrimitiveMeshTemplates(e,t,r){switch(t.type){case\"esriSMS\":return g(e,this._createSMS(t));case\"esriPMS\":return g(e,this._createPMS(t));case\"esriSFS\":return g(e,this._createSFS(t,r));case\"line-marker\":return g(e,this._createLMS(t));case\"esriPFS\":return g(e,this._createPFS(t,r));case\"esriSLS\":return g(e,this._createSLS(t,!1));case\"esriTS\":return g(e,this._createTS(t));default:return y.error(\"Unable to create mesh template for unknown symbol type {: $ }{symbol.type}\"),e}}_createMeshTemplates(e,t,r){if(-1!==t.type.indexOf(\"3d\"))return y.error(\"3D symbols are not supported with MapView\"),e;if(\"expanded-cim\"===t.type){for(const r of t.layers)\"function\"==typeof r.materialHash?e.push(this._createDynamicCIM(r)):g(e,this._createCIM(r));return e}if(\"composite-symbol\"===t.type){for(const s of t.layers)this._createPrimitiveMeshTemplates(e,s,r);return e}return\"cim\"===t.type||\"label\"===t.type||\"web-style\"===t.type?e:this._createPrimitiveMeshTemplates(e,t,r)}}export{k as WGLTemplateStore,S as isDynamicId};\n"]},"metadata":{},"sourceType":"module"}