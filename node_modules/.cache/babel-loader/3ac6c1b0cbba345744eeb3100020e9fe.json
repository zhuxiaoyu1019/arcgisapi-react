{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../../core/Error.js\";\nimport { isSome as t } from \"../../../../core/maybe.js\";\nimport { onAbort as s, throwIfAborted as r } from \"../../../../core/promiseUtils.js\";\nconst i = 14;\n\nclass o {\n  constructor(e, t, s = i) {\n    this._version = s, this._db = null, this._quotaReductionPromise = null, this._gcCounter = 0, this._hit = 0, this._miss = 0, this._destroyed = !1, this.gcFrequency = 50, this.maxByteSize = 1073741824, this.quotaReductionFactor = .2, this._dbName = e, this._storeName = t;\n  }\n\n  init() {\n    return Promise.resolve().then(() => {\n      const e = indexedDB.open(this._dbName, this._version);\n      return e.onupgradeneeded = t => {\n        const s = e.result,\n              r = e.transaction,\n              i = s.objectStoreNames.contains(this._storeName) ? r.objectStore(this._storeName) : s.createObjectStore(this._storeName),\n              o = s.objectStoreNames.contains(\"last_access\") ? r.objectStore(\"last_access\") : s.createObjectStore(\"last_access\");\n        o.indexNames.contains(\"date\") || o.createIndex(\"date\", \"date\", {\n          unique: !1\n        }), o.indexNames.contains(\"byteSize\") || o.createIndex(\"byteSize\", \"byteSize\", {\n          unique: !1\n        }), t.oldVersion < this._version && (i.clear(), o.clear());\n      }, c(e);\n    }).then(e => {\n      this._destroyed ? e.close() : this._db = e;\n    });\n  }\n\n  destroy() {\n    this._db && (this._db.close(), this._db = null), this._destroyed = !0;\n  }\n\n  get initialized() {\n    return null != this._db;\n  }\n\n  getHitRate() {\n    return this._hit / (this._hit + this._miss);\n  }\n\n  put(t, s) {\n    if (null == this._db) return Promise.reject(new e(\"indexedb:not-initialized\", \"IndexedDB Cache is not initialized\"));\n    return (null != this._quotaReductionPromise ? this._quotaReductionPromise : Promise.resolve()).then(() => this._put(t, s)).catch(e => {\n      if (e && \"QuotaExceededError\" === e.name) return null == this._quotaReductionPromise && (this._quotaReductionPromise = this._getCacheSize().then(e => this._removeLeastRecentlyAccessed(s.byteSize + Math.ceil(e * this.quotaReductionFactor))), this._quotaReductionPromise.then(() => this._quotaReductionPromise = null, () => this._quotaReductionPromise = null)), this._quotaReductionPromise.then(() => this._put(t, s));\n      throw e;\n    }).then(() => {\n      this._gcCounter--, this._gcCounter < 0 && null != this._db && (this._gcCounter = this.gcFrequency, this._getCacheSize().then(e => this._removeLeastRecentlyAccessed(e - this.maxByteSize)));\n    });\n  }\n\n  get(e, i) {\n    if (null == this._db) return Promise.resolve(null);\n    let o = null;\n    return Promise.resolve().then(() => {\n      const t = this._db.transaction(this._storeName, \"readonly\");\n\n      o = s(i, () => {\n        t.abort();\n      });\n      return c(t.objectStore(this._storeName).get(e));\n    }).then(s => {\n      if (null == s) ++this._miss;else if (this._db) {\n        ++this._hit;\n\n        this._db.transaction(\"last_access\", \"readwrite\").objectStore(\"last_access\").put({\n          date: Date.now(),\n          byteSize: s.byteSize\n        }, e);\n      }\n      return t(o) && o.remove(), s;\n    }).catch(() => (++this._miss, r(i), t(o) && o.remove(), null));\n  }\n\n  remove(e) {\n    return null == this._db ? Promise.resolve() : Promise.resolve().then(async () => {\n      const t = this._db.transaction([this._storeName, \"last_access\"], \"readwrite\"),\n            s = t.objectStore(this._storeName),\n            r = t.objectStore(\"last_access\"),\n            i = s.delete(e),\n            o = r.delete(e);\n\n      await Promise.all([c(i), c(o), n(t)]);\n    });\n  }\n\n  _put(e, t) {\n    const s = this._db.transaction([this._storeName, \"last_access\"], \"readwrite\"),\n          r = s.objectStore(this._storeName),\n          i = s.objectStore(\"last_access\"),\n          o = r.put(t, e),\n          a = i.put({\n      date: Date.now(),\n      byteSize: t.byteSize\n    }, e);\n\n    return Promise.all([c(o), c(a), n(s)]);\n  }\n\n  _removeLeastRecentlyAccessed(e) {\n    if (e <= 0) return;\n\n    const t = this._db.transaction([this._storeName, \"last_access\"], \"readwrite\"),\n          s = t.objectStore(this._storeName),\n          r = t.objectStore(\"last_access\");\n\n    let i = 0;\n    const o = r.index(\"date\").openCursor(null, \"next\");\n    return o.onsuccess = () => {\n      const t = o.result;\n      null != t && (null != t.value.byteSize && (i += t.value.byteSize), s.delete(t.primaryKey), r.delete(t.primaryKey), i < e && t.continue());\n    }, n(t);\n  }\n\n  _getCacheSize() {\n    const e = this._db.transaction(\"last_access\"),\n          t = e.objectStore(\"last_access\");\n\n    let s = 0;\n    const r = t.index(\"byteSize\").openKeyCursor();\n    return r.onsuccess = () => {\n      const e = r.result;\n      if (!e) return;\n      const t = e.key;\n      null != t && (s += t), e.continue();\n    }, n(e).then(() => s);\n  }\n\n}\n\nfunction n(e) {\n  return new Promise((t, s) => {\n    e.oncomplete = () => t(), e.onerror = () => s(e.error), e.onabort = () => s(e.error);\n  });\n}\n\nfunction c(e) {\n  return new Promise((t, s) => {\n    \"done\" === e.readyState ? null != e.error ? s(e.error) : t(e.result) : (e.onsuccess = () => t(e.result), e.onerror = () => s(e.error));\n  });\n}\n\nexport { o as IDBCache, c as whenRequest, n as whenTransaction };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/layers/i3s/IDBCache.js"],"names":["e","isSome","t","onAbort","s","throwIfAborted","r","i","o","constructor","_version","_db","_quotaReductionPromise","_gcCounter","_hit","_miss","_destroyed","gcFrequency","maxByteSize","quotaReductionFactor","_dbName","_storeName","init","Promise","resolve","then","indexedDB","open","onupgradeneeded","result","transaction","objectStoreNames","contains","objectStore","createObjectStore","indexNames","createIndex","unique","oldVersion","clear","c","close","destroy","initialized","getHitRate","put","reject","_put","catch","name","_getCacheSize","_removeLeastRecentlyAccessed","byteSize","Math","ceil","get","abort","date","Date","now","remove","delete","all","n","a","index","openCursor","onsuccess","value","primaryKey","continue","openKeyCursor","key","oncomplete","onerror","error","onabort","readyState","IDBCache","whenRequest","whenTransaction"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../../core/Error.js\";import{isSome as t}from\"../../../../core/maybe.js\";import{onAbort as s,throwIfAborted as r}from\"../../../../core/promiseUtils.js\";const i=14;class o{constructor(e,t,s=i){this._version=s,this._db=null,this._quotaReductionPromise=null,this._gcCounter=0,this._hit=0,this._miss=0,this._destroyed=!1,this.gcFrequency=50,this.maxByteSize=1073741824,this.quotaReductionFactor=.2,this._dbName=e,this._storeName=t}init(){return Promise.resolve().then((()=>{const e=indexedDB.open(this._dbName,this._version);return e.onupgradeneeded=t=>{const s=e.result,r=e.transaction,i=s.objectStoreNames.contains(this._storeName)?r.objectStore(this._storeName):s.createObjectStore(this._storeName),o=s.objectStoreNames.contains(\"last_access\")?r.objectStore(\"last_access\"):s.createObjectStore(\"last_access\");o.indexNames.contains(\"date\")||o.createIndex(\"date\",\"date\",{unique:!1}),o.indexNames.contains(\"byteSize\")||o.createIndex(\"byteSize\",\"byteSize\",{unique:!1}),t.oldVersion<this._version&&(i.clear(),o.clear())},c(e)})).then((e=>{this._destroyed?e.close():this._db=e}))}destroy(){this._db&&(this._db.close(),this._db=null),this._destroyed=!0}get initialized(){return null!=this._db}getHitRate(){return this._hit/(this._hit+this._miss)}put(t,s){if(null==this._db)return Promise.reject(new e(\"indexedb:not-initialized\",\"IndexedDB Cache is not initialized\"));return(null!=this._quotaReductionPromise?this._quotaReductionPromise:Promise.resolve()).then((()=>this._put(t,s))).catch((e=>{if(e&&\"QuotaExceededError\"===e.name)return null==this._quotaReductionPromise&&(this._quotaReductionPromise=this._getCacheSize().then((e=>this._removeLeastRecentlyAccessed(s.byteSize+Math.ceil(e*this.quotaReductionFactor)))),this._quotaReductionPromise.then((()=>this._quotaReductionPromise=null),(()=>this._quotaReductionPromise=null))),this._quotaReductionPromise.then((()=>this._put(t,s)));throw e})).then((()=>{this._gcCounter--,this._gcCounter<0&&null!=this._db&&(this._gcCounter=this.gcFrequency,this._getCacheSize().then((e=>this._removeLeastRecentlyAccessed(e-this.maxByteSize))))}))}get(e,i){if(null==this._db)return Promise.resolve(null);let o=null;return Promise.resolve().then((()=>{const t=this._db.transaction(this._storeName,\"readonly\");o=s(i,(()=>{t.abort()}));return c(t.objectStore(this._storeName).get(e))})).then((s=>{if(null==s)++this._miss;else if(this._db){++this._hit;this._db.transaction(\"last_access\",\"readwrite\").objectStore(\"last_access\").put({date:Date.now(),byteSize:s.byteSize},e)}return t(o)&&o.remove(),s})).catch((()=>(++this._miss,r(i),t(o)&&o.remove(),null)))}remove(e){return null==this._db?Promise.resolve():Promise.resolve().then((async()=>{const t=this._db.transaction([this._storeName,\"last_access\"],\"readwrite\"),s=t.objectStore(this._storeName),r=t.objectStore(\"last_access\"),i=s.delete(e),o=r.delete(e);await Promise.all([c(i),c(o),n(t)])}))}_put(e,t){const s=this._db.transaction([this._storeName,\"last_access\"],\"readwrite\"),r=s.objectStore(this._storeName),i=s.objectStore(\"last_access\"),o=r.put(t,e),a=i.put({date:Date.now(),byteSize:t.byteSize},e);return Promise.all([c(o),c(a),n(s)])}_removeLeastRecentlyAccessed(e){if(e<=0)return;const t=this._db.transaction([this._storeName,\"last_access\"],\"readwrite\"),s=t.objectStore(this._storeName),r=t.objectStore(\"last_access\");let i=0;const o=r.index(\"date\").openCursor(null,\"next\");return o.onsuccess=()=>{const t=o.result;null!=t&&(null!=t.value.byteSize&&(i+=t.value.byteSize),s.delete(t.primaryKey),r.delete(t.primaryKey),i<e&&t.continue())},n(t)}_getCacheSize(){const e=this._db.transaction(\"last_access\"),t=e.objectStore(\"last_access\");let s=0;const r=t.index(\"byteSize\").openKeyCursor();return r.onsuccess=()=>{const e=r.result;if(!e)return;const t=e.key;null!=t&&(s+=t),e.continue()},n(e).then((()=>s))}}function n(e){return new Promise(((t,s)=>{e.oncomplete=()=>t(),e.onerror=()=>s(e.error),e.onabort=()=>s(e.error)}))}function c(e){return new Promise(((t,s)=>{\"done\"===e.readyState?null!=e.error?s(e.error):t(e.result):(e.onsuccess=()=>t(e.result),e.onerror=()=>s(e.error))}))}export{o as IDBCache,c as whenRequest,n as whenTransaction};\n"]},"metadata":{},"sourceType":"module"}