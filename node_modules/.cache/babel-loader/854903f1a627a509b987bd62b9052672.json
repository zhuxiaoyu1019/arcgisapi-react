{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from \"../../../../core/pbf.js\";\nimport { isAborted as t } from \"../../../../core/promiseUtils.js\";\nimport r from \"./Feature.js\";\nimport { TriangleIndexBuffer as s } from \"./IndexMemoryBuffer.js\";\nimport i from \"./SourceLayerData.js\";\nimport { FillVertexBuffer as o, OutlineVertexBuffer as c, LineVertexBuffer as n, CircleVertexBuffer as l, SymbolVertexBuffer as a } from \"./VertexMemoryBuffer.js\";\nimport u from \"./buckets/CircleBucket.js\";\nimport f from \"./buckets/FillBucket.js\";\nimport p from \"./buckets/LineBucket.js\";\nimport h from \"./buckets/SymbolBucket.js\";\nimport { TileClipper as m, SimpleBuilder as _ } from \"../webgl/TileClipper.js\";\nimport { TileStatus as y } from \"../../tiling/enums.js\";\nconst k = 8,\n      d = 14,\n      T = 5;\n\nclass w {\n  constructor(t, r, s, i, o) {\n    if (this._pbfTiles = {}, this._tileClippers = {}, this._client = s, this._tile = r, o) {\n      this._styleLayerUIDs = new Set();\n\n      for (const e of o) this._styleLayerUIDs.add(e);\n    }\n\n    this._styleRepository = i, this._layers = this._styleRepository.layers;\n    const [c, n, l] = r.tileKey.split(\"/\").map(parseFloat);\n    this._level = c;\n    const a = k + Math.max((this._level - d) * T, 0);\n\n    for (const u of Object.keys(t)) {\n      const r = t[u];\n      this._pbfTiles[u] = new e(new Uint8Array(r.protobuff), new DataView(r.protobuff));\n\n      if (r.refKey) {\n        const [e] = r.refKey.split(\"/\").map(parseFloat),\n              t = c - e;\n\n        if (t > 0) {\n          const e = (1 << t) - 1,\n                r = n & e,\n                s = l & e;\n          this._tileClippers[u] = new m(t, r, s, 8, a);\n        }\n      }\n\n      this._tileClippers[u] || (this._tileClippers[u] = new _());\n    }\n  }\n\n  _canParseStyleLayer(e) {\n    return !this._styleLayerUIDs || this._styleLayerUIDs.has(e);\n  }\n\n  async parse(e) {\n    const t = this._initialize(e),\n          {\n      returnedBuckets: r\n    } = t;\n\n    this._processLayers(t), this._linkReferences(t), this._filterFeatures(t);\n    const s = new Set(),\n          i = {};\n\n    for (const c of r) c.getResources(c.tileClipper, s, i);\n\n    if (this._tile.status === y.INVALID) return Promise.resolve([]);\n\n    const o = this._fetchResources(s, i, e);\n\n    return Promise.all(o).then(() => this._processFeatures(t.returnedBuckets));\n  }\n\n  _initialize(e) {\n    return {\n      signal: e && e.signal,\n      sourceNameToTileData: this._parseTileData(this._pbfTiles),\n      layers: this._layers,\n      zoom: this._level,\n      sourceNameToTileClipper: this._tileClippers,\n      sourceNameToUniqueSourceLayerBuckets: {},\n      sourceNameToUniqueSourceLayers: {},\n      returnedBuckets: [],\n      layerIdToBucket: {},\n      referencerUIDToReferencedId: new Map()\n    };\n  }\n\n  _processLayers(e) {\n    const {\n      sourceNameToTileData: t,\n      layers: r,\n      zoom: s,\n      sourceNameToTileClipper: i,\n      sourceNameToUniqueSourceLayerBuckets: o,\n      sourceNameToUniqueSourceLayers: c,\n      returnedBuckets: n,\n      layerIdToBucket: l,\n      referencerUIDToReferencedId: a\n    } = e;\n\n    for (let u = r.length - 1; u >= 0; u--) {\n      const e = r[u];\n      if (!this._canParseStyleLayer(e.uid) || e.minzoom && s < Math.floor(e.minzoom) || e.maxzoom && s >= e.maxzoom || 0 === e.type) continue;\n      if (!t[e.source] || !i[e.source]) continue;\n      const f = t[e.source],\n            p = i[e.source],\n            h = e.sourceLayer,\n            m = f[h];\n\n      if (m) {\n        let t = c[e.source];\n        if (t || (t = c[e.source] = new Set()), t.add(e.sourceLayer), e.refLayerId) a.set(e.uid, e.refLayerId);else {\n          const t = this._createBucket(e);\n\n          if (t) {\n            t.layerUIDs = [e.uid], t.layerExtent = m.extent, t.tileClipper = p;\n            let r = o[e.source];\n            r || (r = o[e.source] = {});\n            let s = r[h];\n            s || (s = r[h] = []), s.push(t), n.push(t), l[e.id.toLowerCase()] = t;\n          }\n        }\n      }\n    }\n  }\n\n  _linkReferences(e) {\n    const {\n      layerIdToBucket: t,\n      referencerUIDToReferencedId: r\n    } = e;\n    r.forEach((e, r) => {\n      e = e.toLowerCase(), t[e] && t[e].layerUIDs.push(r);\n    });\n  }\n\n  _filterFeatures(e) {\n    const {\n      signal: s,\n      sourceNameToTileData: i,\n      sourceNameToUniqueSourceLayerBuckets: o,\n      sourceNameToUniqueSourceLayers: c\n    } = e,\n          n = 10 * this._level,\n          l = 10 * (this._level + 1),\n          a = [],\n          u = [];\n\n    for (const t of Object.keys(c)) {\n      c[t].forEach(e => {\n        a.push(e), u.push(t);\n      });\n    }\n\n    for (let f = 0; f < a.length; f++) {\n      const e = u[f],\n            c = a[f];\n      if (!i[e] || !o[e]) continue;\n      const p = i[e][c],\n            h = o[e][c];\n      if (!h || 0 === h.length) continue;\n      if (t(s)) return;\n      const m = p.getData();\n\n      for (; m.nextTag(2);) {\n        const e = m.getMessage(),\n              t = new r(e, p);\n        e.release();\n        const s = t.values;\n\n        if (s) {\n          const e = s._minzoom;\n          if (e && e >= l) continue;\n          const t = s._maxzoom;\n          if (t && t <= n) continue;\n        }\n\n        for (const r of h) r.pushFeature(t);\n      }\n    }\n  }\n\n  _fetchResources(e, t, r) {\n    const s = [],\n          i = this._tile.getWorkerTileHandler();\n\n    let o, c;\n    e.size > 0 && (o = i.fetchSprites(e, this._client, r), s.push(o));\n\n    for (const n in t) {\n      const e = t[n];\n      e.size > 0 && (c = i.fetchGlyphs(this._tile.tileKey, n, e, this._client, r), s.push(c));\n    }\n\n    return s;\n  }\n\n  _processFeatures(e) {\n    const t = e.filter(e => e.hasFeatures() || this._canParseStyleLayer(e.layer.uid));\n\n    for (const r of t) r.processFeatures(r.tileClipper);\n\n    return t;\n  }\n\n  _parseTileData(e) {\n    const t = {};\n\n    for (const r of Object.keys(e)) {\n      const s = e[r],\n            o = {};\n\n      for (; s.next();) switch (s.tag()) {\n        case 3:\n          {\n            const e = s.getMessage(),\n                  t = new i(e);\n            e.release(), o[t.name] = t;\n            break;\n          }\n\n        default:\n          s.skip();\n      }\n\n      t[r] = o;\n    }\n\n    return t;\n  }\n\n  _createBucket(e) {\n    switch (e.type) {\n      case 0:\n        return null;\n\n      case 1:\n        return this._createFillBucket(e);\n\n      case 2:\n        return this._createLineBucket(e);\n\n      case 4:\n        return this._createCircleBucket(e);\n\n      case 3:\n        return this._createSymbolBucket(e);\n    }\n  }\n\n  _createFillBucket(e) {\n    return new f(e, this._level, this._tile.getWorkerTileHandler().getSpriteItems(), new o(e.fillMaterial.getStride()), new s(), new c(e.outlineMaterial.getStride()), new s());\n  }\n\n  _createLineBucket(e) {\n    return new p(e, this._level, this._tile.getWorkerTileHandler().getSpriteItems(), new n(e.lineMaterial.getStride()), new s());\n  }\n\n  _createCircleBucket(e) {\n    return new u(e, this._level, this._tile.getWorkerTileHandler().getSpriteItems(), new l(e.circleMaterial.getStride()), new s());\n  }\n\n  _createSymbolBucket(e) {\n    const t = this._tile;\n    return new h(e, this._level, new a(e.iconMaterial.getStride()), new s(), new a(e.textMaterial.getStride()), new s(), t.placementEngine, t.getWorkerTileHandler());\n  }\n\n}\n\nexport default w;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/2d/engine/vectorTiles/TileParser.js"],"names":["e","isAborted","t","r","TriangleIndexBuffer","s","i","FillVertexBuffer","o","OutlineVertexBuffer","c","LineVertexBuffer","n","CircleVertexBuffer","l","SymbolVertexBuffer","a","u","f","p","h","TileClipper","m","SimpleBuilder","_","TileStatus","y","k","d","T","w","constructor","_pbfTiles","_tileClippers","_client","_tile","_styleLayerUIDs","Set","add","_styleRepository","_layers","layers","tileKey","split","map","parseFloat","_level","Math","max","Object","keys","Uint8Array","protobuff","DataView","refKey","_canParseStyleLayer","has","parse","_initialize","returnedBuckets","_processLayers","_linkReferences","_filterFeatures","getResources","tileClipper","status","INVALID","Promise","resolve","_fetchResources","all","then","_processFeatures","signal","sourceNameToTileData","_parseTileData","zoom","sourceNameToTileClipper","sourceNameToUniqueSourceLayerBuckets","sourceNameToUniqueSourceLayers","layerIdToBucket","referencerUIDToReferencedId","Map","length","uid","minzoom","floor","maxzoom","type","source","sourceLayer","refLayerId","set","_createBucket","layerUIDs","layerExtent","extent","push","id","toLowerCase","forEach","getData","nextTag","getMessage","release","values","_minzoom","_maxzoom","pushFeature","getWorkerTileHandler","size","fetchSprites","fetchGlyphs","filter","hasFeatures","layer","processFeatures","next","tag","name","skip","_createFillBucket","_createLineBucket","_createCircleBucket","_createSymbolBucket","getSpriteItems","fillMaterial","getStride","outlineMaterial","lineMaterial","circleMaterial","iconMaterial","textMaterial","placementEngine"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../../../../core/pbf.js\";import{isAborted as t}from\"../../../../core/promiseUtils.js\";import r from\"./Feature.js\";import{TriangleIndexBuffer as s}from\"./IndexMemoryBuffer.js\";import i from\"./SourceLayerData.js\";import{FillVertexBuffer as o,OutlineVertexBuffer as c,LineVertexBuffer as n,CircleVertexBuffer as l,SymbolVertexBuffer as a}from\"./VertexMemoryBuffer.js\";import u from\"./buckets/CircleBucket.js\";import f from\"./buckets/FillBucket.js\";import p from\"./buckets/LineBucket.js\";import h from\"./buckets/SymbolBucket.js\";import{TileClipper as m,SimpleBuilder as _}from\"../webgl/TileClipper.js\";import{TileStatus as y}from\"../../tiling/enums.js\";const k=8,d=14,T=5;class w{constructor(t,r,s,i,o){if(this._pbfTiles={},this._tileClippers={},this._client=s,this._tile=r,o){this._styleLayerUIDs=new Set;for(const e of o)this._styleLayerUIDs.add(e)}this._styleRepository=i,this._layers=this._styleRepository.layers;const[c,n,l]=r.tileKey.split(\"/\").map(parseFloat);this._level=c;const a=k+Math.max((this._level-d)*T,0);for(const u of Object.keys(t)){const r=t[u];this._pbfTiles[u]=new e(new Uint8Array(r.protobuff),new DataView(r.protobuff));if(r.refKey){const[e]=r.refKey.split(\"/\").map(parseFloat),t=c-e;if(t>0){const e=(1<<t)-1,r=n&e,s=l&e;this._tileClippers[u]=new m(t,r,s,8,a)}}this._tileClippers[u]||(this._tileClippers[u]=new _)}}_canParseStyleLayer(e){return!this._styleLayerUIDs||this._styleLayerUIDs.has(e)}async parse(e){const t=this._initialize(e),{returnedBuckets:r}=t;this._processLayers(t),this._linkReferences(t),this._filterFeatures(t);const s=new Set,i={};for(const c of r)c.getResources(c.tileClipper,s,i);if(this._tile.status===y.INVALID)return Promise.resolve([]);const o=this._fetchResources(s,i,e);return Promise.all(o).then((()=>this._processFeatures(t.returnedBuckets)))}_initialize(e){return{signal:e&&e.signal,sourceNameToTileData:this._parseTileData(this._pbfTiles),layers:this._layers,zoom:this._level,sourceNameToTileClipper:this._tileClippers,sourceNameToUniqueSourceLayerBuckets:{},sourceNameToUniqueSourceLayers:{},returnedBuckets:[],layerIdToBucket:{},referencerUIDToReferencedId:new Map}}_processLayers(e){const{sourceNameToTileData:t,layers:r,zoom:s,sourceNameToTileClipper:i,sourceNameToUniqueSourceLayerBuckets:o,sourceNameToUniqueSourceLayers:c,returnedBuckets:n,layerIdToBucket:l,referencerUIDToReferencedId:a}=e;for(let u=r.length-1;u>=0;u--){const e=r[u];if(!this._canParseStyleLayer(e.uid)||e.minzoom&&s<Math.floor(e.minzoom)||e.maxzoom&&s>=e.maxzoom||0===e.type)continue;if(!t[e.source]||!i[e.source])continue;const f=t[e.source],p=i[e.source],h=e.sourceLayer,m=f[h];if(m){let t=c[e.source];if(t||(t=c[e.source]=new Set),t.add(e.sourceLayer),e.refLayerId)a.set(e.uid,e.refLayerId);else{const t=this._createBucket(e);if(t){t.layerUIDs=[e.uid],t.layerExtent=m.extent,t.tileClipper=p;let r=o[e.source];r||(r=o[e.source]={});let s=r[h];s||(s=r[h]=[]),s.push(t),n.push(t),l[e.id.toLowerCase()]=t}}}}}_linkReferences(e){const{layerIdToBucket:t,referencerUIDToReferencedId:r}=e;r.forEach(((e,r)=>{e=e.toLowerCase(),t[e]&&t[e].layerUIDs.push(r)}))}_filterFeatures(e){const{signal:s,sourceNameToTileData:i,sourceNameToUniqueSourceLayerBuckets:o,sourceNameToUniqueSourceLayers:c}=e,n=10*this._level,l=10*(this._level+1),a=[],u=[];for(const t of Object.keys(c)){c[t].forEach((e=>{a.push(e),u.push(t)}))}for(let f=0;f<a.length;f++){const e=u[f],c=a[f];if(!i[e]||!o[e])continue;const p=i[e][c],h=o[e][c];if(!h||0===h.length)continue;if(t(s))return;const m=p.getData();for(;m.nextTag(2);){const e=m.getMessage(),t=new r(e,p);e.release();const s=t.values;if(s){const e=s._minzoom;if(e&&e>=l)continue;const t=s._maxzoom;if(t&&t<=n)continue}for(const r of h)r.pushFeature(t)}}}_fetchResources(e,t,r){const s=[],i=this._tile.getWorkerTileHandler();let o,c;e.size>0&&(o=i.fetchSprites(e,this._client,r),s.push(o));for(const n in t){const e=t[n];e.size>0&&(c=i.fetchGlyphs(this._tile.tileKey,n,e,this._client,r),s.push(c))}return s}_processFeatures(e){const t=e.filter((e=>e.hasFeatures()||this._canParseStyleLayer(e.layer.uid)));for(const r of t)r.processFeatures(r.tileClipper);return t}_parseTileData(e){const t={};for(const r of Object.keys(e)){const s=e[r],o={};for(;s.next();)switch(s.tag()){case 3:{const e=s.getMessage(),t=new i(e);e.release(),o[t.name]=t;break}default:s.skip()}t[r]=o}return t}_createBucket(e){switch(e.type){case 0:return null;case 1:return this._createFillBucket(e);case 2:return this._createLineBucket(e);case 4:return this._createCircleBucket(e);case 3:return this._createSymbolBucket(e)}}_createFillBucket(e){return new f(e,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new o(e.fillMaterial.getStride()),new s,new c(e.outlineMaterial.getStride()),new s)}_createLineBucket(e){return new p(e,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new n(e.lineMaterial.getStride()),new s)}_createCircleBucket(e){return new u(e,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new l(e.circleMaterial.getStride()),new s)}_createSymbolBucket(e){const t=this._tile;return new h(e,this._level,new a(e.iconMaterial.getStride()),new s,new a(e.textMaterial.getStride()),new s,t.placementEngine,t.getWorkerTileHandler())}}export default w;\n"]},"metadata":{},"sourceType":"module"}