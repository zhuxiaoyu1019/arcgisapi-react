{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../../chunks/tslib.es6.js\";\nimport { HandleOwner as t } from \"../../../../../core/HandleOwner.js\";\nimport s from \"../../../../../core/has.js\";\nimport { isNone as r } from \"../../../../../core/maybe.js\";\nimport { ignoreAbortErrors as i, after as a, throwIfAborted as o, throwIfNotAbortError as n, isAbortError as u } from \"../../../../../core/promiseUtils.js\";\nimport { whenFalseOnce as h } from \"../../../../../core/watchUtils.js\";\nimport { property as d } from \"../../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../../core/accessorSupport/ensureType.js\";\nimport \"../../../../../core/Logger.js\";\nimport { subclass as c } from \"../../../../../core/accessorSupport/decorators/subclass.js\";\nimport { convertToGeometry as l } from \"../../../../../layers/graphics/featureConversionUtils.js\";\nimport p from \"../../../../../layers/graphics/data/QueryEngine.js\";\nimport g from \"../../../../../layers/support/FieldsIndex.js\";\nimport { FeatureStore2D as f } from \"../FeatureStore2D.js\";\nimport { createSource as y } from \"../sources/createSource.js\";\nimport m from \"../support/AttributeStore.js\";\nimport { ClusterStore as _ } from \"../support/ClusterStore.js\";\nimport { ComputedAttributeStorage as S } from \"../support/ComputedAttributeStorage.js\";\nimport { FeatureSetReaderJSON as v } from \"../support/FeatureSetReaderJSON.js\";\nimport { UpdateToken as b } from \"../support/UpdateToken.js\";\nimport { QueueProcessor as I } from \"../../../../support/QueueProcessor.js\";\nconst w = 5e3,\n      C = \"tileRenderer.featuresView.attributeView.initialize\",\n      j = \"tileRenderer.featuresView.attributeView.requestUpdate\",\n      E = \"tileRenderer.featuresView.requestRender\";\n\nfunction T(e) {\n  return \"worker:port-closed\" === e.name;\n}\n\nfunction k(e) {\n  if (!u(e) && !T(e)) throw e;\n}\n\nfunction F(e) {\n  return \"feature\" === e.type && \"snapshot\" === e.mode;\n}\n\nlet R = class extends t {\n  constructor() {\n    super(...arguments), this._storage = new S(), this._markedIdsBufId = this._storage.createBitset(), this._lastCleanup = performance.now(), this._cleanupNeeded = !1, this._invalidated = !1, this._tileToResolver = new Map(), this._didEdit = !1, this.tileStore = null, this.config = null, this.processor = null, this.remoteClient = null, this.service = null;\n  }\n\n  initialize() {\n    this._initAttributeStore(), this._initStores(), this._initQueryEngine(), this._initSource(), this._updateQueue = new I({\n      concurrency: \"geoevent\" === this._source.type ? 1 : 4,\n      process: (e, t) => this._onTileMessage(e, {\n        signal: t\n      })\n    }), this.handles.add([this.tileStore.on(\"update\", this.onTileUpdate.bind(this)), this.watch(\"updating\", e => !e && this.onIdle())]), this._checkUpdating = setInterval(() => this.notifyChange(\"updating\"), 300);\n  }\n\n  async startup() {\n    this._initAttributeStore(), this.tileStore.tiles.forEach(e => this._source.subscribe(e));\n  }\n\n  _initSource() {\n    const e = this.tileStore.tileScheme,\n          t = () => this._updateQueue.length < 50,\n          s = (e, t) => (this._invalidated = !0, this._patchTile(e, t));\n\n    this._source = y(this.service, this.spatialReference, e, s, t, this.featureStore), this._proxyEvents();\n  }\n\n  _proxyEvents() {\n    if (\"geoevent\" === this._source.type) {\n      const e = this._source.events;\n      this.handles.add([e.on(\"connectionStatus\", e => this.remoteClient.invoke(\"setProperty\", {\n        propertyName: \"connectionStatus\",\n        value: e\n      }).catch(k)), e.on(\"errorString\", e => this.remoteClient.invoke(\"setProperty\", {\n        propertyName: \"errorString\",\n        value: e\n      }).catch(k)), e.on(\"feature\", e => this.remoteClient.invoke(\"emitEvent\", {\n        name: \"data-received\",\n        event: {\n          attributes: e.attributes,\n          centroid: e.centroid,\n          geometry: e.geometry\n        }\n      }).catch(k)), e.on(\"updateRate\", e => this.remoteClient.invoke(\"emitEvent\", {\n        name: \"update-rate\",\n        event: { ...e\n        }\n      }).catch(k))]);\n    }\n  }\n\n  _initAttributeStore() {\n    this.attributeStore ? this.attributeStore.invalidateResources() : this.attributeStore = new m({\n      type: \"remote\",\n      initialize: (e, t) => i(this.remoteClient.invoke(C, e, {\n        signal: t\n      }).catch(k)),\n      update: (e, t) => i(this.remoteClient.invoke(j, e, {\n        signal: t\n      }).catch(k)),\n      render: e => i(this.remoteClient.invoke(E, void 0, {\n        signal: e\n      }).catch(k))\n    }, this.config);\n  }\n\n  _initStores() {\n    const e = \"snapshot\" === this.service.type ? \"snapshot\" : \"on-demand\",\n          t = {\n      geometryInfo: {\n        geometryType: this.service.geometryType,\n        hasM: !1,\n        hasZ: !1\n      },\n      spatialReference: this.spatialReference,\n      fieldsIndex: this.fieldsIndex,\n      fields: this.service.fields\n    };\n    this.featureStore = new f(t, this._storage, e), this.aggregateStore = new _(t, this.spatialReference, this._storage), this.handles.add(this.aggregateStore.events.on(\"valueRangesChanged\", e => {\n      this.remoteClient.invoke(\"emitEvent\", {\n        name: \"valueRangesChanged\",\n        event: {\n          valueRanges: e.valueRanges\n        }\n      }).catch(k);\n    }));\n  }\n\n  _initQueryEngine() {\n    var e;\n    const t = this;\n    null == (e = this.queryEngine) || e.destroy(), this.queryEngine = new p({\n      definitionExpression: this.config.definitionExpression,\n      fields: this.service.fields,\n      geometryType: this.service.geometryType,\n      objectIdField: this.service.objectIdField,\n      hasM: !1,\n      hasZ: !1,\n      spatialReference: this.spatialReference.toJSON(),\n      cacheSpatialQueries: !0,\n      featureStore: this.featureStore,\n      aggregateAdapter: {\n        getFeatureObjectIds: e => t.aggregateStore.getFeatureDisplayIdsForAggregate(e).map(e => t.getObjectId(e))\n      },\n      timeInfo: this.service.timeInfo\n    });\n  }\n\n  destroy() {\n    this._updateQueue.destroy(), this._source.destroy(), this.queryEngine.destroy(), this.attributeStore && this.attributeStore.destroy(), clearInterval(this._checkUpdating);\n  }\n\n  get fieldsIndex() {\n    return new g(this.service.fields);\n  }\n\n  get hasAggregates() {\n    return !!this.config.schema.targets.aggregate;\n  }\n\n  get spatialReference() {\n    return this.tileStore.tileScheme.spatialReference;\n  }\n\n  get updating() {\n    return this.isUpdating();\n  }\n\n  isUpdating() {\n    return this._source.updating || !!this._updateQueue.length;\n  }\n\n  enableEvent(e) {\n    this._source.enableEvent(e.name, e.value);\n  }\n\n  pause() {\n    this._updateQueue.pause(), this._updateQueue.clear();\n  }\n\n  async update(e, t) {\n    this._set(\"config\", t), this._schema = t.schema, this._initQueryEngine(), await Promise.all([this._source.update(e, t.schema.source), this.featureStore.updateSchema(e, t.schema.targets.feature), this.attributeStore.update(e, t), this.attributeStore.updateFilters(e, this)]), await this.aggregateStore.updateSchema(e, t.schema.targets.aggregate), s(\"esri-2d-update-debug\") && e.describe();\n  }\n\n  async applyUpdate(e) {\n    e.mesh && this.clearTiles(), this._updateQueue.resume(), await this._source.applyUpdate(e), this.notifyChange(\"updating\"), await h(this, \"updating\", !0), this.hasAggregates && (await a(10), await h(this, \"updating\", !0));\n  }\n\n  async onEdits({\n    edits: e\n  }) {\n    s(\"esri-2d-update-debug\") && console.debug(\"Applying Edit:\", e), this._didEdit = !0;\n\n    try {\n      const t = e.removed.map(e => e.objectId && -1 !== e.objectId ? e.objectId : this._lookupObjectIdByGlobalId(e.globalId)),\n            s = e.addOrModified.map(({\n        objectId: e\n      }) => e);\n      this.featureStore.invalidate(), await this._source.edit(s, t), this.clearTiles(), this.notifyChange(\"updating\"), await this._source.resend(), await h(this, \"updating\", !0);\n    } catch (t) {}\n  }\n\n  async refresh() {\n    this.featureStore.invalidate(), this.clearTiles(), this._source.refresh(), this._cleanupNeeded = !0, this.notifyChange(\"updating\"), await h(this, \"updating\", !0);\n  }\n\n  clearTiles() {\n    for (const e of this.tileStore.tiles) this.processor.onTileClear(e);\n  }\n\n  onTileUpdate(e) {\n    this.aggregateStore.onTileUpdate(e);\n\n    for (const t of e.added) this._source.subscribe(t), this._level = t.level;\n\n    for (const t of e.removed) this._source.unsubscribe(t), this._cleanupNeeded = !0, this._tileToResolver.has(t.id) && (this._tileToResolver.get(t.id).resolve(), this._tileToResolver.delete(t.id));\n\n    this.notifyChange(\"updating\");\n  }\n\n  onIdle() {\n    this._invalidated && ((this.hasAggregates || \"heatmap\" === this.processor.type) && this._repushCurrentLevelTiles(), this._invalidated = !1), this._markAndSweep();\n  }\n\n  async querySummaryStatistics({\n    query: e,\n    params: t\n  }) {\n    return this.queryEngine.executeQueryForSummaryStatistics(e, t);\n  }\n\n  queryExtent(e) {\n    return this.queryEngine.executeQueryForExtent(e);\n  }\n\n  queryFeatures(e) {\n    return this.queryEngine.executeQuery(e);\n  }\n\n  queryFeatureCount(e) {\n    return this.queryEngine.executeQueryForCount(e);\n  }\n\n  queryLatestObservations(e) {\n    return this.queryEngine.executeQueryForLatestObservations(e);\n  }\n\n  queryObjectIds(e) {\n    return this.queryEngine.executeQueryForIds(e);\n  }\n\n  async queryStatistics() {\n    return { ...this.featureStore.storeStatistics,\n      displayedFeatureCount: 0,\n      displayedVertexCount: 0,\n      displayPreProcessTime: 0\n    };\n  }\n\n  getObjectId(e) {\n    return this.featureStore.lookupObjectId(e, this._storage);\n  }\n\n  getDisplayId(e) {\n    if (this._schema.targets.aggregate) {\n      const t = this.aggregateStore.getDisplayId(e);\n\n      if (r(t)) {\n        const t = this.featureStore.lookupDisplayId(e);\n        return this.aggregateStore.getDisplayIdForReferenceId(t);\n      }\n\n      return t;\n    }\n\n    return this.featureStore.lookupDisplayId(e);\n  }\n\n  getFeature(e) {\n    const t = this.featureStore.lookupFeatureByDisplayId(e, this._storage);\n    if (r(t)) return null;\n    const s = t.readHydratedGeometry(),\n          i = l(s, t.geometryType, t.hasZ, t.hasM);\n    return {\n      attributes: t.readAttributes(),\n      geometry: i\n    };\n  }\n\n  getAggregate(e) {\n    return this.aggregateStore.getAggregate(e);\n  }\n\n  async setHighlight(e) {\n    const t = e.map(e => this.getDisplayId(e));\n    return this.attributeStore.setHighlight(e, t);\n  }\n\n  _lookupObjectIdByGlobalId(e) {\n    const t = this.service.globalIdField;\n    if (r(t)) throw new Error(\"Expected globalIdField to be defined\");\n    let s = null;\n    if (this.featureStore.forEach(r => {\n      e === r.readAttribute(t) && (s = r.getObjectId());\n    }), r(s)) throw new Error(`Expected to find a feature with globalId ${e}`);\n    return s;\n  }\n\n  _repushCurrentLevelTiles() {\n    const e = this.tileStore.tiles.filter(e => e.level === this._level);\n\n    for (const t of e) this._patchTile({\n      type: \"append\",\n      id: t.key.id,\n      addOrUpdate: v.fromOptimizedFeatures([], this.service.geometryType),\n      remove: [],\n      end: !0,\n      status: b.empty()\n    });\n  }\n\n  _maybeForceCleanup() {\n    performance.now() - this._lastCleanup > w && this._markAndSweep();\n  }\n\n  _patchTile(e, t) {\n    const s = this._updateQueue.push(e, t).then(() => {\n      this.notifyChange(\"updating\");\n    }).catch(e => {\n      this.notifyChange(\"updating\");\n    });\n\n    return this.notifyChange(\"updating\"), s;\n  }\n\n  async _onTileMessage(e, t) {\n    o(t);\n    const s = this.tileStore.get(e.id);\n    if (!s) return;\n    if (e.clear) return this.processor.onTileClear(s);\n    const i = e.status;\n    this._cleanupNeeded = !0;\n    const a = [];\n\n    for (const r of e.remove) {\n      const e = this.featureStore.lookupDisplayId(r);\n      e && a.push(e);\n    }\n\n    e.remove = a;\n\n    try {\n      if (r(e.addOrUpdate)) return void this.processor.onTileMessage(s, { ...e,\n        addOrUpdate: null\n      }, this.hasAggregates, t).catch(n);\n\n      if (e.addOrUpdate.setArcadeSpatialReference(this.spatialReference), this.featureStore.hasInstance(e.addOrUpdate.instance) && i.targets.feature || (i.targets.feature = !0, this.featureStore.onTileData(s, e)), !i.storage.data || !i.storage.filters) {\n        i.storage.data = !0, i.storage.filters = !0, this.attributeStore.onTileData(s, e);\n        \"geoevent\" === this._source.type || this._didEdit ? (await this.attributeStore.sendUpdates(), o(t)) : this.attributeStore.sendUpdates();\n      }\n\n      if (this.hasAggregates && !i.targets.aggregate) {\n        i.targets.aggregate = !0;\n\n        const t = F(this._source) && this._source.loading,\n              r = !F(this._source) || t || e.end;\n\n        if (this.aggregateStore.onTileData(s, e, this._storage, this.attributeStore, r), !r) return;\n        i.mesh || (this.attributeStore.onTileData(s, e), await this.attributeStore.sendUpdates(), this.processor.onTileClear(s));\n      }\n\n      i.mesh || (i.mesh = !0, await this.processor.onTileMessage(s, e, this.hasAggregates, t), o(t)), this._maybeForceCleanup();\n    } catch (u) {\n      n(u);\n    }\n  }\n\n  _mark(e, t, s) {\n    const r = (4294901760 & this._storage.getInstanceId(e)) >>> 16;\n    e && (t.add(r), s.set(e));\n  }\n\n  _markAndSweep() {\n    this._lastCleanup = performance.now();\n    if (!(!(\"feature\" === this._source.type && \"snapshot\" === this._source.mode) && (\"geoevent\" === this._source.type || this._cleanupNeeded))) return;\n    this._cleanupNeeded = !1;\n\n    const e = this._storage.getBitset(this._markedIdsBufId),\n          t = new Set();\n\n    e.clear();\n\n    for (const s of this.tileStore.tiles) for (const r of this._source.readers(s.id)) {\n      const s = r.getCursor();\n\n      for (; s.next();) {\n        let r = s.getDisplayId();\n\n        if (!r) {\n          const e = s.getObjectId();\n          r = this.featureStore.lookupDisplayId(e);\n        }\n\n        this._mark(r, t, e);\n      }\n    }\n\n    this._updateQueue.forEach(s => {\n      for (const r of s.remove) {\n        const s = this.featureStore.lookupDisplayId(r);\n\n        this._mark(s, t, e);\n      }\n    }), this.config.schema.targets.aggregate && (this.aggregateStore.sweepFeatures(e, this.featureStore), this.aggregateStore.sweepClusters(this._storage, this.attributeStore, this._level)), this.featureStore.sweepFeatures(e, this._storage, this.attributeStore), this.featureStore.sweepFeatureSets(t);\n  }\n\n};\ne([d({\n  constructOnly: !0\n})], R.prototype, \"tileStore\", void 0), e([d()], R.prototype, \"config\", void 0), e([d({\n  readOnly: !0\n})], R.prototype, \"fieldsIndex\", null), e([d()], R.prototype, \"processor\", void 0), e([d({\n  constructOnly: !0\n})], R.prototype, \"remoteClient\", void 0), e([d({\n  constructOnly: !0\n})], R.prototype, \"service\", void 0), e([d()], R.prototype, \"spatialReference\", null), e([d()], R.prototype, \"updating\", null), R = e([c(\"esri.views.2d.layers.features.controllers.FeatureController2D\")], R);\nvar O = R;\nexport default O;","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/2d/layers/features/controllers/FeatureController2D.js"],"names":["_","e","HandleOwner","t","s","isNone","r","ignoreAbortErrors","i","after","a","throwIfAborted","o","throwIfNotAbortError","n","isAbortError","u","whenFalseOnce","h","property","d","subclass","c","convertToGeometry","l","p","g","FeatureStore2D","f","createSource","y","m","ClusterStore","ComputedAttributeStorage","S","FeatureSetReaderJSON","v","UpdateToken","b","QueueProcessor","I","w","C","j","E","T","name","k","F","type","mode","R","constructor","arguments","_storage","_markedIdsBufId","createBitset","_lastCleanup","performance","now","_cleanupNeeded","_invalidated","_tileToResolver","Map","_didEdit","tileStore","config","processor","remoteClient","service","initialize","_initAttributeStore","_initStores","_initQueryEngine","_initSource","_updateQueue","concurrency","_source","process","_onTileMessage","signal","handles","add","on","onTileUpdate","bind","watch","onIdle","_checkUpdating","setInterval","notifyChange","startup","tiles","forEach","subscribe","tileScheme","length","_patchTile","spatialReference","featureStore","_proxyEvents","events","invoke","propertyName","value","catch","event","attributes","centroid","geometry","attributeStore","invalidateResources","update","render","geometryInfo","geometryType","hasM","hasZ","fieldsIndex","fields","aggregateStore","valueRanges","queryEngine","destroy","definitionExpression","objectIdField","toJSON","cacheSpatialQueries","aggregateAdapter","getFeatureObjectIds","getFeatureDisplayIdsForAggregate","map","getObjectId","timeInfo","clearInterval","hasAggregates","schema","targets","aggregate","updating","isUpdating","enableEvent","pause","clear","_set","_schema","Promise","all","source","updateSchema","feature","updateFilters","describe","applyUpdate","mesh","clearTiles","resume","onEdits","edits","console","debug","removed","objectId","_lookupObjectIdByGlobalId","globalId","addOrModified","invalidate","edit","resend","refresh","onTileClear","added","_level","level","unsubscribe","has","id","get","resolve","delete","_repushCurrentLevelTiles","_markAndSweep","querySummaryStatistics","query","params","executeQueryForSummaryStatistics","queryExtent","executeQueryForExtent","queryFeatures","executeQuery","queryFeatureCount","executeQueryForCount","queryLatestObservations","executeQueryForLatestObservations","queryObjectIds","executeQueryForIds","queryStatistics","storeStatistics","displayedFeatureCount","displayedVertexCount","displayPreProcessTime","lookupObjectId","getDisplayId","lookupDisplayId","getDisplayIdForReferenceId","getFeature","lookupFeatureByDisplayId","readHydratedGeometry","readAttributes","getAggregate","setHighlight","globalIdField","Error","readAttribute","filter","key","addOrUpdate","fromOptimizedFeatures","remove","end","status","empty","_maybeForceCleanup","push","then","onTileMessage","setArcadeSpatialReference","hasInstance","instance","onTileData","storage","data","filters","sendUpdates","loading","_mark","getInstanceId","set","getBitset","Set","readers","getCursor","next","sweepFeatures","sweepClusters","sweepFeatureSets","constructOnly","prototype","readOnly","O"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../../chunks/tslib.es6.js\";import{HandleOwner as t}from\"../../../../../core/HandleOwner.js\";import s from\"../../../../../core/has.js\";import{isNone as r}from\"../../../../../core/maybe.js\";import{ignoreAbortErrors as i,after as a,throwIfAborted as o,throwIfNotAbortError as n,isAbortError as u}from\"../../../../../core/promiseUtils.js\";import{whenFalseOnce as h}from\"../../../../../core/watchUtils.js\";import{property as d}from\"../../../../../core/accessorSupport/decorators/property.js\";import\"../../../../../core/accessorSupport/ensureType.js\";import\"../../../../../core/Logger.js\";import{subclass as c}from\"../../../../../core/accessorSupport/decorators/subclass.js\";import{convertToGeometry as l}from\"../../../../../layers/graphics/featureConversionUtils.js\";import p from\"../../../../../layers/graphics/data/QueryEngine.js\";import g from\"../../../../../layers/support/FieldsIndex.js\";import{FeatureStore2D as f}from\"../FeatureStore2D.js\";import{createSource as y}from\"../sources/createSource.js\";import m from\"../support/AttributeStore.js\";import{ClusterStore as _}from\"../support/ClusterStore.js\";import{ComputedAttributeStorage as S}from\"../support/ComputedAttributeStorage.js\";import{FeatureSetReaderJSON as v}from\"../support/FeatureSetReaderJSON.js\";import{UpdateToken as b}from\"../support/UpdateToken.js\";import{QueueProcessor as I}from\"../../../../support/QueueProcessor.js\";const w=5e3,C=\"tileRenderer.featuresView.attributeView.initialize\",j=\"tileRenderer.featuresView.attributeView.requestUpdate\",E=\"tileRenderer.featuresView.requestRender\";function T(e){return\"worker:port-closed\"===e.name}function k(e){if(!u(e)&&!T(e))throw e}function F(e){return\"feature\"===e.type&&\"snapshot\"===e.mode}let R=class extends t{constructor(){super(...arguments),this._storage=new S,this._markedIdsBufId=this._storage.createBitset(),this._lastCleanup=performance.now(),this._cleanupNeeded=!1,this._invalidated=!1,this._tileToResolver=new Map,this._didEdit=!1,this.tileStore=null,this.config=null,this.processor=null,this.remoteClient=null,this.service=null}initialize(){this._initAttributeStore(),this._initStores(),this._initQueryEngine(),this._initSource(),this._updateQueue=new I({concurrency:\"geoevent\"===this._source.type?1:4,process:(e,t)=>this._onTileMessage(e,{signal:t})}),this.handles.add([this.tileStore.on(\"update\",this.onTileUpdate.bind(this)),this.watch(\"updating\",(e=>!e&&this.onIdle()))]),this._checkUpdating=setInterval((()=>this.notifyChange(\"updating\")),300)}async startup(){this._initAttributeStore(),this.tileStore.tiles.forEach((e=>this._source.subscribe(e)))}_initSource(){const e=this.tileStore.tileScheme,t=()=>this._updateQueue.length<50,s=(e,t)=>(this._invalidated=!0,this._patchTile(e,t));this._source=y(this.service,this.spatialReference,e,s,t,this.featureStore),this._proxyEvents()}_proxyEvents(){if(\"geoevent\"===this._source.type){const e=this._source.events;this.handles.add([e.on(\"connectionStatus\",(e=>this.remoteClient.invoke(\"setProperty\",{propertyName:\"connectionStatus\",value:e}).catch(k))),e.on(\"errorString\",(e=>this.remoteClient.invoke(\"setProperty\",{propertyName:\"errorString\",value:e}).catch(k))),e.on(\"feature\",(e=>this.remoteClient.invoke(\"emitEvent\",{name:\"data-received\",event:{attributes:e.attributes,centroid:e.centroid,geometry:e.geometry}}).catch(k))),e.on(\"updateRate\",(e=>this.remoteClient.invoke(\"emitEvent\",{name:\"update-rate\",event:{...e}}).catch(k)))])}}_initAttributeStore(){this.attributeStore?this.attributeStore.invalidateResources():this.attributeStore=new m({type:\"remote\",initialize:(e,t)=>i(this.remoteClient.invoke(C,e,{signal:t}).catch(k)),update:(e,t)=>i(this.remoteClient.invoke(j,e,{signal:t}).catch(k)),render:e=>i(this.remoteClient.invoke(E,void 0,{signal:e}).catch(k))},this.config)}_initStores(){const e=\"snapshot\"===this.service.type?\"snapshot\":\"on-demand\",t={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields};this.featureStore=new f(t,this._storage,e),this.aggregateStore=new _(t,this.spatialReference,this._storage),this.handles.add(this.aggregateStore.events.on(\"valueRangesChanged\",(e=>{this.remoteClient.invoke(\"emitEvent\",{name:\"valueRangesChanged\",event:{valueRanges:e.valueRanges}}).catch(k)})))}_initQueryEngine(){var e;const t=this;null==(e=this.queryEngine)||e.destroy(),this.queryEngine=new p({definitionExpression:this.config.definitionExpression,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds:e=>t.aggregateStore.getFeatureDisplayIdsForAggregate(e).map((e=>t.getObjectId(e)))},timeInfo:this.service.timeInfo})}destroy(){this._updateQueue.destroy(),this._source.destroy(),this.queryEngine.destroy(),this.attributeStore&&this.attributeStore.destroy(),clearInterval(this._checkUpdating)}get fieldsIndex(){return new g(this.service.fields)}get hasAggregates(){return!!this.config.schema.targets.aggregate}get spatialReference(){return this.tileStore.tileScheme.spatialReference}get updating(){return this.isUpdating()}isUpdating(){return this._source.updating||!!this._updateQueue.length}enableEvent(e){this._source.enableEvent(e.name,e.value)}pause(){this._updateQueue.pause(),this._updateQueue.clear()}async update(e,t){this._set(\"config\",t),this._schema=t.schema,this._initQueryEngine(),await Promise.all([this._source.update(e,t.schema.source),this.featureStore.updateSchema(e,t.schema.targets.feature),this.attributeStore.update(e,t),this.attributeStore.updateFilters(e,this)]),await this.aggregateStore.updateSchema(e,t.schema.targets.aggregate),s(\"esri-2d-update-debug\")&&e.describe()}async applyUpdate(e){e.mesh&&this.clearTiles(),this._updateQueue.resume(),await this._source.applyUpdate(e),this.notifyChange(\"updating\"),await h(this,\"updating\",!0),this.hasAggregates&&(await a(10),await h(this,\"updating\",!0))}async onEdits({edits:e}){s(\"esri-2d-update-debug\")&&console.debug(\"Applying Edit:\",e),this._didEdit=!0;try{const t=e.removed.map((e=>e.objectId&&-1!==e.objectId?e.objectId:this._lookupObjectIdByGlobalId(e.globalId))),s=e.addOrModified.map((({objectId:e})=>e));this.featureStore.invalidate(),await this._source.edit(s,t),this.clearTiles(),this.notifyChange(\"updating\"),await this._source.resend(),await h(this,\"updating\",!0)}catch(t){}}async refresh(){this.featureStore.invalidate(),this.clearTiles(),this._source.refresh(),this._cleanupNeeded=!0,this.notifyChange(\"updating\"),await h(this,\"updating\",!0)}clearTiles(){for(const e of this.tileStore.tiles)this.processor.onTileClear(e)}onTileUpdate(e){this.aggregateStore.onTileUpdate(e);for(const t of e.added)this._source.subscribe(t),this._level=t.level;for(const t of e.removed)this._source.unsubscribe(t),this._cleanupNeeded=!0,this._tileToResolver.has(t.id)&&(this._tileToResolver.get(t.id).resolve(),this._tileToResolver.delete(t.id));this.notifyChange(\"updating\")}onIdle(){this._invalidated&&((this.hasAggregates||\"heatmap\"===this.processor.type)&&this._repushCurrentLevelTiles(),this._invalidated=!1),this._markAndSweep()}async querySummaryStatistics({query:e,params:t}){return this.queryEngine.executeQueryForSummaryStatistics(e,t)}queryExtent(e){return this.queryEngine.executeQueryForExtent(e)}queryFeatures(e){return this.queryEngine.executeQuery(e)}queryFeatureCount(e){return this.queryEngine.executeQueryForCount(e)}queryLatestObservations(e){return this.queryEngine.executeQueryForLatestObservations(e)}queryObjectIds(e){return this.queryEngine.executeQueryForIds(e)}async queryStatistics(){return{...this.featureStore.storeStatistics,displayedFeatureCount:0,displayedVertexCount:0,displayPreProcessTime:0}}getObjectId(e){return this.featureStore.lookupObjectId(e,this._storage)}getDisplayId(e){if(this._schema.targets.aggregate){const t=this.aggregateStore.getDisplayId(e);if(r(t)){const t=this.featureStore.lookupDisplayId(e);return this.aggregateStore.getDisplayIdForReferenceId(t)}return t}return this.featureStore.lookupDisplayId(e)}getFeature(e){const t=this.featureStore.lookupFeatureByDisplayId(e,this._storage);if(r(t))return null;const s=t.readHydratedGeometry(),i=l(s,t.geometryType,t.hasZ,t.hasM);return{attributes:t.readAttributes(),geometry:i}}getAggregate(e){return this.aggregateStore.getAggregate(e)}async setHighlight(e){const t=e.map((e=>this.getDisplayId(e)));return this.attributeStore.setHighlight(e,t)}_lookupObjectIdByGlobalId(e){const t=this.service.globalIdField;if(r(t))throw new Error(\"Expected globalIdField to be defined\");let s=null;if(this.featureStore.forEach((r=>{e===r.readAttribute(t)&&(s=r.getObjectId())})),r(s))throw new Error(`Expected to find a feature with globalId ${e}`);return s}_repushCurrentLevelTiles(){const e=this.tileStore.tiles.filter((e=>e.level===this._level));for(const t of e)this._patchTile({type:\"append\",id:t.key.id,addOrUpdate:v.fromOptimizedFeatures([],this.service.geometryType),remove:[],end:!0,status:b.empty()})}_maybeForceCleanup(){performance.now()-this._lastCleanup>w&&this._markAndSweep()}_patchTile(e,t){const s=this._updateQueue.push(e,t).then((()=>{this.notifyChange(\"updating\")})).catch((e=>{this.notifyChange(\"updating\")}));return this.notifyChange(\"updating\"),s}async _onTileMessage(e,t){o(t);const s=this.tileStore.get(e.id);if(!s)return;if(e.clear)return this.processor.onTileClear(s);const i=e.status;this._cleanupNeeded=!0;const a=[];for(const r of e.remove){const e=this.featureStore.lookupDisplayId(r);e&&a.push(e)}e.remove=a;try{if(r(e.addOrUpdate))return void this.processor.onTileMessage(s,{...e,addOrUpdate:null},this.hasAggregates,t).catch(n);if(e.addOrUpdate.setArcadeSpatialReference(this.spatialReference),this.featureStore.hasInstance(e.addOrUpdate.instance)&&i.targets.feature||(i.targets.feature=!0,this.featureStore.onTileData(s,e)),!i.storage.data||!i.storage.filters){i.storage.data=!0,i.storage.filters=!0,this.attributeStore.onTileData(s,e);\"geoevent\"===this._source.type||this._didEdit?(await this.attributeStore.sendUpdates(),o(t)):this.attributeStore.sendUpdates()}if(this.hasAggregates&&!i.targets.aggregate){i.targets.aggregate=!0;const t=F(this._source)&&this._source.loading,r=!F(this._source)||t||e.end;if(this.aggregateStore.onTileData(s,e,this._storage,this.attributeStore,r),!r)return;i.mesh||(this.attributeStore.onTileData(s,e),await this.attributeStore.sendUpdates(),this.processor.onTileClear(s))}i.mesh||(i.mesh=!0,await this.processor.onTileMessage(s,e,this.hasAggregates,t),o(t)),this._maybeForceCleanup()}catch(u){n(u)}}_mark(e,t,s){const r=(4294901760&this._storage.getInstanceId(e))>>>16;e&&(t.add(r),s.set(e))}_markAndSweep(){this._lastCleanup=performance.now();if(!(!(\"feature\"===this._source.type&&\"snapshot\"===this._source.mode)&&(\"geoevent\"===this._source.type||this._cleanupNeeded)))return;this._cleanupNeeded=!1;const e=this._storage.getBitset(this._markedIdsBufId),t=new Set;e.clear();for(const s of this.tileStore.tiles)for(const r of this._source.readers(s.id)){const s=r.getCursor();for(;s.next();){let r=s.getDisplayId();if(!r){const e=s.getObjectId();r=this.featureStore.lookupDisplayId(e)}this._mark(r,t,e)}}this._updateQueue.forEach((s=>{for(const r of s.remove){const s=this.featureStore.lookupDisplayId(r);this._mark(s,t,e)}})),this.config.schema.targets.aggregate&&(this.aggregateStore.sweepFeatures(e,this.featureStore),this.aggregateStore.sweepClusters(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(e,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(t)}};e([d({constructOnly:!0})],R.prototype,\"tileStore\",void 0),e([d()],R.prototype,\"config\",void 0),e([d({readOnly:!0})],R.prototype,\"fieldsIndex\",null),e([d()],R.prototype,\"processor\",void 0),e([d({constructOnly:!0})],R.prototype,\"remoteClient\",void 0),e([d({constructOnly:!0})],R.prototype,\"service\",void 0),e([d()],R.prototype,\"spatialReference\",null),e([d()],R.prototype,\"updating\",null),R=e([c(\"esri.views.2d.layers.features.controllers.FeatureController2D\")],R);var O=R;export default O;\n"]},"metadata":{},"sourceType":"module"}