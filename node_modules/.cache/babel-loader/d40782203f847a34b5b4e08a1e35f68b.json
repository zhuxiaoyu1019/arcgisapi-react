{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../chunks/tslib.es6.js\";\nimport t from \"../../request.js\";\nimport i from \"../../core/Accessor.js\";\nimport l from \"../../core/Error.js\";\nimport r from \"../../core/Handles.js\";\nimport s from \"../../core/Logger.js\";\nimport a from \"../../core/LRUCache.js\";\nimport o from \"../../core/PooledArray.js\";\nimport { onAbort as n, createAbortError as c, isAbortError as h, createAbortController as p, isAborted as m } from \"../../core/promiseUtils.js\";\nimport { waitTicks as u } from \"../../core/scheduling.js\";\nimport { objectToQuery as f } from \"../../core/urlUtils.js\";\nimport { init as v } from \"../../core/watchUtils.js\";\nimport { property as y } from \"../../core/accessorSupport/decorators/property.js\";\nimport \"../../core/has.js\";\nimport { cast as _ } from \"../../core/accessorSupport/decorators/cast.js\";\nimport { subclass as d } from \"../../core/accessorSupport/decorators/subclass.js\";\nimport { tilemapDefinitionId as b, Tilemap as g } from \"./Tilemap.js\";\nvar w;\nconst T = s.getLogger(\"esri.layers.support.TilemapCache\");\nlet j = w = class extends i {\n  constructor(e) {\n    super(e), this._handles = new r(), this._pendingTilemapRequests = {}, this._availableLevels = {}, this.levels = 5, this.cacheByteSize = 2097152, this.request = t, this._prefetchingEnabled = !0;\n  }\n\n  initialize() {\n    this._tilemapCache = new a(this.cacheByteSize), this._handles.add([this.watch([\"layer.parsedUrl\", \"layer.tileServers?\"], () => this._initializeTilemapDefinition()), v(this, \"layer.tileInfo.lods\", e => this._initializeAvailableLevels(e), !0)]), this._initializeTilemapDefinition();\n  }\n\n  destroy() {\n    this._handles && (this._handles.destroy(), this._handles = null);\n  }\n\n  castLevels(e) {\n    return e <= 2 ? (T.error(\"Minimum levels for Tilemap is 3, but got \", e), 3) : e;\n  }\n\n  get size() {\n    return 1 << this.levels;\n  }\n\n  fetchTilemap(e, t, i, r) {\n    if (!this._availableLevels[e]) return Promise.reject(new l(\"tilemap-cache:level-unavailable\", `Level ${e} is unavailable in the service`));\n\n    const s = this._tmpTilemapDefinition,\n          a = this._tilemapFromCache(e, t, i, s);\n\n    if (a) return Promise.resolve(a);\n    const o = r && r.signal;\n    return r = { ...r,\n      signal: null\n    }, new Promise((e, t) => {\n      n(o, () => t(c()));\n      const i = b(s);\n      let l = this._pendingTilemapRequests[i];\n\n      if (!l) {\n        l = g.fromDefinition(s, r).then(e => (this._tilemapCache.put(i, e, e.byteSize), e));\n\n        const e = () => delete this._pendingTilemapRequests[i];\n\n        this._pendingTilemapRequests[i] = l, l.then(e, e);\n      }\n\n      l.then(e, t);\n    });\n  }\n\n  getAvailability(e, t, i) {\n    if (!this._availableLevels[e]) return \"unavailable\";\n\n    const l = this._tilemapFromCache(e, t, i, this._tmpTilemapDefinition);\n\n    return l ? l.getAvailability(t, i) : \"unknown\";\n  }\n\n  getAvailabilityUpsample(e, t, i, l) {\n    l.level = e, l.row = t, l.col = i;\n    const r = this.layer.tileInfo;\n\n    for (r.updateTileInfo(l);;) {\n      const e = this.getAvailability(l.level, l.row, l.col);\n      if (\"unavailable\" !== e) return e;\n      if (!r.upsampleTile(l)) return \"unavailable\";\n    }\n  }\n\n  fetchAvailability(e, t, i, r) {\n    return this._availableLevels[e] ? this.fetchTilemap(e, t, i, r).catch(e => e).then(r => {\n      if (r instanceof g) {\n        const s = r.getAvailability(t, i);\n        return \"unavailable\" === s ? Promise.reject(new l(\"tile-map:tile-unavailable\", \"Tile is not available\", {\n          level: e,\n          row: t,\n          col: i\n        })) : s;\n      }\n\n      if (h(r)) throw r;\n      return \"unknown\";\n    }) : Promise.reject(new l(\"tilemap-cache:level-unavailable\", `Level ${e} is unavailable in the service`));\n  }\n\n  fetchAvailabilityUpsample(e, t, i, l, r) {\n    l.level = e, l.row = t, l.col = i;\n    const s = this.layer.tileInfo;\n    s.updateTileInfo(l);\n    const a = this.fetchAvailability(e, t, i, r).catch(e => {\n      if (h(e)) throw e;\n      if (s.upsampleTile(l)) return this.fetchAvailabilityUpsample(l.level, l.row, l.col, l);\n      throw e;\n    });\n    return this._fetchAvailabilityUpsamplePrefetch(l.id, e, t, i, r, a), a;\n  }\n\n  async _fetchAvailabilityUpsamplePrefetch(e, t, i, l, r, s) {\n    if (!this._prefetchingEnabled) return;\n    const a = `prefetch-${e}`;\n    if (this._handles.has(a)) return;\n    const o = p();\n    s.then(() => o.abort(), () => o.abort());\n    let n = !1;\n    const c = {\n      remove() {\n        n || (n = !0, o.abort());\n      }\n\n    };\n    if (this._handles.add(c, a), await u(10, o.signal).catch(() => {}), n || (n = !0, this._handles.remove(a)), m(o)) return;\n    const h = {\n      id: e,\n      level: t,\n      row: i,\n      col: l\n    },\n          f = { ...r,\n      signal: o.signal\n    },\n          v = this.layer.tileInfo;\n\n    for (let p = 0; w._prefetches.length < w._maxPrefetch && v.upsampleTile(h); ++p) {\n      const e = this.fetchAvailability(h.level, h.row, h.col, f);\n\n      w._prefetches.push(e);\n\n      const t = () => {\n        w._prefetches.removeUnordered(e);\n      };\n\n      e.then(t, t);\n    }\n  }\n\n  _initializeTilemapDefinition() {\n    if (!this.layer.parsedUrl) return;\n    const e = this.layer.parsedUrl,\n          t = e.query;\n    this._tilemapCache.clear(), this._tmpTilemapDefinition = {\n      service: {\n        url: e.path,\n        query: t ? f(t) : null,\n        tileServers: this.layer.tileServers,\n        request: this.request,\n        type: this.layer.type\n      },\n      width: this.size,\n      height: this.size,\n      level: 0,\n      row: 0,\n      col: 0\n    };\n  }\n\n  _tilemapFromCache(e, t, i, l) {\n    l.level = e, l.row = t - t % this.size, l.col = i - i % this.size;\n    const r = b(l);\n    return this._tilemapCache.get(r);\n  }\n\n  _initializeAvailableLevels(e) {\n    this._availableLevels = {}, e && e.forEach(e => this._availableLevels[e.level] = !0);\n  }\n\n  get test() {\n    const e = this;\n    return {\n      get prefetchingEnabled() {\n        return e._prefetchingEnabled;\n      },\n\n      set prefetchingEnabled(t) {\n        e._prefetchingEnabled = t;\n      },\n\n      hasTilemap: (t, i, l) => !!e._tilemapFromCache(t, i, l, e._tmpTilemapDefinition)\n    };\n  }\n\n};\nj._maxPrefetch = 4, j._prefetches = new o({\n  initialSize: w._maxPrefetch\n}), e([y({\n  constructOnly: !0,\n  type: Number\n})], j.prototype, \"levels\", void 0), e([_(\"levels\")], j.prototype, \"castLevels\", null), e([y({\n  readOnly: !0,\n  type: Number\n})], j.prototype, \"size\", null), e([y({\n  constructOnly: !0,\n  type: Number\n})], j.prototype, \"cacheByteSize\", void 0), e([y({\n  constructOnly: !0\n})], j.prototype, \"layer\", void 0), e([y({\n  constructOnly: !0\n})], j.prototype, \"request\", void 0), j = w = e([d(\"esri.layers.support.TilemapCache\")], j);\nexport { j as TilemapCache };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/layers/support/TilemapCache.js"],"names":["_","e","t","i","l","r","s","a","o","onAbort","n","createAbortError","c","isAbortError","h","createAbortController","p","isAborted","m","waitTicks","u","objectToQuery","f","init","v","property","y","cast","subclass","d","tilemapDefinitionId","b","Tilemap","g","w","T","getLogger","j","constructor","_handles","_pendingTilemapRequests","_availableLevels","levels","cacheByteSize","request","_prefetchingEnabled","initialize","_tilemapCache","add","watch","_initializeTilemapDefinition","_initializeAvailableLevels","destroy","castLevels","error","size","fetchTilemap","Promise","reject","_tmpTilemapDefinition","_tilemapFromCache","resolve","signal","fromDefinition","then","put","byteSize","getAvailability","getAvailabilityUpsample","level","row","col","layer","tileInfo","updateTileInfo","upsampleTile","fetchAvailability","catch","fetchAvailabilityUpsample","_fetchAvailabilityUpsamplePrefetch","id","has","abort","remove","_prefetches","length","_maxPrefetch","push","removeUnordered","parsedUrl","query","clear","service","url","path","tileServers","type","width","height","get","forEach","test","prefetchingEnabled","hasTilemap","initialSize","constructOnly","Number","prototype","readOnly","TilemapCache"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../chunks/tslib.es6.js\";import t from\"../../request.js\";import i from\"../../core/Accessor.js\";import l from\"../../core/Error.js\";import r from\"../../core/Handles.js\";import s from\"../../core/Logger.js\";import a from\"../../core/LRUCache.js\";import o from\"../../core/PooledArray.js\";import{onAbort as n,createAbortError as c,isAbortError as h,createAbortController as p,isAborted as m}from\"../../core/promiseUtils.js\";import{waitTicks as u}from\"../../core/scheduling.js\";import{objectToQuery as f}from\"../../core/urlUtils.js\";import{init as v}from\"../../core/watchUtils.js\";import{property as y}from\"../../core/accessorSupport/decorators/property.js\";import\"../../core/has.js\";import{cast as _}from\"../../core/accessorSupport/decorators/cast.js\";import{subclass as d}from\"../../core/accessorSupport/decorators/subclass.js\";import{tilemapDefinitionId as b,Tilemap as g}from\"./Tilemap.js\";var w;const T=s.getLogger(\"esri.layers.support.TilemapCache\");let j=w=class extends i{constructor(e){super(e),this._handles=new r,this._pendingTilemapRequests={},this._availableLevels={},this.levels=5,this.cacheByteSize=2097152,this.request=t,this._prefetchingEnabled=!0}initialize(){this._tilemapCache=new a(this.cacheByteSize),this._handles.add([this.watch([\"layer.parsedUrl\",\"layer.tileServers?\"],(()=>this._initializeTilemapDefinition())),v(this,\"layer.tileInfo.lods\",(e=>this._initializeAvailableLevels(e)),!0)]),this._initializeTilemapDefinition()}destroy(){this._handles&&(this._handles.destroy(),this._handles=null)}castLevels(e){return e<=2?(T.error(\"Minimum levels for Tilemap is 3, but got \",e),3):e}get size(){return 1<<this.levels}fetchTilemap(e,t,i,r){if(!this._availableLevels[e])return Promise.reject(new l(\"tilemap-cache:level-unavailable\",`Level ${e} is unavailable in the service`));const s=this._tmpTilemapDefinition,a=this._tilemapFromCache(e,t,i,s);if(a)return Promise.resolve(a);const o=r&&r.signal;return r={...r,signal:null},new Promise(((e,t)=>{n(o,(()=>t(c())));const i=b(s);let l=this._pendingTilemapRequests[i];if(!l){l=g.fromDefinition(s,r).then((e=>(this._tilemapCache.put(i,e,e.byteSize),e)));const e=()=>delete this._pendingTilemapRequests[i];this._pendingTilemapRequests[i]=l,l.then(e,e)}l.then(e,t)}))}getAvailability(e,t,i){if(!this._availableLevels[e])return\"unavailable\";const l=this._tilemapFromCache(e,t,i,this._tmpTilemapDefinition);return l?l.getAvailability(t,i):\"unknown\"}getAvailabilityUpsample(e,t,i,l){l.level=e,l.row=t,l.col=i;const r=this.layer.tileInfo;for(r.updateTileInfo(l);;){const e=this.getAvailability(l.level,l.row,l.col);if(\"unavailable\"!==e)return e;if(!r.upsampleTile(l))return\"unavailable\"}}fetchAvailability(e,t,i,r){return this._availableLevels[e]?this.fetchTilemap(e,t,i,r).catch((e=>e)).then((r=>{if(r instanceof g){const s=r.getAvailability(t,i);return\"unavailable\"===s?Promise.reject(new l(\"tile-map:tile-unavailable\",\"Tile is not available\",{level:e,row:t,col:i})):s}if(h(r))throw r;return\"unknown\"})):Promise.reject(new l(\"tilemap-cache:level-unavailable\",`Level ${e} is unavailable in the service`))}fetchAvailabilityUpsample(e,t,i,l,r){l.level=e,l.row=t,l.col=i;const s=this.layer.tileInfo;s.updateTileInfo(l);const a=this.fetchAvailability(e,t,i,r).catch((e=>{if(h(e))throw e;if(s.upsampleTile(l))return this.fetchAvailabilityUpsample(l.level,l.row,l.col,l);throw e}));return this._fetchAvailabilityUpsamplePrefetch(l.id,e,t,i,r,a),a}async _fetchAvailabilityUpsamplePrefetch(e,t,i,l,r,s){if(!this._prefetchingEnabled)return;const a=`prefetch-${e}`;if(this._handles.has(a))return;const o=p();s.then((()=>o.abort()),(()=>o.abort()));let n=!1;const c={remove(){n||(n=!0,o.abort())}};if(this._handles.add(c,a),await u(10,o.signal).catch((()=>{})),n||(n=!0,this._handles.remove(a)),m(o))return;const h={id:e,level:t,row:i,col:l},f={...r,signal:o.signal},v=this.layer.tileInfo;for(let p=0;w._prefetches.length<w._maxPrefetch&&v.upsampleTile(h);++p){const e=this.fetchAvailability(h.level,h.row,h.col,f);w._prefetches.push(e);const t=()=>{w._prefetches.removeUnordered(e)};e.then(t,t)}}_initializeTilemapDefinition(){if(!this.layer.parsedUrl)return;const e=this.layer.parsedUrl,t=e.query;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:e.path,query:t?f(t):null,tileServers:this.layer.tileServers,request:this.request,type:this.layer.type},width:this.size,height:this.size,level:0,row:0,col:0}}_tilemapFromCache(e,t,i,l){l.level=e,l.row=t-t%this.size,l.col=i-i%this.size;const r=b(l);return this._tilemapCache.get(r)}_initializeAvailableLevels(e){this._availableLevels={},e&&e.forEach((e=>this._availableLevels[e.level]=!0))}get test(){const e=this;return{get prefetchingEnabled(){return e._prefetchingEnabled},set prefetchingEnabled(t){e._prefetchingEnabled=t},hasTilemap:(t,i,l)=>!!e._tilemapFromCache(t,i,l,e._tmpTilemapDefinition)}}};j._maxPrefetch=4,j._prefetches=new o({initialSize:w._maxPrefetch}),e([y({constructOnly:!0,type:Number})],j.prototype,\"levels\",void 0),e([_(\"levels\")],j.prototype,\"castLevels\",null),e([y({readOnly:!0,type:Number})],j.prototype,\"size\",null),e([y({constructOnly:!0,type:Number})],j.prototype,\"cacheByteSize\",void 0),e([y({constructOnly:!0})],j.prototype,\"layer\",void 0),e([y({constructOnly:!0})],j.prototype,\"request\",void 0),j=w=e([d(\"esri.layers.support.TilemapCache\")],j);export{j as TilemapCache};\n"]},"metadata":{},"sourceType":"module"}