{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from \"../../../../../core/Error.js\";\nimport e from \"../../../../../core/has.js\";\nimport i from \"../../../../../core/Logger.js\";\nimport { clamp as s } from \"../../../../../core/mathUtils.js\";\nimport { isNone as r, isSome as a, mapMany as o, forEachSome as n, andThen as h, unwrap as l } from \"../../../../../core/maybe.js\";\nimport { createAbortController as c, createResolver as u, isAbortError as d } from \"../../../../../core/promiseUtils.js\";\nimport { diff as p } from \"../../../../../core/accessorSupport/diffUtils.js\";\nimport _ from \"../../../../../layers/support/FieldsIndex.js\";\nimport { MAX_FILTERS as f, HIGHLIGHT_FLAG as g, ATTRIBUTE_DATA_VV as m, NAN_MAGIC_NUMBER as y, ATTRIBUTE_DATA_ANIMATION as x } from \"../../../engine/webgl/definitions.js\";\nimport { getPixelArrayCtor as b } from \"../../../engine/webgl/Utils.js\";\nimport { createDebugLogger as z, DEBUG_ATTR_UPDATES as T } from \"../../../engine/webgl/util/debug.js\";\nimport { getVisualVariableSizeValueRepresentationRatio as S } from \"../tileRenderers/support/visualVariablesUtils.js\";\n\nconst w = i.getLogger(\"esri.views.layers.2d.features.support.AttributeStore\"),\n      A = z(T, w),\n      k = 2147483647,\n      D = 2147483648,\n      E = 254,\n      F = 255,\n      U = 0,\n      R = 1,\n      C = t => (t & D) >>> 31,\n      M = t => t & k,\n      B = t => C(t) === R ? E : F;\n\nfunction v(t) {\n  return C(t) === R;\n}\n\nconst j = {\n  sharedArrayBuffer: e(\"esri-shared-array-buffer\"),\n  atomics: e(\"esri-atomics\")\n};\n\nfunction I(t, e) {\n  return i => e(t(i));\n}\n\nclass P {\n  constructor(t, e, i, s) {\n    this.size = 0, this.texelSize = 4;\n    const {\n      pixelType: r,\n      layout: a,\n      textureOnly: o\n    } = s;\n    this.textureOnly = o || !1, this.pixelType = r, this._ctype = e, this.layout = a, this._resetRange(), this._shared = t, this.size = i, o || (this.data = this._initData(r, i, t, e));\n  }\n\n  get buffer() {\n    return h(this.data, t => t.buffer);\n  }\n\n  unsetComponentAllTexels(t, e) {\n    const i = l(this.data);\n\n    for (let s = 0; s < this.size * this.size; s++) i[s * this.texelSize + t] &= ~e;\n\n    this.dirtyStart = 0, this.dirtyEnd = this.size * this.size - 1;\n  }\n\n  setComponentAllTexels(t, e) {\n    const i = l(this.data);\n\n    for (let s = 0; s < this.size * this.size; s++) i[s * this.texelSize + t] |= 255 & e;\n\n    this.dirtyStart = 0, this.dirtyEnd = this.size * this.size - 1;\n  }\n\n  setComponent(t, e, i) {\n    const s = l(this.data);\n\n    for (const r of i) s[r * this.texelSize + t] |= e, this.dirtyStart = Math.min(this.dirtyStart, r), this.dirtyEnd = Math.max(this.dirtyEnd, r);\n  }\n\n  setComponentTexel(t, e, i) {\n    l(this.data)[i * this.texelSize + t] |= e, this.dirtyStart = Math.min(this.dirtyStart, i), this.dirtyEnd = Math.max(this.dirtyEnd, i);\n  }\n\n  unsetComponentTexel(t, e, i) {\n    l(this.data)[i * this.texelSize + t] &= ~e, this.dirtyStart = Math.min(this.dirtyStart, i), this.dirtyEnd = Math.max(this.dirtyEnd, i);\n  }\n\n  getData(t, e) {\n    const i = M(t);\n    return l(this.data)[i * this.texelSize + e];\n  }\n\n  setData(t, e, i) {\n    const s = M(t),\n          r = 1 << e;\n    0 != (this.layout & r) ? (this.data[s * this.texelSize + e] = i, this.dirtyStart = Math.min(this.dirtyStart, s), this.dirtyEnd = Math.max(this.dirtyEnd, s)) : w.error(\"mapview-attributes-store\", \"Tried to set a value for a texel's readonly component\");\n  }\n\n  lock() {\n    5121 === this.pixelType && this._shared && j.atomics && \"local\" !== this._ctype && Atomics.store(this.data, 0, 1);\n  }\n\n  unlock() {\n    5121 === this.pixelType && this._shared && j.atomics && \"local\" !== this._ctype && Atomics.store(this.data, 0, 0);\n  }\n\n  expand(t) {\n    if (this.size = t, !this.textureOnly) {\n      const e = this._initData(this.pixelType, t, this._shared, this._ctype),\n            i = l(this.data);\n\n      e.set(i), this.data = e;\n    }\n  }\n\n  toMessage() {\n    const t = this.dirtyStart,\n          e = this.dirtyEnd,\n          i = this.texelSize;\n    if (t > e) return null;\n\n    this._resetRange();\n\n    const s = !(this._shared || \"local\" === this._ctype),\n          r = this.pixelType,\n          a = this.layout,\n          o = l(this.data);\n    return {\n      start: t,\n      end: e,\n      data: s && o.slice(t * i, (e + 1) * i) || null,\n      pixelType: r,\n      layout: a\n    };\n  }\n\n  _initData(t, e, i, s) {\n    const r = i && \"local\" !== s ? SharedArrayBuffer : ArrayBuffer,\n          a = b(t),\n          o = new a(new r(e * e * 4 * a.BYTES_PER_ELEMENT));\n\n    for (let n = 0; n < o.length; n += 4) o[n + 1] = 255;\n\n    return o;\n  }\n\n  _resetRange() {\n    this.dirtyStart = 2147483647, this.dirtyEnd = 0;\n  }\n\n}\n\nclass O {\n  constructor(t, e) {\n    this._client = t, this.config = e, this._attributeComputeMap = new Map(), this._blocks = new Array(), this._filters = new Array(f), this._targetType = 0, this._abortController = c(), this._hasScaleExpr = !1, this._size = 32, this._idsToHighlight = new Set();\n    const i = e.supportsTextureFloat ? 5126 : 5121;\n    A(`Creating AttributeStore ${j.sharedArrayBuffer ? \"with\" : \"without\"} shared memory`), this._blockDescriptors = [{\n      pixelType: 5121,\n      layout: 1\n    }, {\n      pixelType: 5121,\n      layout: 15,\n      textureOnly: !0\n    }, {\n      pixelType: i,\n      layout: 15\n    }, {\n      pixelType: i,\n      layout: 15\n    }], this._blocks = this._blockDescriptors.map(() => null);\n  }\n\n  destroy() {\n    this._abortController.abort();\n  }\n\n  get hasScaleExpr() {\n    return this._hasScaleExpr;\n  }\n\n  get _signal() {\n    return this._abortController.signal;\n  }\n\n  update(t, i) {\n    this.config = i;\n    const s = i.schema.processors[0].storage,\n          o = p(this._schema, s);\n\n    if ((t.targets.feature || t.targets.aggregate) && (t.storage.data = !0), o && (e(\"esri-2d-update-debug\") && console.debug(\"Applying Update - AttributeStore:\", o), t.storage.data = !0, this._schema = s, this._attributeComputeMap.clear(), !r(s))) {\n      switch (s.target) {\n        case \"feature\":\n          this._targetType = U;\n          break;\n\n        case \"aggregate\":\n          this._targetType = R;\n      }\n\n      if (\"subtype\" === s.type) for (const t in s.mapping) {\n        const e = s.mapping[t];\n        if (a(e)) for (const t of e.mapping) this._bindAttribute(t);\n      } else for (const t of s.mapping) this._bindAttribute(t);\n    }\n  }\n\n  onTileData(t, e) {\n    if (r(e.addOrUpdate)) return;\n    const i = e.addOrUpdate.getCursor();\n\n    for (; i.next();) {\n      const t = i.getDisplayId();\n      this.setAttributeData(t, i);\n    }\n  }\n\n  invalidateResources() {\n    this._createResourcesPromise = null, this._abortController.abort(), this._abortController = c();\n  }\n\n  async setHighlight(t, e) {\n    const i = 1,\n          s = this._getBlock(0),\n          r = e.map(t => M(t));\n\n    s.lock(), s.unsetComponentAllTexels(0, i), s.setComponent(0, i, r), s.unlock(), this._idsToHighlight.clear();\n\n    for (const a of t) this._idsToHighlight.add(a);\n\n    await this.sendUpdates();\n  }\n\n  async updateFilters(t, i) {\n    const {\n      config: s,\n      service: r,\n      spatialReference: a\n    } = i,\n          {\n      filters: o\n    } = s,\n          n = o.map((t, e) => this._updateFilter(t, e, r, a));\n    (await Promise.all(n)).some(t => t) && (t.storage.filters = !0, e(\"esri-2d-update-debug\") && console.debug(\"Applying Update - AttributeStore:\", \"Filters changed\"));\n  }\n\n  setData(t, e, i, s) {\n    const r = M(t);\n    this._ensureSizeForTexel(r), this._getBlock(e).setData(t, i, s);\n  }\n\n  getData(t, e, i) {\n    return this._getBlock(e).getData(t, i);\n  }\n\n  getHighlightFlag(t) {\n    return this._idsToHighlight.has(t) ? g : 0;\n  }\n\n  unsetAttributeData(t) {\n    const e = M(t);\n\n    this._getBlock(0).setData(e, 0, 0);\n  }\n\n  setAttributeData(t, e) {\n    const i = M(t);\n    if (this._ensureSizeForTexel(i), this._getBlock(0).setData(i, 0, this.getFilterFlags(e)), this._targetType !== C(t)) return;\n    const r = this._attributeComputeMap,\n          a = this.config.supportsTextureFloat ? 1 : 2,\n          o = 4;\n    r.size && r.forEach((t, r) => {\n      const n = r * a % o,\n            h = Math.floor(r * a / o),\n            l = this._getBlock(h + m),\n            c = t(e);\n\n      if (this.config.supportsTextureFloat) l.setData(i, n, c);else if (c === y) l.setData(i, n, 255), l.setData(i, n + 1, 255);else {\n        const t = s(Math.round(c), -32767, 32766) + 32768,\n              e = 255 & t,\n              r = (65280 & t) >> 8;\n        l.setData(i, n, e), l.setData(i, n + 1, r);\n      }\n    });\n  }\n\n  sendUpdates() {\n    if (this._nextUpdate) return this._nextUpdate.promise;\n    if (this._currUpdate) return this._nextUpdate = u(), this._nextUpdate.promise;\n    const e = {\n      blocks: this._blocks.map(t => a(t) ? t.toMessage() : null)\n    };\n    return this._currUpdate = this._createResources().then(() => {\n      const t = () => {\n        if (this._currUpdate = null, this._nextUpdate) {\n          const t = this._nextUpdate;\n          this._nextUpdate = null, this.sendUpdates().then(() => t.resolve());\n        }\n      },\n            i = this._client.update(e, this._signal).then(t).catch(t);\n\n      return this._client.render(this._signal), i;\n    }).catch(e => d(e) ? (this._createResourcesPromise = null, this._createResources()) : (w.error(new t(\"mapview-attribute-store\", \"Encountered an error during client update\", e)), Promise.resolve())), this._currUpdate;\n  }\n\n  _ensureSizeForTexel(t) {\n    for (; t >= this._size * this._size;) if (this._expand()) return;\n  }\n\n  _bindAttribute(t) {\n    function e() {\n      return t.normalizationField ? e => {\n        const i = e.readAttribute(t.normalizationField);\n        if (!i) return null;\n        return e.readAttribute(t.field) / i;\n      } : e => e.readAttribute(t.field);\n    }\n\n    function i() {\n      return t.normalizationField && w.warn(\"mapview-arcade\", \"Ignoring normalizationField specified with an arcade expression which is not supported.\"), e => e.getComputedNumericAtIndex(t.fieldIndex);\n    }\n\n    let s;\n    if (null != t.fieldIndex) s = i();else {\n      if (!t.field) return;\n      s = e();\n    }\n\n    if (t.valueRepresentation) {\n      s = I(s, e => S(e, t.valueRepresentation));\n    }\n\n    const r = t => null === t || isNaN(t) || t === 1 / 0 ? y : t;\n\n    this._attributeComputeMap.set(t.binding, I(s, r));\n  }\n\n  _createResources() {\n    if (a(this._createResourcesPromise)) return this._createResourcesPromise;\n    this._getBlock(x), A(\"Initializing AttributeStore\");\n\n    const e = {\n      shared: j.sharedArrayBuffer && !(\"local\" === this._client.type),\n      size: this._size,\n      blocks: o(this._blocks, t => ({\n        textureOnly: t.textureOnly,\n        buffer: t.buffer,\n        pixelType: t.pixelType\n      }))\n    },\n          i = this._client.initialize(e, this._signal).catch(e => {\n      d(e) ? this._createResourcesPromise = null : w.error(new t(\"mapview-attribute-store\", \"Encountered an error during client initialization\", e));\n    });\n\n    return this._createResourcesPromise = i, i.then(() => r(this._createResourcesPromise) ? this._createResources() : void 0), i;\n  }\n\n  _getBlock(t) {\n    const e = this._blocks[t];\n    if (a(e)) return e;\n    A(`Initializing AttributeBlock at index ${t}`);\n    const i = j.sharedArrayBuffer,\n          s = this._client.type,\n          r = new P(i, s, this._size, this._blockDescriptors[t]);\n    return this._blocks[t] = r, this._createResourcesPromise = null, r;\n  }\n\n  _expand() {\n    if (this._size < this.config.maxTextureSize) {\n      const t = this._size <<= 1;\n      return A(\"Expanding block size to\", t, this._blocks), n(this._blocks, e => e.expand(t)), this._createResourcesPromise = null, this._size = t, 0;\n    }\n\n    return w.error(new t(\"mapview-limitations\", \"Maximum number of onscreen features exceeded.\")), -1;\n  }\n\n  async _updateFilter(t, e, i, s) {\n    const o = this._filters[e],\n          n = a(o) && o.hash;\n    if (!o && !t) return !1;\n    if (n === JSON.stringify(t)) return !1;\n\n    if (r(t)) {\n      if (!o) return !1;\n\n      const t = 1 << e + 1,\n            i = this._getBlock(0);\n\n      return this._filters[e] = null, i.setComponentAllTexels(0, t), this.sendUpdates(), !0;\n    }\n\n    const h = await this._getFilter(e, i);\n    return await h.update(t, s), !0;\n  }\n\n  async _getFilter(t, e) {\n    const i = this._filters[t];\n    if (a(i)) return i;\n    const {\n      default: s\n    } = await import(\"../../../../../layers/graphics/data/FeatureFilter.js\"),\n          r = new s({\n      geometryType: e.geometryType,\n      hasM: !1,\n      hasZ: !1,\n      timeInfo: e.timeInfo,\n      fieldsIndex: new _(e.fields)\n    });\n    return this._filters[t] = r, r;\n  }\n\n  isVisible(t) {\n    return !!(2 & this._getBlock(0).getData(t, 0));\n  }\n\n  getFilterFlags(t) {\n    let e = 0;\n    const i = B(t.getDisplayId());\n\n    for (let a = 0; a < this._filters.length; a++) {\n      const s = !!(i & 1 << a),\n            o = this._filters[a];\n      e |= (!s || r(o) || o.check(t) ? 1 : 0) << a;\n    }\n\n    let s = 0;\n\n    if (this._idsToHighlight.size) {\n      const e = t.getObjectId();\n      s = this.getHighlightFlag(e);\n    }\n\n    return e << 1 | s;\n  }\n\n}\n\nexport default O;\nexport { R as DISPLAY_ID_TYPE_AGGREGATE, U as DISPLAY_ID_TYPE_FEATURE, B as getDisplayIdFilterMask, M as getDisplayIdTexel, C as getDisplayIdType, v as isAggregateId };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/2d/layers/features/support/AttributeStore.js"],"names":["t","e","i","clamp","s","isNone","r","isSome","a","mapMany","o","forEachSome","n","andThen","h","unwrap","l","createAbortController","c","createResolver","u","isAbortError","d","diff","p","_","MAX_FILTERS","f","HIGHLIGHT_FLAG","g","ATTRIBUTE_DATA_VV","m","NAN_MAGIC_NUMBER","y","ATTRIBUTE_DATA_ANIMATION","x","getPixelArrayCtor","b","createDebugLogger","z","DEBUG_ATTR_UPDATES","T","getVisualVariableSizeValueRepresentationRatio","S","w","getLogger","A","k","D","E","F","U","R","C","M","B","v","j","sharedArrayBuffer","atomics","I","P","constructor","size","texelSize","pixelType","layout","textureOnly","_ctype","_resetRange","_shared","data","_initData","buffer","unsetComponentAllTexels","dirtyStart","dirtyEnd","setComponentAllTexels","setComponent","Math","min","max","setComponentTexel","unsetComponentTexel","getData","setData","error","lock","Atomics","store","unlock","expand","set","toMessage","start","end","slice","SharedArrayBuffer","ArrayBuffer","BYTES_PER_ELEMENT","length","O","_client","config","_attributeComputeMap","Map","_blocks","Array","_filters","_targetType","_abortController","_hasScaleExpr","_size","_idsToHighlight","Set","supportsTextureFloat","_blockDescriptors","map","destroy","abort","hasScaleExpr","_signal","signal","update","schema","processors","storage","_schema","targets","feature","aggregate","console","debug","clear","target","type","mapping","_bindAttribute","onTileData","addOrUpdate","getCursor","next","getDisplayId","setAttributeData","invalidateResources","_createResourcesPromise","setHighlight","_getBlock","add","sendUpdates","updateFilters","service","spatialReference","filters","_updateFilter","Promise","all","some","_ensureSizeForTexel","getHighlightFlag","has","unsetAttributeData","getFilterFlags","forEach","floor","round","_nextUpdate","promise","_currUpdate","blocks","_createResources","then","resolve","catch","render","_expand","normalizationField","readAttribute","field","warn","getComputedNumericAtIndex","fieldIndex","valueRepresentation","isNaN","binding","shared","initialize","maxTextureSize","hash","JSON","stringify","_getFilter","default","geometryType","hasM","hasZ","timeInfo","fieldsIndex","fields","isVisible","check","getObjectId","DISPLAY_ID_TYPE_AGGREGATE","DISPLAY_ID_TYPE_FEATURE","getDisplayIdFilterMask","getDisplayIdTexel","getDisplayIdType","isAggregateId"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport t from\"../../../../../core/Error.js\";import e from\"../../../../../core/has.js\";import i from\"../../../../../core/Logger.js\";import{clamp as s}from\"../../../../../core/mathUtils.js\";import{isNone as r,isSome as a,mapMany as o,forEachSome as n,andThen as h,unwrap as l}from\"../../../../../core/maybe.js\";import{createAbortController as c,createResolver as u,isAbortError as d}from\"../../../../../core/promiseUtils.js\";import{diff as p}from\"../../../../../core/accessorSupport/diffUtils.js\";import _ from\"../../../../../layers/support/FieldsIndex.js\";import{MAX_FILTERS as f,HIGHLIGHT_FLAG as g,ATTRIBUTE_DATA_VV as m,NAN_MAGIC_NUMBER as y,ATTRIBUTE_DATA_ANIMATION as x}from\"../../../engine/webgl/definitions.js\";import{getPixelArrayCtor as b}from\"../../../engine/webgl/Utils.js\";import{createDebugLogger as z,DEBUG_ATTR_UPDATES as T}from\"../../../engine/webgl/util/debug.js\";import{getVisualVariableSizeValueRepresentationRatio as S}from\"../tileRenderers/support/visualVariablesUtils.js\";const w=i.getLogger(\"esri.views.layers.2d.features.support.AttributeStore\"),A=z(T,w),k=2147483647,D=2147483648,E=254,F=255,U=0,R=1,C=t=>(t&D)>>>31,M=t=>t&k,B=t=>C(t)===R?E:F;function v(t){return C(t)===R}const j={sharedArrayBuffer:e(\"esri-shared-array-buffer\"),atomics:e(\"esri-atomics\")};function I(t,e){return i=>e(t(i))}class P{constructor(t,e,i,s){this.size=0,this.texelSize=4;const{pixelType:r,layout:a,textureOnly:o}=s;this.textureOnly=o||!1,this.pixelType=r,this._ctype=e,this.layout=a,this._resetRange(),this._shared=t,this.size=i,o||(this.data=this._initData(r,i,t,e))}get buffer(){return h(this.data,(t=>t.buffer))}unsetComponentAllTexels(t,e){const i=l(this.data);for(let s=0;s<this.size*this.size;s++)i[s*this.texelSize+t]&=~e;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponentAllTexels(t,e){const i=l(this.data);for(let s=0;s<this.size*this.size;s++)i[s*this.texelSize+t]|=255&e;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponent(t,e,i){const s=l(this.data);for(const r of i)s[r*this.texelSize+t]|=e,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)}setComponentTexel(t,e,i){l(this.data)[i*this.texelSize+t]|=e,this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,i)}unsetComponentTexel(t,e,i){l(this.data)[i*this.texelSize+t]&=~e,this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,i)}getData(t,e){const i=M(t);return l(this.data)[i*this.texelSize+e]}setData(t,e,i){const s=M(t),r=1<<e;0!=(this.layout&r)?(this.data[s*this.texelSize+e]=i,this.dirtyStart=Math.min(this.dirtyStart,s),this.dirtyEnd=Math.max(this.dirtyEnd,s)):w.error(\"mapview-attributes-store\",\"Tried to set a value for a texel's readonly component\")}lock(){5121===this.pixelType&&this._shared&&j.atomics&&\"local\"!==this._ctype&&Atomics.store(this.data,0,1)}unlock(){5121===this.pixelType&&this._shared&&j.atomics&&\"local\"!==this._ctype&&Atomics.store(this.data,0,0)}expand(t){if(this.size=t,!this.textureOnly){const e=this._initData(this.pixelType,t,this._shared,this._ctype),i=l(this.data);e.set(i),this.data=e}}toMessage(){const t=this.dirtyStart,e=this.dirtyEnd,i=this.texelSize;if(t>e)return null;this._resetRange();const s=!(this._shared||\"local\"===this._ctype),r=this.pixelType,a=this.layout,o=l(this.data);return{start:t,end:e,data:s&&o.slice(t*i,(e+1)*i)||null,pixelType:r,layout:a}}_initData(t,e,i,s){const r=i&&\"local\"!==s?SharedArrayBuffer:ArrayBuffer,a=b(t),o=new a(new r(e*e*4*a.BYTES_PER_ELEMENT));for(let n=0;n<o.length;n+=4)o[n+1]=255;return o}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}}class O{constructor(t,e){this._client=t,this.config=e,this._attributeComputeMap=new Map,this._blocks=new Array,this._filters=new Array(f),this._targetType=0,this._abortController=c(),this._hasScaleExpr=!1,this._size=32,this._idsToHighlight=new Set;const i=e.supportsTextureFloat?5126:5121;A(`Creating AttributeStore ${j.sharedArrayBuffer?\"with\":\"without\"} shared memory`),this._blockDescriptors=[{pixelType:5121,layout:1},{pixelType:5121,layout:15,textureOnly:!0},{pixelType:i,layout:15},{pixelType:i,layout:15}],this._blocks=this._blockDescriptors.map((()=>null))}destroy(){this._abortController.abort()}get hasScaleExpr(){return this._hasScaleExpr}get _signal(){return this._abortController.signal}update(t,i){this.config=i;const s=i.schema.processors[0].storage,o=p(this._schema,s);if((t.targets.feature||t.targets.aggregate)&&(t.storage.data=!0),o&&(e(\"esri-2d-update-debug\")&&console.debug(\"Applying Update - AttributeStore:\",o),t.storage.data=!0,this._schema=s,this._attributeComputeMap.clear(),!r(s))){switch(s.target){case\"feature\":this._targetType=U;break;case\"aggregate\":this._targetType=R}if(\"subtype\"===s.type)for(const t in s.mapping){const e=s.mapping[t];if(a(e))for(const t of e.mapping)this._bindAttribute(t)}else for(const t of s.mapping)this._bindAttribute(t)}}onTileData(t,e){if(r(e.addOrUpdate))return;const i=e.addOrUpdate.getCursor();for(;i.next();){const t=i.getDisplayId();this.setAttributeData(t,i)}}invalidateResources(){this._createResourcesPromise=null,this._abortController.abort(),this._abortController=c()}async setHighlight(t,e){const i=1,s=this._getBlock(0),r=e.map((t=>M(t)));s.lock(),s.unsetComponentAllTexels(0,i),s.setComponent(0,i,r),s.unlock(),this._idsToHighlight.clear();for(const a of t)this._idsToHighlight.add(a);await this.sendUpdates()}async updateFilters(t,i){const{config:s,service:r,spatialReference:a}=i,{filters:o}=s,n=o.map(((t,e)=>this._updateFilter(t,e,r,a)));(await Promise.all(n)).some((t=>t))&&(t.storage.filters=!0,e(\"esri-2d-update-debug\")&&console.debug(\"Applying Update - AttributeStore:\",\"Filters changed\"))}setData(t,e,i,s){const r=M(t);this._ensureSizeForTexel(r),this._getBlock(e).setData(t,i,s)}getData(t,e,i){return this._getBlock(e).getData(t,i)}getHighlightFlag(t){return this._idsToHighlight.has(t)?g:0}unsetAttributeData(t){const e=M(t);this._getBlock(0).setData(e,0,0)}setAttributeData(t,e){const i=M(t);if(this._ensureSizeForTexel(i),this._getBlock(0).setData(i,0,this.getFilterFlags(e)),this._targetType!==C(t))return;const r=this._attributeComputeMap,a=this.config.supportsTextureFloat?1:2,o=4;r.size&&r.forEach(((t,r)=>{const n=r*a%o,h=Math.floor(r*a/o),l=this._getBlock(h+m),c=t(e);if(this.config.supportsTextureFloat)l.setData(i,n,c);else if(c===y)l.setData(i,n,255),l.setData(i,n+1,255);else{const t=s(Math.round(c),-32767,32766)+32768,e=255&t,r=(65280&t)>>8;l.setData(i,n,e),l.setData(i,n+1,r)}}))}sendUpdates(){if(this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=u(),this._nextUpdate.promise;const e={blocks:this._blocks.map((t=>a(t)?t.toMessage():null))};return this._currUpdate=this._createResources().then((()=>{const t=()=>{if(this._currUpdate=null,this._nextUpdate){const t=this._nextUpdate;this._nextUpdate=null,this.sendUpdates().then((()=>t.resolve()))}},i=this._client.update(e,this._signal).then(t).catch(t);return this._client.render(this._signal),i})).catch((e=>d(e)?(this._createResourcesPromise=null,this._createResources()):(w.error(new t(\"mapview-attribute-store\",\"Encountered an error during client update\",e)),Promise.resolve()))),this._currUpdate}_ensureSizeForTexel(t){for(;t>=this._size*this._size;)if(this._expand())return}_bindAttribute(t){function e(){return t.normalizationField?e=>{const i=e.readAttribute(t.normalizationField);if(!i)return null;return e.readAttribute(t.field)/i}:e=>e.readAttribute(t.field)}function i(){return t.normalizationField&&w.warn(\"mapview-arcade\",\"Ignoring normalizationField specified with an arcade expression which is not supported.\"),e=>e.getComputedNumericAtIndex(t.fieldIndex)}let s;if(null!=t.fieldIndex)s=i();else{if(!t.field)return;s=e()}if(t.valueRepresentation){s=I(s,(e=>S(e,t.valueRepresentation)))}const r=t=>null===t||isNaN(t)||t===1/0?y:t;this._attributeComputeMap.set(t.binding,I(s,r))}_createResources(){if(a(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(x),A(\"Initializing AttributeStore\");const e={shared:j.sharedArrayBuffer&&!(\"local\"===this._client.type),size:this._size,blocks:o(this._blocks,(t=>({textureOnly:t.textureOnly,buffer:t.buffer,pixelType:t.pixelType})))},i=this._client.initialize(e,this._signal).catch((e=>{d(e)?this._createResourcesPromise=null:w.error(new t(\"mapview-attribute-store\",\"Encountered an error during client initialization\",e))}));return this._createResourcesPromise=i,i.then((()=>r(this._createResourcesPromise)?this._createResources():void 0)),i}_getBlock(t){const e=this._blocks[t];if(a(e))return e;A(`Initializing AttributeBlock at index ${t}`);const i=j.sharedArrayBuffer,s=this._client.type,r=new P(i,s,this._size,this._blockDescriptors[t]);return this._blocks[t]=r,this._createResourcesPromise=null,r}_expand(){if(this._size<this.config.maxTextureSize){const t=this._size<<=1;return A(\"Expanding block size to\",t,this._blocks),n(this._blocks,(e=>e.expand(t))),this._createResourcesPromise=null,this._size=t,0}return w.error(new t(\"mapview-limitations\",\"Maximum number of onscreen features exceeded.\")),-1}async _updateFilter(t,e,i,s){const o=this._filters[e],n=a(o)&&o.hash;if(!o&&!t)return!1;if(n===JSON.stringify(t))return!1;if(r(t)){if(!o)return!1;const t=1<<e+1,i=this._getBlock(0);return this._filters[e]=null,i.setComponentAllTexels(0,t),this.sendUpdates(),!0}const h=await this._getFilter(e,i);return await h.update(t,s),!0}async _getFilter(t,e){const i=this._filters[t];if(a(i))return i;const{default:s}=await import(\"../../../../../layers/graphics/data/FeatureFilter.js\"),r=new s({geometryType:e.geometryType,hasM:!1,hasZ:!1,timeInfo:e.timeInfo,fieldsIndex:new _(e.fields)});return this._filters[t]=r,r}isVisible(t){return!!(2&this._getBlock(0).getData(t,0))}getFilterFlags(t){let e=0;const i=B(t.getDisplayId());for(let a=0;a<this._filters.length;a++){const s=!!(i&1<<a),o=this._filters[a];e|=(!s||r(o)||o.check(t)?1:0)<<a}let s=0;if(this._idsToHighlight.size){const e=t.getObjectId();s=this.getHighlightFlag(e)}return e<<1|s}}export default O;export{R as DISPLAY_ID_TYPE_AGGREGATE,U as DISPLAY_ID_TYPE_FEATURE,B as getDisplayIdFilterMask,M as getDisplayIdTexel,C as getDisplayIdType,v as isAggregateId};\n"]},"metadata":{},"sourceType":"module"}