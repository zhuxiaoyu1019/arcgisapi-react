{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isSome as o } from \"../../../../../core/maybe.js\";\nimport { FADE_DURATION as e } from \"./config.js\";\n\nfunction t(o, e) {\n  if (o.priority - e.priority) return o.priority - e.priority;\n  const t = o.tile.key,\n        i = e.tile.key;\n  return t.world - i.world ? t.world - i.world : t.level - i.level ? t.level - i.level : t.row - i.row ? t.row - i.row : t.col - i.col ? t.col - i.col : o.xTile - e.xTile ? o.xTile - e.xTile : o.yTile - e.yTile;\n}\n\nclass i {\n  constructor(o, e, t, i, s, r) {\n    this._visibleTiles = o, this._symbolRepository = e, this._createCollisionJob = t, this._assignTileSymbolsOpacity = i, this._symbolLayerSorter = s, this._isLayerVisible = r, this._selectionJob = null, this._selectionJobCompleted = !1, this._collisionJob = null, this._collisionJobCompleted = !1, this._opacityJob = null, this._opacityJobCompleted = !1, this._running = !0;\n  }\n\n  get running() {\n    return this._running;\n  }\n\n  setScreenSize(o, e) {\n    this._screenWidth === o && this._screenHeight === e || this.restart(), this._screenWidth = o, this._screenHeight = e;\n  }\n\n  restart() {\n    this._selectionJob = null, this._selectionJobCompleted = !1, this._collisionJob = null, this._collisionJobCompleted = !1, this._opacityJob = null, this._opacityJobCompleted = !1, this._running = !0;\n  }\n\n  continue(o) {\n    if (this._selectionJob || (this._selectionJob = this._createSelectionJob()), !this._selectionJobCompleted) {\n      const e = performance.now();\n      if (!this._selectionJob.work(o)) return !1;\n      if (this._selectionJobCompleted = !0, 0 === (o = Math.max(0, o - (performance.now() - e)))) return !1;\n    }\n\n    if (this._collisionJob || (this._collisionJob = this._createCollisionJob(this._selectionJob.sortedSymbols, this._screenWidth, this._screenHeight)), !this._collisionJobCompleted) {\n      const e = performance.now();\n      if (!this._collisionJob.work(o)) return !1;\n      if (this._collisionJobCompleted = !0, 0 === (o = Math.max(0, o - (performance.now() - e)))) return !1;\n    }\n\n    if (this._opacityJob || (this._opacityJob = this._createOpacityJob()), !this._opacityJobCompleted) {\n      const e = performance.now();\n      if (!this._opacityJob.work(o)) return !1;\n      if (this._opacityJobCompleted = !0, 0 === (o = Math.max(0, o - (performance.now() - e)))) return !1;\n    }\n\n    return this._running = !1, !0;\n  }\n\n  _createSelectionJob() {\n    const o = this._symbolRepository.uniqueSymbols,\n          e = [];\n    let i = 0,\n        s = 0;\n    const r = this._isLayerVisible;\n\n    function n(n) {\n      let l;\n      const c = performance.now();\n\n      for (; s < o.length; s++, i = 0) {\n        const t = o[s],\n              h = t.styleLayerUID;\n\n        if (!r(h)) {\n          e[s] || (e[s] = {\n            styleLayerUID: h,\n            symbols: []\n          });\n          continue;\n        }\n\n        e[s] = e[s] || {\n          styleLayerUID: h,\n          symbols: []\n        };\n        const a = e[s];\n\n        for (; i < t.uniqueSymbols.length; i++) {\n          if (l = t.uniqueSymbols[i], i % 100 == 99 && performance.now() - c > n) return !1;\n          let o = null,\n              e = !1,\n              s = !1;\n\n          for (const t of l.tileSymbols) if (t.selectedForRendering = !1, !s || !e) {\n            const i = t.tile;\n            (!o || i.isCoverage || i.neededForCoverage && !e) && (o = t, (i.neededForCoverage || i.isCoverage) && (s = !0), i.isCoverage && (e = !0));\n          }\n\n          if (o.selectedForRendering = !0, s) {\n            a.symbols.push(o), l.show = !0;\n\n            for (const o of l.parts) o.show = !0;\n          } else l.show = !1;\n        }\n      }\n\n      for (const o of e) o.symbols.sort(t);\n\n      return !0;\n    }\n\n    const l = this._symbolLayerSorter;\n    return {\n      work: n,\n\n      get sortedSymbols() {\n        return e.sort(l);\n      }\n\n    };\n  }\n\n  _createOpacityJob() {\n    const e = this._assignTileSymbolsOpacity,\n          t = this._visibleTiles;\n    let i = 0;\n\n    function r(o, t) {\n      const i = o.symbols;\n\n      for (const [e, r] of i) s(r, t);\n\n      e(o, t);\n\n      for (const e of o.childrenTiles) r(e, t);\n    }\n\n    return {\n      work(e) {\n        const s = performance.now();\n\n        for (; i < t.length; i++) {\n          if (performance.now() - s > e) return !1;\n          const n = t[i];\n          if (o(n.parentTile)) continue;\n          r(n, performance.now());\n        }\n\n        return !0;\n      }\n\n    };\n  }\n\n}\n\nfunction s(o, t) {\n  for (const i of o) {\n    const o = i.unique;\n\n    for (const i of o.parts) {\n      const s = i.targetOpacity > .5 ? 1 : -1;\n      i.startOpacity += s * ((t - i.startTime) / e), i.startOpacity = Math.min(Math.max(i.startOpacity, 0), 1), i.startTime = t, i.targetOpacity = o.show && i.show ? 1 : 0;\n    }\n  }\n}\n\nexport { i as SymbolDeclutterer };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/2d/engine/vectorTiles/decluttering/SymbolDeclutterer.js"],"names":["isSome","o","FADE_DURATION","e","t","priority","tile","key","i","world","level","row","col","xTile","yTile","constructor","s","r","_visibleTiles","_symbolRepository","_createCollisionJob","_assignTileSymbolsOpacity","_symbolLayerSorter","_isLayerVisible","_selectionJob","_selectionJobCompleted","_collisionJob","_collisionJobCompleted","_opacityJob","_opacityJobCompleted","_running","running","setScreenSize","_screenWidth","_screenHeight","restart","continue","_createSelectionJob","performance","now","work","Math","max","sortedSymbols","_createOpacityJob","uniqueSymbols","n","l","c","length","h","styleLayerUID","symbols","a","tileSymbols","selectedForRendering","isCoverage","neededForCoverage","push","show","parts","sort","childrenTiles","parentTile","unique","targetOpacity","startOpacity","startTime","min","SymbolDeclutterer"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isSome as o}from\"../../../../../core/maybe.js\";import{FADE_DURATION as e}from\"./config.js\";function t(o,e){if(o.priority-e.priority)return o.priority-e.priority;const t=o.tile.key,i=e.tile.key;return t.world-i.world?t.world-i.world:t.level-i.level?t.level-i.level:t.row-i.row?t.row-i.row:t.col-i.col?t.col-i.col:o.xTile-e.xTile?o.xTile-e.xTile:o.yTile-e.yTile}class i{constructor(o,e,t,i,s,r){this._visibleTiles=o,this._symbolRepository=e,this._createCollisionJob=t,this._assignTileSymbolsOpacity=i,this._symbolLayerSorter=s,this._isLayerVisible=r,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}get running(){return this._running}setScreenSize(o,e){this._screenWidth===o&&this._screenHeight===e||this.restart(),this._screenWidth=o,this._screenHeight=e}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(o){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const e=performance.now();if(!this._selectionJob.work(o))return!1;if(this._selectionJobCompleted=!0,0===(o=Math.max(0,o-(performance.now()-e))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const e=performance.now();if(!this._collisionJob.work(o))return!1;if(this._collisionJobCompleted=!0,0===(o=Math.max(0,o-(performance.now()-e))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const e=performance.now();if(!this._opacityJob.work(o))return!1;if(this._opacityJobCompleted=!0,0===(o=Math.max(0,o-(performance.now()-e))))return!1}return this._running=!1,!0}_createSelectionJob(){const o=this._symbolRepository.uniqueSymbols,e=[];let i=0,s=0;const r=this._isLayerVisible;function n(n){let l;const c=performance.now();for(;s<o.length;s++,i=0){const t=o[s],h=t.styleLayerUID;if(!r(h)){e[s]||(e[s]={styleLayerUID:h,symbols:[]});continue}e[s]=e[s]||{styleLayerUID:h,symbols:[]};const a=e[s];for(;i<t.uniqueSymbols.length;i++){if(l=t.uniqueSymbols[i],i%100==99&&performance.now()-c>n)return!1;let o=null,e=!1,s=!1;for(const t of l.tileSymbols)if(t.selectedForRendering=!1,!s||!e){const i=t.tile;(!o||i.isCoverage||i.neededForCoverage&&!e)&&(o=t,(i.neededForCoverage||i.isCoverage)&&(s=!0),i.isCoverage&&(e=!0))}if(o.selectedForRendering=!0,s){a.symbols.push(o),l.show=!0;for(const o of l.parts)o.show=!0}else l.show=!1}}for(const o of e)o.symbols.sort(t);return!0}const l=this._symbolLayerSorter;return{work:n,get sortedSymbols(){return e.sort(l)}}}_createOpacityJob(){const e=this._assignTileSymbolsOpacity,t=this._visibleTiles;let i=0;function r(o,t){const i=o.symbols;for(const[e,r]of i)s(r,t);e(o,t);for(const e of o.childrenTiles)r(e,t)}return{work(e){const s=performance.now();for(;i<t.length;i++){if(performance.now()-s>e)return!1;const n=t[i];if(o(n.parentTile))continue;r(n,performance.now())}return!0}}}}function s(o,t){for(const i of o){const o=i.unique;for(const i of o.parts){const s=i.targetOpacity>.5?1:-1;i.startOpacity+=s*((t-i.startTime)/e),i.startOpacity=Math.min(Math.max(i.startOpacity,0),1),i.startTime=t,i.targetOpacity=o.show&&i.show?1:0}}}export{i as SymbolDeclutterer};\n"]},"metadata":{},"sourceType":"module"}