{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../chunks/tslib.es6.js\";\nimport { flatten as r } from \"../core/arrayUtils.js\";\nimport { isSome as s } from \"../core/maybe.js\";\nimport { eachAlwaysValues as i } from \"../core/promiseUtils.js\";\nimport \"../core/accessorSupport/decorators/property.js\";\nimport \"../core/has.js\";\nimport \"../core/accessorSupport/ensureType.js\";\nimport \"../core/Logger.js\";\nimport { subclass as p } from \"../core/accessorSupport/decorators/subclass.js\";\n\nconst a = a => {\n  let t = class extends a {\n    async fetchPopupFeatures(e, s) {\n      await this.when();\n\n      const {\n        location: p,\n        queryArea: a,\n        layerViewsAndGraphics: t,\n        clientOnlyGraphics: o\n      } = await this._prepareFetchPopupFeatures(e, s),\n            c = Promise.resolve(o),\n            n = this._queryLayerPopupFeatures({\n        queryArea: a,\n        layerViewsAndGraphics: t,\n        options: s\n      }),\n            l = n.map(e => e.promise);\n\n      return {\n        location: p,\n        clientOnlyGraphics: o,\n        allGraphicsPromise: i([c, ...l]).then(r),\n        promisesPerLayerView: n\n      };\n    }\n\n    _queryLayerPopupFeatures({\n      queryArea: e,\n      layerViewsAndGraphics: r,\n      options: i\n    }) {\n      return r.map(({\n        layerView: r,\n        graphics: p\n      }) => {\n        const a = {\n          clientGraphics: p,\n          event: s(i) ? i.event : null,\n          signal: s(i) ? i.signal : null,\n          defaultPopupTemplateEnabled: !!s(i) && !!i.defaultPopupTemplateEnabled\n        },\n              t = r.fetchPopupFeatures(e, a);\n        return {\n          layerView: r,\n          promise: t\n        };\n      });\n    }\n\n    _isValidPopupGraphic(e, r) {\n      return e && !!e.getEffectivePopupTemplate(s(r) && r.defaultPopupTemplateEnabled);\n    }\n\n    async _prepareFetchPopupFeatures(e, r) {\n      const {\n        clientGraphics: s,\n        queryArea: i,\n        location: p\n      } = await this._popupHitTestGraphics(e, r),\n            a = this._getFetchPopupLayerViews(),\n            {\n        layerViewsAndGraphics: t,\n        clientOnlyGraphics: o\n      } = this._graphicsPerFetchPopupLayerView(s, a);\n\n      return {\n        clientOnlyGraphics: o,\n        layerViewsAndGraphics: t,\n        queryArea: i,\n        location: p\n      };\n    }\n\n    async _popupHitTestGraphics(e, r) {\n      const {\n        results: s,\n        mapPoint: i\n      } = await this.popupHitTest(e),\n            p = s.filter(e => this._isValidPopupGraphic(e.graphic, r)),\n            a = p.length ? p[0].mapPoint : null;\n      return {\n        clientGraphics: p.map(e => e.graphic),\n        queryArea: i,\n        location: i || a\n      };\n    }\n\n    _getFetchPopupLayerViews() {\n      const e = [];\n      return this.allLayerViews.forEach(r => {\n        this._isValidPopupLayerView(r) && e.push(r);\n      }), s(this.graphicsView) && this._isValidPopupLayerView(this.graphicsView) && e.push(this.graphicsView), e.reverse();\n    }\n\n    _isValidPopupLayerView(e) {\n      return s(e) && (!(\"layer\" in e) || !e.suspended) && \"fetchPopupFeatures\" in e;\n    }\n\n    _graphicsPerFetchPopupLayerView(e, r) {\n      const s = [],\n            i = new Map(),\n            p = r.map(e => {\n        const r = [];\n        return \"layer\" in e ? i.set(e.layer, r) : i.set(e.graphics, r), {\n          layerView: e,\n          graphics: r\n        };\n      });\n\n      for (const a of e) {\n        const e = i.get(a.layer) || i.get(a.sourceLayer) || null;\n        e ? e.push(a) : s.push(a);\n      }\n\n      return {\n        layerViewsAndGraphics: p,\n        clientOnlyGraphics: s\n      };\n    }\n\n  };\n  return t = e([p(\"esri.views.PopupView\")], t), t;\n};\n\nexport { a as PopupView };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/PopupView.js"],"names":["_","e","flatten","r","isSome","s","eachAlwaysValues","i","subclass","p","a","t","fetchPopupFeatures","when","location","queryArea","layerViewsAndGraphics","clientOnlyGraphics","o","_prepareFetchPopupFeatures","c","Promise","resolve","n","_queryLayerPopupFeatures","options","l","map","promise","allGraphicsPromise","then","promisesPerLayerView","layerView","graphics","clientGraphics","event","signal","defaultPopupTemplateEnabled","_isValidPopupGraphic","getEffectivePopupTemplate","_popupHitTestGraphics","_getFetchPopupLayerViews","_graphicsPerFetchPopupLayerView","results","mapPoint","popupHitTest","filter","graphic","length","allLayerViews","forEach","_isValidPopupLayerView","push","graphicsView","reverse","suspended","Map","set","layer","get","sourceLayer","PopupView"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../chunks/tslib.es6.js\";import{flatten as r}from\"../core/arrayUtils.js\";import{isSome as s}from\"../core/maybe.js\";import{eachAlwaysValues as i}from\"../core/promiseUtils.js\";import\"../core/accessorSupport/decorators/property.js\";import\"../core/has.js\";import\"../core/accessorSupport/ensureType.js\";import\"../core/Logger.js\";import{subclass as p}from\"../core/accessorSupport/decorators/subclass.js\";const a=a=>{let t=class extends a{async fetchPopupFeatures(e,s){await this.when();const{location:p,queryArea:a,layerViewsAndGraphics:t,clientOnlyGraphics:o}=await this._prepareFetchPopupFeatures(e,s),c=Promise.resolve(o),n=this._queryLayerPopupFeatures({queryArea:a,layerViewsAndGraphics:t,options:s}),l=n.map((e=>e.promise));return{location:p,clientOnlyGraphics:o,allGraphicsPromise:i([c,...l]).then(r),promisesPerLayerView:n}}_queryLayerPopupFeatures({queryArea:e,layerViewsAndGraphics:r,options:i}){return r.map((({layerView:r,graphics:p})=>{const a={clientGraphics:p,event:s(i)?i.event:null,signal:s(i)?i.signal:null,defaultPopupTemplateEnabled:!!s(i)&&!!i.defaultPopupTemplateEnabled},t=r.fetchPopupFeatures(e,a);return{layerView:r,promise:t}}))}_isValidPopupGraphic(e,r){return e&&!!e.getEffectivePopupTemplate(s(r)&&r.defaultPopupTemplateEnabled)}async _prepareFetchPopupFeatures(e,r){const{clientGraphics:s,queryArea:i,location:p}=await this._popupHitTestGraphics(e,r),a=this._getFetchPopupLayerViews(),{layerViewsAndGraphics:t,clientOnlyGraphics:o}=this._graphicsPerFetchPopupLayerView(s,a);return{clientOnlyGraphics:o,layerViewsAndGraphics:t,queryArea:i,location:p}}async _popupHitTestGraphics(e,r){const{results:s,mapPoint:i}=await this.popupHitTest(e),p=s.filter((e=>this._isValidPopupGraphic(e.graphic,r))),a=p.length?p[0].mapPoint:null;return{clientGraphics:p.map((e=>e.graphic)),queryArea:i,location:i||a}}_getFetchPopupLayerViews(){const e=[];return this.allLayerViews.forEach((r=>{this._isValidPopupLayerView(r)&&e.push(r)})),s(this.graphicsView)&&this._isValidPopupLayerView(this.graphicsView)&&e.push(this.graphicsView),e.reverse()}_isValidPopupLayerView(e){return s(e)&&(!(\"layer\"in e)||!e.suspended)&&\"fetchPopupFeatures\"in e}_graphicsPerFetchPopupLayerView(e,r){const s=[],i=new Map,p=r.map((e=>{const r=[];return\"layer\"in e?i.set(e.layer,r):i.set(e.graphics,r),{layerView:e,graphics:r}}));for(const a of e){const e=i.get(a.layer)||i.get(a.sourceLayer)||null;e?e.push(a):s.push(a)}return{layerViewsAndGraphics:p,clientOnlyGraphics:s}}};return t=e([p(\"esri.views.PopupView\")],t),t};export{a as PopupView};\n"]},"metadata":{},"sourceType":"module"}