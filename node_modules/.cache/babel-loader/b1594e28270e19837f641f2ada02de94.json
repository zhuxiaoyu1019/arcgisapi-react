{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../chunks/tslib.es6.js\";\nimport \"../../../../geometry.js\";\nimport t from \"../../../../core/Accessor.js\";\nimport { indexOf as r, PositionHint as s } from \"../../../../core/arrayUtils.js\";\nimport n from \"../../../../core/Logger.js\";\nimport { isNone as i, isSome as o } from \"../../../../core/maybe.js\";\nimport { getUnitString as a } from \"../../../../core/unitUtils.js\";\nimport { whenOnce as c } from \"../../../../core/watchUtils.js\";\nimport { property as l } from \"../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../core/has.js\";\nimport \"../../../../core/accessorSupport/ensureType.js\";\nimport { subclass as p } from \"../../../../core/accessorSupport/decorators/subclass.js\";\nimport { t as u, b as f, s as d } from \"../../../../chunks/vec3.js\";\nimport { WhereClause as g } from \"../../../../core/sql/WhereClause.js\";\nimport { projectBoundingSphere as h, load as y, project as m, projectVectorToVector as j } from \"../../../../geometry/projection.js\";\nimport { create as b } from \"../../../../geometry/support/aaBoundingBox.js\";\nimport { fromValues as S, expandWithNestedArray as R, expand as w } from \"../../../../geometry/support/aaBoundingRect.js\";\nimport { canProject as F, project as E } from \"../../../../geometry/support/webMercatorUtils.js\";\nimport { objectIdFilter as I, filterInPlace as x } from \"./I3SUtil.js\";\nimport M from \"../../../layers/support/FeatureFilter.js\";\nimport _ from \"../../../../geometry/SpatialReference.js\";\nconst v = n.getLogger(\"esri.views.3d.layers.i3s.I3SMeshViewFilter\");\nlet O,\n    k = class extends t {\n  constructor(e) {\n    super(e), this._projectionEngineLoaded = !1;\n  }\n\n  initialize() {\n    c(this, \"filter.geometry\").then(() => this.loadAsyncModule(W().then(e => {\n      this.destroyed || (this._geometryEngine = e, this.applyFilters());\n    })));\n  }\n\n  get sortedObjectIds() {\n    if (i(this.filter.objectIds)) return null;\n    const e = new Float64Array(this.filter.objectIds);\n    return e.sort(), e;\n  }\n\n  get parsedWhereClause() {\n    const e = o(this.filter) ? this.filter.where : null;\n    if (i(e) || !e) return null;\n\n    try {\n      return g.create(e, this.layerFieldsIndex);\n    } catch (t) {\n      v.error(`Failed to parse filter where clause: ${t}`);\n    }\n\n    return null;\n  }\n\n  addFilters(e, t, r, s) {\n    const n = this.sortedObjectIds;\n    o(n) && e.push(e => I(n, !0, e)), this.addSqlFilter(e, this.parsedWhereClause);\n    const i = this.parsedGeometry;\n\n    if (o(i)) {\n      const n = this.spatialRelationship;\n      e.push((e, o) => T(e, o, s, t, r, i, n));\n    }\n  }\n\n  isMBSGeoemtryVisible(e, t, r) {\n    const s = this.parsedGeometry;\n\n    if (o(s)) {\n      const n = this.spatialRelationship,\n            i = s[0].spatialReference || t;\n      if (!h(e, r, V, i)) return v.warnOnce(\"SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS\"), !0;\n      return A(V, s, i, n);\n    }\n\n    return !0;\n  }\n\n  get parsedGeometry() {\n    if (i(this.filter)) return null;\n    if (!this._geometryEngine) return null;\n    const {\n      geometry: e\n    } = this.filter;\n    if (i(e)) return null;\n    const {\n      distance: t,\n      units: r\n    } = this.filter,\n          s = this.spatialRelationship,\n          n = \"mesh\" === e.type ? e.extent : e;\n    if (i(t) || 0 === t) return C(n, s);\n    const o = r || a(n.spatialReference);\n\n    if (n.spatialReference.isWGS84) {\n      return C(this._geometryEngine.geodesicBuffer(n, t, o), s);\n    }\n\n    if (F(n, _.WGS84)) {\n      return C(E(this._geometryEngine.geodesicBuffer(E(n, _.WGS84), t, o), n.spatialReference), s);\n    }\n\n    if (!this._projectionEngineLoaded && (this.loadAsyncModule(y().then(() => this._projectionEngineLoaded = !0)), !this._projectionEngineLoaded)) return null;\n    let c = null;\n\n    try {\n      c = m(n, _.WGS84);\n    } catch (l) {}\n\n    if (c) try {\n      c = m(this._geometryEngine.geodesicBuffer(c, t, o), n.spatialReference);\n    } catch (l) {\n      c = null;\n    }\n    return c || v.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${n.spatialReference.wkid}) to WGS84.`), C(c, s);\n  }\n\n  get spatialRelationship() {\n    return o(this.filter) ? this.filter.spatialRelationship : \"intersects\";\n  }\n\n  static checkSupport(e) {\n    return e.timeExtent ? (v.warn(\"Filters with a timeExtent are not supported for mesh scene layers\"), !1) : !!L(e.spatialRelationship) || (v.warn(`Filters with spatialRelationship other than ${B.join(\", \")} are not supported for mesh scene layers`), !1);\n  }\n\n};\n\nfunction G() {\n  return !!O;\n}\n\nasync function W() {\n  return G() || (O = await import(\"../../../../geometry/geometryEngine.js\")), O;\n}\n\ne([l({\n  type: M\n})], k.prototype, \"filter\", void 0), e([l()], k.prototype, \"layerFieldsIndex\", void 0), e([l()], k.prototype, \"loadAsyncModule\", void 0), e([l()], k.prototype, \"applyFilters\", void 0), e([l()], k.prototype, \"addSqlFilter\", void 0), e([l({\n  readOnly: !0\n})], k.prototype, \"sortedObjectIds\", null), e([l({\n  readOnly: !0\n})], k.prototype, \"parsedWhereClause\", null), e([l({\n  readOnly: !0\n})], k.prototype, \"parsedGeometry\", null), e([l({\n  readOnly: !0\n})], k.prototype, \"spatialRelationship\", null), e([l()], k.prototype, \"_projectionEngineLoaded\", void 0), e([l()], k.prototype, \"_geometryEngine\", void 0), k = e([p(\"esri.views.3d.layers.i3s.I3SMeshViewFilter\")], k);\n\nconst B = (e => e)([\"contains\", \"intersects\", \"disjoint\"]);\n\nfunction L(e) {\n  return null != e && B.indexOf(e) >= 0;\n}\n\nfunction C(e, t) {\n  if (!e) return null;\n\n  if (\"disjoint\" === t && \"polygon\" === e.type) {\n    const t = new Array(e.rings.length);\n\n    for (let r = 0; r < e.rings.length; ++r) {\n      const s = S(1 / 0, 1 / 0, -1 / 0, -1 / 0);\n      R(s, e.rings[r]), t[r] = {\n        type: \"polygon\",\n        rings: [e.rings[r]],\n        spatialReference: e.spatialReference,\n        aabr: s\n      };\n    }\n\n    t.sort((e, t) => e.aabr[0] - t.aabr[0]);\n    const n = new Set(),\n          i = new s();\n\n    for (let e = 0; e < t.length; ++e) {\n      const s = t[e];\n\n      for (let r = e + 1; r < t.length; ++r) {\n        const e = t[r];\n        if (e.aabr[0] >= s.aabr[2]) break;\n        n.add(e);\n      }\n\n      n.forEach(e => {\n        if (s !== e) if (e.aabr[2] <= s.aabr[0]) n.delete(e);else if (O.intersects(s, e)) {\n          s.rings = s.rings.concat(e.rings), w(s.aabr, e.aabr), delete s._geVersion, n.delete(e);\n          const o = r(t, e, t.length, i);\n          t.splice(o, 1);\n        }\n      }), n.add(s);\n    }\n\n    for (const e of t) delete e.aabr;\n\n    return t;\n  }\n\n  return [e];\n}\n\nfunction A(e, t, r, s) {\n  const n = q(e, r);\n  return t.every(e => 1 !== Z(e, n, s));\n}\n\nfunction T(e, t, r, s, n, i, o) {\n  const a = i[0].spatialReference || s.spatialReference;\n  if (!h(t.node.mbs, n, V, a)) return void v.warnOnce(\"SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter\");\n  const c = q(V, a),\n        l = U(o, s, a, r, t.objectHandle);\n\n  for (const p of i) {\n    if (0 === e.length) return;\n\n    switch (Z(p, c, o)) {\n      case 1:\n        return void (e.length = 0);\n\n      case 0:\n        continue;\n    }\n\n    x(e, t.featureIds, e => P(p, e, l));\n  }\n}\n\nconst V = [0, 0, 0, 0];\n\nfunction U(e, t, r, s, n) {\n  const i = t.renderSpatialReference,\n        o = new Map(),\n        a = {\n    rings: [[[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]]],\n    hasZ: !1,\n    hasM: !1,\n    type: \"polygon\",\n    spatialReference: r\n  };\n  a.rings[0][3] = a.rings[0][0];\n  const c = {\n    indices: null,\n    data: null,\n    stride: 0,\n    startIndex: 0,\n    endIndex: 0\n  };\n  let l, p;\n\n  switch (e) {\n    case \"intersects\":\n      l = (e, t) => O.intersects(e, t) ? 0 : 2, p = $;\n      break;\n\n    case \"contains\":\n      l = (e, t) => O.contains(e, t) ? 2 : 1, p = $;\n      break;\n\n    case \"disjoint\":\n    default:\n      l = (e, t) => O.disjoint(e, t) ? 2 : 1, p = z;\n  }\n\n  return {\n    collection: s,\n    object: n,\n    type: e,\n    maskSR: r,\n    renderSR: i,\n    aabbCache: o,\n    triangle: a,\n    positions: c,\n    triangleTest: l,\n    geometryTest: p\n  };\n}\n\nfunction q(e, t) {\n  const r = {\n    x: e[0],\n    y: e[1],\n    hasZ: !1,\n    hasM: !1,\n    type: \"point\",\n    spatialReference: t\n  },\n        s = !t.isWGS84 && !t.isWebMercator ? O.buffer(r, e[3], 1) : O.geodesicBuffer(r, e[3], 1);\n  return s.type = \"polygon\", s;\n}\n\nfunction Z(e, t, r) {\n  switch (r) {\n    case \"intersects\":\n    case \"contains\":\n      return $(e, t);\n\n    case \"disjoint\":\n      return z(e, t);\n  }\n}\n\nfunction $(e, t) {\n  return O.intersects(e, t) ? O.contains(e, t) ? 0 : 2 : 1;\n}\n\nfunction z(e, t) {\n  return O.intersects(e, t) ? O.contains(e, t) ? 1 : 2 : 0;\n}\n\nconst H = 2 ** -32;\n\nfunction P(e, t, r) {\n  const {\n    collection: s,\n    object: n,\n    renderSR: i,\n    maskSR: o,\n    geometryTest: a,\n    aabbCache: c\n  } = r;\n  let l = c.get(t);\n\n  if (!l) {\n    const e = s.getObjectTransform(n);\n    s.getComponentAabb(n, t, D);\n    const r = [[D[0], D[1], 0], [D[0], D[4], 0], [D[3], D[4], 0], [D[3], D[1], 0]];\n\n    for (let t = 0; t < 4; ++t) u(r[t], r[t], e.rotationScale), f(r[t], r[t], e.position), j(r[t], i, r[t], o);\n\n    l = {\n      rings: [r],\n      hasZ: !1,\n      hasM: !1,\n      type: \"polygon\",\n      spatialReference: o\n    }, l.rings[0][4] = l.rings[0][0], c.set(t, l);\n  }\n\n  switch (a(e, l)) {\n    case 1:\n      return !1;\n\n    case 0:\n      return !0;\n  }\n\n  const {\n    triangle: p,\n    triangleTest: g,\n    positions: h\n  } = r,\n        y = p.rings[0][0],\n        m = p.rings[0][1],\n        b = p.rings[0][2],\n        S = s.getObjectTransform(n);\n  s.getComponentPositions(n, t, h);\n  const {\n    indices: R,\n    data: w,\n    stride: F,\n    startIndex: E,\n    endIndex: I\n  } = h;\n\n  for (let x = E; x < I; x += 3) {\n    const t = F * R[x + 0],\n          r = F * R[x + 1],\n          s = F * R[x + 2];\n    d(y, w[t + 0], w[t + 1], w[t + 2]), d(m, w[r + 0], w[r + 1], w[r + 2]), d(b, w[s + 0], w[s + 1], w[s + 2]), u(y, y, S.rotationScale), u(m, m, S.rotationScale), u(b, b, S.rotationScale), f(y, y, S.position), f(m, m, S.position), f(b, b, S.position), j(y, i, y, o), j(m, i, m, o), j(b, i, b, o);\n    const n = m[0] - y[0],\n          a = m[1] - y[1],\n          c = b[0] - y[0],\n          l = b[1] - y[1];\n    if (!(Math.abs(n * l - a * c) < H)) switch (delete p._geVersion, g(e, p)) {\n      case 1:\n        return !1;\n\n      case 0:\n        return !0;\n    }\n  }\n\n  switch (r.type) {\n    case \"intersects\":\n      return !1;\n\n    case \"contains\":\n    case \"disjoint\":\n    default:\n      return !0;\n  }\n}\n\nconst D = b();\nexport { k as I3SMeshViewFilter };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/layers/i3s/I3SMeshViewFilter.js"],"names":["_","e","t","indexOf","r","PositionHint","s","n","isNone","i","isSome","o","getUnitString","a","whenOnce","c","property","l","subclass","p","u","b","f","d","WhereClause","g","projectBoundingSphere","h","load","y","project","m","projectVectorToVector","j","create","fromValues","S","expandWithNestedArray","R","expand","w","canProject","F","E","objectIdFilter","I","filterInPlace","x","M","v","getLogger","O","k","constructor","_projectionEngineLoaded","initialize","then","loadAsyncModule","W","destroyed","_geometryEngine","applyFilters","sortedObjectIds","filter","objectIds","Float64Array","sort","parsedWhereClause","where","layerFieldsIndex","error","addFilters","push","addSqlFilter","parsedGeometry","spatialRelationship","T","isMBSGeoemtryVisible","spatialReference","V","warnOnce","A","geometry","distance","units","type","extent","C","isWGS84","geodesicBuffer","WGS84","wkid","checkSupport","timeExtent","warn","L","B","join","G","prototype","readOnly","Array","rings","length","aabr","Set","add","forEach","delete","intersects","concat","_geVersion","splice","q","every","Z","node","mbs","U","objectHandle","featureIds","P","renderSpatialReference","Map","hasZ","hasM","indices","data","stride","startIndex","endIndex","$","contains","disjoint","z","collection","object","maskSR","renderSR","aabbCache","triangle","positions","triangleTest","geometryTest","isWebMercator","buffer","H","get","getObjectTransform","getComponentAabb","D","rotationScale","position","set","getComponentPositions","Math","abs","I3SMeshViewFilter"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../chunks/tslib.es6.js\";import\"../../../../geometry.js\";import t from\"../../../../core/Accessor.js\";import{indexOf as r,PositionHint as s}from\"../../../../core/arrayUtils.js\";import n from\"../../../../core/Logger.js\";import{isNone as i,isSome as o}from\"../../../../core/maybe.js\";import{getUnitString as a}from\"../../../../core/unitUtils.js\";import{whenOnce as c}from\"../../../../core/watchUtils.js\";import{property as l}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/ensureType.js\";import{subclass as p}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{t as u,b as f,s as d}from\"../../../../chunks/vec3.js\";import{WhereClause as g}from\"../../../../core/sql/WhereClause.js\";import{projectBoundingSphere as h,load as y,project as m,projectVectorToVector as j}from\"../../../../geometry/projection.js\";import{create as b}from\"../../../../geometry/support/aaBoundingBox.js\";import{fromValues as S,expandWithNestedArray as R,expand as w}from\"../../../../geometry/support/aaBoundingRect.js\";import{canProject as F,project as E}from\"../../../../geometry/support/webMercatorUtils.js\";import{objectIdFilter as I,filterInPlace as x}from\"./I3SUtil.js\";import M from\"../../../layers/support/FeatureFilter.js\";import _ from\"../../../../geometry/SpatialReference.js\";const v=n.getLogger(\"esri.views.3d.layers.i3s.I3SMeshViewFilter\");let O,k=class extends t{constructor(e){super(e),this._projectionEngineLoaded=!1}initialize(){c(this,\"filter.geometry\").then((()=>this.loadAsyncModule(W().then((e=>{this.destroyed||(this._geometryEngine=e,this.applyFilters())})))))}get sortedObjectIds(){if(i(this.filter.objectIds))return null;const e=new Float64Array(this.filter.objectIds);return e.sort(),e}get parsedWhereClause(){const e=o(this.filter)?this.filter.where:null;if(i(e)||!e)return null;try{return g.create(e,this.layerFieldsIndex)}catch(t){v.error(`Failed to parse filter where clause: ${t}`)}return null}addFilters(e,t,r,s){const n=this.sortedObjectIds;o(n)&&e.push((e=>I(n,!0,e))),this.addSqlFilter(e,this.parsedWhereClause);const i=this.parsedGeometry;if(o(i)){const n=this.spatialRelationship;e.push(((e,o)=>T(e,o,s,t,r,i,n)))}}isMBSGeoemtryVisible(e,t,r){const s=this.parsedGeometry;if(o(s)){const n=this.spatialRelationship,i=s[0].spatialReference||t;if(!h(e,r,V,i))return v.warnOnce(\"SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS\"),!0;return A(V,s,i,n)}return!0}get parsedGeometry(){if(i(this.filter))return null;if(!this._geometryEngine)return null;const{geometry:e}=this.filter;if(i(e))return null;const{distance:t,units:r}=this.filter,s=this.spatialRelationship,n=\"mesh\"===e.type?e.extent:e;if(i(t)||0===t)return C(n,s);const o=r||a(n.spatialReference);if(n.spatialReference.isWGS84){return C(this._geometryEngine.geodesicBuffer(n,t,o),s)}if(F(n,_.WGS84)){return C(E(this._geometryEngine.geodesicBuffer(E(n,_.WGS84),t,o),n.spatialReference),s)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule(y().then((()=>this._projectionEngineLoaded=!0))),!this._projectionEngineLoaded))return null;let c=null;try{c=m(n,_.WGS84)}catch(l){}if(c)try{c=m(this._geometryEngine.geodesicBuffer(c,t,o),n.spatialReference)}catch(l){c=null}return c||v.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${n.spatialReference.wkid}) to WGS84.`),C(c,s)}get spatialRelationship(){return o(this.filter)?this.filter.spatialRelationship:\"intersects\"}static checkSupport(e){return e.timeExtent?(v.warn(\"Filters with a timeExtent are not supported for mesh scene layers\"),!1):!!L(e.spatialRelationship)||(v.warn(`Filters with spatialRelationship other than ${B.join(\", \")} are not supported for mesh scene layers`),!1)}};function G(){return!!O}async function W(){return G()||(O=await import(\"../../../../geometry/geometryEngine.js\")),O}e([l({type:M})],k.prototype,\"filter\",void 0),e([l()],k.prototype,\"layerFieldsIndex\",void 0),e([l()],k.prototype,\"loadAsyncModule\",void 0),e([l()],k.prototype,\"applyFilters\",void 0),e([l()],k.prototype,\"addSqlFilter\",void 0),e([l({readOnly:!0})],k.prototype,\"sortedObjectIds\",null),e([l({readOnly:!0})],k.prototype,\"parsedWhereClause\",null),e([l({readOnly:!0})],k.prototype,\"parsedGeometry\",null),e([l({readOnly:!0})],k.prototype,\"spatialRelationship\",null),e([l()],k.prototype,\"_projectionEngineLoaded\",void 0),e([l()],k.prototype,\"_geometryEngine\",void 0),k=e([p(\"esri.views.3d.layers.i3s.I3SMeshViewFilter\")],k);const B=(e=>e)([\"contains\",\"intersects\",\"disjoint\"]);function L(e){return null!=e&&B.indexOf(e)>=0}function C(e,t){if(!e)return null;if(\"disjoint\"===t&&\"polygon\"===e.type){const t=new Array(e.rings.length);for(let r=0;r<e.rings.length;++r){const s=S(1/0,1/0,-1/0,-1/0);R(s,e.rings[r]),t[r]={type:\"polygon\",rings:[e.rings[r]],spatialReference:e.spatialReference,aabr:s}}t.sort(((e,t)=>e.aabr[0]-t.aabr[0]));const n=new Set,i=new s;for(let e=0;e<t.length;++e){const s=t[e];for(let r=e+1;r<t.length;++r){const e=t[r];if(e.aabr[0]>=s.aabr[2])break;n.add(e)}n.forEach((e=>{if(s!==e)if(e.aabr[2]<=s.aabr[0])n.delete(e);else if(O.intersects(s,e)){s.rings=s.rings.concat(e.rings),w(s.aabr,e.aabr),delete s._geVersion,n.delete(e);const o=r(t,e,t.length,i);t.splice(o,1)}})),n.add(s)}for(const e of t)delete e.aabr;return t}return[e]}function A(e,t,r,s){const n=q(e,r);return t.every((e=>1!==Z(e,n,s)))}function T(e,t,r,s,n,i,o){const a=i[0].spatialReference||s.spatialReference;if(!h(t.node.mbs,n,V,a))return void v.warnOnce(\"SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter\");const c=q(V,a),l=U(o,s,a,r,t.objectHandle);for(const p of i){if(0===e.length)return;switch(Z(p,c,o)){case 1:return void(e.length=0);case 0:continue}x(e,t.featureIds,(e=>P(p,e,l)))}}const V=[0,0,0,0];function U(e,t,r,s,n){const i=t.renderSpatialReference,o=new Map,a={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:\"polygon\",spatialReference:r};a.rings[0][3]=a.rings[0][0];const c={indices:null,data:null,stride:0,startIndex:0,endIndex:0};let l,p;switch(e){case\"intersects\":l=(e,t)=>O.intersects(e,t)?0:2,p=$;break;case\"contains\":l=(e,t)=>O.contains(e,t)?2:1,p=$;break;case\"disjoint\":default:l=(e,t)=>O.disjoint(e,t)?2:1,p=z}return{collection:s,object:n,type:e,maskSR:r,renderSR:i,aabbCache:o,triangle:a,positions:c,triangleTest:l,geometryTest:p}}function q(e,t){const r={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:\"point\",spatialReference:t},s=!t.isWGS84&&!t.isWebMercator?O.buffer(r,e[3],1):O.geodesicBuffer(r,e[3],1);return s.type=\"polygon\",s}function Z(e,t,r){switch(r){case\"intersects\":case\"contains\":return $(e,t);case\"disjoint\":return z(e,t)}}function $(e,t){return O.intersects(e,t)?O.contains(e,t)?0:2:1}function z(e,t){return O.intersects(e,t)?O.contains(e,t)?1:2:0}const H=2**-32;function P(e,t,r){const{collection:s,object:n,renderSR:i,maskSR:o,geometryTest:a,aabbCache:c}=r;let l=c.get(t);if(!l){const e=s.getObjectTransform(n);s.getComponentAabb(n,t,D);const r=[[D[0],D[1],0],[D[0],D[4],0],[D[3],D[4],0],[D[3],D[1],0]];for(let t=0;t<4;++t)u(r[t],r[t],e.rotationScale),f(r[t],r[t],e.position),j(r[t],i,r[t],o);l={rings:[r],hasZ:!1,hasM:!1,type:\"polygon\",spatialReference:o},l.rings[0][4]=l.rings[0][0],c.set(t,l)}switch(a(e,l)){case 1:return!1;case 0:return!0}const{triangle:p,triangleTest:g,positions:h}=r,y=p.rings[0][0],m=p.rings[0][1],b=p.rings[0][2],S=s.getObjectTransform(n);s.getComponentPositions(n,t,h);const{indices:R,data:w,stride:F,startIndex:E,endIndex:I}=h;for(let x=E;x<I;x+=3){const t=F*R[x+0],r=F*R[x+1],s=F*R[x+2];d(y,w[t+0],w[t+1],w[t+2]),d(m,w[r+0],w[r+1],w[r+2]),d(b,w[s+0],w[s+1],w[s+2]),u(y,y,S.rotationScale),u(m,m,S.rotationScale),u(b,b,S.rotationScale),f(y,y,S.position),f(m,m,S.position),f(b,b,S.position),j(y,i,y,o),j(m,i,m,o),j(b,i,b,o);const n=m[0]-y[0],a=m[1]-y[1],c=b[0]-y[0],l=b[1]-y[1];if(!(Math.abs(n*l-a*c)<H))switch(delete p._geVersion,g(e,p)){case 1:return!1;case 0:return!0}}switch(r.type){case\"intersects\":return!1;case\"contains\":case\"disjoint\":default:return!0}}const D=b();export{k as I3SMeshViewFilter};\n"]},"metadata":{},"sourceType":"module"}