{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { isNone as e, isSome as s } from \"../../../../../core/maybe.js\";\nimport { GridIndex as o, tileCoordChange as t } from \"./util.js\";\nconst l = 32,\n      i = 8,\n      n = 64;\n\nclass r {\n  constructor(e, s, o) {\n    this.tileCoordRange = e, this._visibleTiles = s, this._createUnique = o, this._tiles = new Map(), this._uniqueSymbolsReferences = new Map();\n  }\n\n  get uniqueSymbols() {\n    return e(this._uniqueSymbolLayerArray) && (this._uniqueSymbolLayerArray = this._createUniqueSymbolLayerArray()), this._uniqueSymbolLayerArray;\n  }\n\n  add(e, s) {\n    this._uniqueSymbolLayerArray = null;\n\n    let t = this._tiles.get(e.id);\n\n    t || (t = {\n      symbols: new Map()\n    }, this._tiles.set(e.id, t));\n    const r = new Map();\n    if (s) for (const o of s) t.symbols.has(o) && (r.set(o, t.symbols.get(o)), t.symbols.delete(o));else for (const [o, l] of e.layerData) t.symbols.has(o) && (r.set(o, t.symbols.get(o)), t.symbols.delete(o));\n\n    this._removeSymbols(r);\n\n    const y = e.symbols,\n          a = new Map();\n\n    for (const [f, c] of y) {\n      let e = c.length;\n\n      if (e >= l) {\n        let s = this.tileCoordRange;\n\n        do {\n          s /= 2, e /= 4;\n        } while (e > i && s > n);\n\n        const l = new o(this.tileCoordRange, this.tileCoordRange, s);\n        a.set(f, {\n          flat: c,\n          index: l\n        }), t.symbols.set(f, {\n          flat: c,\n          index: l\n        });\n\n        for (const e of c) l.getCell(e.xTile, e.yTile).push(e);\n      } else a.set(f, {\n        flat: c\n      }), t.symbols.set(f, {\n        flat: c\n      });\n    }\n\n    this._addSymbols(e.key, y);\n  }\n\n  deleteStyleLayers(e) {\n    this._uniqueSymbolLayerArray = null;\n\n    for (const [s, o] of this._tiles) {\n      const t = new Map();\n\n      for (const s of e) o.symbols.has(s) && (t.set(s, o.symbols.get(s)), o.symbols.delete(s));\n\n      this._removeSymbols(t), 0 === o.symbols.size && this._tiles.delete(s);\n    }\n  }\n\n  removeTile(e) {\n    this._uniqueSymbolLayerArray = null;\n\n    const s = this._tiles.get(e.id);\n\n    if (!s) return;\n    const o = new Map();\n\n    for (const [t, l] of e.symbols) s.symbols.has(t) && (o.set(t, s.symbols.get(t)), s.symbols.delete(t));\n\n    this._removeSymbols(o), 0 === s.symbols.size && this._tiles.delete(e.id);\n  }\n\n  _removeSymbols(e) {\n    for (const [s, {\n      flat: o\n    }] of e) for (const e of o) {\n      const o = e.unique,\n            t = o.tileSymbols,\n            l = t.length - 1;\n\n      for (let s = 0; s < l; s++) if (t[s] === e) {\n        t[s] = t[l];\n        break;\n      }\n\n      if (t.length = l, 0 === l) {\n        const e = this._uniqueSymbolsReferences.get(s);\n\n        e.delete(o), 0 === e.size && this._uniqueSymbolsReferences.delete(s);\n      }\n\n      e.unique = null;\n    }\n  }\n\n  _addSymbols(s, o) {\n    if (0 === o.size) return;\n    const t = this._visibleTiles;\n\n    for (const e of t) e.parentTile || e.key.world !== s.world || e.key.level === s.level && !e.key.equals(s) || this._matchSymbols(e, s, o);\n\n    for (const [l, i] of o) for (const s of i) if (e(s.unique)) {\n      const e = this._createUnique();\n\n      s.unique = e, e.tileSymbols.push(s);\n\n      let o = this._uniqueSymbolsReferences.get(l);\n\n      o || (o = new Set(), this._uniqueSymbolsReferences.set(l, o)), o.add(e);\n    }\n  }\n\n  _matchSymbols(e, o, l) {\n    if (e.key.level > o.level) {\n      const s = e.key.level - o.level;\n      if (e.key.row >> s !== o.row || e.key.col >> s !== o.col) return;\n    }\n\n    if (o.level > e.key.level) {\n      const s = o.level - e.key.level;\n      if (o.row >> s !== e.key.row || o.col >> s !== e.key.col) return;\n    }\n\n    if (o.equals(e.key)) {\n      for (const s of e.childrenTiles) this._matchSymbols(s, o, l);\n\n      return;\n    }\n\n    const i = new Map();\n\n    for (const [n, r] of l) {\n      const l = [];\n\n      for (const s of r) {\n        const i = t(this.tileCoordRange, s.xTile, o.level, o.col, e.key.level, e.key.col),\n              n = t(this.tileCoordRange, s.yTile, o.level, o.row, e.key.level, e.key.row);\n        i >= 0 && i < this.tileCoordRange && n >= 0 && n < this.tileCoordRange && l.push({\n          symbol: s,\n          xTransformed: i,\n          yTransformed: n\n        });\n      }\n\n      const y = [],\n            a = e.key.level < o.level ? 1 : 1 << e.key.level - o.level,\n            f = this._tiles.get(e.id).symbols.get(n);\n\n      if (f) {\n        const e = f.flat;\n\n        for (const o of l) {\n          let t,\n              l = !1;\n          const i = o.xTransformed,\n                n = o.yTransformed;\n          t = s(f.index) ? f.index.getCell(i, n) : e;\n          const r = o.symbol,\n                c = r.hash;\n\n          for (const e of t) if (c === e.hash && Math.abs(i - e.xTile) <= a && Math.abs(n - e.yTile) <= a) {\n            const s = e.unique;\n            r.unique = s, s.tileSymbols.push(r), l = !0;\n            break;\n          }\n\n          l || y.push(r);\n        }\n      }\n\n      y.length > 0 && i.set(n, y);\n    }\n\n    for (const s of e.childrenTiles) this._matchSymbols(s, o, i);\n  }\n\n  _createUniqueSymbolLayerArray() {\n    const e = this._uniqueSymbolsReferences,\n          s = new Array(e.size);\n    let o,\n        t = 0;\n\n    for (const [l, i] of e) {\n      const e = new Array(i.size);\n      o = 0;\n\n      for (const s of i) e[o++] = s;\n\n      s[t] = {\n        styleLayerUID: l,\n        uniqueSymbols: e\n      }, t++;\n    }\n\n    return s;\n  }\n\n}\n\nexport { r as SymbolRepository };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/2d/engine/vectorTiles/decluttering/SymbolRepository.js"],"names":["isNone","e","isSome","s","GridIndex","o","tileCoordChange","t","l","i","n","r","constructor","tileCoordRange","_visibleTiles","_createUnique","_tiles","Map","_uniqueSymbolsReferences","uniqueSymbols","_uniqueSymbolLayerArray","_createUniqueSymbolLayerArray","add","get","id","symbols","set","has","delete","layerData","_removeSymbols","y","a","f","c","length","flat","index","getCell","xTile","yTile","push","_addSymbols","key","deleteStyleLayers","size","removeTile","unique","tileSymbols","parentTile","world","level","equals","_matchSymbols","Set","row","col","childrenTiles","symbol","xTransformed","yTransformed","hash","Math","abs","Array","styleLayerUID","SymbolRepository"],"mappings":"AAAA;AACA;AACA;AACA;AACA,SAAOA,MAAM,IAAIC,CAAjB,EAAmBC,MAAM,IAAIC,CAA7B,QAAmC,8BAAnC;AAAkE,SAAOC,SAAS,IAAIC,CAApB,EAAsBC,eAAe,IAAIC,CAAzC,QAA+C,WAA/C;AAA2D,MAAMC,CAAC,GAAC,EAAR;AAAA,MAAWC,CAAC,GAAC,CAAb;AAAA,MAAeC,CAAC,GAAC,EAAjB;;AAAoB,MAAMC,CAAN,CAAO;AAACC,EAAAA,WAAW,CAACX,CAAD,EAAGE,CAAH,EAAKE,CAAL,EAAO;AAAC,SAAKQ,cAAL,GAAoBZ,CAApB,EAAsB,KAAKa,aAAL,GAAmBX,CAAzC,EAA2C,KAAKY,aAAL,GAAmBV,CAA9D,EAAgE,KAAKW,MAAL,GAAY,IAAIC,GAAJ,EAA5E,EAAoF,KAAKC,wBAAL,GAA8B,IAAID,GAAJ,EAAlH;AAA0H;;AAAiB,MAAbE,aAAa,GAAE;AAAC,WAAOlB,CAAC,CAAC,KAAKmB,uBAAN,CAAD,KAAkC,KAAKA,uBAAL,GAA6B,KAAKC,6BAAL,EAA/D,GAAqG,KAAKD,uBAAjH;AAAyI;;AAAAE,EAAAA,GAAG,CAACrB,CAAD,EAAGE,CAAH,EAAK;AAAC,SAAKiB,uBAAL,GAA6B,IAA7B;;AAAkC,QAAIb,CAAC,GAAC,KAAKS,MAAL,CAAYO,GAAZ,CAAgBtB,CAAC,CAACuB,EAAlB,CAAN;;AAA4BjB,IAAAA,CAAC,KAAGA,CAAC,GAAC;AAACkB,MAAAA,OAAO,EAAC,IAAIR,GAAJ;AAAT,KAAF,EAAoB,KAAKD,MAAL,CAAYU,GAAZ,CAAgBzB,CAAC,CAACuB,EAAlB,EAAqBjB,CAArB,CAAvB,CAAD;AAAiD,UAAMI,CAAC,GAAC,IAAIM,GAAJ,EAAR;AAAgB,QAAGd,CAAH,EAAK,KAAI,MAAME,CAAV,IAAeF,CAAf,EAAiBI,CAAC,CAACkB,OAAF,CAAUE,GAAV,CAActB,CAAd,MAAmBM,CAAC,CAACe,GAAF,CAAMrB,CAAN,EAAQE,CAAC,CAACkB,OAAF,CAAUF,GAAV,CAAclB,CAAd,CAAR,GAA0BE,CAAC,CAACkB,OAAF,CAAUG,MAAV,CAAiBvB,CAAjB,CAA7C,EAAtB,KAA6F,KAAI,MAAK,CAACA,CAAD,EAAGG,CAAH,CAAT,IAAiBP,CAAC,CAAC4B,SAAnB,EAA6BtB,CAAC,CAACkB,OAAF,CAAUE,GAAV,CAActB,CAAd,MAAmBM,CAAC,CAACe,GAAF,CAAMrB,CAAN,EAAQE,CAAC,CAACkB,OAAF,CAAUF,GAAV,CAAclB,CAAd,CAAR,GAA0BE,CAAC,CAACkB,OAAF,CAAUG,MAAV,CAAiBvB,CAAjB,CAA7C;;AAAkE,SAAKyB,cAAL,CAAoBnB,CAApB;;AAAuB,UAAMoB,CAAC,GAAC9B,CAAC,CAACwB,OAAV;AAAA,UAAkBO,CAAC,GAAC,IAAIf,GAAJ,EAApB;;AAA4B,SAAI,MAAK,CAACgB,CAAD,EAAGC,CAAH,CAAT,IAAiBH,CAAjB,EAAmB;AAAC,UAAI9B,CAAC,GAACiC,CAAC,CAACC,MAAR;;AAAe,UAAGlC,CAAC,IAAEO,CAAN,EAAQ;AAAC,YAAIL,CAAC,GAAC,KAAKU,cAAX;;AAA0B,WAAE;AAACV,UAAAA,CAAC,IAAE,CAAH,EAAKF,CAAC,IAAE,CAAR;AAAU,SAAb,QAAmBA,CAAC,GAACQ,CAAF,IAAKN,CAAC,GAACO,CAA1B;;AAA6B,cAAMF,CAAC,GAAC,IAAIH,CAAJ,CAAM,KAAKQ,cAAX,EAA0B,KAAKA,cAA/B,EAA8CV,CAA9C,CAAR;AAAyD6B,QAAAA,CAAC,CAACN,GAAF,CAAMO,CAAN,EAAQ;AAACG,UAAAA,IAAI,EAACF,CAAN;AAAQG,UAAAA,KAAK,EAAC7B;AAAd,SAAR,GAA0BD,CAAC,CAACkB,OAAF,CAAUC,GAAV,CAAcO,CAAd,EAAgB;AAACG,UAAAA,IAAI,EAACF,CAAN;AAAQG,UAAAA,KAAK,EAAC7B;AAAd,SAAhB,CAA1B;;AAA4D,aAAI,MAAMP,CAAV,IAAeiC,CAAf,EAAiB1B,CAAC,CAAC8B,OAAF,CAAUrC,CAAC,CAACsC,KAAZ,EAAkBtC,CAAC,CAACuC,KAApB,EAA2BC,IAA3B,CAAgCxC,CAAhC;AAAmC,OAAzO,MAA8O+B,CAAC,CAACN,GAAF,CAAMO,CAAN,EAAQ;AAACG,QAAAA,IAAI,EAACF;AAAN,OAAR,GAAkB3B,CAAC,CAACkB,OAAF,CAAUC,GAAV,CAAcO,CAAd,EAAgB;AAACG,QAAAA,IAAI,EAACF;AAAN,OAAhB,CAAlB;AAA4C;;AAAA,SAAKQ,WAAL,CAAiBzC,CAAC,CAAC0C,GAAnB,EAAuBZ,CAAvB;AAA0B;;AAAAa,EAAAA,iBAAiB,CAAC3C,CAAD,EAAG;AAAC,SAAKmB,uBAAL,GAA6B,IAA7B;;AAAkC,SAAI,MAAK,CAACjB,CAAD,EAAGE,CAAH,CAAT,IAAiB,KAAKW,MAAtB,EAA6B;AAAC,YAAMT,CAAC,GAAC,IAAIU,GAAJ,EAAR;;AAAgB,WAAI,MAAMd,CAAV,IAAeF,CAAf,EAAiBI,CAAC,CAACoB,OAAF,CAAUE,GAAV,CAAcxB,CAAd,MAAmBI,CAAC,CAACmB,GAAF,CAAMvB,CAAN,EAAQE,CAAC,CAACoB,OAAF,CAAUF,GAAV,CAAcpB,CAAd,CAAR,GAA0BE,CAAC,CAACoB,OAAF,CAAUG,MAAV,CAAiBzB,CAAjB,CAA7C;;AAAkE,WAAK2B,cAAL,CAAoBvB,CAApB,GAAuB,MAAIF,CAAC,CAACoB,OAAF,CAAUoB,IAAd,IAAoB,KAAK7B,MAAL,CAAYY,MAAZ,CAAmBzB,CAAnB,CAA3C;AAAiE;AAAC;;AAAA2C,EAAAA,UAAU,CAAC7C,CAAD,EAAG;AAAC,SAAKmB,uBAAL,GAA6B,IAA7B;;AAAkC,UAAMjB,CAAC,GAAC,KAAKa,MAAL,CAAYO,GAAZ,CAAgBtB,CAAC,CAACuB,EAAlB,CAAR;;AAA8B,QAAG,CAACrB,CAAJ,EAAM;AAAO,UAAME,CAAC,GAAC,IAAIY,GAAJ,EAAR;;AAAgB,SAAI,MAAK,CAACV,CAAD,EAAGC,CAAH,CAAT,IAAiBP,CAAC,CAACwB,OAAnB,EAA2BtB,CAAC,CAACsB,OAAF,CAAUE,GAAV,CAAcpB,CAAd,MAAmBF,CAAC,CAACqB,GAAF,CAAMnB,CAAN,EAAQJ,CAAC,CAACsB,OAAF,CAAUF,GAAV,CAAchB,CAAd,CAAR,GAA0BJ,CAAC,CAACsB,OAAF,CAAUG,MAAV,CAAiBrB,CAAjB,CAA7C;;AAAkE,SAAKuB,cAAL,CAAoBzB,CAApB,GAAuB,MAAIF,CAAC,CAACsB,OAAF,CAAUoB,IAAd,IAAoB,KAAK7B,MAAL,CAAYY,MAAZ,CAAmB3B,CAAC,CAACuB,EAArB,CAA3C;AAAoE;;AAAAM,EAAAA,cAAc,CAAC7B,CAAD,EAAG;AAAC,SAAI,MAAK,CAACE,CAAD,EAAG;AAACiC,MAAAA,IAAI,EAAC/B;AAAN,KAAH,CAAT,IAAwBJ,CAAxB,EAA0B,KAAI,MAAMA,CAAV,IAAeI,CAAf,EAAiB;AAAC,YAAMA,CAAC,GAACJ,CAAC,CAAC8C,MAAV;AAAA,YAAiBxC,CAAC,GAACF,CAAC,CAAC2C,WAArB;AAAA,YAAiCxC,CAAC,GAACD,CAAC,CAAC4B,MAAF,GAAS,CAA5C;;AAA8C,WAAI,IAAIhC,CAAC,GAAC,CAAV,EAAYA,CAAC,GAACK,CAAd,EAAgBL,CAAC,EAAjB,EAAoB,IAAGI,CAAC,CAACJ,CAAD,CAAD,KAAOF,CAAV,EAAY;AAACM,QAAAA,CAAC,CAACJ,CAAD,CAAD,GAAKI,CAAC,CAACC,CAAD,CAAN;AAAU;AAAM;;AAAA,UAAGD,CAAC,CAAC4B,MAAF,GAAS3B,CAAT,EAAW,MAAIA,CAAlB,EAAoB;AAAC,cAAMP,CAAC,GAAC,KAAKiB,wBAAL,CAA8BK,GAA9B,CAAkCpB,CAAlC,CAAR;;AAA6CF,QAAAA,CAAC,CAAC2B,MAAF,CAASvB,CAAT,GAAY,MAAIJ,CAAC,CAAC4C,IAAN,IAAY,KAAK3B,wBAAL,CAA8BU,MAA9B,CAAqCzB,CAArC,CAAxB;AAAgE;;AAAAF,MAAAA,CAAC,CAAC8C,MAAF,GAAS,IAAT;AAAc;AAAC;;AAAAL,EAAAA,WAAW,CAACvC,CAAD,EAAGE,CAAH,EAAK;AAAC,QAAG,MAAIA,CAAC,CAACwC,IAAT,EAAc;AAAO,UAAMtC,CAAC,GAAC,KAAKO,aAAb;;AAA2B,SAAI,MAAMb,CAAV,IAAeM,CAAf,EAAiBN,CAAC,CAACgD,UAAF,IAAchD,CAAC,CAAC0C,GAAF,CAAMO,KAAN,KAAc/C,CAAC,CAAC+C,KAA9B,IAAqCjD,CAAC,CAAC0C,GAAF,CAAMQ,KAAN,KAAchD,CAAC,CAACgD,KAAhB,IAAuB,CAAClD,CAAC,CAAC0C,GAAF,CAAMS,MAAN,CAAajD,CAAb,CAA7D,IAA8E,KAAKkD,aAAL,CAAmBpD,CAAnB,EAAqBE,CAArB,EAAuBE,CAAvB,CAA9E;;AAAwG,SAAI,MAAK,CAACG,CAAD,EAAGC,CAAH,CAAT,IAAiBJ,CAAjB,EAAmB,KAAI,MAAMF,CAAV,IAAeM,CAAf,EAAiB,IAAGR,CAAC,CAACE,CAAC,CAAC4C,MAAH,CAAJ,EAAe;AAAC,YAAM9C,CAAC,GAAC,KAAKc,aAAL,EAAR;;AAA6BZ,MAAAA,CAAC,CAAC4C,MAAF,GAAS9C,CAAT,EAAWA,CAAC,CAAC+C,WAAF,CAAcP,IAAd,CAAmBtC,CAAnB,CAAX;;AAAiC,UAAIE,CAAC,GAAC,KAAKa,wBAAL,CAA8BK,GAA9B,CAAkCf,CAAlC,CAAN;;AAA2CH,MAAAA,CAAC,KAAGA,CAAC,GAAC,IAAIiD,GAAJ,EAAF,EAAU,KAAKpC,wBAAL,CAA8BQ,GAA9B,CAAkClB,CAAlC,EAAoCH,CAApC,CAAb,CAAD,EAAsDA,CAAC,CAACiB,GAAF,CAAMrB,CAAN,CAAtD;AAA+D;AAAC;;AAAAoD,EAAAA,aAAa,CAACpD,CAAD,EAAGI,CAAH,EAAKG,CAAL,EAAO;AAAC,QAAGP,CAAC,CAAC0C,GAAF,CAAMQ,KAAN,GAAY9C,CAAC,CAAC8C,KAAjB,EAAuB;AAAC,YAAMhD,CAAC,GAACF,CAAC,CAAC0C,GAAF,CAAMQ,KAAN,GAAY9C,CAAC,CAAC8C,KAAtB;AAA4B,UAAGlD,CAAC,CAAC0C,GAAF,CAAMY,GAAN,IAAWpD,CAAX,KAAeE,CAAC,CAACkD,GAAjB,IAAsBtD,CAAC,CAAC0C,GAAF,CAAMa,GAAN,IAAWrD,CAAX,KAAeE,CAAC,CAACmD,GAA1C,EAA8C;AAAO;;AAAA,QAAGnD,CAAC,CAAC8C,KAAF,GAAQlD,CAAC,CAAC0C,GAAF,CAAMQ,KAAjB,EAAuB;AAAC,YAAMhD,CAAC,GAACE,CAAC,CAAC8C,KAAF,GAAQlD,CAAC,CAAC0C,GAAF,CAAMQ,KAAtB;AAA4B,UAAG9C,CAAC,CAACkD,GAAF,IAAOpD,CAAP,KAAWF,CAAC,CAAC0C,GAAF,CAAMY,GAAjB,IAAsBlD,CAAC,CAACmD,GAAF,IAAOrD,CAAP,KAAWF,CAAC,CAAC0C,GAAF,CAAMa,GAA1C,EAA8C;AAAO;;AAAA,QAAGnD,CAAC,CAAC+C,MAAF,CAASnD,CAAC,CAAC0C,GAAX,CAAH,EAAmB;AAAC,WAAI,MAAMxC,CAAV,IAAeF,CAAC,CAACwD,aAAjB,EAA+B,KAAKJ,aAAL,CAAmBlD,CAAnB,EAAqBE,CAArB,EAAuBG,CAAvB;;AAA0B;AAAO;;AAAA,UAAMC,CAAC,GAAC,IAAIQ,GAAJ,EAAR;;AAAgB,SAAI,MAAK,CAACP,CAAD,EAAGC,CAAH,CAAT,IAAiBH,CAAjB,EAAmB;AAAC,YAAMA,CAAC,GAAC,EAAR;;AAAW,WAAI,MAAML,CAAV,IAAeQ,CAAf,EAAiB;AAAC,cAAMF,CAAC,GAACF,CAAC,CAAC,KAAKM,cAAN,EAAqBV,CAAC,CAACoC,KAAvB,EAA6BlC,CAAC,CAAC8C,KAA/B,EAAqC9C,CAAC,CAACmD,GAAvC,EAA2CvD,CAAC,CAAC0C,GAAF,CAAMQ,KAAjD,EAAuDlD,CAAC,CAAC0C,GAAF,CAAMa,GAA7D,CAAT;AAAA,cAA2E9C,CAAC,GAACH,CAAC,CAAC,KAAKM,cAAN,EAAqBV,CAAC,CAACqC,KAAvB,EAA6BnC,CAAC,CAAC8C,KAA/B,EAAqC9C,CAAC,CAACkD,GAAvC,EAA2CtD,CAAC,CAAC0C,GAAF,CAAMQ,KAAjD,EAAuDlD,CAAC,CAAC0C,GAAF,CAAMY,GAA7D,CAA9E;AAAgJ9C,QAAAA,CAAC,IAAE,CAAH,IAAMA,CAAC,GAAC,KAAKI,cAAb,IAA6BH,CAAC,IAAE,CAAhC,IAAmCA,CAAC,GAAC,KAAKG,cAA1C,IAA0DL,CAAC,CAACiC,IAAF,CAAO;AAACiB,UAAAA,MAAM,EAACvD,CAAR;AAAUwD,UAAAA,YAAY,EAAClD,CAAvB;AAAyBmD,UAAAA,YAAY,EAAClD;AAAtC,SAAP,CAA1D;AAA2G;;AAAA,YAAMqB,CAAC,GAAC,EAAR;AAAA,YAAWC,CAAC,GAAC/B,CAAC,CAAC0C,GAAF,CAAMQ,KAAN,GAAY9C,CAAC,CAAC8C,KAAd,GAAoB,CAApB,GAAsB,KAAGlD,CAAC,CAAC0C,GAAF,CAAMQ,KAAN,GAAY9C,CAAC,CAAC8C,KAApD;AAAA,YAA0DlB,CAAC,GAAC,KAAKjB,MAAL,CAAYO,GAAZ,CAAgBtB,CAAC,CAACuB,EAAlB,EAAsBC,OAAtB,CAA8BF,GAA9B,CAAkCb,CAAlC,CAA5D;;AAAiG,UAAGuB,CAAH,EAAK;AAAC,cAAMhC,CAAC,GAACgC,CAAC,CAACG,IAAV;;AAAe,aAAI,MAAM/B,CAAV,IAAeG,CAAf,EAAiB;AAAC,cAAID,CAAJ;AAAA,cAAMC,CAAC,GAAC,CAAC,CAAT;AAAW,gBAAMC,CAAC,GAACJ,CAAC,CAACsD,YAAV;AAAA,gBAAuBjD,CAAC,GAACL,CAAC,CAACuD,YAA3B;AAAwCrD,UAAAA,CAAC,GAACJ,CAAC,CAAC8B,CAAC,CAACI,KAAH,CAAD,GAAWJ,CAAC,CAACI,KAAF,CAAQC,OAAR,CAAgB7B,CAAhB,EAAkBC,CAAlB,CAAX,GAAgCT,CAAlC;AAAoC,gBAAMU,CAAC,GAACN,CAAC,CAACqD,MAAV;AAAA,gBAAiBxB,CAAC,GAACvB,CAAC,CAACkD,IAArB;;AAA0B,eAAI,MAAM5D,CAAV,IAAeM,CAAf,EAAiB,IAAG2B,CAAC,KAAGjC,CAAC,CAAC4D,IAAN,IAAYC,IAAI,CAACC,GAAL,CAAStD,CAAC,GAACR,CAAC,CAACsC,KAAb,KAAqBP,CAAjC,IAAoC8B,IAAI,CAACC,GAAL,CAASrD,CAAC,GAACT,CAAC,CAACuC,KAAb,KAAqBR,CAA5D,EAA8D;AAAC,kBAAM7B,CAAC,GAACF,CAAC,CAAC8C,MAAV;AAAiBpC,YAAAA,CAAC,CAACoC,MAAF,GAAS5C,CAAT,EAAWA,CAAC,CAAC6C,WAAF,CAAcP,IAAd,CAAmB9B,CAAnB,CAAX,EAAiCH,CAAC,GAAC,CAAC,CAApC;AAAsC;AAAM;;AAAAA,UAAAA,CAAC,IAAEuB,CAAC,CAACU,IAAF,CAAO9B,CAAP,CAAH;AAAa;AAAC;;AAAAoB,MAAAA,CAAC,CAACI,MAAF,GAAS,CAAT,IAAY1B,CAAC,CAACiB,GAAF,CAAMhB,CAAN,EAAQqB,CAAR,CAAZ;AAAuB;;AAAA,SAAI,MAAM5B,CAAV,IAAeF,CAAC,CAACwD,aAAjB,EAA+B,KAAKJ,aAAL,CAAmBlD,CAAnB,EAAqBE,CAArB,EAAuBI,CAAvB;AAA0B;;AAAAY,EAAAA,6BAA6B,GAAE;AAAC,UAAMpB,CAAC,GAAC,KAAKiB,wBAAb;AAAA,UAAsCf,CAAC,GAAC,IAAI6D,KAAJ,CAAU/D,CAAC,CAAC4C,IAAZ,CAAxC;AAA0D,QAAIxC,CAAJ;AAAA,QAAME,CAAC,GAAC,CAAR;;AAAU,SAAI,MAAK,CAACC,CAAD,EAAGC,CAAH,CAAT,IAAiBR,CAAjB,EAAmB;AAAC,YAAMA,CAAC,GAAC,IAAI+D,KAAJ,CAAUvD,CAAC,CAACoC,IAAZ,CAAR;AAA0BxC,MAAAA,CAAC,GAAC,CAAF;;AAAI,WAAI,MAAMF,CAAV,IAAeM,CAAf,EAAiBR,CAAC,CAACI,CAAC,EAAF,CAAD,GAAOF,CAAP;;AAASA,MAAAA,CAAC,CAACI,CAAD,CAAD,GAAK;AAAC0D,QAAAA,aAAa,EAACzD,CAAf;AAAiBW,QAAAA,aAAa,EAAClB;AAA/B,OAAL,EAAuCM,CAAC,EAAxC;AAA2C;;AAAA,WAAOJ,CAAP;AAAS;;AAAngH;;AAAogH,SAAOQ,CAAC,IAAIuD,gBAAZ","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{isNone as e,isSome as s}from\"../../../../../core/maybe.js\";import{GridIndex as o,tileCoordChange as t}from\"./util.js\";const l=32,i=8,n=64;class r{constructor(e,s,o){this.tileCoordRange=e,this._visibleTiles=s,this._createUnique=o,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}get uniqueSymbols(){return e(this._uniqueSymbolLayerArray)&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}add(e,s){this._uniqueSymbolLayerArray=null;let t=this._tiles.get(e.id);t||(t={symbols:new Map},this._tiles.set(e.id,t));const r=new Map;if(s)for(const o of s)t.symbols.has(o)&&(r.set(o,t.symbols.get(o)),t.symbols.delete(o));else for(const[o,l]of e.layerData)t.symbols.has(o)&&(r.set(o,t.symbols.get(o)),t.symbols.delete(o));this._removeSymbols(r);const y=e.symbols,a=new Map;for(const[f,c]of y){let e=c.length;if(e>=l){let s=this.tileCoordRange;do{s/=2,e/=4}while(e>i&&s>n);const l=new o(this.tileCoordRange,this.tileCoordRange,s);a.set(f,{flat:c,index:l}),t.symbols.set(f,{flat:c,index:l});for(const e of c)l.getCell(e.xTile,e.yTile).push(e)}else a.set(f,{flat:c}),t.symbols.set(f,{flat:c})}this._addSymbols(e.key,y)}deleteStyleLayers(e){this._uniqueSymbolLayerArray=null;for(const[s,o]of this._tiles){const t=new Map;for(const s of e)o.symbols.has(s)&&(t.set(s,o.symbols.get(s)),o.symbols.delete(s));this._removeSymbols(t),0===o.symbols.size&&this._tiles.delete(s)}}removeTile(e){this._uniqueSymbolLayerArray=null;const s=this._tiles.get(e.id);if(!s)return;const o=new Map;for(const[t,l]of e.symbols)s.symbols.has(t)&&(o.set(t,s.symbols.get(t)),s.symbols.delete(t));this._removeSymbols(o),0===s.symbols.size&&this._tiles.delete(e.id)}_removeSymbols(e){for(const[s,{flat:o}]of e)for(const e of o){const o=e.unique,t=o.tileSymbols,l=t.length-1;for(let s=0;s<l;s++)if(t[s]===e){t[s]=t[l];break}if(t.length=l,0===l){const e=this._uniqueSymbolsReferences.get(s);e.delete(o),0===e.size&&this._uniqueSymbolsReferences.delete(s)}e.unique=null}}_addSymbols(s,o){if(0===o.size)return;const t=this._visibleTiles;for(const e of t)e.parentTile||e.key.world!==s.world||e.key.level===s.level&&!e.key.equals(s)||this._matchSymbols(e,s,o);for(const[l,i]of o)for(const s of i)if(e(s.unique)){const e=this._createUnique();s.unique=e,e.tileSymbols.push(s);let o=this._uniqueSymbolsReferences.get(l);o||(o=new Set,this._uniqueSymbolsReferences.set(l,o)),o.add(e)}}_matchSymbols(e,o,l){if(e.key.level>o.level){const s=e.key.level-o.level;if(e.key.row>>s!==o.row||e.key.col>>s!==o.col)return}if(o.level>e.key.level){const s=o.level-e.key.level;if(o.row>>s!==e.key.row||o.col>>s!==e.key.col)return}if(o.equals(e.key)){for(const s of e.childrenTiles)this._matchSymbols(s,o,l);return}const i=new Map;for(const[n,r]of l){const l=[];for(const s of r){const i=t(this.tileCoordRange,s.xTile,o.level,o.col,e.key.level,e.key.col),n=t(this.tileCoordRange,s.yTile,o.level,o.row,e.key.level,e.key.row);i>=0&&i<this.tileCoordRange&&n>=0&&n<this.tileCoordRange&&l.push({symbol:s,xTransformed:i,yTransformed:n})}const y=[],a=e.key.level<o.level?1:1<<e.key.level-o.level,f=this._tiles.get(e.id).symbols.get(n);if(f){const e=f.flat;for(const o of l){let t,l=!1;const i=o.xTransformed,n=o.yTransformed;t=s(f.index)?f.index.getCell(i,n):e;const r=o.symbol,c=r.hash;for(const e of t)if(c===e.hash&&Math.abs(i-e.xTile)<=a&&Math.abs(n-e.yTile)<=a){const s=e.unique;r.unique=s,s.tileSymbols.push(r),l=!0;break}l||y.push(r)}}y.length>0&&i.set(n,y)}for(const s of e.childrenTiles)this._matchSymbols(s,o,i)}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsReferences,s=new Array(e.size);let o,t=0;for(const[l,i]of e){const e=new Array(i.size);o=0;for(const s of i)e[o++]=s;s[t]={styleLayerUID:l,uniqueSymbols:e},t++}return s}}export{r as SymbolRepository};\n"]},"metadata":{},"sourceType":"module"}