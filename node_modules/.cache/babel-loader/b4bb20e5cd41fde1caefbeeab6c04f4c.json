{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { a as e } from \"../../../../../chunks/mat3f32.js\";\nimport { COLLISION_GRID_CELL_SIZE as t } from \"./config.js\";\nimport { GridIndex as n } from \"./util.js\";\n\nfunction o(e, t, n, o, r, s) {\n  const {\n    iconRotationAlignment: i,\n    textRotationAlignment: l,\n    iconTranslate: a,\n    iconTranslateAnchor: c,\n    textTranslate: h,\n    textTranslateAnchor: u\n  } = o;\n  let d = 0;\n\n  for (const y of e.colliders) {\n    const [e, o] = 0 === y.partIndex ? a : h,\n          x = 0 === y.partIndex ? c : u,\n          g = y.minLod <= s && s <= y.maxLod;\n    d += g ? 0 : 1, y.enabled = g, y.xScreen = y.xTile * r[0] + y.yTile * r[3] + r[6], y.yScreen = y.xTile * r[1] + y.yTile * r[4] + r[7], 0 === x ? (y.xScreen += n * e - t * o, y.yScreen += t * e + n * o) : (y.xScreen += e, y.yScreen += o), 1 === (0 === y.partIndex ? i : l) ? (y.dxScreen = y.dxPixels, y.dyScreen = y.dyPixels) : (y.dxScreen = n * (y.dxPixels + y.width / 2) - t * (y.dyPixels + y.height / 2) - y.width / 2, y.dyScreen = t * (y.dxPixels + y.width / 2) + n * (y.dyPixels + y.height / 2) - y.height / 2);\n  }\n\n  e.colliders.length > 0 && d === e.colliders.length && (e.unique.show = !1);\n}\n\nclass r {\n  constructor(o, r, s, i, l, a) {\n    this._symbols = o, this._styleRepository = i, this._zoom = l, this._currentLayerCursor = 0, this._currentSymbolCursor = 0, this._styleProps = new Map(), this._allNeededMatrices = new Map(), this._gridIndex = new n(r, s, t), this._si = Math.sin(Math.PI * a / 180), this._co = Math.cos(Math.PI * a / 180);\n\n    for (const t of o) for (const n of t.symbols) this._allNeededMatrices.has(n.tile) || this._allNeededMatrices.set(n.tile, e(n.tile.transforms.tileUnitsToPixels));\n  }\n\n  work(e) {\n    const t = this._gridIndex;\n\n    function n(e) {\n      const n = e.xScreen + e.dxScreen,\n            o = e.yScreen + e.dyScreen,\n            r = n + e.width,\n            s = o + e.height,\n            [i, l, a, c] = t.getCellSpan(n, o, r, s);\n\n      for (let h = l; h <= c; h++) for (let e = i; e <= a; e++) {\n        const i = t.cells[h][e];\n\n        for (const e of i) {\n          const t = e.xScreen + e.dxScreen,\n                i = e.yScreen + e.dyScreen,\n                l = t + e.width,\n                a = i + e.height;\n          if (!(r < t || n > l || s < i || o > a)) return !0;\n        }\n      }\n\n      return !1;\n    }\n\n    const r = performance.now();\n\n    for (; this._currentLayerCursor < this._symbols.length; this._currentLayerCursor++, this._currentSymbolCursor = 0) {\n      const t = this._symbols[this._currentLayerCursor],\n            s = this._getProperties(t.styleLayerUID);\n\n      for (; this._currentSymbolCursor < t.symbols.length; this._currentSymbolCursor++) {\n        if (this._currentSymbolCursor % 100 == 99 && performance.now() - r > e) return !1;\n        const i = t.symbols[this._currentSymbolCursor];\n        if (!i.unique.show) continue;\n        o(i, this._si, this._co, s, this._allNeededMatrices.get(i.tile), this._zoom);\n        const l = i.unique;\n        if (!l.show) continue;\n        const {\n          iconAllowOverlap: a,\n          iconIgnorePlacement: c,\n          textAllowOverlap: h,\n          textIgnorePlacement: u\n        } = s;\n\n        for (const e of i.colliders) {\n          if (!e.enabled) continue;\n          const t = l.parts[e.partIndex];\n          if (!t.show) continue;\n          !(e.partIndex ? h : a) && n(e) && (e.hard ? l.show = !1 : t.show = !1);\n        }\n\n        if (l.show) for (const e of i.colliders) {\n          if (!e.enabled) continue;\n          if (e.partIndex ? u : c) continue;\n          if (!l.parts[e.partIndex].show) continue;\n\n          const t = e.xScreen + e.dxScreen,\n                n = e.yScreen + e.dyScreen,\n                o = t + e.width,\n                r = n + e.height,\n                [s, i, a, h] = this._gridIndex.getCellSpan(t, n, o, r);\n\n          for (let l = i; l <= h; l++) for (let t = s; t <= a; t++) {\n            this._gridIndex.cells[l][t].push(e);\n          }\n        }\n      }\n    }\n\n    return !0;\n  }\n\n  _getProperties(e) {\n    const t = this._styleProps.get(e);\n\n    if (t) return t;\n\n    const n = this._zoom,\n          o = this._styleRepository.getStyleLayerByUID(e),\n          r = 0 !== o.getLayoutValue(\"symbol-placement\", n);\n\n    let s = o.getLayoutValue(\"icon-rotation-alignment\", n);\n    2 === s && (s = r ? 0 : 1);\n    let i = o.getLayoutValue(\"text-rotation-alignment\", n);\n    2 === i && (i = r ? 0 : 1);\n    const l = o.getPaintValue(\"icon-translate\", n),\n          a = o.getPaintValue(\"icon-translate-anchor\", n),\n          c = o.getPaintValue(\"text-translate\", n),\n          h = o.getPaintValue(\"text-translate-anchor\", n),\n          u = {\n      iconAllowOverlap: o.getLayoutValue(\"icon-allow-overlap\", n),\n      iconIgnorePlacement: o.getLayoutValue(\"icon-ignore-placement\", n),\n      textAllowOverlap: o.getLayoutValue(\"text-allow-overlap\", n),\n      textIgnorePlacement: o.getLayoutValue(\"text-ignore-placement\", n),\n      iconRotationAlignment: s,\n      textRotationAlignment: i,\n      iconTranslateAnchor: a,\n      iconTranslate: l,\n      textTranslateAnchor: h,\n      textTranslate: c\n    };\n    return this._styleProps.set(e, u), u;\n  }\n\n}\n\nexport { r as CollisionJob };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/2d/engine/vectorTiles/decluttering/jobs.js"],"names":["a","e","COLLISION_GRID_CELL_SIZE","t","GridIndex","n","o","r","s","iconRotationAlignment","i","textRotationAlignment","l","iconTranslate","iconTranslateAnchor","c","textTranslate","h","textTranslateAnchor","u","d","y","colliders","partIndex","x","g","minLod","maxLod","enabled","xScreen","xTile","yTile","yScreen","dxScreen","dxPixels","dyScreen","dyPixels","width","height","length","unique","show","constructor","_symbols","_styleRepository","_zoom","_currentLayerCursor","_currentSymbolCursor","_styleProps","Map","_allNeededMatrices","_gridIndex","_si","Math","sin","PI","_co","cos","symbols","has","tile","set","transforms","tileUnitsToPixels","work","getCellSpan","cells","performance","now","_getProperties","styleLayerUID","get","iconAllowOverlap","iconIgnorePlacement","textAllowOverlap","textIgnorePlacement","parts","hard","push","getStyleLayerByUID","getLayoutValue","getPaintValue","CollisionJob"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{a as e}from\"../../../../../chunks/mat3f32.js\";import{COLLISION_GRID_CELL_SIZE as t}from\"./config.js\";import{GridIndex as n}from\"./util.js\";function o(e,t,n,o,r,s){const{iconRotationAlignment:i,textRotationAlignment:l,iconTranslate:a,iconTranslateAnchor:c,textTranslate:h,textTranslateAnchor:u}=o;let d=0;for(const y of e.colliders){const[e,o]=0===y.partIndex?a:h,x=0===y.partIndex?c:u,g=y.minLod<=s&&s<=y.maxLod;d+=g?0:1,y.enabled=g,y.xScreen=y.xTile*r[0]+y.yTile*r[3]+r[6],y.yScreen=y.xTile*r[1]+y.yTile*r[4]+r[7],0===x?(y.xScreen+=n*e-t*o,y.yScreen+=t*e+n*o):(y.xScreen+=e,y.yScreen+=o),1===(0===y.partIndex?i:l)?(y.dxScreen=y.dxPixels,y.dyScreen=y.dyPixels):(y.dxScreen=n*(y.dxPixels+y.width/2)-t*(y.dyPixels+y.height/2)-y.width/2,y.dyScreen=t*(y.dxPixels+y.width/2)+n*(y.dyPixels+y.height/2)-y.height/2)}e.colliders.length>0&&d===e.colliders.length&&(e.unique.show=!1)}class r{constructor(o,r,s,i,l,a){this._symbols=o,this._styleRepository=i,this._zoom=l,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new n(r,s,t),this._si=Math.sin(Math.PI*a/180),this._co=Math.cos(Math.PI*a/180);for(const t of o)for(const n of t.symbols)this._allNeededMatrices.has(n.tile)||this._allNeededMatrices.set(n.tile,e(n.tile.transforms.tileUnitsToPixels))}work(e){const t=this._gridIndex;function n(e){const n=e.xScreen+e.dxScreen,o=e.yScreen+e.dyScreen,r=n+e.width,s=o+e.height,[i,l,a,c]=t.getCellSpan(n,o,r,s);for(let h=l;h<=c;h++)for(let e=i;e<=a;e++){const i=t.cells[h][e];for(const e of i){const t=e.xScreen+e.dxScreen,i=e.yScreen+e.dyScreen,l=t+e.width,a=i+e.height;if(!(r<t||n>l||s<i||o>a))return!0}}return!1}const r=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const t=this._symbols[this._currentLayerCursor],s=this._getProperties(t.styleLayerUID);for(;this._currentSymbolCursor<t.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-r>e)return!1;const i=t.symbols[this._currentSymbolCursor];if(!i.unique.show)continue;o(i,this._si,this._co,s,this._allNeededMatrices.get(i.tile),this._zoom);const l=i.unique;if(!l.show)continue;const{iconAllowOverlap:a,iconIgnorePlacement:c,textAllowOverlap:h,textIgnorePlacement:u}=s;for(const e of i.colliders){if(!e.enabled)continue;const t=l.parts[e.partIndex];if(!t.show)continue;!(e.partIndex?h:a)&&n(e)&&(e.hard?l.show=!1:t.show=!1)}if(l.show)for(const e of i.colliders){if(!e.enabled)continue;if(e.partIndex?u:c)continue;if(!l.parts[e.partIndex].show)continue;const t=e.xScreen+e.dxScreen,n=e.yScreen+e.dyScreen,o=t+e.width,r=n+e.height,[s,i,a,h]=this._gridIndex.getCellSpan(t,n,o,r);for(let l=i;l<=h;l++)for(let t=s;t<=a;t++){this._gridIndex.cells[l][t].push(e)}}}}return!0}_getProperties(e){const t=this._styleProps.get(e);if(t)return t;const n=this._zoom,o=this._styleRepository.getStyleLayerByUID(e),r=0!==o.getLayoutValue(\"symbol-placement\",n);let s=o.getLayoutValue(\"icon-rotation-alignment\",n);2===s&&(s=r?0:1);let i=o.getLayoutValue(\"text-rotation-alignment\",n);2===i&&(i=r?0:1);const l=o.getPaintValue(\"icon-translate\",n),a=o.getPaintValue(\"icon-translate-anchor\",n),c=o.getPaintValue(\"text-translate\",n),h=o.getPaintValue(\"text-translate-anchor\",n),u={iconAllowOverlap:o.getLayoutValue(\"icon-allow-overlap\",n),iconIgnorePlacement:o.getLayoutValue(\"icon-ignore-placement\",n),textAllowOverlap:o.getLayoutValue(\"text-allow-overlap\",n),textIgnorePlacement:o.getLayoutValue(\"text-ignore-placement\",n),iconRotationAlignment:s,textRotationAlignment:i,iconTranslateAnchor:a,iconTranslate:l,textTranslateAnchor:h,textTranslate:c};return this._styleProps.set(e,u),u}}export{r as CollisionJob};\n"]},"metadata":{},"sourceType":"module"}