{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { log2 as e } from \"../../../../../core/mathUtils.js\";\nimport { releaseMaybe as t, isNone as s } from \"../../../../../core/maybe.js\";\nimport r from \"../../../../../core/PooledArray.js\";\nimport { t as i, e as n, g as o } from \"../../../../../chunks/mat3.js\";\nimport { c as a } from \"../../../../../chunks/mat3f32.js\";\nimport { g as l, s as h } from \"../../../../../chunks/vec3.js\";\nimport { c } from \"../../../../../chunks/vec3f64.js\";\nimport d from \"../../../support/debugFlags.js\";\nimport { ComponentDrawParameters as m } from \"../../collections/Component/Material/ComponentTechnique.js\";\nimport { bindSliceUniforms as u } from \"../../core/shaderLibrary/Slice.glsl.js\";\nimport { VertexPosition as f } from \"../../core/shaderLibrary/attributes/VertexPosition.glsl.js\";\nimport { bindMultipassTerrainTexture as g } from \"../../core/shaderLibrary/shading/MultipassTerrainTest.glsl.js\";\nimport { doublePrecisionRequiresObfuscation as b } from \"../../core/shaderLibrary/util/DoublePrecision.glsl.js\";\nimport { TwoVectorPosition as p } from \"../../core/util/TwoVectorPosition.js\";\nimport { EdgeShaderTechnique as y } from \"./EdgeShaderTechnique.js\";\nconst T = 8,\n      R = 128,\n      v = {\n  type: \"uber\",\n  slicePlaneEnabled: !1,\n  sliceHighlightDisabled: !1,\n  strokesTexture: null,\n  legacy: !0\n};\n\nclass x {\n  constructor() {\n    this._value = 0;\n  }\n\n  get value() {\n    return this._value;\n  }\n\n  increment() {\n    this._value++;\n  }\n\n  decrement() {\n    this._value--;\n  }\n\n}\n\nconst P = {\n  solid: 0,\n  sketch: 1,\n  uber: 2\n};\n\nclass S {\n  constructor(e, t, s) {\n    this.rctx = e, this.shaderTechniqueRepository = t, this.config = new y.Configuration(), this.technique = null, this.refCount = new x(), this.renderables = new Set(), this.sortedRenderables = {\n      1: {\n        1: new r(),\n        2: new r()\n      },\n      2: {\n        1: new r(),\n        2: new r()\n      }\n    }, this.renderablesDirty = !1, this.settings = { ...v,\n      ...s\n    }, this.key = S.getKey(this.settings.type, this.settings.slicePlaneEnabled, this.settings.legacy);\n    const i = this.settings.strokesTexture.variants;\n    this.writerSettings = {\n      variants: i,\n      reducedPrecision: d.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES\n    }, this.config.legacy = this.settings.legacy, this.config.mode = P[this.settings.type], this.config.silhouette = !1, this.config.antialiasing = !!this.rctx.capabilities.blendMinMax, this.config.slicePlaneEnabled = this.settings.slicePlaneEnabled, this.config.doublePrecisionRequiresObfuscation = b(e);\n  }\n\n  dispose() {\n    this.technique = t(this.technique);\n  }\n\n  addRenderable(e) {\n    this.renderables.add(e), this.renderablesDirty = !0;\n  }\n\n  removeRenderable(e) {\n    this.renderables.delete(e), this.renderablesDirty = !0;\n  }\n\n  setRenderablesDirty() {\n    this.renderablesDirty = !0;\n  }\n\n  forEachRenderable(e, t) {\n    this.renderablesDirty && this.sortRenderables(), this.sortedRenderables[t][1].forAll(e), this.sortedRenderables[t][2].forAll(e);\n  }\n\n  setMultipassParameters(e) {\n    this.config.multipassTerrainEnabled = !!e.multipassTerrainEnabled && e.multipassTerrainEnabled, this.config.cullAboveGround = !!e.cullAboveGround && e.cullAboveGround;\n  }\n\n  bindRegularEdges(e, t) {\n    this.setMultipassParameters(e), this.config.silhouette = !1, this.technique = this.shaderTechniqueRepository.releaseAndAcquire(y, this.config, this.technique), this.technique.bindPass({\n      bindParameters: e,\n      edgeRenderParameters: t\n    }), this.rctx.setPipelineState(this.technique.pipeline), this.rctx.useProgram(this.technique.program);\n  }\n\n  bindSilhouetteEdges(e, t) {\n    this.setMultipassParameters(e), this.config.silhouette = !0, this.technique = this.shaderTechniqueRepository.releaseAndAcquire(y, this.config, this.technique), this.technique.bindPass({\n      bindParameters: e,\n      edgeRenderParameters: t\n    }), this.rctx.setPipelineState(this.technique.pipeline), this.rctx.useProgram(this.technique.program);\n  }\n\n  renderRegularEdges(e, t, s) {\n    this.render(e, e.regular.vao, t, s);\n  }\n\n  renderSilhouetteEdges(e, t, s) {\n    this.render(e, e.silhouette.vao, t, s);\n  }\n\n  render(e, t, s, r) {\n    this.setUniforms(e, s), this.rctx.bindVAO(t), this.rctx.capabilities.instancing.drawArraysInstanced(6, 0, 4, r);\n  }\n\n  setUniforms(e, t) {\n    const s = this.technique.program;\n    if (e.components.buffer.textureBuffer.bind(s, w, E), t.multipassTerrainEnabled && (s.setUniform2fv(\"cameraNearFar\", t.camera.nearFar), s.setUniform2fv(\"inverseViewport\", t.inverseViewport), g(s, t)), \"origin\" in e.transform) s.setUniformMatrix4fv(\"uView\", t.localViewMatrixForEdges), s.setUniformMatrix4fv(\"uModel\", e.transform.modelMatrix), u(s, this.settings, t.slicePlane, e.transform.origin.vec3);else {\n      const r = new p(e.transform.position),\n            a = i(q, n(q, e.transform.rotationScale)),\n            c = new m();\n      l(c.worldFromModel_TL, r.low), l(c.worldFromModel_TH, r.high), o(c.worldFromModel_RS, e.transform.rotationScale), o(c.transformNormal_GlobalFromModel, a), f.bindModelTransform(s, c), s.setUniformMatrix3fv(\"uTransformNormal_GlobalFromModel\", c.transformNormal_GlobalFromModel);\n      const d = t.camera.viewInverseTransposeMatrix,\n            g = h(M, d[3], d[7], d[11]);\n      u(s, this.settings, t.slicePlane, g);\n    }\n    \"uber\" !== this.settings.type && \"sketch\" !== this.settings.type || this.setSketchUniforms(s), s.setUniform1f(\"uWorldLineRadiusPerDistance\", Math.tan(t.camera.fovY / 2) / (t.camera.fullViewport[3] / 2));\n  }\n\n  setSketchUniforms(t) {\n    const r = this.settings.strokesTexture,\n          i = r.texture;\n    s(i) || (t.bindTexture(i, \"uStrokesTexture\"), t.setUniform2f(\"uStrokesTextureScale\", 1 / i.descriptor.width, 1 / i.descriptor.height), t.setUniform1f(\"uStrokesLog2Resolution\", e(r.resolution)), t.setUniform1f(\"uStrokesNormalizationScale\", r.normalizationScale), t.setUniform1f(\"uStrokesAmplitude\", r.amplitude), t.setUniform1f(\"uStrokeVariants\", r.variants));\n  }\n\n  sortRenderables() {\n    this.renderablesDirty = !1, this.sortedRenderables[1][1].clear(), this.sortedRenderables[1][2].clear(), this.sortedRenderables[2][1].clear(), this.sortedRenderables[2][2].clear(), this.renderables.forEach(e => {\n      0 !== e.objectTransparency && 0 !== e.edgeTransparency && this.sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e);\n    });\n\n    const e = (e, t) => \"origin\" in e.transform && \"origin\" in t.transform ? e.transform.origin.id < t.transform.origin.id ? -1 : e.transform.origin.id > t.transform.origin.id ? 1 : 0 : 0;\n\n    this.sortedRenderables[1][1].sort(e), this.sortedRenderables[1][2].sort(e), this.sortedRenderables[2][1].sort(e), this.sortedRenderables[2][2].sort(e);\n  }\n\n  static getKey(e, t, s) {\n    return `edges-t:${e}:${t}:${s}`;\n  }\n\n}\n\nconst w = \"uComponentDataTex\",\n      E = \"uComponentDataTexInvDim\",\n      q = a(),\n      M = c();\nexport { R as EXTENSION_LENGTH_OFFSET, S as EdgeRenderer, T as LINE_WIDTH_FRACTION_FACTOR, E as componentDataInvDimName, w as componentDataTexName };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgis-api-react/node_modules/@arcgis/core/views/3d/webgl-engine/lib/edgeRendering/EdgeRenderer.js"],"names":["log2","e","releaseMaybe","t","isNone","s","r","i","n","g","o","c","a","l","h","d","ComponentDrawParameters","m","bindSliceUniforms","u","VertexPosition","f","bindMultipassTerrainTexture","doublePrecisionRequiresObfuscation","b","TwoVectorPosition","p","EdgeShaderTechnique","y","T","R","v","type","slicePlaneEnabled","sliceHighlightDisabled","strokesTexture","legacy","x","constructor","_value","value","increment","decrement","P","solid","sketch","uber","S","rctx","shaderTechniqueRepository","config","Configuration","technique","refCount","renderables","Set","sortedRenderables","renderablesDirty","settings","key","getKey","variants","writerSettings","reducedPrecision","DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES","mode","silhouette","antialiasing","capabilities","blendMinMax","dispose","addRenderable","add","removeRenderable","delete","setRenderablesDirty","forEachRenderable","sortRenderables","forAll","setMultipassParameters","multipassTerrainEnabled","cullAboveGround","bindRegularEdges","releaseAndAcquire","bindPass","bindParameters","edgeRenderParameters","setPipelineState","pipeline","useProgram","program","bindSilhouetteEdges","renderRegularEdges","render","regular","vao","renderSilhouetteEdges","setUniforms","bindVAO","instancing","drawArraysInstanced","components","buffer","textureBuffer","bind","w","E","setUniform2fv","camera","nearFar","inverseViewport","transform","setUniformMatrix4fv","localViewMatrixForEdges","modelMatrix","slicePlane","origin","vec3","position","q","rotationScale","worldFromModel_TL","low","worldFromModel_TH","high","worldFromModel_RS","transformNormal_GlobalFromModel","bindModelTransform","setUniformMatrix3fv","viewInverseTransposeMatrix","M","setSketchUniforms","setUniform1f","Math","tan","fovY","fullViewport","texture","bindTexture","setUniform2f","descriptor","width","height","resolution","normalizationScale","amplitude","clear","forEach","objectTransparency","edgeTransparency","push","id","sort","EXTENSION_LENGTH_OFFSET","EdgeRenderer","LINE_WIDTH_FRACTION_FACTOR","componentDataInvDimName","componentDataTexName"],"mappings":"AAAA;AACA;AACA;AACA;AACA,SAAOA,IAAI,IAAIC,CAAf,QAAqB,kCAArB;AAAwD,SAAOC,YAAY,IAAIC,CAAvB,EAAyBC,MAAM,IAAIC,CAAnC,QAAyC,8BAAzC;AAAwE,OAAOC,CAAP,MAAa,oCAAb;AAAkD,SAAOH,CAAC,IAAII,CAAZ,EAAcN,CAAC,IAAIO,CAAnB,EAAqBC,CAAC,IAAIC,CAA1B,QAAgC,+BAAhC;AAAgE,SAAOC,CAAC,IAAIC,CAAZ,QAAkB,kCAAlB;AAAqD,SAAOH,CAAC,IAAII,CAAZ,EAAcR,CAAC,IAAIS,CAAnB,QAAyB,+BAAzB;AAAyD,SAAOH,CAAP,QAAa,kCAAb;AAAgD,OAAOI,CAAP,MAAa,gCAAb;AAA8C,SAAOC,uBAAuB,IAAIC,CAAlC,QAAwC,4DAAxC;AAAqG,SAAOC,iBAAiB,IAAIC,CAA5B,QAAkC,wCAAlC;AAA2E,SAAOC,cAAc,IAAIC,CAAzB,QAA+B,4DAA/B;AAA4F,SAAOC,2BAA2B,IAAIb,CAAtC,QAA4C,+DAA5C;AAA4G,SAAOc,kCAAkC,IAAIC,CAA7C,QAAmD,uDAAnD;AAA2G,SAAOC,iBAAiB,IAAIC,CAA5B,QAAkC,sCAAlC;AAAyE,SAAOC,mBAAmB,IAAIC,CAA9B,QAAoC,0BAApC;AAA+D,MAAMC,CAAC,GAAC,CAAR;AAAA,MAAUC,CAAC,GAAC,GAAZ;AAAA,MAAgBC,CAAC,GAAC;AAACC,EAAAA,IAAI,EAAC,MAAN;AAAaC,EAAAA,iBAAiB,EAAC,CAAC,CAAhC;AAAkCC,EAAAA,sBAAsB,EAAC,CAAC,CAA1D;AAA4DC,EAAAA,cAAc,EAAC,IAA3E;AAAgFC,EAAAA,MAAM,EAAC,CAAC;AAAxF,CAAlB;;AAA6G,MAAMC,CAAN,CAAO;AAACC,EAAAA,WAAW,GAAE;AAAC,SAAKC,MAAL,GAAY,CAAZ;AAAc;;AAAS,MAALC,KAAK,GAAE;AAAC,WAAO,KAAKD,MAAZ;AAAmB;;AAAAE,EAAAA,SAAS,GAAE;AAAC,SAAKF,MAAL;AAAc;;AAAAG,EAAAA,SAAS,GAAE;AAAC,SAAKH,MAAL;AAAc;;AAAhH;;AAAiH,MAAMI,CAAC,GAAC;AAACC,EAAAA,KAAK,EAAC,CAAP;AAASC,EAAAA,MAAM,EAAC,CAAhB;AAAkBC,EAAAA,IAAI,EAAC;AAAvB,CAAR;;AAAkC,MAAMC,CAAN,CAAO;AAACT,EAAAA,WAAW,CAACrC,CAAD,EAAGE,CAAH,EAAKE,CAAL,EAAO;AAAC,SAAK2C,IAAL,GAAU/C,CAAV,EAAY,KAAKgD,yBAAL,GAA+B9C,CAA3C,EAA6C,KAAK+C,MAAL,GAAY,IAAItB,CAAC,CAACuB,aAAN,EAAzD,EAA6E,KAAKC,SAAL,GAAe,IAA5F,EAAiG,KAAKC,QAAL,GAAc,IAAIhB,CAAJ,EAA/G,EAAqH,KAAKiB,WAAL,GAAiB,IAAIC,GAAJ,EAAtI,EAA8I,KAAKC,iBAAL,GAAuB;AAAC,SAAE;AAAC,WAAE,IAAIlD,CAAJ,EAAH;AAAS,WAAE,IAAIA,CAAJ;AAAX,OAAH;AAAqB,SAAE;AAAC,WAAE,IAAIA,CAAJ,EAAH;AAAS,WAAE,IAAIA,CAAJ;AAAX;AAAvB,KAArK,EAA+M,KAAKmD,gBAAL,GAAsB,CAAC,CAAtO,EAAwO,KAAKC,QAAL,GAAc,EAAC,GAAG3B,CAAJ;AAAM,SAAG1B;AAAT,KAAtP,EAAkQ,KAAKsD,GAAL,GAASZ,CAAC,CAACa,MAAF,CAAS,KAAKF,QAAL,CAAc1B,IAAvB,EAA4B,KAAK0B,QAAL,CAAczB,iBAA1C,EAA4D,KAAKyB,QAAL,CAActB,MAA1E,CAA3Q;AAA6V,UAAM7B,CAAC,GAAC,KAAKmD,QAAL,CAAcvB,cAAd,CAA6B0B,QAArC;AAA8C,SAAKC,cAAL,GAAoB;AAACD,MAAAA,QAAQ,EAACtD,CAAV;AAAYwD,MAAAA,gBAAgB,EAAChD,CAAC,CAACiD;AAA/B,KAApB,EAAiG,KAAKd,MAAL,CAAYd,MAAZ,GAAmB,KAAKsB,QAAL,CAActB,MAAlI,EAAyI,KAAKc,MAAL,CAAYe,IAAZ,GAAiBtB,CAAC,CAAC,KAAKe,QAAL,CAAc1B,IAAf,CAA3J,EAAgL,KAAKkB,MAAL,CAAYgB,UAAZ,GAAuB,CAAC,CAAxM,EAA0M,KAAKhB,MAAL,CAAYiB,YAAZ,GAAyB,CAAC,CAAC,KAAKnB,IAAL,CAAUoB,YAAV,CAAuBC,WAA5P,EAAwQ,KAAKnB,MAAL,CAAYjB,iBAAZ,GAA8B,KAAKyB,QAAL,CAAczB,iBAApT,EAAsU,KAAKiB,MAAL,CAAY3B,kCAAZ,GAA+CC,CAAC,CAACvB,CAAD,CAAtX;AAA0X;;AAAAqE,EAAAA,OAAO,GAAE;AAAC,SAAKlB,SAAL,GAAejD,CAAC,CAAC,KAAKiD,SAAN,CAAhB;AAAiC;;AAAAmB,EAAAA,aAAa,CAACtE,CAAD,EAAG;AAAC,SAAKqD,WAAL,CAAiBkB,GAAjB,CAAqBvE,CAArB,GAAwB,KAAKwD,gBAAL,GAAsB,CAAC,CAA/C;AAAiD;;AAAAgB,EAAAA,gBAAgB,CAACxE,CAAD,EAAG;AAAC,SAAKqD,WAAL,CAAiBoB,MAAjB,CAAwBzE,CAAxB,GAA2B,KAAKwD,gBAAL,GAAsB,CAAC,CAAlD;AAAoD;;AAAAkB,EAAAA,mBAAmB,GAAE;AAAC,SAAKlB,gBAAL,GAAsB,CAAC,CAAvB;AAAyB;;AAAAmB,EAAAA,iBAAiB,CAAC3E,CAAD,EAAGE,CAAH,EAAK;AAAC,SAAKsD,gBAAL,IAAuB,KAAKoB,eAAL,EAAvB,EAA8C,KAAKrB,iBAAL,CAAuBrD,CAAvB,EAA0B,CAA1B,EAA6B2E,MAA7B,CAAoC7E,CAApC,CAA9C,EAAqF,KAAKuD,iBAAL,CAAuBrD,CAAvB,EAA0B,CAA1B,EAA6B2E,MAA7B,CAAoC7E,CAApC,CAArF;AAA4H;;AAAA8E,EAAAA,sBAAsB,CAAC9E,CAAD,EAAG;AAAC,SAAKiD,MAAL,CAAY8B,uBAAZ,GAAoC,CAAC,CAAC/E,CAAC,CAAC+E,uBAAJ,IAA6B/E,CAAC,CAAC+E,uBAAnE,EAA2F,KAAK9B,MAAL,CAAY+B,eAAZ,GAA4B,CAAC,CAAChF,CAAC,CAACgF,eAAJ,IAAqBhF,CAAC,CAACgF,eAA9I;AAA8J;;AAAAC,EAAAA,gBAAgB,CAACjF,CAAD,EAAGE,CAAH,EAAK;AAAC,SAAK4E,sBAAL,CAA4B9E,CAA5B,GAA+B,KAAKiD,MAAL,CAAYgB,UAAZ,GAAuB,CAAC,CAAvD,EAAyD,KAAKd,SAAL,GAAe,KAAKH,yBAAL,CAA+BkC,iBAA/B,CAAiDvD,CAAjD,EAAmD,KAAKsB,MAAxD,EAA+D,KAAKE,SAApE,CAAxE,EAAuJ,KAAKA,SAAL,CAAegC,QAAf,CAAwB;AAACC,MAAAA,cAAc,EAACpF,CAAhB;AAAkBqF,MAAAA,oBAAoB,EAACnF;AAAvC,KAAxB,CAAvJ,EAA0N,KAAK6C,IAAL,CAAUuC,gBAAV,CAA2B,KAAKnC,SAAL,CAAeoC,QAA1C,CAA1N,EAA8Q,KAAKxC,IAAL,CAAUyC,UAAV,CAAqB,KAAKrC,SAAL,CAAesC,OAApC,CAA9Q;AAA2T;;AAAAC,EAAAA,mBAAmB,CAAC1F,CAAD,EAAGE,CAAH,EAAK;AAAC,SAAK4E,sBAAL,CAA4B9E,CAA5B,GAA+B,KAAKiD,MAAL,CAAYgB,UAAZ,GAAuB,CAAC,CAAvD,EAAyD,KAAKd,SAAL,GAAe,KAAKH,yBAAL,CAA+BkC,iBAA/B,CAAiDvD,CAAjD,EAAmD,KAAKsB,MAAxD,EAA+D,KAAKE,SAApE,CAAxE,EAAuJ,KAAKA,SAAL,CAAegC,QAAf,CAAwB;AAACC,MAAAA,cAAc,EAACpF,CAAhB;AAAkBqF,MAAAA,oBAAoB,EAACnF;AAAvC,KAAxB,CAAvJ,EAA0N,KAAK6C,IAAL,CAAUuC,gBAAV,CAA2B,KAAKnC,SAAL,CAAeoC,QAA1C,CAA1N,EAA8Q,KAAKxC,IAAL,CAAUyC,UAAV,CAAqB,KAAKrC,SAAL,CAAesC,OAApC,CAA9Q;AAA2T;;AAAAE,EAAAA,kBAAkB,CAAC3F,CAAD,EAAGE,CAAH,EAAKE,CAAL,EAAO;AAAC,SAAKwF,MAAL,CAAY5F,CAAZ,EAAcA,CAAC,CAAC6F,OAAF,CAAUC,GAAxB,EAA4B5F,CAA5B,EAA8BE,CAA9B;AAAiC;;AAAA2F,EAAAA,qBAAqB,CAAC/F,CAAD,EAAGE,CAAH,EAAKE,CAAL,EAAO;AAAC,SAAKwF,MAAL,CAAY5F,CAAZ,EAAcA,CAAC,CAACiE,UAAF,CAAa6B,GAA3B,EAA+B5F,CAA/B,EAAiCE,CAAjC;AAAoC;;AAAAwF,EAAAA,MAAM,CAAC5F,CAAD,EAAGE,CAAH,EAAKE,CAAL,EAAOC,CAAP,EAAS;AAAC,SAAK2F,WAAL,CAAiBhG,CAAjB,EAAmBI,CAAnB,GAAsB,KAAK2C,IAAL,CAAUkD,OAAV,CAAkB/F,CAAlB,CAAtB,EAA2C,KAAK6C,IAAL,CAAUoB,YAAV,CAAuB+B,UAAvB,CAAkCC,mBAAlC,CAAsD,CAAtD,EAAwD,CAAxD,EAA0D,CAA1D,EAA4D9F,CAA5D,CAA3C;AAA0G;;AAAA2F,EAAAA,WAAW,CAAChG,CAAD,EAAGE,CAAH,EAAK;AAAC,UAAME,CAAC,GAAC,KAAK+C,SAAL,CAAesC,OAAvB;AAA+B,QAAGzF,CAAC,CAACoG,UAAF,CAAaC,MAAb,CAAoBC,aAApB,CAAkCC,IAAlC,CAAuCnG,CAAvC,EAAyCoG,CAAzC,EAA2CC,CAA3C,GAA8CvG,CAAC,CAAC6E,uBAAF,KAA4B3E,CAAC,CAACsG,aAAF,CAAgB,eAAhB,EAAgCxG,CAAC,CAACyG,MAAF,CAASC,OAAzC,GAAkDxG,CAAC,CAACsG,aAAF,CAAgB,iBAAhB,EAAkCxG,CAAC,CAAC2G,eAApC,CAAlD,EAAuGrG,CAAC,CAACJ,CAAD,EAAGF,CAAH,CAApI,CAA9C,EAAyL,YAAWF,CAAC,CAAC8G,SAAzM,EAAmN1G,CAAC,CAAC2G,mBAAF,CAAsB,OAAtB,EAA8B7G,CAAC,CAAC8G,uBAAhC,GAAyD5G,CAAC,CAAC2G,mBAAF,CAAsB,QAAtB,EAA+B/G,CAAC,CAAC8G,SAAF,CAAYG,WAA3C,CAAzD,EAAiH/F,CAAC,CAACd,CAAD,EAAG,KAAKqD,QAAR,EAAiBvD,CAAC,CAACgH,UAAnB,EAA8BlH,CAAC,CAAC8G,SAAF,CAAYK,MAAZ,CAAmBC,IAAjD,CAAlH,CAAnN,KAAgY;AAAC,YAAM/G,CAAC,GAAC,IAAIoB,CAAJ,CAAMzB,CAAC,CAAC8G,SAAF,CAAYO,QAAlB,CAAR;AAAA,YAAoC1G,CAAC,GAACL,CAAC,CAACgH,CAAD,EAAG/G,CAAC,CAAC+G,CAAD,EAAGtH,CAAC,CAAC8G,SAAF,CAAYS,aAAf,CAAJ,CAAvC;AAAA,YAA0E7G,CAAC,GAAC,IAAIM,CAAJ,EAA5E;AAAkFJ,MAAAA,CAAC,CAACF,CAAC,CAAC8G,iBAAH,EAAqBnH,CAAC,CAACoH,GAAvB,CAAD,EAA6B7G,CAAC,CAACF,CAAC,CAACgH,iBAAH,EAAqBrH,CAAC,CAACsH,IAAvB,CAA9B,EAA2DlH,CAAC,CAACC,CAAC,CAACkH,iBAAH,EAAqB5H,CAAC,CAAC8G,SAAF,CAAYS,aAAjC,CAA5D,EAA4G9G,CAAC,CAACC,CAAC,CAACmH,+BAAH,EAAmClH,CAAnC,CAA7G,EAAmJS,CAAC,CAAC0G,kBAAF,CAAqB1H,CAArB,EAAuBM,CAAvB,CAAnJ,EAA6KN,CAAC,CAAC2H,mBAAF,CAAsB,kCAAtB,EAAyDrH,CAAC,CAACmH,+BAA3D,CAA7K;AAAyQ,YAAM/G,CAAC,GAACZ,CAAC,CAACyG,MAAF,CAASqB,0BAAjB;AAAA,YAA4CxH,CAAC,GAACK,CAAC,CAACoH,CAAD,EAAGnH,CAAC,CAAC,CAAD,CAAJ,EAAQA,CAAC,CAAC,CAAD,CAAT,EAAaA,CAAC,CAAC,EAAD,CAAd,CAA/C;AAAmEI,MAAAA,CAAC,CAACd,CAAD,EAAG,KAAKqD,QAAR,EAAiBvD,CAAC,CAACgH,UAAnB,EAA8B1G,CAA9B,CAAD;AAAkC;AAAA,eAAS,KAAKiD,QAAL,CAAc1B,IAAvB,IAA6B,aAAW,KAAK0B,QAAL,CAAc1B,IAAtD,IAA4D,KAAKmG,iBAAL,CAAuB9H,CAAvB,CAA5D,EAAsFA,CAAC,CAAC+H,YAAF,CAAe,6BAAf,EAA6CC,IAAI,CAACC,GAAL,CAASnI,CAAC,CAACyG,MAAF,CAAS2B,IAAT,GAAc,CAAvB,KAA2BpI,CAAC,CAACyG,MAAF,CAAS4B,YAAT,CAAsB,CAAtB,IAAyB,CAApD,CAA7C,CAAtF;AAA2L;;AAAAL,EAAAA,iBAAiB,CAAChI,CAAD,EAAG;AAAC,UAAMG,CAAC,GAAC,KAAKoD,QAAL,CAAcvB,cAAtB;AAAA,UAAqC5B,CAAC,GAACD,CAAC,CAACmI,OAAzC;AAAiDpI,IAAAA,CAAC,CAACE,CAAD,CAAD,KAAOJ,CAAC,CAACuI,WAAF,CAAcnI,CAAd,EAAgB,iBAAhB,GAAmCJ,CAAC,CAACwI,YAAF,CAAe,sBAAf,EAAsC,IAAEpI,CAAC,CAACqI,UAAF,CAAaC,KAArD,EAA2D,IAAEtI,CAAC,CAACqI,UAAF,CAAaE,MAA1E,CAAnC,EAAqH3I,CAAC,CAACiI,YAAF,CAAe,wBAAf,EAAwCnI,CAAC,CAACK,CAAC,CAACyI,UAAH,CAAzC,CAArH,EAA8K5I,CAAC,CAACiI,YAAF,CAAe,4BAAf,EAA4C9H,CAAC,CAAC0I,kBAA9C,CAA9K,EAAgP7I,CAAC,CAACiI,YAAF,CAAe,mBAAf,EAAmC9H,CAAC,CAAC2I,SAArC,CAAhP,EAAgS9I,CAAC,CAACiI,YAAF,CAAe,iBAAf,EAAiC9H,CAAC,CAACuD,QAAnC,CAAvS;AAAqV;;AAAAgB,EAAAA,eAAe,GAAE;AAAC,SAAKpB,gBAAL,GAAsB,CAAC,CAAvB,EAAyB,KAAKD,iBAAL,CAAuB,CAAvB,EAA0B,CAA1B,EAA6B0F,KAA7B,EAAzB,EAA8D,KAAK1F,iBAAL,CAAuB,CAAvB,EAA0B,CAA1B,EAA6B0F,KAA7B,EAA9D,EAAmG,KAAK1F,iBAAL,CAAuB,CAAvB,EAA0B,CAA1B,EAA6B0F,KAA7B,EAAnG,EAAwI,KAAK1F,iBAAL,CAAuB,CAAvB,EAA0B,CAA1B,EAA6B0F,KAA7B,EAAxI,EAA6K,KAAK5F,WAAL,CAAiB6F,OAAjB,CAA0BlJ,CAAC,IAAE;AAAC,YAAIA,CAAC,CAACmJ,kBAAN,IAA0B,MAAInJ,CAAC,CAACoJ,gBAAhC,IAAkD,KAAK7F,iBAAL,CAAuBvD,CAAC,CAACmJ,kBAAzB,EAA6CnJ,CAAC,CAACoJ,gBAA/C,EAAiEC,IAAjE,CAAsErJ,CAAtE,CAAlD;AAA2H,KAAzJ,CAA7K;;AAAyU,UAAMA,CAAC,GAAC,CAACA,CAAD,EAAGE,CAAH,KAAO,YAAWF,CAAC,CAAC8G,SAAb,IAAwB,YAAW5G,CAAC,CAAC4G,SAArC,GAA+C9G,CAAC,CAAC8G,SAAF,CAAYK,MAAZ,CAAmBmC,EAAnB,GAAsBpJ,CAAC,CAAC4G,SAAF,CAAYK,MAAZ,CAAmBmC,EAAzC,GAA4C,CAAC,CAA7C,GAA+CtJ,CAAC,CAAC8G,SAAF,CAAYK,MAAZ,CAAmBmC,EAAnB,GAAsBpJ,CAAC,CAAC4G,SAAF,CAAYK,MAAZ,CAAmBmC,EAAzC,GAA4C,CAA5C,GAA8C,CAA5I,GAA8I,CAA7J;;AAA+J,SAAK/F,iBAAL,CAAuB,CAAvB,EAA0B,CAA1B,EAA6BgG,IAA7B,CAAkCvJ,CAAlC,GAAqC,KAAKuD,iBAAL,CAAuB,CAAvB,EAA0B,CAA1B,EAA6BgG,IAA7B,CAAkCvJ,CAAlC,CAArC,EAA0E,KAAKuD,iBAAL,CAAuB,CAAvB,EAA0B,CAA1B,EAA6BgG,IAA7B,CAAkCvJ,CAAlC,CAA1E,EAA+G,KAAKuD,iBAAL,CAAuB,CAAvB,EAA0B,CAA1B,EAA6BgG,IAA7B,CAAkCvJ,CAAlC,CAA/G;AAAoJ;;AAAa,SAAN2D,MAAM,CAAC3D,CAAD,EAAGE,CAAH,EAAKE,CAAL,EAAO;AAAC,WAAO,WAAUJ,CAAE,IAAGE,CAAE,IAAGE,CAAE,EAA7B;AAA+B;;AAA52I;;AAA62I,MAAMoG,CAAC,GAAC,mBAAR;AAAA,MAA4BC,CAAC,GAAC,yBAA9B;AAAA,MAAwDa,CAAC,GAAC3G,CAAC,EAA3D;AAAA,MAA8DsH,CAAC,GAACvH,CAAC,EAAjE;AAAoE,SAAOmB,CAAC,IAAI2H,uBAAZ,EAAoC1G,CAAC,IAAI2G,YAAzC,EAAsD7H,CAAC,IAAI8H,0BAA3D,EAAsFjD,CAAC,IAAIkD,uBAA3F,EAAmHnD,CAAC,IAAIoD,oBAAxH","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{log2 as e}from\"../../../../../core/mathUtils.js\";import{releaseMaybe as t,isNone as s}from\"../../../../../core/maybe.js\";import r from\"../../../../../core/PooledArray.js\";import{t as i,e as n,g as o}from\"../../../../../chunks/mat3.js\";import{c as a}from\"../../../../../chunks/mat3f32.js\";import{g as l,s as h}from\"../../../../../chunks/vec3.js\";import{c}from\"../../../../../chunks/vec3f64.js\";import d from\"../../../support/debugFlags.js\";import{ComponentDrawParameters as m}from\"../../collections/Component/Material/ComponentTechnique.js\";import{bindSliceUniforms as u}from\"../../core/shaderLibrary/Slice.glsl.js\";import{VertexPosition as f}from\"../../core/shaderLibrary/attributes/VertexPosition.glsl.js\";import{bindMultipassTerrainTexture as g}from\"../../core/shaderLibrary/shading/MultipassTerrainTest.glsl.js\";import{doublePrecisionRequiresObfuscation as b}from\"../../core/shaderLibrary/util/DoublePrecision.glsl.js\";import{TwoVectorPosition as p}from\"../../core/util/TwoVectorPosition.js\";import{EdgeShaderTechnique as y}from\"./EdgeShaderTechnique.js\";const T=8,R=128,v={type:\"uber\",slicePlaneEnabled:!1,sliceHighlightDisabled:!1,strokesTexture:null,legacy:!0};class x{constructor(){this._value=0}get value(){return this._value}increment(){this._value++}decrement(){this._value--}}const P={solid:0,sketch:1,uber:2};class S{constructor(e,t,s){this.rctx=e,this.shaderTechniqueRepository=t,this.config=new y.Configuration,this.technique=null,this.refCount=new x,this.renderables=new Set,this.sortedRenderables={1:{1:new r,2:new r},2:{1:new r,2:new r}},this.renderablesDirty=!1,this.settings={...v,...s},this.key=S.getKey(this.settings.type,this.settings.slicePlaneEnabled,this.settings.legacy);const i=this.settings.strokesTexture.variants;this.writerSettings={variants:i,reducedPrecision:d.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES},this.config.legacy=this.settings.legacy,this.config.mode=P[this.settings.type],this.config.silhouette=!1,this.config.antialiasing=!!this.rctx.capabilities.blendMinMax,this.config.slicePlaneEnabled=this.settings.slicePlaneEnabled,this.config.doublePrecisionRequiresObfuscation=b(e)}dispose(){this.technique=t(this.technique)}addRenderable(e){this.renderables.add(e),this.renderablesDirty=!0}removeRenderable(e){this.renderables.delete(e),this.renderablesDirty=!0}setRenderablesDirty(){this.renderablesDirty=!0}forEachRenderable(e,t){this.renderablesDirty&&this.sortRenderables(),this.sortedRenderables[t][1].forAll(e),this.sortedRenderables[t][2].forAll(e)}setMultipassParameters(e){this.config.multipassTerrainEnabled=!!e.multipassTerrainEnabled&&e.multipassTerrainEnabled,this.config.cullAboveGround=!!e.cullAboveGround&&e.cullAboveGround}bindRegularEdges(e,t){this.setMultipassParameters(e),this.config.silhouette=!1,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(y,this.config,this.technique),this.technique.bindPass({bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.useProgram(this.technique.program)}bindSilhouetteEdges(e,t){this.setMultipassParameters(e),this.config.silhouette=!0,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(y,this.config,this.technique),this.technique.bindPass({bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.useProgram(this.technique.program)}renderRegularEdges(e,t,s){this.render(e,e.regular.vao,t,s)}renderSilhouetteEdges(e,t,s){this.render(e,e.silhouette.vao,t,s)}render(e,t,s,r){this.setUniforms(e,s),this.rctx.bindVAO(t),this.rctx.capabilities.instancing.drawArraysInstanced(6,0,4,r)}setUniforms(e,t){const s=this.technique.program;if(e.components.buffer.textureBuffer.bind(s,w,E),t.multipassTerrainEnabled&&(s.setUniform2fv(\"cameraNearFar\",t.camera.nearFar),s.setUniform2fv(\"inverseViewport\",t.inverseViewport),g(s,t)),\"origin\"in e.transform)s.setUniformMatrix4fv(\"uView\",t.localViewMatrixForEdges),s.setUniformMatrix4fv(\"uModel\",e.transform.modelMatrix),u(s,this.settings,t.slicePlane,e.transform.origin.vec3);else{const r=new p(e.transform.position),a=i(q,n(q,e.transform.rotationScale)),c=new m;l(c.worldFromModel_TL,r.low),l(c.worldFromModel_TH,r.high),o(c.worldFromModel_RS,e.transform.rotationScale),o(c.transformNormal_GlobalFromModel,a),f.bindModelTransform(s,c),s.setUniformMatrix3fv(\"uTransformNormal_GlobalFromModel\",c.transformNormal_GlobalFromModel);const d=t.camera.viewInverseTransposeMatrix,g=h(M,d[3],d[7],d[11]);u(s,this.settings,t.slicePlane,g)}\"uber\"!==this.settings.type&&\"sketch\"!==this.settings.type||this.setSketchUniforms(s),s.setUniform1f(\"uWorldLineRadiusPerDistance\",Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[3]/2))}setSketchUniforms(t){const r=this.settings.strokesTexture,i=r.texture;s(i)||(t.bindTexture(i,\"uStrokesTexture\"),t.setUniform2f(\"uStrokesTextureScale\",1/i.descriptor.width,1/i.descriptor.height),t.setUniform1f(\"uStrokesLog2Resolution\",e(r.resolution)),t.setUniform1f(\"uStrokesNormalizationScale\",r.normalizationScale),t.setUniform1f(\"uStrokesAmplitude\",r.amplitude),t.setUniform1f(\"uStrokeVariants\",r.variants))}sortRenderables(){this.renderablesDirty=!1,this.sortedRenderables[1][1].clear(),this.sortedRenderables[1][2].clear(),this.sortedRenderables[2][1].clear(),this.sortedRenderables[2][2].clear(),this.renderables.forEach((e=>{0!==e.objectTransparency&&0!==e.edgeTransparency&&this.sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e)}));const e=(e,t)=>\"origin\"in e.transform&&\"origin\"in t.transform?e.transform.origin.id<t.transform.origin.id?-1:e.transform.origin.id>t.transform.origin.id?1:0:0;this.sortedRenderables[1][1].sort(e),this.sortedRenderables[1][2].sort(e),this.sortedRenderables[2][1].sort(e),this.sortedRenderables[2][2].sort(e)}static getKey(e,t,s){return`edges-t:${e}:${t}:${s}`}}const w=\"uComponentDataTex\",E=\"uComponentDataTexInvDim\",q=a(),M=c();export{R as EXTENSION_LENGTH_OFFSET,S as EdgeRenderer,T as LINE_WIDTH_FRACTION_FACTOR,E as componentDataInvDimName,w as componentDataTexName};\n"]},"metadata":{},"sourceType":"module"}