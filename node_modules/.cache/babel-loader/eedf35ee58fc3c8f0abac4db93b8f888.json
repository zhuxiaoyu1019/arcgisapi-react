{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { BufferViewVec3f as t, BufferViewMat3f as i, BufferViewVec4f as e } from \"../../../../../geometry/support/buffer/BufferView.js\";\nimport { assert as s } from \"../Util.js\";\nimport a from \"./BackedBufferObject.js\";\n\nclass n {\n  constructor(s) {\n    this.modelOriginHi = s.getField(\"modelOriginHi\", t), this.modelOriginLo = s.getField(\"modelOriginLo\", t), this.model = s.getField(\"model\", i), this.modelNormal = s.getField(\"modelNormal\", i), this.color = s.getField(\"instanceColor\", e), this.featureAttribute = s.getField(\"instanceFeatureAttribute\", e);\n  }\n\n}\n\nclass r {\n  constructor(t, i) {\n    this._headIndex = 0, this._tailIndex = 0, this._captureFirstIndex = !0, this._updating = !1, this._prevHeadIndex = 0, this._resized = !1, this._rctx = t, this._instanceBufferLayout = i, this._elementSize = i.stride, this._capacity = 1;\n  }\n\n  destroy() {\n    this._buffer && this._buffer.destroy();\n  }\n\n  get buffer() {\n    return this._buffer.buffer;\n  }\n\n  get view() {\n    return this._view;\n  }\n\n  get capacity() {\n    return this._capacity;\n  }\n\n  get size() {\n    const t = this._headIndex,\n          i = this._tailIndex;\n    return t >= i ? t - i : t + this._capacity - i;\n  }\n\n  get isEmpty() {\n    return this._headIndex === this._tailIndex;\n  }\n\n  get isFull() {\n    return this._tailIndex === (this._headIndex + 1) % this._capacity;\n  }\n\n  get headIndex() {\n    return this._headIndex;\n  }\n\n  get tailIndex() {\n    return this._tailIndex;\n  }\n\n  get firstIndex() {\n    return this._firstIndex;\n  }\n\n  get memoryUsage() {\n    return this._buffer ? this._buffer.memoryUsage : {\n      cpu: 0,\n      gpu: 0\n    };\n  }\n\n  reset() {\n    this._headIndex = 0, this._tailIndex = 0, this._firstIndex = null;\n  }\n\n  startUpdateCylce() {\n    this._captureFirstIndex = !0;\n  }\n\n  beginUpdate() {\n    s(!this._updating, \"already updating\"), this._updating = !0, this._prevHeadIndex = this._headIndex;\n  }\n\n  endUpdate() {\n    s(this._updating, \"not updating\"), this.size < _ * this.capacity && this.shrink(), this._resized ? (this._buffer.transferAll(), this._resized = !1) : this.transferRange(this._prevHeadIndex, this._headIndex), this._updating = !1;\n  }\n\n  allocateHead() {\n    s(this._updating, \"not updating\"), this.isFull && this.grow();\n    const t = this.headIndex;\n    return this._captureFirstIndex && (this._firstIndex = t, this._captureFirstIndex = !1), this.incrementHead(), s(this._headIndex !== this._tailIndex, \"invalid pointers\"), t;\n  }\n\n  freeTail() {\n    s(this._updating, \"not updating\"), s(this.size > 0, \"invalid size\");\n    const t = this._tailIndex === this._firstIndex;\n    this.incrementTail(), t && (this._firstIndex = this._tailIndex);\n  }\n\n  grow() {\n    const t = Math.max(h, Math.floor(this._capacity * d));\n    this.resize(t);\n  }\n\n  shrink() {\n    const t = Math.max(h, Math.floor(this._capacity * c));\n    this.resize(t);\n  }\n\n  resize(t) {\n    if (s(this._updating, \"not updating\"), t === this._capacity) return;\n    const i = new a(this._rctx, this._elementSize, t);\n\n    if (this._buffer) {\n      this._firstIndex && (this._firstIndex = (this._firstIndex + this._capacity - this._tailIndex) % this._capacity);\n      const t = this.size,\n            e = this.compactInstances(i);\n      s(e === t, \"invalid compaction\"), this._buffer.destroy(), this._tailIndex = 0, this._headIndex = e, this._prevHeadIndex = 0;\n    }\n\n    this._resized = !0, this._capacity = t, this._buffer = i, this._view = new n(this._instanceBufferLayout.createView(this._buffer.array));\n  }\n\n  compactInstances(t) {\n    const i = this._headIndex,\n          e = this._tailIndex;\n    return e < i ? (this._buffer.copyRange(e, i, t), i - e) : e > i ? (this._buffer.copyRange(e, this._capacity, t), i > 0 && this._buffer.copyRange(0, i, t, this._capacity - e), i + (this._capacity - e)) : 0;\n  }\n\n  incrementHead(t = 1) {\n    this._headIndex = (this._headIndex + t) % this._capacity;\n  }\n\n  incrementTail(t = 1) {\n    this._tailIndex = (this._tailIndex + t) % this._capacity;\n  }\n\n  transferRange(t, i) {\n    t < i ? this._buffer.transferRange(t, i) : t > i && (i > 0 && this._buffer.transferRange(0, i), this._buffer.transferRange(t, this._capacity));\n  }\n\n}\n\nconst h = 1024,\n      d = 2,\n      _ = .3,\n      c = .5;\nexport { r as RenderInstanceData, n as RenderInstanceDataView };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/webgl-engine/lib/lodRendering/RenderInstanceData.js"],"names":["BufferViewVec3f","t","BufferViewMat3f","i","BufferViewVec4f","e","assert","s","a","n","constructor","modelOriginHi","getField","modelOriginLo","model","modelNormal","color","featureAttribute","r","_headIndex","_tailIndex","_captureFirstIndex","_updating","_prevHeadIndex","_resized","_rctx","_instanceBufferLayout","_elementSize","stride","_capacity","destroy","_buffer","buffer","view","_view","capacity","size","isEmpty","isFull","headIndex","tailIndex","firstIndex","_firstIndex","memoryUsage","cpu","gpu","reset","startUpdateCylce","beginUpdate","endUpdate","_","shrink","transferAll","transferRange","allocateHead","grow","incrementHead","freeTail","incrementTail","Math","max","h","floor","d","resize","c","compactInstances","createView","array","copyRange","RenderInstanceData","RenderInstanceDataView"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{BufferViewVec3f as t,BufferViewMat3f as i,BufferViewVec4f as e}from\"../../../../../geometry/support/buffer/BufferView.js\";import{assert as s}from\"../Util.js\";import a from\"./BackedBufferObject.js\";class n{constructor(s){this.modelOriginHi=s.getField(\"modelOriginHi\",t),this.modelOriginLo=s.getField(\"modelOriginLo\",t),this.model=s.getField(\"model\",i),this.modelNormal=s.getField(\"modelNormal\",i),this.color=s.getField(\"instanceColor\",e),this.featureAttribute=s.getField(\"instanceFeatureAttribute\",e)}}class r{constructor(t,i){this._headIndex=0,this._tailIndex=0,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=t,this._instanceBufferLayout=i,this._elementSize=i.stride,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const t=this._headIndex,i=this._tailIndex;return t>=i?t-i:t+this._capacity-i}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCylce(){this._captureFirstIndex=!0}beginUpdate(){s(!this._updating,\"already updating\"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){s(this._updating,\"not updating\"),this.size<_*this.capacity&&this.shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this.transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){s(this._updating,\"not updating\"),this.isFull&&this.grow();const t=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=t,this._captureFirstIndex=!1),this.incrementHead(),s(this._headIndex!==this._tailIndex,\"invalid pointers\"),t}freeTail(){s(this._updating,\"not updating\"),s(this.size>0,\"invalid size\");const t=this._tailIndex===this._firstIndex;this.incrementTail(),t&&(this._firstIndex=this._tailIndex)}grow(){const t=Math.max(h,Math.floor(this._capacity*d));this.resize(t)}shrink(){const t=Math.max(h,Math.floor(this._capacity*c));this.resize(t)}resize(t){if(s(this._updating,\"not updating\"),t===this._capacity)return;const i=new a(this._rctx,this._elementSize,t);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const t=this.size,e=this.compactInstances(i);s(e===t,\"invalid compaction\"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=e,this._prevHeadIndex=0}this._resized=!0,this._capacity=t,this._buffer=i,this._view=new n(this._instanceBufferLayout.createView(this._buffer.array))}compactInstances(t){const i=this._headIndex,e=this._tailIndex;return e<i?(this._buffer.copyRange(e,i,t),i-e):e>i?(this._buffer.copyRange(e,this._capacity,t),i>0&&this._buffer.copyRange(0,i,t,this._capacity-e),i+(this._capacity-e)):0}incrementHead(t=1){this._headIndex=(this._headIndex+t)%this._capacity}incrementTail(t=1){this._tailIndex=(this._tailIndex+t)%this._capacity}transferRange(t,i){t<i?this._buffer.transferRange(t,i):t>i&&(i>0&&this._buffer.transferRange(0,i),this._buffer.transferRange(t,this._capacity))}}const h=1024,d=2,_=.3,c=.5;export{r as RenderInstanceData,n as RenderInstanceDataView};\n"]},"metadata":{},"sourceType":"module"}