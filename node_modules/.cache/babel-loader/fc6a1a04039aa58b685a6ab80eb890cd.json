{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport { _ as e } from \"../../../../../chunks/tslib.es6.js\";\nimport i from \"../../../../../core/Accessor.js\";\nimport t from \"../../../../../core/Handles.js\";\nimport a from \"../../../../../core/Logger.js\";\nimport { isNone as r, isSome as l } from \"../../../../../core/maybe.js\";\nimport { whenOnce as s } from \"../../../../../core/watchUtils.js\";\nimport { property as n } from \"../../../../../core/accessorSupport/decorators/property.js\";\nimport \"../../../../../core/has.js\";\nimport \"../../../../../core/accessorSupport/ensureType.js\";\nimport { subclass as o } from \"../../../../../core/accessorSupport/decorators/subclass.js\";\nimport { a as c } from \"../../../../../chunks/boundedPlane.js\";\nimport d from \"../../../../../layers/Layer.js\";\nimport h from \"../../../../../layers/buildingSublayers/BuildingComponentSublayer.js\";\nimport { isAlwaysDrapedLayer as y, shapeToPlane as u, forceHorizontalOrVertical as p, planeToShape as w } from \"../../analysisTools/slice/sliceToolUtils.js\";\nimport v from \"../../../../../widgets/Slice/SlicePlane.js\";\nconst V = a.getLogger(\"esri.views.3d.interactive.graphics.Slice.SliceController\");\nlet f = class extends i {\n  constructor(e) {\n    super(e), this._handles = new t(), this._internalChange = !1, this._currentSlicePlane = null, this.state = \"pending\";\n  }\n\n  get ready() {\n    return \"ready\" === this.state;\n  }\n\n  initialize() {\n    this._handles.add(this.layerView.layerViewData.excludedLayers.on(\"before-add\", e => {\n      const i = e.item;\n      null != i && (i instanceof d || i instanceof h) ? i instanceof d && y(i) ? (V.error(\"excludedLayers\", `Layer '${i.title}, id:${i.id}' of type '${i.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`), e.preventDefault()) : this.layerView.layerViewData.excludedLayers.includes(i) && e.preventDefault() : (V.error(\"excludedLayers\", \"Invalid layer type, layer must derive from Layer or BuildingComponentSublayer\"), e.preventDefault());\n    })), this._handles.add(s(this.view, \"ready\", () => this._initialize(), !0));\n  }\n\n  _initialize() {\n    switch (this.state) {\n      case \"pending\":\n        break;\n\n      case \"destroyed\":\n        return;\n\n      case \"ready\":\n        throw new Error(\"state error\");\n    }\n\n    C(this.view, this), this._handles.add([this.layerView.layerViewData.watch(\"plane\", () => {\n      this._internalChange || this._updateSlicePlaneFromBoundedPlane(), this._updateLayerViews();\n    }, !0), this.layerView.layerViewData.watch(\"excludeGroundSurface\", () => this._updateLayerViews(), !0), this.layerView.layerViewData.excludedLayers.on(\"change\", () => this._updateLayerViews()), this.layerView.watch([\"active\", \"visible\"], () => {\n      this._updateActiveController(), this._updateViewSlicePlane();\n    }, !0), this.view.allLayerViews.on(\"change\", () => this._updateLayerViews())]), this._handles.add([this.analysis.watch(\"plane\", () => {\n      this._internalChange || (this._updateBoundedPlaneFromSlicePlane(), this._updateViewSlicePlane());\n    }, !0)], \"analysis\"), this._set(\"state\", \"ready\"), this._updateActiveController(), this._updateBoundedPlaneFromSlicePlane(), this._updateViewSlicePlane();\n  }\n\n  destroy() {\n    switch (this.state) {\n      case \"destroyed\":\n      case \"pending\":\n        return;\n    }\n\n    this.layerView.active = !1, P(this.view, this), this._handles.destroy(), this.view.slicePlane = null, this.set(\"view\", null), this._set(\"state\", \"destroyed\");\n  }\n\n  async whenReady() {\n    return await s(this, \"ready\"), this;\n  }\n\n  _updateBoundedPlaneFromSlicePlane() {\n    const e = this.analysis.plane,\n          i = this._currentSlicePlane;\n    if (r(i) && r(e) || l(i) && l(e) && e.equals(i)) return;\n    let t = null,\n        a = null;\n    l(e) && (t = u(e, this.view.renderCoordsHelper, c()), l(t) ? a = {\n      heading: e.heading,\n      tilt: e.tilt,\n      position: e.position,\n      width: e.width,\n      height: e.height\n    } : console.warn(\"Failed slice plane conversion.\")), this._currentSlicePlane = a, l(t) && !this.analysis.tiltEnabled && p(t, this.view.renderCoordsHelper, t), this._internalChange = !0, this.layerView.layerViewData.plane = t, this._internalChange = !1;\n  }\n\n  _updateSlicePlaneFromBoundedPlane() {\n    const e = this.layerView.layerViewData.plane,\n          i = w(e, this.view.renderCoordsHelper, this.view.spatialReference, new v());\n    let t = null;\n    l(i) && (t = {\n      heading: i.heading,\n      tilt: i.tilt,\n      position: i.position,\n      width: i.width,\n      height: i.height\n    }), this._currentSlicePlane = t, l(e) && (this.analysis.tiltEnabled || p(e, this.view.renderCoordsHelper, e)), this._internalChange = !0, this.analysis.plane = i, this._internalChange = !1, this._updateViewSlicePlane();\n  }\n\n  _updateActiveController() {\n    if (_) return;\n    const e = S(this.view);\n    if (this.layerView.active) l(e.activeController) && e.activeController !== this ? (_ = !0, e.activeController.layerView.active = !1, _ = !1) : l(e.activeController) && e.activeController, this._updateLayerViews(), e.activeController = this;else {\n      if (l(e.activeController) && e.activeController !== this) return;\n      l(e.activeController) && e.activeController === this && (e.activeController = null, this._updateLayerViews());\n    }\n  }\n\n  _updateViewSlicePlane() {\n    \"ready\" === this.state && g(this.view);\n  }\n\n  _updateLayerViews() {\n    const e = l(this.layerView.layerViewData.plane) && this.layerView.visible && this.layerView.active,\n          i = [],\n          t = e => {\n      \"layers\" in e ? e.layers.forEach(t) : i.push(e);\n    };\n\n    this.layerView.layerViewData.excludedLayers.forEach(t), this.view.allLayerViews.forEach(t => {\n      \"slicePlaneEnabled\" in t && (t.slicePlaneEnabled = e && i.indexOf(t.layer) < 0), \"sublayerViews\" in t && t.sublayerViews.forEach(t => {\n        t.slicePlaneEnabled = e && i.indexOf(t.sublayer) < 0;\n      });\n    }), null != this.view.basemapTerrain && (this.view.basemapTerrain.slicePlaneEnabled = e && !this.layerView.layerViewData.excludeGroundSurface);\n  }\n\n};\ne([n({\n  readOnly: !0\n})], f.prototype, \"state\", void 0), e([n()], f.prototype, \"view\", void 0), e([n()], f.prototype, \"analysis\", void 0), e([n()], f.prototype, \"layerView\", void 0), e([n()], f.prototype, \"ready\", null), f = e([o(\"esri.views.3d.interactive.graphics.Slice.SliceController\")], f);\nconst m = new Map();\n\nlet _ = !1;\n\nfunction g(e) {\n  const i = S(e).activeController;\n  l(i) && l(i.layerView.layerViewData.plane) && i.layerView.visible ? e.slicePlane = i.layerView.layerViewData.plane : e.slicePlane = null;\n}\n\nfunction C(e, i) {\n  m.has(e) || m.set(e, {\n    all: [],\n    activeController: null\n  }), m.get(e).all.push(i);\n}\n\nfunction S(e) {\n  return m.get(e);\n}\n\nfunction P(e, i) {\n  if (!m.has(e)) throw new Error(\"view expected in global slice register\");\n  const t = m.get(e),\n        a = t.all.lastIndexOf(i);\n  if (-1 === a) throw new Error(\"controller expected in global slice register\");\n  t.all.splice(a, 1), 0 === t.all.length && m.delete(e);\n}\n\nexport { f as SliceController };","map":{"version":3,"sources":["/Users/xiaoyuzhu/Desktop/arcgisapi-react/node_modules/@arcgis/core/views/3d/interactive/graphics/Slice/SliceController.js"],"names":["_","e","i","t","a","isNone","r","isSome","l","whenOnce","s","property","n","subclass","o","c","d","h","isAlwaysDrapedLayer","y","shapeToPlane","u","forceHorizontalOrVertical","p","planeToShape","w","v","V","getLogger","f","constructor","_handles","_internalChange","_currentSlicePlane","state","ready","initialize","add","layerView","layerViewData","excludedLayers","on","item","error","title","id","type","preventDefault","includes","view","_initialize","Error","C","watch","_updateSlicePlaneFromBoundedPlane","_updateLayerViews","_updateActiveController","_updateViewSlicePlane","allLayerViews","analysis","_updateBoundedPlaneFromSlicePlane","_set","destroy","active","P","slicePlane","set","whenReady","plane","equals","renderCoordsHelper","heading","tilt","position","width","height","console","warn","tiltEnabled","spatialReference","S","activeController","g","visible","layers","forEach","push","slicePlaneEnabled","indexOf","layer","sublayerViews","sublayer","basemapTerrain","excludeGroundSurface","readOnly","prototype","m","Map","has","all","get","lastIndexOf","splice","length","delete","SliceController"],"mappings":"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","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../../chunks/tslib.es6.js\";import i from\"../../../../../core/Accessor.js\";import t from\"../../../../../core/Handles.js\";import a from\"../../../../../core/Logger.js\";import{isNone as r,isSome as l}from\"../../../../../core/maybe.js\";import{whenOnce as s}from\"../../../../../core/watchUtils.js\";import{property as n}from\"../../../../../core/accessorSupport/decorators/property.js\";import\"../../../../../core/has.js\";import\"../../../../../core/accessorSupport/ensureType.js\";import{subclass as o}from\"../../../../../core/accessorSupport/decorators/subclass.js\";import{a as c}from\"../../../../../chunks/boundedPlane.js\";import d from\"../../../../../layers/Layer.js\";import h from\"../../../../../layers/buildingSublayers/BuildingComponentSublayer.js\";import{isAlwaysDrapedLayer as y,shapeToPlane as u,forceHorizontalOrVertical as p,planeToShape as w}from\"../../analysisTools/slice/sliceToolUtils.js\";import v from\"../../../../../widgets/Slice/SlicePlane.js\";const V=a.getLogger(\"esri.views.3d.interactive.graphics.Slice.SliceController\");let f=class extends i{constructor(e){super(e),this._handles=new t,this._internalChange=!1,this._currentSlicePlane=null,this.state=\"pending\"}get ready(){return\"ready\"===this.state}initialize(){this._handles.add(this.layerView.layerViewData.excludedLayers.on(\"before-add\",(e=>{const i=e.item;null!=i&&(i instanceof d||i instanceof h)?i instanceof d&&y(i)?(V.error(\"excludedLayers\",`Layer '${i.title}, id:${i.id}' of type '${i.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),e.preventDefault()):this.layerView.layerViewData.excludedLayers.includes(i)&&e.preventDefault():(V.error(\"excludedLayers\",\"Invalid layer type, layer must derive from Layer or BuildingComponentSublayer\"),e.preventDefault())}))),this._handles.add(s(this.view,\"ready\",(()=>this._initialize()),!0))}_initialize(){switch(this.state){case\"pending\":break;case\"destroyed\":return;case\"ready\":throw new Error(\"state error\")}C(this.view,this),this._handles.add([this.layerView.layerViewData.watch(\"plane\",(()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()}),!0),this.layerView.layerViewData.watch(\"excludeGroundSurface\",(()=>this._updateLayerViews()),!0),this.layerView.layerViewData.excludedLayers.on(\"change\",(()=>this._updateLayerViews())),this.layerView.watch([\"active\",\"visible\"],(()=>{this._updateActiveController(),this._updateViewSlicePlane()}),!0),this.view.allLayerViews.on(\"change\",(()=>this._updateLayerViews()))]),this._handles.add([this.analysis.watch(\"plane\",(()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())}),!0)],\"analysis\"),this._set(\"state\",\"ready\"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()}destroy(){switch(this.state){case\"destroyed\":case\"pending\":return}this.layerView.active=!1,P(this.view,this),this._handles.destroy(),this.view.slicePlane=null,this.set(\"view\",null),this._set(\"state\",\"destroyed\")}async whenReady(){return await s(this,\"ready\"),this}_updateBoundedPlaneFromSlicePlane(){const e=this.analysis.plane,i=this._currentSlicePlane;if(r(i)&&r(e)||l(i)&&l(e)&&e.equals(i))return;let t=null,a=null;l(e)&&(t=u(e,this.view.renderCoordsHelper,c()),l(t)?a={heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height}:console.warn(\"Failed slice plane conversion.\")),this._currentSlicePlane=a,l(t)&&!this.analysis.tiltEnabled&&p(t,this.view.renderCoordsHelper,t),this._internalChange=!0,this.layerView.layerViewData.plane=t,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const e=this.layerView.layerViewData.plane,i=w(e,this.view.renderCoordsHelper,this.view.spatialReference,new v);let t=null;l(i)&&(t={heading:i.heading,tilt:i.tilt,position:i.position,width:i.width,height:i.height}),this._currentSlicePlane=t,l(e)&&(this.analysis.tiltEnabled||p(e,this.view.renderCoordsHelper,e)),this._internalChange=!0,this.analysis.plane=i,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(_)return;const e=S(this.view);if(this.layerView.active)l(e.activeController)&&e.activeController!==this?(_=!0,e.activeController.layerView.active=!1,_=!1):l(e.activeController)&&e.activeController,this._updateLayerViews(),e.activeController=this;else{if(l(e.activeController)&&e.activeController!==this)return;l(e.activeController)&&e.activeController===this&&(e.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){\"ready\"===this.state&&g(this.view)}_updateLayerViews(){const e=l(this.layerView.layerViewData.plane)&&this.layerView.visible&&this.layerView.active,i=[],t=e=>{\"layers\"in e?e.layers.forEach(t):i.push(e)};this.layerView.layerViewData.excludedLayers.forEach(t),this.view.allLayerViews.forEach((t=>{\"slicePlaneEnabled\"in t&&(t.slicePlaneEnabled=e&&i.indexOf(t.layer)<0),\"sublayerViews\"in t&&t.sublayerViews.forEach((t=>{t.slicePlaneEnabled=e&&i.indexOf(t.sublayer)<0}))})),null!=this.view.basemapTerrain&&(this.view.basemapTerrain.slicePlaneEnabled=e&&!this.layerView.layerViewData.excludeGroundSurface)}};e([n({readOnly:!0})],f.prototype,\"state\",void 0),e([n()],f.prototype,\"view\",void 0),e([n()],f.prototype,\"analysis\",void 0),e([n()],f.prototype,\"layerView\",void 0),e([n()],f.prototype,\"ready\",null),f=e([o(\"esri.views.3d.interactive.graphics.Slice.SliceController\")],f);const m=new Map;let _=!1;function g(e){const i=S(e).activeController;l(i)&&l(i.layerView.layerViewData.plane)&&i.layerView.visible?e.slicePlane=i.layerView.layerViewData.plane:e.slicePlane=null}function C(e,i){m.has(e)||m.set(e,{all:[],activeController:null}),m.get(e).all.push(i)}function S(e){return m.get(e)}function P(e,i){if(!m.has(e))throw new Error(\"view expected in global slice register\");const t=m.get(e),a=t.all.lastIndexOf(i);if(-1===a)throw new Error(\"controller expected in global slice register\");t.all.splice(a,1),0===t.all.length&&m.delete(e)}export{f as SliceController};\n"]},"metadata":{},"sourceType":"module"}