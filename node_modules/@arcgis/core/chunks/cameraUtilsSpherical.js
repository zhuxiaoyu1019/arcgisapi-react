/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{deg2rad as t,rad2deg as e,asinClamped as a}from"../core/mathUtils.js";import{i,c as o}from"./mat4.js";import{c as s}from"./mat4f64.js";import{n,c as r,d as c,m as l,o as m,l as f,a as p}from"./vec3.js";import{f as h,c as u}from"./vec3f64.js";import y from"../geometry/Extent.js";import{getReferenceEllipsoid as M}from"../geometry/projectionEllipsoid.js";import d from"../geometry/SpatialReference.js";import{geographicToWebMercator as j}from"../geometry/support/webMercatorUtils.js";import{createDirectionUp as T,directionToHeadingTilt as g}from"../views/3d/support/cameraUtilsInternal.js";import{getLonDeltaForDistance as R}from"../views/3d/support/earthUtils.js";import{Cyclical as x,cyclical2PI as b}from"../views/3d/support/mathUtils.js";const v=h(0,0,1),w=n(u(),h(1,1,1)),I=new x(-180,180),U=s(),P=u(),q=u();function E(e,a,s,f=T()){r(P,e,v),0===c(P,P)&&r(P,e,w),i(U),o(U,U,-t(a),e),o(U,U,-t(s),P);const{up:p,direction:h}=f;return r(p,P,e),n(p,p),l(p,p,U),n(h,e),m(h,h),l(h,h,U),f}function _(t,e,a,i){const o=P,s=q;return n(o,t),r(q,o,v),0===c(q,q)&&r(q,o,w),r(s,q,o),g(e,a,i,o,s)}function H(e,i,o,s){const n={eye:u(),up:null,tilt:s,heading:o},r=P;r[0]=e[0],r[1]=e[2],r[2]=-e[1];const c=i,l=t(o),m=t(s),h=Math.sin(l),y=Math.cos(l),M=Math.sin(m),d=Math.cos(m),j=f(r);let T;if(Math.abs(m)<1e-8)T=c+j;else{const t=j/M,e=a(c/t),i=Math.PI-m-e;T=t*Math.sin(i)}const g=d*c,R=c*c*(M*M),x=y*y*R,b=T-g,v=b*b,w=x*(x+v-r[1]*r[1]);if(w<0)return p(n.eye,r,T/j),n.tilt=0,n;const I=Math.sqrt(w),U=r[1]*b,q=x+v;let E;if(E=y>0?-I+U:I+U,Math.abs(q)<1e-8)return j<1e-8?(n.eye[0]=0,n.eye[1]=0,n.eye[2]=c):p(n.eye,r,T/j),n.tilt=0,W(n.eye),k(n,e);n.eye[1]=E/q;const _=h*h*R,H=M*c,z=y*H*n.eye[1],A=n.eye[1]*n.eye[1],G=1-A,S=Math.sqrt(G),C=x*A+_-2*z*S*b+G*v;return Math.abs(C)<1e-8?(p(n.eye,r,T/j),n.tilt=0,W(n.eye),k(n,e)):(n.eye[0]=(G*(T*r[0]-g*r[0])-H*S*(r[0]*n.eye[1]*y+r[2]*h))/C,n.eye[2]=(G*(T*r[2]-g*r[2])-H*S*(r[2]*n.eye[1]*y-r[0]*h))/C,p(n.eye,n.eye,T),W(n.eye),k(n,e))}function W(t){const e=t[1];t[1]=-t[2],t[2]=e}function k(t,e){const a=E(e,t.heading,t.tilt);return t.up=a.up,t}function z(t,i,o){const s=f(i),n=Math.sqrt(o*o+s*s-2*o*s*Math.cos(Math.PI-t)),r=a(o/(n/Math.sin(t)));return e(t-r)}function A(e,i,o){const s=t(e),n=f(i);return a(o/(n/Math.sin(s)))+s}function G(a,i,o,s,n){let r,c,l,m;const f=i.latitude,p=i.longitude,h=R(f,o,M(a.spatialReference).radius)/2;r=p-h,c=p+h;const u=t(f),T=M(a.spatialReference).radius,g=(1+Math.sin(u))/(1-Math.sin(u)),x=(g+1)*Math.tan(s/T/2),v=x*x;function w(t){const e=Math.PI/2;return(t=b.normalize(t,-e))>e&&(t=Math.PI-t),t}if(l=1.5*Math.PI-2*Math.atan(.5*(x+Math.sqrt(4*g+v))),m=l+s/T,l=w(l),m=w(m),m<l){const t=m;m=l,l=t}if(l=Math.max(e(l),-90),m=Math.min(e(m),90),c=I.monotonic(r,c),c-r>180){const t=(c-r-180)/2;r+=t,c-=t}const U=a.spatialReference&&a.spatialReference.isGeographic?a.spatialReference:d.WGS84;return n?(n.xmin=r,n.ymin=l,n.xmax=c,n.ymax=m,n.spatialReference=U):n=new y(r,l,c,m,U),a.spatialReference&&a.spatialReference.isWebMercator&&j(n,!1,n),n}var S=Object.freeze({__proto__:null,headingTiltToDirectionUp:E,directionToHeadingTilt:_,eyeForCenterWithHeadingTilt:H,lookAtTiltToEyeTilt:z,eyeTiltToLookAtTilt:A,toExtent:G});export{A as a,S as c,_ as d,H as e,E as h,z as l,G as t};
