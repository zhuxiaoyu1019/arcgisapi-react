/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/Evented.js";import{abortMaybe as i,isSome as s,isNone as r,unwrapOr as o}from"../../core/maybe.js";import{createTask as n}from"../../core/promiseUtils.js";import{createScreenPointArray as a}from"../../core/screenUtils.js";import{property as p}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/accessorSupport/ensureType.js";import"../../core/Logger.js";import{subclass as h}from"../../core/accessorSupport/decorators/subclass.js";import d from"../../layers/GraphicsLayer.js";import{makeDehydratedPoint as c}from"../../layers/graphics/dehydratedFeatures.js";import{SnappingVisualizer2D as l}from"../2d/interactive/SnappingVisualizer2D.js";import{createCoordinateHelper as m}from"../interactive/coordinateHelper.js";import{EditGeometry as y,Component as _}from"../interactive/editGeometry/EditGeometry.js";import{EditGeometryHelper as g}from"../interactive/editGeometry/EditGeometryHelper.js";import{SnappingContext as u}from"../interactive/snapping/SnappingContext.js";var v;let f=v=class extends t.EventedAccessor{constructor(e){var t;super(e),this._hasZ=null,this._cursorScreenPoint=null,this._snappingTask=null,this._stagedVertex=null,this._stagedVertexUnsnapped=null,this._lastVertexUnsnapped=null,this._nativeEventHistory={undoStack:[],redoStack:[]},this.interactiveUndoDisabled=!1,this.history=[],this.redoHistory=[],this.snapToScene=!1,this.view=null,this.elevationInfo=null,this.defaultZ=0,this._coordinateHelper=m(e.hasZ,!1,e.view.spatialReference,"local"),this._snappingManager=e.snappingManager,this._editGeometry=new g(new y(this._coordinateHelper),null!=(t=e.editGeometryType)?t:"polygon"),this._snappingGraphicsLayer=new d({id:v.SNAPPING_GRAPHICS_LAYER_ID,listMode:"hide",internal:!0}),this._snappingContext=new u({geometry:this._editGeometry,elevationInfo:{mode:"on-the-ground",offset:0},pointer:"mouse",visualizer:new l(this._snappingGraphicsLayer)}),this._activeComponent=new _(this._editGeometry.editGeometry),this._editGeometry.editGeometry.components.push(this._activeComponent)}initialize(){"2d"===this.view.type&&this.view.map.layers.add(this._snappingGraphicsLayer)}destroy(){this._snappingTask=i(this._snappingTask),this.view.map.layers.remove(this._snappingGraphicsLayer),this._snappingGraphicsLayer.destroy(),s(this._snappingManager)&&this._snappingManager.doneSnapping(),this._editGeometry.destroy()}get _committedVertices(){return this._editGeometry.editGeometry.components[0].vertices.map((e=>e.pos))}get vertices(){return s(this._stagedVertex)?[...this._committedVertices,this._coordinateHelper.pointToArray(this._stagedVertex)]:this._committedVertices}get hasZ(){return s(this._hasZ)?this._hasZ:"3d"===this.view.type}set hasZ(e){this._hasZ=e,this.notifyChange("hasZ")}canUndo(){return this._editGeometry.editGeometry.canUndo}canRedo(){return this._editGeometry.editGeometry.canRedo}undo(){this.canUndo()&&this._editGeometry.undo()}redo(){this.canRedo()&&this._editGeometry.redo()}getCoordsFromScreenPoint(e){const t=this.screenToMap(e);return s(t)?t.hasZ?[t.x,t.y,t.z]:[t.x,t.y]:null}getCoordsAndPointFromScreenPoint(e){const t=this.screenToMap(e);return s(t)?t.hasZ?{vertex:[t.x,t.y,t.z],mapPoint:t}:{vertex:[t.x,t.y],mapPoint:t}:null}_pushCursorVertex(e){const t=c(e[0],e[1],null,this.view.spatialReference);this._stagedVertexUnsnapped=t,r(this._snappingManager)?this._stagedVertex=t:(this._stagedVertex=this._snappingManager.update(t,this._snappingContext),this._snappingTask=n((async e=>{if(s(this._snappingManager)){const i=await this._snappingManager.snap(t,this._snappingContext,e);return i.valid&&(this._stagedVertex=i.apply(),this.notifyChange("vertices")),i}return null})))}_popCursorVertex(){this._stagedVertex=null,this._stagedVertexUnsnapped=null,this.notifyChange("vertices")}getGeometryZValue(){return this.defaultZ}screenToMap(e){let t=null;if("3d"===this.view.type)if(this.hasZ){const i=o(this.elevationInfo,x);t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(a(e.x,e.y),i,this.getGeometryZValue())}else{const i=o(this.elevationInfo,G);t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(a(e.x,e.y),i,0),s(t)&&(t.z=void 0)}else t=this.view.toMap(e),s(t)&&(t.z=this.hasZ?this.getGeometryZValue():void 0);return t}_isDuplicateOfLastVertex(e){const t=this._editGeometry.editGeometry.components[0].getLastVertex();if(s(t)&&e[0]===t[0]&&e[1]===t[1])return!0;const{x:i,y:r}=this._coordinateHelper.createDehydratedPoint(e);return!(!s(this._lastVertexUnsnapped)||i!==this._lastVertexUnsnapped.x||r!==this._lastVertexUnsnapped.y)}_vertexAddHandler(e){const t=s(this._stagedVertex)?this._coordinateHelper.pointToArray(this._stagedVertex):this.getCoordsFromScreenPoint(this._cursorScreenPoint);s(t)&&this._addVertex(t,e.native)}_drawCompleteHandler(e){this._completeDrawing(e.native)}};f.SNAPPING_GRAPHICS_LAYER_ID="DrawAction-snapping-graphics-layer",e([p({readOnly:!0})],f.prototype,"vertices",null),e([p({type:Boolean,nonNullable:!0})],f.prototype,"interactiveUndoDisabled",void 0),e([p({readOnly:!0})],f.prototype,"history",void 0),e([p({readOnly:!0})],f.prototype,"redoHistory",void 0),e([p()],f.prototype,"snapToScene",void 0),e([p()],f.prototype,"view",void 0),e([p()],f.prototype,"elevationInfo",void 0),e([p({nonNullable:!0})],f.prototype,"defaultZ",void 0),e([p()],f.prototype,"hasZ",null),f=v=e([h("esri.views.draw.DrawAction")],f);const x={mode:"absolute-height",offset:0},G={mode:"on-the-ground",offset:0};var V=f;export default V;
