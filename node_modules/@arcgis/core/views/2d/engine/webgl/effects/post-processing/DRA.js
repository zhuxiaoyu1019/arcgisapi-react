/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../../../../../../core/Logger.js";import"../../../../../webgl/BufferObject.js";import t from"../../../../../webgl/FramebufferObject.js";import"../../../../../../core/has.js";import"../../../../../webgl/enums.js";import"../../../../../webgl/RenderingContext.js";import"../../../../../../chunks/builtins.js";import s from"../../../../../webgl/Texture.js";import"../../../../../webgl/VertexArrayObject.js";import r from"../../VertexStream.js";const i=e.getLogger("esri.views.2d.engine.webgl.effects.post-processing.DRA"),o=2;class n{constructor(){this._fbos=null,this._colorAttachmentsPoints=[36064,36065],this._size=[0,0],this._programDesc={"min-max":{vsPath:"post-processing/pp",fsPath:"post-processing/dra/min-max",attributes:new Map([["a_position",0]])},dra:{vsPath:"post-processing/pp",fsPath:"post-processing/dra",attributes:new Map([["a_position",0]])}}}dispose(){this._disposeFBOs(),this._layerTexture&&(this._layerTexture.dispose(),this._layerTexture=null)}draw(e,t,s){this._createOrResizeResources(e);const{context:o,state:n,painter:a,pixelRatio:h}=e,{materialManager:l}=a,u=this._programDesc,{size:d}=n,p=this._fbos,m=[h*d[0],h*d[1]],f=o.capabilities.drawBuffers;if(!f)return void i.error("esri.DRA","WebGL Extension WEBGL_draw_buffers isn't supported!");this._quad||(this._quad=new r(o,[-1,-1,1,-1,-1,1,1,1]));const c=this._layerTexture;t.copyToTexture(0,0,m[0],m[1],0,0,c);const g=this._quad;g.bind();const _=l.getProgram(e,u["min-max"]);o.useProgram(_),o.setBlendingEnabled(!1);let b,x=t.colorTexture,w=t.colorTexture;const T=[m[0],m[1]],M=[0,0];for(let r=0;r<p.length;r++){const e=p[r],t=e.descriptor;M[0]=t.width,M[1]=t.height,o.bindFramebuffer(e),f.drawBuffers(this._colorAttachmentsPoints),o.setViewport(0,0,t.width,t.height),b=r,b>6&&(b=6),o.bindTexture(x,b),o.bindTexture(w,b+1),_.setUniform1i("u_minTexture",b),_.setUniform1i("u_maxTexture",b+1),_.setUniform2fv("u_srcResolution",T),_.setUniform2fv("u_dstResolution",M),g.draw(),x=e.getColorTexture(36064),w=e.getColorTexture(36065),T[0]=M[0],T[1]=M[1]}o.setViewport(0,0,m[0],m[1]),o.bindFramebuffer(t);const j=l.getProgram(e,u.dra);o.useProgram(j),o.bindTexture(x,5),o.bindTexture(w,6),o.bindTexture(c,7),j.setUniform1i("u_minColor",5),j.setUniform1i("u_maxColor",6),j.setUniform1i("u_texture",7),o.setStencilWriteMask(0),o.setStencilTestEnabled(!1),o.setDepthWriteEnabled(!1),o.setDepthTestEnabled(!1),g.draw(),o.setBlendingEnabled(!0),o.setBlendFunction(1,771),o.setStencilTestEnabled(!0),g.unbind()}_createOrResizeResources(e){const{context:r,state:i,pixelRatio:n}=e,{size:a}=i;let h=Math.round(n*a[0]),l=Math.round(n*a[1]);if(this._size[0]!==h||this._size[1]!==l){for(this._size[0]=h,this._size[1]=l,this._disposeFBOs(),this._fbos=[];h>1||l>1;){h=Math.max(1,0|Math.floor((h+o-1)/o)),l=Math.max(1,0|Math.floor((l+o-1)/o));const e={pixelFormat:6408,internalFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,flipped:!1,width:h,height:l},s=new t(r,{depthStencilTarget:0,width:h,height:l},[e,e]);this._fbos.push(s)}this._layerTexture?this._layerTexture.resize(Math.round(n*a[0]),Math.round(n*a[1])):this._layerTexture=new s(r,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:Math.round(n*a[0]),height:Math.round(n*a[1])})}}_disposeFBOs(){if(this._fbos){for(const e of this._fbos)e.dispose();this._fbos.length=0,this._fbos=null}}}export{n as DRA};
