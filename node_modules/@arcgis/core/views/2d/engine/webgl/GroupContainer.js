/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import"../../../webgl/BufferObject.js";import e from"../../../webgl/FramebufferObject.js";import"../../../../core/has.js";import"../../../webgl/enums.js";import"../../../webgl/RenderingContext.js";import"../../../../chunks/builtins.js";import"../../../webgl/Texture.js";import"../../../webgl/VertexArrayObject.js";import t from"./WGLContainer.js";class r extends t{constructor(){super(...arguments),this._lastWidth=0,this._lastHeight=0,this.requiresDedicatedFBO=!1}dispose(){this._renderTarget&&(this._renderTarget.dispose(),this._renderTarget=null)}doRender(e){const t=this.createRenderParams(e),{context:r,painter:s,profiler:i}=t;this._prevFBO=r.getBoundFramebufferObject(),i.recordContainerStart(this.name);const n=this._getFbo(t),o=s.getRenderTarget();r.bindFramebuffer(n),s.setRenderTarget(n),r.setDepthWriteEnabled(!0),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.setClearDepth(1),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.DEPTH_BUFFER_BIT),r.setDepthWriteEnabled(!1);for(const a of this.children)a.beforeRender(e);for(const a of this.children)a.processRender(t);for(const a of this.children)a.afterRender(e);s.setRenderTarget(o),r.bindFramebuffer(this._prevFBO),s.beforeRenderLayer(t,this._clippingInfos?255:0,this.computedOpacity),r.setStencilTestEnabled(!1),r.setStencilWriteMask(0),s.blitTexture(r,n.colorTexture,9728),s.compositeLayer(t,this.computedOpacity),i.recordContainerEnd()}createRenderParams(e){return{...super.createRenderParams(e),blendMode:this.blendMode,effects:this.computedEffects,globalOpacity:1}}_getFbo(t){const{context:r,painter:s}=t,{width:i,height:n}=r.getViewport();if(i!==this._lastWidth||n!==this._lastHeight)if(this._lastWidth=i,this._lastHeight=n,this._renderTarget)this._renderTarget.resize(i,n);else{const t={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:i,height:n},o={colorTarget:0,depthStencilTarget:3};this._renderTarget=new e(r,o,t,s.getSharedStencilBuffer())}return this._renderTarget}}export{r as GroupContainer};
