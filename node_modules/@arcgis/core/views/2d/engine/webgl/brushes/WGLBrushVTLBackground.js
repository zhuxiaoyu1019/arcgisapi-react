/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{nextPowerOfTwo as t}from"../../../../../core/mathUtils.js";import{isSome as r}from"../../../../../core/maybe.js";import{c as e}from"../../../../../chunks/mat3f32.js";import{f as o}from"../../../../../chunks/vec4f32.js";import i from"../../../../webgl/BufferObject.js";import"../../../../webgl/FramebufferObject.js";import"../../../../../core/has.js";import"../../../../webgl/enums.js";import"../../../../webgl/RenderingContext.js";import"../../../../../chunks/builtins.js";import"../../../../webgl/Texture.js";import s from"../../../../webgl/VertexArrayObject.js";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as a,VTL_HIGH_RES_CUTOFF as n}from"../definitions.js";import{WGLDrawPhase as c}from"../enums.js";import{u32to4Xu8 as m}from"../number.js";import f from"./WGLBrush.js";class l extends f{constructor(){super(...arguments),this._color=o(1,0,0,1),this._patternMatrix=e(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(e,o){const{context:i,painter:s,styleLayerUID:f}=e;this._loadWGLResources(e);const l=e.displayLevel,u=e.styleLayer,p=u.backgroundMaterial,_=s.vectorTilesMaterialManager,d=u.getPaintValue("background-color",l),g=u.getPaintValue("background-opacity",l),h=u.getPaintValue("background-pattern",l),b=void 0!==h,j=d[3]*g,v=1|window.devicePixelRatio,x=e.spriteMosaic;let y,M;const w=v>n?2:1,U=e.drawPhase===c.HITTEST,k=this._programOptions;k.id=U,k.pattern=b;const L=_.getMaterialProgram(i,p,k);if(i.bindVAO(this._vao),i.useProgram(L),b){const t=x.getMosaicItemPosition(h,!0);if(r(t)){const{tl:e,br:o,page:s}=t;y=o[0]-e[0],M=o[1]-e[1];const n=x.getPageSize(s);r(n)&&(x.bind(i,9729,s,a),L.setUniform4f("u_tlbr",e[0],e[1],o[0],o[1]),L.setUniform2fv("u_mosaicSize",n),L.setUniform1i("u_texture",a))}L.setUniform1f("u_opacity",g)}else this._color[0]=j*d[0],this._color[1]=j*d[1],this._color[2]=j*d[2],this._color[3]=j,L.setUniform4fv("u_color",this._color);if(L.setUniform1f("u_depth",u.z||0),U){const t=m(f+1);L.setUniform4fv("u_id",t)}for(const r of o){if(L.setUniform1f("u_coord_range",r.coordRange[0]),L.setUniformMatrix3fv("u_dvsMat3",r.transforms.dvs),b){const e=Math.max(2**(Math.round(l)-r.key.level),1),o=w*r.size[0]*e,i=o/t(y),s=o/t(M);this._patternMatrix[0]=i,this._patternMatrix[4]=s,L.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}i.setStencilFunction(514,r.stencilRef,255),i.drawArrays(5,0,4)}}_loadWGLResources(t){if(this._vao)return;const{context:r,styleLayer:e}=t,o=e.backgroundMaterial,a=new Int8Array([0,0,1,0,0,1,1,1]),n=i.createVertex(r,35044,a),c=new s(r,o.getAttributeLocations(),o.getLayoutInfo(),{geometry:n});this._vao=c}}export{l as WGLBrushVTLBackground};
