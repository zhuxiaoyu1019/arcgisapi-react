/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../../../../../core/RandomLCG.js";import"../../../../webgl/BufferObject.js";import"../../../../webgl/FramebufferObject.js";import"../../../../../core/has.js";import"../../../../webgl/enums.js";import"../../../../webgl/RenderingContext.js";import"../../../../../chunks/builtins.js";import t from"../../../../webgl/Texture.js";import"../../../../webgl/VertexArrayObject.js";import{TEXTURE_BINDING_RENDERER_0 as o,TEXTURE_BINDING_RENDERER_1 as i,TILE_SIZE as r}from"../definitions.js";import{WGLGeometryType as s}from"../enums.js";import{createProgramDescriptor as a}from"../Utils.js";import n from"./WGLGeometryBrush.js";import{FillMaterialKey as l}from"../materialKey/MaterialKey.js";const u=e=>a(e.data,{geometry:[{location:0,name:"a_pos",count:2,type:5122},{location:1,name:"a_id",count:4,type:5121},...e.dotDensity?[]:[{location:2,name:"a_color",count:4,type:5121,normalized:!0},{location:3,name:"a_tlbr",count:4,type:5123},{location:4,name:"a_aux1",count:4,type:5121},{location:5,name:"a_aux2",count:2,type:5123},{location:6,name:"a_aux3",count:4,type:5121},{location:7,name:"a_zoomRange",count:2,type:5123}],...e.dotDensity?[{location:2,name:"a_inverseArea",count:1,type:5126}]:[]]});class d extends n{constructor(){super(...arguments),this._dotTextureSize=0,this._dotTextures=null,this._dotSamplers=new Int32Array([o,i])}dispose(){this._disposeTextures()}getGeometryType(){return s.FILL}drawGeometry(e,t,o,i){const{context:s,painter:a,rendererInfo:n,requiredLevel:d}=e,m=l.load(o.materialKey),{bufferLayouts:c,attributes:f}=u(m),_=a.materialManager.getMaterialProgram(e,m,"materials/fill",f,i);if(s.useProgram(_),this._setSharedUniforms(_,e,t),m.textureBinding){a.textureManager.bindTextures(s,_,m);const o=1/2**(d-t.key.level)/e.pixelRatio;_.setUniform1f("u_zoomFactor",o)}if(m.vvColor&&(_.setUniform1fv("u_vvColorValues",n.vvColorValues),_.setUniform4fv("u_vvColors",n.vvColors)),m.vvOpacity&&(_.setUniform1fv("u_vvOpacityValues",n.vvOpacityValues),_.setUniform1fv("u_vvOpacities",n.vvOpacities)),m.dotDensity){const o=r/n.ddDotSize,i=o*window.devicePixelRatio*o*window.devicePixelRatio,a=1/2**(d-t.key.level),l=1/a*(1/a),u=n.ddDotScale?e.state.scale/n.ddDotScale:1;_.setUniform1f("u_tileZoomFactor",a),_.setUniform1f("u_tileDotsOverArea",i/(r*window.devicePixelRatio*r*window.devicePixelRatio)),_.setUniformMatrix4fv("u_dotColors",n.ddColors),_.setUniform4fv("u_isActive",n.ddActiveDots),_.setUniform4fv("u_dotBackgroundColor",n.ddBackgroundColor),_.setUniform1f("u_dotValue",Math.max(1,n.ddDotValue*u*l)),this._bindDotDensityTextures(s,_,n,o)}o.draw(s,c,f)}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_bindDotDensityTextures(e,t,o,i){const r=this._createDotDensityTextures(e,i,o.ddSeed);t.setUniform1iv("u_dotTextures",this._dotSamplers);for(let s=0;s<r.length;s++)e.bindTexture(r[s],this._dotSamplers[s])}_createDotDensityTextures(t,o,i){if(this._dotTextureSize===o&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=o,this._seed=i),null===this._dotTextures){const r=new e(i);this._dotTextures=[this._allocDotDensityTexture(t,o,r),this._allocDotDensityTexture(t,o,r)]}return this._dotTextures}_allocDotDensityTexture(e,o,i){const r=new Float32Array(o*o*4);for(let t=0;t<r.length;t++)r[t]=i.getFloat();return new t(e,{wrapMode:10497,pixelFormat:6408,dataType:5126,samplingMode:9728,width:o,height:o},r)}}export default d;
