/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{isNone as e}from"../../../../../core/maybe.js";import{c as t,f as a}from"../../../../../chunks/vec2f32.js";import{FADE_DURATION as i}from"../../vectorTiles/decluttering/config.js";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as r,VTL_TEXTURE_BINDING_UNIT_GLYPHS as s}from"../definitions.js";import{WGLDrawPhase as n}from"../enums.js";import{degToByte as o}from"../GeometryUtils.js";import{u32to4Xu8 as l}from"../number.js";import f from"./WGLBrush.js";const c=1/65536;class p extends f{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=t()}dispose(){}drawMany(e,t){const{drawPhase:a,styleLayerUID:i}=e,r=e.styleLayer;let s;a===n.HITTEST&&(s=l(i+1)),this._drawIcons(e,r,t,s),this._drawText(e,r,t,s)}_drawIcons(t,a,s,l){const{context:f,displayLevel:c,drawPhase:p,painter:u,spriteMosaic:m,state:g,styleLayerUID:y}=t,d=a.iconMaterial,_=u.vectorTilesMaterialManager;let h,M=!1;for(const e of s)if(e.layerData.has(y)&&(h=e.layerData.get(y),h.iconPerPageElementsMap.size>0)){M=!0;break}if(!M)return;const U=a.getPaintValue("icon-translate",c),P=a.getPaintValue("icon-translate-anchor",c);let x=a.getLayoutValue("icon-rotation-alignment",c);2===x&&(x=0===a.getLayoutValue("symbol-placement",c)?1:0);const v=0===x,T=a.getLayoutValue("icon-keep-upright",c)&&v,E=h.isIconSDF,D=p===n.HITTEST,V=this._iconProgramOptions;V.id=D,V.sdf=E;const S=_.getMaterialProgram(f,d,V);f.useProgram(S),S.setUniformMatrix3fv("u_displayViewMat3",0===x?g.displayViewMat3:g.displayMat3),S.setUniformMatrix3fv("u_displayMat3",1===P?g.displayMat3:g.displayViewMat3),S.setUniform2fv("u_iconTranslation",U),S.setUniform1f("u_depth",a.z),S.setUniform1f("u_mapRotation",o(g.rotation)),S.setUniform1f("u_keepUpright",T?1:0),S.setUniform1f("u_level",10*c),S.setUniform1i("u_texture",r),S.setUniform1f("u_fadeDuration",i/1e3),D&&S.setUniform4fv("u_id",l);let w=-1;for(const i of s){if(!i.layerData.has(y))continue;if(i.key.level!==w&&(w=i.key.level,d.setDataUniforms(S,c,a,w,m)),h=i.layerData.get(y),0===h.iconPerPageElementsMap.size)continue;h.prepareForRendering(f),h.updateOpacityInfo();const r=h.iconVertexArrayObject;if(!e(r)){f.bindVAO(r),S.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs),S.setUniform1f("u_time",(performance.now()-h.lastOpacityUpdate)/1e3);for(const[e,a]of h.iconPerPageElementsMap)this._renderIconRange(t,S,a,e,i)}}}_renderIconRange(e,t,a,i,s){const{context:n,spriteMosaic:o}=e;this._spritesTextureSize[0]=o.getWidth(i)/4,this._spritesTextureSize[1]=o.getHeight(i)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),o.bind(n,9729,i,r),n.setStencilTestEnabled(!0),n.setStencilFunction(516,255,255),n.setStencilWriteMask(0),n.drawElements(4,a[1],5125,Uint32Array.BYTES_PER_ELEMENT*a[0]),s.triangleCount+=a[1]/3}_drawText(t,r,l,f){const{context:p,displayLevel:u,drawPhase:m,glyphMosaic:g,painter:y,pixelRatio:d,spriteMosaic:_,state:h,styleLayerUID:M}=t,U=r.textMaterial,P=y.vectorTilesMaterialManager;let x,v=!1;for(const e of l)if(e.layerData.has(M)&&(x=e.layerData.get(M),x.glyphPerPageElementsMap.size>0)){v=!0;break}if(!v)return;const T=r.getPaintProperty("text-opacity");if(T&&!T.isDataDriven&&0===T.getValue(u))return;const E=r.getPaintProperty("text-color"),D=!E||E.isDataDriven||E.getValue(u)[3]>0,V=r.getPaintProperty("text-halo-width"),S=r.getPaintProperty("text-halo-color"),w=(!V||V.isDataDriven||V.getValue(u)>0)&&(!S||S.isDataDriven||S.getValue(u)[3]>0);if(!D&&!w)return;const L=24/8;let z=r.getLayoutValue("text-rotation-alignment",u);2===z&&(z=0===r.getLayoutValue("symbol-placement",u)?1:0);const b=0===z,k=r.getLayoutValue("text-keep-upright",u)&&b,I=m===n.HITTEST,O=.8*L/d;this._glyphTextureSize||(this._glyphTextureSize=a(g.width/4,g.height/4));const R=r.getPaintValue("text-translate",u),j=r.getPaintValue("text-translate-anchor",u),A=this._sdfProgramOptions;A.id=I;const F=P.getMaterialProgram(p,U,A);p.useProgram(F),F.setUniformMatrix3fv("u_displayViewMat3",0===z?h.displayViewMat3:h.displayMat3),F.setUniformMatrix3fv("u_displayMat3",1===j?h.displayMat3:h.displayViewMat3),F.setUniform2fv("u_textTranslation",R),F.setUniform1f("u_depth",r.z+c),F.setUniform2fv("u_mosaicSize",this._glyphTextureSize),F.setUniform1f("u_mapRotation",o(h.rotation)),F.setUniform1f("u_keepUpright",k?1:0),F.setUniform1f("u_level",10*u),F.setUniform1i("u_texture",s),F.setUniform1f("u_antialiasingWidth",O),F.setUniform1f("u_fadeDuration",i/1e3),I&&F.setUniform4fv("u_id",f);let W=-1;for(const a of l){if(!a.layerData.has(M))continue;if(a.key.level!==W&&(W=a.key.level,U.setDataUniforms(F,u,r,W,_)),x=a.layerData.get(M),0===x.glyphPerPageElementsMap.size)continue;x.prepareForRendering(p),x.updateOpacityInfo();const t=x.textVertexArrayObject;if(e(t))continue;p.bindVAO(t),F.setUniformMatrix3fv("u_dvsMat3",a.transforms.dvs),p.setStencilTestEnabled(!0),p.setStencilFunction(516,255,255),p.setStencilWriteMask(0);const i=(performance.now()-x.lastOpacityUpdate)/1e3;F.setUniform1f("u_time",i),x.glyphPerPageElementsMap.forEach(((e,t)=>{this._renderGlyphRange(p,e,t,g,F,w,D,a)}))}}_renderGlyphRange(e,t,a,i,r,n,o,l){i.bind(e,9729,a,s),n&&(r.setUniform1f("u_halo",1),e.drawElements(4,t[1],5125,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3),o&&(r.setUniform1f("u_halo",0),e.drawElements(4,t[1],5125,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3)}}export{p as WGLBrushVTLSymbol};
