/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import t from"../../../../core/Error.js";import e from"../../../../core/Logger.js";import{isSome as r,isNone as s}from"../../../../core/maybe.js";import{DisplayObject as i}from"../DisplayObject.js";import h from"./Mesh2D.js";import o from"../../../webgl/VertexArrayObject.js";const a=e.getLogger("esri.views.2d.engine.webgl.ClippingInfo"),c=t=>parseFloat(t)/100;class n extends i{constructor(t,e){super(),this._clip=e,this._cache={},this.stage=t,this._handle=e.watch("version",(()=>this._invalidate())),this.ready()}static fromClipArea(t,e){return new n(t,e)}_destroyGL(){r(this._cache.mesh)&&(this._cache.mesh.destroy(),this._cache.mesh=null),r(this._cache.vao)&&(this._cache.vao.dispose(),this._cache.vao=null)}destroy(){this._destroyGL(),this._handle.remove()}getVAO(t,e,r,i){const[h,a]=e.size;if("geometry"!==this._clip.type&&this._lastWidth===h&&this._lastHeight===a||(this._lastWidth=h,this._lastHeight=a,this._destroyGL()),s(this._cache.vao)){const s=this._createMesh(e,this._clip),h=s.getIndexBuffer(t),a=s.getVertexBuffers(t);this._cache.mesh=s,this._cache.vao=new o(t,r,i,a,h)}return this._cache.vao}_invalidate(){this._destroyGL(),this.requestRender()}_createScreenRect(t,e){const[r,s]=t.size,i="string"==typeof e.left?c(e.left)*r:e.left,h="string"==typeof e.right?c(e.right)*r:e.right,o="string"==typeof e.top?c(e.top)*s:e.top,a="string"==typeof e.bottom?c(e.bottom)*s:e.bottom,n=i,p=o;return{x:n,y:p,width:Math.max(r-h-n,0),height:Math.max(s-a-p,0)}}_createMesh(e,r){switch(r.type){case"rect":return h.fromRect(this._createScreenRect(e,r));case"path":return h.fromPath(r);case"geometry":return h.fromGeometry(e,r);default:return a.error(new t("mapview-bad-type","Unable to create ClippingInfo mesh from clip of type: ${clip.type}")),h.fromRect({x:0,y:0,width:1,height:1})}}}export default n;
