/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../../../core/Error.js";import{on as t}from"../../../core/events.js";import i from"../../../core/has.js";import{addFrameTask as s}from"../../../core/scheduling.js";import{init as r}from"../../../core/watchUtils.js";import{t as n}from"../../../chunks/common.js";import{i as a,t as o,r as h}from"../../../chunks/mat2d.js";import{c as l}from"../../../chunks/mat2df64.js";import{s as d,t as c}from"../../../chunks/vec2.js";import{a as p}from"../../../chunks/vec2f64.js";import u from"../../webgl/BufferObject.js";import _ from"../../webgl/FramebufferObject.js";import"../../webgl/enums.js";import m from"../../webgl/RenderingContext.js";import"../../../chunks/builtins.js";import{createProgram as g}from"../../webgl/programUtils.js";import"../../webgl/Texture.js";import f from"../../webgl/VertexArrayObject.js";import{createContextOrErrorHTML as b}from"../../webgl/context-util.js";import{Container as w}from"./Container.js";import{WGLDrawPhase as R}from"./webgl/enums.js";import O from"./webgl/Painter.js";import{Profiler as C}from"./webgl/Profiler.js";import{testWebGLDriver as x}from"./webgl/WebGLDriverTest.js";import{BufferDataPool as y}from"./webgl/cpuMapped/BufferDataPool.js";import{stencil as F}from"./webgl/shaders/StencilPrograms.js";import{Timeline as v}from"../support/Timeline.js";import{screenshotSuperSampleSettings as B,encodeResult as P,createEmptyImageData as j,resampleHermite as E}from"../../support/screenshotUtils.js";const S=2e3;class T extends w{constructor(r,n){super(),this._trash=new Set,this._clipData=new Float32Array(8),this._upperLeft=p(),this._upperRight=p(),this._lowerLeft=p(),this._lowerRight=p(),this._mat2=l(),this._clipRendererInitialized=!1,this._supersampleScreenshots=!0,this._pools={bufferData:new y},this.renderRequested=!1,this.stage=this,this._stationary=!0;const{canvas:a=document.createElement("canvas"),alpha:o=!0,stencil:h=!0,renderContext:d="webgl",supersampleScreenshots:c=!0,contextOptions:u={}}=n;this._canvas=a;const _=b(a,{alpha:o,antialias:!1,depth:!0,stencil:h},d);this.context=new m(_,u),this.painter=new O(this.context,this),i("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),r.appendChild(this._debugOutput)),this._renderParameters={drawPhase:0,state:this.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:n.timeline||new v,renderingOptions:n.renderingOptions,requireFBO:!1,driverTestResult:x(this.context),profiler:new C(this.context,this._debugOutput),dataUploadCounter:0},this._taskHandle=s({render:e=>this.renderFrame(e)}),this._taskHandle.pause(),this._supersampleScreenshots=c,this._lostWebGLContextHandle=t(a,"webglcontextlost",(()=>{this.emit("webgl-error",{error:new e("webgl-context-lost")})})),a.setAttribute("style","width: 100%; height:100%; display:block;"),r.appendChild(a)}destroy(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._boundFBO=null,this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null),this._clipVAO&&(this._clipVAO.dispose(),this._clipVAO=null,this._clipVBO=null),this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null),this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.highlightOptions=null,this._pools.bufferData.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}get background(){return this._background}set background(e){this._background=e,this.requestRender()}get highlightOptions(){return this._highlightOptions}set highlightOptions(e){this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=e,this._highlightOptions&&(this._highlightOptionsHandle=r(this._highlightOptions,"version",(()=>{this.painter.setHighlightOptions(e),this.requestRender()})))}get pools(){return this._pools}get renderingOptions(){return this._renderingOptions}set renderingOptions(e){this._renderingOptions=e,this.requestRender()}get state(){return this._state}set state(e){this._state=e,this.requestRender()}get stationary(){return this._stationary}set stationary(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}trashDisplayObject(e){this._trash.add(e),this.requestRender()}untrashDisplayObject(e){return this._trash.delete(e)}requestRender(){this._lastRenderRequestTime=performance.now(),this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())}renderFrame(e){e.time-this._lastRenderRequestTime>=S&&this._taskHandle.pause(),this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")}renderChildren(e){for(const t of this.children)t.beforeRender(e);this._renderChildren(this.children,e);for(const t of this.children)t.afterRender(e)}_renderChildren(e,t){const s=this.context;t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,this._beforeRenderChildren(t),t.drawPhase=R.MAP,this.painter.beforeRenderLayers(s,this.background);for(const i of e)i.processRender(t);this.painter.renderLayers(s),t.drawPhase=R.HIGHLIGHT,this.painter.beforeRenderLayers(s);for(const i of e)i.processRender(t);this.painter.renderLayers(s);if(this._isLabelDrawPhaseRequired(e)){t.drawPhase=R.LABEL,this.painter.beforeRenderLayers(s);for(const i of e)i.processRender(t);this.painter.renderLayers(s)}if(i("esri-tiles-debug")){t.drawPhase=R.DEBUG,this.painter.beforeRenderLayers(s);for(const i of e)i.processRender(t);this.painter.renderLayers(s)}t.profiler.recordEnd("drawLayers"),this._afterRenderChildren()}_beforeRenderChildren(e){const{context:t}=this,{state:i,pixelRatio:s}=e;t.enforceState(),t.setClearDepth(1),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT);const{size:r,rotation:l}=i,p=Math.round(r[0]*s),u=Math.round(r[1]*s);this._boundFBO=t.getBoundFramebufferObject();if(!(i.spatialReference&&(i.spatialReference._isWrappable?i.spatialReference._isWrappable():i.spatialReference.isWrappable)))return void(this._clipFrame=!1);const m=n(l),g=Math.abs(Math.cos(m)),f=Math.abs(Math.sin(m)),b=Math.round(p*g+u*f),w=Math.round(i.worldScreenWidth);if(b<=w)return void(this._clipFrame=!1);this._clipFBO&&this._clipFBO.width===p&&this._clipFBO.height===u||(this._clipFBO=new _(t,{colorTarget:0,depthStencilTarget:3,width:p,height:u}));const R=(this.state.padding.left-this.state.padding.right)/2,O=(this.state.padding.bottom-this.state.padding.top)/2,C=.5*p,x=.5*u,y=1/p,F=1/u,v=w*s*.5,B=.5*(p*f+u*g),P=this._upperLeft,j=this._upperRight,E=this._lowerLeft,S=this._lowerRight;d(P,-v,-B),d(j,v,-B),d(E,-v,B),d(S,v,B),a(this._mat2),o(this._mat2,this._mat2,[C+R,x+O]),0!==l&&h(this._mat2,this._mat2,m),c(P,P,this._mat2),c(j,j,this._mat2),c(E,E,this._mat2),c(S,S,this._mat2);const T=this._clipData;T.set([2*E[0]*y-1,2*(u-E[1])*F-1,2*S[0]*y-1,2*(u-S[1])*F-1,2*P[0]*y-1,2*(u-P[1])*F-1,2*j[0]*y-1,2*(u-j[1])*F-1]),this._clipRendererInitialized||this._initializeClipRenderer(t),this._clipVBO.setData(T),this._boundFBO=t.getBoundFramebufferObject(),t.bindFramebuffer(this._clipFBO),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),t.setClearColor(0,0,0,0),t.setClearDepth(1),t.setClearStencil(0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT|t.gl.STENCIL_BUFFER_BIT),t.setDepthWriteEnabled(!1),this._clipFrame=!0}_afterRenderChildren(){const e=this.context;if(e.logIno(),this._clipFrame&&this._clipRendererInitialized){if(e.bindFramebuffer(this._boundFBO),this._boundFBO=null,e.bindVAO(this._clipVAO),e.useProgram(this._clipStencilProgram),e.setDepthWriteEnabled(!1),e.setDepthTestEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(7680,7680,7681),e.setStencilWriteMask(255),e.setStencilFunction(519,1,255),e.drawElements(4,6,5123,0),e.bindVAO(),e.setColorMask(!0,!0,!0,!0),null!=this.background){const{r:t,g:i,b:s,a:r}=this.background.color;e.setClearColor(r*t/255,r*i/255,r*s/255,r)}else e.setClearColor(0,0,0,0);e.clear(e.gl.COLOR_BUFFER_BIT),e.setBlendingEnabled(!0),e.setStencilFunction(514,1,255),this.painter.blitTexture(e,this._clipFBO.colorTexture,9728,1),e.setStencilTestEnabled(!1)}}doRender(e){const t=this.context,{state:i,pixelRatio:s}=e;this._resizeCanvas(e),this.context.enforceState(),t.setViewport(0,0,s*i.size[0],s*i.size[1]),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),super.doRender(e)}async takeScreenshot(e,t){const i=B(e,this._supersampleScreenshots,this._state.padding),{framebufferWidth:s,framebufferHeight:r}=i,n=this.context,a=e.layers;let o=this.children;const h={...this._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:this._renderParameters.state.clone(),pixelRatio:i.pixelRatio,time:Date.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1};if(null!=e.rotation){const t=h.state.viewpoint;t.rotation=e.rotation,h.state.viewpoint=t}a.length>0&&(o=[],a.forEach((e=>{const i=t.find((t=>t.layer.id===e.id));i&&"container"in i&&i.container&&o.push(i.container)})));const l=new _(n,{colorTarget:0,depthStencilTarget:3,width:s,height:r}),d=n.getBoundFramebufferObject(),c=n.getViewport();n.bindFramebuffer(l),n.setViewport(0,0,s,r),this._renderChildren(o,h);const p=this._readbackScreenshot(i);n.bindFramebuffer(d),n.setViewport(c.x,c.y,c.width,c.height),this.requestRender();const u=this._ensureScreenshotEncodeCanvas();return P(p,e,u,{flipY:!0,premultipliedAlpha:!0})}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}_readbackScreenshot(e){const{framebufferWidth:t,framebufferHeight:i,region:s,resample:r}=e,n=this.context.gl;if(r){const e=j(t,i,this._ensureScreenshotEncodeCanvas());n.readPixels(0,0,t,i,6408,5121,new Uint8Array(e.data.buffer));const a=j(s.width,s.height,this._ensureScreenshotEncodeCanvas());return E(e,a,!0,r.region.x,i-(r.region.y+r.region.height),r.region.width,r.region.height)}{const e=j(s.width,s.height,this._ensureScreenshotEncodeCanvas());return n.readPixels(s.x,i-(s.y+s.height),s.width,s.height,6408,5121,new Uint8Array(e.data.buffer)),e}}_resizeCanvas(e){const t=this._canvas,i=t.style,{state:{size:s},pixelRatio:r}=e,n=s[0],a=s[1],o=Math.round(n*r),h=Math.round(a*r);t.width===o&&t.height===h||(t.width=o,t.height=h),i.width=n+"px",i.height=a+"px"}_initializeClipRenderer(e){if(this._clipRendererInitialized)return!0;const t=F.attributes,i=g(e,F);if(!i)return!1;const s=u.createVertex(e,35040,32),r=new Uint16Array([0,1,2,2,1,3]),n=u.createIndex(e,35044,r),a=new f(e,t,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:s},n);return this._clipStencilProgram=i,this._clipVBO=s,this._clipVAO=a,this._clipRendererInitialized=!0,!0}_emptyTrash(){for(;this._trash.size>0;){const e=Array.from(this._trash);this._trash.clear();for(const t of e)t.processDetach()}}_isLabelDrawPhaseRequired(e){let t=!1;for(const i of e){if(!(i instanceof w)){t=t||!1;break}if(i.hasLabels)return!0;t=t||this._isLabelDrawPhaseRequired(i.children)}return t}}export{S as EXTRA_RENDER_TIME,T as Stage};
