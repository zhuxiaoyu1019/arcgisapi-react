/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as t}from"../chunks/tslib.es6.js";import o from"../core/Accessor.js";import e from"../core/Collection.js";import{HandleOwner as i}from"../core/HandleOwner.js";import a from"../core/Logger.js";import{isSome as r,isNone as s}from"../core/maybe.js";import{throwIfAborted as l,onAbort as n,createAbortError as h}from"../core/promiseUtils.js";import{whenOnce as c,watch as p}from"../core/watchUtils.js";import{property as u}from"../core/accessorSupport/decorators/property.js";import"../core/has.js";import"../core/accessorSupport/ensureType.js";import{subclass as d}from"../core/accessorSupport/decorators/subclass.js";import{ViewEventPriorities as v}from"./input/InputManager.js";import{eventTypes as m}from"./input/ViewEvents.js";import{newToolCollection as T,swap as f,areToolManipulatorsEditable as _,evaluateToolConstructorArguments as g,setActive as w}from"./interactive/interactiveToolUtils.js";import E from"./interactive/ToolViewManagerManipulatorState.js";const y=a.getLogger("esri.views.ToolViewManager"),j="manipulators",b="tools";let C=class extends i{constructor(t){super(t),this._creatingTool=null,this._manipulatorState=new E,this.tools=T(),this.cursor=null,this._forEachTool=t=>{if(!r(this._creatingTool)||!t(this._creatingTool))for(const o of this.tools.items)if(t(o))return}}initialize(){this.handles.add([this.view.on(m,(t=>{this._handleInputEvent(t)}),v.TOOL),this.tools.on("before-add",(t=>{const o=t.item;null==o||this.tools.includes(o)?t.preventDefault():null==o.created||o.created||(y.error("tools","Tool can not be added to view before it has been created"),t.preventDefault())})),this.tools.on("before-remove",(({item:t})=>{this._manipulatorState.clearPointers(t,this._forEachTool)})),this.tools.on("change",(()=>{this._refreshToolWatchers()}))])}destroy(){this._forEachTool((t=>t.destroy()))}set activeTool(t){!r(t)||this.view.ready?(f(this,t,(o=>{this._set("activeTool",o),this._removeIncompleteTools(t),this._forEachTool((t=>{const o=s(this.activeTool)||t===this.activeTool;t.setEditableFlag&&t.setEditableFlag(1,o);const e=_(t);!s(this.activeTool)&&e||this._manipulatorState.clearPointers(t,this._forEachTool,!e)})),this._updateCursor()})),this._creatingTool!==t&&this._rejectCreatingTool()):y.error("#activeTool=","cannot set active tool while view is not ready")}get updating(){return this.updatingHandles.updating||this.tools.some((t=>t.updating))}async createTool(t,e,i){const a="Tool creation was interrupted by another tool being created",{abortHandle:s,tool:h}=await this.updatingHandles.addPromise((async()=>{await this.view.whenReady(),l(i,a);const o=n(i,(()=>this.activeTool=null)),r=g(e),s=new t({...r,view:this.view});return await s.whenCreationStarted(),l(i,a),{abortHandle:o,tool:s}})());return this._rejectCreatingTool(a),this._creatingTool=h,h.attach(),this._refreshToolWatchers(),w(h,!0),await h.when(),r(s)&&s.remove(),this._creatingTool=null,l(i,a),this.tools.add(h),h instanceof o&&null!=h.completed&&c(h,"completed").then((()=>{w(h,!1)})),h}attach(){this._forEachTool((t=>t.attach())),"3d"===this.view.type?this.handles.add([this.view.state.watch("camera",(()=>{this.forEachManipulator((t=>{null!=t.onViewChange&&t.onViewChange()}))})),this.view.elevationProvider.on("elevation-change",(t=>{this.forEachManipulator((o=>{null!=o.onElevationChange&&o.onElevationChange(t)}))}))],j):this.handles.add(this.view.watch("extent",(()=>{this.forEachManipulator((t=>{null!=t.onViewChange&&t.onViewChange()}))})))}detach(){this.activeTool=null,this._forEachTool((t=>{t.detach(),t.destroy()})),this.tools.removeAll(),this.handles.remove(j)}forEachManipulator(t){this._forEachTool((o=>{o.manipulators&&o.manipulators.forEach((({manipulator:e})=>t(e,o)))}))}_handleInputEvent(t){let o=!1;const e={...t,stopPropagation:()=>{o=!0,t.stopPropagation()}};r(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(e):this._forEachTool((t=>{!o&&!1!==t.visible&&t.handleInputEvent&&t.handleInputEvent(e)})),!o&&"key-down"===t.type&&"Escape"===t.key&&this.activeTool&&(t.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(e,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:t=>{this.activeTool=t},creatingTool:this._creatingTool,view:this.view}),!o&&r(this.activeTool)&&this.activeTool.handleInputEventAfter&&this.activeTool.handleInputEventAfter(e),this._manipulatorState.handleHoverEvent(e,this._forEachTool),this._updateCursor()}_refreshToolWatchers(){this.handles.remove(b),this._forEachTool((t=>{if(t instanceof o){const o=p(t,["cursor","visible","editable"],(()=>{_(t)||this._manipulatorState.clearPointers(t,this._forEachTool),this._updateCursor()}));this.handles.add(o,b)}t.manipulators&&this.handles.add(t.manipulators.on("change",(o=>{o.removed.forEach((({id:o})=>{this._manipulatorState.clearPointers(t,this._forEachTool,!0,o)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()})),b)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateCursor(){let t=null;this._forEachTool((o=>null!=o.cursor&&!1!==o.visible&&(t=o.cursor,!0))),t||(t=this._manipulatorState.cursor),this._get("cursor")!==t&&this._set("cursor",t)}_rejectCreatingTool(t){const o=this._creatingTool;s(o)||(this._manipulatorState.clearPointers(o,this._forEachTool),o.rejectCreation&&o.rejectCreation(h(t)),w(o,!1),"destroyed"!==o.toolState&&o.destroy(),this._creatingTool=null,this._refreshToolWatchers())}_removeIncompleteTools(t){this.tools.filter((o=>(s(t)||o!==t)&&null!=o.completed&&!o.completed)).forEach((t=>{this.tools.remove(t)}))}};t([u({constructOnly:!0,nonNullable:!0})],C.prototype,"view",void 0),t([u({value:null})],C.prototype,"activeTool",null),t([u({readOnly:!0,type:e})],C.prototype,"tools",void 0),t([u({readOnly:!0})],C.prototype,"cursor",void 0),t([u({readOnly:!0})],C.prototype,"updating",null),C=t([d("esri.views.ToolViewManager")],C);var S=C;export default S;
