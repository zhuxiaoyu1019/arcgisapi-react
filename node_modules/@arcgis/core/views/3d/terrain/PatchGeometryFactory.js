/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{lerp as t}from"../../../core/mathUtils.js";import{isSome as e}from"../../../core/maybe.js";import{s as n}from"../../../chunks/vec3.js";import{c as r}from"../../../chunks/vec3f64.js";import{s as o}from"../../../chunks/vec4.js";import{c as s}from"../../../chunks/vec4f64.js";import{empty as i}from"../../../geometry/support/aaBoundingBox.js";import{BufferPool as c}from"../../../geometry/support/buffer/BufferPool.js";import{newLayout as u}from"../support/buffer/InterleavedLayout.js";import{ElevationData as f}from"./ElevationData.js";import{MAX_PATCH_TESSELATION as a,GEOMETRY_VERTEX_STRIDE as m}from"./TerrainConst.js";import{computeNormal as l}from"../webgl-engine/materials/internal/MaterialUtil.js";const p=u().vec3f("position").vec2f("uv0"),g=new c((t=>p.createBuffer(t)),(t=>t.count));class h{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=i(),this.numSurfaceIndices=0,this.numSkirtIndices=0,this.numWithoutSkirtIndices=0,this.numVertsPerRow=0,this.skirtLength=0,this.uvOffsetAndScale=s()}}class d{constructor(t,e,n){this.values=t,this.numSurfaceIndices=e,this.numSkirtIndices=n}}function y(){g.clear(),V.clear()}function w(t){g.release(t.vertexAttributes),t.vertexAttributes=null,t.indices=null}const I=65536;function v(e,n,r,s,c,u,a,l){const p=c[0],h=c[1],d=c[2],y=c[3],w=.1*a.radius*(y-h),I=e.numVertsPerRow-1,v=e.numVertsPerRow-1,P=e.numVertsPerRow*e.numVertsPerRow,V=2*I+2*v,A=g.acquire(P+V),M=A.position.typedBuffer,j=A.uv0.typedBuffer,O=s.geometryInfo.boundingBox;i(O);const T=n[2]-n[0],U=n[3]-n[1],q=d-p,E=r[0],N=r[1],W=r[2];for(let t=0;t<=I;t++){const e=t/I,r=p+e*q;k[t]=Math.sin(r),B[t]=Math.cos(r),D[t]=e,L[t]=n[0]+e*T}const C=u&&!!(1&l),z=u&&!!(2&l);let F=0;for(let o=0;o<=v;o++){let r=o/v;const s=t(h,y,r),i=Math.cos(s),c=Math.sin(s);let l;u?(l=a.halfSemiMajorAxis*Math.log((1+c)/(1-c)),r=(l-n[1])/U):l=180*s/Math.PI;for(let t=0;t<=I;t++){const n=D[t],s=k[t],u=B[t];let p=a.radius;e.samplerData&&(p+=f.sample(L[t],l,e.samplerData)||0);const g=u*i*p-E,h=s*i*p-N,d=c*p-W;S(g,h,d,O);const y=m*F;M[y+0]=g,M[y+1]=h,M[y+2]=d,j[y+0]=n,j[y+1]=r;const V=b(t,o,I,v);if(V>-1){const t=m*(P+V),e=C&&0===o?-1:z&&o===v?1:0,s=0===e?g:-E,i=0===e?h:-N,c=0===e?d:a.radius*e-W;M[t+0]=s,M[t+1]=i,M[t+2]=c,j[t+0]=0===e?R(n,r):n,j[t+1]=0===e?w:r,0!==e&&S(s,i,c,O)}++F}}s.geometryInfo.numVertsPerRow=e.numVertsPerRow,s.geometryInfo.vertexAttributes=A,s.geometryInfo.skirtLength=w,o(s.geometryInfo.uvOffsetAndScale,0,0,1,1),x(s.geometryInfo,e.numVertsPerRow,u?l:0,e.wireframe)}function P(t,n,r,s){const c=n[0],u=n[1],a=n[2]-c,l=n[3]-u,p=t.clippingArea,h=e(p)?Math.max(0,(p[0]-n[0])/a):0,d=e(p)?Math.max(0,(p[1]-n[1])/l):0,y=e(p)?Math.min(1,(p[2]-n[0])/a):1,w=e(p)?Math.min(1,(p[3]-n[1])/l):1,I=y>h?1/(y-h):1,v=w>d?1/(w-d):1,P=-h*I,V=-d*v,A=.1*a,M=t.numVertsPerRow-1,j=t.numVertsPerRow-1,k=t.numVertsPerRow*t.numVertsPerRow,B=2*M+2*j,D=g.acquire(k+B),L=D.position.typedBuffer,O=D.uv0.typedBuffer,T=s.geometryInfo.boundingBox;i(T);let U=0;for(let o=0;o<=j;o++){const n=o/j;let s=V+n*v,i=u+n*l;e(p)&&(i<p[1]?(i=p[1],s=0):i>p[3]&&(i=p[3],s=1));for(let u=0;u<=M;u++){const n=u/M;let l=P+n*I,g=c+n*a;e(p)&&(g<p[0]?(g=p[0],l=0):g>p[2]&&(g=p[2],l=1));const h=t.samplerData&&f.sample(g,i,t.samplerData)||0,d=g-r[0],y=i-r[1],w=h-r[2];S(d,y,w,T);const v=m*U;L[v+0]=d,L[v+1]=y,L[v+2]=w,O[v+0]=l,O[v+1]=s;const V=b(u,o,M,M);if(V>-1){const t=m*(k+V);L[t+0]=d,L[t+1]=y,L[t+2]=w,O[t+0]=R(l,s),O[t+1]=A}++U}}s.geometryInfo.numVertsPerRow=t.numVertsPerRow,s.geometryInfo.vertexAttributes=D,s.geometryInfo.skirtLength=A,o(s.geometryInfo.uvOffsetAndScale,h,d,y-h,w-d),x(s.geometryInfo,t.numVertsPerRow,0,t.wireframe)}const V=new Map;function x(t,e,n,r){const o=(2&n)>0,s=e+(r?1024:0)+(o?2048:0);let i=V.get(s);i||(i=A(e,o,r),V.set(s,i)),t.indices=i.values,t.numSurfaceIndices=i.numSurfaceIndices,t.numSkirtIndices=i.numSkirtIndices,t.numWithoutSkirtIndices=t.numSurfaceIndices+(n?6*(e-1)*(r?2:1):0)}function A(t,e,n){const r=t-1,o=t-1,s=t*t,i=2*r+2*o;let c=r*o*2*3,u=6*i,f=6*(2*r+o-1);n&&(c*=2,u*=2,f*=2);const a=s+i>I?new Uint32Array(c+u):new Uint16Array(c+u);let m,l,p,g,h=0,y=0,w=c,v=0;for(let d=0;d<=o;d++){e&&(v=0===d?f:d===o?-f:0),w+=v;for(let t=0;t<=r;t++){const e=b(t,d,r,o);if(e>-1){const i=M(t,d,r,o);0!==i&&(m=h,l=s+e,p=s+(0===t&&1===d?0:e+1),g=h+i,n?(a[w+0]=m,a[w+1]=l,a[w+2]=l,a[w+3]=p,a[w+4]=p,a[w+5]=m,a[w+6]=p,a[w+7]=g,a[w+8]=g,a[w+9]=m,a[w+10]=m,a[w+11]=p,w+=12):(a[w+0]=m,a[w+1]=l,a[w+2]=p,a[w+3]=p,a[w+4]=g,a[w+5]=m,w+=6))}++h,t<r&&d<o&&(m=d*(r+1)+t,l=m+1,p=l+(r+1),g=p-1,n?(a[y+0]=m,a[y+1]=l,a[y+2]=l,a[y+3]=p,a[y+4]=p,a[y+5]=m,a[y+6]=p,a[y+7]=g,a[y+8]=g,a[y+9]=m,a[y+10]=m,a[y+11]=p,y+=12):(a[y+0]=m,a[y+1]=l,a[y+2]=p,a[y+3]=p,a[y+4]=g,a[y+5]=m,y+=6))}w-=v}return new d(a,c,u)}function S(t,e,n,r){t<r[0]&&(r[0]=t),t>r[3]&&(r[3]=t),e<r[1]&&(r[1]=e),e>r[4]&&(r[4]=e),n<r[2]&&(r[2]=n),n>r[5]&&(r[5]=n)}function R(t,e){const n=e>t?1:0;return 2+4*n+(1-2*n)*(t+e)}function b(t,e,n,r){return 0===e?t:t===n?n+e:e===r?n+r+(n-t):0===t&&e>0?2*n+r+(r-e):-1}function M(t,e,n,r){return 0===e&&t!==n?1:t===n&&e!==r?n+1:e===r&&0!==t?-1:0===t&&0!==e?-(n+1):0}function j(t,r,o,s,i,c,u,f,a){const m=c.position,p=c.uv0,g=t[0],h=t[1],d=t[2],y=r[0]-g,w=r[1]-h,I=r[2]-d;s*=3;for(let v=o*=3;v<s;v+=3){const t=i[v],r=i[v+1],o=i[v+2];let s=m.get(t,0),c=m.get(t,1),P=m.get(t,2),V=m.get(r,0),x=m.get(r,1),A=m.get(r,2),S=m.get(o,0),R=m.get(o,1),b=m.get(o,2);p.get(t,0)>=2&&(n(O,s,c,P),u(O),s+=O[0],c+=O[1],P+=O[2]);p.get(r,0)>=2&&(n(O,V,x,A),u(O),V+=O[0],x+=O[1],A+=O[2]);p.get(o,0)>=2&&(n(O,S,R,b),u(O),S+=O[0],R+=O[1],b+=O[2]),e(f)&&([s,c,P]=f.applyToVertex(s,c,P),[V,x,A]=f.applyToVertex(V,x,A),[S,R,b]=f.applyToVertex(S,R,b));const M=V-s,j=x-c,k=A-P,B=S-s,D=R-c,L=b-P,U=w*L-D*I,q=I*B-L*y,E=y*D-B*w,N=M*U+j*q+k*E;if(Math.abs(N)<=Number.EPSILON)continue;const W=g-s,C=h-c,z=d-P,F=W*U+C*q+z*E;if(N>0){if(F<0||F>N)continue}else if(F>0||F<N)continue;const G=C*k-j*z,H=z*M-k*W,J=W*j-M*C,K=y*G+w*H+I*J;if(N>0){if(K<0||F+K>N)continue}else if(K>0||F+K<N)continue;const Q=(B*G+D*H+L*J)/N;if(Q>=0){a(Q,l(M,j,k,B,D,L,T))}}}const k=new Array(a+1),B=new Array(a+1),D=new Array(a+1),L=new Array(a+1),O=r(),T=r();export{h as PatchGeometry,y as clearCaches,P as createPlanarGlobePatch,v as createSphericalGlobePatch,j as intersectSkirts,w as releaseGeometry};
