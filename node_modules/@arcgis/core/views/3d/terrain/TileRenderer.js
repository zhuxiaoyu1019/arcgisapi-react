/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{nextHighestPowerOfTwo as e}from"../../../core/mathUtils.js";import{disposeMaybe as t,releaseMaybe as r,isSome as a,isNone as s}from"../../../core/maybe.js";import{s as i,c as o}from"../../../chunks/vec2.js";import{Z as n}from"../../../chunks/vec2f64.js";import{f as l}from"../../../chunks/vec4f64.js";import{isBaseLayer as c}from"../../../layers/support/layerUtils.js";import"../../webgl/BufferObject.js";import"../../webgl/FramebufferObject.js";import"../../../core/has.js";import"../../webgl/enums.js";import"../../webgl/RenderingContext.js";import"../../../chunks/builtins.js";import u from"../../webgl/Texture.js";import"../../webgl/VertexArrayObject.js";import{VectorTileRendererHelper3D as h}from"../../2d/engine/vectorTiles/VectorTileRendererHelper3D.js";import{ImageWithType as d}from"../support/StreamDataLoader.js";import{BlendLayersTechniqueConfiguration as f,BlendLayersTechnique as p}from"./BlendLayersTechnique.js";import{RasterColorizerTechniqueConfiguration as _,RasterColorizerTechnique as m}from"./RasterColorizerTechnique.js";import{isVectorTileLayerView as T,isVectorTileRenderInfo as x,isImageryTileRenderInfo as b,isRasterTileRenderInfo as y,isTextureTileRenderInfo as g}from"./terrainUtils.js";import w from"./TileTexture.js";import{FBOPool as D}from"./support/FBOPool.js";import{Pos2Tex as I}from"../webgl-engine/lib/DefaultVertexBufferLayouts.js";import{createQuadVAO as k,createColorTexture as L,createEmptyTexture as O}from"../webgl-engine/lib/glUtil3D.js";import{vertexCount as C}from"../../webgl/Util.js";class R{constructor(e,t,r){this._rctx=e,this.tileSize=t,this._backgroundIsGrid=!1,this._backgroundTexture=null,this._backgroundColor=null,this._blackTex=null,this._vectorTileHelper=new h,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._vaoQuad=k(this._rctx,I);const a=new f;a.mode=2,this._blendLayersTechnique=r.acquire(p,a),a.mode=1,this._applyOpacityTechnique=r.acquire(p,a),this._techniqueRep=r,this._blackTex=new w(L(this._rctx,[0,0,0,1])),this._fboPool=new D(this._rctx)}dispose(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad=t(this._vaoQuad),this._backgroundTexture=r(this._backgroundTexture),this._blackTex=r(this._blackTex),this._blendLayersTechnique=t(this._blendLayersTechnique),this._applyOpacityTechnique=t(this._applyOpacityTechnique),this._vectorTileHelper=t(this._vectorTileHelper)}updateTileTexture(e){const t=e.layerInfo[1];for(const a of t)a.pendingUpdates&=-65;if(!e.renderData)return;const r=e.surface,i=r.baseOpacity;let o=0,n=0,l=this.tileSize,u=!1;const h=r.view.pixelRatio;let d=t.length,f=0;for(;f<t.length&&!u;f++){const s=r.layerViewByIndex(f,1),p=s.fullOpacity;if(P[f]=p,c(s.layer)&&d>=t.length&&(d=f),0===p)continue;++n;const _=q(e,f,U);_&&(T(s)?l=Math.max(l,this.tileSize*h):1===i&&1===p&&(s.isOpaque||this._dataToTexture(_)&&a(_.sourceLayerInfo.data)&&_.sourceLayerInfo.data.descriptor.isOpaque)&&(u=!0),++o)}this._cleanupFBOPool(h,t.length),l=j(l);const p=l/this.tileSize,_=f-1;if(0===o){let t=0;return(e.surface.view.layerViewManager.updating||n>0)&&(t=5e3),this._backgroundTexture&&s(e.renderData.textureReference)&&(t=0),void this._useBackgroundTexture(e,t)}1===o&&(u||this._backgroundIsGrid||a(this._backgroundColor))&&this._useLayerTexture(e,_,d,P[_])||this._composeMapLayers(e,_,d,u,P,l,p)}setBackground(e,t){r(this._backgroundTexture),this._backgroundIsGrid=t,e instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(e),this._backgroundColor=null):(this._backgroundTexture=new w(L(this._rctx,e)),this._backgroundColor=l(e[0]||0,e[1]||0,e[2]||0,e[3]||0))}get backgroundIsGrid(){return this._backgroundIsGrid}get backgroundColor(){return this._backgroundColor}_buildTexture(e,t=9987){if(s(e))return null;const r={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:t,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},a=this._rctx;let i;if("number"==typeof e)r.width=r.height=e,i=new w(new u(a,r));else if(e instanceof d)r.isOpaque=e.isOpaque,i=new w(new u(a,r,e.image)),e.release();else try{i=new w(new u(a,r,e))}catch(n){i=new w(O(a)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const o=a.bindTexture(i.texture,u.TEXTURE_UNIT_FOR_UPDATES);return i.generateMipmap(),a.bindTexture(o,u.TEXTURE_UNIT_FOR_UPDATES),i}_drawQuad(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(5,0,C(this._vaoQuad,"geometry"))}_drawRasterData(e,t,r,a,i=1){if(s(t))return;const o=this._rctx,n=e.program;o.setPipelineState(e.pipeline),o.useProgram(n),n.bindTexture(t,"tex"),n.setUniform1f("scale",r),n.setUniform2f("offset",a[0],a[1]),n.setUniform1f("opacity",i),this._drawQuad(n)}hasNearestInterpolation(e){const t=e.sourceLayerInfo.data;return!(s(t)||!t.source)&&"nearest"===t.interpolation}_drawImageryTileData(e,t=1){const r=e.sourceLayerInfo.data;if(s(r)||!r.source)return;e.tile.surface.layerViewByIndex(e.layerIndex,1).ensureSymbolizerParameters(r);const a=this._getRasterColorizerTechnique(r.symbolizerParameters.type,!!r.symbolizerParameters.colormap),i=this._rctx,o=a.program;if(i.setPipelineState(a.pipeline),i.useProgram(o),!r.bind(i))return;r.opacity=t,r.scale=e.scale,r.offset=e.offset;const{names:n,textures:l}=r.getTextures();n.forEach(((e,t)=>o.bindTexture(l[t],e))),a.bindPass(r.getUniforms()),this._drawQuad(o),i.bindVAO()}_getRasterColorizerTechnique(e,t){const r=["stretch","lut","hillshade"].indexOf(e);return this._rasterColorizerConfig||(this._rasterColorizerConfig=new _,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=r,this._rasterColorizerConfig.applyColormap=t,this._rasterColorizerTechnique=this._techniqueRep.releaseAndAcquire(m,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}_drawVectorData(e,t,r,i,o,n,l){const c=t.sourceLayerInfo.data;if(s(c))return l;const u=this._rctx,h=t.tile.surface.layerViewByIndex(t.layerIndex,1);let d;return u.setPipelineState(e.pipeline),i<1?(d=this._fboPool.acquire(o),u.bindFramebuffer(d),u.setClearColor(1,1,1,0),u.clearSafe(16640)):l&&u.clearSafe(256),this._vectorTileHelper.render(u,t.sourceLod,c,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/t.scale),t.offset,this.tileSize,r),!a(d)||(u.bindFramebuffer(n),this._drawRasterData(e,d.colorTexture,1,[0,0],i),this._fboPool.release(d),l)}_useBackgroundTexture(e,t){e.renderData.opacity=e.surface.baseOpacity,e.renderData.compositeBackgroundInShader=!1,e.renderData.layerOpacity=1,e.renderData.baseOpacity=1,e.renderData.setTextureReference(this._backgroundTexture,0,0,1,t)}_useLayerTexture(e,t,r,a){const s=t<r;e.renderData.opacity=s?1:e.surface.baseOpacity,e.renderData.compositeBackgroundInShader=!0,e.renderData.layerOpacity=a,e.renderData.baseOpacity=s?e.surface.baseOpacity:1;const i=q(e,t,U);if(this._dataToTexture(i)){const t=i.offset;return e.renderData.setTextureReference(i.sourceLayerInfo.data,t[0],t[1],i.scale),!0}return!1}_composeMapLayers(e,t,r,s,i,o,l){const c=this._rctx,h=this._fboPool.acquire(o);c.bindFramebuffer(h),c.setViewport(0,0,o,o),c.setClearColor(0,0,0,0),c.setClearDepth(1),c.clearSafe(16640);let d=!1;!s&&a(this._backgroundTexture)&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture.texture,1,n);const f=e.surface.baseOpacity;let p=!1,_=9987;for(let u=t;u>=0;u--){const t=q(e,u,U);t&&(u<r&&f<1&&!p&&(this._drawRasterData(this._applyOpacityTechnique,this._blackTex.texture,1,n,f),p=!0),0!==i[u]&&(x(t)?d=this._drawVectorData(this._blendLayersTechnique,t,l,i[u],o,h,d):b(t)?(this._drawImageryTileData(t,i[u]),this.hasNearestInterpolation(t)&&(_=9728)):this._dataToTexture(t)&&a(t.sourceLayerInfo.data)&&this._drawRasterData(this._blendLayersTechnique,t.sourceLayerInfo.data.texture,t.scale,t.offset,i[u])))}const m=e.renderData.ensureTexture(o,(()=>this._buildTexture(o,_))),T=c.bindTexture(m.texture,u.TEXTURE_UNIT_FOR_UPDATES),y=m.descriptor;c.gl.copyTexImage2D(c.gl.TEXTURE_2D,0,y.pixelFormat,0,0,y.width,y.height,0),m.generateMipmap(),c.bindTexture(T,u.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(null),this._fboPool.release(h),e.renderData.opacity=p?1:f,e.renderData.compositeBackgroundInShader=!1,e.renderData.layerOpacity=1,e.renderData.baseOpacity=1,e.renderData.setTextureReference(m,0,0,1)}_dataToTexture(e){return y(e)&&this._rasterDataToTexture(e),g(e)}_rasterDataToTexture(e){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}_cleanupFBOPool(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t)}get test(){return{backgroundTexture:this._backgroundTexture}}}function j(t){const r=e(t),a=r*r,s=t*t;if(a===s)return t;const i=r/2;return a-s<s-i*i?r:i}function q(e,t,r){r.layerIndex=t;const a=e.layerInfo[1][t];if(a.data)return i(r.offset,0,0),r.tile=e,r.scale=1,r.sourceLod=e.lij,r.sourceLayerInfo=a,r;const s=a.upsampleInfo;if(s){const e=s.tile.layerInfo[1][t];return r.tile=s.tile,o(r.offset,s.offset),r.scale=s.scale,r.sourceLod=s.tile.lij,r.sourceLayerInfo=e,r}return null}const P=new Array,U={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};export{R as TileRenderer};
