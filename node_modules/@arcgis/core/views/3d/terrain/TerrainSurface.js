/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../Color.js";import i from"../../../core/Accessor.js";import{difference as r}from"../../../core/arrayUtils.js";import s from"../../../core/CollectionFlattener.js";import a from"../../../core/Evented.js";import n from"../../../core/Handles.js";import l from"../../../core/Logger.js";import{clamp as o}from"../../../core/mathUtils.js";import{releaseMaybe as h,destroyMaybe as d,unwrapOr as u,isNone as p,isSome as c}from"../../../core/maybe.js";import _ from"../../../core/ObjectPool.js";import g from"../../../core/PooledArray.js";import{isAbortError as m,isAborted as y,createAbortError as v}from"../../../core/promiseUtils.js";import{init as f}from"../../../core/watchUtils.js";import{aliasOf as T}from"../../../core/accessorSupport/decorators/aliasOf.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import{property as w}from"../../../core/accessorSupport/decorators/property.js";import{subclass as S}from"../../../core/accessorSupport/decorators/subclass.js";import{m as x}from"../../../chunks/mat4.js";import{c as L}from"../../../chunks/mat4f64.js";import{g as C}from"../../../chunks/vec3.js";import{c as D}from"../../../chunks/vec3f64.js";import{c as P}from"../../../chunks/vec4f64.js";import{projectVectorToVector as j,projectPointToVector as U}from"../../../geometry/projection.js";import{getReferenceEllipsoid as R}from"../../../geometry/projectionEllipsoid.js";import{create as b,equals as M,set as E,containsPoint as O,empty as V,expand as k}from"../../../geometry/support/aaBoundingRect.js";import{create as I,copy as q}from"../../../geometry/support/frustum.js";import{ElevationQueryTileCache as A}from"../../../layers/support/ElevationQueryTileCache.js";import{isBaseLayer as B}from"../../../layers/support/layerUtils.js";import{acquireDecoder as F}from"../../../layers/support/LercDecoder.js";import{printAllocations as H}from"../../2d/engine/vectorTiles/VectorTile.js";import W from"../layers/ElevationLayerView3D.js";import{directionToHeadingTilt as N,scaleToZoom as Q}from"../support/cameraUtils.js";import G from"../support/debugFlags.js";import{toBoundingRect as z}from"../support/extentUtils.js";import{updatingProgress as X}from"../support/updatingProperties.js";import{ElevationBounds as Y}from"./ElevationBounds.js";import{ElevationData as $}from"./ElevationData.js";import{OverlayManager as J}from"./OverlayManager.js";import{PlanarPatch as K}from"./PlanarPatch.js";import{SphericalPatch as Z}from"./SphericalPatch.js";import{create as ee}from"./SurfaceExtentHelper.js";import{SurfaceTilingSchemeLogic as te}from"./SurfaceTilingSchemeLogic.js";import{DEFAULT_TILE_BACKGROUND as ie,MAX_ROOT_TILES as re,TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR as se,TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR as ae,MAX_MEMORY_LOD_BIAS as ne,LayerClasses as le,ELEVATION_NODATA_VALUE as oe}from"./TerrainConst.js";import he from"./TerrainRenderer.js";import de from"./TerrainSurfacePerformanceInfo.js";import{weakAssert as ue,computeSkirtScale as pe,isSurfaceLayerView as ce,isElevationLayerView as _e,isVectorTileLayerView as ge,useFetchTileForLayer as me,isImageryTileLayerView as ye,isTileLayerView as ve,releaseTileData as fe}from"./terrainUtils.js";import Te,{SplitLimits as we}from"./Tile.js";import{printAllocations as Se}from"./TilePerLayerInfo.js";import{IteratorPreorder as xe,IteratorPostorder as Le,hasLoadableSiblings as Ce,sortTilesByPOI as De,sortTiles as Pe}from"./tileUtils.js";import{UpsampleInfo as je}from"./UpsampleInfo.js";import{TaskPriority as Ue,noBudget as Re}from"../../support/Scheduler.js";import{WatchUpdatingTracking as be}from"../../support/WatchUpdatingTracking.js";const Me=l.getLogger("esri.views.3d.terrain.TerrainSurface"),Ee=.25;let Oe=class extends(a.EventedMixin(i)){constructor(e){super(e),this._elevationBounds=new Y,this._rootExtent=b(),this._iteratorPool=new _(xe,(e=>e.remove=()=>this._iteratorPool.release(e))),this._postorderIterator=new Le,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visible=!1,this._usedMemory=Be,this._performanceInfo=new de,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._overlayOpacity=1,this._eyePosRenderSR=D(),this._eyePosSurfaceSR=D(),this._splitLimits=new we,this._snapLevel=1/0,this._frustum=I(),this._viewProjectionMatrix=L(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new n,this._watchUpdatingTracking=new be,this._allTiles=new g,this._upsampleInfoPool=new _(je),this._getElevationData={spatialReference:null,rootTiles:null},this._maxNumUpdating=1,this.maxTextureScale=1.2,this.rootTiles=null,this.backgroundImage=ie,this.backgroundColor=null,this._layerViewsDirty=!1}initialize(){this._lercDecoder=F(this.view.resourceController),this._tilePool=this.view.state.isLocal?new _(K):new _(Z);const e=this.view.resourceController.memoryController;this._upsampleMapCache=e.getMemCache("esri.views.3d.terrain.upsample",(e=>e.unloadMapData())),this._elevationQueryCache=new A(e.getMemCache("elevation-query")),this._set("overlayManager",new J({surface:this})),this._handles.add([this.watch("overlayManager.hasHighlights",(e=>this._renderer.setNeedsHighlight(e))),this.watch("overlayManager.rendersOccluded",(e=>this._renderer.setRenderOccludedOverlay(e)))],"overlayManager"),this._renderer=new he({overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:R(this.view.spatialReference).radius,stage:this.view._stage,updateOverlayOpacity:()=>this.updateOverlayOpacity(),allTiles:this._allTiles}),this._handles.add([f(this,"baseOpacity",(e=>{this._handleLayerViewChanges(),this._updateBaseOpacity(e)}),!0),f(this,"_background",(()=>{this._handleLayerViewChanges(),this._renderer.setTileBackground(this._background)}),!0),this.view.watch("pointsOfInterest",(e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add(e.focus,"renderLocation",(()=>()=>this._allTilesSorted=!1))})),f(G,"TERRAIN_TILE_TREE_SHOW_TILES",(e=>{e&&!this._treeDebugger?import("../layers/support/TerrainTileTree3DDebugger.js").then((({TerrainTileTree3DDebugger:e})=>{!this._treeDebugger&&G.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new e({view:this.view}))})):e||!this._treeDebugger||G.TERRAIN_TILE_TREE_SHOW_TILES||(this._treeDebugger.destroy(),this._treeDebugger=null)}))]);const t={layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,spatialReference:this.view.spatialReference};this.extentHelper=ee(this.viewingMode,t),this._handles.add(f(this.extentHelper,"stencilEnabledExtents",(e=>this._renderer.setStencilEnabledLayerExtents(e))),"extentHelper");const i=this.view.defaultsFromMap?new s({getCollections:()=>{var e,t,i;return null==(e=this.view)||null==(t=e.defaultsFromMap)||null==(i=t.mapCollectionPaths)?void 0:i.map((e=>this.view.map.get(e)))},getChildrenFunction:e=>e&&"layers"in e?e.layers:null}):this.view.map.allLayers,r=new te({layers:i,extentHelper:this.extentHelper,viewingMode:this.viewingMode,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",r),this._handles.add([this.tilingSchemeLogic.watch("tilingScheme",(()=>this._updateTilingSchemeAndExtent()),!0),this.tilingSchemeLogic.watch("extent",(()=>this._updateTilingSchemeAndExtent()),!0)],"tilingSchemeLogic"),this._updateTilingSchemeAndExtent(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(0),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(1);const a=this.view.resourceController.scheduler;this._frameTask=a.registerTask(Ue.TERRAIN_SURFACE,this),this.view.resourceController.memoryController.events.on("quality-changed",(()=>this._viewChangeUpdate())),this._handles.add([this.view.on("resize",(()=>this._viewChangeUpdate())),this.view.watch("state.camera",(()=>this._viewChangeUpdate()),!0),this.view.watch("state.contentCamera",(()=>this.view.state.fixedContentCamera&&this._viewChangeUpdate()),!0),this.view.watch("qualitySettings.tiledSurface.lodBias",(()=>this._viewChangeUpdate())),f(this.view,"qualitySettings.tiledSurface.textureFadeDuration",(e=>this._renderer.textureFadingEnabled=e>0)),this.view.watch("lodSnapping",(()=>this._viewChangeUpdate())),this.view.watch("clippingArea",(()=>this._clippingChanged()))]),this._handles.add(this.view.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._updateClippingExtent(),this.notifyChange("extent")}destroy(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=h(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=d(this._upsampleMapCache),this._elevationQueryCache=d(this._elevationQueryCache),this._set("tilingSchemeLogic",d(this.tilingSchemeLogic)),this.extentHelper=d(this.extentHelper),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",d(this.overlayManager)),this._tilePool=d(this._tilePool),Te.prune(),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._renderer=d(this._renderer),this._iteratorPool=d(this._iteratorPool),this._set("view",null),this._upsampleInfoPool=d(this._upsampleInfoPool),H(),Se()}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){var e,t;const i=null==(e=this.view.pointsOfInterest)||null==(t=e.contentCameraOnSurface)?void 0:t.scale;if(i){const e=this.view.state.contentCamera;let t=N(this.view,e.eye,e.viewForward,e.up).tilt;t>90&&(t=180-t);const r=2*(t/90)**2,s=Q(this.view,i)-r;Math.abs(this._snapLevel-s)>Ee&&(Math.round(s)!==Math.round(this._snapLevel)&&(this._viewChanged=!0),this._snapLevel=s)}return Math.round(this._snapLevel)}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?1:0}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get extent(){return u(this._clippingExtent,this._rootExtent)}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this._watchUpdatingTracking.updating||this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||this._asyncWorkItems>0||!this._allTilesSorted||this._renderer.updating||this._layerViewsDirty)&&this.ready&&!this.suspended||this.overlayManager.updating||this._frameTask.updating)}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get viewingMode(){return this.view.state.viewingMode}get ready(){return!!this.rootTiles}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}set skirtScale(e){this._renderer.skirtScale=e}get skirtScale(){return this._renderer.skirtScale}get spatialReference(){var e,t;return null!=(e=null==(t=this.tilingScheme)?void 0:t.spatialReference)?e:null}get _background(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage}set slicePlaneEnabled(e){var t,i;this._renderer.slicePlane=e,this._set("slicePlaneEnabled",e),null==(t=this.view)||null==(i=t._stage)||i.renderView.setRenderParameters({opaqueTerrain:this.opaque})}set velvetOverground(e){e!==this.velvetOverground&&(this._renderer.velvetOverground=e),this._set("velvetOverground",e)}set visible(e){e!==this._visible&&(this._visible=e,this._renderer.setVisibility(e),this.suspended=!e)}get opaque(){return this._renderer.opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r)}getElevation(e,t,i,r){const s=Fe,a=this.getTileWithElevation(e,t,i,r,s);return p(a)?null:$.sample(s[0],s[1],a.renderData.geometryState.samplerData)}getTileWithElevation(e,t,i,r,s=Fe){const a=this._getElevationData.rootTiles;if(!a||!a.length)return null;if(0===a[0].layerInfo[0].length)return null;if(s[0]=e,s[1]=t,s[2]=i,!j(s,r,s,this._getElevationData.spatialReference))return Me.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(let n of a){if(!n.containsPoint(s))continue;for(;n&&!n.rendered&&!n.isLeaf;){let e=0;s[0]>.5*(n.extent[0]+n.extent[2])&&(e+=1),s[1]<.5*(n.extent[1]+n.extent[3])&&(e+=2),n=n.children[e]}const e=n.renderData;return(e&&e.geometryState?e.geometryState.samplerData:null)?n:null}return null}get elevationBounds(){return this._elevationBounds}getScale(e){if(this.tilingScheme){if(!U(e,Fe,this.spatialReference))return Me.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const t=this.rootTiles;if(t)for(let e of t)if(e.containsPoint(Fe)){for(;null!=e.children[0];){let t=0;Fe[0]>e.children[0].extent[2]&&(t+=1),Fe[1]<e.children[0].extent[1]&&(t+=2),e=e.children[t]}return this._getLodBiasCorrectedScale(e.level)}}return 1e100}queryVisibleScaleRange(e,t,i,r){const s=t?this.tilingScheme.levelAtScale(t):0,a=i?this.tilingScheme.levelAtScale(i):1/0,n=this.lodBias;this._renderer.queryVisibleLevelRange(e,s+n,a+n,r)}_updateBaseOpacity(e){const t=this._renderer.opaque;this._renderer.opaque=e>=1,this._renderer.isTransparent=this._allTransparentSurfaceLayers();const i=t!==this._renderer.opaque;var r,s;i&&(null==(r=this.view)||null==(s=r._stage)||s.renderView.setRenderParameters({opaqueTerrain:this.opaque}));this._updateTileTextures(i)}_updateTilingSchemeAndExtent(){const e=this.tilingSchemeLogic.extent,t=e&&!M(e,this._dataExtent);t&&(c(this._dataExtent)?E(this._dataExtent,e):this._dataExtent=b(e));const i=this.tilingSchemeLogic.tilingScheme,r=i!==this.tilingScheme;var s;r&&(ue(!!i,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",i),this._updateClippingExtent(),i&&(this._updateTiledLayers(),this._renderer.setTileSize(i.pixelSize),this.overlayManager.setSpatialReference(i.spatialReference)),this._getElevationData.spatialReference=null!=(s=null==i?void 0:i.spatialReference)?s:null);(t||r)&&this._updateRootTiles()}_acquireTile(e,t,i,r){const s=this._tilePool.acquire();return We[0]=e,We[1]=t,We[2]=i,s.init(We,r,this),s}_updateRootTiles(){const e=this._clippingExtent||this._dataExtent,t=this.tilingScheme;if(p(e)||!t)return;const i=He;let s=t.rootTilesInExtent(e,i,5*re);const a=e=>{const t=this._acquireTile(0,e[1],e[2],null);return 2===t.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&t.setPendingUpdate(2),this._loadTile(t),t};if(this.rootTiles){if(s.length>re)return void Me.warn(se);const e=this.rootTiles.map((e=>e.lij)),t=r(e,s,ke);if(t.removed.length>0||t.added.length>0){const e=this.rootTiles.filter((e=>!(t.removed.findIndex(ke.bind(null,e.lij))>-1)||(this._purgeTile(e),!1)));t.added.forEach((t=>e.push(a(t)))),this._setRootTiles(e)}}else s.length>re&&(Me.warn(ae),s=t.rootTilesInExtent(e,i,re)),this._setRootTiles(s.map((e=>a(e))));M(i,this._rootExtent)||(this._rootExtent=b(i),this._hasFixedExtent()||this.notifyChange("extent")),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setOverlayPlacementDirty(),this.notifyChange("ready")}_setRootTiles(e){if(this._set("rootTiles",e),this._allTiles.clear(),e){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._getElevationData.rootTiles=e,this._renderer.setRootTiles(this.rootTiles),this._updateTileVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this.updateOverlayOpacity(),this._updateTileVisibility(this.rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this._clippingExtent)&&e.resetPendingUpdate(32)&&this._updateTileGeometry(e)}_updateTileVisibility(e){if(!e)return;const t=this._iteratorPool.acquire();t.reset(e);const i=Ce(e);let r=i?this._elevationBounds.min:1/0,s=i?this._elevationBounds.max:-1/0;for(;!t.done;){const e=t.next();this._updateClippingStatus(e),e.updateVisibility(),e.setPendingUpdate(16),e.loadable?(e.updateScreenDepth(this._viewProjectionMatrix),e.renderData&&(r=Math.min(e.elevationBounds[0],r),s=Math.max(e.elevationBounds[1],s))):t.skipSubtree()}t.remove(),this._viewChanged=!0,this._allTilesDirty=!0,isFinite(r)&&isFinite(s)&&(this._elevationBounds.min===r&&this._elevationBounds.max===s||(this._elevationBounds.min=r,this._elevationBounds.max=s,this.emit("elevation-bounds-change",null)))}_updateViewDependentParameters(){const e=this.view.state.camera,t=this.view.state.contentCamera,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,a=2**-this.lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*a,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*a,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(p(this._splitLimits.frustum)&&(this._splitLimits.frustum=I()),q(t.frustum,this._splitLimits.frustum)):this._splitLimits.frustum=null,q(e.frustum,this._frustum),x(this._viewProjectionMatrix,t.projectionMatrix,t.viewMatrix),C(this._eyePosRenderSR,t.eye),j(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateSkirts(){const e=this.view.state.camera,t=this.view.state.constraints.collision.enabled?0:1.11*e.near;this.skirtScale=pe(this,this._eyePosSurfaceSR,t)}_updateRenderData(e){e.rendered&&!e.shouldLoad&&(qe(e)?this._loadChildren(e):Ae(e)&&this._loadParent(e))}_updateTileGeometry(e){e.updateVisibility(),this._renderer.updateTileGeometry(e),this._elevationUpdate(e),this._usedMemory=Be}_elevationUpdate(e){Qe.spatialReference=this.spatialReference,Qe.tile=e,Qe.extent=e.extent,this.emit("elevation-change",Qe),O(e.extent,this._eyePosSurfaceSR)&&this._updateSkirts()}get running(){return this.updating&&this.ready&&!this.suspended}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateTileStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;this._mergeAndSplit(e,t),e.run((()=>this._updateElevation(e))),e.run((()=>this._updateTextures(e))),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),e.done&&this.requestUpdate(),this.notifyChange("updatingProgressValue")}_updateTileStatus(e){if(!this._viewChanged||!this.rootTiles||e.done)return;this._viewChanged=!1;const t=this._iteratorPool.acquire();for(t.reset(this.rootTiles);!t.done;){const e=t.next();if(e.loadable){const i=e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(2===i){e.resetPendingUpdate(8),e.isLeaf&&(e.setPendingUpdate(2),t.skipSubtree());continue}e.resetPendingUpdate(2)&&e.updateAgentSuspension(),4===i&&e.updateAgents(0)}if(t.skipSubtree(),!e.isLeaf){e.setPendingUpdate(8),e.resetPendingUpdate(2);const t=this._iteratorPool.acquire();t.resetOne(e);for(let e=t.next();!t.done;e=t.next())this._updateClippingStatus(e),e.updateVisibility(),e.loadable&&e.updateScreenDepth(this._viewProjectionMatrix);t.remove()}}t.remove(),this.requestUpdate(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||(De(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_mergeAndSplit(e,t){if(this.suspended||!this._allTilesDirty||e.done)return;this._allTilesDirty=!1,this.requestUpdate();let i=0;for(;!e.done;){let r=!1;i=0;const s=!this._allTiles.some((s=>{if(i+=s.usedMemory,s.resetPendingUpdate(8)){if(!t)return s.setPendingUpdate(8),e.done;this._mergeTile(s),r=!0,e.madeProgress()}else s.resetPendingUpdate(2)&&(this._splitTile(s),r=!0,e.madeProgress());return s.resetPendingUpdate(16)&&(this._updateRenderData(s),e.madeProgress()),e.done}));if(r&&(this._allTilesSorted=!1,this._allTilesDirty=!0),s){if(this._usedMemory=i,!r)break}else this._allTilesDirty=!0}0===i&&(this._allTilesDirty=!0),this._sortTiles(e)}_updateElevation(e){return this._allTiles.some((t=>(t.resetPendingUpdate(32)&&(this._updateTileGeometry(t),t.resetPendingUpdate(64)&&(this._renderer.updateTileTexture(t),this._usedMemory=Be),e.madeProgress()),e.done))),e.hasProgressed}_updateTextures(e){return this._allTiles.some((t=>(t.resetPendingUpdate(64)&&(this._renderer.updateTileTexture(t),this._usedMemory=Be,e.madeProgress()),e.done))),e.hasProgressed}_updateClippingExtent(){if(!this.spatialReference)return!1;const e=b();let t=null;return z(this.view.clippingArea,e,this.spatialReference)&&(t=e),!M(t,this._clippingExtent)&&(this._clippingExtent=t,this._renderer.clippingExtent=t,this.notifyChange("extent"),this.updateTileOverlayParams(),this.overlayManager.setOverlayPlacementDirty(),!0)}_clippingChanged(){this._updateClippingExtent()&&this._updateRootTiles()}get lodBias(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*ne}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=o(e-this.lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){this.rootTiles&&(this.rootTiles.forEach((e=>this._purgeTile(e))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.visible=!1}_purgeChildTiles(e){if(e.isLeaf)return!1;let t=this._purgeTile(e.children[0]);return t=this._purgeTile(e.children[1])||t,t=this._purgeTile(e.children[2])||t,t=this._purgeTile(e.children[3])||t,e.unsetChildren(),t}_purgeTile(e){const t=this._purgeChildTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),e.unload(this._renderer),this._tilePool.release(e),t}_splitTile(e){ue(e.isLeaf,"tile that is already split should not be split again!");const t=e.level+1,i=2*e.lij[1],r=2*e.lij[2];e.setChildren(this._createTile(t,i,r,e),this._createTile(t,i,r+1,e),this._createTile(t,i+1,r,e),this._createTile(t,i+1,r+1,e)),e.setPendingUpdate(16),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,this._emitTileScaleChange(e,t),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){Ge.spatialReference=this.spatialReference,Ge.extent=e.extent,Ge.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",Ge)}_createTile(e,t,i,r){ue(!!r,"_createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this._clippingExtent),s.loadable&&(s.updateScreenDepth(this._viewProjectionMatrix),2===s.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&s.setPendingUpdate(2)),s}_mergeTile(e){ue(!e.hasPendingUpdate(2),"_mergeTile sanity check"),this._purgeChildTiles(e)&&(ue(!e.renderData,"_mergeTile sanity check"),this._loadTile(e)),this._allTilesDirty=!0,++this._performanceInfo.numMerged,this._emitTileScaleChange(e)}_loadChildren(e){ue(e.rendered,"parent should be rendered"),e.unload(this._renderer),this._loadTile(e.children[0]),this._loadTile(e.children[1]),this._loadTile(e.children[2]),this._loadTile(e.children[3])}_loadParent(e){const t=e.parent;this._unloadChildren(t),this._loadTile(t)}_unloadChildren(e){e.isLeaf||(this._unloadChildren(e.children[0]),e.children[0].unload(this._renderer),this._unloadChildren(e.children[1]),e.children[1].unload(this._renderer),this._unloadChildren(e.children[2]),e.children[2].unload(this._renderer),this._unloadChildren(e.children[3]),e.children[3].unload(this._renderer))}_loadTile(e){e.load(this._renderer),e.setPendingUpdate(16),this.requestUpdate(),this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e),this._elevationUpdate(e)}_elevationDataArrived(e,t,i){const r=new $(e.lij,e.extent,i);e.dataArrived(t,0,r);const s=[e],a=e.level,n=this._iteratorPool.acquire();for(n.reset(s);!n.done;){const e=n.next();e.findElevationBoundsForLayer(t,a),e.computeElevationBounds()}n.remove(),this._updateTileVisibility(s)}_handleLayerViewChanges(e=Re){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(const s of this.view.allLayerViews.items)if(i.add(s.uid),ce(s))if(this._basemapLayerViewHandles.has(s.uid)){const e=this.layerClassFromLayerView(s),i=this._layerIndexByUid[e].get(s.uid);i<r&&(t=!0),r=i}else this._registerTiledLayerView(s),s.layer.loaded&&(t=!0);this._basemapLayerViewHandles.forEach(((e,r)=>{i.has(r)||(this._unregisterTiledLayerView(r),t=!0)})),t&&this._updateTiledLayers(),this._renderer.isTransparent=this._allTransparentSurfaceLayers(),e.madeProgress()}_allTransparentSurfaceLayers(){let e=0===this.view.map.ground.opacity;for(const t of this.view.allLayerViews.items)if(ce(t)&&!_e(t)&&!B(t.layer)&&0!==t.fullOpacity)return e=!1,e;return e}layerClassFromLayerView(e){return _e(e)?0:1}_registerTiledLayerView(e){const t=[],i=this.layerClassFromLayerView(e);t.push(e.watch("suspended",(()=>this._updateTiledLayers()))),t.push(e.watch("fullOpacity",(()=>this._updateTileTextures(!1)))),t.push(e.layer.watch("scaleRangeId",(()=>this._restartAllAgents(i)))),e.on("data-changed",(()=>{const t=this._layerIndexByUid[i].get(e.uid);null!=t&&this._invalidateLayerData(t,i)})),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(let e=0;e<t.length;e++)t[e].remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;const r=V();e.forEach((e=>{const s=e.layer;if(!s||e.suspended||!ce(e))return;const a=e.fullExtent;if(!a)return void Me.warn("Terrain: Map or elevation layer does not have fullExtent: "+s.id);if(!this.tilingScheme.compatibleWith(e.tileInfo))return void Me.warn("Terrain: tiling scheme of layer "+s.id+" is incompatible with other tiled layers, will not be drawn");k(r,a);const n=this.layerClassFromLayerView(e);if(1===n){const t=e.displayLevelRange;t.maxLevel!==1/0&&(null===i||t.maxLevel>i)&&(i=t.maxLevel)}t[n].push(e)}));for(const s of le){const e=this._layerViews[s],i=t[s];i.reverse();const r=i.length;let a=e.length!==r;const n=new Array(r),l=new Array(e.length);this._layerIndexByUid[s].clear();for(let t=0;t<r;t++){const r=i[t].uid;this._layerIndexByUid[s].set(r,t);const o=e.indexOf(i[t]);n[t]=o,t!==o&&(a=!0),o>-1&&(l[o]=t)}if(a){const e=this._postorderIterator;for(e.reset(this.rootTiles);!e.done;)e.next().modifyLayers(l,n,s);this._layerViews[s]=i,this._restartAllAgents(s),this._updateTileVisibility(this.rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;){const i=t.next();i.restartAgents(e),0===e&&i.computeElevationBounds()}}_hasFixedExtent(){return!!this._clippingExtent}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll((t=>{t.updateAgents(1),e?this.renderer.updateTileTexture(t):t.updateRenderData(1)})),this._renderer.isTransparent=this._allTransparentSurfaceLayers()}_invalidateLayerData(e,t){this._allTiles.forAll((i=>i.removeLayerAgent(e,t))),this._allTiles.forAll((i=>i.invalidateLayerData(e,t)))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=1){this.renderer.setNeedsRender(e)}requestUpdate(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,r){const s=this.layerViewByIndex(t,i),a=s.layer;return!a.tilemapCache||ge(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,a.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...r,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw--this._asyncWorkItems,m(t)||this._dataMissing(e,i,s,{notInTilemap:!0}),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,i,s,r)),r.signal))))}_requestTileData(e,t,i,r){return 0===t?this._requestElevationTileData(e,i,r):this._requestMapTileData(e,i,r)}_requestElevationTileData(e,t,i){if(!_e(t))return void ue(!1,"_requestElevationTileData can only be called for elevation layer views");const r=r=>{if(--this._asyncWorkItems,y(i))return;const s=this._layerIndexByUid[0].get(t.uid);null!=s?(this._usedMemory=Be,this.requestUpdate(),this._elevationDataArrived(e,s,r)):Me.warn("TerrainSurface: received data from unknown layer %d %s",0,e.lij.toString())},s=i=>{--this._asyncWorkItems,m(i)||(this._dataMissing(e,0,t,i),this.requestUpdate())};if(++this._asyncWorkItems,me(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:oe,signal:i.signal}).then((e=>{if(y(i))return Me.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void s(v());this._frameTask.schedule((()=>r(e)),i.signal)}),s);const a=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(a,"binary",i).then((e=>this._lercDecoder.decode(e,{noDataValue:oe},i.signal))).then((e=>{r({values:e.pixelData,width:e.width,height:e.height,noDataValue:e.noDataValue,minValue:e.minValue,maxValue:e.maxValue})}),s)}_requestMapTileData(e,t,i){if(t instanceof W)return Promise.reject();++this._asyncWorkItems;const r=(r,s)=>{--this._asyncWorkItems,fe(s),y(i)||(this._dataMissing(e,1,t,r),this.requestUpdate())},s=e=>t=>r(t,e),a=r=>this._frameTask.schedule((()=>{--this._asyncWorkItems,this.requestUpdate(),y(i)?fe(r):this._mapTileDataArrived(e,t,r)}),i.signal,s(r)).catch(s(r)),n=(e,t=null)=>this._frameTask.schedule((()=>r(e,t))).catch(s(t));if(ge(t)){const r=t.schemaHelper.getLevelRowColumn(e.lij);return t.fetchTile(r[0],r[1],r[2],i).then(a,n)}if(ye(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(a,n);if(ve(t)&&me(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then((e=>{if(y(i))return Me.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void n(v());a(e)}),n);let l=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);Ie(t)&&t.refreshTimestamp&&(l+=`${l.indexOf("?")>-1?"&":"?"}_ts=${t.refreshTimestamp}`);const o=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(l,o,i).then(a,n)}_mapTileDataArrived(e,t,i){const r=this._layerIndexByUid[1].get(t.uid);null!=r?e.dataArrived(r,1,i):(fe(i),Me.warn("TerrainSurface: received data from unknown layer"))}_dataMissing(e,t,i,r){const s=this._layerIndexByUid[t].get(i.uid);null!=s?e.dataMissing(s,t,r):Me.warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll((e=>{e.renderData&&this.overlayManager.setTileParameters(e)})),this._renderer.setNeedsRender())}updateOverlayOpacity(){if(!this.overlayManager)return;const e=this._eyePosSurfaceSR[2],t=this.overlayManager.computeOpacity(e);this._overlayOpacity!==t&&(this._overlayOpacity=t,this._renderer.overlayOpacity=t,this._renderer.setNeedsRender())}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))})),e}getUsedMemory(){return this.tilingScheme?(this._usedMemory===Be&&(this._usedMemory=0,this._allTiles.forAll((e=>this._usedMemory+=e.usedMemory))),this._usedMemory):0}getUsedMemoryForLayerView(e){let t=0;const i=this.layerClassFromLayerView(e),r=this._layerIndexByUid[i].get(e.uid);return this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(i,r))),t}getTile(e){if(p(e))return null;const t=e.split("/").map((e=>+e));if(0===t[0])return this.rootTiles.find((e=>e.lij[1]===t[1]&&e.lij[2]===t[2]));const i=2**t[0],r=Math.floor(t[1]/i),s=Math.floor(t[2]/i);let a;if(this.rootTiles.some((e=>e.lij[1]===r&&e.lij[2]===s&&(a=e,!0))),a){let e=1<<t[0]-1;for(;a.lij[0]<t[0];){let i=t[1]&e?2:0;if((t[2]&e)>0&&i++,!a.children[i])return null;a=a.children[i],e>>=1}return ue(a.lij[0]===t[0]&&a.lij[1]===t[1]&&a.lij[2]===t[2],"not the right tile?"),a}return null}get test(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{e._mergeTile(e.rootTiles[0]),e._viewChangeUpdate()},getTiles:()=>e._allTiles.toArray(),getRenderedTiles:()=>(Ne.clear(),e._allTiles.forAll((e=>{e.visible&&e.rendered&&Ne.push(e)})),Pe(e.renderOrder,Ne),Ne.toArray())}}};e([w()],Oe.prototype,"_renderer",void 0),e([w()],Oe.prototype,"_hasPendingUpdates",void 0),e([w()],Oe.prototype,"_asyncWorkItems",void 0),e([w()],Oe.prototype,"_allTilesDirty",void 0),e([w()],Oe.prototype,"_allTilesSorted",void 0),e([w()],Oe.prototype,"_viewChanged",void 0),e([w({readOnly:!0})],Oe.prototype,"_watchUpdatingTracking",void 0),e([w()],Oe.prototype,"_frameTask",void 0),e([w({readOnly:!0})],Oe.prototype,"snapLevel",null),e([w({readOnly:!0})],Oe.prototype,"lodSnapping",null),e([w({constructOnly:!0})],Oe.prototype,"view",void 0),e([T("_renderer.cullBackFaces")],Oe.prototype,"cullBackFaces",void 0),e([w({readOnly:!0,dependsOn:[]})],Oe.prototype,"extent",null),e([w({readOnly:!0})],Oe.prototype,"updating",null),e([w(X)],Oe.prototype,"updatingProgress",void 0),e([w({readOnly:!0})],Oe.prototype,"updatingProgressValue",null),e([w()],Oe.prototype,"_maxNumUpdating",void 0),e([w({aliasOf:"view.map.ground.opacity"})],Oe.prototype,"baseOpacity",void 0),e([w({readOnly:!0})],Oe.prototype,"overlayManager",void 0),e([w({readOnly:!0})],Oe.prototype,"viewingMode",null),e([w()],Oe.prototype,"maxTextureScale",void 0),e([w({readOnly:!0})],Oe.prototype,"ready",null),e([w({value:1})],Oe.prototype,"renderOrder",null),e([w({readOnly:!0})],Oe.prototype,"rootTiles",void 0),e([w({readOnly:!0})],Oe.prototype,"spatialReference",null),e([w()],Oe.prototype,"backgroundImage",void 0),e([w({type:t,aliasOf:"view.map.ground.surfaceColor"})],Oe.prototype,"backgroundColor",void 0),e([w()],Oe.prototype,"_background",null),e([w({value:!1})],Oe.prototype,"slicePlaneEnabled",null),e([w({readOnly:!0})],Oe.prototype,"tilingScheme",void 0),e([w({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],Oe.prototype,"tilingSchemeLocked",void 0),e([w({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],Oe.prototype,"tilingSchemeDone",void 0),e([w({readOnly:!0})],Oe.prototype,"tilingSchemeLogic",void 0),e([w({value:!0})],Oe.prototype,"velvetOverground",null),e([T("_renderer.wireframe")],Oe.prototype,"wireframe",void 0),e([w({value:!1})],Oe.prototype,"suspended",null),e([w({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],Oe.prototype,"textureFadeDuration",void 0),e([w()],Oe.prototype,"_layerViewsDirty",void 0),e([T("_renderer.renderPatchBorders")],Oe.prototype,"renderPatchBorders",void 0),e([T("_renderer.renderingDisabled")],Oe.prototype,"renderingDisabled",void 0),Oe=e([S("esri.views.3d.terrain.TerrainSurface")],Oe);var Ve=Oe;function ke(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function Ie(e){return null!=e.refreshInterval}function qe(e){return!e.isLeaf&&(e.children[0].shouldLoad||e.children[1].shouldLoad||e.children[2].shouldLoad||e.children[3].shouldLoad||qe(e.children[0])||qe(e.children[1])||qe(e.children[2])||qe(e.children[3]))}function Ae(e){return e.isLeaf&&e.parent&&e.parent.shouldLoad}const Be=-1,Fe=P(),He=b(),We=[0,0,0],Ne=new g,Qe={spatialReference:null,tile:null,extent:null,context:"ground"},Ge={spatialReference:null,extent:null,scale:0};export default Ve;
