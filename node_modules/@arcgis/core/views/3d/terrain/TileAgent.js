/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{isSome as e,get as t,isNone as s}from"../../../core/maybe.js";import{PROGRESSIVE_LOADING_MODULO as i}from"./TerrainConst.js";import{getLayerWithExtentRange as l}from"./terrainUtils.js";import{fallsWithinLayer as a}from"./tileUtils.js";class r{get updating(){return!!this._tileRequested}init(e,t,s,i){this.tile=e,this._layerIdx=t,this._layerClass=s,this._suspended=i,this._tileLayerInfo=e.getLayerInfo(t,s),this._tileRequested=null;const l=this._findAncestorWithData();this._setUpsampleTile(l)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const t=this._findNextDownload();if(this._tileRequested){if(t===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return e(t)?t.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=t):this._agentDone(),!!this._tileRequested}_findNextDownload(){const r=this._layerIdx,n=this._layerClass,h=this.tile.surface.layerViewByIndex(r,n),d=l(h),{minLevel:_,maxLevel:o}=h.dataLevelRange,u=this._desiredMinLevelDelta,p=this._progressiveLevelModulo+u,y=this._scaleRangeEnabled?a:()=>!0;let f=this.tile;const q=f.level;let v;const I=this._tileLayerInfo.upsampleInfo,L=I?I.tile.level:-1,m=t(d,"tilemapCache");for(;f&&y(f,d,!1)&&f.level>=_;){const e=f.level,t=q-e,l=f.layerInfo[n][r];if(l.data&&t>=u){e>L&&this._setUpsampleTile(f),l.dataInvalidated&&(v=f);break}if((s(m)||"unavailable"!==m.getAvailability(f.lij[0],f.lij[1],f.lij[2]))&&e<=o&&!l.data&&!l.dataMissing&&((s(v)||f.level===_||e%i==0||q-v.level<u)&&(v=f),t>=p))break;f=f.parent}return e(v)&&q-v.level<u&&this._tileLayerInfo.upsampleInfo&&(v=null),v}_findAncestorWithData(){const e=this.tile.vlevel,t=this._desiredMinLevelDelta;let s;for(let i=this.tile;i;i=i.parent)if(i.hasLayerData(this._layerIdx,this._layerClass)){if(e-i.level>=t)return i;s=i}return s}_setUpsampleTile(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}class n extends r{get _desiredMinLevelDelta(){throw h}get _progressiveLevelModulo(){throw h}dispose(){}}const h=new Error("Abstract method called on TileAgent"),d=new n;export{d as TILE_AGENT_DONE,r as TileAgent};
