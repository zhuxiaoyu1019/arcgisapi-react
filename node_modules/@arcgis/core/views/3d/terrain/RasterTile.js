/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{isSome as t,isNone as r,disposeMaybe as e}from"../../../core/maybe.js";import{createTransformTexture as s,getBasicGridUniforms as i,getCommonUniforms as o,getColormapUniforms as a,getStretchUniforms as h,getShadedReliefUniforms as l,createRasterTexture as u,createColormapTexture as n}from"../../webgl/rasterUtils.js";const m={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,type:"stretch"};class d{constructor(t,r,e=null,s=null){this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.scale=1,this.offset=[0,0],this.opacity=1,this.lij=t,this.source=r,this.width=e||r.width,this.height=s||r.height}get source(){return this._source}set source(t){this._source=t,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._memoryUsed=null)}get symbolizerParameters(){return this.isRendereredSource?{...m,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||m}set symbolizerParameters(t){this._symbolizerParameters=t}get bandIds(){return this._bandIds}set bandIds(r){if(t(r)&&r.length>0){this._bandIds&&r.every(((t,r)=>!!this._bandIds[r]&&t===this._bandIds[r]))||(this._bandIds=r,this._dirty=!0)}else this._bandIds=null}get interpolation(){return this._interpolation}set interpolation(t){this._interpolation=t,this._rasterTexture&&this._rasterTexture.setSamplingMode("bilinear"===t?9729:9728)}get transformGrid(){return this._transformGrid}set transformGrid(t){this._transformGrid=t,this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null,this._memoryUsed=null)}bind(t){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&(this._rasterTexture&&!this._dirty||this._updateRasterTexture(t,this.bandIds),this._rasterTexture&&(this._updateColormapTexture(t),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=s(t,this.transformGrid))),!0)}getUniforms(){const t=i(this.scale,this.offset),{symbolizerParameters:r,transformGrid:e,width:s,height:u,opacity:n}=this;return{basic:t,common:o(e,[s,u],[this.source.width,this.source.height],n),colormap:r.colormap?a(r.colormap,r.colormapOffset):null,stretch:"stretch"===this.symbolizerParameters.type?h(this.symbolizerParameters):null,hillshade:"hillshade"===this.symbolizerParameters.type?l(this.symbolizerParameters):null}}getTextures(){const t=new Array,r=[];return this._rasterTexture&&(r.push(this._rasterTexture),t.push("u_image"),this._transformGridTexture&&(r.push(this._transformGridTexture),t.push("u_transformGrid")),this._colormapTexture&&(r.push(this._colormapTexture),t.push("u_colormap"))),{names:t,textures:r}}get memoryUsage(){if(r(this._memoryUsed)){const t=this.getTextures();if(null==t)return 0;this._memoryUsed=t.textures.map((t=>t.descriptor.width*t.descriptor.height*4)).reduce(((t,r)=>t+r),0)}return this._memoryUsed}release(){return this._rasterTexture=e(this._rasterTexture),this._transformGridTexture=e(this._transformGridTexture),this._colormapTexture=e(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,s){const i=this.source?this.source.extractBands(s):null;if(!(i&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null));const o=r(s)&&r(this.bandIds)||t(s)&&t(this.bandIds)&&s.join("")===this.bandIds.join("");if(this._rasterTexture){if(o)return;this._rasterTexture.dispose(),this._rasterTexture=null}this._rasterTexture=u(e,i,this.interpolation||"nearest",this.isRendereredSource)}_updateColormapTexture(t){const r=this._colormap,e=this.symbolizerParameters.colormap;return e?r?e.length!==r.length||e.some(((t,e)=>t!==r[e]))?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=n(t,e),void(this._colormap=e)):void 0:(this._colormapTexture=n(t,e),void(this._colormap=e)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))}}export default d;
