/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{clamp as t}from"../../../core/mathUtils.js";import{bilerp as a}from"../support/mathUtils.js";import{ELEVATION_NODATA_VALUE as s}from"./TerrainConst.js";class i{constructor(t,a,s){this.samplerData=null,this.level=t[0],this.i=t[1],this.j=t[2],this.extent=a;const i=s.noDataValue,o=s.values;let e=1/0,l=-1/0,h=!0,r=!1;for(let n=0;n<o.length;n++){const t=o[n];t!==i?(e=t<e?t:e,l=t>l?t:l,h=!1):r=!0}h&&(e=0,l=0),l=l>-3e38?l:0,this.samplerData={pixelData:s.values,width:s.width,height:s.height,noDataValue:i,safeWidth:.99999999*(s.width-1),dx:(s.width-1)/(a[2]-a[0]),dy:(s.width-1)/(a[3]-a[1]),x0:a[0],y1:a[3]},this.bounds=[e,l],this.hasNoDataValues=r}release(){this.samplerData=null,this.bounds=null}computeMinMaxValue(t,i,o,e){e.min=1/0,e.max=-1/0,e.hasNoDataValues=!1;const l=t-this.level;if(l<=0)return e;const h=2**l;if(!(Math.floor(i/h)===this.i&&Math.floor(o/h)===this.j))return e;let r=1/0,n=-1/0;const m=this.samplerData.width,f=this.samplerData.pixelData,u=.5*s;let c=(m-1)/h,p=(o-this.j*h)*c,d=(i-this.i*h)*c;if(c<1){const t=Math.floor(p),s=Math.floor(d),i=t+s*m,o=f[i],l=f[i+1],h=f[i+m],r=f[i+m+1];if(o+l+h+r<u){const i=p-t,n=d-s,m=a(o,l,h,r,i,n),f=a(o,l,h,r,i+c,n),u=a(o,l,h,r,i,n+c),x=a(o,l,h,r,i+c,n+c);return e.min=Math.min(m,f,u,x),e.max=Math.max(m,f,u,x),e}p=t,d=s,c=1}else p=Math.floor(p),d=Math.floor(d),c=Math.ceil(c);for(let a=p;a<=p+c;a++)for(let t=d;t<=d+c;t++){const s=f[a+t*m];s<u?(r=Math.min(r,s),n=Math.max(n,s)):e.hasNoDataValues=!0}return e.min=r,e.max=n,e}static sample(a,i,o){for(const e of o){if(!e)continue;const o=e.safeWidth,l=e.width,h=e.pixelData;let r=t(e.dy*(e.y1-i),0,o),n=t(e.dx*(a-e.x0),0,o);const m=Math.floor(r),f=Math.floor(n),u=m*l+f,c=u+l,p=h[u],d=h[c],x=h[u+1],M=h[c+1];if(p+d+x+M<.5*s){r-=m,n-=f;const t=p+(x-p)*n;return t+(d+(M-d)*n-t)*r}}return null}}export{i as ElevationData};
