/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{deg2rad as t,sign as e,clamp as n,acosClamped as o}from"../../../../core/mathUtils.js";import{isNone as r}from"../../../../core/maybe.js";import{createScreenPointArray as a}from"../../../../core/screenUtils.js";import{i as s,c as i,m as c}from"../../../../chunks/mat4.js";import{c as m}from"../../../../chunks/mat4f64.js";import{s as u}from"../../../../chunks/vec2.js";import{a as p}from"../../../../chunks/vec2f64.js";import{g as l,d as f,a as h,f as M,n as y,c as g,m as b,b as d,l as j,e as v,s as z,h as x}from"../../../../chunks/vec3.js";import{c as P}from"../../../../chunks/vec3f64.js";import{axis as k,fromPoints as I,wrapAxisAngle as w,create as A}from"../../../../geometry/support/axisAngle.js";import{coordinateSystemFromOneAxisAndNormalVector as H,vectorCoordinates as U}from"../../../../geometry/support/coordinateSystem.js";import{intersectRay as E,fromNormalAndOffset as G,create as S}from"../../../../geometry/support/plane.js";import{b as V,i as q,c as F}from"../../../../chunks/sphere.js";import{angle as R}from"../../../../geometry/support/vector.js";import{sv3d as C,sm4d as T}from"../../../../geometry/support/vectorStacks.js";import{cyclicalPI as W}from"../../support/mathUtils.js";import{fromScreen as B,fromScreenAtEye as D}from"../../support/geometryUtils/ray.js";import{intersectScreen as J}from"../../support/geometryUtils/sphere.js";import K from"../../webgl-engine/lib/Camera.js";function L(t,e,n){return n[0]=e[0]/(t.fullWidth/t.pixelRatio),n[1]=e[1]/(t.fullHeight/t.pixelRatio),n}function N(t,e,n){const o=C.get(),r=C.get(),a=C.get();l(r,t),l(a,e);const s=f(r,n),i=f(a,n);h(o,n,s),M(r,r,o),y(r,r),h(o,n,i),M(a,a,o),y(a,a);const c=f(r,a);g(o,n,r);const m=f(a,o);return Math.atan2(m,c)}function O(t){for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}function Q(t,e,n){const o=T.get();s(o),i(o,o,n[3],k(n)),M(Jt,t.eye,e),b(Jt,Jt,o),t.eye=d(Jt,Jt,e),M(Jt,t.center,e),b(Jt,Jt,o),t.center=d(Jt,Jt,e),t.up=b(Jt,t.up,o)}function X(t,e,n,o){return E(t,B(e,n,Qt),o)}function Y(t,e,n,o){const r=C.get();let a=1-n;M(r,e,t.eye);const s=j(r);let i=s*(1-a);a>=0&&i<o&&(i=o,a=-(i-s)/s),Math.abs(s-i)<1e-6||(h(r,r,a),t.eye=d(Jt,t.eye,r),t.center=v(Jt,t.center,e,a))}function Z(t,e,n){e.getScreenCenter($),J(t,e,$,Jt)&&(e.center=Jt);const o=e.distance,r=o*n;if(Math.abs(o-r)<1e-6)return;const a=h(C.get(),e.viewForward,r);e.eye=M(Jt,e.center,a)}const $=a();function _(t,e,n){tt(e,n),y(n,n),h(n,n,t)}function tt(t,e){z(e,0,0,0);for(const n of t)d(e,e,n);h(e,e,1/t.length)}function et(t,e,n,o){return Math.sin(t/j(e))*(n+o.radius)}function nt(t,e,n,o){return et(Math.PI/2,e,n,o)+(t-Math.PI/2)}var ot;!function(t){t[t.Vertical=0]="Vertical",t[t.Horizontal=1]="Horizontal"}(ot||(ot={}));const rt={Elevation:3e4,Angle:t(6)},at={Pole:.95,Angle:t(18),Tilt:45},st=t(80);function it(t,e,n,o,r){const a=P(),s=F();let i=!0,c=!0;return t.intersectScreen(n,a)?s[3]=j(a):(c=!1,e.aboveGround?s[3]=Math.max(j(e.center),.9*r.radius):s[3]=j(e.eye)-e.relativeElevation,o?pt(s,e,n,a):i=J(s,e,n,a)),{sphere:s,scenePickPoint:i?a:null,hasGeometryIntersection:c}}function ct(t,n,o,r){if(j(t.eye)-r.radius>rt.Elevation)return ot.Horizontal;if(!o)return ot.Vertical;D(t,n,Xt);return-e(t.relativeElevation)*(.5*Math.PI+R(t.eye,Xt.direction))<rt.Angle?ot.Vertical:ot.Horizontal}function mt(t,e,n){M(ut,n,e),t.eye=M(Jt,t.eye,ut),t.center=M(Jt,t.center,ut)}const ut=P();function pt(t,e,n,o){const a=D(e,n,Qt);return!r(a)&&(V(t,a,lt),q(t,a,o)?!(x(lt,a.origin)<x(o,a.origin))||(l(o,lt),!1):(M(ft,e.eye,e.center),y(ft,ft),G(ft,-f(y(ft,ft),lt),ht),E(ht,a,o),!1))}const lt=P(),ft=P(),ht=S();function Mt(e,r,a,s,i,c){let m;if(g(Nt,e,r),M(Kt,e,r),j(e)<=i||!s.aboveGround){g(a,Kt,s.eye);const u=f(e,r)/(j(e)*j(r)),p=Math.cos(n(W.normalize(t(c)),0,st));m=-o(u)-Math.max(0,j(r)-i)/(p*i)}else M(yt,s.eye,s.center),g(a,Kt,yt),m=-j(Kt)/i;return y(a,a),h(a,a,j(Nt)),m}const yt=P();function gt(e,r,a,s){let i,c;const m=Math.cos(n(W.normalize(t(s)),0,st));return i=r>a?-(r-a)/(m*a):r<-a?Math.PI-(r+a)/(m*a):o(r/a),c=e>a?-(e-a)/(m*a):e<-a?Math.PI-(e+a)/(m*a):o(e/a),(c-i)*a}function bt(t,e,n,o,r,a,s,i,c,m){const p=gt(t[2],e[2],s[3],c),l=m?gt(t[0],e[0],s[3],180):e[0]-t[0],h=Math.sin(i)*l-Math.cos(i)*p,M=Math.cos(i)*l+Math.sin(i)*p;y(Jt,r);const g=m?h/Math.sqrt(Math.abs(s[3]**2-f(n,Jt)**2)):h/s[3],b=M/Math.sqrt(Math.abs(s[3]**2-f(n,o)**2));u(a,g,b)}function dt(t,e,n,o,r,a,s,i,c,m){g(Nt,t,e),H(a.up,a.eye,Gt,St,Vt),H([0,0,1],a.eye,Ht,Ut,Et),l(n,Ut),l(o,Ht),y(n,n),h(n,n,j(Nt)),U(t,y(St,St),y(Vt,Vt),y(Gt,Gt),qt),U(e,St,Vt,Gt,Ft),bt(qt,Ft,t,Ht,Ut,r,s,i,c,m)}function jt(t,e,n,o,r,a,m){s(Tt),s(Wt),s(Bt),i(Tt,Tt,r,o),i(Wt,Wt,m,a),c(Bt,Tt,Wt),M(e,t,n),b(e,e,Bt),d(e,e,n)}function vt(t,e,n,o,r,a){s(Tt),s(Wt),s(Bt),i(Tt,Tt,o,n),i(Wt,Wt,a,r),c(Bt,Tt,Wt),M(Jt,t.eye,e),b(Jt,Jt,Bt),t.eye=d(Jt,Jt,e),M(Jt,t.center,e),b(Jt,Jt,Bt),t.center=d(Jt,Jt,e),M(Jt,t.up,e),b(Jt,Jt,Bt),t.up=d(Jt,Jt,e)}function zt(t,e,n,o,r,a,s=at.Pole,i=at.Angle){const c=Math.abs(o)>Math.PI-i||Math.abs(o)<i,m=Math.abs(t[2])<n*s||Math.abs(e)>n;return!!(c&&m&&a.aboveGround&&r<at.Tilt)}function xt(t,e,n,o,r,a){if(a)I(n,o,Ct),Q(e,t,Ct);else{const a=Mt(n,o,Ot,e,t[3],r);Q(e,t,w(Ot,a))}}function Pt(t,e,n,o,r,a,s){const i=s?20:1,c=1e-12;let m,u;l(Dt,o),Lt.copyFrom(e);for(let p=0;p<i&&x(n,Dt)>c&&(m=x(n,Dt),dt(n,Dt,Ut,Ht,Rt,Lt,t,r,a,s),vt(Lt,t,Ht,Rt[1],Ut,Rt[0]),jt(Dt,Dt,t,Ht,Rt[1],Ut,Rt[0]),u=x(n,Dt),u<m||0===p);p++)e.copyFrom(Lt)}function kt(e,n,o,r,a,s,i){zt(o,f(n.up,o),e[3],-W.normalize(t(a)),s,n,at.Pole,at.Angle)?Pt(e,n,o,r,-W.normalize(t(a)),s,i):xt(e,n,o,r,s,i)}function It(t,e,n,o,r,a){const{eye:s}=t;H([0,0,1],s,Ht,Ut,Et);const c=e.translation[0]*n.pan,m="zoom"===r.mode?0:e.translation[1]*n.pan,u=Math.max(Math.sqrt(Math.abs(1-f(t.center,Ht)**2/j(t.center)**2)),.5),p=(Math.sin(a)*m+Math.cos(a)*c)/u,l=-Math.cos(a)*m+Math.sin(a)*c;switch(i(o.pan.matrix,o.pan.matrix,p,Ht),o.pan.enabled=!0,r.mode){case"pan":i(o.pan.matrix,o.pan.matrix,l,Ut),o.pan.enabled=!0;break;case"zoom":o.zoom=-e.translation[1]*n.zoom}}function wt(t,e,n,o,r){const{eye:a,viewRight:s}=t,c=g(C.get(),s,a),m=e.translation[0]*n.pan;switch(0!==m&&(i(o.pan.matrix,o.pan.matrix,-m,c),o.pan.enabled=!0),r.mode){case"pan":{const t=e.translation[1]*n.pan;0!==t&&(i(o.pan.matrix,o.pan.matrix,t,s),o.pan.enabled=!0);break}case"zoom":o.zoom=-e.translation[1]*n.zoom}}function At(e,n,o,r,a,s,i,c,m){zt(e.center,f(e.up,e.center),j(e.center),-W.normalize(t(s)),i,n)?It(n,o,r,c,m,-W.normalize(t(a))):wt(n,o,r,c,m)}const Ht=P(),Ut=P(),Et=P(),Gt=P(),St=P(),Vt=P(),qt=P(),Ft=P(),Rt=p(),Ct=A(),Tt=m(),Wt=m(),Bt=m(),Dt=P(),Jt=P(),Kt=P(),Lt=new K,Nt=P(),Ot=P(),Qt={origin:P(),direction:P()},Xt={origin:P(),direction:P()};export{ot as NavigationMode,at as PreservingHeadingThreshold,st as TiltThresholdPanningSpeed,rt as VerticalPanTresholds,mt as applyPanPlanar,xt as applyPanSphericalDirectRotation,Pt as applyPanSphericalPreserveHeading,Q as applyRotation,vt as applyRotationWithTwoAxes,Z as applyZoomOnSphere,Y as applyZoomToPoint,tt as centroid,_ as centroidOnSphere,ct as decideNavigationMode,X as intersectPlaneFromScreenPoint,gt as lengthFromPoints,L as normalizeCoordinate,O as normalizeRotationDelta,nt as offSurfaceTiltToEyeTiltGlobal,et as onSurfaceTiltToEyeTiltGlobal,At as panMotionToRotationMatrix,kt as panToPosition,it as pickPointAndInitSphere,zt as preserveHeadingThreshold,jt as rotatePointAroundTwoAxes,Mt as rotationAngleAndAxisDirectRotation,dt as rotationAnglesAndAxesHeadingPreserving,bt as rotationAnglesHeadingPreserving,N as rotationFromPointsAroundAxis,pt as sphereOrPlanePointFromScreenPoint};
