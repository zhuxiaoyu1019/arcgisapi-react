/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import i from"../../../../core/has.js";import{acosClamped as s,clamp as o}from"../../../../core/mathUtils.js";import{createScreenPointArray as r}from"../../../../core/screenUtils.js";import{property as e}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/Logger.js";import{subclass as a}from"../../../../core/accessorSupport/decorators/subclass.js";import{i as n,c as p}from"../../../../chunks/mat4.js";import{c as h}from"../../../../chunks/mat4f64.js";import{c}from"../../../../chunks/vec2.js";import{a as m}from"../../../../chunks/vec2f64.js";import{g as l,f as v,l as u,n as f,b as P,a as d,d as C,c as w,m as j}from"../../../../chunks/vec3.js";import{c as y}from"../../../../chunks/vec3f64.js";import{getReferenceEllipsoid as R}from"../../../../geometry/projectionEllipsoid.js";import{applyAll as g}from"../../camera/constraintUtils.js";import{TiltDefault as x}from"../Constraints.js";import{InteractiveController as T}from"./InteractiveController.js";import{normalizeCoordinate as D,decideNavigationMode as M,NavigationMode as k}from"../utils/navigationUtils.js";const O=7,V=90;let b=class extends T{constructor(t){super(t),this.view=null,this.pivot=0,this.lastPoint=m(),this.tmpWorldUp=y(),this.tmpViewDir=y(),this.tmpRotCurPoint=m(),this.tmpTransf=h(),this.tmpAxis=y(),this.tmpPivotPoint=y(),this.pivotPos=y(),this.constraintOptions={selection:15,interactionType:2,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.rotScale=0===this.pivot?3:1.5}begin(t){if(this.active){switch(this.pivot){case 1:l(this.pivotPos,this.startCamera.eye),this.constraintOptions.interactionType=3,this.constraintOptions.tiltMode=1,this.constraintOptions.selection=0;break;case 0:this.intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this.pivotPos)||l(this.pivotPos,this.startCamera.center),i("disable-feature:context-navigation")||this.constrainPivotPoint(t),this.startCamera.center=this.pivotPos,this.constraintOptions.interactionType=2,this.constraintOptions.tiltMode=0,this.constraintOptions.selection=11}this.constraintOptions.interactionStartCamera=this.startCamera,D(this.startCamera,t,this.lastPoint)}}constrainPivotPoint(t){const i=this.startCamera,s=y();v(s,this.pivotPos,i.eye);let o=u(s);this.view.camera.position.hasZ&&(o=Math.min(o,O*Math.abs(this.view.camera.position.z)));const e=R(this.view.spatialReference),a=r(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),n=M(this.startCamera,a,!0,e);let p=this.view._stage.renderView.getMinimalDepthForArea(i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,2.5*V,V),h=this.view._stage.renderView.getMinimalDepthForArea(t[0],t[1],i,V);void 0===p&&void 0===h||(p=void 0===p?h:p,h=void 0===h||n===k.Horizontal?p:h,o=p>h?h:p),f(s,s),l(this.pivotPos,P(this.tmpPivotPoint,i.eye,d(this.tmpPivotPoint,s,o)))}update(t){if(this.active){switch(this.pivot){case 1:this.currentCamera.center=this.applyRotation(this.currentCamera,t,this.currentCamera.center,this.pivotPos);break;case 0:this.currentCamera.center=this.pivotPos,this.currentCamera.eye=this.applyRotation(this.currentCamera,t,this.currentCamera.eye,this.pivotPos)}g(this.view,this.currentCamera,this.constraintOptions)}}end(){this.active&&this.finishController()}applyRotation(t,i,r,e){this.view.renderCoordsHelper.worldUpAtPosition(e,this.tmpWorldUp),D(t,i,this.tmpRotCurPoint);let a=(this.lastPoint[1]-this.tmpRotCurPoint[1])*this.rotScale,h=(this.tmpRotCurPoint[0]-this.lastPoint[0])*this.rotScale;v(this.tmpViewDir,r,e);const m=u(this.tmpViewDir),l=s(C(this.tmpViewDir,this.tmpWorldUp)/m);if(1===this.pivot){a*=-.5;const t=.5*Math.PI-l,i=.5*Math.PI*.99;a=t-Math.max(-i,Math.min(i,t+a))}return a=o(a+l,x.min,x.max)-l,n(this.tmpTransf),w(this.tmpAxis,t.up,this.tmpViewDir),0===this.pivot&&(h=-h),p(this.tmpTransf,this.tmpTransf,h,this.tmpWorldUp),p(this.tmpTransf,this.tmpTransf,a,this.tmpAxis),j(this.tmpViewDir,this.tmpViewDir,this.tmpTransf),t.up=j(U,t.up,this.tmpTransf),P(U,e,this.tmpViewDir),c(this.lastPoint,this.tmpRotCurPoint),U}};t([e({constructOnly:!0})],b.prototype,"view",void 0),t([e()],b.prototype,"pivot",void 0),b=t([a("esri.views.3d.state.controllers.RotateController")],b);const U=y();export{b as RotateController};
