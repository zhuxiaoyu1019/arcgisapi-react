/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{isNone as e,abortMaybe as t,isSome as n}from"../../../core/maybe.js";import{createTask as r}from"../../../core/promiseUtils.js";import{pointEquals as a}from"../../../layers/graphics/dehydratedFeatureComparison.js";import{EventPipeline as i}from"../../interactive/dragEventPipeline.js";import{SnappingContext as o}from"../../interactive/snapping/SnappingContext.js";import{TaskPriority as p,ImmediateTask as s}from"../../support/Scheduler.js";class c{constructor(){this.next=new i}createSnapDragEventPipelineStep({predicate:c=(()=>!0),cancel:l,snappingManager:d,snappingContext:m,updatingHandles:u}){if(e(d))return e=>e;let x=null,g=null;const y=()=>{x=t(x),d.doneSnapping(),n(g)&&g.frameTask.remove(),g=null};return l.next((e=>(y(),e))),this.next=new i,e=>{if(!c(e))return e;if(x=t(x),"start"===e.action){const t="3d"===d.view.type?d.view.resourceController.scheduler.registerTask(p.SNAPPING):s;g={context:new o({geometry:m.geometry,elevationInfo:m.elevationInfo,pointer:m.pointer,vertexHandle:n(e.info)?e.info.handle:null,excludeFeature:m.excludeFeature,visualizer:m.visualizer}),originalPos:n(e.snapOrigin)?m.coordinateHelper.createDehydratedPoint(e.snapOrigin):e.mapStart,frameTask:t}}if(n(g)){const t=g.context.coordinateHelper.createDehydratedPoint(g.context.coordinateHelper.fromArray([g.originalPos.x,g.originalPos.y,g.originalPos.z]));t.x+=e.mapEnd.x-e.mapStart.x,t.y+=e.mapEnd.y-e.mapStart.y;const n=e.mapStart.x-g.originalPos.x,i=e.mapStart.y-g.originalPos.y,o={...e,action:"udpate"},p=g.context,s=d.update(t,g.context);if(e.mapEnd.x=s.x+n,e.mapEnd.y=s.y+i,"end"!==e.action){const e=g.frameTask;x=r((async r=>{const c=await e.schedule((()=>d.snap(t,p,r)),r);if(c.valid){const t=await e.schedule((()=>c.apply()),r);a(t,s)||(o.mapEnd.x=t.x+n,o.mapEnd.y=t.y+i,this.next.execute(o))}})),u.addPromise(x.promise)}}return"end"===e.action&&y(),e}}}export{c as SnappingPipeline};
