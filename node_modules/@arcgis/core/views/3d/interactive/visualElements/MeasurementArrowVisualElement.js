/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../../../../core/Handles.js";import{isNone as r,isSome as t}from"../../../../core/maybe.js";import{c as s}from"../../../../chunks/mat4f64.js";import{f as i}from"../../../../chunks/vec3.js";import{c as a}from"../../../../chunks/vec3f64.js";import{sv3d as o}from"../../../../geometry/support/vectorStacks.js";import{Object3DVisualElement as n}from"./Object3DVisualElement.js";import h from"../../webgl-engine/lib/GeometryUtil.js";import{MeasurementArrowMaterial as l}from"../../webgl-engine/materials/MeasurementArrowMaterial.js";class d extends n{constructor(e){super(e),this._parameters=c,this._handles=null,this._origin=a(),this._originTransform=s(),this._arrowCenter=a(),this._renderOccluded=4,this._geometry=null,this._stripeLength=1,this._stripesEnabled=!0,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._arrowMaterial&&this._arrowMaterial.setParameterValues({renderOccluded:e}))}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.geometryChanged()}get stripeLength(){return this._stripeLength}set stripeLength(e){this._stripeLength=e,this.attached&&this._arrowMaterial.setParameterValues({stripeLength:this._stripeLength})}get stripesEnabled(){return this._stripesEnabled}set stripesEnabled(e){if(this._stripesEnabled=e,this.attached){const e=this._stripesEnabled?this._parameters.arrowStripeEvenColor:this._parameters.arrowStripeOddColor;this._arrowMaterial.setParameterValues({stripeEvenColor:e})}}createExternalResources(){const r=this._stripesEnabled?this._parameters.arrowStripeEvenColor:this._parameters.arrowStripeOddColor;this._arrowMaterial=new l({outlineColor:this._parameters.arrowOutlineColor,stripeEvenColor:r,stripeOddColor:this._parameters.arrowStripeOddColor,renderOccluded:this.renderOccluded,polygonOffset:!0}),this._handles=new e,this._handles.add(this.view.state.watch("camera",(()=>{this.viewChanged()})))}destroyExternalResources(){this._arrowMaterial=null,this._handles.destroy(),this._handles=null}forEachExternalMaterial(e){e(this._arrowMaterial)}createGeometries(e){if(r(this._geometry)||r(this._geometry.startRenderSpace)||r(this._geometry.endRenderSpace))return;const t=this._createArrowGeometry(this._geometry.startRenderSpace,this._geometry.endRenderSpace,this._origin,this._geometry);e.addGeometry(t,this._arrowMaterial,this._originTransform),this.viewChanged()}_createArrowGeometry(e,r,t,s){const a=this.view.renderCoordsHelper,n=[],l=[],d=(e,r)=>{const s=o.get();i(s,e,t),n.push(s),l.push(r)};if("euclidean"===s.type){s.eval(.5,this._arrowCenter);const t=o.get();a.worldUpAtPosition(this._arrowCenter,t),d(e,t),d(r,t)}else{s.eval(.5,this._arrowCenter);const e=this._parameters.arrowSubdivisions+1&-2;for(let r=0;r<e;++r){const t=r/(e-1),i=o.get(),n=o.get();s.eval(t,i),a.worldUpAtPosition(i,n),d(i,n)}}return h.createPolylineGeometry(n,l)}geometryChanged(){this.recreateGeometry()}viewChanged(){if(this.view.ready&&this.attached&&t(this._geometry)){const e=this.view.state.camera.computeScreenPixelSizeAt(this._arrowCenter);this._arrowMaterial.setParameterValues({width:this._parameters.arrowWidth*e})}}}const c={arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],arrowStripeLength:16,arrowSubdivisions:128};export{d as MeasurementArrowVisualElement};
