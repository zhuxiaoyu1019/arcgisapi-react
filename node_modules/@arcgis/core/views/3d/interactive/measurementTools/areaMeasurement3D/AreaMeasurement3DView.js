/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../../../../../core/Handles.js";import{isSome as t,isNone as i,unwrap as s}from"../../../../../core/maybe.js";import{screenPointObjectToArray as a}from"../../../../../core/screenUtils.js";import{c as r}from"../../../../../chunks/vec3f64.js";import{createSphereManipulator as n}from"../../manipulatorUtils.js";import{screenToMap3D as l}from"../../editingTools/dragEventPipeline3D.js";import{copyParameter as o,pointToPointScreenDistance as h,resizeArray as d}from"../support/viewUtils.js";import{LaserlineVisualElement as u}from"../../visualElements/LaserlineVisualElement.js";import _ from"../../../webgl-engine/lib/GeometryUtil.js";import{Intersector as c}from"../../../webgl-engine/lib/Intersector.js";import{ManipulatorCollection as p}from"../../../../interactive/ManipulatorCollection.js";const m={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:1,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,handleRadiusHovered:10,handleRadiusMouse:10,handleRadiusTouch:25,pathLineColor:[1,.5,0,1],pathLineWidth:3,intersectingLineColor:[1,.2,0,1],perimeterLineColor:[1,.5,0,1],perimeterLineWidth:2,projectionLineColor:[1,.5,0,1],projectionLineWidth:2,projectionLineStippleSize:5,areaColor1:[1,.5,0,.5],areaColor2:[1,1,1,.5],fillColor:[1,.5,0,.5],lineSubdivisions:64,labelDistance:25};class w{constructor(e){var t,i,s,a;this.vertexManipulators=[],this._layerView=null,this._analysisView=null,this._state="pending",this._mode="auto",this._cursorPoint=null,this._lastDraggedVertex=null,this._visible=!1,this._laserLine=null,this._cursorManipulator=null,this._listenerHandles=null,this._tempHandlePosition=r(),this._model=e.model,this._unit=null!=(t=e.unit)?t:"metric",this._manipulators=null!=(i=e.manipulators)?i:new p,this._view=this._model.sceneView,this._mode=null!=(s=e.mode)?s:"auto",this._cursorPoint=null!=(a=e.cursorPoint)?a:null,this._style=o(m,e.style),this._intersector=new c(this._view.state.viewingMode),this._intersector.options.store=0;const n=this._model.analysis;this._creationPromise=this._view.whenLayerView(n).then((e=>this._initialize(e)))}_initialize(e){switch(this._state){case"pending":break;case"destroyed":return}this._layerView=e,this._analysisView=e.analysisView,this._layerViewData=e.layerViewData;const t=n(this._view,this._style.handleColor,this._style.handleOpacity);t.available=!1,t.radius=this._style.handleRadius,t.interactive=!1,this._manipulators.add(t),this._cursorManipulator=t,this._laserLine=new u({view:this._view,attached:!0,style:{glowColor:this._style.laserLineGlowColor,glowWidth:this._style.laserLineGlowWidth,glowFalloff:this._style.laserLineGlowFalloff,innerColor:this._style.laserLineInnerColor,innerWidth:this._style.laserLineInnerWidth,globalAlpha:this._style.laserLineGlobalAlpha}}),this._analysisView.mode=this._mode,this._layerView.unit=this._unit,this._layerViewData.cursorPoint=this._cursorPoint,this._visible&&this._updateVisibility(this._visible),this._state="ready"}destroy(){switch(this._state){case"pending":return void(this._state="destroyed");case"ready":break;case"destroyed":default:return}this.hide(),this._laserLine.destroy(),this._laserLine=null,this._state="destroyed"}when(){return this._creationPromise}async whenMessages(){return this._creationPromise.then((()=>this.analysisView.whenMessages()))}get state(){return this._state}get analysisView(){return this._analysisView}get layerView(){return this._layerView}get validMeasurement(){return"ready"===this.state&&this._layerViewData.validMeasurement}get path(){return"ready"!==this.state?null:this._layerViewData.path}set unit(e){this._unit=e,"ready"===this.state&&(this.layerView.unit=e)}get requiresCursorPoint(){return("initial"===this._model.state||"drawing"===this._model.state)&&this._model.active}get visible(){return this._visible}set visible(e){e?this.show():this.hide()}get mode(){return this._mode}set mode(e){switch(this._state){case"pending":this._mode=e;break;case"ready":this._mode=e,this._analysisView.mode=e}}get cursorPoint(){return this._cursorPoint}set cursorPoint(e){switch(this._state){case"pending":this._cursorPoint=e;break;case"ready":this._cursorPoint=e,this._layerViewData.cursorPoint=e}}get lastDraggedVertex(){return this._lastDraggedVertex}set lastDraggedVertex(e){switch(this._state){case"pending":this._lastDraggedVertex=e;break;case"ready":this._lastDraggedVertex=e,this._layerViewData.lastDraggedVertex=e}}get testData(){const e=this._laserLine.testData;return{labels:this._analysisView.testData.labels,laserLineRenderer:t(e)?{heightManifoldEnabled:e.heightManifoldEnabled,heightManifoldTarget:e.heightManifoldTarget,pointDistanceEnabled:e.pointDistanceEnabled,pointDistanceOrigin:e.pointDistanceOrigin,pointDistanceTarget:e.pointDistanceTarget,lineVerticalPlaneEnabled:e.lineVerticalPlaneEnabled}:{heightManifoldEnabled:!1,heightManifoldTarget:null,pointDistanceEnabled:!1,pointDistanceOrigin:null,pointDistanceTarget:null,lineVerticalPlaneEnabled:!1}}}show(){this._setVisiblity(!0)}hide(){this._setVisiblity(!1)}_setVisiblity(e){switch(this._state){case"ready":this._visible!==e&&this._updateVisibility(e);break;case"pending":this._visible=e;break;case"destroyed":default:return}}_updateVisibility(e){e?(this._visible=!0,this._model.analysis.visible=!0,this._laserLine.visible=!0,this._initializeListeners(),this._updateAll(this._analysisView.viewData)):(this._visible=!1,this._model.analysis.visible=!1,this._laserLine.visible=!1,this._destroyListeners(),this.vertexManipulators.forEach((e=>{this._removeVertexManipulator(e.manipulator)})),this.vertexManipulators=[],this._view.cursor=null)}vertexHandleAt(e,i){const s=this._manipulators.intersect(e,i);return t(s)?s.manipulator.metadata:null}manipulatorToVertex(e){return e.metadata}pick(e){const t=this._view.spatialReference,s=a(e.screenPoint);this._view.sceneIntersectionHelper.intersectToolIntersectorScreen(s,this._intersector);const n=this._intersector.results.min,l=r();if(!n.getIntersectionPoint(l))return new w.PickResult;const o=this._view.renderCoordsHelper.fromRenderCoords(l,t);if(i(o))return new w.PickResult;const h="TerrainRenderer"===n.intersector?"surface":"feature";return new w.PickResult(h,l,o)}overlappingHandles(e,t){return h(e,t,this._view)<=this._style.handleRadius}screenToMap3D(){return l(this._view)}finishMeasurement(){switch(this._state){case"pending":return;case"ready":{const e=this._layerViewData.path;return void(e.numVertices<3?(e.clear(),this.cursorPoint=null,this._model.state="initial"):(e.close(),this.cursorPoint=null,this._model.state="measured"))}}}_updateAll(e){this._visible&&(this._updateVertexManipulators(e),this._updateLaserLine())}_createVertexManipulator(){const e=n(this._view,this._style.handleColor,this._style.handleOpacity);e.radius=this._style.handleRadius;return{id:this._manipulators.add(e),manipulator:e}}_removeVertexManipulator(e){this._manipulators.remove(e)}_updateVertexManipulators(e){const i=this._layerViewData.path.vertices,s=this.vertexManipulators;d(s,i.length,(()=>this._createVertexManipulator()),(e=>this._removeVertexManipulator(e.manipulator))),s.forEach(((t,s)=>{t.manipulator.metadata=i[s],t.manipulator.renderLocation=e.positionsRenderCoords[s]})),"drawing"===this._model.state&&t(this.cursorPoint)?(this._cursorManipulator.available=!0,this._cursorManipulator.location=this.cursorPoint):this._cursorManipulator.available=!1}_getFocusPoint(){const e=this._model,i=this.lastDraggedVertex;switch(e.state){case"drawing":return t(this.cursorPoint)?this.cursorPoint:t(i)?this._layerViewData.path.getVertexPositionAsPoint(i):s(this._layerViewData.path.lastPoint);case"editing":return t(i)?this._layerViewData.path.getVertexPositionAsPoint(i):null;default:return this.cursorPoint}}_updateLaserLine(){const e=this._model,i=this._style.laserLineEnabled&&"measured"!==e.state&&e.active,s=this._getFocusPoint();if(i&&t(s)){const e=this._tempHandlePosition;this._view.renderCoordsHelper.toRenderCoords(s,e),this._laserLine.heightManifoldTarget=e}else this._laserLine.heightManifoldTarget=null}_initializeListeners(){this._listenerHandles=new e,this._listenerHandles.add([this._model.watch("state",(()=>this._updateLaserLine())),this._analysisView.watch("viewData",(()=>this._updateAll(this._analysisView.viewData)),!0),this._layerViewData.watch(["lastDraggedVertex","cursorPoint"],(()=>this._updateLaserLine())),this._model.watch(["active"],(()=>this._updateAll(this._analysisView.viewData)))])}_destroyListeners(){this._listenerHandles.destroy(),this._listenerHandles=null}}w._handleGeometry=_.createSphereGeometry(1,32,32),function(e){class t{}e.PickRequest=t;class i{constructor(e=null,t=null,i=null){this.type=e,this.scenePoint=t,this.mapPoint=i}}e.PickResult=i}(w||(w={}));var y=w;export default y;
