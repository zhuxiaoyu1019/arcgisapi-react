/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import t from"../../../../../core/Handles.js";import{isNone as e,unwrap as i}from"../../../../../core/maybe.js";import{clonePoint as s}from"../../../../../layers/graphics/hydratedFeatures.js";import{hideManipulatorWhileDragging as o}from"../../editingTools/dragEventPipeline3D.js";import a from"./AreaMeasurement3DView.js";import{createManipulatorDragEventPipeline as n}from"../../../../interactive/dragEventPipeline.js";import{createScreenPointFromEvent as r}from"../../../../support/screenUtils.js";class h{constructor(e,i,s){this._manipulators=s,this._handles=new t,this._tempPickRequest=new a.PickRequest,this.model=e,this.view=i,this._setupManipulators()}destroy(){this._handles.destroy(),this._handles=null}handleInputEvent(t){switch(t.type){case"immediate-double-click":this._handleImmediateDoubleClick(t);break;case"immediate-click":this._handleImmediateClick(t);break;case"pointer-move":this._handlePointerMove(t);break;case"drag":this._handleDrag(t);break;case"key-down":this._handleKeyDown(t)}}_setupManipulators(){const t=t=>`manipulator-${t}`;let e=0;const a=t=>s=>("start"===s.action&&(e++,this.view.lastDraggedVertex=i(this.view.manipulatorToVertex(t)),"measured"===this.model.state&&(this.model.state="editing")),s),r=()=>t=>"end"===t.action?(e--,0===e&&"editing"===this.model.state&&(this.model.state="measured"),null):t,h=(e,h)=>{this._handles.add([n(h,((t,e,n)=>{const h=o(t),d=i(this.view.manipulatorToVertex(t));e.next(a(t)).next(h).next(r()).next(this.view.screenToMap3D()).next((e=>{t.location=e.mapEnd,this.view.path.setVertexPosition(d,s(e.mapEnd))}));const l=s(this.view.path.getVertexPositionAsPoint(d));n.next(h).next((()=>{this.view.path.setVertexPosition(d,l),t.location=l}))}))],t(e))},d=e=>{this._handles.remove(t(e))};this._manipulators.forEach((({id:t,manipulator:e})=>{h(t,e)})),this._handles.add([this._manipulators.on("after-add",(({item:{id:t,manipulator:e}})=>{h(t,e)})),this._manipulators.on("after-remove",(({item:{id:t}})=>{d(t)}))])}_handleImmediateDoubleClick(t){d(t)&&("drawing"===this.model.state&&this.view.finishMeasurement(),t.stopPropagation())}_handleDrag(t){"editing"===this.model.state&&t.stopPropagation()}_handleImmediateClick(t){if(!d(t))return;const i=r(t);if(this.model.active)switch(this.model.state){case"initial":if(this._addVertexAt(i))return this.view.cursorPoint=null,this.model.state="drawing",void t.stopPropagation();break;case"drawing":{const s=this.view.vertexHandleAt(i,t.pointerType);if(e(s)){if(this._addVertexAt(i))return this.view.cursorPoint=null,void t.stopPropagation()}else 0===s.index&&(this.view.finishMeasurement(),t.stopPropagation());break}}"mouse"===t.pointerType&&this._hoverAt(i)}_handlePointerMove(t){if("mouse"===t.pointerType){const e=r(t);this._hoverAt(e)}}_handleKeyDown(t){"Enter"===t.key&&"drawing"===this.model.state&&(this.view.finishMeasurement(),t.stopPropagation())}_hoverAt(t){if(this.view.requiresCursorPoint){const e=this._pick(t);e.mapPoint&&(this.view.cursorPoint=e.mapPoint)}else this.view.cursorPoint=null}_addVertexAt(t){const e=this._pick(t);return!!e.mapPoint&&(this.view.path.add(e.mapPoint),!0)}_pick(t){const e=this._tempPickRequest;return e.screenPoint=t,this.view.pick(e)}}function d(t){return"mouse"!==t.pointerType||0===t.button}export default h;
