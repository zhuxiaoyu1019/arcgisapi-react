/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import t from"../../../../../Color.js";import i from"../../../../../core/Collection.js";import r from"../../../../../core/Handles.js";import{handlesGroup as n,makeHandle as a}from"../../../../../core/handleUtils.js";import{applySome as o,destroyMaybe as s,isSome as l,mapOr as h,isNone as c,removeMaybe as u,abortMaybe as p,none as _}from"../../../../../core/maybe.js";import{createTask as d,ignoreAbortErrors as g}from"../../../../../core/promiseUtils.js";import{property as m}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/has.js";import"../../../../../core/accessorSupport/ensureType.js";import"../../../../../core/Logger.js";import{subclass as v}from"../../../../../core/accessorSupport/decorators/subclass.js";import{reactionInit as y,reaction as T}from"../../../../../core/accessorSupport/trackingUtils.js";import{g as b,f as O,n as f,a as C,b as L}from"../../../../../chunks/vec3.js";import{c as S}from"../../../../../chunks/vec3f64.js";import w from"../../../../../geometry/Point.js";import{fromPoints as M,create as E}from"../../../../../geometry/support/lineSegment.js";import{LineOfSightRayIntersector as I}from"./LineOfSightRayIntersector.js";import{LineOfSightToolConfiguration as P}from"./LineOfSightToolConfiguration.js";import{createSphereManipulator as V,createSphereManipulatorRenderObjects as k}from"./lineOfSightToolUtils.js";import{LineOfSightAnalysis as A}from"../../graphics/LineOfSight/LineOfSightAnalysis.js";import{LineOfSightController as H}from"../../graphics/LineOfSight/LineOfSightController.js";import{LineOfSightView as j}from"../../graphics/LineOfSight/LineOfSightView.js";import{LaserlineVisualElement as D}from"../../visualElements/LaserlineVisualElement.js";import{createManipulatorDragEventPipeline as R}from"../../../../interactive/dragEventPipeline.js";import{InteractiveToolBase as F}from"../../../../interactive/InteractiveToolBase.js";import{ImmediateTask as N,TaskPriority as x}from"../../../../support/Scheduler.js";import G from"../../../../../widgets/LineOfSight/LineOfSightTarget.js";const z=i.ofType(G);let U=class extends F{constructor(e){super(e),this._showTracker=!0,this._someManipulatorsFocused=!1,this._tasks=N,this._laserlineVisualElement=null,this._grabbedManipulator=null,this._handles=new r,this._manipulatorHandles=new r,this._analysisHandles=new r,this.lineOfSightView=new j({model:e.model,view:e.view}),this.lineOfSightController=new H({model:e.model,view:e.view})}initialize(){var e;const t=y((()=>this.state),(e=>{switch(e){case"created":this.complete();break;default:this.finishToolCreation()}}));this._intersector=new I({view:this.view});const i=this._handles,r=null==(e=this.view.resourceController)?void 0:e.scheduler;r&&(this._tasks=r.registerTask(x.LINE_OF_SIGHT_TOOL)),this._observerManipulator=this._createObserverManipulator(),i.add([t,T((()=>({...this.configuration.observer})),(()=>this._updateObserverManipulatorStyle())),this._createLineOfSightTracker(),y((()=>this.model.observer),(e=>this._onObserverChange(e))),y((()=>({...this.configuration.laserLine})),(()=>this._createVisualElements())),this._connectAnalyses()]),o(this.view.pointsOfInterest,(e=>i.add(this._connectObserverToContentChange(e)))),this.continue()}destroy(){this.detach(),this.manipulators.remove(this._observerManipulator),this.lineOfSightView.destroy(),this.lineOfSightController.destroy(),this._handles=s(this._handles),this._analysisHandles=s(this._analysisHandles),this._manipulatorHandles=s(this._manipulatorHandles),this._removeVisualElements(),this._intersector=null,this._set("model",null)}get state(){return this._showTracker?"creating":l(this.model.observer)?"created":"ready"}get cursor(){return this._someManipulatorsFocused?null:this._showTracker?"crosshair":null}get isSupported(){var e;return"3d"===(null==(e=this.view)?void 0:e.type)}get updating(){return h(this._tasks,!1,(e=>e.updating))||h(this.lineOfSightController,!1,(e=>e.updating))}get configuration(){return this._viewData.configuration}set configuration(e){this._viewData.configuration=e}get _viewData(){return this.model.viewData}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._observerEngineLocation)}get _analyses(){return this._viewData.analyses}get _observerEngineLocation(){return this._viewData.observerEngineLocation}set _observerEngineLocation(e){this._viewData.observerEngineLocation=e}get _shouldRenderTracker(){return this._showTracker&&l(this.model.observer)&&!this._someManipulatorsFocused}get _isCameraDirty(){const e=this.model.observer,{view:t}=this,{renderCoordsHelper:i}=t;if(c(e)||c(i))return!1;const r=W;i.toRenderCoords(e,r);const n=t.state.camera.computeScreenPixelSizeAt(r);return Math.abs((n-this._screenPixelSize)/this._screenPixelSize)>.1}continue(){this.view.activeTool=this,this._showTracker=!0,this._manipulatorFocusChanged()}stop(){this._showTracker=!1,this._setPriority(x.LINE_OF_SIGHT_TOOL_INTERACTIVE),this._manipulatorFocusChanged()}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"key-down":this._keyDownHandler(e);break;case"pointer-move":this._pointerMoveHandler(e)}}onInputEventAfter(e){switch(e.type){case"immediate-click":this._clickHandler(e)}}onShow(){this.model.visible=!0}onHide(){this.model.visible=!1}_setPriority(e){this._tasks.priority=e,this.lineOfSightController.priority=e}_createLineOfSightTracker(){const e=new G({location:new w}),t=new A({target:e}),i=this._createTargetManipulator(t);i.available=!1,i.interactive=!1;const r=this.lineOfSightView.createLineOfSightVisualization(),o={analysis:t,interpolationInfo:{originalIntersection:S(),originalObserver:S(),originalTarget:S()}};let s=null;const l=y((()=>this._shouldRenderTracker),(e=>{s=u(s),r.visibleLineVisualElement.attached=e,r.occludedLineVisualElement.attached=e,r.undefinedLineVisualElement.attached=e,e&&(s=n([T((()=>({...this.configuration.target})),(()=>this._updateTargetManipularStyle(i))),y((()=>this._observerEngineLocation),(e=>this._onObserverEngineLocationChange(i,e))),y((()=>this.lineOfSightController.getLineOfSightComputationDependencies(t)),(()=>this.lineOfSightController.computeAnalysis(o,!0))),y((()=>this.lineOfSightView.getLineOfSightVisualizationDependencies(t)),(()=>this.lineOfSightView.updateLineOfSightVisualization(t,r))),y((()=>this._getLineOfSightManipulatorStateDependencies(t)),(()=>this._updateManipulatorState(i))),T((()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty})),(({isDirty:e})=>this._onCameraChange(i,e))),T((()=>h(this.view.map,1,(e=>e.ground.opacity))),((e,t)=>this._onGroundOpacityChange(i,e,t))),y((()=>this.view.slicePlane),(()=>this._onSlicePlaneChange(i))),T((()=>t.target.location),(e=>this._onTargetLocationChange(i,e)))]))}));return this._trackerManipulator=i,a((()=>{l.remove(),s=u(s),this.lineOfSightView.destroyLineOfSightVisualization(r),this._removeManipulator(i)}))}_removeManipulator(e){this.manipulators.remove(e),this._manipulatorHandles.remove(e),e.metadata=null}_createManipulator(e,t,i){const r=V(this.view,e);return r.metadata=i,this._manipulatorHandles.add([t(r),r.events.on("focus-changed",(()=>this._manipulatorFocusChanged())),r.events.on("grab-changed",(e=>this._manipulatorGrabChanged(r,e))),r.events.on("immediate-click",(e=>e.stopPropagation()))],r),this.manipulators.add(r),this._setPriority(x.LINE_OF_SIGHT_TOOL_INTERACTIVE),r}_createTargetManipulator(e,t,i){const r=this.configuration,n={size:r.target.size,customColor1:r.target.visibleColor,customColor2:r.target.occludedColor,customColor3:r.target.undefinedColor},a=this._createManipulator(n,(e=>this._createTargetManipulatorDragPipeline(e)),{analysis:e,intersection:i});return this._setTargetManipulatorLocation(a,t),a}_createObserverManipulator(){const e=this.configuration,t={size:e.observer.size,color:e.observer.color,visible:!0};return this._createManipulator(t,(e=>this._createObserverManipulatorDragPipeline(e)),null)}_updateTargetManipularStyle(e){const t=this.configuration.target,i={size:t.size,customColor1:t.visibleColor,customColor2:t.occludedColor,customColor3:t.undefinedColor};e.renderObjects=k(i)}_updateObserverManipulatorStyle(){const e=this._observerManipulator,t=this.configuration.observer,i={size:t.size,color:t.color,visible:e.available};e.renderObjects=k(i)}_manipulatorFocusChanged(){this._someManipulatorsFocused=this.manipulators.some((e=>e.manipulator.focused)),this._updateLaserLineRenderer()}_screenToIntersection(){return e=>{const t=this._intersector.getScreenPointIntersection(e.screenEnd);return c(t)?null:{...e,intersection:t}}}_createTargetManipulatorDragPipeline(e){return R(e,((t,i,r)=>{i.next(this._screenToIntersection()).next(this._updateAnalysisDragStep(e)).next((()=>this._updateLaserLineRenderer())),r.next(this._cancelAnalysisDragStep(e)).next((()=>this._updateLaserLineRenderer()))}))}_createObserverManipulatorDragPipeline(e){return R(e,((e,t,i)=>{t.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next((()=>this._updateLaserLineRenderer())),i.next(this._cancelObserverDragStep()).next((()=>this._updateLaserLineRenderer()))}))}_updateObserverDragStep(){return e=>(this.model.observer=e.intersection.point,this._observerManipulator.metadata=e.intersection,e)}_cancelObserverDragStep(){const e=l(this.model.observer)?this.model.observer.clone():null,t=this._observerManipulator.metadata;return i=>(this.model.observer=e,this._observerManipulator.metadata=t,i)}_updateAnalysisDragStep(e){return t=>(e.metadata.analysis.target.location=t.intersection.point,e.metadata.intersection=t.intersection,t)}_cancelAnalysisDragStep(e){const{metadata:t}=e,{analysis:i,intersection:r}=t,n=h(i.target.location,null,(e=>e.clone())),a=r;return t=>(i.target.location=n,e.metadata.intersection=a,t)}_manipulatorGrabChanged(e,t){switch(t.action){case"start":this._grabbedManipulator=e;break;case"end":this._grabbedManipulator===e&&(this._grabbedManipulator=null)}this._manipulatorFocusChanged()}_updateManipulatorState(e){const t=e.metadata.analysis,{isValid:i,isTargetVisible:r}=t.computationResult;e.state=i?r?16:32:64}_getLineOfSightManipulatorStateDependencies(e){const{isValid:t,isTargetVisible:i}=e.computationResult;return{isValid:t,isTargetVisible:i}}_setTargetManipulatorLocation(e,t){c(t)||(e.location=t,this._onTargetManipulatorLocationChange(e))}_updateLaserLineRenderer(){if(c(this._laserlineVisualElement))return;const e=this._laserlineVisualElement,t=l(this._grabbedManipulator)?this._grabbedManipulator:this._shouldRenderTracker&&this.model.observer?this._trackerManipulator:null;this.configuration.laserLine.enabled&&l(t)?(e.heightManifoldTarget=t.renderLocation,t!==this._observerManipulator?e.lineVerticalPlaneSegment=M(this._observerManipulator.renderLocation,t.renderLocation,B):e.lineVerticalPlaneSegment=null):(e.heightManifoldTarget=null,e.lineVerticalPlaneSegment=null)}_createVisualElements(){const e=this.configuration.laserLine;this._removeVisualElements(),this._laserlineVisualElement=new D({view:this.view,attached:!0,style:{glowColor:t.toUnitRGB(e.glowColor),glowWidth:e.glowWidth,innerColor:t.toUnitRGB(e.innerColor),innerWidth:e.innerWidth,globalAlpha:e.globalAlpha}}),this._setPriority(x.LINE_OF_SIGHT_TOOL_INTERACTIVE)}_removeVisualElements(){l(this._laserlineVisualElement)&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}_onObserverChange(e){c(e)?this._observerManipulator.available=!1:(this._observerManipulator.metadata=null,this._observerManipulator.available=!0,this._observerManipulator.location=e,this._setTargetManipulatorLocation(this._trackerManipulator,e),this._setPriority(x.LINE_OF_SIGHT_TOOL_INTERACTIVE))}_onTargetLocationChange(e,t){e.metadata.intersection=null,this._setTargetManipulatorLocation(e,t),this._setPriority(x.LINE_OF_SIGHT_TOOL_INTERACTIVE)}_onGroundOpacityChange(e,t,i){1!==t&&1!==i||t===i||(this._onTargetManipulatorLocationChange(e),this._setPriority(x.LINE_OF_SIGHT_TOOL_INTERACTIVE))}_onCameraChange(e,t){const{analysis:i}=e.metadata;i.inputPoints.isValid&&!t||(this._onTargetManipulatorLocationChange(e),this._setPriority(x.LINE_OF_SIGHT_TOOL_INTERACTIVE))}_onSlicePlaneChange(e){this._onTargetManipulatorLocationChange(e),this._setPriority(x.LINE_OF_SIGHT_TOOL_INTERACTIVE)}_onObserverEngineLocationChange(e,t){const{analysis:i}=e.metadata,{inputPoints:r}=i,{observer:n}=r;b(n,t),this._adjustInputPoints(r,this._observerManipulator.metadata,e.metadata.intersection),i.updateInputPoints()}_onTargetManipulatorLocationChange(e){const t=this.view.renderCoordsHelper;if(c(t))return;const{metadata:i}=e,{analysis:r,intersection:n}=i,{inputPoints:a}=r,{target:o}=a;t.toRenderCoords(e.location,o),this._adjustInputPoints(a,this._observerManipulator.metadata,n),r.updateInputPoints()}_onAnalysesCollectionChange(e){e.added.forEach((e=>this._connectAnalysis(e))),e.removed.forEach((e=>this._disconnectAnalysis(e)))}_addPointFromClickEvent(e){const t=this._intersector.getScreenPointIntersection(e);if(!c(t)&&!c(t.point))if(this.model.observer){const e=new G({location:t.point}),i=new A({target:e});this._connectAnalysis(i,t),this._analyses.add(i),this.model.targets.add(e)}else this.model.observer=t.point,this._observerManipulator.metadata=t}_clickHandler(e){this._showTracker&&(this._addPointFromClickEvent({x:e.x,y:e.y}),e.stopPropagation())}_doubleClickHandler(e){this._showTracker&&(this.stop(),e.stopPropagation())}_keyDownHandler(e){this._showTracker&&"Escape"===e.key&&(this.stop(),e.stopPropagation())}_pointerMoveHandler(e){if(!this._showTracker)return;const t={x:e.x,y:e.y},i=this._intersector.getScreenPointIntersection(t);l(i)&&(this._setTargetManipulatorLocation(this._trackerManipulator,i.point),this._updateLaserLineRenderer(),this._setPriority(x.LINE_OF_SIGHT_TOOL_INTERACTIVE))}_refineObserverManipulatorPosition(){const e=this._observerManipulator,t=e.metadata;if(this._analyses.length<1||c(t))return;const i=this._intersector.updateFromIntersectionResult(t);if(c(i))return;e.location=i;const r=S();this.view.renderCoordsHelper.toRenderCoords(e.location,r),this._observerEngineLocation=r}_refineTargetManipulatorPosition(e){const{intersection:t}=e.metadata;if(c(t))return;const i=this._intersector.updateFromIntersectionResult(t);this._setTargetManipulatorLocation(e,i)}_adjustInputPoints(e,t,i){const r=W,{observer:n,target:a,observerAdjusted:o,targetAdjusted:s}=e;l(t)?b(r,t.normal):O(r,a,n);const h=this._screenPixelSize;f(r,r),C(r,r,Math.min(h,1)),L(o,n,r),l(i)?b(r,i.normal):O(r,n,a);const c=this.view.state.camera.computeScreenPixelSizeAt(a);f(r,r),C(r,r,Math.min(c,1)),L(s,a,r)}_connectAnalyses(){let e=null;return n([y((()=>this._analyses),(t=>{e=u(e),e=t.on("change",(e=>this._onAnalysesCollectionChange(e))),this._onAnalysesCollectionChange({target:t,added:t.items,removed:[],moved:[]})})),a((()=>e=u(e)))])}_connectAnalysis(e,t){const i=this._analysisHandles;if(i.has(e))return;const{target:r}=e,n=this._createTargetManipulator(e,r.location,t),s=[y((()=>this._getLineOfSightManipulatorStateDependencies(e)),(()=>this._updateManipulatorState(n))),y((()=>this._observerEngineLocation),(e=>this._onObserverEngineLocationChange(n,e))),T((()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty})),(({isDirty:e})=>this._onCameraChange(n,e))),T((()=>h(this.view.map,1,(e=>e.ground.opacity))),((e,t)=>this._onGroundOpacityChange(n,e,t))),y((()=>this.view.slicePlane),(()=>this._onSlicePlaneChange(n))),T((()=>e.target.location),(e=>this._onTargetLocationChange(n,e))),T((()=>({...this.configuration.target})),(()=>this._updateTargetManipularStyle(n))),a((()=>{this._removeManipulator(n)}))];o(this.view.pointsOfInterest,(e=>s.push(this._connectTargetToContentChange(n,e)))),i.add(s,e),this._setPriority(x.LINE_OF_SIGHT_TOOL_INTERACTIVE)}_disconnectAnalysis(e){this._analysisHandles.remove(e)}_connectObserverToContentChange(e){let t=_;const i=()=>{t=p(t),c(this._observerManipulator.metadata)||(t=d((async e=>{this._setPriority(x.LINE_OF_SIGHT_TOOL_INTERACTIVE),await g(this._tasks.schedule((()=>this._refineObserverManipulatorPosition()),e))})))},r=e.contentGeometryUpdates.events.on("request-update",i),n=this.view.elevationProvider.on("elevation-change",i);return a((()=>{t=p(t),r.remove(),n.remove()}))}_connectTargetToContentChange(e,t){let i=_;const r=()=>{i=p(i),i=d((async t=>{this._setPriority(x.LINE_OF_SIGHT_TOOL_INTERACTIVE),await g(this._tasks.schedule((()=>{this._refineTargetManipulatorPosition(e),this._onTargetManipulatorLocationChange(e)}),t))}))},n=t.contentGeometryUpdates.events.on("request-update",r),o=this.view.elevationProvider.on("elevation-change",r);return a((()=>{i=p(i),n.remove(),o.remove()}))}};e([m({constructOnly:!0})],U.prototype,"view",void 0),e([m({constructOnly:!0})],U.prototype,"model",void 0),e([m({constructOnly:!0})],U.prototype,"lineOfSightView",void 0),e([m({constructOnly:!0})],U.prototype,"lineOfSightController",void 0),e([m({readOnly:!0})],U.prototype,"state",null),e([m({readOnly:!0})],U.prototype,"cursor",null),e([m({readOnly:!0})],U.prototype,"isSupported",null),e([m({readOnly:!0})],U.prototype,"updating",null),e([m({type:P})],U.prototype,"configuration",null),e([m()],U.prototype,"_viewData",null),e([m()],U.prototype,"_screenPixelSize",null),e([m()],U.prototype,"_showTracker",void 0),e([m()],U.prototype,"_analyses",null),e([m()],U.prototype,"_observerEngineLocation",null),e([m()],U.prototype,"_shouldRenderTracker",null),e([m()],U.prototype,"_someManipulatorsFocused",void 0),e([m()],U.prototype,"_isCameraDirty",null),e([m()],U.prototype,"_tasks",void 0),e([m()],U.prototype,"_laserlineVisualElement",void 0),e([m()],U.prototype,"_grabbedManipulator",void 0),U=e([v("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],U);const W=S(),B=E();export{z as LineOfSightTargetCollection,U as LineOfSightTool};
