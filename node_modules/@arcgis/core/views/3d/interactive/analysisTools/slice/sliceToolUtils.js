/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import"../../../../../geometry.js";import{neverReached as e}from"../../../../../core/compilerUtils.js";import t from"../../../../../core/Logger.js";import{rad2deg as s,deg2rad as i}from"../../../../../core/mathUtils.js";import{isSome as r,isNone as o}from"../../../../../core/maybe.js";import{castRenderScreenPointArray3 as n}from"../../../../../core/screenUtils.js";import{r as a,i as c,s as l,m,b as g,t as d,w as u}from"../../../../../chunks/mat4.js";import{c as p}from"../../../../../chunks/mat4f64.js";import{r as f}from"../../../../../chunks/quat.js";import{a as b,g as h,d as w,c as y,n as j,b as M,l as k,f as P,p as v,s as O}from"../../../../../chunks/vec3.js";import{a as T,c as U,f as R}from"../../../../../chunks/vec3f64.js";import{r as S,f as L,a as A,n as E,u as F,i as G}from"../../../../../chunks/boundedPlane.js";import{fromVectorsAndPoint as C,fromPositionAndNormal as I}from"../../../../../geometry/support/plane.js";import{create as x}from"../../../../../geometry/support/ray.js";import{angleAroundAxis as z}from"../../../../../geometry/support/vector.js";import{sv3d as D,sm4d as B,sq4d as V}from"../../../../../geometry/support/vectorStacks.js";import{Manipulator3D as q}from"../../Manipulator3D.js";import{calculateTranslateRotateFromBases as H}from"../../manipulatorUtils.js";import{SMALL_ANGLE_DOT_THRESHOLD as N,RESIZE_HANDLE_EDGE_PADDING_FRAC as W,PLANE_MIN_BASIS_SCREEN_LEN2 as $,INITIAL_PLANE_HALF_SIZE_VIEW_PROPORTION as J,SHIFT_RESTART_OFFSET_DISTANCE as K,SHIFT_RESTART_ARROW_TIP_COLOR as Q,SHIFT_RESTART_ARROW_CAP_COLOR as X,SHIFT_RESTART_TUBE_COLOR as Y,SHIFT_RESTART_OUTLINE_COLOR as Z,SHIFT_RESTART_CALLOUT_COLOR as _,SHIFT_RESTART_TIP_RADIUS as ee,ROTATE_HEADING_CALLOUT_COLOR as te,PLANE_OUTLINE_COLOR as se,PLANE_OUTLINE_WIDTH as ie,PLANE_BACKGROUND_COLOR as re,GRID_COLOR as oe,RESIZE_HANDLE_CORNER_INPUT_RADIUS as ne,RESIZE_HANDLE_EDGE_INPUT_RADIUS as ae,ROTATE_HEADING_TIP_LENGTH as ce,VERTICAL_DOT_THRESHOLD as le,SHIFT_RESTART_TUBE_RADIUS as me,SHIFT_RESTART_TIP_LENGTH as ge,SHIFT_RESTART_TUBE_FOCUS_MULTIPLIER as de,SHIFT_RESTART_TIP_FOCUS_MULTIPLIER as ue,SHIFT_RESTART_ARROW_OUTLINE_WIDTH as pe,ROTATE_HEADING_OFFSET_DISTANCE as fe,ROTATE_HEADING_DISC_RADIUS as be,ROTATE_HEADING_DISC_RADIUS_FOCUS_MULTIPLIER as he,HANDLE_COLOR as we,DISPLAY_FOCUS_MULTIPLIER as ye,RESIZE_HANDLE_EDGE_WIDTH as je,SHIFT_RESTART_ARROW_LENGTH as Me,RESIZE_HANDLE_CORNER_WIDTH as ke}from"./sliceToolConfig.js";import{LineVisualElement as Pe}from"../../visualElements/LineVisualElement.js";import{SlicePlaneVisualElement as ve}from"../../visualElements/SlicePlaneVisualElement.js";import{fromRender as Oe}from"../../../support/geometryUtils/ray.js";import{Geometry as Te}from"../../../webgl-engine/lib/Geometry.js";import Ue from"../../../webgl-engine/lib/GeometryUtil.js";import{ColorMaterial as Re}from"../../../webgl-engine/materials/ColorMaterial.js";import{ImageMaterial as Se}from"../../../webgl-engine/materials/ImageMaterial.js";import{NativeLineMaterial as Le}from"../../../webgl-engine/materials/NativeLineMaterial.js";import{RibbonLineMaterial as Ae}from"../../../webgl-engine/materials/RibbonLineMaterial.js";import Ee from"../../../../../widgets/Slice/SlicePlane.js";import Fe from"../../../../../geometry/Point.js";const Ge=t.getLogger("esri.views.3d.interactive.analysisTools.slice.sliceToolUtils");function Ce(e,t,s,i,r,o,n,a){return Ie(t,n.worldUpAtPosition(e,D.get()),r,o,a.basis1,a.basis2),b(a.basis1,a.basis1,s),b(a.basis2,a.basis2,i),h(a.origin,e),C(a.basis2,a.basis1,a.origin,a.plane),a}function Ie(e,t,s,i,r,o){const n=w(e,t),a=D.get(),c=D.get();switch(0===i?Math.abs(n)>le?1:2:i){case 2:{const i=Math.abs(n)<=N?e:s.viewUp;y(a,i,t),h(c,t);break}case 1:y(a,s.viewUp,t),y(c,t,a);break;case 3:{const i=Math.abs(n)<=N?t:s.viewUp;y(a,i,e),y(c,e,a);break}}const l=y(D.get(),a,c);w(l,s.viewForward)>0&&b(c,c,-1),j(r,a),j(o,c)}function xe(e,t,s){const i=t.worldUpAtPosition(e.origin,D.get()),r=e.basis1,o=ct(e,i),n=Math.round(o/ft)*ft;return S(e,n-o,r,s)}function ze(e,t,s,i,r,o){const n=h(D.get(),r.origin);M(n,n,b(D.get(),r.basis1,e.direction[0]<0?1:-1)),M(n,n,b(D.get(),r.basis2,e.direction[1]<0?1:-1));const a=k(r.basis1),c=k(r.basis2),l=P(D.get(),s,n),m=P(D.get(),t,n);let g=0,d=0;if(Ze(e)){const t=Ye(r),s=Ye(o);g=a-.5*e.direction[0]*w(r.basis1,m)/a,d=c-.5*e.direction[1]*w(r.basis2,m)/c;const i=s/t;g*=i,d*=i}const u=g+.5*e.direction[0]*w(r.basis1,l)/a,p=d+.5*e.direction[1]*w(r.basis2,l)/c,f=b(D.get(),r.basis1,u/a),y=b(D.get(),r.basis2,p/c);(u<=0||Qe(o.origin,f,i)<=$)&&h(f,o.basis1),(p<=0||Qe(o.origin,y,i)<=$)&&h(y,o.basis2);const j=h(D.get(),n);return M(j,j,b(D.get(),f,e.direction[0]<0?-1:1)),M(j,j,b(D.get(),y,e.direction[1]<0?-1:1)),L(j,f,y,o)}function De(e,t){return J*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function Be(e,t,s,i){const r=y(D.get(),t,s);return y(r,r,t),I(e,r,i)}function Ve(e,t){return H(e.basis1,e.basis2,e.origin,t)}function qe(e,t,s,i){const r=t.worldUpAtPosition(e.origin,D.get()),o=D.get();switch(s){case 1:h(o,r);break;case 2:h(o,e.basis1)}return I(e.origin,o,i)}function He(e,t,s,i){const r=Ke(s,2),o=B.get();a(o,t,r.edge*Math.PI/2);const c=j(D.get(),r.basis);let l=b(D.get(),c,r.direction*i.computeScreenPixelSizeAt(r.position)*K);M(l,l,r.position);const m=i.projectToRenderScreen(l,n(D.get())),g=Ne(i,m);Oe(i,m,pt),j(pt.direction,pt.direction);const d=D.get();!g&&G(s,pt,d)&&(l=d),o[12]=0,o[13]=0,o[14]=0,e.modelTransform=o,e.renderLocation=T(l),g?e.state|=ut:e.state&=~ut}function Ne(e,t){const[s,i,r,o]=e.viewport,n=Math.min(r,o)/16;let a=!0;return t[0]<s+n?(t[0]=s+n,a=!1):t[0]>s+r-n&&(t[0]=s+r-n,a=!1),t[1]<i+n?(t[1]=i+n,a=!1):t[1]>i+o-n&&(t[1]=i+o-n,a=!1),a}function We(e,t,s,i){const r=k(i.basis1),o=k(i.basis2),n=Xe(i),g=Ye(i),d=O(D.get(),0,0,0);M(d,b(D.get(),i.basis1,t.direction[0]),b(D.get(),i.basis2,t.direction[1])),M(d,i.origin,d);let u=0,p=1;if(Ze(t))1===t.direction[0]&&-1===t.direction[1]?u=ft:1===t.direction[0]&&1===t.direction[1]?u=Math.PI:-1===t.direction[0]&&1===t.direction[1]&&(u=3*Math.PI/2),p=g;else{const e=0!==t.direction[0]?1:2;u=1===e?ft:0,p=(1===e?o:r)-n}const f=c(B.get());a(f,f,u),l(f,f,O(D.get(),p,p,p)),m(f,s,f),f[12]=0,f[13]=0,f[14]=0,e.modelTransform=f,e.renderLocation=d}function $e(e,t,s,i){const r=i.worldUpAtPosition(s.origin,D.get()),o=Ke(s,0),n=c(B.get());a(n,n,o.edge*Math.PI/2),g(n,n,-ct(s,r)),m(n,t,n),n[12]=0,n[13]=0,n[14]=0,e.modelTransform=n,e.renderLocation=o.position}function Je(e,t,s){const i=Ke(s,1),r=c(B.get());a(r,r,i.edge*Math.PI/2),g(r,r,ft),m(r,t,r),r[12]=0,r[13]=0,r[14]=0,e.modelTransform=r,e.renderLocation=i.position}function Ke(e,t){switch(t){case 0:return{basis:e.basis1,direction:1,position:M(D.get(),e.origin,e.basis1),edge:t};case 1:return{basis:e.basis2,direction:1,position:M(D.get(),e.origin,e.basis2),edge:t};case 2:return{basis:e.basis1,direction:-1,position:P(D.get(),e.origin,e.basis1),edge:t};case 3:return{basis:e.basis2,direction:-1,position:P(D.get(),e.origin,e.basis2),edge:t}}}function Qe(e,t,s){const i=s.projectToRenderScreen(M(D.get(),e,t),n(D.get())),r=s.projectToRenderScreen(P(D.get(),e,t),n(D.get()));return v(P(i,i,r))}function Xe(e){const t=k(e.basis1),s=k(e.basis2);return W*Math.min(t,s)}function Ye(e){return Xe(e)}function Ze(e){return 0!==e.direction[0]&&0!==e.direction[1]}function _e(e,t=1){const s=0===t?K:0,i=[R(s,0,-Me/2),R(s,0,Me/2)],r=nt(i,!0),o=(e,t)=>rt(i,i,{tubeRadius:me,tipRadius:ee,tipLength:ge,tubeFocusMultiplier:de,tipFocusMultiplier:ue,padding:e,bothEnds:!0,flat:null,focusTipLength:!0,addCap:t}),n=o(0,!1),a=o(pe,!0),c=new Re({color:Q,cullFace:2,renderOccluded:16}),l=new Re({color:X,cullFace:2,renderOccluded:16}),m=new Re({color:Y,cullFace:2,renderOccluded:16}),g=new Re({color:Z,transparent:!0,writeDepth:!1,cullFace:1,renderOccluded:2}),d=Ue.createPolylineGeometry([[s,0,0],[s-K,0,0]]),u=Ue.createPolylineGeometry([[s,0,0],[s-K,0,0]]),p=new Le({color:_,renderOccluded:4});return new q({view:e,renderObjects:[...n.normal.map((({part:e,geometry:t,transform:s})=>({geometry:t,material:"tip"===e?c:"cap"===e?l:m,transform:s,stateMask:1|dt}))),...a.normal.map((({geometry:e,transform:t})=>({geometry:e,material:g,transform:t,stateMask:1|dt}))),{geometry:d,material:p,stateMask:1|dt|ut},...n.focused.map((({part:e,geometry:t,transform:s})=>({geometry:t,material:"tip"===e?c:"cap"===e?l:m,transform:s,stateMask:2|dt}))),...a.focused.map((({geometry:e,transform:t})=>({geometry:e,material:g,transform:t,stateMask:2|dt}))),{geometry:u,material:p,stateMask:2|dt|ut}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[r]},collisionPriority:1,radius:ee,state:dt})}function et(e,t){const s=new Se({transparent:!0,writeDepth:!1,textureId:t.id,renderOccluded:16}),i=fe,r=be,o=r*he,n=e=>{const t=new Uint32Array([0,1,2,2,3,0]);return new Te([["position",{size:3,data:[i-e,-e,0,i+e,-e,0,i+e,e,0,i-e,e,0],exclusive:!0}],["uv0",{size:2,data:[0,0,1,0,1,1,0,1]}]],[["position",t],["uv0",t]])},a=Ue.createPolylineGeometry([[0,0,0],[i-r,0,0]]),c=Ue.createPolylineGeometry([[0,0,0],[i-o,0,0]]),l=new Le({color:te,renderOccluded:4}),m=[{geometry:n(r),material:s,stateMask:1|dt},{geometry:a,material:l,stateMask:1|dt},{geometry:n(o),material:s,stateMask:2|dt},{geometry:c,material:l,stateMask:2|dt}];return new q({view:e,renderObjects:m,autoScaleRenderObjects:!1,collisionType:{type:"disc",direction:[0,0,1],offset:[i,0,0]},collisionPriority:1,radius:r/2,state:dt})}function tt(e){return new Pe({view:e,attached:!0,color:se,width:ie,writeDepthEnabled:!1,renderOccluded:4,geometry:[[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]]})}function st(e){return new ve({view:e,attached:!0,backgroundColor:[...re],gridColor:oe,gridWidth:4,renderOccluded:4})}function it(e,t){const s=Ze(t),i=s?[R(1,0,0),R(0,0,0),R(0,1,0)]:[R(1,0,0),R(-1,0,0)],r=Ue.createPolylineGeometry(i),o=[...we,1],n=e=>new Ae({color:o,width:e,renderOccluded:4}),a=()=>new Le({color:o,renderOccluded:4}),c=s?ke:je,l=c*ye,m=je,g=e=>e>1?n(e):a(),d=[{geometry:r,material:g(c),stateMask:1|bt},{geometry:r,material:g(l),stateMask:2|bt},{geometry:r,material:g(m),stateMask:ht}],u=new q({view:e,renderObjects:d,collisionType:{type:"line",paths:[i]},autoScaleRenderObjects:!1,worldSized:!0,radius:s?ne:ae,idHint:s?1:2});return u.state=bt,u}function rt(e,t,s){const i=i=>{const o=(i?t:e).slice(0),n=P(D.get(),o[0],o[1]);j(n,n);const a=P(D.get(),o[o.length-1],o[o.length-2]);if(j(a,a),s.padding>0){const e=b(U(),a,-s.padding);if(o[o.length-1]=M(e,e,o[o.length-1]),s.bothEnds){const e=b(U(),n,-s.padding);o[0]=M(e,e,o[0])}}const g=i?s.tipFocusMultiplier:1,h=s.tipLength*(s.focusTipLength?g:1),w=s.tipRadius*g,y=c(B.get());if(s.padding>0){const e=h/4,t=O(D.get(),0,e,0),i=1+s.padding/e;d(y,y,t),l(y,y,O(D.get(),i,i,i)),d(y,y,b(t,t,-1/i))}const k=c(p()),v=R(0,1,0),T=u(p(),f(V.get(),v,a));T[12]=o[o.length-1][0],T[13]=o[o.length-1][1],T[14]=o[o.length-1][2],m(T,T,y);const S=[{part:"tube",geometry:ot(s.tubeRadius*(i?s.tubeFocusMultiplier:1)+s.padding,s.flat,o),transform:k}];let L,A;if(r(s.flat)?L=Ue.createExtrudedTriangle(h,w,w,s.flat.thickness):(L=Ue.createConeGeometry(h,w,24,!1,!1,!0),A=Ue.createConeGeometry(h,w,24,!1,!0,!1)),S.push({part:"tip",geometry:L,transform:T}),A&&S.push({part:"cap",geometry:A,transform:T}),s.bothEnds){const e=u(p(),f(V.get(),v,n));e[12]=o[0][0],e[13]=o[0][1],e[14]=o[0][2],m(e,e,y),S.push({part:"tip",geometry:L,transform:e}),A&&S.push({part:"cap",geometry:A,transform:e})}return S};return{normal:i(!1),focused:i(!0)}}function ot(e,t,s){const i=[];if(r(t))i.push([e,t.thickness/2],[-e,t.thickness/2],[-e,-t.thickness/2],[e,-t.thickness/2]);else{const t=12;for(let s=0;s<t;s++){const r=s/t*2*Math.PI;i.push([Math.cos(r)*e,Math.sin(r)*e])}}return Ue.createPathExtrusionGeometry(i,s,[],[],!1)}function nt(e,t){const s=P(U(),e[e.length-1],e[e.length-2]);if(j(s,s),b(s,s,ce),M(s,s,e[e.length-1]),t){const t=P(U(),e[0],e[1]);return j(t,t),b(t,t,ce),M(t,t,e[0]),[t,...e,s]}return[...e,s]}function at(e,t,i,n=new Ee){if(o(e))return null;const a=r(n.position)?n.position:new Fe;t.fromRenderCoords(e.origin,a,i),n.position=a;const c=t.worldUpAtPosition(e.origin,D.get()),l=t.worldBasisAtPosition(e.origin,1,D.get());return n.width=2*k(e.basis1),n.height=2*k(e.basis2),n.tilt=s(ct(e,c)),n.heading=s(lt(e,c,l)),n}function ct(e,t){return z(t,e.basis2,e.basis1)+ft}function lt(e,t,s){return z(e.basis1,s,t)-ft}function mt(e,t,s=A()){return o(e)||o(e.position)?null:t.toRenderCoords(e.position,s.origin)?(t.worldBasisAtPosition(s.origin,0,s.basis1),t.worldBasisAtPosition(s.origin,1,s.basis2),C(s.basis2,s.basis1,s.origin,s.plane),S(s,-i(e.heading),E(s),s),S(s,i(e.tilt),s.basis1,s),b(s.basis1,s.basis1,e.width/2),b(s.basis2,s.basis2,e.height/2),F(s),s):(Ge.error(`Failed to project slice plane position, projection from ${e.position.spatialReference.wkid} is not supported`),null)}function gt(t){switch(t.type){case"building-scene":case"csv":case"direct-line-measurement":case"area-measurement":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"kml":case"line-of-sight":case"map-notes":case"ogc-feature":case"point-cloud":case"route":case"slice":case"scene":case"stream":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"open-street-map":case"tile":case"vector-tile":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return e(t.type),!1}}const dt=16,ut=32,pt=x(),ft=Math.PI/2,bt=16,ht=32;export{dt as DidPointerMoveRecentlyFlag,ut as IsShiftEdgeOnScreenFlag,nt as addArrowTips,Ve as calculateBoundedPlaneTranslateRotate,Ye as calculateDiagonalResizeHandleScale,De as calculatePlaneHalfSize,Xe as calculateResizeHandlePadding,Qe as calculateScreenSpaceBasisLength2,rt as createArrowGeometry,st as createGridVisualElement,tt as createOutlineVisualElement,Ce as createPlane,it as createResizeManipulator,et as createRotateManipulator,qe as createRotatePlane,_e as createShiftManipulator,Be as createShiftPlane,xe as forceHorizontalOrVertical,gt as isAlwaysDrapedLayer,Ze as isDiagonalResizeHandle,Ie as normalToBases,at as planeToShape,bt as resizeNormal,ht as resizeOutlineOnly,ze as resizePlane,mt as shapeToPlane,We as updateResizeHandle,$e as updateRotateHeadingHandle,Je as updateRotateTiltHandle,He as updateShiftRestartHandle};
