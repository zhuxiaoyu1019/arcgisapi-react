/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../../chunks/tslib.es6.js";import e from"../../../../../core/clock.js";import i from"../../../../../core/Handles.js";import{isNone as a,destroyMaybe as s,isSome as r}from"../../../../../core/maybe.js";import{addFrameTask as n}from"../../../../../core/scheduling.js";import{createScreenPoint as l,screenPointObjectToArray as o,createScreenPointArray as h}from"../../../../../core/screenUtils.js";import{property as p}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/has.js";import"../../../../../core/accessorSupport/ensureType.js";import"../../../../../core/Logger.js";import{subclass as u}from"../../../../../core/accessorSupport/decorators/subclass.js";import{i as d,c,v as _,m as v}from"../../../../../chunks/mat4.js";import{d as y,l as w,g as P,a as m,b as g,m as f,n as M,s as V}from"../../../../../chunks/vec3.js";import{a as b,c as D}from"../../../../../chunks/vec3f64.js";import{a as T,c as k,n as E,f as S}from"../../../../../chunks/boundedPlane.js";import{signedDistance as x,create as H,intersectRay as j,normal as C}from"../../../../../geometry/support/plane.js";import{create as R}from"../../../../../geometry/support/ray.js";import{sv3d as z,sm4d as O,sv2d as G}from"../../../../../geometry/support/vectorStacks.js";import{calculateInputRotationTransform as I}from"../../manipulatorUtils.js";import{PLANE_PREVIEW_OUTLINE_WIDTH as U,forceVerticalModifier as K,forceHorizontalModifier as L,PREVIEW_FADE_DURATION_SECONDS as A,POINTER_MOVE_TIMER_MS as B,PLANE_OUTLINE_COLOR as F,PLANE_BACKGROUND_COLOR as q,PREVIEW_FADE_DOT_THRESHOLD as N,INITIAL_DEPTH_OFFSET_FRAC as J}from"./sliceToolConfig.js";import{createShiftManipulator as Q,createRotateManipulator as W,createResizeManipulator as X,createGridVisualElement as Y,createOutlineVisualElement as Z,planeToShape as $,createRotatePlane as tt,resizePlane as et,calculatePlaneHalfSize as it,createPlane as at,DidPointerMoveRecentlyFlag as st,calculateBoundedPlaneTranslateRotate as rt,updateShiftRestartHandle as nt,updateRotateHeadingHandle as lt,updateRotateTiltHandle as ot,updateResizeHandle as ht,createShiftPlane as pt}from"./sliceToolUtils.js";import ut from"./images/heading-rotate-png.js";import dt from"./images/tilt-rotate-png.js";import{screenToRenderPlane as ct}from"../../editingTools/dragEventPipeline3D.js";import{fromScreen as _t}from"../../../support/geometryUtils/ray.js";import{Intersector as vt}from"../../../webgl-engine/lib/Intersector.js";import{Texture as yt}from"../../../webgl-engine/lib/Texture.js";import{createManipulatorDragEventPipeline as wt}from"../../../../interactive/dragEventPipeline.js";import{InteractiveToolBase as Pt}from"../../../../interactive/InteractiveToolBase.js";import{setActive as mt}from"../../../../interactive/interactiveToolUtils.js";import{createScreenPointFromEvent as gt}from"../../../../support/screenUtils.js";import ft from"../../../../../widgets/Slice/SlicePlane.js";let Mt=class extends Pt{constructor(t){super(t),this.clock=e,this._previewPlaneOpacity=1,this.layerView=null,this.cursor=null,this.layersMode="none",this.tiltEnabled=!1,this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this.disableEngineLayers=!1,this._handles=new i,this._viewHandles=new i,this._frameTask=null,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=T(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=l(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=new vt(t.view.state.viewingMode),this._intersector.options.store=0}onAttach(){this.created&&this.visible&&this._updateManipulators()}initialize(){this._initialize()}async _initialize(){const t=()=>{switch(this.toolState){case"created":case"creating":throw new Error("unexpected toolState");case"destroyed":return!1}return!0};if(!t())return;if(this.layerView=await this.view.whenLayerView(this.analysis),!t())return;if(null==this.analysis)throw new Error("SliceTool requires valid model, but null was provided.");if(a(this.layerView.layerViewData))throw new Error("expected internal object to be defined.");this.layerViewData=this.layerView.layerViewData,this.rotateHeadingTexture=new yt(ut,{width:64,height:64,mipmap:!0,preMultiplyAlpha:!0}),this.rotateTiltTexture=new yt(dt,{width:64,height:64,mipmap:!0,preMultiplyAlpha:!0}),this.view._stage&&(this.view._stage.add(this.rotateHeadingTexture),this.view._stage.add(this.rotateTiltTexture));const e=this.watch("state",(t=>{switch(t){case"ready":case"slicing":this.finishToolCreation();break;case"sliced":this.complete()}}),!0);"sliced"===this.state?this.complete():this.startToolCreation(),this._handles.add([e,this.view.state.watch("camera",(()=>this._onCameraChange()))]);const i=t=>{this.updateManipulatorsInteractive(t),t.grabbing||(r(this.layerViewData.plane)&&k(this.layerViewData.plane,this._startPlane),this.inputState=null)};this.shiftManipulator=Q(this.view),this.manipulators.add(this.shiftManipulator),this.shiftManipulator.events.on("grab-changed",(t=>{this._onShiftGrab(t),i(this.shiftManipulator)})),this._handles.add(this._createShiftDragPipeline(this.shiftManipulator)),this.rotateHeadingManipulator=W(this.view,this.rotateHeadingTexture),this.manipulators.add(this.rotateHeadingManipulator),this.rotateHeadingManipulator.events.on("grab-changed",(t=>{this._onRotateHeadingGrab(t),i(this.rotateHeadingManipulator)})),this._handles.add(this._createRotateHeadingDragPipeline(this.rotateHeadingManipulator)),this.rotateTiltManipulator=W(this.view,this.rotateTiltTexture),this.manipulators.add(this.rotateTiltManipulator),this.rotateTiltManipulator.events.on("grab-changed",(t=>{this._onRotateTiltGrab(t),i(this.rotateTiltManipulator)})),this._handles.add(this._createRotateTiltDragPipeline(this.rotateTiltManipulator)),this.resizeManipulators=this._resizeHandles.map(((t,e)=>{const a=X(this.view,t);return a.events.on("grab-changed",(t=>{this._onResizeGrab(t,e),i(a)})),this._handles.add(this._createResizeDragPipeline(a)),a})),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=Y(this.view),this._previewPlaneOutlineVisualElement=Z(this.view),this._previewPlaneOutlineVisualElement.width=U,this._handles.add(this.layerViewData.watch("plane",(()=>this._updateManipulators()),!0)),this._updateManipulators(),this._updateVisibility(this.visible)}destroy(){switch(this.toolState){case"pending":return this._handles=s(this._handles),void(this._viewHandles=s(this._viewHandles));case"destroyed":return}this.view._stage&&(this.view._stage.remove(this.rotateHeadingTexture),this.view._stage.remove(this.rotateTiltTexture)),this.detach(),this._handles.destroy(),this._handles=null,this._viewHandles.destroy(),this._viewHandles=null,this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=s(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=s(this._previewPlaneGridVisualElement)}get state(){const t=!!this.layerViewData.plane,e=!!this.inputState;return t?t&&e?"slicing":t&&!e?"sliced":"ready":"ready"}get isSupported(){return"3d"===this.get("view.type")}set analysis(t){if(null==t)throw new Error("SliceTool requires valid model, but null was provided.");this._handles.remove("analysis"),this._set("analysis",t)}get inputState(){return this._get("inputState")}set inputState(t){this._set("inputState",t),this.layerView.showGrid=t&&"resize"===t.type,this._updateMaterials()}get _isPlacingSlicePlane(){return!this.inputState&&!this.layerViewData.plane&&this.active}get _creatingPointerId(){return this.inputState&&"shift"===this.inputState.type?this.inputState.creatingPointerId:null}enterExcludeLayerMode(){a(this.layerViewData.plane)||(this._set("layersMode","exclude"),mt(this,!0))}exitExcludeLayerMode(){a(this.layerViewData.plane)||(this._set("layersMode","none"),mt(this,!1))}deactivate(){this._updateMouseCursor(),this._set("layersMode","none"),this._updatePreviewPlane(null)}onDetach(){this.created&&this._set("layersMode","none")}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(t){this.analysis.visible=t,this.created&&(this._updateMouseCursor(),this._updateManipulators(),this._updateVisualElementVisibility(),t||this._clearPointerMoveTimeout())}onInputEvent(t){switch(t.type){case"pointer-drag":if(!bt(t))return;this._isPlacingSlicePlane?this._onClickPlacePlane(t)&&(t.stopPropagation(),this._updateMouseCursor()):this._onPointerDrag(t)&&t.stopPropagation();break;case"pointer-move":this._onPointerMove(t),this._updateMouseCursor();break;case"pointer-up":this._onPointerUp(t)&&t.stopPropagation();break;case"immediate-click":if(!bt(t))return;this._onClickPlacePlane(t)&&(t.stopPropagation(),this._updateMouseCursor());break;case"click":if(!bt(t))return;this._onClickExcludeLayer(t)&&t.stopPropagation();break;case"drag":this.inputState&&t.stopPropagation();break;case"key-down":this._onKeyDown(t)&&t.stopPropagation();break;case"key-up":this._onKeyUp(t)&&t.stopPropagation()}}onEditableChange(){this.layerView.editable=this.editable}_onPointerDrag(t){if(t.pointerId===this._creatingPointerId){const e=gt(t);return this.shiftManipulator.events.emit("drag",{action:"start",pointerType:t.pointerType,start:e,screenPoint:e}),!0}return!1}_onPointerMove(t){this._lastCursorPosition.x=t.x,this._lastCursorPosition.y=t.y,this._resetPointerMoveTimeout(),"touch"!==t.pointerType&&this._updatePreviewPlane(gt(t),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(t){return!(t.pointerId!==this._creatingPointerId||!r(this.layerViewData.plane))&&(k(this.layerViewData.plane,this._startPlane),this.inputState=null,!0)}_onClickPlacePlane(t){if("exclude"===this.layersMode)return!1;if(this._isPlacingSlicePlane){const e=gt(t),i=T();if(this._pickPlane(e,!1,this._activeKeyModifiers,i)){k(i,this._startPlane);const a=this._calculatePickRay(e);return this.analysis.plane=$(i,this.view.renderCoordsHelper,this.view.spatialReference,new ft),this.inputState=Vt(a,t.pointerId,i.origin,i),!0}}return!1}_onClickExcludeLayer(t){return!("exclude"!==this.layersMode||!this.created)&&(this.view.hitTest(gt(t)).then((t=>{if(t.results.length){const e=t.results[0],i=e&&e.graphic;if(i){const t=i.sourceLayer||i.layer;t&&this.layerViewData.excludedLayers.push(t)}}else t.ground.layer?this.layerViewData.excludedLayers.push(t.ground.layer):this.layerViewData.excludeGroundSurface=!0})),this._set("layersMode","none"),mt(this,!1),!0)}_onKeyDown(t){return(t.key===K||t.key===L)&&(this._activeKeyModifiers[t.key]=!0,r(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(t){return!(t.key!==K&&t.key!==L||!this._activeKeyModifiers[t.key])&&(delete this._activeKeyModifiers[t.key],r(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(t){if("start"!==t.action||a(this.layerViewData.plane))return;const e=this._calculatePickRay(t.screenPoint);k(this.layerViewData.plane,this._startPlane),this.inputState=Vt(e,null,this.shiftManipulator.renderLocation,this.layerViewData.plane)}_createShiftDragPipeline(t){return wt(t,((t,e,i)=>{const a=this.inputState;if(!a||"shift"!==a.type)return;const s=r(this.layerViewData.plane)?k(this.layerViewData.plane,T()):null;e.next(ct(this.view,a.shiftPlane)).next(this._shiftDragAdjustSensitivity(a)).next(this._shiftDragUpdatePlane(a)),i.next((()=>{r(s)&&this._updateBoundedPlane(s)}))}))}_shiftDragAdjustSensitivity(t){return e=>{if(a(this.layerViewData.plane))return null;const i=.001,s=Math.min((1-Math.abs(y(E(this.layerViewData.plane),e.ray.direction)/w(e.ray.direction)))/i,1),r=-x(this._startPlane.plane,e.renderEnd),n=-x(this._startPlane.plane,t.startPoint);return t.depth=t.depth*(1-s)+r*s-n,e}}_shiftDragUpdatePlane(t){return()=>{if(a(this.layerViewData.plane))return;const e=P(z.get(),this._startPlane.origin),i=P(z.get(),E(this._startPlane));m(i,i,-t.depth),g(i,i,e);const s=S(i,this.layerViewData.plane.basis1,this.layerViewData.plane.basis2,T());this._updateBoundedPlane(s)}}_onRotateHeadingGrab(t){if("start"!==t.action||a(this.layerViewData.plane))return;const e=tt(this.layerViewData.plane,this.view.renderCoordsHelper,1,H()),i=this._calculatePickRay(t.screenPoint),s=D();j(e,i,s)&&(k(this.layerViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:e,startPoint:s})}_createRotateHeadingDragPipeline(t){return wt(t,((t,e,i)=>{const a=this.inputState;if(!a||"rotate"!==a.type)return;const s=r(this.layerViewData.plane)?k(this.layerViewData.plane,T()):null;e.next(ct(this.view,a.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(a)).next(this._rotateDragUpdatePlaneFromRotate()),i.next((()=>{r(s)&&this._updateBoundedPlane(s)}))}))}_onRotateTiltGrab(t){if("start"!==t.action||a(this.layerViewData.plane))return;const e=tt(this.layerViewData.plane,this.view.renderCoordsHelper,2,H()),i=this._calculatePickRay(t.screenPoint),s=D();j(e,i,s)&&(k(this.layerViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:e,startPoint:s})}_createRotateTiltDragPipeline(t){return wt(t,((t,e,i)=>{const a=this.inputState;if(!a||"rotate"!==a.type)return;const s=r(this.layerViewData.plane)?k(this.layerViewData.plane,T()):null;e.next(ct(this.view,a.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(a)).next(this._rotateDragUpdatePlaneFromRotate()),i.next((()=>{r(s)&&this._updateBoundedPlane(s)}))}))}_rotateDragRenderPlaneToRotate(t){return e=>{if(a(this.layerViewData.plane))return null;const i=C(t.rotatePlane),s=I(this.inputState.startPoint,e.renderEnd,this.layerViewData.plane.origin,i);return{...e,rotateAxis:i,rotateAngle:s}}}_rotateDragUpdatePlaneFromRotate(){return t=>{if(a(this.layerViewData.plane))return;const e=d(O.get());c(e,e,t.rotateAngle,t.rotateAxis);const i=f(z.get(),this._startPlane.basis1,e),s=f(z.get(),this._startPlane.basis2,e),r=S(this.layerViewData.plane.origin,i,s,T());this._updateBoundedPlane(r)}}_onResizeGrab(t,e){if("start"!==t.action||a(this.layerViewData.plane))return;const i=this._calculatePickRay(t.screenPoint),s=z.get();j(this.layerViewData.plane.plane,i,s)&&(k(this.layerViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:e,startPoint:b(s)})}_createResizeDragPipeline(t){return wt(t,((t,e,i)=>{const s=this.inputState;if(!s||"resize"!==s.type||a(this.layerViewData.plane))return;const r=k(this.layerViewData.plane,T());e.next(ct(this.view,this.layerViewData.plane.plane)).next(this._resizeDragUpdatePlane(s)),i.next((()=>{this._updateBoundedPlane(r)}))}))}_resizeDragUpdatePlane(t){return e=>{if(a(this.layerViewData.plane))return;const i=this._resizeHandles[t.activeHandleIdx],s=et(i,this.inputState.startPoint,e.renderEnd,this.view.state.camera,this._startPlane,k(this.layerViewData.plane));this._updateBoundedPlane(s)}}_updateBoundedPlane(t){const e=this.layerViewData;if(!r(e))throw new Error("valid internal object expected");e.plane=t}_updatePreviewPlane(t,e={}){let i=this._previewPlane;if(this._previewPlane=null,a(t))return this._removeFrameTask(),void this._updateManipulators();if(!this.layerViewData.plane&&this.active){const a=r(i)?i:T();if(i=r(i)?k(i,Dt):null,this._pickPlane(t,!0,e,a)){const t=N;let e=!1;r(i)&&(e=y(i.plane,a.plane)<t||y(M(z.get(),i.basis1),M(z.get(),a.basis1))<t),e&&(this._previewPlaneOpacity=0),this._previewPlane=a}}r(this._previewPlane)&&a(this._frameTask)&&0===this._previewPlaneOpacity?this._frameTask=n({update:({deltaTime:t})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+t/(1e3*A),1),this._updateManipulators(),1===this._previewPlaneOpacity&&this._removeFrameTask()}}):a(this._previewPlane)&&r(this._frameTask)?this._removeFrameTask():r(this._previewPlane)&&this._updateManipulators()}_removeFrameTask(){r(this._frameTask)&&(this._frameTask.remove(),this._frameTask=null)}_calculatePickRay(t){const e=R(),i=o(t,Tt);return _t(this.view.state.camera,i,e),M(e.direction,e.direction),e}_pickMinResult(t){const e=o(t,G.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector),this._intersector.results.min}_pickPlane(t,e,i,a){const s=this._pickMinResult(t),r=z.get();if(!s.getIntersectionPoint(r))return!1;const n=s.getTransformedNormal(z.get()),l=this.view.state.camera;y(n,l.viewForward)>0&&m(n,n,-1);const o=it(r,l),h=(e?1:-1)*o*J,p=m(z.get(),n,h);g(p,p,r);const u=this.tiltEnabled?3:0,d=i[K]?2:i[L]?1:u;return at(p,n,o,o,l,d,this.view.renderCoordsHelper,a),!0}_updateMouseCursor(){this._set("cursor",null),this._isPlacingSlicePlane||"exclude"===this.layersMode?this._set("cursor","crosshair"):r(this._creatingPointerId)&&this._set("cursor","grabbing")}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout&&(this._prevPointerMoveTimeout.remove(),this._prevPointerMoveTimeout=null)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=st,this.rotateHeadingManipulator.state|=st,this.rotateTiltManipulator.state|=st,this._prevPointerMoveTimeout=this.clock.setTimeout((()=>{this.shiftManipulator.state&=~st,this.rotateHeadingManipulator.state&=~st,this.rotateTiltManipulator.state&=~st}),B)}_updateManipulators(){if(this.disableEngineLayers)return;let t=null,e=!1;if(r(this.layerViewData.plane))t=this.layerViewData.plane,e=!1;else{if(!r(this._previewPlane))return this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach((t=>t.available=!1)),this._previewPlaneOutlineVisualElement.visible=!1,void(this._previewPlaneGridVisualElement.visible=!1);t=this._previewPlane,e=!0}const i=rt(t,O.get());e?(this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach((t=>t.available=!1)),this._previewPlaneOutlineVisualElement.visible=!0,this._previewPlaneGridVisualElement.visible=!0):(this.shiftManipulator.available=!0,this.rotateHeadingManipulator.available=!0,this.rotateTiltManipulator.available=this.tiltEnabled,this.resizeManipulators.forEach((t=>t.available=!0)),nt(this.shiftManipulator,i,t,this.view.state.camera),lt(this.rotateHeadingManipulator,i,t,this.view.renderCoordsHelper),ot(this.rotateTiltManipulator,i,t),this.resizeManipulators.forEach(((e,a)=>ht(e,this._resizeHandles[a],i,t))),this._previewPlaneOutlineVisualElement.visible=!1,this._previewPlaneGridVisualElement.visible=!1);const a=V(z.get(),w(t.basis1),w(t.basis2),1),s=_(O.get(),a),n=v(s,i,s);this._previewPlaneOutlineVisualElement.transform=n,this._previewPlaneGridVisualElement.transform=n,this._updateMaterials()}_updateVisualElementVisibility(){this.disableEngineLayers}_updateMaterials(){const t=[F[0],F[1],F[2],F[3]*this._previewPlaneOpacity];this._previewPlaneOutlineVisualElement.color=t;const e=[q[0],q[1],q[2],q[3]*this._previewPlaneOpacity],i=[0,0,0,0];this._previewPlaneGridVisualElement.backgroundColor=e,this._previewPlaneGridVisualElement.gridColor=i}updateManipulatorsInteractive(t){if(!t.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach((t=>{t.interactive=!0}));this.shiftManipulator.interactive=this.shiftManipulator===t,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===t,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===t,this.resizeManipulators.forEach((e=>{e.interactive=e===t}))}testData(){return{plane:r(this.layerViewData.plane)?this.layerViewData.plane:null}}};function Vt(t,e,i,a){const s=pt(i,E(a),t.direction,H()),r=D();return j(s,t,r)?{type:"shift",creatingPointerId:e,shiftPlane:s,depth:0,startPoint:r}:null}function bt(t){return"mouse"!==t.pointerType||0===t.button}t([p()],Mt.prototype,"clock",void 0),t([p({constructOnly:!0})],Mt.prototype,"view",void 0),t([p()],Mt.prototype,"layerView",void 0),t([p()],Mt.prototype,"layerViewData",void 0),t([p({readOnly:!0})],Mt.prototype,"state",null),t([p({readOnly:!0})],Mt.prototype,"isSupported",null),t([p({readOnly:!0})],Mt.prototype,"cursor",void 0),t([p()],Mt.prototype,"analysis",null),t([p({readOnly:!0})],Mt.prototype,"layersMode",void 0),t([p({aliasOf:"analysis.tiltEnabled"})],Mt.prototype,"tiltEnabled",void 0),t([p({value:null})],Mt.prototype,"inputState",null),Mt=t([u("esri.views.3d.interactive.analysisTools.slice.SliceTool")],Mt);const Dt=T(),Tt=h();var kt=Mt;export default kt;
