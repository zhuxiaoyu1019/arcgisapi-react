/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{handlesGroup as e,destroyHandle as t,refHandle as a}from"../../../../core/handleUtils.js";import{deg2rad as n}from"../../../../core/mathUtils.js";import{isSome as i}from"../../../../core/maybe.js";import{s as l,b as s,a as o}from"../../../../chunks/vec3.js";import{c as r}from"../../../../chunks/vec3f64.js";import{getGraphicEffectiveElevationInfo as c}from"../../../../support/elevationInfoUtils.js";import{Manipulator3D as p}from"../Manipulator3D.js";import{ManipulatorState as m}from"./ManipulatorState.js";import{settings as h}from"./settings.js";import{ExtendedLineVisualElement as u}from"../visualElements/ExtendedLineVisualElement.js";import{LaserlineVisualElement as d}from"../visualElements/LaserlineVisualElement.js";import{OutlineVisualElement as g}from"../visualElements/OutlineVisualElement.js";import{GraphicState as f}from"../../layers/graphics/GraphicState.js";function v(t){const{view:a,graphic:n}=t,i=new f({graphic:n}),l=y(t,i),s=[l,E(t,l.visualElement,i),a.maskOccludee(n),a.trackGraphicState(i)];return{visualElement:l.visualElement,remove:()=>e(s).remove()}}function y(a,n){const{view:i,graphic:l}=a,s=new g({view:i,geometry:S(l)?l.geometry:null,elevationInfo:c(l),attached:!1});h.visualElements.lineGraphics.shadowStyle.apply(s);const o=()=>{s.attached=n.displaying};h.visualElements.lineGraphics.outline.apply(s);const r=[n.watch("displaying",o),n.watch("isDraped",(e=>s.isDraped=e)),n.on("changed",(()=>s.geometry=S(l)?l.geometry:null)),t(s)];return o(),{visualElement:s,remove:()=>e(r).remove()}}function E(i,l,s){const{graphic:o,view:r}=i,p=[],g=c(o),f="on-the-ground"===g.mode||!g.offset&&"absolute-height"!==g.mode,v=new m,y=new u({view:r,extensionType:h.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});h.visualElements.pointGraphics.shadowStyle.apply(y);const E=n(h.visualElements.heightPlaneAngleCutoff),j=new d({view:r,attached:!1,angleCutoff:E});h.visualElements.heightPlane.apply(j);let M=1,G=1;const L=()=>{if(v.update(i),!s.displaying||f&&(s.isDraped||!S(o)||!o.geometry.hasZ))return l.laserlineEnabled=!1,y.attached=!1,void(j.attached=!1);l.laserlineEnabled=!0;{const e=4&v.grabbingState?h.visualElements.laserlineAlphaMultiplier:1;e!==M&&(M=e,h.visualElements.lineGraphics.shadowStyle.apply(l,e),h.visualElements.pointGraphics.shadowStyle.apply(y,e))}{const e=2&v.grabbingState?h.visualElements.laserlineAlphaMultiplier:1;e!==G&&(G=e,h.visualElements.heightPlane.apply(j,e))}w(y,v),b(i,l,j,v)};h.visualElements.zVerticalLine.apply(y),p.push(s.on("changed",L),s.watch("displaying",L),l.events.on("attachment-origin-changed",L),t(y),t(j));const D=[],C=()=>{e(D).remove(),D.length=0,i.forEachManipulator((e=>D.push(e.events.on("grab-changed",L)))),i.forEachManipulator((e=>D.push(e.events.on("select-changed",L)))),L()};return C(),p.push(i.onManipulatorsChanged(C),a((()=>e(D)))),e(p)}function w(e,t){const a=1===t.numSelected?t.firstSelected:t.numSelected>1&&i(t.firstGrabbedXY)?t.firstGrabbedXY:null;i(a)?(e.setStartEndFromWorldDownAtLocation(a.renderLocation),e.attached=!0):e.attached=!1}function b(e,t,a,n){if(n.numSelected>0){l(j,0,0,0);let t=0;e.forEachManipulator(((e,a)=>{1===a&&e.selected&&e instanceof p&&(s(j,j,e.renderLocation),t++)})),t>0?(a.heightManifoldTarget=o(j,j,1/t),a.attached=!0):a.attached=!1}else{const n=t.attachmentOrigin;i(n)&&e.view.renderCoordsHelper.toRenderCoords(n,j)?(a.heightManifoldTarget=j,a.attached=!0):a.attached=!1}}function S(e){return i(e.geometry)&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}const j=r();export{y as createGeometryRepresentationVisualElement,v as createVisualElements};
