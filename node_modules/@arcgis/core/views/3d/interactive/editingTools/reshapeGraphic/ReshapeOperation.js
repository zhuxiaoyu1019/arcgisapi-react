/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import"../../../../../core/has.js";import t from"../../../../../core/Evented.js";import{HandleOwner as i}from"../../../../../core/HandleOwner.js";import a from"../../../../../core/Handles.js";import{handlesGroup as r,destroyHandle as n}from"../../../../../core/handleUtils.js";import{isSome as o,destroyMaybe as s,isNone as l,unwrap as p,removeMaybe as h}from"../../../../../core/maybe.js";import{init as d}from"../../../../../core/watchUtils.js";import{property as u}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/accessorSupport/ensureType.js";import"../../../../../core/Logger.js";import{subclass as c}from"../../../../../core/accessorSupport/decorators/subclass.js";import{I as m}from"../../../../../chunks/mat4f64.js";import{l as g,f as _,e as v,s as f,b as M,a as y}from"../../../../../chunks/vec3.js";import{f as x,c as G}from"../../../../../chunks/vec3f64.js";import b from"../../../../../geometry/Polyline.js";import{makeDehydratedPoint as H}from"../../../../../layers/graphics/dehydratedFeatures.js";import{getGraphicEffectiveElevationInfo as O}from"../../../../../support/elevationInfoUtils.js";import{isVolumetricSymbol as E}from"../../../../../symbols/support/utils.js";import{Manipulator3D as S}from"../../Manipulator3D.js";import{createManipulatorMaterial as I,createManipulatorOutlineMaterial as w,placeAtGraphic as V}from"../../manipulatorUtils.js";import{SnappingPipeline as D}from"../../SnappingDragPipelineStep.js";import{SnappingVisualizer3D as P}from"../../SnappingVisualizer3D.js";import{screenToRenderPlaneFromEvent as k,convertToMapCoordinates as j,screenToMapXYForGraphicAtLocation as A}from"../dragEventPipeline3D.js";import{canMoveZ as L}from"../manipulatorUtils.js";import{settings as U,colors as z}from"../settings.js";import{createVisualElements as T}from"../visualElementUtils.js";import{DISC_RADIUS_SMALL as F}from"../manipulations/config.js";import{MoveManipulation as C}from"../manipulations/MoveManipulation.js";import{shapeOrientation as R}from"../manipulations/moveUtils.js";import{MoveXYGraphicManipulation as Z}from"../manipulations/MoveXYGraphicManipulation.js";import{createEdgeOffsetIntersectionPlane as N,createEdgeOffsetOperation as X,edgeOffsetRotationMatrix as Y,screenEdgeLengthSquared as q}from"./edgeOffsetUtils.js";import{OutlineVisualElement as K}from"../../visualElements/OutlineVisualElement.js";import{GraphicState as W}from"../../../layers/graphics/GraphicState.js";import B from"../../../webgl-engine/lib/GeometryUtil.js";import{addMapDelta as J,createManipulatorDragEventPipeline as Q,dragAtLocation as $}from"../../../../interactive/dragEventPipeline.js";import{EditGeometryHelper as ee}from"../../../../interactive/editGeometry/EditGeometryHelper.js";import{SnappingContext as te}from"../../../../interactive/snapping/SnappingContext.js";let ie=class extends(t.EventedMixin(i)){constructor(e){super(e),this._vertexManipulatorMaterial=I(U.colorToVec4(U.reshapeManipulators.vertex.color),U.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=w(U.colorToVec4(U.reshapeManipulators.vertex.outlineColor),U.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=w(U.colorToVec4(U.reshapeManipulators.vertex.hoverOutlineColor),U.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=I(U.colorToVec4(U.reshapeManipulators.edge.color),U.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=w(U.colorToVec4(U.reshapeManipulators.edge.outlineColor),U.reshapeManipulators.edge.renderOccluded),this._edgeOffsetManipulatorMaterial=I(U.colorToVec4(U.reshapeManipulators.edgeOffset.color),U.reshapeManipulators.edgeOffset.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=I(U.colorToVec4(U.reshapeManipulators.edgeOffset.hoverColor),U.reshapeManipulators.edgeOffset.renderOccluded,!1),this._selectedManipulatorMaterial=I(U.colorToVec4(U.reshapeManipulators.selected.color),U.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=w(U.colorToVec4(U.reshapeManipulators.selected.outlineColor),U.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=w(U.colorToVec4(U.reshapeManipulators.selected.hoverOutlineColor),U.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._edgeOffsetManipulatorGeometryInside=null,this._edgeOffsetManipulatorGeometryOutside=null,this._manipulatorHandles=new a,this._manipulatorInfos=[],this._editGeometryHelper=null,this._graphicMoveManipulation=null,this._moveManipulation=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=0,this._outlineVisualElement=null,this.tool=null,this.outputGeometry=null,this._snappingPipeline=new D,this._snappingPipelineHandle=new D,this._vertexLaserLineVisualElement=null}initialize(){const e=new W({graphic:this.graphic});this._graphicState=e,this.handles.add([e.watch("displaying",(e=>{for(const t of this._manipulatorInfos)t.manipulator.available=e})),this.view.trackGraphicState(e)])}destroy(){this._clear()}get inputGeometry(){return o(this._editGeometryHelper)?this._editGeometryHelper.geometry:null}set inputGeometry(e){this._recreateEditGeometryAndManipulators(e)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}removeSelectedVertices(){const e=this._manipulatorInfos.filter((e=>e.manipulator.selected&&"vertex"===e.handle.type));this._removeVertices(e)}manipulatorSelectionChanged(){this.emit("manipulators-changed")}_clear(){this._removeManipulators(),this._resetGrabbingDragging(),this._editGeometryHelper=s(this._editGeometryHelper)}_removeManipulators(){this._moveManipulation=s(this._moveManipulation),this._graphicMoveManipulation=s(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[]}_resetGrabbingDragging(){this._numGrabbing=0,this._numDragging=0}_createManipulators(){if(l(this._editGeometryHelper))return;const e=O(this.graphic);for(const t of this._editGeometryHelper.editGeometry.components){for(const i of t.vertices)this._createVertexOrEdgeManipulator(i,e);for(const i of t.edges)this._createVertexOrEdgeManipulator(i,e)}this._createGraphicMoveManipulators(e)}get canRedo(){return o(this._editGeometryHelper)&&this._editGeometryHelper.canRedo}get canUndo(){return o(this._editGeometryHelper)&&this._editGeometryHelper.canUndo}redo(){if(l(this._editGeometryHelper))return null;const e=this._editGeometryHelper.redo();return o(e)&&(this.outputGeometry=this._editGeometryHelper.geometry,this._recreateManipulators()),e}undo(){if(l(this._editGeometryHelper))return null;this.emit("undo");const e=this._editGeometryHelper.undo();return o(e)&&(this.outputGeometry=this._editGeometryHelper.geometry,this._recreateManipulators()),e}_recreateManipulators(){this._removeManipulators(),this._resetGrabbingDragging(),this._createManipulators()}_recreateEditGeometryAndManipulators(e=this.inputGeometry){this._clear(),l(e)||(s(this._editGeometryHelper),this._editGeometryHelper=ee.fromGeometry(e,this.view.viewingMode),this._createManipulators())}_perGraphicManipulatorDragAction(e,t){if("end"===t.action)return;let i=0;const a=[],r=this._manipulatorInfos.some((e=>"vertex"===e.handle.type&&e.manipulator.selected)),n=1===e&&r;for(const o of this._manipulatorInfos)re(o)&&(o.manipulator.grabbing||n&&!o.manipulator.selected||a.push(o),i++);if(0===a.length)return;this._moveVertices(a,t);if(a.length===i){if(this._updateEventState(1),this.destroyed)return;this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(2),this.destroyed)return;this.emit("reshape",{type:"reshape",mover:this.graphic})}}isMultiVertexSelection(){let e=0;for(const t of this._manipulatorInfos)re(t)&&t.manipulator.selected&&e++;return e>1}_perVertexManipulatorDragAction(e){if(this._updateEventState(2),this.destroyed)return;const{mapDeltaX:t,mapDeltaY:i,mapDeltaZ:a}=e;if(!t&&!i&&!a)return;const r=[];for(const n of this._manipulatorInfos)re(n)&&(n.manipulator.selected&&!n.manipulator.grabbing||n===e.info)&&r.push(n);this._moveVertices(r,e,1),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(e){if(e===this._reshapeEventState)return!1;switch(e){case 0:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case 1:switch(this._reshapeEventState){case 0:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case 2:switch(this._reshapeEventState){case 0:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==e;return this._reshapeEventState=e,t}_createGraphicMoveManipulators(e){if(this._graphicMoveManipulation=new Z({tool:this.tool,view:this.view,graphicState:this._graphicState}),this.enableMoveGraphic){let e=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline(((t,i,a)=>{i.next((e=>this._trackNumDragging(e))).next((t=>("start"===t.action&&(e=p(this._editGeometryHelper).createUndoGroup()),t))).next((t=>{this._perGraphicManipulatorDragAction(0,t),"end"===t.action&&(e=h(e))})),a.next(this._cancelDragOperation((()=>e=h(e))))})))}else this._graphicMoveManipulation.forEachManipulator((e=>{e.grabbable=!1,e.cursor=null}));this._graphicMoveManipulation.forEachManipulator((e=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()}))]))),this._moveManipulation=new C({tool:this.tool,view:this.view,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&L(this.graphic),snapToScene:!1,radius:C.radiusForSymbol(this.graphic.symbol)}),this._moveManipulation.forEachManipulator((e=>{this.handles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(t=>{this._moveManipulation.zManipulation.hasManipulator(e)||this._manipulatorInfos.some((e=>e.manipulator.selected))||this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()}))])})),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const t=p(this.graphic.geometry).spatialReference;this.handles.add([this._moveManipulation.createDragPipeline(((t,i,a,r,n)=>{const o=a.next((e=>this._trackNumDragging(e))).next((e=>{const t=this._manipulatorInfos.filter((e=>re(e)&&e.manipulator.selected));return 1===e.manipulatorType&&1===t.length?{...e,info:t[0],snapOrigin:t[0].handle.pos}:{...e,info:null}})).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:e=>!!e.info,cancel:r,snappingManager:this.tool.snappingManager,snappingContext:new te({geometry:p(this._editGeometryHelper),elevationInfo:e,pointer:n,excludeFeature:this.graphic,visualizer:new P}),updatingHandles:this.updatingHandles}),this._snappingPipelineHandle.next).next(J()).next((e=>(this._perGraphicManipulatorDragAction(1,e),e)));return r.next(this._cancelDragOperation()),o}),e,t,this.graphic),d(this._graphicState,"displaying",(()=>{this._updateMoveManipulationPosition()})),this._graphicState.on("changed",(()=>this._updateMoveManipulationPosition())),d(this._graphicState,"isDraped",(()=>{const e="align-move-manipulation";this._graphicState.isDraped?this.handles.add(this.view.elevationProvider.on("elevation-change",(()=>this._updateMoveManipulationPosition())),e):this.handles.remove(e)}))]),this._updateMoveManipulationPosition();const i=T({view:this.view,graphic:this.graphic,forEachManipulator:e=>{if(!this.destroyed){o(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(e);for(const t of this._manipulatorInfos)e(t.manipulator,1);this._moveManipulation.forEachManipulator(e)}},onManipulatorsChanged:e=>this.on("manipulators-changed",e)});o(i)&&(this._outlineVisualElement=i.visualElement instanceof K?i.visualElement:null),o(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",(()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._graphicState.watch("isDraped",(()=>this._updateMoveManipulationPosition()))]),this._manipulatorHandles.add(i)}_createEdgeOffsetManipulator(e,t=O(this.graphic)){const i=U.reshapeManipulators.edgeOffset,a=i.size/2,n=a+i.collisionPadding;if(l(this._edgeOffsetManipulatorGeometryInside)||l(this._edgeOffsetManipulatorGeometryOutside)){const e=a/n,t=e*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=B.createExtrudedTriangle(t,e/2,e/2,i.height,i.offset),this._edgeOffsetManipulatorGeometryOutside=B.createExtrudedTriangle(-t,e/2,e/2,i.height,-i.offset)}const o=[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:1},{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:2},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:1},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:2}],s=new S({view:this.view,renderObjects:o,elevationInfo:"on-the-ground"!==t.mode||E(this.graphic.symbol)?{mode:"absolute-height",offset:0}:t,worldOriented:!1,focusMultiplier:1,touchMultiplier:1,radius:n,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:x(0,0,1)},collisionPriority:1}),d=new S({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:"default"});d.grabbable=!1;const u={manipulator:s,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0,visibilityManipulator:d,elevationInfo:t,visibilityHandle:null},c=()=>{h(u.visibilityHandle);const e=()=>q(this._getManipulatorInfoFromHandle(u.handle.left).manipulator.renderLocation,this._getManipulatorInfoFromHandle(u.handle.right).manipulator.renderLocation,this.view.state.camera)<i.minSquaredEdgeLength;(!s.focused&&!d.focused||e())&&(s.grabbable=!1,u.visibilityHandle=r([s.disableDisplay(),{remove:()=>{s.grabbable=!0}}]))};this._manipulatorHandles.add([s.events.on("focus-changed",(()=>c())),d.events.on("focus-changed",(()=>c())),{remove:()=>{h(u.visibilityHandle),this.manipulators.remove(u.visibilityManipulator)}}],s),c(),this._updateEdgeOffsetManipulator(u);const m=this._getManipulatorInfoFromHandle(u.handle.left).manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(u))),g=this._getManipulatorInfoFromHandle(u.handle.right).manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(u)));u.locationUpdateHandle=r([m,g]),this._manipulatorHandles.add(u.locationUpdateHandle,s),this._manipulatorHandles.add(this._watchAndUpdateGrabState(s,!0),s);const _=Q(s,((e,i,a)=>{this._clearSelection();const{step:r,cleanup:n}=this._initializeEdgeOffset(u,t);i.next((e=>this._trackNumDragging(e))).next($(this.view,e.elevationAlignedLocation)).next(r).next(k(this.view)).next(j(this.view,p(this._editGeometryHelper).editGeometry.coordinateHelper.spatialReference)).next(J()).next(this._applyEdgeOffsetStep(u)).next((e=>{"end"===e.action&&n()})),a.next((e=>(n(),e))).next(this._cancelDragOperation())}));return this._manipulatorHandles.add(_,s),this._manipulatorHandles.add([s.events.on("immediate-click",(e=>{e.shiftKey||this._clearSelection(),e.stopPropagation()})),d.events.on("immediate-click",(e=>this.emit("immediate-click",{...e,graphic:this.graphic})))],s),this._manipulatorInfos.push(u),this.manipulators.add(s),this.manipulators.add(d),this.emit("manipulators-changed"),u}_updateEdgeOffsetManipulator(e){this._updateManipulatorPosition(e);const t=p(this._editGeometryHelper).editGeometry.coordinateHelper,i=N(this.view,e.manipulator.elevationAlignedLocation,X(t,e.handle,p(e.manipulator.elevationInfo))),a=this._getManipulatorInfoFromHandle(e.handle.left).manipulator.renderLocation,r=this._getManipulatorInfoFromHandle(e.handle.right).manipulator.renderLocation,n=o(i)?Y(i,a,r):m;e.manipulator.modelTransform=n,e.visibilityManipulator.elevationAlignedLocation=e.manipulator.elevationAlignedLocation,e.visibilityManipulator.modelTransform=n;const s=g(_(se,a,r))/2;e.visibilityManipulator.collisionType={type:"line",paths:[[[-s,0,0],[s,0,0]]]}}_initializeEdgeOffset(e,t){const i=p(this._editGeometryHelper),a=X(i.editGeometry.coordinateHelper,e.handle,t),o=i.createUndoGroup(),s=N(this.view,e.manipulator.elevationAlignedLocation,a);a.requiresSplitEdgeLeft&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(e.handle.left.left),1),a.requiresSplitEdgeRight&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(e.handle.right.right),0);const d=()=>new b({paths:[[e.handle.left.pos,e.handle.right.pos]],spatialReference:p(this._editGeometryHelper).editGeometry.coordinateHelper.spatialReference}),u=new K({view:this.view,isDraped:this._graphicState.isDraped,geometry:d(),elevationInfo:e.elevationInfo,width:U.visualElements.lineGraphics.outline.width,color:U.colorToVec4(z.main),attached:!0});let c;const m=()=>{this._cleanEdgeOffsetCollapsedEdges(e),c=h(c)},g=this.on("undo",m);return c=r([n(u),this._graphicState.watch("isDraped",(e=>u.isDraped=e)),this._graphicState.on("changed",(()=>u.geometry=d())),o,g]),{step:e=>l(a)||l(s)?(m(),null):{...e,operation:a,plane:s},cleanup:m}}_applyEdgeOffsetStep(e){return t=>{if(this.destroyed||l(t.operation))return t;this._updateEventState(2);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:r}=t;return(i||a||r)&&(this._offsetEdge(e,t),this.emit("reshape",{type:"reshape",mover:this.graphic})),t}}_cleanEdgeOffsetCollapsedEdges(e){var t,i;const a=null==(t=e.handle.left.left)?void 0:t.left,r=e.handle.left,n=null==(i=e.handle.right.right)?void 0:i.right,o=e.handle.right,s=p(this._editGeometryHelper).editGeometry.coordinateHelper,l=1e-6,h=[];a&&s.distance(a.pos,r.pos)<l&&h.push(this._getManipulatorInfoFromHandle(r)),(s.distance(r.pos,o.pos)<l||n&&s.distance(n.pos,o.pos)<l)&&h.push(this._getManipulatorInfoFromHandle(o)),h.length&&this._removeVertices(h)}_computeVertexManipulatorSizeAndOutline(e){const t=e.size/2,i=t+e.collisionPadding;return{size:t/i,outlineSize:(t+e.outlineSize)/i}}_createVertexOrEdgeManipulator(e,t=O(this.graphic)){if("edge"===e.type){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(e,t);if(!this.enableMidpoints)return null}if(l(this._vertexManipulatorGeometry)||l(this._vertexManipulatorOutlineGeometry)){const{size:e,outlineSize:t}=this._computeVertexManipulatorSizeAndOutline(U.reshapeManipulators.vertex);this._vertexManipulatorGeometry=B.createSphereGeometry(e,16,16),this._vertexManipulatorOutlineGeometry=B.createSphereGeometry(t,16,16)}if(l(this._edgeManipulatorGeometry)||l(this._edgeManipulatorOutlineGeometry)){const{size:e,outlineSize:t}=this._computeVertexManipulatorSizeAndOutline(U.reshapeManipulators.edge);this._edgeManipulatorGeometry=B.createSphereGeometry(e,16,16),this._edgeManipulatorOutlineGeometry=B.createSphereGeometry(t,16,16)}const i=o(this.graphic.geometry)&&"point"===this.graphic.geometry.type?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:4|le.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:5|le.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|le.Vertex},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:8},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:9},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:10}];this.enableMidpoints&&i.push({geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:6|le.Edge},{geometry:this._edgeManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|le.Edge},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:5|le.Edge},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:5|le.Edge});const a=new S({view:this.view,renderObjects:i,elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(a,e,t);const n="edge"===e.type?{manipulator:a,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:a,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(n),this.manipulators.add(a),this._updateManipulatorPosition(n),"edge"===n.type){const e=this._getManipulatorInfoFromHandle(n.handle.left).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(n))),t=this._getManipulatorInfoFromHandle(n.handle.right).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(n)));n.locationUpdateHandle=r([e,t]),this._manipulatorHandles.add(n.locationUpdateHandle,a)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!0),a);const s=Q(a,((e,i,a,r)=>{let o=null;i.next((e=>this._trackNumDragging(e))).next((e=>{if("start"===e.action&&(o=p(this._editGeometryHelper).createUndoGroup()),ne(n)){const t=this._splitEdgeManipulator(n);return{...e,info:t,snapOrigin:t.handle.pos}}return{...e,info:n,snapOrigin:n.handle.pos}})).next($(this.view,e.elevationAlignedLocation)).next(A(this.view,this.graphic,e.elevationAlignedLocation,e.location.spatialReference,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this.isMultiVertexSelection(),cancel:a,snappingManager:this.tool.snappingManager,snappingContext:new te({geometry:p(this._editGeometryHelper),elevationInfo:t,pointer:r,excludeFeature:this.graphic,visualizer:new P}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next(J()).next((e=>{this._perVertexManipulatorDragAction(e),"end"===e.action&&(o=h(o))})),a.next(this._cancelDragOperation((()=>o=h(o))))}));return this._manipulatorHandles.add(s,a),this._manipulatorHandles.add([a.events.on("immediate-click",(e=>this._manipulatorClickCallback(e,n))),a.events.on("select-changed",(()=>{n.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}))],a),this.emit("manipulators-changed"),n}_trackNumDragging(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e}_cancelDragOperation(e){return()=>{switch(this._numDragging--,this.undo(),this.outputGeometry=o(this._editGeometryHelper)?this._editGeometryHelper.geometry:null,o(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._reshapeEventState){case 0:break;case 1:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape",mover:this.graphic})}e&&e(),this.destroyed||this._updateEventState(0)}}_setTypeSpecificManipulatorSettings(e,t,i){switch(t.type){case"vertex":e.state=le.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2,e.radius=U.reshapeManipulators.vertex.size/2+U.reshapeManipulators.vertex.collisionPadding,e.elevationInfo=i,e.interactive=o(this.graphic.geometry)&&"point"!==this.graphic.geometry.type;break;case"edge":e.state=le.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1,e.radius=U.reshapeManipulators.edge.size/2+U.reshapeManipulators.edge.collisionPadding,e.elevationInfo="on-the-ground"!==i.mode||E(this.graphic.symbol)?{mode:"absolute-height",offset:0}:i}}_watchAndUpdateGrabState(e,t){return e.events.on("grab-changed",(i=>{if("start"===i.action)t&&this._updateSelection(e),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(0),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing}))}_clearSelection(){for(const e of this._manipulatorInfos)e.manipulator.grabbing||(e.manipulator.selected=!1)}_updateSelection(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(e){e&&(this._manipulatorHandles.remove(e.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(e),1),this.manipulators.remove(e.manipulator),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(e){if(e)for(const t of this._manipulatorInfos)if(e===t.handle)return t;return null}_updateManipulatorPosition(e){if(!e)return;const t=p(this._editGeometryHelper);if("vertex"===e.handle.type)e.manipulator.location=t.editGeometry.coordinateHelper.toPoint(e.handle.pos,oe),e.manipulator.grabbing&&o(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if("edge"===e.handle.type){const i=this._getManipulatorInfoFromHandle(e.handle.left).manipulator,a=this._getManipulatorInfoFromHandle(e.handle.right).manipulator;if(o(e.manipulator.elevationInfo)&&"on-the-ground"===e.manipulator.elevationInfo.mode){const r=i.location,n=a.location,o=.5,s=r.x+o*(n.x-r.x),l=r.y+o*(n.y-r.y),p=r.hasZ&&n.hasZ?0:void 0;e.manipulator.location=H(s,l,p,t.geometry.spatialReference)}else v(se,i.renderLocation,a.renderLocation,.5),e.manipulator.renderLocation=se}}_splitEdgeManipulator(e,t=.5){const i=p(this._editGeometryHelper),a=p(i.splitEdge(e.handle,t).createdVertex);e.locationUpdateHandle.remove(),e.locationUpdateHandle=void 0;const r=O(this.graphic);let n;this.enableEdgeOffset?(this._removeManipulator(e),n=this._createVertexOrEdgeManipulator(a)):(n=e,n.handle=a,n.type="vertex",this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,r)),a.left&&this._createVertexOrEdgeManipulator(a.left),a.right&&this._createVertexOrEdgeManipulator(a.right),this.outputGeometry=i.geometry,this._updateManipulatorPosition(n),this._updateSelection(e.manipulator);const o=this._updateEventState(2),s=i.editGeometry.coordinateHelper.toArray(n.handle.pos),l=i.editGeometry.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:s,componentIndex:l,vertexIndex:p(a.index)}],added:s}),o&&this._updateEventState(0),n}_updateMoveManipulationPosition(){const e=f(se,0,0,0);let t=0,i=!1,a=null,r=null;for(const n of this._manipulatorInfos)re(n)&&(n.manipulator.selected?(t++,M(e,e,n.manipulator.renderLocation),l(a)||n.selectedIndex>a.selectedIndex?(r=a,a=n):(l(r)||n.selectedIndex>r.selectedIndex)&&(r=n)):i=!0);if(0!==t){const e=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.zManipulation.available=e&&this.enableZVertex&&L(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e&&1!==t}else{const e=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e,this._moveManipulation.zManipulation.available=e&&this.enableZShape&&L(this.graphic)}if(0!==t){let e=0;if(o(a)){const t=a.handle.pos,i=o(r)?r.handle.pos:a.handle.left&&a.handle.left.left?a.handle.left.left.pos:null,n=!o(r)&&a.handle.right&&a.handle.right.right?a.handle.right.right.pos:null;i&&n?this._moveManipulation.xyAxisManipulation.available=!1:i?e=ae(i,t):n&&(e=ae(t,n))}this._moveManipulation.angle=e,this._moveManipulation.radius=F}else this._moveManipulation.angleDeferred=()=>R(p(this.graphic.geometry)),this._moveManipulation.radius=C.radiusForSymbol(this.graphic.symbol);0!==t&&i?(y(e,e,1/t),oe.spatialReference=p(this._editGeometryHelper).geometry.spatialReference,oe.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(e,oe),this._moveManipulation.elevationAlignedLocation=oe):o(this._outlineVisualElement)&&!this._graphicState.isDraped&&o(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:V(this.view,this._moveManipulation,this.graphic)}_removeVertices(e){const t=[],i=p(this._editGeometryHelper);for(const a of e)if("vertex"===a.handle.type&&i.canRemoveVertex()){t.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.left)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.right));const e=p(i.removeVertices([a.handle]).removedVertices[0].createdEdge);e&&this._createVertexOrEdgeManipulator(e)}if(t.length>0){const e=t.map((e=>{const t=i.editGeometry.components.indexOf(e.component);return{coordinates:i.editGeometry.coordinateHelper.toArray(e.pos),componentIndex:t,vertexIndex:p(e.index)}}));this.outputGeometry=i.geometry;const a=this._updateEventState(2);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:e.map((e=>e.coordinates)),vertices:e}),this.destroyed)return;if(a&&(this._updateEventState(0),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(e,t,i=("start"===t.action?0:1)){const a=p(this._editGeometryHelper);a.moveVertices(e.map((e=>e.handle)),t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i),this.outputGeometry=a.geometry;for(const r of e)this._updateManipulatorPosition(r)}_offsetEdge(e,t){if(l(t.operation))return;const i=p(this._editGeometryHelper),a=t.operation.clone();a.distance=t.operation.signedDistanceToPoint(t.mapEnd),i.updateVertices([e.handle.left,e.handle.right],a),this.outputGeometry=i.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.left)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.right))}_manipulatorClickCallback(e,t){e.shiftKey||this._clearSelection(),"vertex"===t.handle.type&&(t.manipulator.selected=!t.manipulator.selected),"vertex"===t.handle.type&&2===e.button&&this._removeVertices([t]),ne(t)&&0===e.button&&this._splitEdgeManipulator(t),e.stopPropagation()}};function ae(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function re(e){return"vertex"===e.handle.type}function ne(e){return"edge"===e.handle.type}e([u({constructOnly:!0})],ie.prototype,"tool",void 0),e([u()],ie.prototype,"inputGeometry",null),e([u()],ie.prototype,"outputGeometry",void 0),e([u({readOnly:!0})],ie.prototype,"updating",null),ie=e([c("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],ie);const oe=H(0,0,null,null),se=G();var le;!function(e){e.Vertex=16,e.Edge=32}(le||(le={}));export{ie as ReshapeOperation};
