/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../core/Accessor.js";import r from"../../../core/Evented.js";import{destroyMaybe as s,isNone as o,isSome as i}from"../../../core/maybe.js";import{createResolver as n,isAbortError as a}from"../../../core/promiseUtils.js";import{property as c}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import"../../../core/Logger.js";import{subclass as l}from"../../../core/accessorSupport/decorators/subclass.js";import{ElevationQuery as h}from"../layers/graphics/ElevationQuery.js";let p=class extends(r.EventedMixin(t)){constructor(e){super(e),this.im=new Array,this.ground=new Array,this.scene=new Array,this.handles=new Map}destroy(){this._elevationQuery=s(this._elevationQuery)}get elevationQuery(){return o(this._elevationQuery)&&(this._elevationQuery=new h(this.view.resourceController.scheduler,this.view.spatialReference,(()=>this.view.map&&this.view.map.ground),{maximumAutoTileRequests:4})),this._elevationQuery}getElevation(e,t,r,s,i){let n=null;return n=u(n,this.im,e,t,r,s,i),o(n)&&(n=u(n,this.ground,e,t,r,s,i)),"scene"===i&&(n=u(n,this.scene,e,t,r,s,i)),n}queryElevation(e,t,r,s,o,i=null,c=0){const l=n();return this.elevationQuery.queryElevation(e,t,i,c).then((i=>{"scene"===o&&(i=u(i,this.scene,e,t,r,s,o)),l.resolve(i)})).catch((i=>{a(i)?l.reject(i):l.resolve(this.getElevation(e,t,r,s,o))})),l.promise}register(e,t){this.handles.set(t,t.on("elevation-change",(e=>this.emit("elevation-change",e)))),this[e].push(t)}unregister(e){this.handles.has(e)&&(this.handles.get(e).remove(),this.handles.delete(e));for(const t of[this.im,this.ground,this.scene]){const r=t.indexOf(e);r>-1&&t.splice(r,1)}}};function u(e,t,r,s,o,n,a){for(const c of t){const t=c.getElevation(r,s,o,n,a);i(t)&&(e=i(e)?Math.max(t,e):t)}return e}e([c({constructOnly:!0})],p.prototype,"view",void 0),e([c({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],p.prototype,"spatialReference",void 0),p=e([l("esri.views.3d.support.CombinedElevationProvider")],p);export{p as CombinedElevationProvider};
