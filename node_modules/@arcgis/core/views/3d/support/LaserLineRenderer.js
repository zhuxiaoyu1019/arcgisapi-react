/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{deg2rad as e}from"../../../core/mathUtils.js";import{isSome as t,isNone as i,disposeMaybe as n,releaseMaybe as s}from"../../../core/maybe.js";import{a as r}from"../../../chunks/vec2f64.js";import{g as a,m as h,i as l,n as c,c as o,b as _}from"../../../chunks/vec3.js";import{c as d}from"../../../chunks/vec3f64.js";import{t as m}from"../../../chunks/vec4.js";import{c as p}from"../../../chunks/vec4f64.js";import{fromRay as f,getStart as g,getEnd as u,create as b}from"../../../geometry/support/clipRay.js";import{intersectClipRay as P}from"../../../geometry/support/frustum.js";import{create as V,copy as E,pointAt as D}from"../../../geometry/support/lineSegment.js";import{create as q,fromPositionAndNormal as L}from"../../../geometry/support/plane.js";import{wrap as S}from"../../../geometry/support/ray.js";import{c as U}from"../../../chunks/sphere.js";import{LaserlinePathData as R}from"./LaserlinePathData.js";import{createQuadVAO as x}from"../webgl-engine/lib/glUtil3D.js";import{inverseProjectionInfo as M}from"../webgl-engine/lib/Util.js";import{copyParameters as T,updateParameters as v}from"../webgl-engine/materials/internal/MaterialUtil.js";import{LaserlinePathTechniqueConfiguration as C,LaserlinePathTechnique as j}from"../webgl-engine/shaders/LaserlinePathTechnique.js";import{LaserlineTechniqueConfiguration as w,LaserlineTechnique as A}from"../webgl-engine/shaders/LaserlineTechnique.js";const y=d(),I=p(),O={glowColor:[1,.5,0],glowWidth:8,glowFalloff:8,innerColor:[1,1,1],innerWidth:1,globalAlpha:.75,angleCutoff:e(6),globalAlphaContrastBoost:2};function H(e,t,i,n){const s=y,r=I;h(s,t,n),a(r,i),r[3]=0,m(r,r,n),L(s,r,e)}class z{constructor(e,t={},i={contrastControlEnabled:!1}){this._renderCoordsHelper=e,this._config=i,this._technique=null,this._projInfo=p(),this._zScale=r(),this._heightManifoldEnabled=!1,this._heightManifoldTarget=d(),this._pointDistanceEnabled=!1,this._pointDistanceOrigin=d(),this._pointDistanceTarget=d(),this._lineVerticalPlaneEnabled=!1,this._lineVerticalPlaneSegment=V(),this._intersectsLineEnabled=!1,this._intersectsLineSegment=V(),this._intersectsLineRadius=3,this._intersectsLineInfinite=!1,this._pathVerticalPlaneEnabled=!1,this._pathVerticalPlaneData=null,this._pathTechnique=null,this.canRender=!0,this._tempNormal=d(),this._tempDir=d(),this._tempUp=d(),this._tempVec3A=d(),this._tempVec3B=d(),this._tempVec4=p(),this._tempPlane=q(),this._tempSphere=U(),this._params=T(t,O)}get renderSlots(){return[this._config.contrastControlEnabled?17:16]}get needsLinearDepth(){return!0}get heightManifoldEnabled(){return this._heightManifoldEnabled}set heightManifoldEnabled(e){this._heightManifoldEnabled!==e&&(this._heightManifoldEnabled=e,this._requestRender())}get heightManifoldTarget(){return this._heightManifoldTarget}set heightManifoldTarget(e){a(this._heightManifoldTarget,e),this._requestRender()}get pointDistanceEnabled(){return this._pointDistanceEnabled}set pointDistanceEnabled(e){e!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=e,this._requestRender())}get pointDistanceTarget(){return this._pointDistanceTarget}set pointDistanceTarget(e){a(this._pointDistanceTarget,e),this._requestRender()}get pointDistanceOrigin(){return this._pointDistanceOrigin}set pointDistanceOrigin(e){a(this._pointDistanceOrigin,e),this._requestRender()}get lineVerticalPlaneEnabled(){return this._lineVerticalPlaneEnabled}set lineVerticalPlaneEnabled(e){e!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=e,this._requestRender())}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){E(e,this._lineVerticalPlaneSegment),this._requestRender()}get intersectsLineEnabled(){return this._intersectsLineEnabled}set intersectsLineEnabled(e){e!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=e,this._requestRender())}get intersectsLineSegment(){return this._intersectsLineSegment}set intersectsLineSegment(e){E(e,this._intersectsLineSegment),this._requestRender()}get intersectsLineRadius(){return this._intersectsLineRadius}set intersectsLineRadius(e){e!==this._intersectsLineRadius&&(this._intersectsLineRadius=e,this._requestRender())}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){e!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=e,this._requestRender())}get pathVerticalPlaneEnabled(){return this._pathVerticalPlaneEnabled}set pathVerticalPlaneEnabled(e){e!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=e,t(this._pathVerticalPlaneData)&&this._requestRender())}set pathVerticalPlaneVertices(e){i(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new R(this._renderCoordsHelper)),this._pathVerticalPlaneData.vertices=e,this.pathVerticalPlaneEnabled&&this._requestRender()}set pathVerticalPlaneBuffers(e){i(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new R(this._renderCoordsHelper)),this._pathVerticalPlaneData.buffers=e,this.pathVerticalPlaneEnabled&&this._requestRender()}setParameterValues(e){v(this._params,e)&&this._requestRender()}initializeRenderContext(e){this._context=e;const t=e.renderContext.rctx;this._quadVAO=x(t),this._techniqueRepository=e.shaderTechniqueRep,this._techniqueConfig=new w;const i=new C;i.contrastControlEnabled=this._config.contrastControlEnabled,this._pathTechnique=this._techniqueRepository.acquire(j,i)}uninitializeRenderContext(){this._quadVAO=n(this._quadVAO),this._technique=s(this._technique),this._pathVerticalPlaneData=n(this._pathVerticalPlaneData),this._pathTechnique=s(this._pathTechnique)}render(e){const t=this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled,i=this.pathVerticalPlaneEnabled;if(!t&&!i)return!0;const n=e.camera;return M(n.projectionMatrix,n.fullWidth,n.fullHeight,this._projInfo,this._zScale),t&&this.renderUnified(e),i&&this.renderPath(e),!0}renderUnified(e){const t=e.rctx,i=this._selectTechnique(),n=i.program;t.useProgram(n),i.bindPipelineState(t),this._bindGlobalUniforms(e,n),this.bindHeightManifoldUniforms(e,n),this.bindPointDistanceUniforms(e,n),this.bindLineVerticalPlaneUniforms(e,n),this.bindIntersectsLineUniforms(e,n),i.bind(this._params,e.camera),t.bindVAO(this._quadVAO),t.drawArrays(5,0,4)}renderPath(e){if(i(this._pathVerticalPlaneData)||i(this._pathTechnique))return;const t=e.rctx,n=this._pathTechnique,s=n.program;t.useProgram(s),n.bindPipelineState(t),this._bindGlobalUniforms(e,s),n.bind(this._params,this._pathVerticalPlaneData.origin,e.camera),this._pathVerticalPlaneData.draw(e.rctx)}bindHeightManifoldUniforms(e,t){if(!this.heightManifoldEnabled)return;const i=this._tempVec3A,n=this._tempPlane;this._renderCoordsHelper.worldUpAtPosition(this._heightManifoldTarget,i),H(n,this._heightManifoldTarget,i,e.camera.viewMatrix),t.setUniform4fv("heightPlane",n)}bindPointDistanceUniforms(e,t){if(!this._pointDistanceEnabled)return;const i=e.camera,n=this._tempSphere;a(n,this._pointDistanceOrigin),h(n,n,i.viewMatrix),n[3]=l(this._pointDistanceOrigin,this._pointDistanceTarget),t.setUniform4f("pointDistanceSphere",n[0],n[1],n[2],n[3])}bindLineVerticalPlaneUniforms(e,t){if(!this._lineVerticalPlaneEnabled)return;const i=this._renderCoordsHelper,n=e.camera,s=this._tempPlane,r=this._tempVec3A,l=this._tempUp,d=this._tempDir,m=this._tempNormal;D(this._lineVerticalPlaneSegment,.5,r),i.worldUpAtPosition(r,l),c(d,this._lineVerticalPlaneSegment.vector),o(m,l,d),c(m,m),H(s,this._lineVerticalPlaneSegment.origin,m,n.viewMatrix),t.setUniform4fv("lineVerticalPlane",s);const p=this._tempVec3A;a(p,this._lineVerticalPlaneSegment.origin),i.setAltitude(p,0),h(p,p,n.viewMatrix),t.setUniform3fv("lineVerticalStart",p);const f=this._tempVec3B;_(f,this._lineVerticalPlaneSegment.origin,this._lineVerticalPlaneSegment.vector),i.setAltitude(f,0),h(f,f,n.viewMatrix),t.setUniform3fv("lineVerticalEnd",f)}bindIntersectsLineUniforms(e,t){if(!this._intersectsLineEnabled)return;const i=B,n=G;if(this._intersectsLineInfinite){const t=e.camera;if(f(S(this._intersectsLineSegment.origin,this._intersectsLineSegment.vector),k),k.c0=-Number.MAX_VALUE,!P(t.frustum,k))return;g(k,i),u(k,n)}else a(i,this._intersectsLineSegment.origin),_(n,this._intersectsLineSegment.origin,this._intersectsLineSegment.vector);const s=this._tempVec3A;h(s,i,e.camera.viewMatrix),t.setUniform3fv("intersectsLineStart",s);const r=this._tempVec4;a(r,this._intersectsLineSegment.vector),this._tempVec4[3]=0,m(this._tempVec4,this._tempVec4,e.camera.viewMatrix),h(n,n,e.camera.viewMatrix),t.setUniform3fv("intersectsLineEnd",n),c(r,r),t.setUniform3f("intersectsLineDirection",r[0],r[1],r[2]),t.setUniform1f("intersectsLineRadius",this._intersectsLineRadius)}_bindGlobalUniforms(e,t){const i=e.camera;t.setUniform4fv("projInfo",this._projInfo),t.setUniform2fv("zScale",this._zScale),t.setUniform2f("nearFar",i.near,i.far),this._heightManifoldEnabled?t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._heightManifoldTarget)):this._pointDistanceEnabled?t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._pointDistanceTarget)):this._lineVerticalPlaneEnabled&&t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._lineVerticalPlaneSegment.origin)),t.bindTexture(e.offscreenRenderingHelper.linearDepthTexture,"depthMap"),t.bindTexture(e.offscreenRenderingHelper.mainColorTexture,"frameColor")}_requestRender(){this._context&&this._context.requestRender()}_selectTechnique(){return this._techniqueConfig.heightManifoldEnabled=this.heightManifoldEnabled,this._techniqueConfig.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._techniqueConfig.pointDistanceEnabled=this.pointDistanceEnabled,this._techniqueConfig.intersectsLineEnabled=this.intersectsLineEnabled,this._techniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._technique=this._techniqueRepository.releaseAndAcquire(A,this._techniqueConfig,this._technique),this._technique}}const k=b(),B=d(),G=d();export{z as LaserLineRenderer};
