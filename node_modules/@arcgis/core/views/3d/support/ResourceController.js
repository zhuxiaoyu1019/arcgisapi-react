/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../core/Accessor.js";import r from"../../../core/Handles.js";import{destroyMaybe as s,removeMaybe as o}from"../../../core/maybe.js";import{addFrameTask as a}from"../../../core/scheduling.js";import{SecondsFromMilliseconds as i}from"../../../core/time.js";import{property as h}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import"../../../core/Logger.js";import{subclass as n}from"../../../core/accessorSupport/decorators/subclass.js";import{maxDownloadSlots as l,downloadSlotsPerClient as m}from"./index.js";import{newMemoryController as u}from"./MemoryController.js";import d from"./StreamDataLoader.js";import{ImmediateTask as c,newScheduler as p,TaskPriority as _}from"../../support/Scheduler.js";let y=class extends t{constructor(){super(...arguments),this.updating=!1}};function g(e,t=(()=>performance.now())){return new C.ResourceController({view:e,now:t})}var C;e([h({readOnly:!0})],y.prototype,"updating",void 0),y=e([n("esri.views.3d.support.ResourceController")],y),function(t){let g=class extends y{constructor(){super(...arguments),this._scheduler=null,this._memoryController=null,this._streamDataLoader=null,this._cameraChangeTime=0,this._handles=new r,this._frameTask=null,this._scheduleTask=c}initialize(){this._cameraChangeTime=this.now(),this._scheduler=p(this.now),this._memoryController=u(this.view),this._streamDataLoader=new d,this._streamDataLoader.setup(l,m,this._scheduler),this._handles.add([this.view.watch("state.camera",((e,t)=>this._cameraChangedHandler(e,t)),!0),this.view.watch("stationary",(()=>this._stationaryChangedHandler())),this._memoryController.events.on("updating-changed",(()=>this.notifyChange("updating")))]),this._frameTask=a({update:e=>this.frame(e)}),this._scheduleTask=this._scheduler.registerTask(_.RESOURCE_CONTROLLER)}destroy(){this._handles=s(this._handles),this._scheduleTask.remove(),this._frameTask=o(this._frameTask),this._streamDataLoader=s(this._streamDataLoader),this._memoryController=s(this._memoryController),this._scheduler=s(this._scheduler)}get updating(){var e,t;return!!(null!=(e=this._memoryController)&&e.updating||null!=(t=this._streamDataLoader)&&t.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}schedule(e,t,r){return this._scheduleTask.schedule(e,t,r)}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(r,s,o)=>t.request(r,s,e,o),get busy(){return!t.hasDownloadSlots(e)}}}frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(i(e.deltaTime)),!this._scheduler)||(this._scheduler.state=this.state,this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=this._scheduler.now,this._scheduler.state=this.state)}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get state(){const e=this.view;return e.animation?0:e.interacting||this._scheduler.now-this._cameraChangeTime<=C?1:2}get test(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e),state:this.state}}};e([h({constructOnly:!0})],g.prototype,"view",void 0),e([h({constructOnly:!0})],g.prototype,"now",void 0),e([h()],g.prototype,"_scheduler",void 0),e([h()],g.prototype,"_memoryController",void 0),e([h()],g.prototype,"_streamDataLoader",void 0),e([h({readOnly:!0})],g.prototype,"updating",null),g=e([n("esri.views.3d.support.ResourceController")],g),t.ResourceController=g;const C=300}(C||(C={}));export{y as ResourceControllerMain,g as newResourceController};
