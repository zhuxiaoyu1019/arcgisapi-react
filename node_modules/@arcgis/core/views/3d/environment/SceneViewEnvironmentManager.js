/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../Color.js";import r from"../../../core/Evented.js";import i from"../../../core/Handles.js";import{isSome as s,isNone as n,mapOr as o}from"../../../core/maybe.js";import{after as a}from"../../../core/promiseUtils.js";import{init as c}from"../../../core/watchUtils.js";import{property as h}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import"../../../core/Logger.js";import{subclass as d}from"../../../core/accessorSupport/decorators/subclass.js";import{s as l,a as p,g as _,e as m}from"../../../chunks/vec3.js";import{c as f,f as u}from"../../../chunks/vec3f64.js";import{b as P,f as g}from"../../../chunks/vec4f64.js";import{canProjectToWGS84ComparableLonLat as v,projectPointToWGS84ComparableLonLat as b}from"../../../geometry/projection.js";import{isEarth as C}from"../../../geometry/support/spatialReferenceUtils.js";import w from"./EnvironmentRenderer.js";import{positionToTimezoneInfo as U}from"../support/earthUtils.js";import{computeColorAndIntensity as y,computeDirection as T,computeShadowsEnabled as R}from"../support/sunUtils.js";import{MainLight as S,AmbientLight as M,FillLight as H}from"../webgl-engine/lighting/Lightsources.js";import G from"../../../webscene/background/ColorBackground.js";const L=u(.5773502691896258,-.5773502691896258,.5773502691896258);let W=class extends r.EventedAccessor{constructor(...e){super(...e),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new i,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this.referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new S,this._ambientLight=new M,this._moonLight=new H,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView(),this._viewHandles.destroy()}get updating(){return!!(!this.disableQueries&&(this._referencePosUpdateQuery||this._referencePosMapCoordsRequested)||this._renderer&&this._renderer.updating)}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){this._renderer||(this._view=e,this._renderer=new w({view:e}),this._viewHandles.add([e.watch("environment.lighting.date",(e=>this._lightingDateHandler(e)),!0),e.watch("stationary",(()=>this._interactingStationaryHandler())),e.watch(["environment.lighting.directShadowsEnabled","environment.lighting.ambientOcclusionEnabled","environment.lighting.waterReflectionEnabled","environment.background.color"],(()=>this._updateRenderParamsHandler()),!0),e.watch("spatialReference",(()=>this._resetReferencePosition(!0)),!0),c(e,"viewingMode",(()=>this._resetReferencePosition(!0)),!0),c(e,"environment.lighting.cameraTrackingEnabled",(e=>this._updateCameraTracking(e)),!0),c(e,"state.camera",(()=>this._cameraHandler(null)),!0),this.watch("disableQueries",(()=>this._cameraHandler(null)))]),this._updateRenderParamsHandler(),this._updateLightParams(),this._cameraHandler(),this.notifyChange("updating"))}disconnectView(){this._renderer&&(this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer.destroy(),this._renderer=null,this._view=null)}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;e&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){if(!e)return;const t=this._view.environment.lighting;if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const r=this._view.spatialReference;if(!v(r)){const e=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(e))return void this._requestReferencePositionUpdate(e)}if(this._preupdateTracking(e),s(this._referencePosWGS84Comparable)){const e=U(this._referencePosWGS84Comparable,k);s(e)&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLightParams(e)}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){if(!this._view.ready)return;const t=this._view.camera;t&&(this._cameraHandlerClientSide(t,e)||this._cameraHandlerServerSide(t))}_cameraHandlerClientSide(e,t){const r=C(this._view.spatialReference);if(r&&!v(this._view.spatialReference))return!1;const i=e.position;return n(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=f()),r?b(i,this._referencePosWGS84Comparable):l(this._referencePosWGS84Comparable,i.longitude,i.latitude,i.z),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLightParams(t),!0}_cameraHandlerServerSide(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=t.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLightParams(e){const t=this._view.environment.lighting;e=e||t.date;const r=this._view._stage;let i;s(this._referencePosWGS84Comparable)?(i=y(e,this._referencePosWGS84Comparable),T(e,this._referencePosWGS84Comparable,this._view.viewingMode,i.diffuse.directionToLightSource)):i={diffuse:{color:[1,1,1],intensity:.55,directionToLightSource:L},ambient:{color:[1,1,1],intensity:.55},noonFactor:.5,globalFactor:0},p(this._mainLight.intensity,i.diffuse.color,i.diffuse.intensity*Math.PI),_(this._mainLight.direction,i.diffuse.directionToLightSource),p(this._ambientLight.intensity,i.ambient.color,i.ambient.intensity),m(this._moonLight.intensity,E,D,i.globalFactor);const n=(1-.5*i.globalFactor)*(1-.4*i.noonFactor*(1-i.globalFactor));p(this._moonLight.intensity,this._moonLight.intensity,n),_(this._moonLight.direction,i.diffuse.directionToLightSource),r.renderView.updateLightSources([this._mainLight,this._ambientLight,this._moonLight],1-i.noonFactor,i.globalFactor),this._updateRenderParamsHandler()}_autoUpdateTimezone(e,t=null){if(!this._view.environment.lighting.cameraTrackingEnabled||n(e))return!1;const r=j;r.setTime((t||this._view.environment.lighting.date).getTime());const i=U(e,k);if(n(i))return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===i.hours&&s.minutes===i.minutes&&s.seconds===i.seconds)return!1}else s=i;const o=r.getUTCHours()-(i.hours-s.hours),a=r.getUTCMinutes()-(i.minutes-s.minutes),c=r.getUTCSeconds()-(i.seconds-s.seconds);return r.setUTCHours(o),r.setUTCMinutes(a),r.setUTCSeconds(c),!t&&this._view.environment.lighting.autoUpdate(r,i)}_updateRenderParamsHandler(){const e=this._view._stage;if(!e)return;const r=o(this._referencePosWGS84Comparable,!0,(e=>R(e,this._view.viewingMode))),i=this._view.environment.background,s=i instanceof G?{type:"color",color:P(t.toUnitRGBA(i.color))}:{type:"color",color:g(0,0,0,1)};e.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&r,ssao:this._view.environment.lighting.ambientOcclusionEnabled,waterReflectionEnabled:this._view.environment.lighting.waterReflectionEnabled,background:s})}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler(null)}_requestReferencePositionUpdate(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this.referencePosUpdateTimer&&this._view.stationary)){const e=this._referencePosUpdateQuery=a(this._referencePointUpdateDelay).then((()=>{if(this._referencePosUpdateQuery===e){const t=()=>this._referencePosUpdateQuery!==e;return this._doReferencePositionUpdateQuery(t)}})).catch((e=>{"mapcoordshelper:missing-geometry-service"===e.name&&(this.disableQueries=!0)})).then((()=>{this._referencePosUpdateQuery===e&&(this._referencePosUpdateQuery=null,this.referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))})),t=this.referencePosUpdateTimer=a(this._referencePointUpdateInterval).then((()=>{this.referencePosUpdateTimer===t&&(this.referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())}));this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const e=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=e):this._referencePosWGS84Comparable=[t[0],t[1],e],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLightParams(),this.notifyChange("referencePositionWGS84Comparable")}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this.referencePosUpdateTimer=null,e}get test(){const e=this;return{renderer:this._renderer,set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e.referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t}}}};W.FIXED_LIGHT_DIRECTION=L,e([h({type:Boolean,readOnly:!0})],W.prototype,"updating",null),e([h()],W.prototype,"disableQueries",void 0),e([h()],W.prototype,"referencePositionWGS84Comparable",null),e([h()],W.prototype,"_renderer",void 0),e([h()],W.prototype,"_referencePosWGS84Comparable",void 0),W=e([d("esri.views.3d.environment.SceneViewEnvironmentManager")],W);const j=new Date,k={hours:0,minutes:0,seconds:0},E=u(.22,.22,.33),D=u(.22,.22,.22);var Q=W;export default Q;export{W as SceneViewEnvironmentManager};
