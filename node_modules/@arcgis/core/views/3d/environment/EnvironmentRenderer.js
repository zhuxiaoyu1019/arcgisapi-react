/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../core/Accessor.js";import"../../../core/has.js";import s from"../../../core/Handles.js";import{isSome as r,destroyMaybe as i,isNone as n}from"../../../core/maybe.js";import{when as o,init as h}from"../../../core/watchUtils.js";import{property as a}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/accessorSupport/ensureType.js";import"../../../core/Logger.js";import{subclass as p}from"../../../core/accessorSupport/decorators/subclass.js";import{isMoon as m,isMars as d}from"../../../geometry/support/spatialReferenceUtils.js";import l from"./PanoramicAtmosphere.js";import{RealisticAtmosphere as _}from"./RealisticAtmosphere.js";import u from"./SimpleAtmosphere.js";import{Stars as c}from"./Stars.js";const v=[14,15];let g=class extends t{constructor(){super(...arguments),this._handles=new s,this._context=null,this._pendingAtmosphere=null,this._atmosphere=null,this._stars=null}get canRender(){return!(!this.view.basemapTerrain||!this.view.basemapTerrain.renderer.canRender)||"global"!==this.view.viewingMode}get updating(){return r(this._pendingAtmosphere)||r(this._stars)&&this._stars.updating}initialize(){this.view._stage.addRenderPlugin(v,this)}destroy(){this._pendingAtmosphere=i(this._pendingAtmosphere),this._atmosphere=i(this._atmosphere),this._stars=i(this._stars),this._handles=i(this._handles),this.view&&null!=this.view._stage&&(this.view._stage.removeRenderPlugin(this),this._set("view",null))}initializeRenderContext(e){this._context=e,this.setup()}setup(){this._handles.add(o(this.view,"basemapTerrain",(()=>this._updateBasemapTerrain()),!0)),this._handles.add([h(this.view,["viewingMode","environment.atmosphereEnabled","environment.atmosphere.quality"],(()=>this._updateAtmosphere()),!0),h(this.view,"environment.starsEnabled",(()=>this._updateStars()),!0)])}uninitializeRenderContext(){r(this._stars)&&(this._stars.uninitializeRenderContext(),this._stars.destroy(),this._stars=null),r(this._atmosphere)&&(this._atmosphere.uninitializeRenderContext(),this._atmosphere.destroy(),this._atmosphere=null)}render(e){let t=!0;return r(this._stars)&&this._stars.canRender&&(t=this._stars.render(e)&&t),r(this._atmosphere)&&this._atmosphere.canRender&&(t=this._atmosphere.render(e)&&t),t}_setNeedsRender(){this._context&&this._context.requestRender()}_updateStars(){var e,t,s;const i=null!=(e=null==(t=this.view)||null==(s=t.environment)?void 0:s.starsEnabled)&&e;i&&n(this._stars)?(this._stars=new c({view:this.view}),this._stars.initializeRenderContext(this._context),this._setNeedsRender()):!i&&r(this._stars)&&(this._stars.destroy(),this._stars=null,this._setNeedsRender())}_updateAtmosphere(){const e=this._getAtmosphereType();if(this.atmosphereType===e)return;this.atmosphereType=e,r(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const t=this._getAtmosphereClass();if(!t)return r(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const s=new t(this.view);s.initializeRenderContext(this._context),n(this._atmosphere)&&(this._atmosphere=s,this._setNeedsRender()),this._pendingAtmosphere=s,s.when().then((()=>{r(this._atmosphere)&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain()})).catch((()=>{this._pendingAtmosphere===s&&(this._pendingAtmosphere=null)}))}_getAtmosphereClass(){const e=this._getAtmosphereType();if(this.atmosphereClassFromType)return this.atmosphereClassFromType(e);switch(e){case"none":return null;case"realistic":return _;case"panoramic":return l;case"simple":return u;default:return}}_getAtmosphereType(){const e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),s=this.view.viewingMode;return!e||null==t||m(this.view.spatialReference)?"none":"local"===s?"panoramic":"high"===t&&_.isSupported(this._context)&&!d(this.view.spatialReference)?"realistic":"simple"}_updateBasemapTerrain(){const e=this.view.basemapTerrain;e&&(e.velvetOverground=null!=this._atmosphere&&"simple"===this.atmosphereType)}get test(){return{atmosphere:this._atmosphere}}};e([a({constructOnly:!0})],g.prototype,"view",void 0),e([a({constructOnly:!0})],g.prototype,"atmosphereClassFromType",void 0),e([a()],g.prototype,"updating",null),e([a()],g.prototype,"_pendingAtmosphere",void 0),e([a()],g.prototype,"_stars",void 0),g=e([p("esri.views.3d.environment.EnvironmentRenderer")],g);var w=g;export default w;
