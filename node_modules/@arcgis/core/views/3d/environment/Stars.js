/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as t}from"../../../chunks/tslib.es6.js";import{fetchAsset as e}from"../../../assets.js";import s from"../../../core/Accessor.js";import r from"../../../core/Error.js";import i from"../../../core/Logger.js";import{isSome as a,abortMaybe as o,disposeMaybe as n,isNone as c}from"../../../core/maybe.js";import{createTask as f,isAbortError as u}from"../../../core/promiseUtils.js";import{property as h}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import{subclass as d}from"../../../core/accessorSupport/decorators/subclass.js";import{d as p,r as m,m as l}from"../../../chunks/mat4.js";import{c as _,f as g}from"../../../chunks/mat4f64.js";import{StarsTechnique as b}from"./StarsTechnique.js";import{glLayout as y}from"../support/buffer/glUtil.js";import{newLayout as v}from"../support/buffer/InterleavedLayout.js";import{Default3D as w}from"../webgl-engine/lib/DefaultVertexAttributeLocations.js";import{WatchUpdatingTracking as j}from"../../support/WatchUpdatingTracking.js";import k from"../../webgl/BufferObject.js";import x from"../../webgl/VertexArrayObject.js";const T=i.getLogger("esri.views.3d.environment.Stars");let D=class extends s{constructor(t){super(t),this.slot=14,this._loadDataTask=null,this._numPoints=0,this._modelMatrix=_(),this._updatingTracking=new j,this._requestRender=()=>{}}get updating(){return this._updatingTracking.updating||this.loading}get loading(){return a(this._loadDataTask)&&!this._loadDataTask.finished}get canRender(){return!this.loading}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=o(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=n(this._technique),this._vao=n(this._vao),this._requestRender=null}initializeRenderContext(t){this._requestRender=t.requestRender}uninitializeRenderContext(){this.destroy()}render(t){if(t.slot!==this.slot||0!==t.pass)return!1;if(this._ensureResources(t),c(this._technique)||c(this._vao))return!0;const e=t.rctx,s=this._technique.program;return e.useProgram(s),this._technique.bindPass({camera:t.camera,modelMatrix:this._modelMatrix}),this._technique.bindPipelineState(e),e.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),e.drawArrays(0,0,this._numPoints),!0}_ensureResources(t){if(a(this._technique)||c(S))return;const e=t.rctx;this._technique=new b({rctx:e,viewingMode:this.view.state.viewingMode},null),this._numPoints=S.byteLength/R;const s=new Float32Array(S,0,2*this._numPoints),r=new Uint8Array(S,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(t.rctx,s,r,this._numPoints),this._updatingTracking.add(this.view,"environment.lighting.date",(t=>this._update(t)),2)}_computeDayDuration(t){const e=t,s=new Date(t.getFullYear(),0,1,11,58,56);return(+e-+s)/(+new Date(t.getFullYear()+1,0,1,11,58,55)-+s)}_update(t){if(!t)return;const e=(t.getHours()/12+t.getMinutes()/60*(2/24)+t.getSeconds()/60*(2/1440)-.9972222)%2,s=2*this._computeDayDuration(t),r=this._modelMatrix;p(r,P),m(r,r,-s*Math.PI),l(r,M,r),m(r,r,-e*Math.PI),this._requestRender()}_hexToRGB(t){return[parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16),parseInt(t.substring(4,6),16)]}_unpackUint8Attributes(t){return t>=192?[2.9,t-192]:t>=160?[2.5,t-160]:t>=128?[2,t-128]:t>=96?[1.5,t-96]:t>=64?[1,t-64]:t>=32?[.7,t-32]:[.4,t]}_createVertexArrayObject(t,e,s,r){const i=A.createBuffer(r),a=i.position,o=i.color,n=i.size;for(let c=0;c<r;c++){const t=e[2*c+0],r=e[2*c+1];a.set(c,0,-Math.cos(t)*Math.sin(r)),a.set(c,1,-Math.sin(t)*Math.sin(r)),a.set(c,2,-Math.cos(r));const i=this._unpackUint8Attributes(s[c]),f=this._hexToRGB(q[i[1]]);o.set(c,0,255*f[0]),o.set(c,1,255*f[1]),o.set(c,2,255*f[2]),o.set(c,3,255),n.set(c,i[0])}return new x(t,w,{geometry:y(A)},{geometry:k.createVertex(t,35044,i.buffer)})}_createLoadDataTask(){if(a(S))return null;const t=f((async t=>{const{data:s}=await e("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});this._verifyStarData(s),S=s}));return t.promise.catch((t=>{u(t)||T.error(t)})).then((()=>{this.destroyed||(this._requestRender(),this.notifyChange("updating"))})),t}_verifyStarData(t){if(!t)throw new r("stars:no-data-received","Failed to create stars because star catalogue is missing");const e=t.byteLength/R;if(e%1!=0||e>5e4||e<5e3)throw new r("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};t([h({constructOnly:!0})],D.prototype,"view",void 0),t([h({readOnly:!0})],D.prototype,"updating",null),t([h()],D.prototype,"_loadDataTask",void 0),t([h()],D.prototype,"_updatingTracking",void 0),D=t([d("esri.views.3d.environment.Stars")],D);const q=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],M=g(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),P=g(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),R=9,A=v().vec3f("position").vec4u8("color").f32("size");let S=null;export{D as Stars};
