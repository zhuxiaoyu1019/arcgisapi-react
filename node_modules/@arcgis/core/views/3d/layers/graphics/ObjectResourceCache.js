/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../../../../core/Handles.js";import{timeoutHandle as t}from"../../../../core/handleUtils.js";import{isSome as r}from"../../../../core/maybe.js";import{isAborted as o,createAbortError as s,onAbort as i,createAbortController as a}from"../../../../core/promiseUtils.js";import{DefaultLoadingContext as n}from"../../glTF/DefaultLoadingContext.js";import{load as l}from"../../glTF/loader.js";import{load as c}from"./wosrLoader.js";class m{constructor(){this.gltfCache=new Map,this.wosrCache=new Map,this.evictHandles=new e}loadGLTF(e,t,r){const o=r?`gltfPBR:${e}`:`gltf:${e}`;return this.fromCache(this.gltfCache,o,(t=>l(new n(t.streamDataRequester),e,t,r)),t)}loadWOSR(e,t){const r=`wosr:${e}:${t.disableTextures}`;return this.fromCache(this.wosrCache,r,(t=>c(e,t)),t)}destroy(){this.evictHandles.destroy(),this.gltfCache.clear(),this.wosrCache.clear()}get size(){return this.wosrCache.size+this.gltfCache.size}fromCache(e,t,n,l){return new Promise(((c,m)=>{if(o(l))return void m(s());const h=i(l,(()=>{this.remove(e,t),m(s())})),f=e.get(t);if(f)return this.evictHandles.remove(t),f.refCount++,void f.item.then(c,m);const d=a(),C={...l,signal:d.signal},v={refCount:1,abortController:d,item:n(C).then((r=>(v.abortController=null,r.remove=()=>this.remove(e,t),r)))};e.set(t,v),v.item.then((e=>{r(h)&&h.remove(),c(e)}),(e=>{r(h)&&h.remove(),m(e)}))}))}remove(e,o){const s=e.get(o);s&&(s.refCount--,0===s.refCount&&this.evictHandles.add(t((()=>{e.delete(o),r(s.abortController)&&s.abortController.abort()}),f),o))}}const h=1e4;let f=h;const d={overrideEvictDelay:e=>(f=e,{remove(){f=h}})};export{m as ObjectResourceCache,d as test};
