/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{neverReached as e}from"../../../../core/compilerUtils.js";import{unwrapOr as t}from"../../../../core/maybe.js";import{d as n}from"../../../../chunks/mat4.js";import{c as o}from"../../../../chunks/mat4f64.js";import{c as r}from"../../../../chunks/vec3f64.js";import{projectBuffer as i,computeLinearTransformation as s}from"../../../../geometry/projection.js";import{isDehydratedPoint as a}from"../../../../layers/graphics/dehydratedFeatureUtils.js";import{updateVertexAttributeAuxpos1w as l}from"./graphicUtils.js";import{isSamplePosition as c,getElevationAtPoint as u}from"../../support/ElevationProvider.js";function f(e,t,n,o,r,s,a,l,c,u,f){const m=j[f.mode];let d,p,g=0;if(i(e,t,n,o,c.spatialReference,r,l))return m.requiresAlignment(f)?(g=m.applyElevationAlignmentBuffer(o,r,s,a,l,c,u,f),d=s,p=a):(d=o,p=r),i(d,c.spatialReference,p,s,u.spatialReference,a,l)?g:void 0}function m(n,o,r,i,s){const l=(a(n)?n.z:c(n)?n.array[n.offset+2]:n[2])||0;switch(r.mode){case"on-the-ground":{const e=t(u(o,n,"ground"),0);return s&&(s.verticalDistanceToGround=0,s.sampledElevation=e),e}case"relative-to-ground":{const e=t(u(o,n,"ground"),0),a=r.geometryZWithOffset(l,i);return s&&(s.verticalDistanceToGround=a,s.sampledElevation=e),a+e}case"relative-to-scene":{const e=t(u(o,n,"scene"),0),a=r.geometryZWithOffset(l,i);return s&&(s.verticalDistanceToGround=a,s.sampledElevation=e),a+e}case"absolute-height":{const e=r.geometryZWithOffset(l,i);if(s){const r=t(u(o,n,"ground"),0);s.verticalDistanceToGround=e-r,s.sampledElevation=r}return e}default:return e(r.mode),0}}function d(e,t,n){return null==t||null==n?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===n?e.staysOnTheGround:t===n||"on-the-ground"!==t&&"on-the-ground"!==n?T.UPDATE:e.onTheGroundChanged}function p(e){return"relative-to-ground"===e||"relative-to-scene"===e}function g(e){return"absolute-height"!==e}function v(e,t,o,r,i){const a=m(t,o,i,r,O);l(e,O.verticalDistanceToGround);const c=O.sampledElevation,u=n(x,e.transformation);U[0]=t.x,U[1]=t.y,U[2]=a;return s(t.spatialReference,U,u,r.spatialReference)?e.transformation=u:console.warn("Could not locate symbol object properly, it might be misplaced"),c}function E(e,n,o,r,i,s){let a=0;const l=s.spatialReference;n*=3,r*=3;for(let c=0;c<i;++c){const i=e[n+0],c=e[n+1],u=e[n+2],f=t(s.getElevation(i,c,u,l,"ground"),0);a+=f,o[r+0]=i,o[r+1]=c,o[r+2]=f,n+=3,r+=3}return a/i}function h(e,n,o,r,i,s,a,l){let c=0;const u=l.calculateOffsetRenderUnits(a),f=l.featureExpressionInfoContext,m=s.spatialReference;n*=3,r*=3;for(let d=0;d<i;++d){const i=e[n+0],a=e[n+1],l=e[n+2],d=t(s.getElevation(i,a,l,m,"ground"),0);c+=d,o[r+0]=i,o[r+1]=a,o[r+2]=null==f?l+d+u:d+u,n+=3,r+=3}return c/i}function y(e,n,o,r,i,s,a,l){let c=0;const u=l.calculateOffsetRenderUnits(a),f=l.featureExpressionInfoContext,m=s.spatialReference;n*=3,r*=3;for(let d=0;d<i;++d){const i=e[n+0],a=e[n+1],l=e[n+2],d=t(s.getElevation(i,a,l,m,"scene"),0);c+=d,o[r+0]=i,o[r+1]=a,o[r+2]=null==f?l+d+u:d+u,n+=3,r+=3}return c/i}function A(e){const t=e.meterUnitOffset,n=e.featureExpressionInfoContext;return 0!==t||null!=n}function R(e,t,n,o,r,i,s,a){const l=a.calculateOffsetRenderUnits(s),c=a.featureExpressionInfoContext;t*=3,o*=3;for(let u=0;u<r;++u){const r=e[t+0],i=e[t+1],s=e[t+2];n[o+0]=r,n[o+1]=i,n[o+2]=null==c?s+l:l,t+=3,o+=3}return 0}var T;!function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"}(T||(T={}));const j={"absolute-height":{applyElevationAlignmentBuffer:R,requiresAlignment:A},"on-the-ground":{applyElevationAlignmentBuffer:E,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:h,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:y,requiresAlignment:()=>!0}},x=o(),O={verticalDistanceToGround:0,sampledElevation:0},U=r();export{T as SymbolUpdateType,v as applyElevationAlignmentForHUD,f as applyPerVertexElevationAlignment,d as elevationModeChangeUpdateType,m as evaluateElevationAlignmentAtPoint,p as needsElevationUpdates2D,g as needsElevationUpdates3D};
