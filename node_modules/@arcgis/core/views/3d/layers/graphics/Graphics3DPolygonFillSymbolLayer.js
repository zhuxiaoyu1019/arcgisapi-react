/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../../../../Color.js";import{isSome as t,get as i,isNone as r,unwrap as n}from"../../../../core/maybe.js";import{pt2px as o}from"../../../../core/screenUtils.js";import{e as a}from"../../../../chunks/earcut.js";import{I as s}from"../../../../chunks/mat4f64.js";import{s as l}from"../../../../chunks/vec4.js";import{empty as u,expandWithBuffer as p,intersectsClippingArea as c,expandWithAABB as h,create as m}from"../../../../geometry/support/aaBoundingBox.js";import{BufferViewMat3f64 as d,BufferViewVec3f64 as _,BufferViewVec4f as y}from"../../../../geometry/support/buffer/BufferView.js";import{elevationModeChangeUpdateType as g,SymbolUpdateType as f,needsElevationUpdates2D as b}from"./elevationAlignmentUtils.js";import{ElevationContext as M}from"./ElevationContext.js";import E from"./Graphics3DDrapedGraphicLayer.js";import{Graphics3DObject3DGraphicLayer as x}from"./Graphics3DObject3DGraphicLayer.js";import{Graphics3DSymbolLayer as v}from"./Graphics3DSymbolLayer.js";import{mixinColorAndOpacity as O}from"./graphicUtils.js";import{createGeometry as D}from"./lineUtils.js";import{geometryAsPolygon as A,geometryToRenderInfo as S,createColorGeometry as P,geometryToRenderInfoDraped as C}from"./polygonUtils.js";import{createMaterial as U,uvElevationAligner as G}from"../support/patternUtils.js";import{createMapSpaceUVCoords as w,createMapSpaceUVCoordsDraped as j}from"../support/uvUtils.js";import{Object3D as T}from"../../webgl-engine/lib/Object3D.js";import{RenderGeometry as R}from"../../webgl-engine/lib/RenderGeometry.js";import{createStipplePattern as B}from"../../webgl-engine/materials/lineStippleUtils.js";import{NativeLineMaterial as L}from"../../webgl-engine/materials/NativeLineMaterial.js";import{PatternMaterial as N}from"../../webgl-engine/materials/PatternMaterial.js";import{RibbonLineMaterial as V}from"../../webgl-engine/materials/RibbonLineMaterial.js";const F=["polyline","polygon","extent"];class I extends v{constructor(e,t,i,r){super(e,t,i,r),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}ensureMaterials(){this.ensureFillMaterial(),this.ensureOutlineMaterial()}ensureFillMaterial(){if(t(this._material))return;const e=i(this.symbolLayer,"material","color"),r=this._getCombinedOpacityAndColor(e);this._material=U(this.symbolLayer,{color:r,transparent:r[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,writeLinearDepth:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof N,this._context.stage.add(this._material)}ensureOutlineMaterial(){const i=this.symbolLayer.outline;if(t(this._outlineMaterial)||!this._isValidOutline(i))return;this._hasOutline=!0;const r=t=>{const r=i.stipplePattern?B(i.stipplePattern.map(o)):null,n=i.stippleOffColor?e.toUnitRGBA(i.stippleOffColor):null;return t>1.5?new V({width:t,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:r,stippleIntegerRepeats:!0,stippleOffColor:n}):new L({color:this._getOutlineColor(),slicePlaneEnabled:this._context.slicePlaneEnabled,width:t,stipplePattern:r,stippleIntegerRepeats:!0,stippleOffColor:n})};this._outlineMaterial=r(o(i.size)),this._context.stage.add(this._outlineMaterial)}_isValidOutline(e){return t(e)&&e.size&&e.size>0&&t(e.color)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,F,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new M);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.ensureMaterials(),this.draped?this._createAsOverlay(t,i):this._createAs3DShape(t,i,r)}layerOpacityChanged(){if(t(this._material)){const e=this._material.params.color,t=i(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(t);this._material.setParameterValues({color:[e[0],e[1],e[2],r],transparent:r<1||this.needsDrivenTransparentPass})}if(t(this._outlineMaterial)){const e=this._outlineMaterial.params.color;this._outlineMaterial.setParameterValues({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}return!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=g(I.elevationModeChangeTypes,i,r);if(n!==f.UPDATE)return n;const o=b(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>o))}slicePlaneEnabledChanged(){if(t(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),t(this._outlineMaterial)){const e={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameterValues(e)}return!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,t,i){const n=A(e.geometry);if(r(n))return null;z.renderData=S(n,this._context.elevationProvider,this._context.renderCoordsHelper,i),z.color=t;const o=z.renderData.position.length/3;if(this._needsUV&&(z.uvMapSpace=new Float32Array(4*o),z.boundingRect=new Float64Array(9*o)),z.outNum=0,z.outGeometries=[],z.outTransforms=[],z.outMaterials=[],this._createAs3DShapeFill(z),this._hasOutline&&this._createAs3DShapeOutline(z),this._logGeometryCreationWarnings(z.renderData,n.rings,"rings","FillSymbol3DLayer"),0===z.outNum)return null;this._needsUV&&w(y.fromTypedArray(z.uvMapSpace),_.fromTypedArray(z.renderData.position),this._context.renderCoordsHelper,d.fromTypedArray(z.boundingRect));const a=new T({geometries:z.outGeometries,materials:z.outMaterials,transformations:z.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),s=G,l=new x(this,a,z.outGeometries,null,null,s,i);return l.alignedSampledElevation=z.renderData.sampledElevation,l.needsElevationUpdates=b(i.mode),l}_createAs3DShapeFill(e){const i=e.renderData.polygons;for(const{position:r,mapPosition:o,holeIndices:l,index:h,count:m}of i){if(t(this._context.clippingExtent)&&(u(k),p(k,o),!c(k,this._context.clippingExtent)))continue;const i=a(o,l,3);if(0===i.length)continue;const d=new Uint32Array(i),_=P({indices:d,attributeData:{position:r,color:e.color,mapPosition:o,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*h*e.uvMapSpace.BYTES_PER_ELEMENT,4*m):null,boundingRect:this._needsUV?new Float64Array(e.boundingRect.buffer,9*h*e.boundingRect.BYTES_PER_ELEMENT,9*m):null}});e.outGeometries.push(_),e.outMaterials.push(n(this._material)),e.outTransforms.push(s),e.outNum++}}_createAs3DShapeOutline(e){if(!this._hasOutline)return;const i=e.renderData.outlines,r=this._outlineMaterial instanceof L;for(let o=0;o<i.length;++o){const{mapPosition:a,position:l}=i[o];if(t(this._context.clippingExtent)&&(u(k),p(k,a),!c(k,this._context.clippingExtent)))continue;const h=D({removeDuplicateStartEnd:r?0:1,attributeData:{position:l,mapPosition:a}}),m=h.vertexAttributes.get("position");m.data===l&&(m.data=new Float64Array(l)),e.outGeometries.push(h),e.outMaterials.push(n(this._outlineMaterial)),e.outTransforms.push(s),e.outNum++}}_createAsOverlay(e,i){const o=A(e.geometry);if(r(o))return null;n(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,t(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),Y.renderData=C(o,this._context.overlaySR),Y.color=i;const a=Y.renderData.position.length/3;return this._needsUV&&(Y.uvMapSpace=new Float32Array(4*a)),Y.outNum=0,Y.outGeometries=[],Y.outBoundingBox=u(),Y.layerUid=this._context.layer.uid,Y.graphicsUid=e.uid,this._createAsOverlayFill(Y),this._hasOutline&&this._createAsOverlayOutline(Y),this._logGeometryCreationWarnings(Y.renderData,o.rings,"rings","FillSymbol3DLayer"),0===Y.outNum?null:(this._needsUV&&j(y.fromTypedArray(Y.uvMapSpace),_.fromTypedArray(Y.renderData.position),this._context.overlaySR),Y.outNum>0?new E(this,Y.outGeometries,Y.outBoundingBox):null)}_createAsOverlayFill(e){const t=e.renderData.polygons;for(const{position:i,holeIndices:r,index:o,count:s}of t){if(u(k),p(k,i),!c(k,this._context.clippingExtent))continue;const t=a(i,r,3);if(0===t.length)continue;h(e.outBoundingBox,k);const m=new Uint32Array(t),d=P({indices:m,attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*o*e.uvMapSpace.BYTES_PER_ELEMENT,4*s):null}}),_=new R(d,n(this._material),e.layerUid,e.graphicsUid),y=k;l(_.boundingSphere,.5*(y[0]+y[3]),.5*(y[1]+y[4]),0,.5*Math.sqrt((y[3]-y[0])*(y[3]-y[0])+(y[4]-y[1])*(y[4]-y[1]))),e.outGeometries.push(_),e.outNum++}}_createAsOverlayOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{position:r}=t[i];if(u(k),p(k,r),!c(k,this._context.clippingExtent))continue;h(e.outBoundingBox,k);const o=this._outlineMaterial instanceof L,a=D({removeDuplicateStartEnd:o?0:1,attributeData:{position:r}}),s=new R(a,n(this._outlineMaterial),e.layerUid,e.graphicsUid),m=k;l(s.boundingSphere,.5*(m[0]+m[3]),.5*(m[1]+m[4]),0,.5*Math.sqrt((m[3]-m[0])*(m[3]-m[0])+(m[4]-m[1])*(m[4]-m[1]))),e.outGeometries.push(s),e.outNum++}}_getOutlineOpacity(){const e=i(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(t(e)?e.a:0)}_getOutlineColor(){const r=i(this.symbolLayer,"outline","color"),n=this._getOutlineOpacity();return O(t(r)?e.toUnitRGB(r):null,n)}get test(){return{createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,i)=>this._createAs3DShape(e,t,i)}}}I.elevationModeChangeTypes={definedChanged:f.RECREATE,staysOnTheGround:f.NONE,onTheGroundChanged:f.RECREATE};const k=m(),z={renderData:null,color:null,uvMapSpace:null,boundingRect:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Y={renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};export default I;export{I as Graphics3DPolygonFillSymbolLayer};
