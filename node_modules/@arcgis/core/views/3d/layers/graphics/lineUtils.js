/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{acosClamped as t}from"../../../../core/mathUtils.js";import{isNone as o,isSome as e,unwrapOr as n}from"../../../../core/maybe.js";import{slice as r}from"../../../../core/typedArrayUtil.js";import{s as i,n as s,d as a,a as u}from"../../../../chunks/vec3.js";import{c}from"../../../../chunks/vec3f64.js";import{projectBuffer as p}from"../../../../geometry/projection.js";import{pathsToTriangulationInfo as l}from"../../../../geometry/support/triangulationUtils.js";import{WHITE_UNIT as f}from"./constants.js";import{applyPerVertexElevationAlignment as h}from"./elevationAlignmentUtils.js";import{DRAPED_Z as m}from"../../terrain/OverlayRenderer.js";import{Geometry as y}from"../../webgl-engine/lib/Geometry.js";function b(t){const o=[],e=[];j(t,e,o);const n=e[0][1].data,r=o[0][1].length,i=new Uint16Array(r);return A(t,e,o),F(t,e,o,i),w(t,e,o,i),v(t,e,o,i),D(t,e,o,i),P(t,e,o,i),U(t,e,o,n),new y(e,o,2)}function g(t,o,e,n){const r="polygon"===t.type?1:0,i="polygon"===t.type?t.rings:t.paths,{position:s,outlines:a}=l(i,t.hasZ,r),u=new Float64Array(s.length),c=h(s,t.spatialReference,0,u,0,s,0,s.length/3,o,e,n),p=null!=c;return{lines:p?d(a,s,u):[],projectionSuccess:p,sampledElevation:c}}function d(t,o,e){const n=new Array;for(const{index:r,count:i}of t){if(i<=1)continue;const t=3*r,s=t+3*i;n.push({position:o.subarray(t,s),mapPosition:e?e.subarray(t,s):void 0})}return n}function z(t,o){const e="polygon"===t.type?1:0,n="polygon"===t.type?t.rings:t.paths,{position:r,outlines:i}=l(n,!1,e),s=p(r,t.spatialReference,0,r,o,0,r.length/3);for(let a=2;a<r.length;a+=3)r[a]=m;return{lines:s?d(i,r):[],projectionSuccess:s}}function j(t,o,e){const{attributeData:{position:n},removeDuplicateStartEnd:i}=t,s=M(n)&&1===i,a=n.length/3-(s?1:0),u=new Uint32Array(2*(a-1)),c=s?r(n,0,n.length-3):n;let p=0;for(let r=0;r<a-1;r++)u[p++]=r,u[p++]=r+1;o.push(["position",{size:3,data:c,exclusive:s}]),e.push(["position",u])}function A(t,e,n){const r=t.attributeData.mapPosition;o(r)||(n.push(["mapPos",n[0][1]]),e.push(["mapPos",{size:3,data:r}]))}function F(t,o,r,i){if(e(t.attributeData.colorFeature))return;const s=t.attributeData.color;o.push(["color",{size:4,data:n(s,f)}]),r.push(["color",i])}function v(t,e,n,r){const i=t.attributeData.colorFeature;o(i)||(e.push(["colorFeatureAttribute",{size:1,data:new Float32Array([i])}]),n.push(["color",r]))}function w(t,o,r,i){if(e(t.attributeData.sizeFeature))return;const s=t.attributeData.size;o.push(["size",{size:1,data:[n(s,1)]}]),r.push(["size",i])}function D(t,e,n,r){const i=t.attributeData.sizeFeature;o(i)||(e.push(["sizeFeatureAttribute",{size:1,data:new Float32Array([i])}]),n.push(["sizeFeatureAttribute",r]))}function P(t,e,n,r){const i=t.attributeData.opacityFeature;o(i)||(e.push(["opacityFeatureAttribute",{size:1,data:new Float32Array([i])}]),n.push(["opacityFeatureAttribute",r]))}function U(o,e,r,c){if("round"!==o.join)return;const p=c.length/3,l=new Float32Array(p),f=S,h=R;i(f,0,0,0);const m=n(o.uniformSize,1);for(let n=-1;n<p;++n){const o=n<0?p+n:n,e=(n+1)%p;if(i(h,c[3*e+0]-c[3*o+0],c[3*e+1]-c[3*o+1],c[3*e+2]-c[3*o+2]),s(h,h),n>=0){const o=1*((Math.PI-t(a(f,h)))*k)*x(m);l[n]=Math.max(Math.floor(o),0)}u(f,h,-1)}e.push(["subdivisions",{size:1,data:l}]),r.push(["subdivisions",r[0][1]])}function x(t){return 1.863798+-2.0062872/(1+t/18.2313)**.8856294}function M(t){const o=t.length;return t[0]===t[o-3]&&t[1]===t[o-2]&&t[2]===t[o-1]}const S=c(),R=c(),k=4/Math.PI;export{b as createGeometry,g as geometryToRenderInfo,z as geometryToRenderInfoDraped};
