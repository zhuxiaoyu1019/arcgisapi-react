/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import e from"../../../../core/Logger.js";import{isNone as t,isSome as r}from"../../../../core/maybe.js";import{a as n}from"../../../../chunks/vec2f64.js";import{s as a,l as c}from"../../../../chunks/vec3.js";import{f as l,c as o}from"../../../../chunks/vec3f64.js";import{f as s}from"../../../../chunks/vec4f64.js";import{center as i,height as f,create as p}from"../../../../geometry/support/aaBoundingBox.js";import{getGraphics3DSymbol as m}from"./graphicSymbolUtils.js";import{HUDMaterial as h}from"../../webgl-engine/materials/HUDMaterial.js";const u=e.getLogger("esri.views.3d.layers.graphics.labelPlacement");function b(e){const r=k(e);if(t(r))return null;const a=g(e,r);if(t(a))return null;const c=a.anchor,l=!!r.hasLabelVerticalOffset;return P({anchor:c,verticalOffset:r.verticalOffset,screenOffset:n(),centerOffset:s(0,0,0,-1),centerOffsetUnits:"world",translation:o(),elevationOffset:0,hasLabelVerticalOffset:l},a,e)}function g(e,t){if(t.anchor)return t;const r=e.labelClass.labelPlacement,n=V[r],a=n||y(e);return r&&!n&&u.warnOncePerTick(`the requested label placement '${r}' is not currently supported in SceneView`),d(a,e)}function O(e){const t=e.graphics3DGraphic.graphics3DSymbol,n=m(t);return r(n)?n.symbol.symbolLayers.getItemAt(0):null}function d(e,n){const a=n.graphics3DGraphic.graphic.geometry;if(t(a))return null;if(r(n.disablePlacement)){return n.labelClass.labelPlacement?(u.warnOncePerTick(v(e.placement,n.disablePlacement.logEntityDescription)),y(n)):e}const c=a.type;switch(c){case"polyline":case"polygon":case"extent":case"multipoint":if(n.labelClass.labelPlacement)return u.warnOncePerTick(v(e.placement,`'${c}' geometries`)),y(n);break;case"point":case"mesh":return e}return e}function v(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView`}function y(e){const n=e.graphics3DGraphic.graphic.geometry;if(t(n))return null;switch(n.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const t=O(e);return r(t)&&"extrude"===t.type?V["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return V["above-center"];default:return}}function P(e,r,n){const a=n.graphics3DGraphic.graphic.geometry;if(t(a))return null;switch(a.type){case"point":L(e,r,n);break;case"polygon":w(e,r,n);break;case"mesh":S(e,r,n.graphics3DGraphic._graphics[0])}return e}function w(e,n,c){const l=O(c);if(!t(l))switch(l.type){case"extrude":{const t=c.graphics3DGraphic._graphics[0];r(t)?(t.getBoundingBoxObjectSpace(T),i(T,e.translation),e.translation[2]=f(T)/2):a(e.translation,0,0,0),S(e,n,t);break}}}function L(e,n,c){const l=O(c);if(t(l))return;const o=c.graphics3DGraphic._graphics[0];switch(r(o)?o.getCenterObjectSpace(e.translation):a(e.translation,0,0,0),l.type){case"icon":case"text":z(e,n,c,o);break;case"object":S(e,n,o)}}function z(e,t,n,a){const{graphics3DGraphic:c}=n,l=r(a)?a.getScreenSize():null;if(!c.isDraped&&r(l)){const r=j(n);G[0]=l[0]/2*(t.normalizedOffset[0]-r[0]),G[1]=l[1]/2*(t.normalizedOffset[1]-r[1]),e.screenOffset[0]=G[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=G[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=G[1]}else e.hasLabelVerticalOffset||"center"===e.anchor||(V[n.labelClass.labelPlacement]&&u.warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center")}function j(e,t=B){const{graphics3DGraphic:n}=e,a=n._graphics[0],c=r(a)?a.stageObject.geometryRecords[0].material:null;if(c&&c instanceof h){const e=c.params.anchorPos;t[0]=2*(e[0]-.5),t[1]=2*(e[1]-.5)}else t[0]=0,t[1]=0;return t}function S(e,t,n){const a=r(n)?n.getBoundingBoxObjectSpace(T):T,o=l(a[3]-a[0],a[4]-a[1],a[5]-a[2]),s=Math.sqrt(o[0]*o[0]+o[1]*o[1]);e.centerOffset[0]=s/2*t.normalizedOffset[0];const i=e.translation[2],f=o[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=i+f;const p=c(o);e.centerOffset[2]=p/2*t.normalizedOffset[2]}function D(e){switch(e){case"above-center":return!0;default:return!1}}function k(e){const t=e.labelClass.labelPlacement,{labelSymbol:n,graphics3DGraphic:a}=e,c=m(a.graphics3DSymbol),l=r(c)?c.symbol:null,o=V[t]||y(e);return"point-3d"===l.type&&l.supportsCallout()&&l.hasVisibleVerticalOffset()&&!a.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:C(l.verticalOffset),anchor:null,normalizedOffset:null}:!n||!n.hasVisibleVerticalOffset()||"point-3d"===l.type&&l.supportsCallout()&&l.verticalOffset&&!a.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:D(o.placement)?{placement:"above-center",verticalOffset:C(n.verticalOffset),anchor:"bottom",normalizedOffset:[0,o.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(u.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null)}function C(e){const{screenLength:t,minWorldLength:r,maxWorldLength:n}=e;return{screenLength:t,minWorldLength:r,maxWorldLength:n}}const V={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},x={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const $ in x){const e=x[$],t=V[$];e.forEach((e=>{V[e]=t}))}Object.freeze&&(Object.freeze(V),Object.keys(V).forEach((function(e){Object.freeze(V[e]),Object.freeze(V[e].normalizedOffset)})));const G=[0,0],B=[0,0],T=p();export{b as get};
