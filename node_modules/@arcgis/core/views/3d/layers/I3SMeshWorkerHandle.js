/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../../../core/Logger.js";import t from"../../../core/PooledArray.js";import{WorkerHandle as o}from"../../../core/workers/WorkerHandle.js";import{canProjectWithoutEngine as r,projectVectorToVector as s}from"../../../geometry/projection.js";const n=e.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle");class i extends o{constructor(e){super("SceneLayerWorker","process",e,{hasInitialize:!0})}getTransferList(e){return[e.geometryBuffer]}setModifications(e,t,o){const r={context:e,modifications:f(t,o),isGeodetic:o.isGeographic};this.broadcast(r,"setModifications")}setLegacySchema(e,t){const o=JSON.stringify(t);this.broadcast({context:e,jsonSchema:o},"setLegacySchema")}destroyContext(e){return this.broadcast(e,"destroyContext")}}const c=new t({deallocator:null}),a=[0,0,0];function f(e,t){c.clear();for(const i of e){const e="clip"===i.type?2:"mask"===i.type?1:0,o=i.geometry;let f=e=>e;if(o.spatialReference){if(!r(o.spatialReference,t)){n.warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}f=e=>(s(e,o.spatialReference,a,t),a)}else o.hasZ||(a[2]=0,f=e=>(a[0]=e[0],a[1]=e[1],a));c.push(e),c.push(o.rings.length);for(const t of o.rings){c.push(t.length);for(const e of t){const t=f(e);c.push(t[0]),c.push(t[1]),c.push(t[2])}}}c.push(3);const o=new Float64Array(c.length);for(let r=0;r<c.length;++r)o[r]=c.getItemAt(r);return o}export{i as I3SMeshWorkerHandle,f as toWasmModification};
