/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{isNone as e,unwrap as i,disposeMaybe as t,isSome as s}from"../../../../core/maybe.js";import r from"../../../../core/PooledArray.js";import{i as n,t as o,m as a}from"../../../../chunks/mat4.js";import{c as h}from"../../../../chunks/mat4f32.js";import{I as l}from"../../../../chunks/mat4f64.js";import{f as c,l as d,a as u,o as m,d as p,p as g,s as f}from"../../../../chunks/vec3.js";import{c as _}from"../../../../chunks/vec3f32.js";import{c as x}from"../../../../chunks/vec3f64.js";import{s as S}from"../../../../chunks/vec4.js";import{create as z,POSITIVE_INFINITY as P,offset as b,contains as w,containsPoint as R,equals as y,set as q}from"../../../../geometry/support/aaBoundingBox.js";import{create as v}from"../../../../geometry/support/plane.js";import{fromPoints as M}from"../../../../geometry/support/ray.js";import{PointHighlights as j}from"./PointHighlights.js";import{minimumDistancePlane as F,maximumDistancePlane as H,intersectLine as V,toAaBoundingBox as U}from"../../support/orientedBoundingBox.js";import{bindSliceUniforms as A}from"../../webgl-engine/core/shaderLibrary/Slice.glsl.js";import{bindOutputHighlight as C}from"../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl.js";import{Default3D as B}from"../../webgl-engine/lib/DefaultVertexAttributeLocations.js";import{IntersectorResult as E}from"../../webgl-engine/lib/intersectorUtils.js";import{PointRendererTechniqueConfiguration as L,PointRendererTechnique as I}from"../../webgl-engine/shaders/PointRendererTechnique.js";import N from"../../../webgl/BufferObject.js";import O from"../../../webgl/VertexArrayObject.js";const k={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]};class T{constructor(e){this._params=e,this.type="Point",this.isGround=!1,this._bindParameters={inverseViewport:[0,0],highlightDepthTexture:null},this._highlights=new j({forEachNode:e=>this.forEachNode(e),addHighlight:(e,i,t)=>this.addHighlight(e,i,t),removeHighlight:(e,i)=>this.removeHighlight(e,i)}),this.canRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=z(P),this._techniqueConfig=new L,this.tempMatrix4=h(),this.tempVec3=_(),this.nodes=new r}get needsHighlight(){return this._highlights.hasHighlights}initializeRenderContext(e){this._context=e,this._techniqueRep=this._context.shaderTechniqueRep,e.requestRender()}uninitializeRenderContext(){}intersect(e,i,t,s){const r=x(),n=x(),o=x(),a=x(),h=v(),f=e.camera.perScreenPixelRatio/2,_=e.camera.near,P=this._getSizeParams();c(n,s,t);const y=1/d(n);u(n,n,y),m(o,n),S(h,n[0],n[1],n[2],-p(n,t));class q{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""}}const j=new q,A=new q,C=[],B=z(),L=z(this._clipBox);b(L,-t[0],-t[1],-t[2],L),this.nodes.forAll((l=>{const d=l.splatSize*this._scaleFactor;let u=F(l.obb,h),m=H(l.obb,h);u-=G(d,u+_,P,f,l.isLeaf),m-=G(d,m+_,P,f,l.isLeaf);const x=m<0,S=null!=j.dist&&null!=A.dist&&j.dist<u*y&&A.dist>m*y;if(x||S)return;const z=D(d,m+_,P,f,l.isLeaf);if(!V(l.obb,t,n,z))return;const v=z*z;U(l.obb,B),b(B,-t[0],-t[1],-t[2],B);const M=!w(L,B);c(a,l.origin,t);const E=l.coordinates.length/3;for(let h=0;h<E;h++){if(r[0]=a[0]+l.coordinates[3*h],r[1]=a[1]+l.coordinates[3*h+1],r[2]=a[2]+l.coordinates[3*h+2],M&&!R(L,r))continue;const c=p(r,n),u=g(r)-c*c;if(u>v)continue;let m=c+_;const x=G(d,m,P,f,l.isLeaf);if(c-x<0)continue;m-=x;const S=D(d,m,P,f,l.isLeaf);if(u>S*S)continue;const z=(c-x)*y,b=e=>{e.point=$(l,h,e.point),e.dist=z,e.normal=o,e.node=l,e.pointId=h,e.layerUid=this.layerUid};if((null==j.dist||z<j.dist)&&(null==i||i(t,s,z))&&b(j),0!==e.options.store&&(null==A.dist||z>A.dist)&&(null==i||i(t,s,z))&&b(A),2===e.options.store&&(null==i||i(t,s,z))){const e=new q;b(e),C.push(e)}}}));const I=e=>{const{layerUid:i,node:t,pointId:s}=e;return{type:"external",point:e.point,metadata:{layerUid:i,createGraphic:()=>this._params.createGraphic(t,s,e.point)}}},N=(e,i)=>{const t=I(i),s=`${i.layerUid}/${i.node.id}/${i.pointId}`;e.set(t,s,i.dist,i.normal,l,void 0),e.intersector="PointRenderer"};if(null!=j.dist){const i=e.results.min;(null==i.dist||j.dist<i.dist)&&N(i,j)}if(null!=A.dist&&0!==e.options.store){const i=e.results.max;(null==i.dist||A.dist>i.dist)&&N(i,A)}if(2===e.options.store){const i=M(t,s);for(const t of C){const s=new E(i);N(s,t),e.results.all.push(s)}}}render(e){if(0!==e.pass&&2!==e.pass&&5!==e.pass)return!1;const i=2===e.pass,t=e.rctx;this.nodes.forAll((i=>{null==i.vao&&this._initNode(e,i)}));const s=this._getSizeParams(),r=this.selectTechnique(e,s),h=r.program;if(null==h||0===this.nodes.length)return!0;const l=this._clipBox,c=!y(l,P,((e,i)=>e===i));c||(f(this.tempVec3,-1/0,-1/0,-1/0),h.setUniform3fv("uClipMin",this.tempVec3),f(this.tempVec3,1/0,1/0,1/0),h.setUniform3fv("uClipMax",this.tempVec3)),t.useProgram(h),r.bindPipelineState(t),h.setUniformMatrix4fv("uProjectionMatrix",e.camera.projectionMatrix),i&&h.setUniform2f("nearFar",e.camera.near,e.camera.far),e.isHighlightPass&&(this._bindParameters.inverseViewport[0]=1/e.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/e.camera.fullViewport[3],this._bindParameters.highlightDepthTexture=e.highlightDepthTexture,C(h,this._bindParameters));const d=e.camera.pixelRatio;s.drawFixedSize&&h.setUniform2f("uPointScale",s.fixedSize*d,e.camera.fullHeight);const u=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null;return this.nodes.forAll((i=>{if(0===i.coordinates.length||e.isHighlightPass&&!i.highlights)return;if(h.setUniform2f("uScreenMinMaxSize",s.screenMinSize*d,W(i.isLeaf)*d),!s.drawFixedSize){const t=i.splatSize*this._scaleFactor;h.setUniform2f("uPointScale",t*d,e.camera.fullHeight/d)}const m=i.origin;c&&(f(this.tempVec3,l[0]-m[0],l[1]-m[1],l[2]-m[2]),h.setUniform3fv("uClipMin",this.tempVec3),f(this.tempVec3,l[3]-m[0],l[4]-m[1],l[5]-m[2]),h.setUniform3fv("uClipMax",this.tempVec3)),n(this.tempMatrix4),o(this.tempMatrix4,this.tempMatrix4,m),a(this.tempMatrix4,e.camera.viewMatrix,this.tempMatrix4),h.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),A(h,r.configuration,u,m),t.bindVAO(i.vao),e.isHighlightPass?this._renderHighlightFragments(t,i):t.drawArrays(0,0,i.coordinates.length/3)})),!0}_renderHighlightFragments(t,s){const r=s.highlights;if(e(r))return;let n=i(r[0].component),o=n+1;for(let e=1;e<r.length;e++){const s=i(r[e].component);if(s!==o){const e=o-n;e>0&&t.drawArrays(0,n,e),n=s}o=s+1}const a=o-n;a>0&&t.drawArrays(0,n,a)}set useFixedSizes(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())}get useFixedSizes(){return this._useFixedSizes}set scaleFactor(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())}get scaleFactor(){return this._scaleFactor}set minSizePx(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())}get minSizePx(){return this._minSizePx}set useRealWorldSymbolSizes(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())}get useRealWorldSymbolSizes(){return this._useRealWorldSymbolSizes}set size(e){this._size!==e&&(this._size=e,this._requestRender())}get size(){return this._size}set sizePx(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())}get sizePx(){return this._sizePx}set clippingBox(e){q(this._clipBox,e||P)}get slicePlane(){return this._slicePlaneEnabled}set slicePlane(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}get intersectionHandlerId(){return this.layerUid}addNode(e){this.nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()}removeNode(e){let i=null;return this.nodes.filterInPlace((s=>s.id!==e||(i=s,s.vao=t(s.vao),this._highlights.nodeRemoved(s),!1))),this._requestRender(),i}forEachNode(e){this.nodes.forAll(e)}removeAll(){this.nodes.forAll((e=>e.vao=t(e.vao))),this._highlights.removeAll(),this.nodes.clear(),this._requestRender()}highlight(e){return this._highlights.add(e)}addHighlight(e,i,t){e.highlights=K(e.highlights,i,t),this._requestRender()}removeHighlight(e,i){e.highlights=Q(e.highlights,i),this._requestRender()}_initNode(e,i){const t=e.rctx;i.vao=new O(t,B,k,{positions:N.createVertex(t,35044,i.coordinates),colors:N.createVertex(t,35044,i.rgb)})}_requestRender(){this._context&&this._context.requestRender()}_getSizeParams(){const e=this._useFixedSizes,i=e&&!this._useRealWorldSymbolSizes;return{drawScreenSpace:i,drawFixedSize:e,fixedSize:i?this._sizePx:this._size,screenMinSize:e?0:this._minSizePx}}selectTechnique(e,i){return this._techniqueConfig.drawScreenSize=i.drawScreenSpace,this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled,this._techniqueConfig.sceneHasOcludees=e.hasOccludees,this._techniqueConfig.output=2===e.pass?1:5===e.pass?4:0,this._techniqueRep.releaseAndAcquire(I,this._techniqueConfig,this._technique)}}function W(e){return e?256:64}function D(e,i,t,s,r){if(t.drawScreenSpace)return t.fixedSize*i*s;const n=W(r)*i*s;return t.drawFixedSize?Math.min(t.fixedSize/2,n):t.screenMinSize>0?Math.min(Math.max(t.screenMinSize*i*s,e/2),n):Math.min(e/2,n)}function G(e,i,t,s,r){return t.drawScreenSpace?0:D(e,i,t,s,r)}function $(e,i,t){return null==t&&(t=x()),t[0]=e.origin[0]+e.coordinates[3*i],t[1]=e.origin[1]+e.coordinates[3*i+1],t[2]=e.origin[2]+e.coordinates[3*i+2],t}function J(e){return s(e.component)?e.component:-1}function K(i,t,s){e(i)&&(i=[]);const r={component:t,id:s};i.push(r);const n=J(r);let o=i.length-1;for(;o>0&&n<J(i[o-1]);)[i[o-1],i[o]]=[i[o],i[o-1]],--o;return i}function Q(i,t){if(e(i))return i;const s=i.filter((e=>e.id!==t));return 0===s.length?null:s}!function(e){function i(e){return e.hasOwnProperty("splatSize")}e.isInstanceOfNode=i}(T||(T={}));export{T as PointRenderer};
