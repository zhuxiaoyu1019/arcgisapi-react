/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import i from"../../../../../Color.js";import t from"../../../../../core/Accessor.js";import o from"../../../../../core/Handles.js";import{makeHandle as n,handlesGroup as s}from"../../../../../core/handleUtils.js";import{removeMaybe as r,destroyMaybe as l}from"../../../../../core/maybe.js";import{property as a}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/has.js";import"../../../../../core/accessorSupport/ensureType.js";import"../../../../../core/Logger.js";import{subclass as c}from"../../../../../core/accessorSupport/decorators/subclass.js";import{reactionInit as u}from"../../../../../core/accessorSupport/trackingUtils.js";import{c as d}from"../../../../../chunks/mat4f64.js";import{f as m}from"../../../../../chunks/vec3.js";import{d as h,c as p}from"../../../../../chunks/vec3f64.js";import{LineVisualElement as f}from"../../../interactive/visualElements/LineVisualElement.js";let y=class extends t{constructor(e){super(e),this._handle=null,this._analysisHandles=new o}initialize(){this._handle=this._connectAnalyses()}destroy(){this._handle=r(this._handle),this._analysisHandles=l(this._analysisHandles)}get _analyses(){return this.layerViewData.analyses}get _configuration(){return this.layerViewData.configuration}createLineOfSightVisualization(){const e=this._configuration,t={view:this.view,attached:!0,width:e.outerWidth,innerWidth:e.innerWidth};return{visibleLineVisualElement:new f({...t,color:i.toUnitRGBA(e.visibleOuterColor),innerColor:i.toUnitRGBA(e.visibleInnerColor)}),occludedLineVisualElement:new f({...t,color:i.toUnitRGBA(e.occludedOuterColor),innerColor:i.toUnitRGBA(e.occludedInnerColor)}),undefinedLineVisualElement:new f({...t,color:i.toUnitRGBA(e.undefinedOuterColor),innerColor:i.toUnitRGBA(e.undefinedInnerColor)})}}destroyLineOfSightVisualization(e){e.visibleLineVisualElement=l(e.visibleLineVisualElement),e.occludedLineVisualElement=l(e.occludedLineVisualElement),e.undefinedLineVisualElement=l(e.undefinedLineVisualElement)}updateLineOfSightVisualization(e,t){const o=this._configuration,{computationResult:n,inputPoints:s}=e,{start:r,end:l,intersection:a,isValid:c,isTargetVisible:u}=n,{observer:d}=s,p=v;p[12]=d[0],p[13]=d[1],p[14]=d[2];const f=m(g,r,d),y=m(V,l,d),L=m(_,a,d),{visibleLineVisualElement:C,occludedLineVisualElement:O,undefinedLineVisualElement:A}=t;C.geometry=null,O.geometry=null,A.geometry=null,c?u?(C.geometry=[[h(f),h(y)]],C.transform=p,C.color=i.toUnitRGBA(o.visibleOuterColor)):(C.geometry=[[h(f),h(L)]],C.transform=p,C.color=i.toUnitRGBA(o.occludedOuterColor),O.geometry=[[h(L),h(y)]],O.transform=p):(A.geometry=[[h(f),h(y)]],A.transform=p)}getLineOfSightVisualizationDependencies(e){const{computationResult:i}=e,{occludedOuterColor:t,visibleOuterColor:o}=this._configuration;return{computationResult:i,occludedOuterColor:t,visibleOuterColor:o}}_connectAnalysis(e){const i=this._analysisHandles;if(i.has(e))return;const t=this.createLineOfSightVisualization();i.add([u((()=>this.getLineOfSightVisualizationDependencies(e)),(()=>this.updateLineOfSightVisualization(e,t))),n((()=>this.destroyLineOfSightVisualization(t)))])}_disconnectAnalysis(e){this._analysisHandles.remove(e)}_connectAnalyses(){let e=null;return s([u((()=>this._analyses),(i=>{e=r(e),e=i.on("change",(e=>this._onAnalysesCollectionChange(e))),this._onAnalysesCollectionChange({target:i,added:i.items,removed:[],moved:[]})})),n((()=>e=r(e)))])}_onAnalysesCollectionChange(e){e.added.forEach((e=>this._connectAnalysis(e))),e.removed.forEach((e=>this._disconnectAnalysis(e)))}};e([a({constructOnly:!0})],y.prototype,"layer",void 0),e([a({constructOnly:!0})],y.prototype,"view",void 0),e([a({constructOnly:!0})],y.prototype,"layerViewData",void 0),e([a()],y.prototype,"_analyses",null),e([a()],y.prototype,"_configuration",null),y=e([c("esri.views.3d.layers.analysis.LineOfSight.LineOfSightView")],y);const g=p(),V=p(),_=p(),v=d();export{y as LineOfSightView};
