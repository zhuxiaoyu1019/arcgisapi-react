/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import"../../../../../intl.js";import t from"../../../../../core/Accessor.js";import"../../../../../core/has.js";import i from"../../../../../core/Handles.js";import{nextHighestPowerOfTen as s}from"../../../../../core/mathUtils.js";import{isNone as r,isSome as n,unwrap as a}from"../../../../../core/maybe.js";import o from"../../../../../core/Quantity.js";import{formatDecimal as l}from"../../../../../core/quantityFormatUtils.js";import{convertUnit as h,preferredImperialAreaUnit as m,preferredMetricAreaUnit as c,preferredImperialLengthUnit as d,preferredMetricLengthUnit as u}from"../../../../../core/unitUtils.js";import{whenOnce as p}from"../../../../../core/watchUtils.js";import{property as g}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/accessorSupport/ensureType.js";import"../../../../../core/Logger.js";import{subclass as _}from"../../../../../core/accessorSupport/decorators/subclass.js";import{reactionInit as L}from"../../../../../core/accessorSupport/trackingUtils.js";import{i as b,t as v}from"../../../../../chunks/mat4.js";import{c as f}from"../../../../../chunks/mat4f64.js";import{f as w}from"../../../../../chunks/vec3.js";import{c as S}from"../../../../../chunks/vec3f64.js";import y from"../../../interactive/measurementTools/support/measurementUtils.js";import{midpoint as j}from"../../../interactive/measurementTools/support/viewUtils.js";import{LabelVisualElement as C}from"../../../interactive/visualElements/LabelVisualElement.js";import{LineVisualElement as P}from"../../../interactive/visualElements/LineVisualElement.js";import{MeasurementAreaVisualElement as V}from"../../../interactive/visualElements/MeasurementAreaVisualElement.js";import{GeodesicSegment as A,EuclideanSegment as D}from"../../../interactive/visualElements/support/Segment.js";import{createStipplePatternSimple as R}from"../../../webgl-engine/materials/lineStippleUtils.js";import{onLocaleChange as M}from"../../../../../intl/locale.js";import{fetchMessageBundle as I}from"../../../../../intl/messages.js";let U=class extends t{constructor(e){super(e),this._handles=new i,this._params={...z},this._path=null,this._intersectedPath=null,this._perimeter=null,this._intersectedPerimeter=null,this._projectionLines=null,this._measurementArea=null,this._areaLabel=null,this._pathLengthLabel=null,this._cursorSegmentLengthLabel=null,this._perimeterLengthLabel=null,this._pathSegments=[],this._perimeterSegments=[],this._cursorSegment=null,this._origin=S(),this._originTransform=f(),this._cursorPositionRenderSpace=S(),this.messages=null,this.viewData=k,this.areaLabel=null,this.perimeterLengthLabel=null,this.mode="auto",this.geodesicMeasurementDistanceThreshold=1e5}get visible(){return this.layerView.visible&&!this.layerView.suspended}get testData(){return{labels:{area:this._areaLabel,pathLength:this._pathLengthLabel,cursorSegmentLength:this._cursorSegmentLengthLabel,perimeterLength:this._perimeterLengthLabel}}}initialize(){const e=this.view;this._path=new P({view:e,attached:!0,width:this._params.pathLineWidth,color:this._params.pathLineColor,polygonOffset:!0,renderOccluded:4}),this._intersectedPath=new P({view:e,attached:!0,width:this._params.pathLineWidth,color:this._params.intersectingLineColor,polygonOffset:!0,renderOccluded:4}),this._perimeter=new P({view:e,attached:!0,width:this._params.perimeterLineWidth,color:this._params.perimeterLineColor,polygonOffset:!0,renderOccluded:4}),this._intersectedPerimeter=new P({view:e,attached:!0,width:this._params.perimeterLineWidth,color:this._params.intersectingLineColor,polygonOffset:!0,renderOccluded:4}),this._projectionLines=new P({view:e,attached:!0,width:this._params.projectionLineWidth,color:this._params.projectionLineColor,stipplePattern:R(this._params.projectionLineStippleSize),stippleIntegerRepeats:!1,polygonOffset:!0,renderOccluded:4}),this._measurementArea=new V({view:e,attached:!0,color1:this._params.areaColor1,color2:this._params.areaColor2}),this._areaLabel=new C({view:this.view,attached:!0,fontSize:16}),this._pathLengthLabel=new C({view:e,attached:!0,fontSize:12}),this._cursorSegmentLengthLabel=new C({view:e,attached:!0,fontSize:12}),this._perimeterLengthLabel=new C({view:e,attached:!0,fontSize:12});const t=this.layerView,i=t.layerViewData;this._handles.add([L((()=>[this.mode,this.visible,t.unit,i.measurementData,i.cursorPoint]),(()=>this._update())),L((()=>{var t;return null==(t=e.state)?void 0:t.camera}),(()=>this._updateLabels())),M((async()=>this._updateMessageBundle()))]),this._updateMessageBundle()}destroy(){this._measurementArea.destroy(),this._measurementArea=null,this._path.destroy(),this._path=null,this._intersectedPath.destroy(),this._intersectedPath=null,this._perimeter.destroy(),this._perimeter=null,this._intersectedPerimeter.destroy(),this._intersectedPerimeter=null,this._areaLabel.destroy(),this._areaLabel=null,this._pathLengthLabel.destroy(),this._pathLengthLabel=null,this._cursorSegmentLengthLabel.destroy(),this._cursorSegmentLengthLabel=null,this._perimeterLengthLabel.destroy(),this._perimeterLengthLabel=null,this.set("view",null)}async whenMessages(){await p(this,"messages")}_update(){if(this.destroyed)return;const e=this.layerView.layerViewData.measurementData;r(e)||(this._updateViewData(e,this.layerView.layerViewData.path,this.layerView.layerViewData.cursorPoint),this._updateOrigin(),this._updatePathSegments(),this._updatePerimeterSegments(),this._updateArea(),this._updateProjectionLines(),this._updateLabels())}_updateViewData(e,t,i){const r=t.isValidPolygon,a=t.lastPoint,l=n(a)&&n(i)?new o(y.segmentLengthGeodesic(a,i),"meters"):null,m=n(a)&&n(i)?new o(e.unitNormalizer.normalizeDistance(y.segmentLengthEuclidean(a,i,e.unitNormalizer.spatialReference)),"meters"):null;let c;if("auto"===this.mode){c="euclidean";(e.geodesicPathLength?e.geodesicPathLength.value:0)+(!r&&n(l)?l.value:0)>this.geodesicMeasurementDistanceThreshold&&(c="geodesic")}else c=this.mode;null==e.geodesicPathLength&&(c="euclidean");const d="geodesic"===c,u=d?e.geodesicArea:e.area;let p=1;if(u){const t=this._toPreferredAreaUnit(u,this.layerView.unit);p=s(Math.sqrt(t.value)/Math.sqrt(300)),p*=Math.sqrt(h(1,t.unit,"square-meters")),p/=e.unitNormalizer.normalizeDistance(1)}const g={validMeasurement:r,path:t,pathVersion:t.version,cursorPoint:i,measurementData:e,mode:c,positionsGeographic:e.positionsGeographic,positionsRenderCoords:e.positionsRenderCoords,positionsProjected:e.positionsProjectedWorldCoords,positionsFittedRenderCoords:e.positionsFittedRenderCoords,intersectingSegments:d?e.geodesicIntersectingSegments:e.intersectingSegments,triangleIndices:d?e.geodesicTriangleIndices:e.triangleIndices,fittingMode:e.fittingMode,areaCentroid:d?e.geodesicAreaCentroidRenderCoords:e.areaCentroidRenderCoords,pathLengthLabelSegmentIndex:r?0:t.numVertices-2,perimeterLengthLabelSegmentIndex:0,checkerSize:p,geodesicCursorSegmentLength:l,cursorSegmentLength:m};this._set("viewData",g)}_updateOrigin(){const e=this.viewData;j(e.positionsRenderCoords,this._origin),b(this._originTransform),v(this._originTransform,this._originTransform,this._origin),this._measurementArea.transform=this._originTransform,this._projectionLines.transform=this._originTransform}_createSegments(e){const t=this.viewData,i=t.path,s=this.view.renderCoordsHelper.spatialReference,r=t.mode,n=[],a=[],o=[],l=t.validMeasurement?i.numVertices:i.numVertices-1;for(let h=0;h<l;++h){const l=t[e][h],m=t[e][(h+1)%i.numVertices];let c=null;switch(r){case"euclidean":c=new D(l,m);break;case"geodesic":c=new A(l,m,s)}t.intersectingSegments.has(h)?o.push(c):a.push(c),n.push(c)}return{all:n,nonIntersecting:a,intersecting:o}}_updatePathSegments(){const e=this.visible,t=this.viewData,i=this._createSegments("positionsRenderCoords"),s=t.path,r=!s.isValidPolygon,a=t.cursorPoint,o=this.view.renderCoordsHelper,l=o.spatialReference,h=t.mode;if(this._cursorSegment=null,s.numVertices>0&&r&&n(a)){if(o.toRenderCoords(a,this._cursorPositionRenderSpace)){const e=t.positionsRenderCoords[s.numVertices-1],r=this._cursorPositionRenderSpace;let n=null;switch(h){case"euclidean":n=new D(e,r);break;case"geodesic":n=new A(e,r,l)}i.nonIntersecting.push(n),this._cursorSegment=n}}this._path.setGeometryFromSegments(i.nonIntersecting,this._origin),this._path.visible=e,this._intersectedPath.setGeometryFromSegments(i.intersecting,this._origin),this._intersectedPath.visible=e,this._pathSegments=i.all}_updatePerimeterSegments(){const e=this.visible&&"euclidean"===this.viewData.mode,t=this._createSegments("positionsFittedRenderCoords");this._perimeter.setGeometryFromSegments(t.nonIntersecting,this._origin),this._perimeter.visible=e,this._intersectedPerimeter.setGeometryFromSegments(t.intersecting,this._origin),this._intersectedPerimeter.visible=e,this._perimeterSegments=t.all}_updateArea(){const e=this.viewData;switch(e.mode){case"euclidean":this._updateAreaEuclidean(e);break;case"geodesic":this._updateAreaGeodesic()}}_updateAreaEuclidean(e){const t=this.visible;e.validMeasurement&&0===e.intersectingSegments.size&&e.triangleIndices?(this._measurementArea.geometry={uv:e.positionsProjected,position:e.positionsFittedRenderCoords,triangleIndices:e.triangleIndices},this._measurementArea.size=[e.checkerSize,e.checkerSize],this._measurementArea.visible=t):this._measurementArea.visible=!1}_updateAreaGeodesic(){this._measurementArea.visible=!1}_updateProjectionLines(){const e=this.viewData,t=this.visible,i=e.path,s=e.mode;if(i.numVertices>0&&e.validMeasurement&&"euclidean"===s){const s=[];for(let t=0;t<i.numVertices;++t){const i=S();w(i,e.positionsRenderCoords[t],this._origin);const r=S();w(r,e.positionsFittedRenderCoords[t],this._origin),s.push([i,r])}this._projectionLines.geometry=s,this._projectionLines.visible=t}else this._projectionLines.geometry=null,this._projectionLines.visible=!1}_updateLabels(){if(this.destroyed)return;const e=this.viewData,t=e.path;if(!t)return;const i=e.measurementData,s=e.mode,r=!t.isValidPolygon,o=this.visible,l=this._formatAreaLabel(this.messages,"geodesic"===s?i.geodesicArea:i.area,this.layerView.unit);n(l)?(this._areaLabel.geometry={type:"point",point:e.areaCentroid},this._areaLabel.text=l,this._areaLabel.visible=e.validMeasurement&&0===e.intersectingSegments.size&&o):this._areaLabel.visible=!1,this._set("areaLabel",a(l));const h=this._formatLengthLabel(this.messages,"geodesic"===s?i.geodesicPathLength:i.pathLength,this.layerView.unit);if(n(h)&&e.pathLengthLabelSegmentIndex>=0&&e.pathLengthLabelSegmentIndex<this._pathSegments.length){const i=this._pathSegments[e.pathLengthLabelSegmentIndex],s=n(this._cursorSegment)?this._cursorSegment:O;this._pathLengthLabel.distance=this._params.labelDistance,this._pathLengthLabel.geometry={type:"corner",left:i,right:s},this._pathLengthLabel.text=h,this._pathLengthLabel.visible=r&&t.numVertices>0&&o}else this._pathLengthLabel.visible=!1;const m="geodesic"===s?e.geodesicCursorSegmentLength:e.cursorSegmentLength;if(n(m)){const e=this._formatLengthLabel(this.messages,m,this.layerView.unit);this._cursorSegmentLengthLabel.distance=this._params.labelDistance,this._cursorSegmentLengthLabel.geometry=n(this._cursorSegment)?{type:"segment",segment:this._cursorSegment,sampleLocation:"end"}:null,this._cursorSegmentLengthLabel.anchor="bottom",this._cursorSegmentLengthLabel.text=a(e),this._cursorSegmentLengthLabel.visible=r&&0!==m.value&&o}else this._cursorSegmentLengthLabel.visible=!1;this._cursorSegmentLengthLabel.overlaps(this._pathLengthLabel)&&(this._cursorSegmentLengthLabel.visible=!1),this._pathLengthLabel.overlaps(this._areaLabel)&&(this._pathLengthLabel.visible=!1);const c="geodesic"===e.mode,d=c?i.geodesicPathLength:i.perimeterLength,u=a(null!=d?this._formatLengthLabel(this.messages,d,this.layerView.unit):null);if(this._set("perimeterLengthLabel",a(u)),e.validMeasurement&&0===e.intersectingSegments.size){this._perimeterLengthLabel.distance=this._params.labelDistance,this._perimeterLengthLabel.anchor="top",this._perimeterLengthLabel.text=u,this._perimeterLengthLabel.visible=!0;let t=!0;for(let i=0;i<e.path.numVertices;++i){const s=(e.perimeterLengthLabelSegmentIndex+i)%e.path.numVertices,r=c?this._pathSegments[s]:this._perimeterSegments[s];if(t=!0,this._perimeterLengthLabel.geometry={type:"segment",segment:r,sampleLocation:"center"},!this._perimeterLengthLabel.overlaps(this._areaLabel))break;t=!1}this._perimeterLengthLabel.visible=t&&o}else this._perimeterLengthLabel.visible=!1}_toPreferredAreaUnit(e,t){return e.toUnit(this._preferredAreaUnit(e,t))}_preferredAreaUnit(e,t){switch(t){case"metric":return c(e.value,e.unit);case"imperial":return m(e.value,e.unit);default:return t}}_preferredLengthUnit(e,t){const i=this._deriveLengthUnitFromAreaUnit(t);switch(i){case"metric":return u(e.value,e.unit);case"imperial":return d(e.value,e.unit);default:return i}}_deriveLengthUnitFromAreaUnit(e){switch(e){case"metric":return"metric";case"imperial":return"imperial";case"square-inches":return"inches";case"square-feet":return"feet";case"square-yards":return"yards";case"square-miles":return"miles";case"square-us-feet":return"us-feet";case"square-millimeters":return"millimeters";case"square-centimeters":return"centimeters";case"square-decimeters":return"decimeters";case"square-meters":return"meters";case"square-kilometers":return"kilometers";case"acres":return"imperial";case"ares":case"hectares":return"metric"}throw new Error("unhandled area unit")}_formatAreaLabel(e,t,i){return e&&t&&l(e,t,this._preferredAreaUnit(t,i))}_formatLengthLabel(e,t,i){return e&&t&&l(e,t,this._preferredLengthUnit(t,i))}_updateMessageBundle(){I("esri/core/t9n/Units").then((e=>{this.messages=e,this.view&&this._update()}))}};e([g()],U.prototype,"view",void 0),e([g()],U.prototype,"messages",void 0),e([g()],U.prototype,"analysis",void 0),e([g()],U.prototype,"viewData",void 0),e([g()],U.prototype,"layerView",void 0),e([g({readOnly:!0})],U.prototype,"areaLabel",void 0),e([g({readOnly:!0})],U.prototype,"perimeterLengthLabel",void 0),e([g()],U.prototype,"mode",void 0),e([g({readOnly:!0})],U.prototype,"visible",null),e([g()],U.prototype,"geodesicMeasurementDistanceThreshold",void 0),U=e([_("esri.views.3d.layers.analysis.AreaMeasurement.AreaMeasurementView")],U);const z={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:1,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,handleRadiusHovered:10,handleRadiusMouse:10,handleRadiusTouch:25,pathLineColor:[1,.5,0,1],pathLineWidth:3,intersectingLineColor:[1,.2,0,1],perimeterLineColor:[1,.5,0,1],perimeterLineWidth:2,projectionLineColor:[1,.5,0,1],projectionLineWidth:2,projectionLineStippleSize:5,areaColor1:[1,.5,0,.5],areaColor2:[1,1,1,.5],fillColor:[1,.5,0,.5],lineSubdivisions:64,labelDistance:25},k={validMeasurement:!1,path:null,pathVersion:-1,cursorPoint:null,measurementData:null,mode:null,positionsGeographic:null,positionsRenderCoords:null,positionsProjected:null,positionsFittedRenderCoords:null,intersectingSegments:null,triangleIndices:null,fittingMode:null,areaCentroid:null,pathLengthLabelSegmentIndex:null,perimeterLengthLabelSegmentIndex:null,checkerSize:null,geodesicCursorSegmentLength:null,cursorSegmentLength:null},O=new D(S(),S());export{U as AreaMeasurementView};
