/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import{isSome as t,unwrap as i}from"../../../../core/maybe.js";import{bindSliceUniformsWithOrigin as r}from"../core/shaderLibrary/Slice.glsl.js";import{bindOutputHighlight as s}from"../core/shaderLibrary/output/OutputHighlight.glsl.js";import{bindProjectionMatrix as o,bindView as p}from"../core/shaderLibrary/util/View.glsl.js";import{ReloadableShaderModule as l}from"../core/shaderTechnique/ReloadableShaderModule.js";import{ShaderTechnique as n}from"../core/shaderTechnique/ShaderTechnique.js";import{ShaderTechniqueConfiguration as a,parameter as u}from"../core/shaderTechnique/ShaderTechniqueConfiguration.js";import{Default3D as h}from"../lib/DefaultVertexAttributeLocations.js";import{Program as d}from"../lib/Program.js";import{depthCompareLess as c,stencilWriteMaskOn as m,stencilToolMaskBaseParams as f,stencilBaseAllZerosParams as g}from"../lib/StencilUtils.js";import{N as b}from"../../../../chunks/NativeLine.glsl.js";import{separateBlendingParams as x,makePipelineState as P,defaultColorWriteParams as E,defaultDepthWriteParams as T}from"../../../webgl/renderState.js";class v extends n{constructor(e,t,i){super(e,t,i),this.stipplePattern=null,this.stippleTextureBind=null,this.stippleTextureRepository=e.stippleTextureRepository}initializeProgram(e){const t=v.shader.get(),i=this.configuration,r=t.build({output:i.output,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,stippleEnabled:i.stippleEnabled,stippleOffColorEnabled:i.stippleOffColorEnabled,stippleUVMaxEnabled:!1,stippleIntegerRepeatsEnabled:i.stippleIntegerRepeatsEnabled});return new d(e.rctx,r,h)}dispose(){super.dispose(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,r){if(o(this.program,r.camera.projectionMatrix),this.stipplePattern!==e.stipplePattern){const t=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,t),this.stipplePattern=t}if(this.configuration.stippleEnabled){const e=t(this.stippleTextureBind)?this.stippleTextureBind(this.program)*r.camera.pixelRatio:1;this.program.setUniform1i("stipplePatternTexture",0),this.program.setUniform1f("stipplePatternPixelSizeInv",1/e),this.program.setUniform2f("ndcToPixel",r.camera.fullViewport[2]/2,r.camera.fullViewport[3]/2)}if(this.program.setUniform4fv("constantColor",e.color),this.program.setUniform1f("alphaCoverage",Math.min(1,e.width*r.camera.pixelRatio)),this.configuration.stippleOffColorEnabled){const t=i(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",t[0],t[1],t[2],t.length>3?t[3]:1)}4===this.configuration.output&&s(this.program,r)}bindDraw(e){p(this.program,e),r(this.program,this.configuration,e),this.program.rebindTextures()}initializePipeline(){const e=this.configuration,t=x(770,1,771,771),i=(t,i=null,r=null)=>P({blending:i,depthTest:c,depthWrite:r,colorWrite:E,stencilWrite:e.sceneHasOcludees?m:null,stencilTest:e.sceneHasOcludees?t?f:g:null});return 0===e.output?(this._occludeePipelineState=i(!0,e.transparent||e.stippleEnabled?t:null,T),i(!1,e.transparent||e.stippleEnabled?t:null,T)):i(!1)}get primitiveType(){return 1}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}v.shader=new l(b,(()=>import("./NativeLine.glsl.js")));class y extends a{constructor(){super(...arguments),this.output=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleIntegerRepeatsEnabled=!1,this.sceneHasOcludees=!1}}e([u({count:8})],y.prototype,"output",void 0),e([u()],y.prototype,"slicePlaneEnabled",void 0),e([u()],y.prototype,"vertexColors",void 0),e([u()],y.prototype,"transparent",void 0),e([u()],y.prototype,"stippleEnabled",void 0),e([u()],y.prototype,"stippleOffColorEnabled",void 0),e([u()],y.prototype,"stippleIntegerRepeatsEnabled",void 0),e([u()],y.prototype,"sceneHasOcludees",void 0);export{v as NativeLineTechnique,y as NativeLineTechniqueConfiguration};
