/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{RenderTargetHelper as e}from"./RenderTargetHelper.js";class t{constructor(t,r){this._rctx=t,this._compositingHelper=r,this._currentRenderTarget=0,this.dimensions={width:4,height:4},this._needLastFrameColorTexture=!1,this._background={type:"color",color:[0,0,0,1]};const i=this._rctx,o="webgl2"===i.webglVersion;this.renderTargetHelper=new e(i);const s=this.renderTargetHelper;this.mainColorTarget0=s.registerColorTarget({name:"mainColorTarget0"}),this.mainColorTarget1=s.registerColorTarget({name:"mainColorTarget1"}),this.frontFaceTarget=s.registerColorTarget({name:"frontFaceTarget"});const a=e=>s.registerColorTarget({name:e,dataType:5126,internalFormat:o?34836:6408,samplingMode:9728});this.colorFloatTarget=a("colorFloatTarget"),this.alphaFloatTarget=a("alphaFloatTarget"),this.mainDepth=s.registerDepthTarget({name:"mainDepth"}),this.linearDepth=s.registerColorTarget({name:"linearDepth",samplingMode:9728}),this.terrainLinearDepth=s.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=s.registerColorTarget({name:"geometryLinearDepth"}),this.normal=s.registerColorTarget({name:"normal"}),this.highlight=s.registerColorTarget({name:"highlight",internalFormat:o?32854:6408,dataType:32819}),this.hudVisibility=s.registerColorTarget({name:"hudVisibility",internalFormat:o?32854:6408,dataType:32819}),this.tmpColor=s.registerColorTarget({name:"tmpColor"}),this.tmpDepth=s.registerDepthTarget({name:"tmpDepth"}),this.hudColor=s.registerColorTarget({name:"hudColor"})}dispose(){this.renderTargetHelper.dispose()}get width(){return this.dimensions.width}get height(){return this.dimensions.height}set background(e){this._background=e}get background(){return this._background}get currentColorTarget(){return 0===this._currentRenderTarget?this.mainColorTarget0:this.mainColorTarget1}get previousColorTarget(){return 0===this._currentRenderTarget?this.mainColorTarget1:this.mainColorTarget0}get currentRenderTarget(){return this._currentRenderTarget}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(e,t){return this.renderTargetHelper.getFramebuffer(this.dimensions,e,t)}get colorTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this.renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this.getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this.getColorTexture(this.tmpColor)}get hudColorTexture(){return this.getColorTexture(this.hudColor)}get mainColorTexture(){return this.getColorTexture(this.currentColorTarget)}advanceCurrentRenderTarget(){this._currentRenderTarget=0===this._currentRenderTarget&&this._needLastFrameColorTexture?1:0}initializeFrame(e){const t=this._rctx;this.dimensions.width=e.fullWidth,this.dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),t.setClearStencil(0);const r=this._background.color;t.setClearColor(r[0]*r[3],r[1]*r[3],r[2]*r[3],r[3]),t.clearSafe(17664)}composite(){this._compositingHelper.composite(this.colorTexture,0)}renderTmpAndCompositeToMain(e,t,i=!1){this.renderToTargets(e,this.tmpColor,i?this.tmpDepth:this.mainDepth,r),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),t)}renderHUDVisibility(e,t=!1){this.renderToTargets(e,this.hudVisibility,t?this.tmpDepth:this.mainDepth,i)}compositeTransparentTerrainOntoHUDVisibility(){this.renderToTargets((()=>{this._compositingHelper.compositeSpecial(this.getColorTexture(this.tmpColor),1)}),this.hudVisibility,this.tmpDepth)}renderOITPass(e,t,r){let i,o;switch(t){case 0:i=this.colorFloatTarget,o=[0,0,0,0];break;case 1:i=this.alphaFloatTarget,o=[1,1,1,1];break;case 2:i=this.frontFaceTarget,o=[0,0,0,0]}r?this.renderToTargets(e,i,this.tmpDepth,o,!0,!0):this.renderToTargets(e,i,this.mainDepth,o,!1)}compositeTransparentTerrainOntoMain(){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2)}compositeOccludedOntoMain(e){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2,e)}compositeTransparentOntoOpaque(e){e?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(16384)):this.bindFramebuffer(),this._compositingHelper.compositeTransparent(this.getColorTexture(this.colorFloatTarget),this.getColorTexture(this.alphaFloatTarget),this.getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(e){this.renderTargetHelper.disposeTargetResource(e)}set needLastFrameColorTexture(e){!e&&this._needLastFrameColorTexture&&(this._currentRenderTarget=0,this.disposeTarget(this.mainColorTarget1)),this._needLastFrameColorTexture=e}get needLastFrameColorTexture(){return this._needLastFrameColorTexture}renderToTargets(e,t,r,i,o=!1,s=!1){const a=this._rctx,h=this.bindTarget(t,r);let n=0;if(i){const e=1e-13,t=Math.max(e,i[3]);a.setClearColor(i[0],i[1],i[2],t),n|=16384}return o&&(n|=256),!1===s?s=0:(!0===s&&(s=255),n|=1024),n&&a.clearSafe(n,s),e(),a.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth),h}bindTarget(e,t){const r=this.renderTargetHelper.getFramebuffer(this.dimensions,e,t);return this._rctx.bindFramebuffer(r),r}getColorTexture(e){return this.renderTargetHelper.getColorTexture(e,this.dimensions)}getGpuMemoryUsage(){let e=0;return this.renderTargetHelper&&(e+=this.renderTargetHelper.getGpuMemoryUsage()),e}}const r=[0,0,0,0],i=[0,1,0,1];export{t as OffscreenRendering};
