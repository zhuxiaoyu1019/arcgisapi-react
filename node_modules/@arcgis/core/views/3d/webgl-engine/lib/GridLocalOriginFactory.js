/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{isSome as t}from"../../../../core/maybe.js";import{I as i}from"../../../../chunks/mat4f64.js";import{f as s}from"../../../../chunks/vec3.js";import{c as r}from"../../../../chunks/vec3f64.js";import{projectBuffer as e}from"../../../../geometry/projection.js";import{Geometry as o}from"./Geometry.js";import{fromValues as n}from"./localOrigin.js";import{Object3D as a}from"./Object3D.js";import{WebGLLayer as h}from"./WebGLLayer.js";import{RibbonLineMaterial as c}from"../materials/RibbonLineMaterial.js";let _=0;const m="rg_";class d{constructor(t){this._originSR=t,this.ROOT_ORIGIN_ID=m+"root_"+_++,this._origins=new Map,this._gridSize=125e4,this._objects=new Map}getOrigin(i){const r=this._origins.get(this.ROOT_ORIGIN_ID);if(null==r){if(t(g))return this._origins.set(this.ROOT_ORIGIN_ID,n(g[0],g[1],g[2],this.ROOT_ORIGIN_ID)),this.getOrigin(i);const s=n(i[0]+Math.random()-.5,i[1]+Math.random()-.5,i[2]+Math.random()-.5,this.ROOT_ORIGIN_ID);return this._origins.set(this.ROOT_ORIGIN_ID,s),s}const e=this._gridSize,o=Math.round(i[0]/e),a=Math.round(i[1]/e),h=Math.round(i[2]/e),c=`${m}${o}/${a}/${h}`;let _=this._origins.get(c);const d=.5*e;if(s(f,i,r.vec3),f[0]=Math.abs(f[0]),f[1]=Math.abs(f[1]),f[2]=Math.abs(f[2]),f[0]<d&&f[1]<d&&f[2]<d){if(_){const t=Math.max(...f);s(f,i,_.vec3),f[0]=Math.abs(f[0]),f[1]=Math.abs(f[1]),f[2]=Math.abs(f[2]);if(Math.max(...f)<t)return _}return r}return _||(_=n(o*e,a*e,h*e,c),this._origins.set(c,_)),_}_drawOriginBox(t,s=[1,1,0,1]){const r=window.view,n=r._stage,_=s.toString();if(!this._objects.has(_)){this._material=new c({width:2,color:s}),n.add(this._material);const t=new h({isPickable:!1}),i=new a({castShadow:!1});n.add(i),t.add(i),n.add(t),this._objects.set(_,i)}const m=this._objects.get(_),d=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],g=d.length,O=new Array(3*g),f=new Uint16Array(2*(g-1)),l=.5*this._gridSize;for(let i=0;i<g;i++)O[3*i+0]=t[0]+(1&d[i]?l:-l),O[3*i+1]=t[1]+(2&d[i]?l:-l),O[3*i+2]=t[2]+(4&d[i]?l:-l),i>0&&(f[2*i+0]=i-1,f[2*i+1]=i);e(O,this._originSR,0,O,r.renderSpatialReference,0,g);const I=new o([["position",{size:3,data:O,exclusive:!0}]],[["position",f]],2);n.add(I),m.addGeometry(I,this._material,i)}get test(){const t=this;return{get gridSize(){return t._gridSize},set gridSize(i){t._gridSize=i}}}}let g=null;function O(t){g=t}const f=r();export{d as GridLocalOriginFactory,O as setTestRootOrigin};
