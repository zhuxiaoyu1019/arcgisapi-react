/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../../../../core/Handles.js";import{someMap as r}from"../../../../core/MapUtils.js";import{destroyMaybe as t,disposeMaybe as s,isSome as n,isNone as i,unwrap as a}from"../../../../core/maybe.js";import h from"../../../../core/TimeProfiler.js";import{init as d}from"../../../../core/watchUtils.js";import{f as o,t as l,a as c,m as p}from"../../../../chunks/mat4.js";import{c as _}from"../../../../chunks/mat4f64.js";import{a as g}from"../../../../chunks/vec2f64.js";import u from"../../support/debugFlags.js";import{RenderPassManager as m}from"../core/renderPasses/RenderPassManager.js";import{BoundingInfo as f}from"./BoundingInfo.js";import{ZERO as T,union as x}from"./depthRange.js";import{depthRangeFromScene as R}from"./depthRangeUtils.js";import{createEmptyDepthTexture as b}from"./glUtil3D.js";import w from"./HighlightHelper.js";import{materialPredicate as C}from"./Material.js";import{OffscreenRendering as P}from"./OffscreenRendering.js";import{RenderContext as H}from"./RenderContext.js";import{splitRenderGeometryChangeSetByMaterial as y}from"./rendererUtils.js";import{RenderPluginManager as S}from"./RenderPluginManager.js";import{ShadowAccumulator as M}from"./ShadowAccumulator.js";import{ShadowHighlightHelper as D}from"./ShadowHighlightHelper.js";import E from"./ShadowMap.js";import v from"./SliceHelper.js";import{SmaaRenderPass as O}from"./SmaaRenderPass.js";import I from"./SSAOHelper.js";import{EdgeView as A}from"./edgeRendering/EdgeView.js";import{SceneLighting as q}from"../lighting/SceneLighting.js";import G from"../materials/renderers/MergedRenderer.js";import{RendererPerformanceInfo as L}from"../statistics/RendererPerformanceInfo.js";import{startMeasurement as j}from"../../../webgl/Measurement.js";class F{constructor(r,t,s,n,i,a,h,o,l){this._materialRep=r,this._shaderTechniqueRepository=s,this._rctx=n,this._compositingHelper=i,this._magnifierHelper=a,this.requestRender=h,this._stage=l,this._materialRenderers=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._hasWater=!1,this._hasOverlayWater=!1,this._content=new Map,this._isRendering=!1,this._fallbackDepthStencilTexture=null,this.performanceInfo=new L,this._antialiasing=1,this._oitEnabled=!1,this._multipassTerrain=!0,this._opaqueTerrain=!0,this._lighting=new q,this._handles=new e,this.renderHiddenTransparentEdges=()=>{},this._smaaPass=new O(this._rctx,s),this._oitEnabled=this._hasOITSupport,this.requestRender(),this._offscreenRendering=new P(this._rctx,this._compositingHelper),this._sliceHelper=new v,this._shadowMap=new E(this._rctx,l.viewingMode,2),this._ssaoHelper=new I(s,this._rctx,(()=>this.requestRender())),this._highlightHelper=new w(s,this._rctx),this._shadowHighlightHelper=new D(this._rctx,l.viewingMode),this._shadowAccumulator=new M(this._rctx,s,l,((e,r)=>{this.renderPassManager.shadowCastingEnabled=!0,this._renderPlugins.prepareRender(e,r),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled}),((e,r,t,s)=>{e.start(t,r,s),this.renderShadowCascades(4,e),t.setGLViewport(this._rctx),this.ensureCameraBindParameters(t)}),(()=>this.requestRender())),this._bindParameters={slot:null,camera:null,inverseViewport:g(),shadowMap:this._shadowMap,shadowMappingEnabled:this._shadowMap.enabled,ssaoHelper:this._ssaoHelper,ssaoEnabled:this._ssaoHelper.enabled,origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:this._sliceHelper.plane,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,multipassGeometryEnabled:!1,cullAboveGround:!1,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,highlightColorTexture:null},this._renderContext=new H(this._rctx,this._offscreenRendering,this._lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderContext.multipassTerrainParams={camera:null,multipassTerrainEnabled:!1,cullAboveGround:!1,terrainLinearDepthTexture:null},this._renderContext.multipassGeometryParams={multipassGeometryEnabled:!1,geometryLinearDepthTexture:null},this._renderContext.ssrParams={camera:null,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1},this._renderPlugins=new S({renderContext:this._renderContext,shaderTechniqueRep:s,textureRep:t,materialRep:this._materialRep,requestRender:this.requestRender,schedule:o}),this.renderPassManager=new m(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._handles.add([d(u,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",(e=>{this.renderHiddenTransparentEdges=e?()=>this.renderEdges(1):()=>{},this.requestRender()})),d(this._stage,"camera",(()=>this.requestRender()),!0)])}get hasWater(){return this._hasWater||this._hasOverlayWater}get hasWaterReflection(){return this.hasWater&&this._waterReflectionEnabled}dispose(){this._handles.destroy(),this._smaaPass.disable(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._edgeView=t(this._edgeView),this._offscreenRendering.dispose(),this._fallbackDepthStencilTexture=s(this._fallbackDepthStencilTexture),this._shadowMap.enabled=!1,this._shadowMap.dispose(),this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose(),this._highlightHelper.dispose(),this._shadowHighlightHelper.dispose(),this._shadowAccumulator.dispose(),f.prune(),this._content.clear()}get updating(){return 1===this._antialiasing&&this._smaaPass.isLoadingResources||n(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}ensureEdgeView(){return i(this._edgeView)&&(this._edgeView=new A({rctx:this._rctx,renderSR:this._stage.renderSR,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this.requestRender(),schedule:e=>this._stage.resourceController.schedule(e)}),this._handles.add(this._edgeView.watch("updating",(()=>this.requestRender()),!0)),this.requestRender()),this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return null===this._bindParameters.reprojectionMat||o(this._bindParameters.reprojectionMat,Q)}get hasShadowsEnabled(){var e;return!(null==(e=this._shadowMap)||!e.enabled)}setRenderParameters(e){const{renderPassManager:r,_shadowMap:t,_ssaoHelper:s}=this;void 0!==e.screenSpaceReflectionsEnabled&&r.screenSpaceReflectionsEnabled!==e.screenSpaceReflectionsEnabled&&(r.screenSpaceReflectionsEnabled=e.screenSpaceReflectionsEnabled,this.requestRender()),void 0===e.shadowMap||t.enabled===e.shadowMap&&r.shadowCastingEnabled===e.shadowMap||(t.enabled=e.shadowMap,r.shadowCastingEnabled=e.shadowMap,this.requestRender()),void 0!==e.shadowMapMaxCascades&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this.requestRender()),void 0!==e.ssao&&s.enabled!==e.ssao&&(s.enabled=e.ssao,this.requestRender()),void 0!==e.ssaoAttenuation&&s.attenuation!==e.ssaoAttenuation&&(s.attenuation=e.ssaoAttenuation,this.requestRender()),void 0!==e.ssaoRadius&&s.radius!==e.ssaoRadius&&(s.radius=e.ssaoRadius,this.requestRender()),void 0!==e.ssaoSamples&&s.samples!==e.ssaoSamples&&(s.samples=e.ssaoSamples,this.requestRender()),e.background&&this._offscreenRendering.background!==e.background&&(this._offscreenRendering.background=e.background,this.requestRender());const n=e.antialiasingEnabled?1:0;void 0!==e.antialiasingEnabled&&this._antialiasing!==n&&(this._antialiasing=n,this.requestRender()),void 0!==e.highQualityTransparency&&this._multipassTerrain!==e.highQualityTransparency&&(this._multipassTerrain=e.highQualityTransparency,this._oitEnabled=e.highQualityTransparency&&this._hasOITSupport,this.requestRender()),void 0!==e.defaultHighlightOptions&&(this._highlightHelper.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlightHelper.setDefaultOptions(e.defaultHighlightOptions),this.requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=a(e.slicePlane),this.requestRender());const i=this._rctx.parameters.maxTextureImageUnits>=10&&e.waterReflectionEnabled;void 0!==e.waterReflectionEnabled&&this._waterReflectionEnabled!==i&&(this._waterReflectionEnabled=i,this.requestRender()),void 0!==e.opaqueTerrain&&this._opaqueTerrain!==e.opaqueTerrain&&(this._opaqueTerrain=e.opaqueTerrain,this.requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this.requestRender()),void 0!==e.shadowAccumulationOptions&&this._shadowAccumulator.setOptions(e.shadowAccumulationOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.capabilities.textureFloat&&this._rctx.capabilities.textureFloat.textureFloat&&this._rctx.capabilities.colorBufferFloat&&this._rctx.capabilities.colorBufferFloat.textureFloat}modify(e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:t,removes:s,updates:n}=e;if(0===t.length&&0===s.length&&0===n.length)return;s.forAll((({id:e})=>this._content.delete(e))),t.forAll((e=>this._content.set(e.id,e)));const i=y(e);let a=!1;i.forEach(((e,r)=>{let t=this._materialRenderers.get(r);if(!t){if(!(e.adds.length>0))return;t=new G(this._rctx,this._materialRep,r),this._materialRenderers.set(r,t)}t.modify(e),t.isEmpty&&(a=!0)})),a&&this._materialRenderers.forEach(((e,r)=>{e.isEmpty&&(this._materialRenderers.delete(r),e.dispose())})),this._hasHighlights=r(this._materialRenderers,(e=>e.hasHighlights)),this._hasOccludees=r(this._materialRenderers,(e=>e.hasOccludees)),this._hasWater=r(this._materialRenderers,(e=>e.hasWater)),this.requestRender()}updateLogic(e){let r=!1;return this._materialRenderers.forEach((t=>{t.updateLogic&&(r=t.updateLogic(e)||r)})),r}updateLightSources(e,r,t){this._lighting.groundLightingFactor=r,this._lighting.globalFactor=t,this._lighting.set(e)}render(e,r,t,s){this._isRendering=!0,this.performanceInfo.prerender(this._rctx),this._bindParameters.lighting=this._lighting,this._renderContext.hasOccludees=this._hasOccludees,this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=3;const n=this._offscreenRendering;n.needLastFrameColorTexture=this.hasWaterReflection,n.advanceCurrentRenderTarget();const a=this._sliceHelper.plane;s&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),r.setGLViewport(this._rctx),this.needsShadowAccumulation&&(this.renderPassManager.shadowCastingEnabled=!0),this._renderPlugins.prepareRender(r,t),this.performanceInfo.advance(0);const h=this.computeDepthRange(r);this.renderShadowMap(e,r,this._lighting.lightingMainDirection,h),this.performanceInfo.advance(1),n.initializeFrame(r),this.ensureBindParameters(r),this.renderLinearDepth(),this.performanceInfo.advance(2),this.accumulateShadows(h,r,t),this.renderNormal(),this.performanceInfo.advance(3),this.ensureBindParametersSSR(),this._ssaoHelper.computeSSAO(r,n.linearDepthTexture,n.normalTexture),this.performanceInfo.advance(4),this.performanceInfo.stats.reset(),this._renderContext.pass=0,n.bindFramebuffer(),this.renderSlot(0),this.renderOpaqueGeometry(),this.performanceInfo.advance(5);const d=this._multipassTerrain&&!this._opaqueTerrain;this.renderTerrainLinearDepth(d),this.setMultipassFlags(d),this.setTerrainCulling(d),this.renderEdges(2),this.performanceInfo.advance(6),this.renderHiddenTransparentEdges(),this._oitEnabled?this.renderOrderIndependentTransparency((()=>this.renderTransparentGeometry()),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderGeometryLinearDepth(d);const o={hudVisibility:!1,transparentTerrain:!1};o.hudVisibility=this.renderHUDVisibility(),d||this.renderInternalSlot(20),this.performanceInfo.advance(9),this.renderEdges(1,d),this.performanceInfo.advance(8),o.transparentTerrain=this.renderTransparentTerrain(),o.transparentTerrain&&o.hudVisibility&&(d?this.renderLineCallouts(0):n.compositeTransparentTerrainOntoHUDVisibility(),this.renderHUD(0,n.framebuffer),this.performanceInfo.advance(16)),this.performanceInfo.advance(10),this.setTerrainCulling(!1),o.transparentTerrain&&(n.compositeTransparentTerrainOntoMain(),d&&(this.renderEdges(2),this.performanceInfo.advance(6),this._oitEnabled?this.renderOrderIndependentTransparency((()=>this.renderTransparentGeometry()),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderEdges(1),this.performanceInfo.advance(8))),d&&this.renderLineCallouts(1),this.setMultipassFlags(!1),this._shadowAccumulator.render(),n.renderToTargets((()=>{this.renderInternalSlot(8),this.renderSlot(15),this.renderSlot(16)}),n.currentColorTarget,n.mainDepth),this.performanceInfo.advance(11),this._renderPlugins.needsLaserlineWithContrastControl&&n.renderTmpAndCompositeToMain((()=>{this.renderSlot(17)}),2),this.performanceInfo.advance(12),this.renderOccluded(),this.performanceInfo.advance(13);const l=!s&&this._magnifierHelper.enabled,c=l&&i(e)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):e;this._rctx.bindFramebuffer(c),this.renderAntiAliasing(this._antialiasing,this._offscreenRendering.colorTexture)||this._compositingHelper.composite(this._offscreenRendering.colorTexture,0),this.performanceInfo.advance(14),this.renderHUD(1,c),this.performanceInfo.advance(17),this.renderHighlights(c,this._bindParameters),this.performanceInfo.advance(15),l&&this._magnifierHelper.render(this._rctx,this._bindParameters),c!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._offscreenRendering.tmpColorTexture,0)),this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera),this._sliceHelper.plane=a,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.postrender()}readDepthPixels(e,r,t,s,n,i){const a=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this._needsLinearDepth){this.ensureBindParameters(e),this._renderContext.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const r=17664;this._rctx.clearSafe(r),this.renderGeometryAndTransparentTerrainPass(2)}a.readPixels(r,t,s,n,6408,5121,i)}readAccumulatedShadow(e,r){return this._shadowAccumulator.readAccumulatedShadow(e,r)}setMultipassFlags(e){this._renderContext.multipassTerrainParams.multipassTerrainEnabled=this._bindParameters.multipassTerrainEnabled=e,this._renderContext.multipassGeometryParams.multipassGeometryEnabled=this._bindParameters.multipassGeometryEnabled=e}setTerrainCulling(e){this._renderContext.multipassTerrainParams.cullAboveGround=this._bindParameters.cullAboveGround=e}renderSlot(e){return this._renderContext.slot=e,this._renderPlugins.render()}renderEdges(e,r=!1){const t=this._edgeView;n(t)&&t.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain((()=>t.render(this._bindParameters,e)),1,r)}renderShadowMap(e,r,t,s){const n=this._shadowMap;if(n.enabled){if(u.ENABLE_PROFILE_DEPTH_RANGE&&h.begin("depthRange"),u.ENABLE_PROFILE_DEPTH_RANGE&&h.end("depthRange"),n.start(r,t,s),this.needsShadowHighlight){const e=this._shadowHighlightHelper;this.renderShadowCascades(7,this._shadowMap,(r=>n.takeCascadeSnapshotTo(r,e.highlightShadowMapSlot))),n.clear(),this.renderShadowCascades(6,this._shadowMap,(r=>{n.takeCascadeSnapshotTo(r,e.defaultSnapshotSlot),this.renderGeometryAndTransparentTerrainPass(7)}))}else this.renderShadowCascades(4);n.finish(e),r.setGLViewport(this._rctx)}}renderShadowCascades(e,r=this._shadowMap,t=(e=>{})){for(const s of r.getCascades())s.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(s.camera),this.renderGeometryAndTransparentTerrainPass(e),t(s)}get _needsLinearDepth(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this.needsShadowHighlight||this.needsShadowAccumulation}renderLinearDepth(){this._needsLinearDepth?this._offscreenRendering.renderToTargets((()=>this.renderGeometryAndTransparentTerrainPass(2)),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth),this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture}renderTerrainLinearDepth(e){if(e){const e=this._renderContext.pass;this._renderContext.pass=2,this._offscreenRendering.renderToTargets((()=>this.renderTransparentTerrain()),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.pass=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._renderContext.multipassTerrainParams.terrainLinearDepthTexture=this._bindParameters.terrainLinearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture}renderGeometryLinearDepth(e){if(e){const e=this._renderContext.pass;this._offscreenRendering.renderToTargets((()=>this.renderGeometryPass(2)),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.pass=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._renderContext.multipassGeometryParams.geometryLinearDepthTexture=this._bindParameters.geometryLinearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture}get needsNormal(){return this._ssaoHelper.enabled}renderNormal(){this.needsNormal?this._offscreenRendering.renderToTargets((()=>{this.renderGeometryAndTransparentTerrainPass(3)}),this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)}get needsDepthRange(){return this._shadowMap.enabled||this.needsShadowAccumulation}computeDepthRange(e){if(!this.needsDepthRange)return T;const r=R(e,this._content,this._stage.layers);return x(r,this.renderPlugins.queryDepthRange(e)),r.near=Math.max(e.near,r.near),r.far=Math.min(e.far,r.far),r}renderGeometryAndTransparentTerrainPass(e){this._renderContext.pass=e,this.renderGeometryPass(e),this.renderTransparentTerrain()}renderGeometryPass(e){this._renderContext.pass=e,this.renderOpaqueGeometry(),this.renderTransparentGeometry()}renderOpaqueGeometry(){this.renderSlot(1),this.renderSlot(2),this.renderInternalSlot(3),this.renderSlot(4),this.renderSlot(14)}renderTransparentGeometry(){this.renderInternalSlot(5),this.renderSlot(6)}renderTransparentTerrain(){return this.renderSlot(7)}renderHUDVisibility(){let e=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility((()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper?this._renderContext.offscreenRenderingHelper.hudVisibilityTexture:null,e=this.renderInternalSlot(12)}),this._multipassTerrain&&!this._opaqueTerrain),e}renderLineCallouts(e){this._bindParameters.renderTransparentlyOccludedHUD=e,0===e?this._offscreenRendering.renderToTargets((()=>this.renderInternalSlot(20)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderInternalSlot(20)}renderHUD(e,r){this._oitEnabled?(this.renderOrderIndependentTransparency((()=>this.renderHUDElements(e)),!0),this._rctx.bindFramebuffer(r),this._compositingHelper.composite(this._offscreenRendering.hudColorTexture,2)):0===e?this._offscreenRendering.renderToTargets((()=>this.renderHUDElements(0)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderHUDElements(e)}renderHUDElements(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this.renderInternalSlot(21),this.renderInternalSlot(18),this.renderInternalSlot(19)}get needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}get needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlightHelper.isVisible&&this.needsHighlight}renderHighlights(e,r){if(!this.needsHighlight)return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const t=this._highlightHelper,s=t.profilingCallback&&j(this._renderContext.rctx);this._renderContext.highlightDepthTexture=r.highlightDepthTexture;const i=this._offscreenRendering.renderToTargets((()=>{this.renderGeometryAndTransparentTerrainPass(5),this._rctx.clearSafe(256),this.renderHUDElements(2)}),this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=i.colorTexture,this.needsShadowHighlight&&this._shadowHighlightHelper.render(r,e),t.render(this._renderContext.camera,i,e),n(s)&&t.profilingCallback&&s.stop((e=>{t.profilingCallback&&t.profilingCallback(e)}))}get needsShadowAccumulation(){return this._shadowAccumulator.isAccumulating}accumulateShadows(e,r,t){this.needsShadowAccumulation&&(this._shadowAccumulator.setAccumulationDependencies(this._offscreenRendering.linearDepthTexture,e,r,t),this._shadowAccumulator.accumulateFixedSamples(),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled)}renderOrderIndependentTransparency(e,r){const t=t=>{this._renderContext.transparencyPassType=t,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._offscreenRendering.renderOITPass((()=>e()),t,r)},s=this._renderContext.pass;this._renderContext.pass=1,t(1),this._renderContext.pass=0,t(0),t(2),this._offscreenRendering.compositeTransparentOntoOpaque(r),this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._renderContext.pass=s}renderOccluded(){let e=0;this._materialRenderers.forEach(((r,t)=>{t&&t.isVisible()&&8===t.renderOccluded&&(e|=t.renderOccluded,U.push(t))}));const r=this._offscreenRendering,t=(t,s,n,i,a)=>{0!=(e&s)&&(r.renderToTargets(n,r.tmpColor,r.mainDepth,[0,0,0,0],i,a),r.compositeOccludedOntoMain(t))};0!==U.length&&(this.renderInternalSlot(10,U),t(.5,8,(()=>this.renderInternalSlot(11,U)),!1,!1),U.length=0),this._materialRenderers.forEach(((r,t)=>{t&&t.isVisible()&&(4===t.renderOccluded||2===t.renderOccluded||16===t.renderOccluded)&&(e|=t.renderOccluded,V.push(t))}));const s=this._renderPlugins.renderOccludedFlags;if(e|=s,!e)return;const n=e=>{this._renderContext.renderOccludedMask=e,s>1&&this.renderSlot(9),this.renderInternalSlot(3,V),this.renderInternalSlot(5,V),this.renderInternalSlot(8,V),this._renderContext.resetRenderOccludedMask()};this._renderContext.pass=0,t(.5,4,(()=>n(4)),!0,2),t(.5,2,(()=>n(2)),!0,2),t(1,16,(()=>n(16)),!0,2),V.length=0}renderAntiAliasing(e,r){if(1===e){if(this._smaaPass.loadResources((()=>this.requestRender())),this._smaaPass.enable())return this._smaaPass.render({colorTexture:r}),!0}else this._smaaPass.disable();return!1}ensureCameraBindParameters(e){this._renderContext.camera=e,this._bindParameters.camera=this._renderContext.camera,this._bindParameters.inverseViewport[0]=1/this._renderContext.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/this._renderContext.camera.fullViewport[3]}ensureBindParameters(e){var r;this.ensureCameraBindParameters(e);const t=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=this._renderContext.shadowMap,this._bindParameters.shadowMappingEnabled=this._renderContext.shadowMap.enabled,this._bindParameters.ssaoHelper=this._renderContext.ssaoHelper,this._bindParameters.ssaoEnabled=this._renderContext.ssaoHelper.enabled,this._bindParameters.slicePlane=this._renderContext.sliceHelper.plane,this._bindParameters.hasOccludees=this._renderContext.hasOccludees,this._renderContext.multipassTerrainParams.camera=this._renderContext.camera,this._bindParameters.hudVisibilityTexture=t.hudVisibilityTexture,this._bindParameters.highlightDepthTexture=null!=(r=t.depthTexture)?r:this.getFallbackDepthTexture()}ensureBindParametersSSR(){this.hasWaterReflection?(this._renderContext.lastFrameCamera.equals(this._renderContext.camera)?this._renderContext.ssrParams.reprojectionMat=this._bindParameters.reprojectionMat=Q:(l(k,this._renderContext.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),l(B,this._renderContext.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),c(B,B),c(W,this._renderContext.camera.projectionMatrix),p(N,B,W),p(N,k,N),p(N,this._renderContext.lastFrameCamera.projectionMatrix,N),this._renderContext.ssrParams.reprojectionMat=this._bindParameters.reprojectionMat=N),this._renderContext.ssrParams.camera=this._renderContext.camera,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null,this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=this.hasWaterReflection}renderInternalSlot(e,r){const t=0===this._renderContext.pass?this.performanceInfo.stats:null;let s=!1;return this._bindParameters.slot=e,n(r)?r.forEach((r=>{if(!C(r,this._renderContext))return;const t=this._materialRenderers.get(r);n(t)&&(s=t.render(e,this._renderContext.pass,this._bindParameters)||s)})):this._materialRenderers.forEach(((r,n)=>{C(n,this._renderContext)&&(s=r.render(e,this._renderContext.pass,this._bindParameters,t)||s)})),s}getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=b(this._rctx)),this._fallbackDepthStencilTexture}getGpuMemoryUsage(){return{offscreen:this._offscreenRendering?this._offscreenRendering.getGpuMemoryUsage():0,highlights:(this._highlightHelper?this._highlightHelper.getGpuMemoryUsage():0)+(this._shadowHighlightHelper?this._shadowHighlightHelper.getGpuMemoryUsage():0),shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.gpuMemoryUsage:0}}get test(){const e=this;return{antialiasing:this._antialiasing,offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,lighting:this._lighting,materialRenderers:this._materialRenderers,oitEnabled:this._oitEnabled,shadowHighlights:this._shadowHighlightHelper,getFramebufferTexture:r=>{var t;switch(r){case 0:return e._offscreenRendering.colorTexture;case 1:return e._offscreenRendering.linearDepthTexture;case 2:return e._offscreenRendering.normalTexture;case 3:return null==(t=e._shadowMap)?void 0:t.test.depthTexture;case 4:return e._offscreenRendering.hudVisibilityTexture;case 5:return e._offscreenRendering.highlightTexture}}}}}const V=[],U=[],k=_(),W=_(),B=_(),N=_(),Q=_();export default F;
