/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{range as e}from"../../../../../core/arrayUtils.js";import{deg2rad as t,acosClamped as n}from"../../../../../core/mathUtils.js";import{forEach as o}from"../../../../../core/typedArrayUtil.js";import{i as r,s,g as c,d as a,r as i,c as l,f as g,n as f}from"../../../../../chunks/vec3.js";import{c as m}from"../../../../../chunks/vec3f64.js";const p=-1;function u(n,i,l,g=V){const f=n.vertices.position,m=n.vertices.componentIndex,u=t(g.anglePlanar),I=t(g.angleSignificantEdge),N=Math.cos(I),j=Math.cos(u),x=y.edge,F=x.position0,E=x.position1,U=x.faceNormal0,k=x.faceNormal1,D=w(n),M=v(n),P=M.length/4,S=i.allocate(P);let b=0;const L=P,q=l.allocate(L);let z=0,B=0,C=0;const G=e(0,P),H=new Float32Array(P);o(H,((e,t,n)=>{f.getVec(M[4*t+0],F),f.getVec(M[4*t+1],E),n[t]=r(F,E)})),G.sort(((e,t)=>H[t]-H[e]));const J=new Array,K=new Array;for(let e=0;e<P;e++){const t=G[e],n=H[t],o=M[4*t+0],r=M[4*t+1],g=M[4*t+2],v=M[4*t+3],w=v===p;if(f.getVec(o,F),f.getVec(r,E),w)s(U,D[3*g+0],D[3*g+1],D[3*g+2]),c(k,U),x.componentIndex=m.get(o),x.cosAngle=a(U,k);else{if(s(U,D[3*g+0],D[3*g+1],D[3*g+2]),s(k,D[3*v+0],D[3*v+1],D[3*v+2]),x.componentIndex=m.get(o),x.cosAngle=a(U,k),d(x,j))continue;x.cosAngle<-.9999&&c(k,U)}B+=n,C++,w||h(x,N)?(i.write(S,b++,x),J.push(n)):A(x,u)&&(l.write(q,z++,x),K.push(n))}const O=new Float32Array(J.reverse()),Q=new Float32Array(K.reverse());return{regular:{instancesData:i.trim(S,b),lodInfo:{lengths:O}},silhouette:{instancesData:l.trim(q,z),lodInfo:{lengths:Q}},averageEdgeLength:B/C}}function h(e,t){return e.cosAngle<t}function d(e,t){return e.cosAngle>t}function A(e,t){const o=n(e.cosAngle),r=y.fwd,s=y.ortho;i(r,e.position1,e.position0);return o*(a(l(s,e.faceNormal0,e.faceNormal1),r)>0?-1:1)>t}function v(e){const t=e.faces.length/3,n=e.faces,o=e.neighbors;let r=0;for(let a=0;a<t;a++){const e=o[3*a+0],t=o[3*a+1],s=o[3*a+2],c=n[3*a+0],i=n[3*a+1],l=n[3*a+2];r+=e===p||c<i?1:0,r+=t===p||i<l?1:0,r+=s===p||l<c?1:0}const s=new Int32Array(4*r);let c=0;for(let a=0;a<t;a++){const e=o[3*a+0],t=o[3*a+1],r=o[3*a+2],i=n[3*a+0],l=n[3*a+1],g=n[3*a+2];(e===p||i<l)&&(s[c++]=i,s[c++]=l,s[c++]=a,s[c++]=e),(t===p||l<g)&&(s[c++]=l,s[c++]=g,s[c++]=a,s[c++]=t),(r===p||g<i)&&(s[c++]=g,s[c++]=i,s[c++]=a,s[c++]=r)}return s}function w(e){const t=e.faces.length/3,n=e.vertices.position,o=e.faces,r=I.v0,s=I.v1,c=I.v2,a=new Float32Array(3*t);for(let i=0;i<t;i++){const e=o[3*i+0],t=o[3*i+1],m=o[3*i+2];n.getVec(e,r),n.getVec(t,s),n.getVec(m,c),g(s,s,r),g(c,c,r),l(r,s,c),f(r,r),a[3*i+0]=r[0],a[3*i+1]=r[1],a[3*i+2]=r[2]}return a}const y={edge:{position0:m(),position1:m(),faceNormal0:m(),faceNormal1:m(),componentIndex:0,cosAngle:0},ortho:m(),fwd:m()},I={v0:m(),v1:m(),v2:m()},V={anglePlanar:4,angleSignificantEdge:35};export{u as extractEdges};
