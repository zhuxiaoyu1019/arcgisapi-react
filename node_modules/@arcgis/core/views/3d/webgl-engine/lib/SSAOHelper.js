/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{disposeMaybe as e,isSome as t,isNone as s}from"../../../../core/maybe.js";import{a as i}from"../../../../chunks/vec2f64.js";import{i as r}from"../../../../chunks/vec3.js";import{c as o}from"../../../../chunks/vec4.js";import{c as a}from"../../../../chunks/vec4f64.js";import{requestImage as h}from"../../../../support/requestImageUtils.js";import{createQuadVAO as n}from"./glUtil3D.js";import{SSAOTechniqueConfiguration as _,FILTER_RADIUS as u,SSAOTechnique as l}from"./SSAOTechnique.js";import{inverseProjectionInfo as m}from"./Util.js";import p from"../../../webgl/FramebufferObject.js";import d from"../../../webgl/Texture.js";import{vertexCount as c}from"../../../webgl/Util.js";class f{constructor(e,t,s){this._techniqueRep=e,this._rctx=t,this._requestRender=s,this._enabled=!1,this._ssaoTechniqueConfig=new _,this.quadVAO=null,this._BLUR_F=2,this._attenuation=.5,this._radius=3,this._samples=16,this._viewportToRestore=a()}dispose(){this.quadVAO=e(this.quadVAO)}set enabled(e){e?this._enable():this._disable()}get enabled(){return this._enabled}set attenuation(e){this._attenuation=e}get attenuation(){return this._attenuation}set radius(e){this._radius=e}get radius(){return this._radius}set samples(e){this._samples=e,this._enabled&&this._selectPrograms()}get samples(){return this._samples}get ready(){return this.enabled&&t(this._noiseTexture)&&t(this._ssaoFBO)&&t(this._blur0FBO)&&t(this._blur1FBO)}computeSSAO(e,t,i){if(!this.enabled||s(this._noiseTexture)||s(this._ssaoFBO)||s(this._blur0FBO)||s(this._blur1FBO))return;const a=this._rctx,h=e.fullViewport,_=h[2],l=h[3],p=_/this._BLUR_F,d=l/this._BLUR_F;this._ssaoFBO.resize(_,l),this._blur0FBO.resize(p,d),this._blur1FBO.resize(p,d);const f=1,g=1,T=_*f,O=l*g;o(this._viewportToRestore,e.fullViewport),a.bindFramebuffer(this._ssaoFBO),a.setViewport(0,0,_,l);const B=this._ssaoTechnique.program;a.useProgram(B),a.setPipelineState(this._ssaoTechnique.pipeline),B.setUniform2f("rnmScale",_/this._noiseTexture.descriptor.width,l/this._noiseTexture.descriptor.height),B.setUniform3fv("pSphere",this._samples<=8?this._data.random8:this._samples<=16?this._data.random16:this._samples<=32?this._data.random32:this._data.random64);const x=this._data.minDiscrepancy,U=this._samples<x.length?x[this._samples]:5779;B.setUniform1f("numSpiralTurns",U);const w=F,q=b;m(e.projectionMatrix,e.fullWidth,e.fullHeight,w,q),B.setUniform4fv("projInfo",w),B.setUniform2fv("zScale",q),B.setUniform2f("nearFar",e.near,e.far);let R=1/e.computeRenderPixelSizeAtDist(1);B.setUniform1f("projScale",R*f),B.setUniform2f("screenDimensions",T,O);const S=r(e.eye,e.center);let A=20*e.computeRenderPixelSizeAtDist(S);A=Math.max(.1,A),B.setUniform1f("radius",A),B.setUniform1f("intensity",4*this._attenuation/A**6),B.bindTexture(this._noiseTexture,"rnm"),B.bindTexture(i,"normalMap"),B.bindTexture(t,"depthMap"),s(this.quadVAO)&&(this.quadVAO=n(this._rctx));const j=this.quadVAO;a.bindVAO(j),a.drawArrays(5,0,c(j,"geometry"));const v=(u+1)/2,y=1/(2*v*v),M=this._blurTechnique.program;a.useProgram(M),M.bindTexture(this._ssaoFBO.colorTexture,"tex"),M.bindTexture(i,"normalMap"),M.bindTexture(t,"depthMap"),a.setViewport(0,0,T/this._BLUR_F,O/this._BLUR_F),a.bindFramebuffer(this._blur0FBO),M.setUniform2f("screenDimensions",T,O),M.setUniform2f("blurSize",0,this._BLUR_F*f/O),M.setUniform1i("radius",u),M.setUniform1f("g_BlurFalloff",y),M.setUniform2f("nearFar",e.near,e.far),S>5e4&&(R=Math.max(0,R-(S-5e4))),M.setUniform1f("projScale",R),M.setUniform2f("zScale",1,0),a.drawArrays(5,0,c(j,"geometry")),M.setUniform2f("blurSize",this._BLUR_F*g/T,0),a.bindFramebuffer(this._blur1FBO),M.bindTexture(this._blur0FBO.colorTexture,"tex"),a.drawArrays(5,0,c(j,"geometry")),a.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3])}bind(e){this.enabled&&t(this._blur1FBO)&&t(this._ssaoFBO)?(e.bindTexture(this._blur1FBO.colorTexture,"ssaoTex"),e.setUniform4f("viewportPixelSz",this._viewportToRestore[0],this._viewportToRestore[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height)):e.setUniform4f("viewportPixelSz",-1,-1,-1,-1)}_selectPrograms(){const e=this._samples<=8?0:this._samples<=16?1:this._samples<=32?2:3;this._ssaoTechniqueConfig.samples=e,this._ssaoTechniqueConfig.output=0,this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(l,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=1,this._blurTechnique=this._techniqueRep.releaseAndAcquire(l,this._ssaoTechniqueConfig,this._blurTechnique)}_enable(){this.enabled||(this._enabled=!0,this._loadResources((()=>{this._enabled&&this._initialize()})))}_loadResources(e){this._data?e():import("./SSAOHelperData.js").then((t=>{this._data=t,e()}))}_initialize(){const e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},t={colorTarget:0,depthStencilTarget:0};h(this._data.noiseTexture).then((s=>{this._enabled&&(this._ssaoFBO=new p(this._rctx,t,e),this._blur0FBO=new p(this._rctx,t,e),this._blur1FBO=new p(this._rctx,t,e),this._noiseTexture=new d(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:s.width,height:s.height},s),this._requestRender())})),this._selectPrograms()}_disable(){this._enabled=!1,this._noiseTexture=e(this._noiseTexture),this._blur1FBO=e(this._blur1FBO),this._blur0FBO=e(this._blur0FBO),this._ssaoFBO=e(this._ssaoFBO)}get gpuMemoryUsage(){return(t(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(t(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(t(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}const b=i(),F=a();export default f;
