/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{isSome as e,isNone as t}from"../../../../core/maybe.js";import r from"../../../../core/PooledArray.js";import{m as i,d as n}from"../../../../chunks/mat4.js";import{c as s}from"../../../../chunks/mat4f64.js";import{m as a}from"../../../../chunks/vec3.js";import{l as o}from"../../../../chunks/vec4.js";import{c as h}from"../../../../chunks/vec4f64.js";import{intersectsSphere as f,create as c,copy as l}from"../../../../geometry/support/frustum.js";import{c as u}from"../../../../chunks/sphere.js";import{maxScale as d}from"../../support/mathUtils.js";import{empty as g,union as m,set as p}from"./depthRange.js";import{unpackFloatRGBA as b,assert as w}from"./Util.js";const v=1e4,j=100,R=500,B=500,C=.1;function M(e,t,r){return b(t,e)*(r[1]-r[0])+r[0]}function A(e,t,r){if(t.size<v)return U.compute(e,t);const i=g();return r.forAll((t=>{t.isVisible&&m(i,S(e,t))})),i}function S(t,r){if(!r.isVisible)return;const i=g(),n=r.getSpatialQueryAccelerator();return e(n)?y(i,t,n):I(i,t,r.objects),i}function y(e,t,r){const i=t.eye,n=t.viewForward,s=t.frustum,a=e=>e.isVisible,o=r.objectCount;if(o<R)p(N,t.near,Math.min(e.near,t.far)),r.forEachInDepthRange(i,n,1,N,((r,i)=>{P(e,t,r),N.far=e.near,i.setRange(N)}),s,a),p(N,Math.max(e.far,t.near),t.far),r.forEachInDepthRange(i,n,-1,N,((r,i)=>{P(e,t,r),N.near=e.far,i.setRange(N)}),s,a);else{const i=Math.max(Math.min(o,B),Math.ceil(o*C)),h=r.findClosest(n,1,s,a,i),f=r.findClosest(n,-1,s,a,i);h&&f&&(V(e,t,h.boundingVolumeWorldSpace.bounds),V(e,t,f.boundingVolumeWorldSpace.bounds))}}function I(e,t,r){T.clear(),r.forAll((e=>{e.isVisible&&0!==e.getNumGeometryRecords()&&T.add(e)})),T.empty||(T.sort(t),p(N,t.near,Math.min(e.near,t.far)),T.forEachInDepthRange(N,1,((r,i)=>{i<e.near&&P(e,t,r)})),p(N,Math.max(e.far,t.near),t.far),T.forEachInDepthRange(N,-1,((t,r,i)=>{e.far=Math.max(e.far,i)})))}function P(e,t,r){if(!r.isVisible)return;if(!f(t.frustum,r.boundingVolumeWorldSpace.bounds))return;const n=r.transformation,s=F;r.geometryRecords.forEach((r=>{i(s,n,r.getShaderTransformation());const a=d(s);x(e,t,r.geometry.boundingInfo,s,a)}))}function x(e,r,i,n,s){if(t(i))return;const o=r.eye,h=r.viewForward;a(k,i.center,n);const c=h[0]*(k[0]-o[0])+h[1]*(k[1]-o[1])+h[2]*(k[2]-o[2]);if(k[3]=i.radius*s,!(c-k[3]>e.near&&c+k[3]<e.far)&&f(r.frustum,k))if(i.radius>j&&i.getChildren()){const t=i.getChildren();for(let i=0;i<8;++i)t[i]&&x(e,r,t[i],n,s)}else L.unionDepthRangeWithAABB(e,r.viewProjectionMatrix,n,i.bbMin,i.bbMax)}function V(e,t,r){const i=t.eye,n=t.viewForward,s=(r[0]-i[0])*n[0]+(r[1]-i[1])*n[1]+(r[2]-i[2])*n[2];e.near=Math.min(e.near,s-r[3]),e.far=Math.max(e.far,s+r[3])}class _{constructor(){this._items=new r({allocator:e=>e||{obj:null,distance:0,near:0,far:0},deallocator:e=>(e.obj=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().obj=e}sort(e){const t=e.eye,r=e.viewForward;this._items.forAll((e=>{const i=e.obj.boundingVolumeWorldSpace.bounds,n=(i[0]-t[0])*r[0]+(i[1]-t[1])*r[1]+(i[2]-t[2])*r[2];e.distance=n,e.near=n-i[3],e.far=n+i[3]})),this._items.sort(((e,t)=>e.distance-t.distance))}forEachInDepthRange(e,t,r){if(1===t)for(let i=0;i<this._items.length;++i){const t=this._items.data[i];t.far<e.near||t.near>e.far||r(t.obj,t.near,t.far)}else for(let i=this._items.length-1;i>=0;--i){const t=this._items.data[i];t.far<e.near||t.near>e.far||r(t.obj,t.near,t.far)}}}class D{constructor(){this.view=s(),this.viewProj=s(),this.frustum=c(),this.geometries=[],this.near=[],this.far=[],this.nearCandidates=[],this.farCandidates=[],this.range={near:0,far:0},this.looseRange={near:0,far:0}}compute(e,t){this.reset(),n(this.view,e.viewMatrix),i(this.viewProj,e.projectionMatrix,this.view),l(e.frustum,this.frustum);const r=this.view,s=r[2],a=r[6],o=r[10],h=r[14],f=this.range;let c=0;if(t.forEach((e=>{if(!e.instanceParameters.visible)return;if(!e.castShadow)return;let t;e.hasShaderTransformation?(e.computeBoundingSphere(e.getShaderTransformation(),k,1),t=k):t=e.boundingSphere;const r=s*t[0]+a*t[1]+o*t[2]+h,i=r-t[3],n=r+t[3];this.geometries[c]=e,this.near[c]=-n,this.far[c]=-i,++c})),0===this.geometries.length)return f;for(let i=0;i<this.geometries.length;++i)this.near[i]>f.far&&(f.far=this.near[i]),this.near[i]>2&&this.far[i]<f.near&&(f.near=this.far[i]);const u=this.looseRange;u.near=Math.max(.5*f.near,2),u.far=2*f.far;let d=0,g=0;for(let i=0;i<this.geometries.length;++i)this.near[i]<f.near&&(this.near[i]>=u.near?f.near=this.near[i]:this.nearCandidates[d++]=i),this.far[i]>f.far&&(this.far[i]<=u.far?f.far=this.far[i]:this.farCandidates[g++]=i);if(0===this.nearCandidates.length&&0===this.farCandidates.length)return f;this.nearCandidates.sort(((e,t)=>this.near[e]<this.near[t]?-1:this.near[e]>this.near[t]?1:0)),this.farCandidates.sort(((e,t)=>this.far[e]<this.far[t]?1:this.far[e]>this.far[t]?-1:0));for(let i=0;i<this.nearCandidates.length;++i){const e=this.nearCandidates[i];if(this.near[e]<f.near){const t=this.geometries[e],r=t.boundingInfo;this.includeNearBoundingInfoRec(r,t.getShaderTransformation())}}for(let i=0;i<this.farCandidates.length;++i){const e=this.farCandidates[i];if(this.far[e]>f.far){const t=this.geometries[e],r=t.boundingInfo;this.includeFarBoundingInfoRec(r,t.getShaderTransformation())}}return f}reset(){this.geometries.length=0,this.near.length=0,this.far.length=0,this.nearCandidates.length=0,this.farCandidates.length=0,this.range.near=Number.MAX_VALUE,this.range.far=-Number.MAX_VALUE}includeNearBoundingInfoRec(e,r){if(t(e))return;const i=e.getCenter();a(k,i,r);const n=d(r),s=k[0],o=k[1],h=k[2],f=e.getBSRadius()*n,c=this.frustum;if(c[0][0]*s+c[0][1]*o+c[0][2]*h+c[0][3]>f||c[1][0]*s+c[1][1]*o+c[1][2]*h+c[1][3]>f||c[2][0]*s+c[2][1]*o+c[2][2]*h+c[2][3]>f||c[3][0]*s+c[3][1]*o+c[3][2]*h+c[3][3]>f)return;const l=this.view[2]*s+this.view[6]*o+this.view[10]*h+this.view[14],u=l+f;if(!(-(l-f)<2||-u>=this.range.near))if(-u>this.looseRange.near)this.range.near=-u;else{if(f>j){const t=e.getChildren();if(void 0!==t){for(let e=0;e<8;++e)void 0!==t[e]&&this.includeNearBoundingInfoRec(t[e],r);return}}L.unionDepthRangeWithAABB(this.range,this.viewProj,r,e.getBBMin(),e.getBBMax())}}includeFarBoundingInfoRec(e,r){if(t(e))return;let i=e.getBSRadius();const n=e.getCenter();a(k,n,r);const s=d(r),o=k[0],h=k[1],f=k[2];i*=s;const c=this.frustum;if(c[0][0]*o+c[0][1]*h+c[0][2]*f+c[0][3]>i||c[1][0]*o+c[1][1]*h+c[1][2]*f+c[1][3]>i||c[2][0]*o+c[2][1]*h+c[2][2]*f+c[2][3]>i||c[3][0]*o+c[3][1]*h+c[3][2]*f+c[3][3]>i)return;const l=this.view[2]*o+this.view[6]*h+this.view[10]*f+this.view[14]-i;if(!(-l<=this.range.far))if(-l<this.looseRange.far)this.range.far=-l;else{if(i>j){const t=e.getChildren();if(void 0!==t){for(let e=0;e<8;++e)void 0!==t[e]&&this.includeFarBoundingInfoRec(t[e],r);return}}L.unionDepthRangeWithAABB(this.range,this.viewProj,r,e.getBBMin(),e.getBBMax())}}}class E{constructor(){this.modelViewProj=s(),this.clipPosition=[h(),h(),h(),h(),h(),h(),h(),h()]}unionDepthRangeWithAABB(e,t,r,n,s){const a=this.modelViewProj;i(a,t,r);let o=!1;for(let i=0;i<8;++i){const e=this.clipPosition[i],t=0===i||3===i||4===i||7===i?n[0]:s[0],r=0===i||1===i||4===i||5===i?n[1]:s[1],o=i<4?n[2]:s[2];e[0]=a[0]*t+a[4]*r+a[8]*o+a[12],e[1]=a[1]*t+a[5]*r+a[9]*o+a[13],e[2]=a[2]*t+a[6]*r+a[10]*o+a[14],e[3]=a[3]*t+a[7]*r+a[11]*o+a[15]}for(let i=0;i<12;++i){const t=this.clipPosition[W[i][0]],r=this.clipPosition[W[i][1]],n=this.clipPosition[W[i][2]],s=this.clipTriangle(t,r,n);let a=!0;for(let e=0;e<s.length;++e){if(s[e][3]>=2){a=!1;break}}if(!a){o=!0;for(let t=0;t<s.length;++t){const r=s[t][3];r<e.near&&(e.near=r),r>e.far&&(e.far=r)}}}return o}inside(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void w(!1)}intersect(e,t,r){let i=0;return 0===r?i=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===r?i=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===r?i=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===r&&(i=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),o(h(),e,t,i)}clipTriangle(e,t,r){let i=[e,t,r];for(let n=0;n<4;++n){const e=i;i=[];for(let t=0;t<e.length;++t){const r=e[t],s=e[(t+1)%e.length];this.inside(s,n)?(this.inside(r,n)||i.push(this.intersect(r,s,n)),i.push(s)):this.inside(r,n)&&i.push(this.intersect(r,s,n))}}return i}}const W=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],k=u(),F=s(),N=g(),T=new _,U=new D,L=new E;export{D as DepthRangeFromRenderGeometries,S as depthRangeFromLayer,A as depthRangeFromScene,M as textureToDepth};
