/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../core/Accessor.js";import r from"../../../core/Handles.js";import{isNone as s,isSome as o,applySome as i}from"../../../core/maybe.js";import n from"../../../core/PooledArray.js";import{isPromise as d}from"../../../core/promiseUtils.js";import{property as a}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import"../../../core/Logger.js";import{subclass as l}from"../../../core/accessorSupport/decorators/subclass.js";import{isIntersectionHandler as c}from"../state/helpers/SceneIntersectionHelper.js";import{AutoDisposableMixin as h,autoDispose as m}from"./lib/AutoDisposable.js";import{ChangeSet as y}from"./lib/ChangeSet.js";import{GeometryRecord as p}from"./lib/GeometryRecord.js";import{isWebGLLayer as _}from"./lib/WebGLLayer.js";import{Model as g}from"./parts/Model.js";import{RenderView as u}from"./parts/RenderView.js";import{TaskPriority as S}from"../../support/Scheduler.js";var f;let w=f=class extends(h(t)){constructor(e){super(e),this._handles=new r,this._model=new g,this._layers=new n,this._changeSet=new y,this._layerSyncSet=new Set}initialize(){this._set("renderView",new u(this)),this._frameTask=this.resourceController.scheduler.registerTask(S.STAGE,this),this._handles.add(this._frameTask)}destroy(){p.pool.prune(0),this._handles.destroy(),this.dispose()}get viewingMode(){return this.state.viewingMode}get updating(){return this._model.dirtySet.dirty||this.renderView.updating}add(e){this._model.add(e),_(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.setNeedsRender()}remove(e){s(e)||(this.renderView.setNeedsRender(),this._model.remove(e),_(e)&&(this._removeLayer(e),e.detachStage()))}addMany(e){o(e)&&(this._model.addMany(e),this.renderView.setNeedsRender())}removeMany(e){o(e)&&(this._model.removeMany(e),this.renderView.setNeedsRender())}forEachOfType(e,t){this._model.forEachOfType(e,t)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.setNeedsRender())}get running(){return this._model.dirtySet.dirty}runTask(e){this._frameTask.processQueue(e),e.done||this._commit()}_commit(){const e=this._model.dirtySet;f.DebugSettings.logDirtySet&&console.log("Dirty set: "+e.formatDebugInfo()),e.commit(this._changeSet),f.DebugSettings.logDirtySet&&(console.log("RGs add: "+this._changeSet.adds.map((e=>e.id))),console.log("RGs remove: "+this._changeSet.removes.map((e=>e.id)))),this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.setNeedsRender()}schedule(e,t){return this._frameTask.schedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.setNeedsRender()}processSyncLayers(){const e=this._model.dirtySet;this._layers.forAll((t=>{(this._layerSyncSet.has(t.id)||1===t.updatePolicy)&&(e.commitLayer(t.id,this._changeSet),this._layerSyncSet.delete(t.id))}));for(const t of this._layerSyncSet)e.commitLayer(t,this._changeSet);this._layerSyncSet.clear(),this.renderView.modify(this._changeSet)}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.some((t=>t===e))||this._layers.push(e)}_removeLayer(e){this._commit(),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._changeSet.removes),this.renderView.modify(this._changeSet))}addRenderPlugin(e,t,r){const s=this.renderView.renderPlugins.add(e,t,r),o=()=>{c(t)&&this.sceneIntersectionHelper.addIntersectionHandler(t)};if(d(s))return s.then(o);o()}removeRenderPlugin(e){c(e)&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const e=this;return{getCount:t=>e._model.test.content.filter((e=>e.type===t)).length,stopAnimations:t=>e._model.test.content.filter((e=>3===e.type)).forEach((e=>i(e.animation,(e=>e.stopAtTime(t))))),model:e._model}}};w.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},e([a({constructOnly:!0})],w.prototype,"resourceController",void 0),e([a({constructOnly:!0})],w.prototype,"options",void 0),e([a({constructOnly:!0})],w.prototype,"state",void 0),e([a({constructOnly:!0})],w.prototype,"sceneIntersectionHelper",void 0),e([a({readOnly:!0})],w.prototype,"viewingMode",null),e([a({constructOnly:!0})],w.prototype,"container",void 0),e([a({constructOnly:!0})],w.prototype,"renderSR",void 0),e([a({constructOnly:!0})],w.prototype,"_handles",void 0),e([a({readOnly:!0})],w.prototype,"updating",null),e([a({constructOnly:!0})],w.prototype,"_model",void 0),e([m(),a()],w.prototype,"renderView",void 0),w=f=e([l("esri.views.3d.webgl-engine.Stage")],w);export{w as Stage};
