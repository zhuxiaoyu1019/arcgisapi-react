/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import t from"../../../../../core/PooledArray.js";import{h as n,d as e}from"../../../../../chunks/mat3.js";import{c as o}from"../../../../../chunks/mat3f64.js";import{c as r}from"../../../../../chunks/quat.js";import{a}from"../../../../../chunks/quatf64.js";import{d as s,w as c,q as f,b as l,s as u,e as i,g as h,t as m}from"../../../../../chunks/vec3.js";import{c as p}from"../../../../../chunks/vec3f64.js";import{signedDistance as d}from"../../../../../geometry/support/plane.js";import{projectedRadius as g,intersectPlane as j}from"../../../support/orientedBoundingBox.js";import{empty as b,within as k,union as w}from"../../lib/depthRange.js";function z(t,n){const e=b(),{eye:o,frustum:r,viewForward:a}=t;for(let f=0;f<n.length;f++){const t=n[f].obb,l=s(c(E,t.center,o),a),u=g(t,a);if(k(e,l-u)&&k(e,l+u))continue;const i=R(t,r);if(-1===i)continue;if(0===i){q.far=l+u,q.near=l-u,w(e,q);continue}const h=S.pushNew();h.near=l-u,h.far=l+u,h.mask=i,h.object=n[f]}for(let f=0;f<S.length;f++){const t=S.data[f];if(k(e,t.near)&&k(e,t.far))continue;q.far=t.far,q.near=1/0;0===M(t.object.obb,o,x,(n=>{let e=A;for(let o=0;o<P&&n.length>0;o++){if(0==(t.mask&1<<o))continue;B(r[o],n,e);const a=n;n=e,e=a}for(let t=0;t<n.length;t+=3){u(y,n.data[t+0],n.data[t+1],n.data[t+2]);const e=s(c(y,y,o),a);q.near=Math.min(q.near,e)}}))&&(q.near=0),w(e,q)}return S.length=0,e}const S=new t({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:t=>(t.object=null,t)}),q=b(),y=p(),v=p(),x=new t({deallocator:null}),A=new t({deallocator:null});function B(t,n,e){e.length=0;const o=n.length-3;F(y,n,o);const r=d(t,y);r<=0&&(e.push(y[0]),e.push(y[1]),e.push(y[2]));let a=0,s=r;for(;a<o;a+=3){F(v,n,a);const o=d(t,v);if(s*o<0){i(y,v,y,o/(o-s)),I(e,y)}o<=0&&I(e,v),s=o,h(y,v)}if(s*r<0){F(v,n,o);i(y,v,y,r/(r-s)),I(e,y)}}function F(t,n,e){return u(t,n.data[e+0],n.data[e+1],n.data[e+2])}function I(t,n){t.push(n[0]),t.push(n[1]),t.push(n[2])}function M(t,o,a,s){r(D,t.quaternion),c(E,o,t.center),f(E,E,D);const i=8*((E[0]<-t.halfSize[0]?-1:E[0]>t.halfSize[0]?1:0)+3*(E[1]<-t.halfSize[1]?-1:E[1]>t.halfSize[1]?1:0)+9*(E[2]<-t.halfSize[2]?-1:E[2]>t.halfSize[2]?1:0)+13),h=N[i];if(0===h)return h;n(C,t.quaternion),e(C,C,t.halfSize);const p=(n,e)=>{const o=N[i+e+1];return u(n,((1&o)<<1)-1,(2&o)-1,((4&o)>>1)-1),m(n,n,C),l(n,t.center,n)};return a.length=0,I(a,p(G,0)),I(a,p(H,1)),I(a,p(E,2)),I(a,p(J,3)),s(a),1===h?h:(a.length=0,I(a,G),I(a,J),I(a,p(E,4)),I(a,p(K,5)),s(a),2===h||(a.length=0,I(a,G),I(a,K),I(a,p(E,6)),I(a,H),s(a)),h)}const N=(()=>{const t=new Int8Array(216);let n=0;const e=e=>{for(let o=0;o<e.length;o++)t[n+o]=e[o];n+=8};return e([3,0,6,2,3,1,5,4]),e([2,0,2,3,1,5,4,0]),e([3,1,0,2,3,7,5,4]),e([2,0,1,3,2,6,4,0]),e([1,0,1,3,2,0,0,0]),e([2,1,5,7,3,2,0,0]),e([3,2,0,1,3,7,6,4]),e([2,2,0,1,3,7,6,0]),e([3,3,0,1,5,7,6,2]),e([2,0,1,5,4,6,2,0]),e([1,0,1,5,4,0,0,0]),e([2,1,3,7,5,4,0,0]),e([1,0,2,6,4,0,0,0]),e([0,0,0,0,0,0,0,0]),e([1,1,3,7,5,0,0,0]),e([2,2,3,7,6,4,0,0]),e([1,2,3,7,6,0,0,0]),e([2,3,1,5,7,6,2,0]),e([3,4,0,1,5,7,6,2]),e([2,5,7,6,4,0,1,0]),e([3,5,0,1,3,7,6,4]),e([2,4,5,7,6,2,0,0]),e([1,4,5,7,6,0,0,0]),e([2,5,1,3,7,6,4,0]),e([3,6,0,2,3,7,5,4]),e([2,6,2,3,7,5,4,0]),e([3,7,6,2,3,1,5,4]),t})(),P=4;function R(t,n){let e=0;for(let o=0;o<P;o++){const r=j(t,n[o]);if(r>0)return-1;0===r&&(e|=1<<o)}return e}const C=o(),D=a(),E=p(),G=p(),H=p(),J=p(),K=p();export{z as computeDepthRange};
