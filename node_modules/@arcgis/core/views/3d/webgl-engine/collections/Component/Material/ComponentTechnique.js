/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../../chunks/tslib.es6.js";import{isSome as o}from"../../../../../../core/maybe.js";import{c as r}from"../../../../../../chunks/mat3f64.js";import{c as t}from"../../../../../../chunks/vec4f64.js";import{C as s}from"../../../../../../chunks/ComponentShader.glsl.js";import{bindSliceUniforms as i}from"../../../core/shaderLibrary/Slice.glsl.js";import{VertexPosition as a}from"../../../core/shaderLibrary/attributes/VertexPosition.glsl.js";import{bindOutputHighlight as n}from"../../../core/shaderLibrary/output/OutputHighlight.glsl.js";import{bindPBRUniforms as l}from"../../../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl.js";import{bindSSRUniforms as d}from"../../../core/shaderLibrary/shading/ScreenSpaceReflections.glsl.js";import{doublePrecisionRequiresObfuscation as u}from"../../../core/shaderLibrary/util/DoublePrecision.glsl.js";import{ReloadableShaderModule as c}from"../../../core/shaderTechnique/ReloadableShaderModule.js";import{ShaderTechnique as p}from"../../../core/shaderTechnique/ShaderTechnique.js";import{ShaderTechniqueConfiguration as m,parameter as h}from"../../../core/shaderTechnique/ShaderTechniqueConfiguration.js";import{blendingDefault as b,OITBlending as f,OITDepthTest as x,OITPolygonOffset as T}from"../../../lib/OrderIndependentTransparency.js";import{Program as v}from"../../../lib/Program.js";import{stencilWriteMaskOn as g,replaceBitWhenDepthTestPasses as M,stencilBaseAllZerosParams as y}from"../../../lib/StencilUtils.js";import{makePipelineState as S,cullingParams as P,defaultDepthWriteParams as C,defaultColorWriteParams as E}from"../../../../../webgl/renderState.js";class O extends p{bindPass(e){const o=this.program;a.bindViewProjTransform(o,e.viewTransform),i(this.program,this.configuration,e.slicePlane),0===e.identifier&&(void 0!==e.ssrParams&&d(this.program,e.ssrParams),o.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",e.transformNormal_ViewFromGlobal),2===e.subPass&&o.setUniform2fv("cameraNearFar",e.cameraNearFar),0===e.subPass&&e.lighting.setUniforms(this.program,e.integratedMesh)),1===e.identifier&&this.program.setUniform2fv("cameraNearFar",e.cameraNearFar)}bindMaterial(e,r){const t=this.program;t.setUniform4fv("uBaseColor",e.baseColor),t.setUniform1f("uObjectOpacity",e.objectOpacity),t.setUniform1f("textureAlphaCutoff",e.alphaCutoff),1===e.componentParameters.type?e.componentParameters.texture.bind(t,"uComponentColorTex","uComponentColorTexInvDim"):(t.setUniform4fv("uExternalColor",e.componentParameters.externalColor),t.setUniform1i("uExternalColorMixMode",e.componentParameters.externalColorMixMode)),o(e.baseColorTexture)&&e.baseColorTexture.bind(t,"uBaseColorTexture","uBaseColorTextureSize"),0!==this.configuration.output&&7!==this.configuration.output||(l(this.program,e,this.configuration.isSchematic),o(e.metallicRoughnessTexture)&&e.metallicRoughnessTexture.bind(t,"texMetallicRoughness","texMetallicRoughnessSize"),o(e.emissionTexture)&&e.emissionTexture.bind(t,"texEmission","texEmissionSize"),o(e.occlusionTexture)&&e.occlusionTexture.bind(t,"texOcclusion","texOcclusionSize"),o(e.normalTexture)&&e.normalTexture.bind(t,"normalTexture","normalTextureSize")),e.isIntegratedMesh&&(0===r.identifier&&0===r.subPass?(t.bindTexture(e.overlayColor,"ovColorTex"),t.bindTexture(e.overlayNormal,"ovNormalTex")):2===r.identifier&&t.bindTexture(e.overlayHighlight,"ovColorTex"),t.setUniform1f("overlayOpacity",1)),2===r.identifier&&n(this.program,r),0===r.identifier&&0===r.subPass&&(r.ambientOcclusionEnabled&&r.bindAmbientOcclusion(t),r.shadowsEnabled&&r.bindShadowMap(t)),0!==r.identifier||0!==r.subPass&&1!==r.subPass||!r.multipassTerrainParams.multipassTerrainEnabled||(this.program.setUniform2fv("cameraNearFar",r.cameraNearFar),t.setUniform2fv("inverseViewport",r.inverseViewport),r.multipassTerrainParams.terrainLinearDepthTexture&&t.bindTexture(r.multipassTerrainParams.terrainLinearDepthTexture,"terrainDepthTexture"))}bindDraw(e,o){if(a.bindModelTransform(this.program,e),this.program.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",e.transformNormal_GlobalFromModel),this.program.rebindTextures(),o.isIntegratedMesh){const r=o.overlayTexScale,t=o.overlayTexOffset;this.program.setUniform4fv("overlayTexOffset",[e.toMapSpace[0]*r[0]+t[0],e.toMapSpace[1]*r[1]+t[1],e.toMapSpace[0]*r[2]+t[2],e.toMapSpace[1]*r[3]+t[3]]),this.program.setUniform4fv("overlayTexScale",[e.toMapSpace[2]*r[0],e.toMapSpace[3]*r[1],e.toMapSpace[2]*r[2],e.toMapSpace[3]*r[3]])}}initializeProgram(e){const o=O.shader.get(),r=this.configuration,t=o.build({multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround,OITEnabled:0===r.transparencyPassType,output:r.output,normalType:0===r.integratedMeshMode?r.hasNormals?1:3:2,attributeColor:r.hasVertexColors,attributeTextureCoordinates:r.vertexTextureCoordinates,componentData:r.componentData,alphaDiscardMode:r.alphaDiscardMode,baseColorTexture:r.baseColorTexture,doubleSidedMode:r.doubleSidedMode,receiveAmbientOcclusion:r.receiveAmbientOcclusion,receiveShadows:r.receiveShadows,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,viewingMode:e.viewingMode,vertexDiscardMode:r.vertexDiscardMode,pbrMode:3===r.integratedMeshMode?4:r.usePBR?r.isSchematic?2:1:0,hasMetalnessAndRoughnessTexture:r.hasMetalnessAndRoughnessTexture,hasEmissionTexture:r.hasEmissionTexture,hasOcclusionTexture:r.hasOcclusionTexture,hasNormalTexture:r.hasNormalTexture,vertexTangents:!1,supportsTextureAtlas:!0,doublePrecisionRequiresObfuscation:u(e.rctx),overlayEnabled:2===r.integratedMeshMode||3===r.integratedMeshMode,ssrEnabled:r.ssrEnabled,highStepCount:!1,ellipsoidMode:r.ellipsoidMode});return new v(e.rctx,t,o.attributeLocations)}setPipelineState(e){const o=this.configuration,r=0!==o.integratedMeshMode,t=3===e,s=2===e;return S({blending:0!==o.output&&7!==o.output||!o.blendingEnabled?null:t?b:f(e),culling:P(o.cullFace),depthTest:{func:x(e)},depthWrite:t||s?C:null,colorWrite:E,stencilWrite:r||o.sceneHasOcludees?g:null,stencilTest:r?M(1):o.sceneHasOcludees?y:null,polygonOffset:t||s?o.polygonOffsetEnabled?{factor:2,units:2}:null:T})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}O.shader=new c(s,(()=>import("./shader/ComponentShader.glsl.js")));class j extends a.ModelTransform{constructor(){super(...arguments),this.transformNormal_GlobalFromModel=r(),this.toMapSpace=t()}}class N extends m{constructor(){super(...arguments),this.output=0,this.hasVertexColors=!1,this.hasNormals=!1,this.vertexTextureCoordinates=0,this.componentData=0,this.slicePlaneEnabled=!1,this.cullFace=2,this.baseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.vertexDiscardMode=0,this.doubleSidedMode=2,this.blendingEnabled=!0,this.alphaDiscardMode=1,this.integratedMeshMode=0,this.ssrEnabled=!1,this.polygonOffsetEnabled=!1,this.usePBR=!1,this.isSchematic=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.ellipsoidMode=1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}e([h({count:8})],N.prototype,"output",void 0),e([h()],N.prototype,"hasVertexColors",void 0),e([h()],N.prototype,"hasNormals",void 0),e([h({count:3})],N.prototype,"vertexTextureCoordinates",void 0),e([h({count:2})],N.prototype,"componentData",void 0),e([h()],N.prototype,"slicePlaneEnabled",void 0),e([h({count:3})],N.prototype,"cullFace",void 0),e([h()],N.prototype,"baseColorTexture",void 0),e([h()],N.prototype,"receiveAmbientOcclusion",void 0),e([h()],N.prototype,"receiveShadows",void 0),e([h({count:3})],N.prototype,"vertexDiscardMode",void 0),e([h({count:3})],N.prototype,"doubleSidedMode",void 0),e([h()],N.prototype,"blendingEnabled",void 0),e([h({count:4})],N.prototype,"alphaDiscardMode",void 0),e([h({count:4})],N.prototype,"integratedMeshMode",void 0),e([h()],N.prototype,"ssrEnabled",void 0),e([h()],N.prototype,"polygonOffsetEnabled",void 0),e([h()],N.prototype,"usePBR",void 0),e([h()],N.prototype,"isSchematic",void 0),e([h()],N.prototype,"hasMetalnessAndRoughnessTexture",void 0),e([h()],N.prototype,"hasEmissionTexture",void 0),e([h()],N.prototype,"hasOcclusionTexture",void 0),e([h()],N.prototype,"hasNormalTexture",void 0),e([h()],N.prototype,"sceneHasOcludees",void 0),e([h({count:4})],N.prototype,"transparencyPassType",void 0),e([h({count:4})],N.prototype,"ellipsoidMode",void 0),e([h()],N.prototype,"multipassTerrainEnabled",void 0),e([h()],N.prototype,"cullAboveGround",void 0);export{j as ComponentDrawParameters,O as ComponentTechnique,N as ComponentTechniqueConfiguration};
