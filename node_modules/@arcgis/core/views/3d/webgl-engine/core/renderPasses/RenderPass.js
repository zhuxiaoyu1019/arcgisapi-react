/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{unwrap as e}from"../../../../../core/maybe.js";import t from"../../../../../core/PooledArray.js";class s{constructor(e,s,i=0){this._rctx=e,this._techniqueRepository=s,this._sorting=i,this._draws=new t({initialSize:32,allocator:e=>e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._passBoundTechniques=new Set,this._previouslyBoundMaterials=new Map,this._previouslyBoundDraw=new Map}submitDraw(t,s,i,r,a){const n=this._draws.pushNew();n.geometry=s,n.geometryRanges=i,n.material=t,n.bindDrawParams=r,n.depthSquaredHint=a,n.indexType=s.indexed?e(s.vao.indexBuffer).indexType:0}dispatch(e){const t=this._rctx;this._passBoundTechniques.clear(),this._previouslyBoundMaterials.clear(),this._previouslyBoundDraw.clear();let s=null;const r=this._draws.length;for(let a=0;a<r;a++){const r=this._draws.data[a],n=r.geometry,o=r.material.getTechnique(this._techniqueRepository,e,n.parameters);o===s&&3===o.configuration.transparencyPassType||(t.useProgram(o.program),t.setPipelineState(o.pipeline),s=o),this._passBoundTechniques.has(o)||(o.bindPass(e),this._passBoundTechniques.add(o)),t.bindVAO(n.vao),this._previouslyBoundMaterials.get(o)!==r.material&&(o.bindMaterial(r.material,e),this._previouslyBoundMaterials.set(o,r.material)),this._previouslyBoundDraw.get(o)!==r.bindDrawParams&&(o.bindDraw(r.bindDrawParams,r.material,e),this._previouslyBoundDraw.set(o,r.bindDrawParams));const d=r.geometryRanges,l=d.length;if(0!==r.indexType){const e=i.get(r.indexType);for(let s=0;s<l;s+=2){const i=d[s],a=d[s+1];t.drawElements(n.primitiveType,a,r.indexType,i*e)}}else for(let e=0;e<l;e+=2){const s=d[e],i=d[e+1];t.drawArrays(n.primitiveType,s,i)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=0===this._sorting?1:-1;this._draws.sort(((t,s)=>{const i=e*(t.depthSquaredHint-s.depthSquaredHint);return 0!==i?i:t.geometry.vao.size-s.geometry.vao.size}))}get count(){return this._draws.length}}const i=new Map;i.set(5121,1),i.set(5123,2),i.set(5125,4);export{s as RenderPass};
