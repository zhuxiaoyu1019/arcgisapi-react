/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import n from"../core/Error.js";import{clamp as e,deg2rad as t,rad2deg as r,asinClamped as l}from"../core/mathUtils.js";import{isNone as u}from"../core/maybe.js";import{throwIfAborted as o}from"../core/promiseUtils.js";import{getMetersPerUnitForSR as s}from"../core/unitUtils.js";import{i,t as a,s as c}from"../chunks/mat4.js";import{g as f,b as p,f as h,n as m,l as d}from"../chunks/vec3.js";import{c as M}from"../chunks/vec3f64.js";import R from"./Extent.js";import j from"./Multipoint.js";import{l as w,p as y,i as E}from"../chunks/pe.js";import g from"./Point.js";import x from"./Polygon.js";import P from"./Polyline.js";import{SphericalECEFSpatialReference as I,WGS84ECEFSpatialReference as T,SphericalPCPFMars as C,SphericalPCPFMoon as F}from"./projectionEllipsoid.js";import{set as S}from"./support/aaBoundingRect.js";import{earth as k,moon as b,mars as v}from"./support/Ellipsoid.js";import{earthEllipsoidConstants as q}from"./support/geodesicConstants.js";import z from"./support/GeographicTransformation.js";import{equals as A,isValid as U,isWGS84 as G,isWebMercator as W,isMars as Z,isMoon as _}from"./support/spatialReferenceUtils.js";let B=null,K=null,L=null,N={};function V(){return!!B&&E()}function X(){return!0}function D(n){return u(L)&&(L=Promise.all([w(),import("../chunks/geometryEngineBase.js").then((function(n){return n.g})),import("./geometryAdapters/hydrated.js")])),L.then((([,e,{hydratedAdapter:t}])=>{o(n),K=t,B=e.default,B._enableProjection(y)}))}function H(n,e,t=null){return Array.isArray(n)?0===n.length?[]:J(K,n,n[0].spatialReference,e,t):J(K,[n],n.spatialReference,e,t)[0]}function J(n,e,t,r,l=null){if(u(t)||u(r))return e;if(nn(t,r,l))return e.map((n=>rn(n,t,r)));if(u(l)){const n=z.cacheKey(t,r);void 0!==N[n]?l=N[n]:(l=O(t,r,null),u(l)&&(l=new z),N[n]=l)}if(u(B))throw new Y;return B._project(n,e,t,r,l)}function O(n,e,t=null){if(u(B))throw new Y;if(u(n)||u(e))return null;const r=B._getTransformation(K,n,e,t,null==t?void 0:t.spatialReference);return null!==r?z.fromGE(r):null}function Q(n,e,t=null){if(u(B))throw new Y;const r=B._getTransformationBySuitability(K,n,e,t,null==t?void 0:t.spatialReference);if(null!==r){const n=[];for(const e of r)n.push(z.fromGE(e));return n}return[]}class Y extends n{constructor(){super("projection:not-loaded","projection engine not fully loaded yet, please call load()")}}function $(){B=null,K=null,L=null,N={}}function nn(n,e,t){return!t&&(!!A(n,e)||U(n)&&U(e)&&!!re(n,e,ie))}async function en(n,e,t,r){if(!V())if(Array.isArray(n)){for(const{source:l,dest:u,geographicTransformation:o}of n)if(!nn(l,u,o))return D(r)}else if(!nn(n,e,t))return D(r)}function tn(n,e){switch(re(n,e,ie)){case qn:return"copy3";case Nn:return"wgs84ToSphericalECEF";case Wn:return"wgs84ToWebMercator";case Yn:return"wgs84ToWGS84ECEF";case zn:return"webMercatorToWGS84";case An:return"webMercatorToSphericalECEF";case Un:return"webMercatorToWGS84ECEF";case $n:return"wgs84ECEFToWGS84";case ne:return"wgs84ECEFToSphericalECEF";case ee:return"wgs84ECEFToWebMercator";case Hn:return"sphericalECEFToWGS84";case Jn:return"sphericalECEFToWebMercator";case Dn:return"sphericalMarsPCPFToMars2000";case Xn:return"sphericalMoonPCPFToMoon2000";case On:return"sphericalECEFToWGS84ECEF";case Ln:return"mars2000ToSphericalPCPF";case Kn:return"moon2000ToSphericalPCPF";default:return null}}function rn(n,e,t){if(!n)return n;if("x"in n){const r=new g;return un(n,e,r,t)?r:null}if("xmin"in n){const r=new R;return mn(n,e,r,t)?r:null}if("rings"in n){const r=new x;return pn(n,e,r,t)?r:null}if("paths"in n){const r=new P;return cn(n,e,r,t)?r:null}if("points"in n){const r=new j;return sn(n,e,r,t)?r:null}return null}function ln(n,e,t=e.spatialReference,r=0){return!u(t)&&un(n,n.spatialReference,e,t,r)}function un(n,e,t,r,l=0){de[0]=n.x,de[1]=n.y;const u=n.z;return de[2]=void 0!==u?u:l,!!xn(de,e,0,de,r,0,1)&&(t.x=de[0],t.y=de[1],t.spatialReference=r,void 0===u?(t.z=void 0,t.hasZ=!1):(t.z=de[2],t.hasZ=!0),void 0===n.m?(t.m=void 0,t.hasM=!1):(t.m=n.m,t.hasM=!0),!0)}function on(n,e,t=e.spatialReference,r=0){return!u(t)&&sn(n,n.spatialReference,e,t,r)}function sn(n,e,t,r,l=0){const{points:u,hasZ:o,hasM:s}=n,i=[],a=u.length,c=[];for(const f of u)c.push(f[0],f[1],o?f[2]:l);if(!xn(c,e,0,c,r,0,a))return!1;for(let f=0;f<a;++f){const n=3*f,e=c[n],t=c[n+1];o&&s?i.push([e,t,c[n+2],u[f][3]]):o?i.push([e,t,c[n+2]]):s?i.push([e,t,u[f][2]]):i.push([e,t])}return t.points=i,t.spatialReference=r,t.hasZ=o,t.hasM=s,!0}function an(n,e,t=e.spatialReference,r=0){return!u(t)&&cn(n,n.spatialReference,e,t,r)}function cn(n,e,t,r,l=0){const{paths:u,hasZ:o,hasM:s}=n,i=[];return!!In(u,o,s,e,i,r,l)&&(t.paths=i,t.spatialReference=r,t.hasZ=o,t.hasM=s,!0)}function fn(n,e,t=e.spatialReference,r=0){return!u(t)&&pn(n,n.spatialReference,e,t,r)}function pn(n,e,t,r,l=0){const{rings:u,hasZ:o,hasM:s}=n,i=[];return!!In(u,o,s,e,i,r,l)&&(t.rings=i,t.spatialReference=r,t.hasZ=o,t.hasM=s,!0)}function hn(n,e,t=e.spatialReference,r=0){return!u(t)&&mn(n,n.spatialReference,e,t,r)}function mn(n,e,t,r,l=0){const{xmin:u,ymin:o,xmax:s,ymax:i,hasZ:a,hasM:c}=n;if(!jn(u,o,a?n.zmin:l,e,de,r))return!1;t.xmin=de[0],t.ymin=de[1],a&&(t.zmin=de[2]);return!!jn(s,i,a?n.zmax:l,e,de,r)&&(t.xmax=de[0],t.ymax=de[1],a&&(t.zmax=de[2]),c&&(t.mmin=n.mmin,t.mmax=n.mmax),t.spatialReference=r,!0)}function dn(n,e,t){if(u(e)||u(t))return null;const r=new g({spatialReference:t});return xn(n,e,0,de,t,0,1)?(r.x=de[0],r.y=de[1],r.z=de[2],r):null}function Mn(n,e,t){return xn(n,e,0,de,t.spatialReference,0,1)?(t.x=de[0],t.y=de[1],t.z=de[2],t):null}function Rn(n,e,t,r=0){de[0]=n.x,de[1]=n.y;const l=n.z;return de[2]=void 0!==l?l:r,xn(de,n.spatialReference,0,e,t,0,1)}function jn(n,e,t,r,l,u){return pe[0]=n,pe[1]=e,pe[2]=t,xn(pe,r,0,l,u,0,1)}function wn(n,e,t,r){return!(u(e)||u(r)||n.length<2)&&(2===n.length&&(pe[0]=n[0],pe[1]=n[1],pe[2]=0,n=pe),xn(n,e,0,t,r,0,1))}function yn(n,e){de[0]=n.x,de[1]=n.y;const t=n.z;return de[2]=void 0!==t?t:0,En(de,n.spatialReference,e)}function En(n,e,t){return gn(n,e,t)}function gn(n,e,t){if(u(e))return!1;const r=vn(e,oe),l=te[r][6];return!u(l)&&(l(n,0,pe,0),t!==pe&&(t[0]=pe[0],t[1]=pe[1],t.length>2&&(t[2]=pe[2])),!0)}function xn(n,e,t,r,l,o,s=1){const i=re(e,l,ie);if(u(i))return!1;if(i===qn){if(n===r&&t===o)return!0;const e=t+3*s;for(let l=t,u=o;l<e;l++,u++)r[u]=n[l];return!0}const a=t+3*s;for(let u=t,c=o;u<a;u+=3,c+=3)i(n,u,r,c);return!0}function Pn(n,e,t,r,l){f(de,n),p(Me,n,e),wn(de,t,de,l),wn(Me,t,Me,l),h(r,Me,de),m(r,r)}function In(n,e,t,r,l,u,o=0){const s=new Array;for(const a of n)for(const n of a)s.push(n[0],n[1],e?n[2]:o);if(!xn(s,r,0,s,u,0,s.length/3))return!1;let i=0;l.length=0;for(const a of n){const n=new Array;for(const r of a)e&&t?n.push([s[i++],s[i++],s[i++],r[3]]):e?n.push([s[i++],s[i++],s[i++]]):t?(n.push([s[i++],s[i++],r[2]]),i++):(n.push([s[i++],s[i++]]),i++);l.push(n)}return!0}function Tn(n,e,t,r){if(u(e)||u(r))return!1;const l=le(e,r,ae);if(l.projector===qn)return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],!0;if(u(l.projector))return!1;const{source:o,dest:s}=l;if(3===s.spatialReferenceId){const e=te[o.spatialReferenceId][2];if(u(e))return!1;e(n,0,he,0);const r=Math.abs(ce*he[1])+Math.asin(n[3]/(k.radius+n[2]));if(Wn(he,0,t,0),r>.9999*Math.PI)t[3]=Number.MAX_VALUE;else{const e=1/Math.cos(r);t[3]=e*n[3]}return!0}return l.projector(n,0,t,0),t[3]=n[3]*o.metersPerUnit/s.metersPerUnit,!0}function Cn(n,e,t,r){return null!=n&&(A(e,r)?(S(t,n),!0):(pe[0]=n[0],pe[1]=n[1],pe[2]=0,!!xn(pe,e,0,pe,r,0,1)&&(t[0]=pe[0],t[1]=pe[1],pe[0]=n[2],pe[1]=n[3],pe[2]=0,!!xn(pe,e,0,pe,r,0,1)&&(t[2]=pe[0],t[3]=pe[1],!0))))}function Fn(n,e,t,r){if(u(e)||u(r))return!1;const l=vn(e,oe),o=vn(r,se);if(l===o&&0!==l||A(e,r))return t[0]=1,t[1]=1,t[2]=1,!0;if(1===l){const e=d(n),r=e/Math.sqrt(n[0]*n[0]+n[1]*n[1]),l=e/k.radius;if(3===o)return t[0]=r*l,t[1]=r*l,t[2]=1,!0;if(2===o||5===o){const n=180/(k.radius*Math.PI);return t[0]=n*r*l,t[1]=n*l,t[2]=1,!0}}return!1}function Sn(n,e,t,r){if(u(n)||u(r))return!1;const l=vn(n,oe),o=vn(r,se);if(l===o&&!kn(o)&&(0!==l||A(n,r)))return i(t),a(t,t,e),!0;if(kn(o)){let n=0,r=0;const s=te[l][11],i=te[11][o];return!u(s)&&!u(i)&&(s(e,0,he,0),i(he,0,me,0),n=ce*he[0],r=ce*he[1],bn(r,n,t),t[12]=me[0],t[13]=me[1],t[14]=me[2],!0)}if(3===o&&(2===l||1===l)){const n=te[l][11];if(u(n))return!1;n(e,0,he,0);const r=ce*he[1];Wn(he,0,me,0),i(t),a(t,t,me);const o=1/Math.cos(r);return c(t,t,[o,o,1]),!0}return!1}function kn(n){return 1===n||7===n||9===n}function bn(n,e,t){const r=Math.sin(e),l=Math.cos(e),u=Math.sin(n),o=Math.cos(n),s=t;return s[0]=-r,s[4]=-u*l,s[8]=o*l,s[12]=0,s[1]=l,s[5]=-u*r,s[9]=o*r,s[13]=0,s[2]=0,s[6]=o,s[10]=u,s[14]=0,s[3]=0,s[7]=0,s[11]=0,s[15]=1,s}function vn(n,e){return e.spatialReference===n?e.spatialReferenceId:(e.spatialReference=n,"metersPerUnit"in e&&(e.metersPerUnit=s(n,1)),n.wkt===I.wkt?e.spatialReferenceId=1:G(n)?e.spatialReferenceId=2:W(n)?e.spatialReferenceId=3:n.wkt===T.wkt?e.spatialReferenceId=4:4490===n.wkid?e.spatialReferenceId=5:n.wkt===C.wkt?e.spatialReferenceId=7:n.wkt===F.wkt?e.spatialReferenceId=9:Z(n)?e.spatialReferenceId=8:_(n)?e.spatialReferenceId=10:e.spatialReferenceId=0)}function qn(n,e,t,r){n!==t&&(t[r++]=n[e++],t[r++]=n[e++],t[r]=n[e])}function zn(n,e,t,r){t[r++]=fe*(n[e++]/k.radius),t[r++]=fe*(Math.PI/2-2*Math.atan(Math.exp(-1*n[e++]/k.radius))),t[r]=n[e]}function An(n,e,t,r){zn(n,e,t,r),Nn(t,r,t,r)}function Un(n,e,t,r){zn(n,e,t,r),Yn(t,r,t,r)}function Gn(n,t,r,l,u){const o=.4999999*Math.PI,s=e(ce*n[t+1],-o,o),i=Math.sin(s);r[l++]=ce*n[t]*u.radius,r[l++]=u.halfSemiMajorAxis*Math.log((1+i)/(1-i)),r[l]=n[t+2]}function Wn(n,e,t,r){Gn(n,e,t,r,k)}function Zn(n){if(u(n))return!1;const e=vn(n,oe);return!!te[e][6]}function _n(n,e,t,r,l=0){const u=r+l,o=Math.cos(t);n[0]=Math.cos(e)*o*u,n[1]=Math.sin(e)*o*u,n[2]=Math.sin(t)*u}function Bn(n,e,t,r,l){const u=l+n[e+2],o=ce*n[e+1],s=ce*n[e],i=Math.cos(o);t[r++]=Math.cos(s)*i*u,t[r++]=Math.sin(s)*i*u,t[r]=Math.sin(o)*u}function Kn(n,e,t,r){Bn(n,e,t,r,b.radius)}function Ln(n,e,t,r){Bn(n,e,t,r,v.radius)}function Nn(n,e,t,r){Bn(n,e,t,r,k.radius)}function Vn(n,e,t,r,u){const o=n[e],s=n[e+1],i=n[e+2],a=Math.sqrt(o*o+s*s+i*i),c=l(i/(0===a?1:a)),f=Math.atan2(s,o);t[r++]=fe*f,t[r++]=fe*c,t[r]=a-u}function Xn(n,e,t,r){Vn(n,e,t,r,b.radius)}function Dn(n,e,t,r){Vn(n,e,t,r,v.radius)}function Hn(n,e,t,r){Vn(n,e,t,r,k.radius)}function Jn(n,e,t,r){Hn(n,e,t,r),Wn(t,r,t,r)}function On(n,e,t,r){Hn(n,e,t,r),Yn(t,r,t,r)}function Qn(n,e,t,r,l){const u=ce*n[e],o=ce*n[e+1],s=n[e+2],i=Math.sin(o),a=Math.cos(o),c=l.radius/Math.sqrt(1-l.eccentricitySquared*i*i);t[r++]=(c+s)*a*Math.cos(u),t[r++]=(c+s)*a*Math.sin(u),t[r++]=(c*(1-l.eccentricitySquared)+s)*i}function Yn(n,e,t,r){Qn(n,e,t,r,k)}function $n(n,e,t,r){const l=q,u=n[e],o=n[e+1],s=n[e+2];let i,a,c,f,p,h,m,d,M,R,j,w,y,E,g,x,P,I,T,C,F;i=Math.abs(s),a=u*u+o*o,c=Math.sqrt(a),f=a+s*s,p=Math.sqrt(f),C=Math.atan2(o,u),h=s*s/f,m=a/f,E=l.a2/p,g=l.a3-l.a4/p,m>.3?(d=i/p*(1+m*(l.a1+E+h*g)/p),T=Math.asin(d),R=d*d,M=Math.sqrt(1-R)):(M=c/p*(1-h*(l.a5-E-m*g)/p),T=Math.acos(M),R=1-M*M,d=Math.sqrt(R)),j=1-k.eccentricitySquared*R,w=k.radius/Math.sqrt(j),y=l.a6*w,E=c-w*M,g=i-y*d,P=M*E+d*g,x=M*g-d*E,I=x/(y/j+P),T+=I,F=P+x*I/2,s<0&&(T=-T),t[r++]=fe*C,t[r++]=fe*T,t[r]=F}function ne(n,e,t,r){$n(n,e,t,r),Nn(t,r,t,r)}function ee(n,e,t,r){$n(n,e,t,r),Wn(t,r,t,r)}const te={2:{5:null,8:null,10:null,11:qn,6:qn,1:Nn,7:null,9:null,0:null,3:Wn,2:qn,4:Yn},5:{5:qn,8:null,10:null,11:qn,6:qn,1:Nn,7:null,9:null,0:null,3:null,2:null,4:Yn},8:{5:null,8:qn,10:null,11:qn,6:null,1:null,7:Ln,9:null,0:null,3:null,2:null,4:null},10:{5:null,8:null,10:qn,11:qn,6:null,1:null,7:null,9:Kn,0:null,3:null,2:null,4:null},3:{5:null,8:null,10:null,11:zn,6:zn,1:An,7:null,9:null,0:null,3:qn,2:zn,4:Un},4:{5:$n,8:null,10:null,11:$n,6:$n,1:ne,7:null,9:null,0:null,3:ee,2:$n,4:qn},1:{5:Hn,8:null,10:null,11:Hn,6:Hn,1:qn,7:null,9:null,0:null,3:Jn,2:Hn,4:On},7:{5:null,8:Dn,10:null,11:Dn,6:null,1:null,7:qn,9:null,0:null,3:null,2:null,4:null},9:{5:null,8:null,10:Xn,11:Xn,6:null,1:null,7:null,9:qn,0:null,3:null,2:null,4:null},0:{5:null,8:null,10:null,11:null,6:null,1:null,7:null,9:null,0:qn,3:null,2:null,4:null},11:{5:qn,8:qn,10:qn,11:qn,6:qn,1:Nn,7:Ln,9:Kn,0:null,3:Wn,2:qn,4:Yn},6:{5:null,8:null,10:null,11:qn,6:qn,1:Nn,7:null,9:null,0:null,3:null,2:qn,4:Yn}};function re(n,e,t=ue()){return u(n)||u(e)?null:le(n,e,t).projector}function le(n,e,t){if(u(n)||u(e)||t.source.spatialReference===n&&t.dest.spatialReference===e)return t;const r=vn(n,t.source),l=vn(e,t.dest);return 0===r&&0===l?A(n,e)?t.projector=qn:t.projector=null:t.projector=te[r][l],t}function ue(){return{source:{spatialReference:null,spatialReferenceId:0,metersPerUnit:1},dest:{spatialReference:null,spatialReferenceId:0,metersPerUnit:1},projector:qn}}const oe={spatialReference:null,spatialReferenceId:0},se={spatialReference:null,spatialReferenceId:0},ie=ue(),ae=ue(),ce=t(1),fe=r(1),pe=M(),he=M(),me=M(),de=M(),Me=M();export{Zn as canProjectToWGS84ComparableLonLat,nn as canProjectWithoutEngine,bn as computeLatLonToENURotation,Sn as computeLinearTransformation,tn as getProjectorName,O as getTransformation,Q as getTransformations,en as initializeProjection,V as isLoaded,X as isSupported,D as load,Fn as localLinearScaleFactors,_n as lonLatToSphericalPCPF,Gn as lonLatToWebMercatorComparable,H as project,Cn as projectBoundingRect,Tn as projectBoundingSphere,xn as projectBuffer,Pn as projectDirection,hn as projectExtent,J as projectMany,on as projectMultipoint,ln as projectPoint,Rn as projectPointToVector,yn as projectPointToWGS84ComparableLonLat,fn as projectPolygon,an as projectPolyline,Mn as projectVectorToDehydratedPoint,dn as projectVectorToPoint,wn as projectVectorToVector,En as projectVectorToWGS84ComparableLonLat,jn as projectXYZToVector,Vn as sphericalPCPFtoLonLatElevation,$ as unload};
