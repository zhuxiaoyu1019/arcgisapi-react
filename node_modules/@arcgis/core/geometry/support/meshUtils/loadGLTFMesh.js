/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import t from"../../../Color.js";import e from"../../../request.js";import{unwrap as r,applySome as o,isSome as n}from"../../../core/maybe.js";import{a as s}from"../../../chunks/mat3.js";import{c as a}from"../../../chunks/mat3f64.js";import{f as i}from"../../../chunks/vec3f64.js";import{f as u}from"../../../chunks/vec4f64.js";import l from"../MeshComponent.js";import c from"../MeshMaterialMetallicRoughness.js";import f from"../MeshTexture.js";import m from"../MeshVertexAttributes.js";import{BufferViewVec3f64 as p,BufferViewVec3f as d,BufferViewVec4f as g,BufferViewVec4u8 as x,BufferViewVec2f as b,BufferViewVec4u16 as h,BufferViewVec3u8 as v,BufferViewVec3u16 as w}from"../buffer/BufferView.js";import{t as j,a as y,s as C,b as M}from"../../../chunks/vec32.js";import{t as A,s as T,a as k}from"../../../chunks/vec42.js";import{createBuffer as B}from"../buffer/utils.js";import{georeferenceByTransform as F}from"./georeference.js";import{DefaultLoadingContext as I}from"../../../views/3d/glTF/DefaultLoadingContext.js";import{load as R}from"../../../views/3d/glTF/loader.js";import{triangleFanToTriangles as E,triangleStripToTriangles as S,trianglesToTriangles as D}from"../../../views/3d/glTF/internal/indexUtils.js";import{generateIndexArray as O}from"../../../views/3d/webgl-engine/lib/geometryDataUtils.js";import{COLOR_GAMMA as q}from"../../../views/3d/webgl-engine/materials/DefaultMaterial_COLOR_GAMMA.js";import{f as L,c as N}from"../../../chunks/vec33.js";import{f as U,c as V}from"../../../chunks/vec43.js";import{n as _,f as z}from"../../../chunks/vec22.js";async function G(t,e,r){const o=new I(K(r)),s=(await R(o,e,r,!0)).model,a=s.lods.shift(),i=new Map,u=new Map;s.textures.forEach(((t,e)=>i.set(e,Q(t)))),s.materials.forEach(((t,e)=>u.set(e,H(t,i))));const l=P(a);for(const n of a.parts)J(l,n,u);const{position:c,normal:f,tangent:p,color:d,texCoord0:g}=l.vertexAttributes,x={position:c.typedBuffer,normal:n(f)?f.typedBuffer:null,tangent:n(p)?p.typedBuffer:null,uv:n(g)?g.typedBuffer:null,color:n(d)?d.typedBuffer:null},b=F(x,t,r);return{transform:b.transform,components:l.components,spatialReference:t.spatialReference,vertexAttributes:new m({position:b.vertexAttributes.position,normal:b.vertexAttributes.normal,tangent:b.vertexAttributes.tangent,color:x.color,uv:x.uv})}}function K(t){return null!=t&&t.resolveFile?{busy:!1,request:async(r,o,s)=>{const a=t.resolveFile(r),i="image"===o?"image":"binary"===o?"array-buffer":"json";return(await e(a,{responseType:i,signal:n(s)?s.signal:null})).data}}:null}function P(t){let e=0;const r={color:!1,tangent:!1,normal:!1,texCoord0:!1};for(const{attributes:{position:o,normal:n,color:s,tangent:a,texCoord0:i}}of t.parts)e+=o.count,n&&(r.normal=!0),s&&(r.color=!0),a&&(r.tangent=!0),i&&(r.texCoord0=!0);return{writeIndex:0,vertexAttributes:{position:B(p,e),normal:r.normal?B(d,e):null,tangent:r.tangent?B(g,e):null,color:r.color?B(x,e):null,texCoord0:r.texCoord0?B(b,e):null},components:[]}}function Q(t){return new f({data:t.data,wrap:Y(t.parameters.wrap)})}function H(e,n){const s=new t(tt(e.color,e.opacity)),a=e.emissiveFactor?new t(et(e.emissiveFactor)):null;return new c({color:s,colorTexture:r(o(e.textureColor,(t=>n.get(t)))),normalTexture:r(o(e.textureNormal,(t=>n.get(t)))),emissiveColor:a,emissiveTexture:r(o(e.textureEmissive,(t=>n.get(t)))),occlusionTexture:r(o(e.textureOcclusion,(t=>n.get(t)))),alphaMode:X(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:r(o(e.textureMetallicRoughness,(t=>n.get(t))))})}function J(t,e,r){const{position:o,normal:i,tangent:u,color:c,texCoord0:f}=t.vertexAttributes,m=t.writeIndex,p=e.attributes.position.count;if(j(o.slice(m,p),e.attributes.position,e.transform),n(e.attributes.normal)&&n(i)){const t=s(a(),e.transform);y(i.slice(m,p),e.attributes.normal,t)}else n(i)&&L(i,0,0,1,{dstIndex:m,count:p});if(n(e.attributes.tangent)&&n(u)){const t=s(a(),e.transform);A(u.slice(m,p),e.attributes.tangent,t)}else n(u)&&U(u,0,0,1,1,{dstIndex:m,count:p});if(n(e.attributes.texCoord0)&&n(f)?_(f.slice(m,p),e.attributes.texCoord0):n(f)&&z(f,0,0,{dstIndex:m,count:p}),n(e.attributes.color)&&n(c)){const t=e.attributes.color,r=c.slice(m,p);if(4===t.elementCount)t instanceof g?T(r,t,255):t instanceof x?V(r,t):t instanceof h&&k(r,t,8);else{U(r,255,255,255,255);const e=v.fromTypedArray(r.typedBuffer,r.typedBufferStride);t instanceof d?C(e,t,255):t instanceof v?N(e,t):t instanceof w&&M(e,t,8)}}else n(c)&&U(c.slice(m,p),255,255,255,255);const b=W(e.indices||p,e.primitiveType);if(m)for(let n=0;n<b.length;n++)b[n]+=m;t.components.push(new l({faces:b,material:r.get(e.material).clone(),trustSourceNormals:!0})),t.writeIndex+=p}function W(t,e){switch(e){case 4:return D(t,O);case 5:return S(t);case 6:return E(t)}}function X(t){switch(t){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function Y(t){return{horizontal:Z(t.s),vertical:Z(t.t)}}function Z(t){switch(t){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function $(t){return t**(1/q)*255}function tt(t,e){return u($(t[0]),$(t[1]),$(t[2]),e)}function et(t){return i($(t[0]),$(t[1]),$(t[2]))}export{G as loadGLTFMesh};
