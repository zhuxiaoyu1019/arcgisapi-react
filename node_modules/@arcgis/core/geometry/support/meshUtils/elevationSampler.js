/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../core/maybe.js";import{open as t}from"../../../core/workers/workers.js";import{c as r}from"../../../chunks/vec3f64.js";import{fromValues as o}from"../ray.js";import{intersectRay as n}from"../triangle.js";import{ElevationSamplerWorker as a}from"./ElevationSamplerWorker.js";import{ElevationSamplerBase as i}from"../../../layers/support/ElevationSampler.js";async function s(e,t){const r=await l(),o=await p.createIndex(e,r);return m(r),new c(e,o,t)}class c extends i{constructor(t,r,o){super(),this.rindex=r,this.demResolution={min:0,max:0},this.spatialReference=t.spatialReference.clone(),this.extent=t.extent.clone(),this.noDataValue=e(o)&&o.noDataValue||0}elevationAt(e){const t=this.projectIfRequired(e,this.spatialReference);let r=Number.NEGATIVE_INFINITY;return o([t.x,t.y,0],[0,0,-1],j),this.rindex.search({minX:t.x,maxX:t.x,minY:t.y,maxY:t.y},(e=>{n(e,j,N)&&N[2]>r&&(r=N[2])})),r===Number.NEGATIVE_INFINITY?this.noDataValue:r}}function l(){return++f,u(),x||(x=t("ElevationSamplerWorker").catch((()=>null)),x)}function m(t){--f,e(t)&&0===f&&(h=setTimeout((()=>{t.close(),x=null,h=0}),I))}function u(){h&&(clearTimeout(h),h=0)}const p=new a;let f=0,x=null,h=0;const I=1e4,j=o([0,0,0],[0,0,-1]),N=r();export{s as create};
