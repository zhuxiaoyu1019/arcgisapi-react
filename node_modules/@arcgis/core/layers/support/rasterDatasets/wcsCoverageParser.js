/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../../../geometry/Extent.js";import t from"../../../geometry/Polygon.js";import n from"../RasterInfo.js";import{coordsReversedForWKID as i}from"../wmsUtils.js";import{getElements as o,isSameTagIgnoreNS as s,getElementValue as a,getElementValues as r,getNodeNameIgnoreNS as l,getElement as p,getSpaceDelimitedNumericValues as m}from"./xmlUtilities.js";function u(e){return{requestResponseCRSs:r(e,"requestResponseCRSs").map((e=>e.split(":")[1])),nativeCRSs:r(e,"nativeCRSs").map((e=>e.split(":")[1]))}}function d(e,t){const n=r(e,"1.0.0"===t?"interpolationMethod":"InterpolationMethod"),i="1.0.0"===t?e.getAttribute("default"):a(e,"InterpolationMethods/Default");return null!=i?[i].concat(n.filter((e=>e.toLowerCase()!==i.toLowerCase()))):n}function f(e){return null==e?["nearest"]:e.map((e=>{const t=e.toLowerCase();return t.indexOf("nearest")>-1?"nearest":t.indexOf("linear")>-1?"bilinear":t.indexOf("cubic")>-1?"cubic":null})).filter((e=>!!e))}function c(t){const n=o(t,"pos"),i=m(n[0]),s=m(n[1]);return new e({xmin:i[0],ymin:i[1],xmax:s[0],ymax:s[1],spatialReference:{wkid:4326}})}function h(e){const t=[],n=o(e,"RangeSet");let i=[];for(let s=0;s<n.length;s++){const e=a(n[s],"name"),l=a(n[s],"label"),p=[],m=o(n[s],"AxisDescription");for(let t=0;t<m.length;t++){const e=a(m[t],"name"),n=a(m[t],"label"),o=r(m[t],"singleValue");if(0===o.length){const e=a(m[t],"min"),n=a(m[t],"max"),i=Number(a(m[t],"res"))||1;if(null!==e&&null!==n)for(let t=parseInt(e,10);t<=parseInt(n,10);t+=i)o.push(t.toString())}"band"===e.toLowerCase()&&(i=o),p.push({name:e,label:n,values:o})}t.push({name:e,label:l,axis:p})}return{rangeSet:t,bandNames:i}}function g(e=null){if(!e)return{resolution:null,units:null};let t=e.toUpperCase();const n=["Y","M","D"],i=["H","M","S"],o=["Years","Months","Days","Hours","Minutes","Seconds"];let s,a,r;return-1===t.indexOf("PT")?(t=t.slice(1),r=n.findIndex((e=>t.indexOf(e)>-1)),r>-1&&(s=o[r]),a=parseFloat(t.substring(0,t.length-1))):(t=t.slice(2),r=i.findIndex((e=>t.indexOf(e)>-1)),s=o[3+r],a=parseFloat(t.substring(0,t.length-1))),{resolution:a,units:s}}function x(e){const t=o(e,"timeposition");if(t.length>0){const e=[];for(let n=0;n<t.length;n++)e.push(new Date(a(t[n])));return{begin:e[0],end:e[e.length-1],values:e}}const n=p(e,"timePeriod")||p(e,"TimePeriod");if(n){return{begin:new Date(a(n,"beginPosition")||a(n,"BeginPosition")),end:new Date(a(n,"endPosition")||a(n,"EndPosition")),...g(a(n,"timeResolution")||a(n,"TimeResolution"))}}return null}function b(t){const n=p(t,"spatialDomain"),i=p(n,"Envelope")||p(n,"EnvelopeWithTimePeriod"),s=i.getAttribute("srsName").split(":"),r=s[s.length-1],l=o(i,"pos"),u=m(l[0]),d=m(l[1]),f=parseInt(r,10),c=isNaN(f)?null:{wkid:f},h=new e({xmin:u[0],ymin:u[1],xmax:d[0],ymax:d[1],spatialReference:c}),g=p(n,"RectifiedGrid"),b=a(g,"low").split(" "),v=a(g,"high").split(" "),w=parseInt(v[0],10)-parseInt(b[0],10)+1,y=parseInt(v[1],10)-parseInt(b[1],10)+1,D=m(n,"origin/pos"),L=o(n,"offsetVector"),S={envelope:h,columns:w,rows:y,offset:{x:parseFloat(a(L[0]).split(" ")[0]),y:parseFloat(a(L[1]).split(" ")[1])},origin:{x:D[0],y:D[1]}},C=p(t,"temporalDomain")||p(t,"TemporalDomain");return{spatialDomain:S,temporalDomain:C?x(C):null}}function v(e){const t={version:"1.0"};let i=[];for(let n=0;n<e.childNodes.length;n++){const o=e.childNodes[n];if(1===o.nodeType)if(s(o,"description"))t.description=a(o);else if(s(o,"name"))t.name=a(o);else if(s(o,"label"))t.label=a(o);else if(s(o,"supportedFormats"))t.supportedFormats=r(o,"formats");else if(s(o,"supportedCRSs"))t.supportedCRSs=u(o);else if(s(o,"supportedInterpolations"))t.supportedInterpolations=d(o,"1.0.0");else if(s(o,"lonLatEnvelope"))t.lonLatEnvelope=c(o);else if(s(o,"rangeSet")){const e=h(o);t.rangeSet=e.rangeSet,i=e.bandNames}else s(o,"domainSet")&&(t.domainSet=b(o))}const o=f(t.supportedInterpolations),{name:l,description:p,label:m,lonLatEnvelope:g,supportedFormats:x}=t,{spatialDomain:v}=t.domainSet,w={x:Math.abs(v.offset.x),y:Math.abs(v.offset.y)},y=new n({width:v.columns,height:v.rows,pixelSize:w,extent:v.envelope,spatialReference:v.envelope.spatialReference,bandCount:i.length||1});return{id:l,title:t.name,description:p||m,lonLatEnvelope:g,rasterInfo:y,bandNames:i,supportedFormats:x,supportedInterpolations:o,coverageDescription:t,version:"1.0.0",useEPSGAxis:!1}}function w(e){const t=[],n=o(e,"Field");let i=[];for(let s=0;s<n.length;s++){const e=a(n[s],"Identifier"),l=a(n[s],"Description"),p=a(n[s],"Definition"),m=a(n[s],"Abstract"),u=a(n[s],"Title"),f=d(n[s],"1.1.0"),c=[],h=o(n[s],"Axis");for(let t=0;t<h.length;t++){const e=h[t].getAttribute("identifier"),n=a(h[t],"UOM"),o=a(h[t],"DataType"),s=r(h[t],"Key");"band"===e.toLowerCase()&&(i=s),c.push({identifier:e,uom:n,dataType:o,values:s})}t.push({identifier:e,description:l,definition:p,abstract:m,title:u,supportedInterpolations:f,axis:c})}return{rangeSet:t,bandNames:i}}function y(e,t){const n=e.filter((e=>-1===e.identifier.toLowerCase().indexOf("field_1")&&!e.axis.some((e=>"band"===e.identifier.toLowerCase())))),i=[];if(n.length&&n.forEach((e=>{var t,n;const o=e.axis.map((e=>{const t=e.values.map((t=>{if("ISO8601"===e.uom){return-1===(t=t.trim()).toLowerCase().indexOf("z")?new Date(t+"Z").getTime():new Date(t).getTime()}return parseFloat(t.trim())})),n=[Math.min.apply(null,t),Math.max.apply(null,t)];return{name:e.identifier.trim(),description:"",field:e.identifier.trim(),unit:e.uom?e.uom.trim():"",hasRegularIntervals:!1,values:t,extent:n}}));i.push({name:e.identifier.trim(),description:null!=(t=null==(n=e.description)?void 0:n.trim())?t:"",unit:"",dimensions:o})})),t.temporalDomain){const{begin:e,end:n,values:o,units:s,resolution:a}=t.temporalDomain;i.some((e=>e.dimensions.some((e=>"stdtime"===e.name.toLowerCase()))))||i.forEach((t=>{t.dimensions.push({name:"StdTime",description:"",unit:"ISO8601",values:null==o?void 0:o.map((e=>e.getTime())),hasRegularIntervals:!o,interval:a,intervalUnit:s,extent:[e.getTime(),n.getTime()]})}))}return i.length?{variables:i}:null}function D(t){var n;const s=p(t,"SpatialDomain"),r=p(s,"GridCRS"),l=a(r,"GridBaseCRS"),u=a(r,"GridOrigin"),d=null!=(n=null==u?void 0:u.split(" ").map((e=>parseFloat(e))))?n:[0,0],f=m(r,"GridOffsets"),c=o(s,"BoundingBox");let h,g,b,v;for(let i=0;i<c.length;i++){var w;const t=null==(w=c[i].getAttribute("crs"))?void 0:w.toLowerCase();if(null!=t)if(t.indexOf("imagecrs")>-1){const e=m(c[i],"LowerCorner"),t=m(c[i],"UpperCorner");h=t[0]-e[0]+1,g=t[1]-e[1]+1}else if(t.indexOf("epsg")>0){const n=t.split(":");b=parseInt(n[n.length-1],10);const o=m(c[i],"LowerCorner"),s=m(c[i],"UpperCorner");v=new e({xmin:o[0],ymin:o[1],xmax:s[0],ymax:s[1],spatialReference:{wkid:b}})}}const y=h>g,D=v.xmax-v.xmin>v.ymax-v.ymin;let L=!1;i(b)&&(y===D?L=!1:(L=!0,v=new e({xmin:v.ymin,ymin:v.xmin,xmax:v.ymax,ymax:v.xmax,spatialReference:{wkid:b}})));const S={columns:h,rows:g,origin:{x:d[0],y:d[1]},offset:{x:f[0],y:f[1]},gridBaseCRS:l,envelope:v,useEPSGAxis:L},C=p(t,"temporalDomain")||p(t,"TemporalDomain");return{spatialDomain:S,temporalDomain:C?x(C):null}}function L(e,t){const i=[],o=[],s={supportedFormats:i,supportedCRSs:o,version:"1.1"};let r;for(let n=0;n<e.childNodes.length;n++){const t=e.childNodes[n];if(1!==t.nodeType)continue;const p=l(t).toLowerCase();switch(p){case"title":case"abstract":case"identifier":s[p]=a(t);break;case"supportedformat":{const e=a(t);-1===i.indexOf(e)&&i.push(e)}break;case"supportedcrs":{const e=a(t);-1===o.indexOf(e)&&o.push(e)}break;case"range":{const e=w(t);s.range=e.rangeSet,r=e.bandNames}break;case"domain":s.domain=D(t)}}const p=f(s.range[0].supportedInterpolations),{identifier:m,abstract:u,title:d,domain:c,range:h}=s,g={x:Math.abs(c.spatialDomain.offset.x),y:Math.abs(c.spatialDomain.offset.y)},x=y(h,c),b=new n({width:c.spatialDomain.columns,height:c.spatialDomain.rows,pixelSize:g,extent:c.spatialDomain.envelope,spatialReference:c.spatialDomain.envelope.spatialReference,bandCount:r.length||1,multidimensionalInfo:x});return{id:m,title:s.title,description:u||d,lonLatEnvelope:null,bandNames:r,rasterInfo:b,supportedFormats:i,supportedInterpolations:p,coverageDescription:s,version:t,useEPSGAxis:c.spatialDomain.useEPSGAxis}}function S(t){const n=p(t,"Envelope")||p(t,"EnvelopeWithTimePeriod"),i=n.getAttribute("srsName"),o=i.slice(i.lastIndexOf("/")+1),r=n.getAttribute("axisLabels").split(" ").map((e=>e.trim())).filter((e=>""!==e.trim())),l=m(n,"lowerCorner"),u=m(n,"upperCorner"),d=!["y","lat","latitude","north","nor","n","b"].some((e=>e===r[0].toLowerCase()));let f;const c=parseInt(o,10),h=isNaN(c)?null:{wkid:c};f=new e(d?{xmin:l[0],ymin:l[1],xmax:u[0],ymax:u[1],spatialReference:h}:{xmin:l[1],ymin:l[0],xmax:u[1],ymax:u[0],spatialReference:h});const g={mins:l,maxs:u},x=n.getAttribute("uomLabels").trim().split(" ");let b,v;return s(n,"EnvelopeWithTimePeriod")&&(b=new Date(a(t,"beginPosition")||a(t,"BeginPosition")),v=new Date(a(t,"endPosition")||a(t,"EndPosition"))),{envelope:f,axisLabels:r,uomLabels:x.length?x:null,envelopeAllDims:g,beginPosition:b,endPosition:v,isEastFirst:d}}function C(e){const t=[],n=o(e,"DataRecord"),i=[];for(let r=0;r<n.length;r++){const e=o(n[r],"field"),l=[];for(let t=0;t<e.length;t++){var s;const n=e[t].getAttribute("name"),o=a(e[t],"description")||"",r=(null==(s=p(e[t],"uom"))?void 0:s.getAttribute("code"))||"",u=m(e[t],"interval");n.toLowerCase().indexOf("band")>-1&&i.push(n),l.push({name:n,description:o,uom:r,allowedValues:u})}t.push(l)}return{rangeType:t,bandNames:i}}function I(e){let t=1,n="";const i=.01;return Math.abs(e-1/24)<1/24*i?n="Hours":Math.abs(e-1)<1*i?n="Days":e<1?(t=Math.round(24*e),n="Hours"):e>28-i&&e<31+i||Math.round(e/30)<12?n="Months":e>365-i&&e<366+i&&(n="Years"),{interval:t,intervalUnit:n}}function R(e,t,n){const i=[];for(let s=0;s<e.length;s++){const t=e[s];for(let e=0;e<t.length;e++)-1===t[e].name.toLowerCase().indexOf("band")&&i.push(t[e])}const o=[];if(i.length){const e=[];for(let i=2;i<n.axisLabels.length;i++){const o=(t.uomLabels&&t.uomLabels.length)>i?t.uomLabels[i]:"",s=n.axisLabels[i].toLowerCase().indexOf("time")>-1||"iso8601"===o.toLowerCase()||"oledatetime"===o.toLowerCase();let a,r;if(s){const e=I(n.offset[i]);a=e.interval,r=e.intervalUnit}else a=n.offset[i],r=o;const l=[];s?(l.push((new Date).setTime(24*(t.envelopeAllDims.mins[i]-25569)*3600*1e3)),l.push((new Date).setTime(24*(t.envelopeAllDims.maxs[i]-25569)*3600*1e3))):(l.push(t.envelopeAllDims.mins[i]),l.push(t.envelopeAllDims.maxs[i])),e.push({name:n.axisLabels[i].trim(),description:n.axisLabels[i].trim(),unit:t.uomLabels&&t.uomLabels.length>i?t.uomLabels[i].trim():"",hasRegularIntervals:!0,extent:l,interval:a,intervalUnit:r})}if(i.forEach((t=>{var n,i;return o.push({name:t.name.trim(),description:null!=(n=null==(i=t.description)?void 0:i.trim())?n:"",unit:t.uom.trim(),dimensions:e})})),o.length)return{variables:o}}return null}function T(e,t){const n=p(e,"RectifiedGrid"),i=m(n,"low"),s=m(n,"high"),r=[];for(let o=0;o<i.length;o++)r.push(s[o]-i[o]+1);const l=a(n,"axisLabels").split(" "),u=m(n,"origin/pos"),d=o(n,"offsetVector"),f=[];for(let o=0;o<d.length;o++){const e=m(d[o]),t=e.findIndex((e=>0!==e));f[t]=e[t]}const c=t||l;let h,g,x;return["y","lat","latitude","north","nor","n","b"].some((e=>e===c[0].toLowerCase()))?(h=r[1],g=r[0],x={y:Math.abs(f[0]),x:Math.abs(f[1])}):(h=r[0],g=r[1],x={x:Math.abs(f[0]),y:Math.abs(f[1])}),{columns:h,rows:g,origin:u,offset:f,resolution:x,gridSamples:r,axisLabels:l}}function M(e){const n=p(e,"EarthObservation");if(!n)return null;const i=p(n,"phenomenonTime"),o=i?x(i):null,s=p(n,"phenomenonTime"),r=s?x(s):null,l=a(n,"featureOfInterest/Footprint/multiExtentOf/MultiSurface/surfaceMembers/Polygon/exterior/LinearRing/posList");let m=null;if(l){const e=l.split(" ").map((e=>e.trim())).filter((e=>null!=e&&""!==e));if(e.length){const n=[];for(let t=0;t<e.length/2;t+=2)n.push(e[t],e[t+1]);m=new t({rings:[n],spatialReference:{wkid:4326}})}}return{observation:{phonomenonTime:o,resultTime:r,footprint:m,identifier:a(e,"metaDataProperty/EarthObservationMetaData/identifier"),acquisitionType:a(e,"metaDataProperty/EarthObservationMetaData/acquisitionType"),status:a(e,"metaDataProperty/EarthObservationMetaData/status")}}}function O(e){const t={version:"2.0"};let i=[];for(let n=0;n<e.childNodes.length;n++){const l=e.childNodes[n];if(1===l.nodeType)if(s(l,"coverageId"))t.coverageId=a(l);else if(s(l,"ServiceParameters"))t.serviceParameters={supportedFormats:r(l,"nativeFormat")};else if(s(l,"boundedBy"))t.boundedBy=S(l);else if(s(l,"rangeType")){const e=C(l);t.rangeType=e.rangeType,i=e.bandNames}else if(s(l,"domainSet")){var o;t.domainSet=T(l,null==(o=t.boundedBy)?void 0:o.axisLabels)}else if(s(l,"metadata")){const e=p(l,"EOMetadata");t.eoMetadata=e?M(e):null}}const{coverageId:l,boundedBy:m,domainSet:u,rangeType:d,serviceParameters:f}=t,c=R(d,m,u);return{id:l,title:l,description:l,lonLatEnvelope:null,bandNames:i,rasterInfo:new n({width:u.columns,height:u.rows,pixelSize:u.resolution,extent:m.envelope,spatialReference:m.envelope.spatialReference,bandCount:i.length||1,multidimensionalInfo:c}),supportedFormats:f.supportedFormats,supportedInterpolations:null,coverageDescription:t,version:"2.0.1",useEPSGAxis:!1}}function P(e,t){let n=null;if("string"==typeof e){n=(new DOMParser).parseFromString(e,"text/xml")}else n=e;if("1.0.0"===t){return o(n,"CoverageOffering").map((e=>v(e)))}const i=o(n,"CoverageDescription");return"1.1.0"===t||"1.1.1"===t||"1.1.2"===t?i.map((e=>L(e,t))):i.map((e=>O(e)))}export{P as parseCoverages,f as standardizeInterpolations};
