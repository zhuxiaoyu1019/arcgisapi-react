/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../../config.js";import r from"../../request.js";import{throwIfAborted as s}from"../../core/promiseUtils.js";import{urlToObject as t,removeTrailingSlash as o,getOrigin as l,isProtocolRelative as n,isAbsolute as i,join as u,normalize as c,removeFile as a,appBaseUrl as f}from"../../core/urlUtils.js";import p from"../../views/2d/engine/vectorTiles/style/VectorTileSource.js";const m=e.defaults&&e.defaults.io.corsEnabledServers;async function y(e,r){const s={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:"",spriteFormat:"png"},[o,l]="string"==typeof e?[e,null]:[null,e.jsonUrl],n=o?t(o):null;await h(s,"esri",e,l,r);const i={layerDefinition:s.validatedSource,url:o,parsedUrl:n,serviceUrl:s.sourceUrl,style:s.style,styleUrl:s.styleUrl,spriteUrl:s.style.sprite&&S(s.styleBase,s.style.sprite),spriteFormat:s.spriteFormat,glyphsUrl:s.style.glyphs&&S(s.styleBase,s.style.glyphs),sourceNameToSource:s.sourceNameToSource,primarySourceName:s.primarySourceName};return d(i.spriteUrl),d(i.glyphsUrl),i}function d(e){if(!e)return;const r=l(e);m&&-1===m.indexOf(r)&&m.push(r)}function S(...e){let r;for(let s=0;s<e.length;++s)if(n(e[s])){if(r){const t=r.split("://")[0];r=t+":"+e[s].trim()}}else r=i(e[s])?e[s]:u(r,e[s]);return o(r)}async function h(e,o,l,n,i){let u,a,f;if(s(i),"string"==typeof l){const e=c(l);d(e);const s=t(e);f=await r(s.path,{query:{f:"json"},responseType:"json",...i}),u=e,a=e}else f={data:l},u=l.jsonUrl||null,a=n;const p=f.data;return f.ssl&&(u&&(u=u.replace(/^http:/i,"https:")),a&&(a=a.replace(/^http:/i,"https:"))),U(p)?(e.styleUrl=u||null,w(e,p,a,i)):x(p)?e.sourceUrl?g(e,p,a,!1,o,i):(e.sourceUrl=u||null,g(e,p,a,!0,o,i)):Promise.reject("You must specify the URL or the JSON for a service or for a style.")}function U(e){return!!e.sources}function x(e){return!U(e)}async function w(e,r,s,t){const o=s?a(s):f;e.styleBase=o,e.style=r,e.styleUrl&&d(e.styleUrl),r["sprite-format"]&&"webp"===r["sprite-format"].toLowerCase()&&(e.spriteFormat="webp");const l=[];if(r.sources&&r.sources.esri){const s=r.sources.esri;s.url?await h(e,"esri",S(o,s.url),void 0,t):l.push(h(e,"esri",s,o,t))}for(const n of Object.keys(r.sources))"esri"!==n&&"vector"===r.sources[n].type&&(r.sources[n].url?l.push(h(e,n,S(o,r.sources[n].url),void 0,t)):r.sources[n].tiles&&l.push(h(e,n,r.sources[n],o,t)));await Promise.all(l)}async function g(e,r,s,t,l,n){const i=s?o(s)+"/":f,u=j(r,i),c=new p(l,i,u);if(!t&&e.primarySourceName in e.sourceNameToSource){const r=e.sourceNameToSource[e.primarySourceName];if(!r.isCompatibleWith(c))return Promise.resolve();null!=c.fullExtent&&(null!=r.fullExtent?r.fullExtent.union(c.fullExtent):r.fullExtent=c.fullExtent.clone()),r.tileInfo.lods.length<c.tileInfo.lods.length&&(r.tileInfo=c.tileInfo)}if(t?(e.sourceBase=i,e.source=r,e.validatedSource=u,e.primarySourceName=l,e.sourceUrl&&d(e.sourceUrl)):d(i),e.sourceNameToSource[l]=c,!e.style)return null==r.defaultStyles?Promise.reject():"string"==typeof r.defaultStyles?h(e,"",S(i,r.defaultStyles,"root.json"),void 0,n):h(e,"",r.defaultStyles,S(i,"root.json"),n)}function j(e,r){if(e.hasOwnProperty("tileInfo"))return e;const s={xmin:-20037507.067161843,ymin:-20037507.067161843,xmax:20037507.067161843,ymax:20037507.067161843,spatialReference:{wkid:102100}},t=512;let o=78271.51696400007,l=295828763.7957775;const n=[],i=e.hasOwnProperty("minzoom")?parseFloat(e.minzoom):0,u=e.hasOwnProperty("maxzoom")?parseFloat(e.maxzoom):22;for(let c=0;c<=u;c++)c>=i&&n.push({level:c,scale:l,resolution:o}),o/=2,l/=2;for(const c of e.tiles)d(S(r,c));return{capabilities:"TilesOnly",initialExtent:s,fullExtent:s,minScale:0,maxScale:0,tiles:e.tiles,tileInfo:{rows:t,cols:t,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},lods:n,spatialReference:{wkid:102100}}}}export{y as loadMetadata};
