/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../geometry.js";import t from"../../../core/Error.js";import s from"../../../core/Loadable.js";import{isNone as r,isSome as o}from"../../../core/maybe.js";import{property as i}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import"../../../core/Logger.js";import{subclass as p}from"../../../core/accessorSupport/decorators/subclass.js";import{equals as n}from"../../../geometry/support/spatialReferenceUtils.js";import{queryFeatureSet as a,queryFeatureSetJSON as u,getSpatialReference as l,getServerLandingPage as c,getServerConformance as m,getServerCollections as d,getServerOpenApi as y,getCollectionDefinition as f}from"../../ogc/ogcFeatureUtils.js";import h from"../../../geometry/SpatialReference.js";import{typeKebabDictionary as g}from"../../../geometry/support/typeUtils.js";const S="http://www.opengis.net/def/crs/OGC/1.3/CRS84";let v=class extends s{constructor(){super(...arguments),this.featureDefinition=null,this.type="ogc-feature"}load(e){return this.addResolvingPromise(this._loadOGCServices(this.layer,e)),this.when()}getFeatureDefinition(){const{featureDefinition:{collection:e,layerDefinition:t,spatialReference:s,supportedCrs:r},layer:{apiKey:o,capabilities:i,customParameters:p}}=this;return{capabilities:i,collection:e,layerDefinition:t,queryParameters:{apiKey:o,customParameters:p},spatialReference:s,supportedCrs:r}}queryExtent(e,t={}){return null}queryFeatureCount(e,t={}){return null}queryFeatures(e,t={}){const s=this.getFeatureDefinition();return this.load(t).then((()=>a(s,e,t)))}queryFeaturesJSON(e,t={}){const s=this.getFeatureDefinition();return this.load(t).then((()=>u(s,e,t)))}queryObjectIds(e,t={}){return null}supportsSpatialReference(e){return!(!e.isWGS84&&!e.isWebMercator)||this.featureDefinition.supportedCrs.some((t=>{const s=l(t);return!r(s)&&n(s,e)}))}_conformsToType(e,t){var s;const r=new RegExp(`^${t}$`,"i");return null!=(s=e.conformsTo.some((e=>r.test(e))))&&s}_getCapabilities(e,t){var s,r,i,p,n,a,u;const l=o(t)?null==(s=t.components)?void 0:s.parameters:null;return{attachment:null,data:{isVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:e},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!1,supportsDelete:!1,supportsEditing:!1,supportsChangeTracking:!1,supportsQuery:!1,supportsQueryAttachments:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:!1,supportsExceedsLimitStatistics:!1},query:{maxRecordCount:null!=(r=null!=(i=null==l||null==(p=l.limit)||null==(n=p.schema)?void 0:n.maximum)?i:null==l||null==(a=l.limitFeatures)||null==(u=a.schema)?void 0:u.maximum)?r:5e3,maxRecordCountFactor:void 0,standardMaxRecordCount:void 0,supportsCacheHint:!1,supportsCentroid:!1,supportsDisjointSpatialRelationship:!1,supportsDistance:!1,supportsDistinct:!1,supportsExtent:!1,supportsFormatPBF:!1,supportsGeometryProperties:!1,supportsHavingClause:!1,supportsHistoricMoment:!1,supportsMaxRecordCountFactor:!1,supportsOrderBy:!1,supportsPagination:!1,supportsPercentileStatistics:!1,supportsQuantization:!1,supportsQuantizationEditMode:!1,supportsQueryByOthers:!1,supportsQueryGeometry:!1,supportsResultType:!1,supportsStandardizedQueriesOnly:!1,supportsTopFeaturesQuery:!1,supportsStatistics:!1,supportsSqlExpression:!1,tileMaxRecordCount:void 0},queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1},editing:{supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsGeometryUpdate:!1,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsUploadWithItemId:!1,supportsUpdateWithoutM:!1}}}_getExtent(e){var t;const s=null==(t=e.extent)?void 0:t.spatial;if(!s)return null;const r=s.bbox[0],o=4===r.length,i=r[0],p=r[1],n=o?void 0:r[2];return{xmin:i,ymin:p,xmax:o?r[2]:r[3],ymax:o?r[3]:r[4],zmin:n,zmax:o?void 0:r[5],spatialReference:h.WGS84.toJSON()}}_getSpatialReference(e){var t;const s=null!=(t=e.storageCrs)?t:S,o=l(s);return r(o)?h.WGS84:o}_getSupportedSpatialReferences(e,t){var s;const r="#/crs",o=null!=(s=e.crs)?s:[S],i=o.includes(r)?o.filter((e=>e!==r)).concat(t.crs):o,p=/^http:\/\/www\.opengis.net\/def\/crs\/epsg\/.*\/3785$/i;return i.filter((e=>!p.test(e)))}async _loadOGCServices(e,s){const r=o(s)?s.signal:null,{apiKey:i,collectionId:p,customParameters:n,fields:a,geometryType:u,hasZ:l,objectIdField:h,timeInfo:S,url:v}=e,R={fields:null==a?void 0:a.map((e=>e.toJSON())),geometryType:g.toJSON(u),hasZ:l,objectIdField:h,timeInfo:null==S?void 0:S.toJSON()},x={apiKey:i,customParameters:n,signal:r},C=await c(v,x),[w,j]=await Promise.all([m(C,x),d(C,x)]);if(!this._conformsToType(w,"http://www.opengis.net/spec/ogcapi-features-1/1.0/conf/geojson"))throw new t("ogc-feature-layer:no-geojson-support","Server does not support geojson");const O=j.collections.find((e=>e.id===p));if(!O)throw new t("ogc-feature-layer:collection-not-found","Server does not contain the named collection");const F=this._conformsToType(w,"http://www.opengis.net/spec/ogcapi-features-1/1.0/conf/oas30")?await y(C,x):null,b=await f(O,R,x),D=this._getCapabilities(b.hasZ,F),P=this._getExtent(O),T=this._getSpatialReference(O).toJSON(),_=this._getSupportedSpatialReferences(O,j);b.extent=P,this.featureDefinition={capabilities:D,collection:O,layerDefinition:b,queryParameters:{},spatialReference:T,supportedCrs:_}}};e([i()],v.prototype,"featureDefinition",void 0),e([i({constructOnly:!0})],v.prototype,"layer",void 0),e([i()],v.prototype,"type",void 0),v=e([p("esri.layers.graphics.sources.OGCFeatureSource")],v);var R=v;export default R;export{v as OGCFeatureSource};
