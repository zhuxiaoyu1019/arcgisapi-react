/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{remove as t}from"../../core/arrayUtils.js";import{removeMaybe as a,isSome as r,isNone as i,destroyMaybe as s}from"../../core/maybe.js";import"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/accessorSupport/ensureType.js";import"../../core/Logger.js";import{subclass as o}from"../../core/accessorSupport/decorators/subclass.js";import{reactionInit as n}from"../../core/accessorSupport/trackingUtils.js";import l from"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import{BatchCreateWorkflowData as c}from"./BatchCreateWorkflowData.js";import u from"./Workflow.js";import{startCreatingNewFeature as d,findLayerInfo as h,updateGraphicSymbolWhenRequired as p,getVisualVariableAttributes as f,startUpdatingFeature as v,createWorkflowSteps as g,avoidFeatureTemplateSelectionWithOnlyOneItem as w,visualVariableInteractiveUpdate as m}from"./workflowUtils.js";var y;let b=y=class extends u{constructor(e){super(e),this.type="batch-create",this.createFeatureState="create-new",this.featureFormHandle=null,this.visualVariableAttributes={rotation:null,size:null},this.highlightHandles=new Map,this.preventDefaultActionOnCancel=!1}get numPendingFeatures(){return this.data.viewModel.sketchViewModel.layer.graphics.length}get pendingFeatures(){return this.data.viewModel.sketchViewModel.layer.graphics}async updatePendingFeature(e){return this.preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),t(this.lastActiveGraphics,e),this.startUpdating(e)}static create(e,t,a){const r=new y({data:new c({viewModel:e}),onCommit:async e=>{await a(e.creationInfo.layer,{addFeatures:e.viewModel.sketchViewModel.layer.graphics.toArray()})}});return r._set("steps",this._createWorkflowSteps(r,t)),r}highlight(e){const t=this.data.viewModel.view;"3d"===t.type&&this.highlightHandles.set(e,t.highlight(e))}removeHighlight(e){a(this.highlightHandles.get(e)),this.highlightHandles.delete(e)}async startCreating(){return this.createFeatureState="create-new",d(this.data.viewModel.sketchViewModel,this.data.creationInfo)}async startUpdating(e){var t;const r=this.data.viewModel,i=r.sketchViewModel,s=this.data.creationInfo.layer;return r.featureFormViewModel.set({feature:e,fieldConfig:null==(t=h(r.layerInfos,s))?void 0:t.fieldConfig}),a(this.featureFormHandle),this.featureFormHandle=r.featureFormViewModel.on("value-change",(async()=>{e.attributes=r.featureFormViewModel.getValues(),"3d"===i.view.type&&await p(e)})),this.removeHighlight(e),this.createFeatureState="update-pending",this.visualVariableAttributes=f(e),v(i,e,s,this.visualVariableAttributes)}static _createWorkflowSteps(e,o="awaiting-feature-creation-info"){const{data:c,handles:u}=e;let d=null,h=!0;const p=g(["awaiting-feature-creation-info","batch-creating-features"],o,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){c.creationInfo=null,u.add(c.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{c.creationInfo={layer:e.layer,template:e.template},c.viewModel.activeWorkflow.next()})),this.id)},async tearDown(){u.remove(this.id)}}),"batch-creating-features":()=>({id:"batch-creating-features",async setUp(){const o=c.viewModel.view,p=c.viewModel.sketchViewModel;h=p.updateOnGraphicClick,p.updateOnGraphicClick=!1,e.lastActiveGraphics=[],e.featureFormHandle=a(e.featureFormHandle),e.visualVariableAttributes={rotation:null,size:null};const f=p.on("create",(async t=>{if("cancel"===t.state){if(e.preventDefaultActionOnCancel)return void(e.preventDefaultActionOnCancel=!1);if(e.lastActiveGraphics.length<1)return e.startCreating();const t=e.lastActiveGraphics.pop();return e.startUpdating(t)}if("complete"===t.state)return e.startUpdating(t.graphic)})),v=p.on("update",(async t=>{const a=t.graphics[0];if("complete"===t.state)return a!==d&&(e.lastActiveGraphics.push(a),e.highlight(a)),d=null,t.aborted&&e.preventDefaultActionOnCancel?void(e.preventDefaultActionOnCancel=!1):e.startCreating();"start"===t.state&&e.removeHighlight(a),await m(o,a,t,e.visualVariableAttributes);const i=a.attributes;if(r(e.visualVariableAttributes.rotation)){const{field:t}=e.visualVariableAttributes.rotation;c.viewModel.featureFormViewModel.setValue(t,i[t])}if(r(e.visualVariableAttributes.size)){const{field:t}=e.visualVariableAttributes.size;c.viewModel.featureFormViewModel.setValue(t,i[t])}})),g=p.on("delete",(async a=>{const r=a.graphics[0];t(e.lastActiveGraphics,r),d=r}));let w=null;const y=n((()=>{var e;const t=p.snappingOptions.featureSources.find((e=>e.layer===c.creationInfo.layer));return{hasFeatureLayerSource:!!t,enabled:null!=(e=null==t?void 0:t.enabled)&&e}}),(({hasFeatureLayerSource:e,enabled:t})=>{const a=p.snappingOptions.featureSources;e?(i(w)&&(w=new l({layer:p.layer,enabled:t}),a.add(w)),w.enabled=t):(r(w)&&a.remove(w),w=s(w))})),b=o.on("immediate-click",(async t=>{const a=await o.hitTest(t,{include:p.layer});if(a.results.length>0){const t=a.results[0].graphic;if("transform"===p.activeTool||"reshape"===p.activeTool){if(p.updateGraphics.getItemAt(0)===t)return;await e.updatePendingFeature(t)}}}));await e.startCreating();const M={remove:()=>{a(e.featureFormHandle),f.remove(),v.remove(),g.remove(),y.remove(),r(w)&&p.snappingOptions.featureSources.remove(w),w=s(w),p.cancel(),b.remove()}};u.add(M,this.id)},async tearDown(e){e.cancelled&&c.viewModel.sketchViewModel.layer.removeAll(),u.remove(this.id),c.viewModel.sketchViewModel.updateOnGraphicClick=h}})});return w(c,p)}};b=y=e([o("esri.widgets.Editor.BatchCreateWorkflow")],b);var M=b;export default M;
