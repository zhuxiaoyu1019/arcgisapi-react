/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../../Graphic.js";import"../../core/has.js";import{isSome as t,isNone as r,removeMaybe as i}from"../../core/maybe.js";import{whenOrAbort as a,eachAlways as n}from"../../core/promiseUtils.js";import{px2pt as s}from"../../core/screenUtils.js";import{init as o,whenFalseOnce as l}from"../../core/watchUtils.js";import{diff as c}from"../../core/accessorSupport/diffUtils.js";import{calculateTolerance as u}from"../../renderers/support/clickToleranceUtils.js";import{meterIn as p}from"../../renderers/support/lengthUtils.js";import{getTransformationType as y}from"../../renderers/visualVariables/support/sizeVariableUtils.js";import{getVisualVariableValues as f}from"../../renderers/visualVariables/support/visualVariableUtils.js";import{to3D as d}from"../../symbols/support/symbolConversion.js";import{getDisplayedSymbol as m}from"../../symbols/support/symbolUtils.js";import{GraphicState as h}from"../../views/3d/layers/graphics/GraphicState.js";import{createQueryGeometry as g}from"../../views/support/drapedUtils.js";import{hitTestSelectSameDistance as b}from"../../views/support/hitTestSelectUtils.js";function w(e){const t=e.sourceLayer,r=V(t.renderer)&&f(t.renderer,e),i=r?r.map((e=>e.variable)):[],a=i.filter((e=>"rotation"===e.type&&(!e.axis||"heading"===e.axis))),n=a[0],s=1===a.length&&n.field&&!n.valueExpression,o=i.filter((e=>"size"===e.type)),l=o[0],c=1===o.length&&"real-world-size"===y(l)&&l.field&&!l.useSymbolValue&&!l.valueExpression;return{rotation:s?v(n,t):null,size:c?S(l,t):null}}function v(e,t){const r="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,i=e.field,a=t.fields&&t.fields.filter((e=>e.name===i)),n=a&&1===a.length?a[0].type:"double",s={initial:0,current:0};return{field:i,getDefault:()=>Promise.resolve(0),getValue:e=>(s.current=s.initial-r*e,U((s.current+360)%360,n)),initValue:e=>{s.initial=null!=e?e:s.current,s.current=0},isUpdatingInteractively:!1}}function j(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}async function I(e,t,i){if(r(t))return 0;const{symbol:a}=d(t);if(r(a)||"web-style"===a.type)return 0;const n=a.symbolLayers.getItemAt(0);if(!n)return 0;switch(n.type){case"icon":{const{computeIconLayerResourceSize:e}=await import("../../symbols/support/symbolLayerUtils.js");return n.size||Math.min(Z.icon,(await e(n,Z.icon))[0])||Z.icon}case"text":return n.size||Z.text;case"line":return n.size||Z.line;case"object":{const{computeObjectLayerResourceSize:t}=await import("../../symbols/support/symbolLayerUtils.js");return j(await t(n,e.scale/Z.viewScaleSizeFactor),i)}case"path":case"extrude":return n.size||e.scale/Z.viewScaleSizeFactor;case"fill":case"water":default:return 0}}function S(e,t){const r=e.field,i=e.axis,a=t.fields&&t.fields.filter((e=>e.name===r)),n=a&&1===a.length?a[0].type:"double",s={updating:!1,initial:0,current:0},o=p[e.valueUnit];let l;return l="area"===e.valueRepresentation?e=>(e*o/2)**2*Math.PI:"radius"===e.valueRepresentation||"distance"===e.valueRepresentation?e=>e*o/2:e=>e*o,{field:r,getDefault:async(e,t)=>U(l(await I(t,e,i)),n),getValue:(e,t)=>(s.initial||(s.initial=t.pixelSizeAt(t.center)),s.current=s.initial*e,U(s.current,n)),initValue:e=>{s.initial=null!=e?e:s.current,s.current=0},isUpdatingInteractively:!1}}function U(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}function V(e){switch(e.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":return!0;default:return!1}}async function z(e){const r=await m(e,{useSourceLayer:!0,ignoreGraphicSymbol:!0}),i=c(e.symbol,r);t(i)&&(e.symbol=r)}function L(e){if("mesh"===e||"multipatch"===e)throw new Error("Mesh and Multipatch not supported");return e}async function x(e,t,r){await F(e,t);const i=e.on("create",(async i=>{if("cancel"===i.state)return F(e,t);if("complete"===i.state){const e=i.graphic;e.sourceLayer||(e.sourceLayer=t.layer),e.attributes||(e.attributes={...t.template.prototype.attributes}),await z(e),r(e)}}));return{remove:()=>{i.remove(),e.cancel()}}}async function F(e,t){const r=t.layer,i={...t.template.prototype.attributes};await M(e,r,i);const a={graphicProperties:{attributes:i,sourceLayer:r},hasZ:r.capabilities.data.supportsZ};e.layer.elevationInfo=r.elevationInfo,e.create(L(r.geometryType),a)}async function M(t,i,a){var n;if("3d"!==t.view.type)return;const s=new e({sourceLayer:i,attributes:a}),{rotation:o,size:l}=w(s);let c=await m(s,{useSourceLayer:!0}),u=!1;for(const e of[l,o]){if(r(e))continue;null==a[e.field]&&(a[e.field]=await e.getDefault(c,t.view),u=!0)}switch(u&&(c=await m(s,{useSourceLayer:!0})),null==(n=c)?void 0:n.type){case"simple-fill":case"polygon-3d":t.polygonSymbol=c;break;case"simple-line":case"line-3d":t.polylineSymbol=c;break;case"simple-marker":case"point-3d":t.pointSymbol=c}}function R(e,t){return e&&e.find((e=>e.layer===t))}async function E(e,t,r,i){if(0===e.length)return[];const{updatable:s,graphicsByLayer:o}=await r.async((async()=>{const{results:n}=await a(b(t,r),i),s=new Map,o=({layer:e})=>{const t=s.get(e);if(!t){const t=new Array;return s.set(e,t),t}return t};n.forEach((({graphic:e})=>o(e).push(e)));const l=e.filter((({supports:e,layer:t})=>e.indexOf("update")>-1&&s.has(t)));return 0!==l.length&&r.stopPropagation(),{updatable:l,graphicsByLayer:s}}));return a(n(s.map((async({layer:e})=>{const{objectIdField:t,displayField:r}=e,a=[t];e.fieldsIndex.has(r)&&a.push(r);const n=o.get(e);if(!!n.some((e=>a.some((t=>!(t in e.attributes)))))){const t=e.createQuery();return t.outFields=a,t.returnGeometry=!1,t.objectIds=n.map((e=>e.getObjectId())),e.queryFeatures(t,{signal:i}).then((({features:e})=>e))}return n}))),i)}async function T(e,t,r,i){if(0===e.length)return[];const s=await r.async((async()=>{const{results:n}=await a(t.hitTest(r),i);if(0===n.length)return[];const s=new Set;n.forEach((({graphic:e})=>s.add(e.layer)));const o=e.items.filter((({layer:e,supports:t})=>t.indexOf("update")>-1&&s.has(e)));return o.length>0&&r.stopPropagation(),o}));return a(n(s.map((({layer:e})=>{const{objectIdField:a,displayField:n}=e,s=[a];e.fieldsIndex.has(n)&&s.push(n);const o=e.createQuery();o.outFields=s,o.returnGeometry=!1;const l="renderer"in e?u({renderer:e.renderer,event:r}):0;return o.geometry=g(r.mapPoint,l,t),o.outSpatialReference=t.spatialReference,e.queryFeatures(o,{signal:i}).then((({features:e})=>e))}))),i)}async function k(e,t,r,i){switch(t.type){case"3d":return E(e,t,r,i);case"2d":return T(e,t,r,i)}}async function A(e,t,r){const i=e.layer,a=i.createQuery();return a.objectIds=[e.getAttribute(i.objectIdField)],a.outFields=["*"],a.outSpatialReference=t.spatialReference,a.returnM=i.capabilities.data.supportsM,a.returnZ=i.capabilities.data.supportsZ,(await i.queryFeatures(a,{signal:r})).features[0]}async function G(e,i,a,n){let s=!1;const{rotation:o,size:l}=n;[o,l].forEach((async a=>{if(r(a))return;const n=i.attributes[a.field];if(t(n))a.initValue(n);else{const t=await a.getDefault(i.symbol,e.view);a.initValue(t),i.setAttribute(a.field,t),s=!0}})),s&&"3d"===e.view.type&&await z(i);const c={multipleSelectionEnabled:!1};return"point"===a.geometryType&&(c.enableRotation=t(o),c.enableScaling=t(l)),e.layer.elevationInfo=a.elevationInfo,e.update(i,c)}function P(e){return!e||"rotate-start"!==e.type&&"rotate"!==e.type&&"rotate-stop"!==e.type?null:e}function q(e){return!e||"scale-start"!==e.type&&"scale"!==e.type&&"scale-stop"!==e.type?null:e}async function D(e,r,i,a){var n;if(!t(r.geometry)||"point"!==(null==(n=r.geometry)?void 0:n.type))return;const s=a.rotation,o=P(i.toolEventInfo);if(t(s)&&t(o))if("rotate-stop"===o.type)s.isUpdatingInteractively=!1,s.initValue();else{s.isUpdatingInteractively=!0;const{field:t,getValue:i}=s;r.attributes[t]=i(o.angle,e)}const l=a.size,c=q(i.toolEventInfo);if(t(l)&&t(c))if("scale-stop"===c.type)l.isUpdatingInteractively=!1,l.initValue();else{l.isUpdatingInteractively=!0;const{field:t,getValue:i}=l;r.attributes[t]=i(c.xScale,e)}"3d"===e.type&&await z(r)}async function O(e,a,n,s,c){const u=e.clone();await z(u),n.layer.add(u);const p=e.sourceLayer,y=s.whenLayerView(p),f=()=>{const t=e.layer,r=e.attributes[t.objectIdField];return y.then((e=>e.setVisibility(r,!1)),(()=>{})),{remove(){y.then((e=>e.setVisibility(r,!0)),(()=>{}))}}};let d=null,m=null;if("3d"===s.type){const e=new h({graphic:u});d=s.trackGraphicState(e),o(e,"displaying",(e=>{m=e?f():i(m)}))}else m=f();G(n,u,p,a);let g=null;y.then((e=>g=e),(()=>{}));const b=a.size,w=a.rotation,v=e.watch("attributes",(async e=>{let i=!1;for(const a in e){const n=e[a];n!==u.attributes[a]&&(u.setAttribute(a,n),t(b)&&!b.isUpdatingInteractively&&b.field===a&&b.initValue(n),t(w)&&!w.isUpdatingInteractively&&w.field===a&&w.initValue(n),(r(g)||g.requiredFields.includes(a))&&(i=!0))}i&&"3d"===s.type&&await z(u)})),j=n.on("update",(async e=>{const t=e.graphics[0];if("complete"===e.state)return G(n,t,p,a);await D(s,t,e,a),c(t.clone())})),I=n.on(["undo","redo"],(async e=>{c(e.graphics[0].clone())}));s.map.add(n.layer);const S=()=>{};return{interactive:{remove(){I.remove(),j.remove(),n.cancel(),v&&v.remove(),this.remove=S}},visual:{remove(){i(m),s.whenLayerView(p).then((e=>l(e,"updating"))).then((()=>{i(d),n.layer.remove(u),this.remove=S}))}}}}const Z={icon:s(24),text:s(12),line:s(1),viewScaleSizeFactor:100};function Q(e,t,r){let i=!1;return e.filter((e=>!!i||(i=e===t,i))).map((e=>r[e]()))}function B(e){if(1!==e.length)return null;const t=e[0];if("items"in t){const e=t;return 1===e.items.length?e.items[0]:null}return t}function C(e,r){if(e.viewModel.refreshCreationTemplates(),"awaiting-feature-creation-info"===r[0].id){const i=B(e.viewModel.featureTemplatesViewModel.items);t(i)&&(e.creationInfo={layer:i.layer,template:i.template},r.shift())}return r}export{C as avoidFeatureTemplateSelectionWithOnlyOneItem,Q as createWorkflowSteps,k as fetchCandidates,A as fetchFullFeature,R as findLayerInfo,w as getVisualVariableAttributes,x as setUpFeatureAdd,O as setUpGeometryUpdate,Z as sizeDefaults,F as startCreatingNewFeature,G as startUpdatingFeature,z as updateGraphicSymbolWhenRequired,D as visualVariableInteractiveUpdate};
