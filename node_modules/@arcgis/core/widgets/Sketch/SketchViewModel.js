/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../geometry.js";import t from"../../Graphic.js";import{symbolTypes as i}from"../../symbols.js";import o from"../../core/Collection.js";import"../../core/has.js";import a from"../../core/Error.js";import r from"../../core/Evented.js";import s from"../../core/Handles.js";import n from"../../core/Logger.js";import{isSome as p,destroyMaybe as c,unwrap as h,abortMaybe as l,isNone as d,get as v}from"../../core/maybe.js";import{createAbortError as y,createAbortController as u,whenOrAbort as m}from"../../core/promiseUtils.js";import{createScreenPoint as g,pt2px as _}from"../../core/screenUtils.js";import{watch as G,on as w,init as f,when as b,whenNotOnce as T,whenOnce as E}from"../../core/watchUtils.js";import{property as C}from"../../core/accessorSupport/decorators/property.js";import"../../core/accessorSupport/ensureType.js";import{subclass as S}from"../../core/accessorSupport/decorators/subclass.js";import{getReferenceEllipsoid as I}from"../../geometry/projectionEllipsoid.js";import{geometryToCoordinates as x}from"../../geometry/support/coordsUtils.js";import O from"../../layers/GraphicsLayer.js";import{isDOMContainer as A}from"../../views/DOMContainer.js";import{isSupportedGraphicResultMessage as k}from"../../views/3d/interactive/editingTools/isSupportedGraphicUtils.js";import{isSupportedGraphic as M}from"../../views/3d/interactive/editingTools/moveGraphic/isSupportedGraphic.js";import{isSupportedGraphic as P}from"../../views/3d/interactive/editingTools/reshapeGraphic/isSupportedGraphic.js";import{isSupportedGraphic as H}from"../../views/3d/interactive/editingTools/transformGraphic/isSupportedGraphic.js";import D from"../../views/draw/Draw.js";import R from"../../views/draw/DrawAction.js";import{loadCreateUtils as L}from"../../views/draw/support/createUtilsAsync.js";import{addUniqueLayer as U}from"../../views/draw/support/layerUtils.js";import{ViewEventPriorities as F}from"../../views/input/InputManager.js";import{SKETCH_KEYS as j}from"../../views/interactive/keybindings.js";import{SnappingManager as V}from"../../views/interactive/snapping/SnappingManager.js";import W from"../../views/interactive/snapping/SnappingOptions.js";import{createScreenPointFromEvent as K}from"../../views/support/screenUtils.js";import{OperationHandle as Z}from"./support/OperationHandle.js";import q from"../../symbols/SimpleMarkerSymbol.js";import z from"../../symbols/SimpleFillSymbol.js";import N from"../../symbols/CIMSymbol.js";import B from"../../symbols/SimpleLineSymbol.js";import $ from"../../geometry/Point.js";const Y="esri.widgets.Sketch.SketchViewModel",J=n.getLogger(Y),Q={defaultZ:0},X={reshapeOptions:{edgeOperation:"split",shapeOperation:"move",vertexOperation:"move"},enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,enableZ:!0,tool:"transform"};let ee=class extends r.EventedAccessor{constructor(e){super(e),this._activeFillGraphic=null,this._activeLineGraphic=null,this._centerIndicatorGraphic=null,this._centerSymbol=new q({style:"cross",size:6,color:[255,255,255]}),this._defaultSegmentOffset=48,this._numUpdating=0,this._handles=new s,this._internalGraphicsLayer=new O({listMode:"hide",internal:!0,title:"SVM Internal"}),this._lineGraphic=null,this._operationHandle=null,this._vertexGraphics=[],this._viewHandles=new s,this._doUnnormalization=!1,this.activeFillSymbol=new z({style:"solid",color:[150,150,150,.2],outline:{color:[50,50,50],width:0}}),this.activeLineSymbol=new N({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",effects:[{type:"CIMGeometricEffectDashes",dashTemplate:[3.75,3.75],lineDashEnding:"HalfPattern",controlPointEnding:"NoConstraint"}],enable:!0,capStyle:"Butt",joinStyle:"Round",miterLimit:10,width:1.6,color:[255,255,255,255]},{type:"CIMSolidStroke",enable:!0,capStyle:"Butt",joinStyle:"Round",miterLimit:10,width:2,color:[0,0,0,255]}]}}}),this.activeVertexSymbol=new q({style:"circle",size:6,color:[255,127,0,1],outline:{color:[50,50,50],width:1}}),this.allowDeleteKey=!0,this.layer=null,this.pointSymbol=new q({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.polygonSymbol=new z({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),this.polylineSymbol=new B({color:[130,130,130,1],width:2}),this._snappingManager=null,this.updateGraphics=new o,this.updateOnGraphicClick=!0,this.updatePointSymbol=new q({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),this.updatePolygonSymbol=new z({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),this.updatePolylineSymbol=new B({color:[12,207,255],width:2}),this.vertexSymbol=new q({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this._moduleLoaderAbortController=null,this._viewReadyAbortController=null,this._originalAutoOpenEnabled=null,this.defaultCreateOptions=Q,this.defaultUpdateOptions=X,this.snappingOptions=new W}initialize(){this._handles.add([G(this,"layer",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=p(this.layer)?this.layer.elevationInfo:null})),w(this,"view.map.layers","change",(e=>{e.removed.includes(this.layer)&&this.cancel()})),w(this,"layer.graphics","change",(e=>{if(p(this._operationHandle))for(const t of e.removed)this.updateGraphics.includes(t)&&(this.updateGraphics.length>1?this._operationHandle.removeFromSelection(t):this._operationHandle.cancel())})),f(this,"layer.elevationInfo",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=p(this.layer)?this.layer.elevationInfo:null}),!0),f(this,"view",(e=>{c(this._snappingManager),e&&(this._snappingManager=new V({view:e,options:this.snappingOptions}),"3d"===e.type&&(import("../../views/3d/interactive/editingTools.js"),import("../../views/3d/layers/GraphicsLayerView3D.js")))}),!0)])}destroy(){this.cancel(),this._handles=c(this._handles),this._viewHandles=c(this._viewHandles),this._removeDefaultLayer(),c(this._draw),c(this._snappingManager),this._set("view",null),this.emit("destroy")}get _defaultUpdateTool(){return"3d"===this.view.type?"move":"transform"}get _draw(){return"ready"===this.state||"active"===this.state?new D({view:this.view}):null}get updating(){return this._numUpdating>0}get activeTool(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null}get activeComponent(){return this._operationHandle?this._operationHandle.activeComponent:null}get createGraphic(){return this.view&&"3d"===this.view.type&&p(this.activeComponent)&&"draw-3d"===this.activeComponent.type?h(this.activeComponent.createGraphic):this._get("createGraphic")}set defaultCreateOptions(e){this._set("defaultCreateOptions",{...Q,...e})}set defaultUpdateOptions(e){this._set("defaultUpdateOptions",{...X,...e,reshapeOptions:{...X.reshapeOptions,...null==e?void 0:e.reshapeOptions}})}set snappingOptions(e){p(this._snappingManager)&&(this._snappingManager.options=e),this._set("snappingOptions",e)}get state(){var e;const t=!(null==(e=this.view)||!e.ready||!this.layer),i=this._operationHandle;return t&&i?"active":t?"ready":"disabled"}get view(){return this._get("view")}set view(e){const t=this._get("view");if(t){const{container:e,map:i}=t;e&&(t.cursor=null),i&&i.remove(this._internalGraphicsLayer),this._viewHandles.removeAll(),this.cancel()}this._doUnnormalization=null!=e&&"3d"===e.type&&"global"===e.viewingMode;const i="view-ready";this._handles.remove(i),e&&this._handles.add(b(e,"ready",(t=>{this._viewHandles.removeAll(),t&&this._viewHandles.add(this._generateViewHandles(e))}),!0),i),this._set("view",e)}cancel(){this._moduleLoaderAbortController=l(this._moduleLoaderAbortController),this._viewReadyAbortController=l(this._viewReadyAbortController),this._operationHandle&&this._operationHandle.cancel()}complete(){this._operationHandle&&this._operationHandle.complete()}delete(){const{state:e,updateGraphics:t}=this;if("active"===e&&t.length){const{activeTool:e,layer:i}=this,o=t.toArray();i.removeMany(o),this.cancel(),this._emitDeleteEvent({graphics:o,tool:e})}}async create(e,t){if(await this._waitViewReady(),"disabled"===this.state)throw this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),y();if(this.cancel(),this.view.activeTool=null,!e)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");const i=await this._setupCreateOperation(e,t);if(d(i)||this.destroyed)return;let o=null;"2d"===this.view.type&&(o=this.view.map.layers.findIndex((e=>e.id===R.SNAPPING_GRAPHICS_LAYER_ID)),o=o>-1?o:null),U(this.view,this._internalGraphicsLayer,o);const a=()=>{if(i===this._operationHandle){const t=this.createGraphic,o=this._operationHandle.cancelled;this._operationHandle.destroy(),this._operationHandle=null,this._set("createGraphic",null),this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),i.cancelled||null==t||this.layer.add(t),this.emit("create",{graphic:t,state:o?"cancel":"complete",tool:e,toolEventInfo:null,type:"create"})}};i.on("complete",a),this._operationHandle=i,this.view.ready&&A(this.view)&&this.view.focus()}async update(e,t){await this._waitViewReady();const{layer:i,view:o,state:a}=this;if("disabled"===a)throw o||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),i||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),y();this.cancel(),this.view.activeTool=null;const r=Array.isArray(e)?e:[e];if(null==e||!r||!r.length)return void this._logError("sketch:missing-parameter","Missing parameter 'graphics'.");if(r.some((e=>e.layer!==i?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):d(e.geometry)?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0):"2d"===o.type&&!o.spatialReference.equals(e.geometry.spatialReference)&&(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with a spatial reference different from the supplied IMapView."),!0))))return;const s=await this._setupUpdateOperation(r,t);this.destroyed||d(s)||re(s)||(U(this.view,this._internalGraphicsLayer),this._setUpdateOperationHandle(s,t),this.emit("update",{graphics:r,state:"start",aborted:!1,tool:s.tool,toolEventInfo:null,type:"update"}))}undo(){this.canUndo()&&this._operationHandle.undo()}redo(){this.canRedo()&&this._operationHandle.redo()}canUndo(){return!(!this._operationHandle||!this._operationHandle.canUndo())}canRedo(){return!(!this._operationHandle||!this._operationHandle.canRedo())}toggleUpdateTool(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()}async _getFirstHit(e){const t=[];switch(this.view.type){case"2d":{const a=await this.view.hitTest(e);if(a.results.length>0){const e=a.results[0];if(e.graphic){var i,o;const a=e.graphic;"vector-tile"!==(null==(i=a.layer)?void 0:i.type)&&"imagery"!==(null==(o=a.layer)?void 0:o.type)&&t.push(e)}}}break;case"3d":{const i=[this.view.map.ground];this.view.map.allLayers.forEach((e=>{"integrated-mesh"===e.type&&i.push(e)}));const o=await this.view.hitTest(e,{exclude:i});if(o.results.length>0){const e=o.results[0];(!o.ground.mapPoint||this.view.map.ground.opacity<1||o.ground.distance-e.distance>-Math.min(3*o.ground.distance,"global"===this.view.viewingMode?I(this.view.renderCoordsHelper.spatialReference).radius/this.view.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY))&&t.push(e)}}}return{screenPoint:e,results:t}}_generateViewHandles(e){return[e.on("immediate-click",(async t=>{const i="active"===this.state&&"create"===this._operationHandle.type;if("disabled"===this.state||i||!this.updateOnGraphicClick)return;this._beginAsyncOperation();const o=(await t.async((()=>this._getFirstHit(K(t))))).results;let a=null;if(o.length){for(const r of o)if(r.graphic){const i=r.graphic;if(this.updateGraphics.includes(i)||i.layer===this.layer){t.stopPropagation(),a=i;break}"2d"!==e.type||this._isComponentGraphic(i)||"active"!==this.state||this.cancel()}}else"active"===this.state&&this.cancel();p(a)&&!this.updateGraphics.includes(a)&&await this.update([a],{...this.defaultUpdateOptions,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions}}),this._endAsyncOperation()}),F.WIDGET)]}async _setupCreateOperation(e,t){if(!e)return null;const i={hasZ:"3d"===this.view.type,...this.defaultCreateOptions,...t};let o;if("2d"===this.view.type)switch(e){case"point":o=this._setupCreatePointOperation(e,i);break;case"multipoint":o=await this._setupCreateMultipointOperation(e,i);break;case"polygon":case"polyline":o=await this._setupCreatePolyOperation(e,i);break;case"rectangle":o=await this._setupCreateRectangleOperation(e,i);break;case"circle":o=await this._setupCreateCircleOperation(e,i)}else{const t=await this._setupCreate3DOperation(e,this.view,i);if(d(t)||re(t))return null;o=t}return o}async _setupCreate3DOperation(e,t,i){if("multipoint"===e)return null;this._removeCreateOperationGraphics();const o="rectangle"!==e,a="rectangle"!==e;this.snappingOptions.enabledToggled=!1;const r=await this._requireModule(import("../../views/3d/interactive/editingTools.js"));if(re(r))return r;if(this.destroyed)return null;const s=new r.module.DrawGraphicTool({view:t,mode:"rectangle"===e||"circle"===e?"hybrid":"click",...i,elevationInfo:this.layer.elevationInfo,geometryType:e,createGraphicSymbol:this._getGraphicSymbolFromTool(e),snapToScene:!p(this.layer.elevationInfo)||"absolute-height"===this.layer.elevationInfo.mode,snappingManager:this._snappingManager,forceUniformSize:a,centered:o});this.view.tools.add(s);let n=null;this.view.activeTool=s;const c=[this.view.on("key-down",(t=>{if(t.key===j.pan)t.stopPropagation(),t.repeat||(s.enabled=!1);else if(t.key===j.complete)t.stopPropagation(),s.completeCreateOperation();else if(t.key!==j.vertexAdd||t.repeat)t.key===j.undo?(t.stopPropagation(),l.undo()):t.key===j.redo?(t.stopPropagation(),l.redo()):t.key!==j.snappingToggle||"rectangle"===e||"circle"===e||t.repeat?t.key!==j.constraint||"rectangle"!==e&&"circle"!==e||t.repeat?t.key===j.center&&(t.repeat||(s.centered=!o,t.stopPropagation())):(s.forceUniformSize=!a,t.stopPropagation()):(this.snappingOptions.enabledToggled=!0,t.stopPropagation());else{const e=s.drawOperation.geometryType;"polyline"!==e&&"polygon"!==e||(t.stopPropagation(),s.drawOperation.commitStagedVertex())}}),F.WIDGET),this.view.on("key-up",(t=>{t.key===j.pan?s.enabled=!0:t.key===j.snappingToggle&&"rectangle"!==e&&"circle"!==e?(this.snappingOptions.enabledToggled=!1,t.stopPropagation()):t.key!==j.constraint||"rectangle"!==e&&"circle"!==e?t.key===j.center&&(s.centered=o,t.stopPropagation()):(s.forceUniformSize=a,t.stopPropagation())}),F.WIDGET),s.on("vertex-add",(t=>{switch(n=d(n)?"start":"active",t.operation){case"apply":this.emit("create",{graphic:h(s.createGraphic),state:n,tool:this.activeTool,toolEventInfo:t,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[h(s.createGraphic)],tool:e});break;case"redo":this._emitRedoEvent({graphics:[h(s.createGraphic)],tool:e})}})),s.on("cursor-update",(e=>{s.drawOperation.numCommittedVertices>0&&this.emit("create",{graphic:h(s.createGraphic),state:"active",tool:this.activeTool,toolEventInfo:{coordinates:e.vertices[0].coordinates,type:"cursor-update"},type:"create"})})),s.on("vertex-remove",(t=>{switch(t.operation){case"apply":this.emit("create",{graphic:h(s.createGraphic),state:"active",tool:this.activeTool,toolEventInfo:t,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[h(s.createGraphic)],tool:e});break;case"redo":this._emitRedoEvent({graphics:[h(s.createGraphic)],tool:e})}})),s.on("complete",(e=>{this._removeCreateOperationGraphics(),this._set("createGraphic",h(e.graphic)),n="complete",e.aborted?l&&l.cancel():l&&l.complete()}))],l=new Z({activeComponent:s,tool:e,type:"update",onEnd:()=>{var e;c.forEach((e=>e.remove())),c.length=0,null==(e=this.view.tools)||e.remove(s),s.destroy()},undo:()=>{s.canUndo&&s.undo()},redo:()=>{s.canRedo&&s.redo()},canUndo:()=>s.canUndo,canRedo:()=>s.canRedo});return l}_getGraphicSymbolFromTool(e){switch(e){case"point":return this.pointSymbol;case"polyline":return this.polylineSymbol;case"circle":case"rectangle":case"polygon":return this.polygonSymbol;default:return null}}_setupCreatePointOperation(e,i){const o={elevationInfo:this.layer.elevationInfo,hasZ:i.hasZ,defaultZ:i.defaultZ,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},a=this._draw.create(e,o),r=[a.on("cursor-update",(e=>{p(e.vertexIndex)?this._displayCrosshairCursor():this._displayDefaultCursor()})),a.on("draw-complete",(e=>{const i=this.createPointFromVertex(e.vertices[0]),o=new t(i,this.pointSymbol);this._set("createGraphic",o),n&&n.complete()}))],s=[this.view.on("key-down",(e=>{e.key===j.cancel&&(n&&n.cancel(),e.stopPropagation())}),F.WIDGET)],n=this._operationHandleForCreateAction(a,[...r,...s],e);return n}async _setupCreateMultipointOperation(e,t){const i=await L(),o={...t,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},a=this._draw.create(e,o);let r=null;const s=[],n=this._operationHandleForCreateAction(a,s,e);return s.push(a.on("vertex-add",(t=>{const{type:o,vertexIndex:a,vertices:s}=t,n=s[a];r=t,this._drawMultipointGraphic(i,s,!0),this.emit("create",{graphic:this.createGraphic,state:1===s.length?"start":"active",tool:e,toolEventInfo:{added:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:a}],type:o},type:"create"})})),a.on("vertex-remove",(t=>{const{type:o,vertexIndex:a,vertices:s}=t,n=s[a];r=t,this._drawMultipointGraphic(i,s,!0),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{removed:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:a}],type:o},type:"create"})})),a.on("vertex-update",(t=>{const{type:o,vertexIndex:a,vertices:s}=t,n=s[a];r=t,this._drawMultipointGraphic(i,s,!0),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{type:o,updated:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:a}]},type:"create"})})),a.on("cursor-update",(e=>{r=e})),a.on("draw-complete",(e=>{const t=e.vertices.slice(0),o=i.createMultipoint(t,this.view.spatialReference);o&&this.createGraphic&&(this.createGraphic.geometry=o),n&&n.complete()})),a.on("undo",(e=>{const t=e.vertices,o=r&&"cursor-update"!==r.type;this._resetCreateOperationGraphics(),t.length&&this._drawMultipointGraphic(i,t,o)})),a.on("redo",(e=>{const t=e.vertices,o=r&&"cursor-update"!==r.type;this._resetCreateOperationGraphics(),t.length&&this._drawMultipointGraphic(i,t,o)}))),s.push(this.view.on("pointer-move",(()=>this._displayCrosshairCursor()),F.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(n,e)),F.WIDGET)),n}async _setupCreatePolyOperation(e,t){const i=await L(),o={...t,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0};let a=null;("polyline"===e||"polygon"===e)&&(a=this._draw.create(e,o));let r=null;const s=[a.on("vertex-add",(t=>{const{type:o,vertexIndex:a,vertices:s}=t,n=s[a];this._snapLastPolygonVertexToFirst(e,s),r=t,this._drawVertexGraphics(i,e,s,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:1===s.length?"start":"active",tool:e,toolEventInfo:{added:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:a}],type:o},type:"create"})})),a.on("vertex-remove",(t=>{const{type:o,vertexIndex:a,vertices:s}=t,n=s[a];this._snapLastPolygonVertexToFirst(e,s),r=t,this._drawVertexGraphics(i,e,s,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{removed:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:a}],type:o},type:"create"})})),a.on("vertex-update",(t=>{const{type:o,vertexIndex:a,vertices:s}=t,n=s[a];this._snapLastPolygonVertexToFirst(e,s),r=t,this._drawVertexGraphics(i,e,s,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{type:o,updated:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:a}]},type:"create"})})),a.on("cursor-update",(t=>{const{type:o,vertices:a}=t;if(t.mapPoint&&(this._snapLastPolygonVertexToFirst(e,a),r=t,this._drawVertexGraphics(i,e,a,{userClicked:!1}),a.length>1)){const t=a[a.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:o},type:"create"})}})),a.on("draw-complete",(t=>{const o=t.vertices.slice(0);let a=null;"polyline"===e?a=i.createPolyline([o],this.view.spatialReference,this._doUnnormalization):"polygon"===e&&(a=i.createPolygon([o],this.view.spatialReference,this._doUnnormalization,!0)),a&&(this.createGraphic.geometry=a),c&&c.complete()})),a.on("undo",(t=>{const o=t.vertices,a=r&&"cursor-update"!==r.type;this._resetCreateOperationGraphics(),this._snapLastPolygonVertexToFirst(e,o),o.length&&this._drawVertexGraphics(i,e,o,{userClicked:a})})),a.on("redo",(t=>{const o=t.vertices,a=r&&"cursor-update"!==r.type;this._resetCreateOperationGraphics(),this._snapLastPolygonVertexToFirst(e,o),o.length&&this._drawVertexGraphics(i,e,o,{userClicked:a})}))],n=[this.view.on("pointer-move",(e=>{p(a.getCoordsFromScreenPoint(g(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()}),F.WIDGET),this.view.on("key-down",(e=>{e.key!==j.snappingToggle||e.repeat?e.key===j.undo&&c&&c.canUndo()?(e.stopPropagation(),c.undo()):e.key===j.redo&&c&&c.canRedo()?(e.stopPropagation(),c.redo()):e.key===j.cancel&&c&&c.cancel():(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),F.WIDGET),this.view.on("key-up",(e=>{e.key===j.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),F.WIDGET)];if("polygon"===e){const e=(e,t,i)=>{if(!e||!e.layer||!e.visible)return!1;const o=this.view.toScreen(e.geometry);return this._isWithinScreenDistance(o,t,i)},t=t=>{if(!(this._vertexGraphics.length<=2))return e(this._vertexGraphics[0],t,this._getVertexIntersectDistance())};let i=!1;n.push(this.view.on("pointer-move",(()=>{i=!1}),F.WIDGET),this.view.on("pointer-down",(o=>{if(t(o))return i=!0,void o.stopPropagation();this._vertexGraphics.some((t=>e(t,o,this._getVertexIntersectDistance())))&&o.stopPropagation()}),F.WIDGET),this.view.on("pointer-up",(e=>{i&&(e.stopPropagation(),a.complete())})))}const c=this._operationHandleForCreateAction(a,[...s,...n],e);return c}async _setupCreateCircleOperation(e,i){const o=await L(),a={...i,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},r=this._draw.create(e,a);let s=!1,n=!0;const c=[r.on("vertex-add",(t=>{const{type:i,vertexIndex:a,vertices:p}=t,c=p[a];this._drawSegmentGraphic(o,e,p,{centered:n,constrainToggle:s},r.viewAlignedCoordinateSystem),this.emit("create",{graphic:this.createGraphic,state:1===p.length?"start":"active",tool:e,toolEventInfo:{added:c,vertices:[{coordinates:c,componentIndex:0,vertexIndex:a}],type:i},type:"create"})})),r.on("cursor-update",(t=>{const{type:i,vertices:a}=t;if(this._drawSegmentGraphic(o,e,a,{centered:n,constrainToggle:s},r.viewAlignedCoordinateSystem),2===a.length){const t=a[a.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:i},type:"create"})}})),r.on("draw-complete",(e=>{const i=e.vertices.slice(0);let a;1===i.length?(i.push(r.viewAlignedCoordinateSystem.makeMapPoint(i[0][0]+this._defaultSegmentOffset*this.view.resolution,i[0][1])),a=o.createCircle(i,r.viewAlignedCoordinateSystem,!0,this.view.resolution)):a=s?o.createEllipse(i,r.viewAlignedCoordinateSystem,n):o.createCircle(i,r.viewAlignedCoordinateSystem,n,this.view.resolution),this.createGraphic?this.createGraphic.geometry=a:(this._removeCreateGraphic(),this._set("createGraphic",new t(a,this.polygonSymbol))),l&&l.complete()}))],h=[this.view.on("pointer-move",(e=>{p(r.getCoordsFromScreenPoint(g(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()}),F.WIDGET),this.view.on("key-down",(t=>{t.key===j.constraint?s||(s=!0,this._drawSegmentGraphic(o,e,r.vertices,{centered:n,constrainToggle:s},r.viewAlignedCoordinateSystem)):t.key===j.center?n&&(n=!1,this._drawSegmentGraphic(o,e,r.vertices,{centered:n,constrainToggle:s},r.viewAlignedCoordinateSystem)):t.key===j.cancel&&l&&l.cancel()}),F.WIDGET),this.view.on("key-up",(t=>{t.key===j.constraint?(s=!1,this._drawSegmentGraphic(o,e,r.vertices,{centered:n,constrainToggle:s},r.viewAlignedCoordinateSystem)):t.key===j.center&&(n=!0,this._drawSegmentGraphic(o,e,r.vertices,{centered:n,constrainToggle:s},r.viewAlignedCoordinateSystem))}),F.WIDGET)],l=this._operationHandleForCreateAction(r,[...c,...h],e);return l}async _setupCreateRectangleOperation(e,i){const o=await L(),a={...i,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},r=this._draw.create(e,a);let s=!1,n=!1;const c=[r.on("vertex-add",(t=>{const{type:i,vertexIndex:a,vertices:p}=t,c=p[a];this._drawSegmentGraphic(o,e,p,{centered:n,constrainToggle:s},r.viewAlignedCoordinateSystem),this.emit("create",{graphic:this.createGraphic,state:1===p.length?"start":"active",tool:e,toolEventInfo:{added:c,vertices:[{coordinates:c,componentIndex:0,vertexIndex:a}],type:i},type:"create"})})),r.on("cursor-update",(t=>{const{type:i,vertices:a}=t;if(this._drawSegmentGraphic(o,e,a,{centered:n,constrainToggle:s},r.viewAlignedCoordinateSystem),2===a.length){const t=a[a.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:i},type:"create"})}})),r.on("draw-complete",(e=>{const i=e.vertices.slice(0);let a=null;1===i.length&&(s=!1,n=!1),a=s?o.createSquare(i,r.viewAlignedCoordinateSystem,n):o.createRectangle(i,r.viewAlignedCoordinateSystem,n),this.createGraphic?this.createGraphic.geometry=a:(this._removeCreateGraphic(),this._set("createGraphic",new t(a,this.polygonSymbol))),l&&l.complete()}))],h=[this.view.on("pointer-move",(e=>{p(r.getCoordsFromScreenPoint(g(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()}),F.WIDGET),this.view.on("key-down",(t=>{t.key===j.constraint?s||(s=!0,this._drawSegmentGraphic(o,e,r.vertices,{centered:n,constrainToggle:s},r.viewAlignedCoordinateSystem)):t.key===j.center?n||(n=!0,this._drawSegmentGraphic(o,e,r.vertices,{centered:n,constrainToggle:s},r.viewAlignedCoordinateSystem)):t.key===j.cancel&&l&&l.cancel()}),F.WIDGET),this.view.on("key-up",(t=>{t.key===j.constraint?(s=!1,this._drawSegmentGraphic(o,e,r.vertices,{centered:n,constrainToggle:s},r.viewAlignedCoordinateSystem)):t.key===j.center&&(n=!1,this._drawSegmentGraphic(o,e,r.vertices,{centered:n,constrainToggle:s},r.viewAlignedCoordinateSystem))}),F.WIDGET)],l=this._operationHandleForCreateAction(r,[...c,...h],e);return l}async _setupUpdateOperation(e,t){const{layer:i,view:o}=this,a={tool:this._defaultUpdateTool,...this.defaultUpdateOptions,...t,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions,...null==t?void 0:t.reshapeOptions}},r=a.tool;for(const s of e)i.remove(s),i.add(s);if("3d"===o.type){if(0===e.length)return null;switch(r){case"move":return this._setupMove3DOperation(e,a,o,r);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const t=P(e[0]);return 0===t?this._setupReshape3DOperation(e[0],a,o):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${k(t)}).`),null)}case"transform":return this._setupGraphicTransform3DOperation(e,a,o)}}switch(r){case"move":return this._setupMoveOperation(e,a,o);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const t=P(e[0]);return 0===t?this._setupTransformOrReshapeOperation(e,r,a,o):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${k(t)}).`),null)}case"transform":return this._setupTransformOrReshapeOperation(e,1===e.length&&"point"===v(e[0].geometry,"type")?"reshape":r,a,o)}}async _setupMove3DOperation(e,t,i,o,a=!1){for(const c of e){const e=M(c);if(0!==e)return this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${k(e)}).`),null}const r=await this._requireModule(import("../../views/3d/interactive/editingTools.js"));if(re(r))return r;const s=new r.module.GraphicMoveTool({view:i,enableZ:t.enableZ,snappingManager:this._snappingManager});this.view.tools.add(s),s.graphics.addMany(e),a||this.updateGraphics.addMany(e);const n=[],p=new Z({activeComponent:s,tool:o,type:"update",onEnd:()=>{var e;n.forEach((e=>e.remove())),n.length=0,null==(e=this.view.tools)||e.remove(s),s.destroyed||s.destroy()},undo:()=>{te(p,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:o})},redo:()=>{ie(p,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:o})},addToSelection:e=>{this.updateGraphics.push(e),s.graphics.push(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);p.history.undo.forEach((e=>e.updates.splice(t,1))),p.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?s.graphics.remove(e):p.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===t.toggleToolOnClick)return;if("transform"!==o)return;const e=this.updateGraphics.getItemAt(0);if(0!==P(e))return;const a=await this._setupReshape3DOperation(e,t,i,!0);re(a)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(a,t))}});return n.push(...this._getHandlesForComponent(p,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(p,e,t)),F.WIDGET),i.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(p,e),e.key===j.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),F.WIDGET),i.on("key-up",(e=>{e.key===j.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),F.WIDGET)),p}_setupGraphicTransform3DOperation(e,t,i,o=!1){if(1===e.length&&0===H(e[0])){const a=e[0],r=a.geometry;if(p(r)&&("point"===r.type||"mesh"===r.type))return this._setupPointTransform3DOperation(a,t,i);if(p(r)&&("polygon"===r.type||"polyline"===r.type))return this._setupPolyTransform3DOperation(a,t,i,o)}return this._setupMove3DOperation(e,t,i,"transform",o)}async _setupPointTransform3DOperation(e,t,i){const o="transform",{enableRotation:a,enableScaling:r,enableZ:s}=t,n=await this._requireModule(import("../../views/3d/interactive/editingTools.js"));if(re(n))return n;const p=new n.module.GraphicTransformTool({graphic:e,view:i,enableRotation:a,enableScaling:r,enableZ:s,snappingManager:this._snappingManager});this.view.tools.add(p),this.updateGraphics.add(e);const c=[],h=new Z({activeComponent:p,tool:o,type:"update",onEnd:()=>{var e;c.forEach((e=>e.remove())),c.length=0,null==(e=this.view.tools)||e.remove(p),p.destroyed||p.destroy()},undo:()=>{te(h,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:o})},redo:()=>{ie(h,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:o})},addToSelection:async e=>{this.updateGraphics.add(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const o=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,i,"transform",!0);re(o)||(h.onEnd(),h.destroy(),this._setUpdateOperationHandle(o,t))},removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),h.complete()},toggleTool:()=>{}});return c.push(...this._getHandlesForComponent(h,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(h,e,t)),F.WIDGET),i.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(h,e),e.key===j.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),F.WIDGET),i.on("key-up",(e=>{e.key===j.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),F.WIDGET)),h}async _setupPolyTransform3DOperation(e,t,i,o=!1){const a="transform",{enableRotation:r,enableScaling:s,enableZ:n,preserveAspectRatio:p}=t,c=await this._requireModule(import("../../views/3d/interactive/editingTools.js"));if(re(c))return c;const h=new c.module.ExtentTransformTool({graphic:e,view:i,enableRotation:r,enableScaling:s,enableZ:n,preserveAspectRatio:p});this.view.tools.add(h),o||this.updateGraphics.add(e);const l=[],d=new Z({activeComponent:h,tool:a,type:"update",onEnd:()=>{var e;l.forEach((e=>e.remove())),l.length=0,null==(e=this.view.tools)||e.remove(h),h.destroyed||h.destroy()},canUndo:()=>h.canUndo,undo:()=>{h.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:a})},canRedo:()=>h.canRedo,redo:()=>{h.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:a})},addToSelection:async e=>{this.updateGraphics.add(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const o=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,i,"transform",!0);re(o)||(d.onEnd(),d.destroy(),this._setUpdateOperationHandle(o,t))},removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),d.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===t.toggleToolOnClick)return;const e=this.updateGraphics.getItemAt(0);if(0!==P(e))return;const o=await this._setupReshape3DOperation(e,t,i,!0);re(o)||(d.onEnd(),d.destroy(),this._setUpdateOperationHandle(o,t))}});return l.push(...this._getHandlesForComponent(d,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(d,e,t)),F.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(d,e)),F.WIDGET),this.view.on("key-down",(e=>{e.key!==j.constraint||e.repeat||(h.preserveAspectRatio=!h.preserveAspectRatio,e.stopPropagation())}),F.WIDGET),this.view.on("key-up",(e=>{e.key===j.constraint&&(h.preserveAspectRatio=!h.preserveAspectRatio,e.stopPropagation())}),F.WIDGET)),d}async _setupMoveOperation(e,t,i){const o="move";this.updateGraphics.addMany(e);const a=await this._getGraphicMover(e,t,i);if(re(a))return a;const r=new Z({activeComponent:a,tool:o,type:"update",onEnd:()=>{var e;this._displayDefaultCursor(),p.forEach((e=>e.remove())),n.forEach((e=>e.remove())),p=[],n=[],a.destroy(),null==(e=this._internalGraphicsLayer)||e.removeMany([...this.updateGraphics.toArray()])},undo:()=>{const e=this.updateGraphics.toArray();te(r,e),r.refreshComponent(),this._emitUndoEvent({graphics:e,tool:o})},redo:()=>{const e=this.updateGraphics.toArray();ie(r,e),r.refreshComponent(),this._emitRedoEvent({graphics:e,tool:o})},addToSelection:e=>{this.updateGraphics.push(e),a.graphics=this.updateGraphics.toArray(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);r.history.undo.forEach((e=>e.updates.splice(t,1))),r.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e);const i=this.updateGraphics.toArray();this.emit("update",{graphics:i,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?a.graphics=i:r.complete()}});let s=!1,n=[i.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(r,e,t)),F.WIDGET),i.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(r,e),e.key!==j.constraint||e.repeat||(s=!0,a.enableMoveAllGraphics=!a.enableMoveAllGraphics)}),F.WIDGET),i.on("key-up",(e=>{e.key===j.constraint&&s&&(s=!1,a.enableMoveAllGraphics=!a.enableMoveAllGraphics)}),F.WIDGET)],p=this._getHandlesForComponent(r,t);return r}async _setupReshape3DOperation(e,t,i,o=!1){const a="reshape",r=await this._requireModule(import("../../views/3d/interactive/editingTools.js"));if(re(r))return r;this.snappingOptions.enabledToggled=!1;const s=new r.module.GraphicReshapeTool({view:i,graphic:e,enableZVertex:t.enableZ&&"move"===t.reshapeOptions.vertexOperation,enableZShape:t.enableZ&&"move"===t.reshapeOptions.shapeOperation,enableMoveGraphic:"move"===t.reshapeOptions.shapeOperation||"move-xy"===t.reshapeOptions.shapeOperation,enableMidpoints:"split"===t.reshapeOptions.edgeOperation,enableEdgeOffset:"offset"===t.reshapeOptions.edgeOperation,snappingManager:this._snappingManager});i.tools.add(s),o||this.updateGraphics.add(e);const n=[],p=new Z({activeComponent:s,tool:a,type:"update",onEnd:()=>{var e;n.forEach((e=>e.remove())),n.length=0,null==(e=this.view.tools)||e.remove(s),s.destroyed||s.destroy()},canUndo:()=>s.canUndo,undo:()=>{s.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:a})},canRedo:()=>s.canRedo,redo:()=>{s.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:a})},addToSelection:async e=>{this.updateGraphics.add(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const o=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,i,"transform",!0);re(o)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(o,t))},removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),p.complete()},toggleTool:async()=>{if(!1===t.toggleToolOnClick)return;const e=await this._setupGraphicTransform3DOperation(this.updateGraphics.toArray(),t,i,!0);re(e)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(e,t))}});return n.push(...this._getHandlesForComponent(p,t),i.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(p,e,t)),F.WIDGET),i.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(p,e),e.key===j.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),F.WIDGET),i.on("key-up",(e=>{e.key===j.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),F.WIDGET)),p}async _setupTransformOrReshapeOperation(e,t,i,o){const{multipleSelectionEnabled:a}=i;this.updateGraphics.addMany(e);const r="transform"===t?await this._getBox(e,i,o):await this._getReshape(e,i,o);if(re(r))return r;const s=new Z({activeComponent:r,type:"update",onEnd:()=>{c.forEach((e=>e.remove())),n.forEach((e=>e.remove())),c=[],n=[],s.activeComponent&&!s.activeComponent.destroyed&&s.activeComponent.destroy(),this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},undo:()=>{te(s,this.updateGraphics.toArray()),s.refreshComponent(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:s.tool})},redo:()=>{ie(s,this.updateGraphics.toArray()),s.refreshComponent(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:s.tool})},addToSelection:async e=>{let t=s.activeComponent;if("reshape"===t.type){const t=[...this.updateGraphics,e];this.updateGraphics.removeAll();const a=await this._setupMoveOperation(t,i,o);if(re(a))return;s.onEnd(),s.destroy(),this._setUpdateOperationHandle(a,i)}else this.updateGraphics.add(e),t=t,t.graphics=this.updateGraphics.toArray(),t.refresh(),s.resetHistory();this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:async e=>{const t=this.updateGraphics.indexOf(e);s.history.undo.forEach((e=>e.updates.splice(t,1))),s.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e);const i=this.updateGraphics.toArray();0===i.length?s.complete():1===i.length&&p(i[0].geometry)&&"point"===i[0].geometry.type?s.toggleTool():s.activeComponent.graphics=i,this.emit("update",{graphics:i,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"})},toggleTool:async()=>{if(this.updateGraphics.length>1)return;const e=this.updateGraphics.getItemAt(0);if(p(e.geometry)&&("transform"===s.tool&&"extent"===e.geometry.type||"reshape"===s.tool&&"point"===e.geometry.type))return;let t=null;"transform"===s.tool?t=await this._getReshape([e],i,o):"reshape"===s.tool&&(t=await this._getBox([e],i,o)),re(t)||(s.activeComponent.destroy(),s.activeComponent=t,s.activeComponent&&(c.forEach((e=>e.remove())),c=this._getHandlesForComponent(s,i)))}});let n=[o.on("immediate-click",(async e=>{var t;const i=await e.async((()=>this._getFirstHit(K(e))));null!=(t=i.results)&&t.length?i.results.some((t=>{if(t.graphic){var i;const o=t.graphic;if(null!=(i=e.native)&&i.shiftKey&&a)return e.stopPropagation(),s.addToSelection(o),!0;if(o.layer===this.layer)return s.complete(),!0}return!1})):s.complete()}),F.WIDGET),o.on("key-down",(e=>{if(this._getCommonUpdateOperationKeyDownHandlers(s,e),e.key!==j.snappingToggle||e.repeat||(this.snappingOptions.enabledToggled=!0,e.stopPropagation()),e.key===j.constraint&&!e.repeat&&s){const e=s.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),F.WIDGET),o.on("key-up",(e=>{var t;if(e.key===j.snappingToggle&&"reshape"===(null==s||null==(t=s.activeComponent)?void 0:t.type)&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation()),e.key===j.constraint&&s){const e=s.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),F.WIDGET)],c=this._getHandlesForComponent(s,i);return s}async _getGraphicMover(e,t,i){const{enableMoveAllGraphics:o}=t,a=await this._requireModule(import("../../views/draw/support/GraphicMover.js"));return re(a)?a:new a.module.default({enableMoveAllGraphics:o,graphics:e,view:i,callbacks:{onGraphicMoveStart:({dx:e,dy:t,graphic:i})=>{this._displayGrabbingCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move-start"},type:"update"})},onGraphicMove:({dx:e,dy:t,graphic:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move"},type:"update"}),onGraphicMoveStop:({dx:e,dy:t,graphic:i})=>{this._displayPointerCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayPointerCursor(),onGraphicPointerOut:()=>this._displayDefaultCursor()}})}async _getBox(e,t,i){const{enableRotation:o,enableScaling:a,preserveAspectRatio:r}=t,s=await this._requireModule(import("../../views/draw/support/Box.js"));return re(s)?s:new s.module.default({graphics:e,enableRotation:o,enableScaling:a,preserveAspectRatio:r,layer:this._internalGraphicsLayer,view:i,callbacks:{onMoveStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMove:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMoveStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScale:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotate:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"})}})}async _getReshape(e,t,i){var o,a;const r="split"===(null==(o=t.reshapeOptions)?void 0:o.edgeOperation),s="move"===(null==(a=t.reshapeOptions)?void 0:a.shapeOperation),n=await this._requireModule(import("../../views/draw/support/Reshape.js"));return re(n)?n:new n.module.default({enableMidpoints:r,enableMovement:s,graphic:e[0],layer:this._internalGraphicsLayer,snappingManager:this._snappingManager,view:i,callbacks:{onReshapeStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshape:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshapeStop:({mover:e,type:t})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e,type:t},type:"update"}),onMoveStart:({dx:e,dy:t,mover:i,type:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:o},type:"update"}),onMove:({dx:e,dy:t,mover:i,type:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:o},type:"update"}),onMoveStop:({dx:e,dy:t,mover:i,type:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:o},type:"update"}),onVertexAdd:({added:e,type:t,vertices:i})=>{const o=e.map((e=>x(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:o,vertices:i,type:t},type:"update"})},onVertexRemove:({removed:e,type:t,vertices:i})=>{const o=e.map((e=>x(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:o,vertices:i,type:t},type:"update"})}}})}_getHandlesForComponent(e,t){const i=e.activeComponent;switch(i.type){case"graphic-mover":return[i.on("graphic-click",(({graphic:t,viewEvent:i})=>{var o;null!=(o=i.native)&&o.shiftKey&&(i.stopPropagation(),e.removeFromSelection(t))})),i.on("graphic-move-start",(t=>e.addToHistory(ae(t.allGraphics))))];case"box":return[i.on("graphic-click",(i=>this._onTransformOrReshape2DGraphicClick(e,t,i))),i.on("move-start",(t=>e.addToHistory(ae(t.graphics)))),i.on("rotate-start",(t=>e.addToHistory(ae(t.graphics)))),i.on("scale-start",(t=>e.addToHistory(ae(t.graphics))))];case"reshape":return[i.on("graphic-click",(i=>this._onTransformOrReshape2DGraphicClick(e,t,i))),i.on("move-start",(t=>e.addToHistory(ae([t.mover])))),i.on("reshape-start",(t=>e.addToHistory(ae([t.graphic])))),i.on("vertex-add",(t=>e.addToHistory(ae([t.oldGraphic])))),i.on("vertex-remove",(t=>e.addToHistory(ae([t.oldGraphic]))))];case"move-3d":return[i.on("graphic-move-start",(t=>{e.addToHistory(ae(t.allGraphics)),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:t.allGraphics.length>0?t.allGraphics[0]:null,type:"move-start"},type:"update"})})),i.on("graphic-move",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e.dx,dy:e.dy,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move"},type:"update"})})),i.on("graphic-move-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move-stop"},type:"update"})})),i.on("immediate-click",(i=>{i.shiftKey?this._toggleSelection([i.graphic],e,t):e.toggleTool()}))];case"transform-3d":return[i.on("record-undo",(({record:t})=>{e.addToHistory({updates:[t]})})),i.on("graphic-translate-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-start"},type:"update"})})),i.on("graphic-translate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-stop"},type:"update"})})),i.on("graphic-rotate-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-start"},type:"update"})})),i.on("graphic-rotate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-stop"},type:"update"})})),i.on("graphic-scale-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale-start"},type:"update"})})),i.on("graphic-scale-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale-stop"},type:"update"})})),i.on("graphic-translate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move"},type:"update"})})),i.on("graphic-rotate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate"},type:"update"})})),i.on("graphic-scale",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale"},type:"update"})})),i.on("immediate-click",(i=>{i.shiftKey?this._toggleSelection([i.graphic],e,t):e.toggleTool()}))];case"reshape-3d":return[i.on("reshape",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),i.on("move",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),i.on("vertex-add",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),i.on("vertex-remove",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),i.on("immediate-click",(i=>{i.shiftKey?this._toggleSelection([i.graphic],e,t):e.toggleTool()}))];case"draw":case"draw-3d":return null;default:return}}_onTransformOrReshape2DGraphicClick(e,t,i){var o;const{graphic:a,viewEvent:r}=i;return null!=(o=r.native)&&o.shiftKey?(r.stopPropagation(),e.removeFromSelection(a)):t.toggleToolOnClick?(r.stopPropagation(),e.toggleTool()):void 0}_setUpdateOperationHandle(e,t){this._operationHandle=e;const i=this.view.map;this._disablePopup(t);const o=()=>{if(e===this._operationHandle){const o=this.updateGraphics.toArray(),a=this._operationHandle.tool;this._operationHandle.destroy(),this._operationHandle=null,this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray()),this.updateGraphics.removeAll(),i&&i.remove(this._internalGraphicsLayer),this._restorePopup(t),this.emit("update",{graphics:o,state:"complete",aborted:e.cancelled,tool:a,toolEventInfo:null,type:"update"})}};e.on("complete",o)}async _getCommonUpdateOperationClickHandlers(e,t,i){const o=K(t),a=(await t.async((()=>this._getFirstHit(o)))).results;if(!a.length)return void e.complete();if(t.native.shiftKey&&this._toggleSelection(a.map((e=>e.graphic)),e,i))return void t.stopPropagation();a.some((e=>e.graphic&&this.updateGraphics.includes(e.graphic)))?t.stopPropagation():e.complete()}_toggleSelection(e,t,i){const o=!!i.multipleSelectionEnabled;return e.some((e=>null!=e&&(!(!o||e.layer!==this.layer)&&(this.updateGraphics.includes(e)?t.removeFromSelection(e):t.addToSelection(e),!0))))}_getCommonUpdateOperationKeyDownHandlers(e,t){if(!e)return;const i=t.key;i===j.undo&&e.canUndo()?(t.stopPropagation(),e.undo()):i===j.redo&&e.canRedo()?(t.stopPropagation(),e.redo()):i===j.cancel?(t.stopPropagation(),e.cancel()):this.allowDeleteKey&&j.delete.includes(i)&&this._onDeleteKey(t)}_onDeleteKey(e){if(!this._operationHandle||"update"!==this._operationHandle.type)return;const t=this.activeComponent,i=this.updateGraphics.toArray();d(t)||"reshape-3d"===t.type||("reshape"!==t.type||1===i.length&&"point"===v(i[0].geometry,"type"))&&(e.stopPropagation(),this.delete())}_drawMultipointGraphic(e,i,o){let a=null;if(!o&&i.length>1){const t=i.slice(0);t.pop(),a=e.createMultipoint(t,this.view.spatialReference)}else a=e.createMultipoint(i,this.view.spatialReference);this.createGraphic?this.createGraphic.geometry=a:this._set("createGraphic",new t(a,this.pointSymbol)),o&&1===i.length&&this._internalGraphicsLayer.add(this.createGraphic)}_drawVertexGraphics(e,i,o,a){if(!o.length)return;const{_doUnnormalization:r,activeLineSymbol:s,activeVertexSymbol:n,polygonSymbol:p,polylineSymbol:c,vertexSymbol:h,view:{spatialReference:l}}=this,d=!(!a||!a.userClicked),v="polygon"===i,y=v?p:c;if(1===o.length){this._removeLineGraphic(),this._removeActiveLineGraphic();const i=this.createPointFromVertex(o[0]),a=v?e.createPolygon([o],l,r,!0):e.createPolyline([o],l,r);this._vertexGraphics.length?this._vertexGraphics[0].geometry=i:this._vertexGraphics.push(new t(i,n)),this.createGraphic?this.createGraphic.set({geometry:a,symbol:y}):this._set("createGraphic",new t(a,y)),d&&this._internalGraphicsLayer.add(this._vertexGraphics[0])}else if(2===o.length){const i=this.createPointFromVertex(o[1]),a=e.createPolyline([o],l,r),s=v?e.createPolygon([o],l,r,!0):e.createPolyline([o],l,r);if(!this._vertexGraphics.length){const e=this.createPointFromVertex(o[0]),i=new t(e,h);this._vertexGraphics.push(i)}if(1===this._vertexGraphics.length){const e=this._vertexGraphics[0],o=new t(i,h);this._removeLineGraphic(),this._removeActiveFillGraphic(),this._vertexGraphics.push(o),this._internalGraphicsLayer.remove(e),this._internalGraphicsLayer.add(e)}else this._vertexGraphics[1].geometry=i;this._showActiveLineGraphic(a);const n=this._vertexGraphics[0];d&&(this._activeLineGraphic.symbol=c,n.symbol=h,this._internalGraphicsLayer.add(this._vertexGraphics[1])),this.createGraphic?this.createGraphic.set({geometry:s,symbol:y}):this._set("createGraphic",new t(s,y)),this._internalGraphicsLayer.remove(n),this._internalGraphicsLayer.add(n)}else if(o.length>2){const a=v?e.createPolygon([o],l,r,!0):e.createPolyline([o],l,r);"polygon"===i&&this._showFillGraphic(a);const p=o.map((e=>e.slice())),u=p.pop(),m=[p[p.length-1],u],g=e.createPolyline([p],l,r),_=e.createPolyline([m],l,r);this._showLineGraphic(g),this._showActiveLineGraphic(_);for(let e=0;e<p.length;e++){const t=this._vertexGraphics[e];if(t)d||e!==this._vertexGraphics.length-1?t.symbol=h:t.symbol=n;else{const t=this.createPointFromVertex(o[e]);this._showVertexGraphic(t)}}if(d){this._activeLineGraphic.symbol=c;const e=o.length-1,t=this.createPointFromVertex(o[e]);this._showVertexGraphic(t)}else this._activeLineGraphic.symbol=s;this.createGraphic?this.createGraphic.set({geometry:a,symbol:y}):(this._removeCreateGraphic(),this._set("createGraphic",new t(a,y)));for(const e of this._vertexGraphics)this._internalGraphicsLayer.remove(e),this._internalGraphicsLayer.add(e)}}_drawSegmentGraphic(e,i,o,a,r){if(!o.length)return;const s=!(null==a||!a.centered),n=!(null==a||!a.constrainToggle);let c;1===o.length?this._removeCenterIndicatorGraphic():("rectangle"===i?c=n?e.createSquare(o,r,s):e.createRectangle(o,r,s):"circle"===i&&(c=n?e.createEllipse(o,r,s):e.createCircle(o,r,s,this.view.resolution)),p(c)&&c.extent&&c.extent.center&&this._showCenterIndicatorGraphic(c.extent.center)),c?this.createGraphic?this.createGraphic.geometry=c:(this._removeCreateGraphic(),this._set("createGraphic",new t(c,this.polygonSymbol)),this._internalGraphicsLayer.add(this.createGraphic)):this._removeCreateGraphic()}_showCenterIndicatorGraphic(e){this._centerIndicatorGraphic?this._centerIndicatorGraphic.geometry=e:(this._centerIndicatorGraphic=new t(e,this._centerSymbol),this._internalGraphicsLayer.add(this._centerIndicatorGraphic))}_removeCenterIndicatorGraphic(){this._centerIndicatorGraphic&&(this._internalGraphicsLayer.remove(this._centerIndicatorGraphic),this._centerIndicatorGraphic.destroy(),this._centerIndicatorGraphic=null)}_showActiveLineGraphic(e){this._activeLineGraphic?(this._activeLineGraphic.set({geometry:e,symbol:this.activeLineSymbol}),this._internalGraphicsLayer.remove(this._activeLineGraphic)):this._activeLineGraphic=new t(e,this.activeLineSymbol),this._internalGraphicsLayer.add(this._activeLineGraphic)}_showFillGraphic(e){this._activeFillGraphic?(this._activeFillGraphic.set({geometry:e,symbol:this.activeFillSymbol}),this._internalGraphicsLayer.remove(this._activeFillGraphic)):this._activeFillGraphic=new t(e,this.activeFillSymbol),this._internalGraphicsLayer.add(this._activeFillGraphic)}_showLineGraphic(e){this._lineGraphic?(this._lineGraphic.set({geometry:e,symbol:this.polylineSymbol}),this._internalGraphicsLayer.remove(this._lineGraphic)):this._lineGraphic=new t(e,this.polylineSymbol),this._internalGraphicsLayer.add(this._lineGraphic)}_showVertexGraphic(e,i){const o=i?this.activeVertexSymbol:this.vertexSymbol,a=new t(e,o);this._vertexGraphics.push(a),this._internalGraphicsLayer.add(a)}_resetCreateOperationGraphics(){this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeActiveLineGraphic(),this._removeVertexGraphics()}_removeCreateGraphic(){this.createGraphic&&(this._internalGraphicsLayer.remove(this.createGraphic),this._set("createGraphic",null))}_removeCreateOperationGraphics(){this._removeCenterIndicatorGraphic(),this._removeActiveLineGraphic(),this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeVertexGraphics()}_removeActiveLineGraphic(){this._activeLineGraphic&&(this._internalGraphicsLayer.remove(this._activeLineGraphic),this._activeLineGraphic.destroy(),this._activeLineGraphic=null)}_removeActiveFillGraphic(){this._activeFillGraphic&&(this._internalGraphicsLayer.remove(this._activeFillGraphic),this._activeFillGraphic.destroy(),this._activeFillGraphic=null)}_removeLineGraphic(){this._lineGraphic&&(this._internalGraphicsLayer.remove(this._lineGraphic),this._lineGraphic.destroy(),this._lineGraphic=null)}_removeVertexGraphics(){this._vertexGraphics.length&&(this._internalGraphicsLayer.removeMany(this._vertexGraphics),this._vertexGraphics.forEach((e=>e.destroy())),this._vertexGraphics=[])}_removeDefaultLayer(){this._internalGraphicsLayer&&(this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer.destroy(),this._internalGraphicsLayer=null)}_operationHandleForCreateAction(e,t,i){return new Z({activeComponent:this._draw,tool:i,type:"create",onEnd:()=>{t.forEach((e=>e.remove())),t.length=0,this._removeCreateOperationGraphics(),this._internalGraphicsLayer&&this._internalGraphicsLayer.remove(this.createGraphic),this._displayDefaultCursor()},undo:()=>{e.undo(),this._emitUndoEvent({graphics:[this.createGraphic],tool:i})},redo:()=>{e.redo(),this._emitRedoEvent({graphics:[this.createGraphic],tool:i})},canUndo:()=>e&&e.canUndo(),canRedo:()=>e&&e.canRedo()})}_isComponentGraphic(e){const{activeComponent:t}=this;return!(!e||d(t))&&(!(!e.attributes||!e.attributes.esriSketchTool)||("box"===t.type||"reshape"===t.type)&&t.isUIGraphic(e))}_snapLastPolygonVertexToFirst(e,t){if("polygon"!==e&&t.length<=2)return;const i=t[0],o=t[t.length-1],a=this.view.toScreen(new $(i[0],i[1],this.view.spatialReference)),r=this.view.toScreen(new $(o[0],o[1],this.view.spatialReference));this._isWithinScreenDistance(a,r,this._getVertexIntersectDistance())&&(o[0]=i[0],o[1]=i[1])}_getVertexIntersectDistance(){const e=3;return this.vertexSymbol&&"simple-marker"===this.vertexSymbol.type?_(this.vertexSymbol.size)/2+e:e}_isWithinScreenDistance(e,t,i){const o=e.x-t.x,a=e.y-t.y;return Math.sqrt(o*o+a*a)<=i}_displayPointerCursor(){this.view&&this.view.container&&"pointer"!==this.view.cursor&&(this.view.cursor="pointer")}_displayGrabbingCursor(){this.view&&this.view.container&&"grabbing"!==this.view.cursor&&(this.view.cursor="grabbing")}_displayCrosshairCursor(){this.view&&this.view.container&&"crosshair"!==this.view.cursor&&(this.view.cursor="crosshair")}_displayDefaultCursor(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)}_logError(e,t,i){J.error(new a(e,t,i))}async _requireModule(e){const t=new AbortController;this._moduleLoaderAbortController=t;const i=await e;return this._moduleLoaderAbortController!==t||t.signal.aborted?{requireError:"aborted"}:{module:i}}_emitUndoEvent(e){this.emit("undo",{...e,type:"undo"})}_emitRedoEvent(e){this.emit("redo",{...e,type:"redo"})}_emitDeleteEvent(e){this.emit("delete",{...e,type:"delete"})}createPointFromVertex(e){return e.length>2?new $(e[0],e[1],e[2],this.view.spatialReference):new $(e[0],e[1],this.view.spatialReference)}test(){return{operationHandle:this._operationHandle,defaultUpdateOptions:X}}wait(){return T(this,"updating")}_beginAsyncOperation(){this._numUpdating+=1,this.notifyChange("updating")}_endAsyncOperation(){this._numUpdating-=1,this.notifyChange("updating")}_disablePopupEnabled(e){var t;return"3d"!==(null==(t=this.view)?void 0:t.type)||this.updateOnGraphicClick||p(e)&&e.toggleToolOnClick}_disablePopup(e){if(!this._disablePopupEnabled(e))return;const t=this.view.popup;t&&d(this._originalAutoOpenEnabled)&&(this._originalAutoOpenEnabled=t.autoOpenEnabled,t.autoOpenEnabled=!1)}_restorePopup(e){if(!this._disablePopupEnabled(e))return;const t=this.view.popup;t&&p(this._originalAutoOpenEnabled)&&(t.autoOpenEnabled=this._originalAutoOpenEnabled,this._originalAutoOpenEnabled=null)}async _waitViewReady(){this.view&&(l(this._viewReadyAbortController),this._viewReadyAbortController=u(),await m(E(this.view,"ready"),this._viewReadyAbortController.signal))}};function te(e,t){oe("undo",e.history.undo,e.history.redo,t)}function ie(e,t){oe("redo",e.history.redo,e.history.undo,t)}function oe(e,t,i,o){const a=t.pop().updates,r=[];o.forEach(((t,i)=>{const o=a[i];null!=o&&("geometry"in o&&p(o.geometry)&&(r.push({geometry:t.geometry}),t.geometry=o.geometry),"symbol"in o&&p(o.symbol)&&(r.push({symbol:t.symbol}),t.symbol=o.symbol),"undo"in o&&(r.push(o),o[e](t)))})),i.push({updates:r})}function ae(e){return{updates:e.map((e=>({geometry:e.geometry})))}}function re(e){return"requireError"in e&&"aborted"===e.requireError}e([C({readOnly:!0})],ee.prototype,"_draw",null),e([C()],ee.prototype,"updating",null),e([C()],ee.prototype,"_operationHandle",void 0),e([C({readOnly:!0})],ee.prototype,"activeTool",null),e([C()],ee.prototype,"activeFillSymbol",void 0),e([C()],ee.prototype,"activeLineSymbol",void 0),e([C()],ee.prototype,"activeVertexSymbol",void 0),e([C()],ee.prototype,"allowDeleteKey",void 0),e([C({readOnly:!0})],ee.prototype,"createGraphic",null),e([C()],ee.prototype,"defaultCreateOptions",null),e([C()],ee.prototype,"defaultUpdateOptions",null),e([C()],ee.prototype,"layer",void 0),e([C({types:i})],ee.prototype,"pointSymbol",void 0),e([C({types:i})],ee.prototype,"polygonSymbol",void 0),e([C({types:i})],ee.prototype,"polylineSymbol",void 0),e([C({type:W,nonNullable:!0})],ee.prototype,"snappingOptions",null),e([C()],ee.prototype,"_snappingManager",void 0),e([C({readOnly:!0})],ee.prototype,"state",null),e([C({readOnly:!0})],ee.prototype,"updateGraphics",void 0),e([C()],ee.prototype,"updateOnGraphicClick",void 0),e([C({types:i})],ee.prototype,"updatePointSymbol",void 0),e([C({types:i})],ee.prototype,"updatePolygonSymbol",void 0),e([C({types:i})],ee.prototype,"updatePolylineSymbol",void 0),e([C({types:i})],ee.prototype,"vertexSymbol",void 0),e([C({value:null})],ee.prototype,"view",null),e([C()],ee.prototype,"cancel",null),e([C()],ee.prototype,"complete",null),e([C()],ee.prototype,"delete",null),e([C()],ee.prototype,"create",null),e([C()],ee.prototype,"update",null),e([C()],ee.prototype,"undo",null),e([C()],ee.prototype,"redo",null),e([C()],ee.prototype,"canUndo",null),e([C()],ee.prototype,"canRedo",null),e([C()],ee.prototype,"toggleUpdateTool",null),ee=e([S(Y)],ee);var se=ee;export default se;
