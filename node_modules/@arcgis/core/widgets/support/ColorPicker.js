/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"@esri/calcite-components/dist/custom-elements/bundles/button.js";import"@esri/calcite-components/dist/custom-elements/bundles/color-picker.js";import"@esri/calcite-components/dist/custom-elements/bundles/label.js";import"@esri/calcite-components/dist/custom-elements/bundles/slider.js";import t from"../../Color.js";import o from"../../core/Handles.js";import{makeHandle as s}from"../../core/handleUtils.js";import{applySome as r,destroyMaybe as i,isSome as n,isNone as a}from"../../core/maybe.js";import{property as l}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/accessorSupport/ensureType.js";import"../../core/Logger.js";import{subclass as p}from"../../core/accessorSupport/decorators/subclass.js";import{autorun as c}from"../../core/accessorSupport/trackingUtils.js";import h from"../Widget.js";import{tsx as u}from"./jsxFactory.js";import m from"./Popover.js";import"./widgetUtils.js";import{messageBundle as d}from"./decorators/messageBundle.js";const _="esri-color-picker",v={base:_,backgroundPattern:`${_}__bg-pattern`,toggleButton:`${_}__toggle-button`,popover:`${_}__popover`,opacitySliderContainer:`${_}__opacity-slider-container`,opacitySlider:`${_}__opacity-slider`};let C=class extends h{constructor(e,s){super(e,s),this.value=new t,this.alphaEnabled=!0,this._handles=new o,this._containerElement=null,this._popover=null,this._popoverElement=null,this._buttonElement=null}initialize(){this.own(c((()=>{r(this._containerElement,(e=>{e.style.setProperty("--esri-color-picker-value",this.value.toCss(!0))}))})))}destroy(){this._destroyPopover(),this._handles=i(this._handles),this._buttonElement=null}render(){const e=this._messages,t=n(this._popover)&&this._popover.open?e.close:e.open;return u("div",{class:this.classes(v.base,this.class),bind:this,afterCreate:this._onContainerAfterCreate},u("div",{class:v.backgroundPattern}),u("calcite-button",{appearance:"transparent","aria-label":t,class:v.toggleButton,color:"neutral",id:this.id,scale:"s",tabIndex:-1,title:t,bind:this,onclick:this._togglePopover,afterCreate:this._onButtonAfterCreate}))}_onContainerAfterCreate(e){this._containerElement=e}_onButtonAfterCreate(e){this._destroyPopover(),this._buttonElement=e,this._popover=new m({owner:this,anchorElement:e,placement:"bottom-start",renderContentFunction:this._renderPopoverContent})}_destroyPopover(){this._handles.remove("hex-input-poll-timeout"),this._popover=i(this._popover),this._popoverElement=null}_renderPopoverContent(){const e=this.value,t=this._messages;return u("div",{class:v.popover,tabIndex:-1,bind:this,afterCreate:this._onPopoverAfterCreate,onfocusout:this._onPopoverFocusOut,onkeydown:this._onPopoverKeyDown},u("calcite-color-picker",{appearance:"minimal",hideSaved:!0,hideChannels:!0,scale:"m",value:e.toCss(),bind:this,onCalciteColorPickerChange:this._onColorChange,afterCreate:this._onColorPickerAfterCreate}),this.alphaEnabled&&u("section",{class:v.opacitySliderContainer},u("calcite-label",{scale:"s"},t.opacity,u("calcite-slider",{class:v.opacitySlider,labelHandles:!0,min:0,max:1,step:.01,value:e.a,bind:this,onCalciteSliderChange:this._onOpacityChange}))))}_onColorChange(e){const o=e.target.value,s="string"==typeof o?t.fromRgb(o):new t;s.a=this.value.a,this._onChange(s)}_onOpacityChange(e){const t=e.target,o=this.value.clone();o.a=t.value,this._onChange(o)}_onChange(e){this.value=e,n(this.onChange)&&this.onChange(e)}_onColorPickerAfterCreate(e){this._handles.remove("hex-input-poll-timeout"),this._handles.add(g((()=>!!e.hexInputNode),(()=>{this._handles.remove("hex-input-poll-timeout"),e.setFocus()})),"hex-input-poll-timeout")}_togglePopover(e){n(this._popover)&&this._popover.open?this._closePopover():this._openPopover()}_openPopover(){r(this._popover,(e=>e.open=!0))}_closePopover(){this._handles.remove("hex-input-poll-timeout"),r(this._popover,(e=>e.open=!1)),this._setFocusOnButton()}_setFocusOnButton(){this._handles.remove("button-focus-timeout"),this._handles.add(b((()=>{r(this._buttonElement,(e=>e.setFocus()))})),"button-focus-timeout")}_onPopoverAfterCreate(e){this._popoverElement=e}_onPopoverFocusOut(e){const t=this._popoverElement;if(a(t))return;const o=e.relatedTarget;if(o&&o instanceof Node){if(t.contains(o))return;if(o===this._buttonElement||this._isAssociatedLabel(o))return}this._closePopover()}_isAssociatedLabel(e){var t;const o=this.id,s=null==(t=e.tagName)?void 0:t.toLowerCase();return"calcite-label"===s&&e.for===o||"label"===s&&e.htmlFor===o}_onPopoverKeyDown(e){"Escape"!==e.key&&"Enter"!==e.key||(e.stopPropagation(),this._closePopover())}};function b(e,t){const o=setTimeout(e,t);return s((()=>clearTimeout(o)))}function g(e,t,o=50){let r;function i(){e()?t():r=setTimeout(i,o)}return r=setTimeout(i,o),s((()=>clearTimeout(r)))}e([l()],C.prototype,"class",void 0),e([l()],C.prototype,"value",void 0),e([l()],C.prototype,"alphaEnabled",void 0),e([l()],C.prototype,"onChange",void 0),e([l()],C.prototype,"_containerElement",void 0),e([l()],C.prototype,"_popover",void 0),e([l()],C.prototype,"_popoverElement",void 0),e([l()],C.prototype,"_buttonElement",void 0),e([l(),d("esri/widgets/support/t9n/ColorPicker")],C.prototype,"_messages",void 0),C=e([p("esri.widgets.support.ColorPicker")],C);export{C as ColorPicker};
