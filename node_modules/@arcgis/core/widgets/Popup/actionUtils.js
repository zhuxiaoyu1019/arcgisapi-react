/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../../core/Error.js";import t from"../../core/Logger.js";import{zoomToFeature as r,zoomToClusteredFeatures as i,browseClusteredFeatures as o,removeSelectedFeature as n}from"./actions.js";const a="esri.widgets.Popup.PopupViewModel",s=t.getLogger(a),c=function(t){const{event:a,view:s}=t,{action:c}=a,u=s&&s.popup;if(!c)return Promise.reject(new e("trigger-action:missing-arguments","Event has no action"));if(!u)return Promise.reject(new e("trigger-action:missing-arguments","view.popup is missing"));const{disabled:d,id:w}=c;if(!w)return Promise.reject(new e("trigger-action:invalid-action","action.id is missing"));if(d)return Promise.reject(new e("trigger-action:invalid-action","Action is disabled"));if(w===r.id)return l(u.viewModel);if(w===i.id)return g(u.viewModel);if(w===o.id)return u.featureMenuOpen=!u.featureMenuOpen,u.viewModel.browseClusterEnabled=!u.viewModel.browseClusterEnabled,Promise.resolve();if(u.viewModel.browseClusterEnabled=!1,w===n.id){u.close();const{selectedFeature:t}=u;if(!t)return Promise.reject(new e(`trigger-action:${n.id}`,"selectedFeature is required",{selectedFeature:t}));const{sourceLayer:r}=t;return r?r.remove(t):s.graphics.remove(t),Promise.resolve()}return Promise.resolve()};function u(e){const{selectedFeature:t,location:r,view:i}=e;if(!i)return null;if("3d"===i.type)return t||r;return e.get("selectedFeature.geometry")||r}function d(t,r){if("3d"!==(null==r?void 0:r.type)||!t||"esri.Graphic"!==t.declaredClass)return!0;const i=r.getViewForGraphic(t);if(i&&"whenGraphicBounds"in i){let r=!1;return i.whenGraphicBounds(t,{useViewElevation:!0}).then((e=>{r=!e||!e.boundingBox||e.boundingBox[0]===e.boundingBox[3]&&e.boundingBox[1]===e.boundingBox[4]&&e.boundingBox[2]===e.boundingBox[5]})).catch((()=>{const r=new e("zoom-to:invalid-graphic","Could not zoom to the location of the graphic.",{graphic:t});s.error(r)})),r}return!0}async function l(t){const{location:i,selectedFeature:o,view:n,zoomFactor:a}=t,c=u(t);if(!c){const t=new e("zoom-to:invalid-target-or-view","Cannot zoom to location without a target and view.",{target:c,view:n});return s.error(t),Promise.reject(t)}const l=n.scale/a,g=t.get("selectedFeature.geometry")||i,w=g&&"point"===g.type&&d(o,n);r.active=!0,r.disabled=!0,await t.view.goTo({target:c,scale:w?l:void 0}),r.active=!1,r.disabled=!1,t.zoomToLocation=null,w&&(t.location=g)}async function g(t){const{selectedFeature:r,view:o}=t;if("2d"!==(null==o?void 0:o.type)){const t=new e("zoomToCluster:invalid-view","View must be 2d MapView.",{view:o});throw s.error(t),t}if(!r.isAggregate){const t=new e("zoomToCluster:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:r});throw s.error(t),t}const n=r.sourceLayer,a=await o.whenLayerView(n),c=a.createQuery();c.aggregateIds=[r.getObjectId()],i.active=!0,i.disabled=!0;const{extent:u}=await a.queryExtent(c);await o.goTo({target:u}),i.active=!1,i.disabled=!1}async function w(t){const{selectedFeature:r,view:i}=t;if("2d"!==(null==i?void 0:i.type)){const t=new e("displayClusterExtent:invalid-view","View must be 2d MapView.",{view:i});throw s.error(t),t}if(!r.isAggregate){const t=new e("zoomToCluster:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:r});throw s.error(t),t}const o=r.sourceLayer,n=await i.whenLayerView(o),a=n.createQuery();a.aggregateIds=[r.getObjectId()];const{extent:c}=await n.queryExtent(a);t.selectedClusterBoundaryFeature.geometry=c,i.graphics.add(t.selectedClusterBoundaryFeature)}async function v(t){const{selectedFeature:r,view:i}=t;if("2d"!==(null==i?void 0:i.type)){const t=new e("browseAggregateFeatures:invalid-view","View must be 2d MapView.",{view:i});throw s.error(t),t}if(!r.isAggregate){const t=new e("browseAggregateFeatures:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:r});throw s.error(t),t}const n=r.sourceLayer,a=await i.whenLayerView(n),c=a.createQuery();c.aggregateIds=[r.getObjectId()],o.active=!0,o.disabled=!0;const{features:u}=await a.queryFeatures(c);o.active=!1,o.disabled=!1,i.popup.open({features:[r].concat(u),featureMenuOpen:!0})}function p(e){e.features=e.features.filter((e=>e.isAggregate))}export{v as browseAggregateFeatures,w as displayClusterExtent,u as getSelectedTarget,d as isZoomScreenSize,p as removeClusteredFeaturesForBrowsing,c as triggerAction,g as zoomToClusterExtent,l as zoomToLocation};
