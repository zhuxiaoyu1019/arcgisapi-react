/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Graphic.js";import"../../intl.js";import i from"../../core/Evented.js";import{HandleOwnerMixin as r}from"../../core/HandleOwner.js";import s from"../../core/Logger.js";import{ReentrantObjectPool as l}from"../../core/ReentrantObjectPool.js";import{init as o}from"../../core/watchUtils.js";import{property as a}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import{cast as n}from"../../core/accessorSupport/decorators/cast.js";import{subclass as u}from"../../core/accessorSupport/decorators/subclass.js";import p from"../../form/FormTemplate.js";import{loadArcade as d}from"../../support/arcadeOnDemand.js";import f from"./FieldConfig.js";import c from"./FieldGroupConfig.js";import h from"./InputField.js";import m from"./InputFieldGroup.js";import{fieldConfigsFromFormTemplate as g}from"./support/formTemplateUtils.js";import{fetchMessageBundle as y}from"../../intl/messages.js";import{onLocaleChange as _}from"../../intl/locale.js";function v(e){return!!e.inputFields}function F(e){return!!e.fieldConfig}const C=new t({attributes:{}}),j="esri.widgets.FeatureForm.FeatureFormViewModel",E=s.getLogger(j);let O=class extends(r(i.EventedAccessor)){constructor(e){super(e),this._arcade=null,this._fieldPool=new l(h),this._fieldGroupPool=new l(m),this._featureClone=C.clone(),this._initialFeature=C.clone(),this._needsArcade=!1,this.messages=null,this.strict=!1}initialize(){const e=async()=>this.messages=await y("esri/widgets/FeatureForm/t9n/FeatureForm");e(),this.handles.add(_(e));const t=o(this,"fieldConfig",(async e=>{const i=[];e&&e.forEach((e=>{i.push(e.visibilityExpression),F(e)?e.fieldConfig.forEach((({requiredExpression:e,visibilityExpression:t})=>{i.push(e,t)})):i.push(e.requiredExpression)}));const r=i.filter((e=>!!e)),s=r.length>0;if(s){const e=await d(),{arcadeUtils:i}=e;r.some((e=>i.hasGeometryOperations(e)))&&(await i.enableGeometryOperations(),t.remove()),this._arcade=e,this.notifyChange("inputFields")}this._needsArcade=s}));this.handles.add(t)}destroy(){this.fieldConfig=null,this.feature=null,this.layer=null,this._fieldPool.destroy(),this._fieldGroupPool.destroy()}get _allInputFields(){return this.inputFields.reduce(((e,t)=>v(t)?[...e,...t.inputFields]:[...e,t]),[])}get _inputFieldCache(){const e=this._get("_inputFieldCache")||new Map;e.forEach((e=>this._disposeInputOrGroup(e))),e.clear();return(this.get("layer.fields")||[]).forEach((t=>e.set(t,this._fieldPool.acquire()))),e}get _inputFieldGroupCache(){const e=this._get("_inputFieldGroupCache")||new Map;e.forEach((e=>this._disposeInputOrGroup(e))),e.clear();return(this.fieldConfig||[]).filter(F).forEach((t=>e.set(t,this._fieldGroupPool.acquire()))),e}get description(){var e;return null==(e=this.formTemplate)?void 0:e.description}set description(e){void 0===e?this._clearOverride("description"):this._override("description",e)}get feature(){return this._get("feature")}set feature(e){this._featureClone=e?e.clone():C.clone(),this._initialFeature=this._featureClone.clone(),this._set("feature",e)}get fieldConfig(){const{formTemplate:e}=this;if(!e)return null;const{config:t,encounteredUnsupportedTypes:i}=g(e);return i.length>0&&E.warn("form-info::unsupported-type","encountered unsupported elements/types when parsing form info",i),t}set fieldConfig(e){e?this._override("fieldConfig",e):this._clearOverride("fieldConfig")}castFieldConfig(e){return e?e.map((e=>e instanceof f||e instanceof c?e:F(e)?new c(e):new f(e))):null}get formTemplate(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null}set formTemplate(e){void 0===e?this._clearOverride("formTemplate"):this._override("formTemplate",e)}get inputFields(){const{_arcade:e,_inputFieldCache:t,_inputFieldGroupCache:i,_featureClone:r,messages:s,_needsArcade:l,layer:o,state:a}=this,n=r.clone();if("ready"!==a||l&&!e)return[];const u=this.get("layer.fields")||[],p=this.fieldConfig||[];let d;return d=0!==p.length?p.map((r=>{if(F(r)){const l=i.get(r),a=r.fieldConfig.map((i=>{const r=u.find((e=>e.name===i.name)),a=t.get(r);return a.set({arcade:e,field:r,config:i,feature:n,group:l,initialFeature:this._initialFeature,layer:o,messages:s,value:this.getValue(r.name)}),a})).filter((e=>e.visible));return l.set({arcade:e,config:r,feature:n,inputFields:a}),l}const l=u.find((e=>e.name===r.name)),a=t.get(l);return a.set({arcade:e,field:l,config:r,feature:n,group:null,initialFeature:this._initialFeature,layer:o,messages:s,value:this.getValue(l.name)}),a})):u.map((i=>{const r=t.get(i);return r.set({arcade:e,config:null,field:i,feature:n,group:null,initialFeature:this._initialFeature,layer:o,messages:s,value:this.getValue(i.name)}),r})),d.filter((e=>e.visible))}get layer(){var e;return null!=(e=this.feature)&&e.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null}set layer(e){e?this._override("layer",e):this._clearOverride("layer")}get state(){return this.messages&&this.get("layer.loaded")?"ready":"disabled"}get title(){var e;return null==(e=this.formTemplate)?void 0:e.title}set title(e){void 0===e?this._clearOverride("title"):this._override("title",e)}get valid(){const e=this._allInputFields;return e.length>0&&e.every((({valid:e})=>e))}findField(e){return this._allInputFields.find((t=>t.name===e))}getValue(e){var t;const{_featureClone:i,layer:r}=this,s=!(null==r||!r.getField(e));return null!=(t=i.getAttribute(e))?t:s?null:void 0}setValue(e,t){const{_featureClone:i,strict:r}=this,s=this.findField(e);if(t=""===t?null:t,!s||i.getAttribute(e)===t)return;s.value=t;if(this.get("layer.typeIdField")===s.name&&"types"in this.layer){const e=new Set;this.layer.types.forEach((t=>Object.keys(t.domains).forEach((t=>e.add(t))))),e.forEach((e=>{const t=this.findField(e);t&&t.notifyChange("domain")}))}r&&!s.valid||(i.setAttribute(e,t),this.notifyChange("inputFields"),this._emitChangeEvent(s))}getValues(){return{...this._featureClone.attributes}}submit(){const e=this._allInputFields,t=e.filter((e=>e.valid)).map((({name:e})=>e)),i=e.filter((e=>!e.valid)).map((({name:e})=>e)),r=this.getValues();this.emit("submit",{valid:t,invalid:i,values:r})}_disposeInputOrGroup(e){v(e)?this._disposeGroup(e):this._disposeInput(e)}_disposeGroup(e){e.inputFields.forEach((e=>this._disposeInput(e))),this._fieldGroupPool.release(e)}_disposeInput(e){this._fieldPool.release(e)}_emitChangeEvent({name:e,valid:t,value:i}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:e,value:i,valid:t})}};e([a({readOnly:!0})],O.prototype,"_allInputFields",null),e([a({readOnly:!0})],O.prototype,"_inputFieldCache",null),e([a({readOnly:!0})],O.prototype,"_inputFieldGroupCache",null),e([a()],O.prototype,"description",null),e([a()],O.prototype,"feature",null),e([a()],O.prototype,"fieldConfig",null),e([n("fieldConfig")],O.prototype,"castFieldConfig",null),e([a({type:p})],O.prototype,"formTemplate",null),e([a({readOnly:!0,dependsOn:["messages","feature","fieldConfig","layer.fields","layer.loaded","state"]})],O.prototype,"inputFields",null),e([a()],O.prototype,"layer",null),e([a()],O.prototype,"messages",void 0),e([a()],O.prototype,"state",null),e([a()],O.prototype,"strict",void 0),e([a()],O.prototype,"title",null),e([a()],O.prototype,"valid",null),e([a()],O.prototype,"getValues",null),e([a()],O.prototype,"submit",null),O=e([u(j)],O);var b=O;export default b;
