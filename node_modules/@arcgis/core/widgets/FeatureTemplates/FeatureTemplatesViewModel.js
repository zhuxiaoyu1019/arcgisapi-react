/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/Evented.js";import{HandleOwnerMixin as s}from"../../core/HandleOwner.js";import r from"../../core/ObjectPool.js";import{when as o}from"../../core/watchUtils.js";import{property as l}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/accessorSupport/ensureType.js";import"../../core/Logger.js";import{subclass as a}from"../../core/accessorSupport/decorators/subclass.js";import i from"./TemplateItem.js";import n from"./TemplateItemGroup.js";const p=({layer:e})=>({key:e,label:e.title}),m=({layer:e})=>e.geometryType;let u=class extends(s(t.EventedAccessor)){constructor(e){super(e),this._itemPool=new r(i),this._groupPool=new r(n),this.filterFunction=null,this.groupBy="layer",this.selectedItem=null}destroy(){this._templateToLayer.clear()}get _templateToLayer(){const e=new Map;for(const{layer:t,templates:s}of this._featureTemplateInfos)for(const r of s)e.set(r,t);return e}set layers(e){const t="layers";if(this.handles.remove(t),e){const t=()=>this.notifyChange("state");this.handles.add(e.map((e=>o(e,"loadStatus",t))),"layers")}this._set("layers",e)}get layers(){return this._get("layers")}get state(){const{layers:e}=this;return e&&0!==e.length?e.some((e=>"loading"===e.loadStatus||"not-loaded"===e.loadStatus))?"loading":"ready":"disabled"}get _featureTemplateInfos(){return this.layers?this.layers.filter((({capabilities:e,loaded:t})=>t&&e.operations.supportsEditing&&e.operations.supportsAdd)).map((e=>({layer:e,templates:this._getTemplatesForLayer(e)}))).filter((e=>null!=e&&e.templates.length>0)):[]}get numberOfFeatureTemplates(){return this._featureTemplateInfos.reduce(((e,t)=>e+t.templates.length),0)}get items(){const e=this._featureTemplateInfos;if(0===e.length)return this._releasePreviousItems(),[];const{groupBy:t}=this;if("none"===t){const t=e.map((({templates:e})=>e.filter((({name:e})=>!this.filterFunction||this.filterFunction({label:e}))))).map((e=>e.map((e=>this._createItem(e))))).reduce(((e,t)=>[...e,...t]),[]);return this._releasePreviousItems(),t}const s=e.reduce(((e,{layer:s,templates:r})=>(r.forEach((r=>{const o=("layer"===t?p:"geometry"===t?m:t)({template:r,layer:s});if(o){const t="string"==typeof o?o:o.key,s="string"==typeof o?o:o.label;e.has(t)||e.set(t,{label:s,templates:[]}),e.get(t).templates.push(r)}})),e)),new Map);if(0===s.size)return this._releasePreviousItems(),[];const r=[],{filterFunction:o}=this;return s.forEach((e=>{const{label:t,templates:s}=e;if(!o||this.filterFunction(e))r.push(this._createGroup(t,s.map((e=>this._createItem(e)))));else{const e=s.filter((({name:e})=>this.filterFunction({label:e}))).map((e=>this._createItem(e)));e.length>0&&r.push(this._createGroup(t,e))}})),this._releasePreviousItems(),r}refresh(){this.notifyChange("items")}select(e){const t=(null==e?void 0:e.clone())||null;this._set("selectedItem",t),this.emit("select",{item:t,template:(null==t?void 0:t.template)||null})}_getTemplatesForLayer(e){return[...e.templates||[],...(e.types||[]).map((e=>e.templates)).reduce(((e,t)=>[...e,...t]),[])]}_createItem(e){const t=this._itemPool.acquire();return t.set({template:e,layer:this._templateToLayer.get(e)}),t}_createGroup(e,t){const s=this._groupPool.acquire();return s.set("label",e),s.items=t,s}_releasePreviousItems(){this._destroyItems(this._get("items"))}_destroyItems(e){if(!e)return;e[0]instanceof i?e.forEach((e=>this._destroyItem(e))):e.forEach((e=>this._destroyGroup(e)))}_destroyGroup(e){e.items.forEach((e=>this._destroyItem(e))),e.items.length=0,this._groupPool.release(e)}_destroyItem(e){e.layer=null,e.template=null,this._itemPool.release(e)}};e([l({readOnly:!0})],u.prototype,"_templateToLayer",null),e([l()],u.prototype,"filterFunction",void 0),e([l()],u.prototype,"groupBy",void 0),e([l()],u.prototype,"layers",null),e([l()],u.prototype,"state",null),e([l({readOnly:!0})],u.prototype,"_featureTemplateInfos",null),e([l({readOnly:!0})],u.prototype,"numberOfFeatureTemplates",null),e([l({readOnly:!0})],u.prototype,"items",null),e([l({readOnly:!0})],u.prototype,"selectedItem",void 0),e([l()],u.prototype,"select",null),u=e([a("esri.widgets.FeatureTemplates.FeatureTemplatesViewModel")],u);var c=u;export default c;
