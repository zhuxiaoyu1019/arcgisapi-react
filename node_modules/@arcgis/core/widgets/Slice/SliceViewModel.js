/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/Collection.js";import{referenceSetter as o,castForReferenceSetter as r}from"../../core/collectionUtils.js";import i from"../../core/Handles.js";import s from"../../core/Logger.js";import{isNone as l,isSome as a}from"../../core/maybe.js";import{ignoreAbortErrors as d}from"../../core/promiseUtils.js";import{whenTrueOnce as c}from"../../core/watchUtils.js";import{aliasOf as h}from"../../core/accessorSupport/decorators/aliasOf.js";import"../../core/has.js";import"../../core/accessorSupport/ensureType.js";import{property as n}from"../../core/accessorSupport/decorators/property.js";import{subclass as u}from"../../core/accessorSupport/decorators/subclass.js";import p from"../../layers/SliceLayer.js";import y from"../../views/3d/interactive/analysisTools/slice/SliceTool.js";import{InteractiveToolViewModel as m}from"../support/InteractiveToolViewModel.js";const w=s.getLogger("esri.widgets.Slice.SliceViewModel"),f=new Set;let V=class extends m{constructor(e){super(e),this.layerView=null,this.supportedViewType="3d",this.handles=new i,this.model=new p({listMode:"hide"}),this.shape=null,this.tiltEnabled=!1,this.ready=!1,f.add(this)}initialize(){this.handles.add(this.watch("shape",((e,t)=>{l(t)&&a(e)?this.tool||this.creatingTool||this.createTool():a(t)&&l(e)&&this.tool&&this.removeTool()}),!0)),this.handles.add(this.watch("tiltEnabled",(e=>this._updateToolOrRecreate((t=>t.tiltEnabled=e))),!0)),this.handles.add(this.watch("view",(e=>{this._disconnectFromView(),this._connectToView(e)}),!0)),this._connectToView(this.view)}destroy(){this._disconnectFromView(),f.delete(this),this.handles.destroy()}get state(){return this.isDisabled||!this.ready?"disabled":this.tool&&"pending"!==this.tool.toolState?this.tool.state:"ready"}get excludedLayers(){return a(this.layerView)?this.layerView.layerViewData.excludedLayers:this._get("excludedLayers")||new t}set excludedLayers(e){this._set("excludedLayers",o(e,this.excludedLayers)),a(this.layerView)&&(this.layerView.layerViewData.excludedLayers=e)}get excludeGroundSurface(){return a(this.layerView)?this.layerView.layerViewData.excludeGroundSurface:this._get("excludeGroundSurface")||!1}set excludeGroundSurface(e){this._set("excludeGroundSurface",e),a(this.layerView)&&(this.layerView.layerViewData.excludeGroundSurface=e)}async start(){this.removeTool(),this.ready||await c(this,"ready"),f.forEach((e=>{e.view===this.view&&e!==this&&e.clear()})),await this.createTool()}clear(){this.removeTool(),this.excludeGroundSurface=!1,this.excludedLayers=new t}removeSliceAndStart(){return this.removeTool(),this.shape=null,this.start()}enterExcludeLayerMode(){this.tool&&this.tool.enterExcludeLayerMode()}exitExcludeLayerMode(){this.tool&&this.tool.exitExcludeLayerMode()}_updateToolOrRecreate(e){this.tool?e(this.tool):this.creatingTool&&d(this.createTool())}createToolParams(){return{toolConstructor:y,constructorArguments:()=>({tiltEnabled:this.tiltEnabled,analysis:this.model})}}logUnsupportedError(){this.logError("Slice widget is not implemented for MapView")}logError(...e){w.error(...e)}_connectToView(e){if(!l(e)&&(e.map.layers.includes(this.model)||e.map.layers.add(this.model),"3d"===e.type)){const t=e;t.whenLayerView(this.model).then((e=>{this.destroyed||t!==this.view||(e.layerViewData.excludeGroundSurface=this.excludeGroundSurface,e.layerViewData.excludedLayers=this.excludedLayers,this.layerView=e,this.ready=!0)}))}}_disconnectFromView(){null!=this.view&&(this.view.map.remove(this.model),this.layerView=null)}};e([n()],V.prototype,"layerView",void 0),e([n({readOnly:!0})],V.prototype,"state",null),e([n()],V.prototype,"tool",void 0),e([n()],V.prototype,"model",void 0),e([n({aliasOf:"model.plane"})],V.prototype,"shape",void 0),e([n({aliasOf:"model.tiltEnabled"})],V.prototype,"tiltEnabled",void 0),e([h("tool.layersMode")],V.prototype,"layersMode",void 0),e([n({cast:r})],V.prototype,"excludedLayers",null),e([n({nonNullable:!0})],V.prototype,"excludeGroundSurface",null),e([n()],V.prototype,"ready",void 0),V=e([u("esri.widgets.slice.SliceViewModel")],V);var x=V;export default x;
