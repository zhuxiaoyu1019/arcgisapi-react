/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"@esri/calcite-components/dist/custom-elements/bundles/switch.js";import"../intl.js";import{aliasOf as t}from"../core/accessorSupport/decorators/aliasOf.js";import"../core/has.js";import"../core/accessorSupport/ensureType.js";import"../core/Logger.js";import{property as i}from"../core/accessorSupport/decorators/property.js";import{subclass as a}from"../core/accessorSupport/decorators/subclass.js";import{loadMoment as s}from"../intl/moment.js";import{getDomainRange as r}from"../layers/support/domains.js";import{getFieldRange as n}from"../layers/support/fieldUtils.js";import l from"./Widget.js";import o from"./FeatureForm/FeatureFormViewModel.js";import{Heading as d}from"./support/Heading.js";import"./support/widgetUtils.js";import{messageBundle as u}from"./support/decorators/messageBundle.js";import{vmEvent as p}from"./support/decorators/vmEvent.js";import{tsx as c}from"./support/jsxFactory.js";import{getLocale as h}from"../intl/locale.js";const m={base:"esri-feature-form",form:"esri-feature-form__form",formHeader:"esri-feature-form__form-header",label:"esri-feature-form__label",inputField:"esri-feature-form__input",inputDate:"esri-feature-form__input--date",inputTime:"esri-feature-form__input--time",inputRadioGroup:"esri-feature-form__input--radio-group",inputRadio:"esri-feature-form__input--radio",inputRadioLabel:"esri-feature-form__input--radio-label",inputDisabled:"esri-feature-form__input--disabled",inputSwitch:"esri-feature-form__input--switch",inputInvalid:"esri-feature-form__input--invalid",inputIconInvalid:"esri-feature-form__input-icon--invalid",errorMessage:"esri-feature-form__field-error-message",description:"esri-feature-form__description-text",dateInputPart:"esri-feature-form__date-input-part",loneDateInputPart:"esri-feature-form__date-input-part--lone",dateInputContainer:"esri-feature-form__date-input-container",dateFormatHint:"esri-feature-form__date-format-hint",group:"esri-feature-form__group",groupLabel:"esri-feature-form__group-label",groupHeader:"esri-feature-form__group-header",groupHeading:"esri-feature-form__group-header",groupTitle:"esri-feature-form__group-title",groupDescription:"esri-feature-form__group-description",groupToggleIcon:"esri-feature-form__group-toggle-icon",groupCollapsed:"esri-feature-form__group--collapsed",groupSequential:"esri-feature-form__group--sequential",groupActive:"esri-feature-form__group--active",collapseIcon:"esri-icon-up",errorIcon:"esri-icon-notice-triangle",expandIcon:"esri-icon-down",widget:"esri-widget",panel:"esri-widget--panel",input:"esri-input",select:"esri-select"},f={datePattern:"L",timePattern:"LTS"};function _(e){return e&&e.inputFields}let g=class extends l{constructor(e,t){super(e,t),this._activeDateEdit=null,this._activeInputName=null,this._fieldFocusNeeded=!1,this._fieldToInitialIncompatibleDomainValue=new Map,this._switchFieldsWithInitialIncompatibleValue=new Set,this._moment=null,this._userUpdatedInputFieldNames=new Set,this.description=null,this.feature=null,this.fieldConfig=null,this.formTemplate=null,this.groupDisplay="all",this.headingLevel=2,this.label=void 0,this.layer=null,this.messages=null,this.strict=null,this.title=null,this.viewModel=new o,this._handleRadioInputChange=e=>{this._updateFieldValue(e.target)},this._handleFormKeyDown=this._handleFormKeyDown.bind(this),this._handleInputBlur=this._handleInputBlur.bind(this),this._handleInputFocus=this._handleInputFocus.bind(this),this._handleNumberInputMouseDown=this._handleNumberInputMouseDown.bind(this),this._handleInputKeyDown=this._handleInputKeyDown.bind(this),this._handleOptionChange=this._handleOptionChange.bind(this),this._handleGroupClick=this._handleGroupClick.bind(this),this._handleSubmit=this._handleSubmit.bind(this),this._afterInputCreateOrUpdate=this._afterInputCreateOrUpdate.bind(this)}async loadLocale(){this._moment=await s()}initialize(){this.own(this.watch("feature",(()=>{const e=this._getFocusableInput("forward");this._activeInputName=e&&e.name,this._userUpdatedInputFieldNames.clear(),this._fieldToInitialIncompatibleDomainValue.clear(),this._switchFieldsWithInitialIncompatibleValue.clear(),this._fieldFocusNeeded=!0})),this.on("submit",(e=>{if(e.invalid.length>0){const[t]=e.invalid;e.invalid.forEach((e=>this._userUpdatedInputFieldNames.add(e))),this._activeInputName=t,this._fieldFocusNeeded=!0,this.scheduleRender()}})))}destroy(){this._userUpdatedInputFieldNames.clear(),this._userUpdatedInputFieldNames=null}getValues(){return null}submit(){return null}render(){const{state:e}=this.viewModel;return c("div",{class:this.classes(m.base,m.widget,m.panel)},"ready"===e?this.renderForm():null)}renderForm(){const e=this.title?c(d,{key:"title",level:this.headingLevel},this.title):null,t=this.description?c("p",{class:m.description,key:"description"},this.description):null,i=e||t?c("div",{class:m.formHeader},e,t):null;return c("form",{class:m.form,novalidate:!0,onsubmit:this._handleSubmit,onkeydown:this._handleFormKeyDown},i,this.renderFields())}renderFields(){const{viewModel:{inputFields:e}}=this;return e.map(((e,t)=>_(e)?this.renderGroup(e,t):this.renderLabeledField(e)))}renderGroup(e,t){const{description:i,inputFields:a,label:s,state:r}=e,n=this.viewModel.findField(this._activeInputName),l=!(!n||n.group!==e),o=`${this.id}_group_${t}`,u=`${this.id}_group-label_${t}`,p=`${this.id}_group-description_${t}`,h=i?c("p",{class:this.classes(m.groupDescription,m.description),id:p},i):null,f="sequential"===this.groupDisplay,_=f?l:"expanded"===r,g=_?m.collapseIcon:m.expandIcon;return c("fieldset",{"aria-expanded":_.toString(),"aria-labelledby":u,"aria-describedby":i?p:"",class:this.classes(m.group,f?m.groupSequential:null,_?null:m.groupCollapsed,l?m.groupActive:null),"data-group":e,id:o,key:t,onclick:this._handleGroupClick},c("button",{role:f?"presentation":void 0,class:m.groupHeader,type:"button",tabIndex:f?-1:0},c("div",{class:m.groupTitle},c(d,{class:m.groupLabel,id:u,level:this.headingLevel+(this.title?1:0)},s),h),f?null:c("span",{class:this.classes(g,m.groupToggleIcon)})),a.map((e=>this.renderLabeledField(e))))}_getFocusableInput(e,t){const i=this.viewModel._allInputFields,a="forward"===e?i:i.slice().reverse();let s;if(t)if(_(t))s=a.indexOf(t.inputFields[0]);else{let i;if(this._isFieldInClosedCollapsibleGroup(t)){const{inputFields:a}=t.group;i="forward"===e?a[a.length-1]:a[0]}else i=t;s=a.indexOf(i)+1}else s=0;for(let r=s;r<a.length;r++){const e=a[r];if(e.visible&&e.editable)return e}return null}renderLabeledField(e){const{label:t,layer:i,type:a}=e;return c("label",{key:`${i.id}-${e.name}`,class:m.label},[t,"unsupported"!==a?this.renderInputField(e):this.renderUnsupportedField(e),this.renderAuxiliaryText(e)])}renderInputField(e){const{viewModel:t}=this,{domain:i,editable:a,name:s,type:r}=e,n=t.getValue(s),l=!a,o=this.getCommonInputProps(e);if("coded-value"===(null==i?void 0:i.type)&&!l){if("switch"===e.editorType){if(!(this._switchFieldsWithInitialIncompatibleValue.has(s)||null==n||e.config.onValue!==n&&e.config.offValue!==n))return this.renderSwitchInputField(n,o);this._switchFieldsWithInitialIncompatibleValue.add(s)}return"radio-buttons"===e.editorType?this.renderRadioButtonsInputField(n,i.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),o):this.renderSelectInputField(n,i.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),o)}return"text"===r&&"text-area"===e.editorType||"rich-text"===e.editorType?c("textarea",{...o}):"datetime-picker"===e.editorType||"date"===r?this.renderDateInputField(n,o):c("input",{type:"text"===r?"text":"number",...o})}renderDateInputField(e,t){const{date:i,time:a}=this._formatDate(0),s=`${this.id}-${t.key}`,r=`${s}-date`,n=`${s}-time`,l=t["data-field"],{includeTime:o}=l,{date:d,time:u}=this._formatDate(e);return c("div",{key:`${t.key}-date`,class:m.dateInputContainer},c("div",{class:this.classes(m.dateInputPart,o?null:m.loneDateInputPart)},c("input",{"aria-label":l.label,"aria-describedby":r,type:"text",...t,"data-date-part":"date",class:this.classes(t.class,m.inputDate),value:d}),c("div",{class:m.dateFormatHint,id:r},i)),o?c("div",{class:m.dateInputPart,key:"time-input"},c("input",{"aria-describedby":n,"aria-label":l.label,type:"text",...t,"data-date-part":"time",class:this.classes(t.class,m.inputTime),value:u}),c("div",{class:m.dateFormatHint,id:n},a)):null)}renderUnsupportedField(e){const t=this.viewModel.getValue(e.name);return c("input",{class:this.classes(m.input,m.inputField,m.inputDisabled),disabled:!0,type:"text",value:`${t}`})}renderSelectInputField(e,t,i){const a=t.map((e=>c("option",{value:`${e.value}`,key:e.name},e.name))),s=i["data-field"];if(this.registerIncompatibleValue(e,t,s,(e=>{a.unshift(c("option",{value:`${e}`,key:"incompatible-option",disabled:!0},e))})),!s.required&&("combo-box"!==s.editorType||s.config.showNoValueOption)){var r;const e="",t=(null==(r=s.config)?void 0:r.noValueOptionLabel)||this.messages.empty;a.unshift(c("option",{value:e,key:"empty-option"},t))}return c("select",{...i,class:this.classes(i.class,m.select),onchange:this._handleOptionChange},a)}registerIncompatibleValue(e,t,i,a){const s=this._fieldToInitialIncompatibleDomainValue,r=s.has(i.name);(r||null!=e&&""!==e&&!t.find((t=>t.value===e))||r)&&(r||s.set(i.name,e),null==a||a(s.get(i.name)))}renderRadioButtonsInputField(e,t,i){const a=i["data-field"],s=t.map((t=>this.renderRadioButton({key:t.name,label:t.name,name:a.name,value:t.value,selected:t.value===e,props:i})));if(this.registerIncompatibleValue(e,t,a),!a.required&&(!a.config||a.config.showNoValueOption)){var r;const t="",n=(null==(r=a.config)?void 0:r.noValueOptionLabel)||this.messages.empty,l=e===t||null===e;s.unshift(this.renderRadioButton({key:"empty-option",label:n,name:a.name,value:t,selected:l,props:i}))}return c("div",{key:`${i.key}-radio`,class:m.inputRadioGroup},s)}renderSwitchInputField(e,t){const i=t["data-field"];return c("calcite-switch",{...t,class:m.inputSwitch,switched:e===i.config.onValue,onCalciteSwitchChange:e=>{this._parseValue(e.currentTarget)}})}renderRadioButton({key:e,name:t,value:i,selected:a,label:s,props:r}){return c("label",{key:e,class:m.inputRadioLabel},c("input",{...r,class:m.inputRadio,name:t,type:"radio",value:i,checked:a,onchange:this._handleRadioInputChange}),s)}renderAuxiliaryText(e){return this._userUpdatedInputFieldNames.has(e.name)&&!e.valid?c("div",{key:"error-message"},c("span",{class:this.classes(m.inputIconInvalid,m.errorIcon)}),c("div",{class:m.errorMessage},e.errorMessage)):e.description?c("div",{key:"description",class:m.description},e.description):void 0}getCommonInputProps(e){const{groupDisplay:t,viewModel:i}=this,{editable:a,group:s,hint:r,maxLength:n,minLength:l,name:o,required:d,type:u,valid:p}=e,c=i.getValue(o),h=this._userUpdatedInputFieldNames.has(o),f=!a,_="all"===t&&"collapsed"===(null==s?void 0:s.state);return{afterCreate:this._afterInputCreateOrUpdate,afterUpdate:this._afterInputCreateOrUpdate,"aria-invalid":p?"false":"true",class:this.classes(m.input,m.inputField,f?m.inputDisabled:null,h&&!p?m.inputInvalid:null),key:o,minlength:l>-1?`${l}`:"",maxlength:n>-1?`${n}`:"",...this._getNumberFieldConstraints(e),disabled:f,value:null==c?"":`${c}`,"data-field":e,onfocus:this._handleInputFocus,onblur:this._handleInputBlur,onkeydown:this._handleInputKeyDown,onmousedown:"number"===u?this._handleNumberInputMouseDown:null,placeholder:"number"===u||"text"===u?r:"",required:d,tabIndex:_?-1:0}}_isFieldInClosedCollapsibleGroup(e){var t;return"all"===this.groupDisplay&&!_(e)&&"collapsed"===(null==e||null==(t=e.group)?void 0:t.state)}_handleNumberInputMouseDown({target:e}){const t=e;t.disabled||t.focus(),this.scheduleRender()}_getNumberFieldConstraints(e){const t=r(e.domain)||n(e.field);return t&&t.max!==Number.MAX_VALUE&&t.min!==Number.MIN_VALUE?t:{min:null,max:null}}_afterInputCreateOrUpdate(e){const t=e["data-field"],i=this.viewModel.findField(this._activeInputName),a=this._fieldToInitialIncompatibleDomainValue.get(t.name)===t.value;t.editable&&this._fieldFocusNeeded&&i===t&&("radio-buttons"!==t.editorType||a||e.checked)&&(this._fieldFocusNeeded=!1,e.focus())}_handleInputFocus(e){const t=e.target;this._activeInputName=t["data-field"].name}_handleInputBlur(e){const t=e.target,i=t["data-field"],a=e.relatedTarget,s=a&&a["data-field"];this._syncDateEditsBeforeValueCommit(t);if(s&&"date"===i.type&&"date"===s.type&&i.field===s.field){if(""!==t.value&&""===a.value){const e=a.getAttribute("data-date-part");a.value=this._formatDate(Date.now())[e]}}else("radio-buttons"!==i.editorType||t.checked)&&(this._commitValue(t),this.scheduleRender())}_commitValue(e){const t=e["data-field"];if(this._activeDateEdit){const{date:e,time:i}=this._activeDateEdit,a=this._getDateEditValue(t,"date"),s=this._getDateEditValue(t,"time"),r=""===a||""===s;if(e){const{input:t}=e;t.value=r?"":a}if(i){const{input:e}=i;e.value=r?"":s}if(this._activeDateEdit=null,e&&i)return void this._updateDateFieldValue(e.input,i.input)}this._updateFieldValue(e)}_getDateEditValue(e,t){const i=this._activeDateEdit[t];if(!i)return;const{value:a}=i;if(""===a)return"";const s=this._parseDate(i.value,t);return s?this._formatDate(s.getTime())[t]:this._formatDate(e.value)[t]}_handleInputKeyDown(e){const{key:t,altKey:i,ctrlKey:a,metaKey:s,shiftKey:r}=e,n=e.target,l=n["data-field"];if("Tab"===t){const t=r?"backward":"forward",i=n.getAttribute("data-date-part");this._syncDateEditsBeforeValueCommit(n);if("backward"===t&&"time"===i||"forward"===t&&"date"===i&&l.includeTime)return;this._commitValue(n);const a=this.viewModel.findField(l.name),s=this._getFocusableInput(t,a),o=a.group===(null==s?void 0:s.group);return this._activeInputName=null==s?void 0:s.name,void(s&&("sequential"===this.groupDisplay||o)?(e.preventDefault(),this._fieldFocusNeeded=!0):this.renderNow())}if("Enter"===t)this._isFieldInClosedCollapsibleGroup(l)?l.group.state="expanded":(this._updateFieldValue(e.target),this.scheduleRender());else{const{type:r}=l.field,n="single"===r||"double"===r,o=!i&&!a&&!s;if(("integer"===r||"small-integer"===r||n)&&o&&1===t.length){const i=Number(t),a=["-","+"],s=["e","."],r=n?[...a,...s]:a;isNaN(i)&&-1===r.indexOf(t)&&e.preventDefault()}}}_syncDateEditsBeforeValueCommit(e){if("date"!==e["data-field"].type)return;const t=e.getAttribute("data-date-part");this._activeDateEdit={...this._activeDateEdit,[t]:{value:e.value,input:e}}}_updateFieldValue(e){const t=e["data-field"];this.viewModel.setValue(t.name,this._parseValue(e)),this._userUpdatedInputFieldNames.add(t.name)}_updateDateFieldValue(e,t){const i=e["data-field"];this.viewModel.setValue(i.name,this._parseDateTimeValue(e,t)),this._userUpdatedInputFieldNames.add(i.name)}_parseValue(e){const t=e["data-field"],i=e.value;if("switch"===t.editorType&&!(e instanceof HTMLSelectElement))return e.switched?t.config.onValue:t.config.offValue;if("radio-buttons"===t.editorType&&"radio"===e.type&&!e.checked)return t.value;const{type:a}=t;if("number"===a)return i?parseFloat(i):null;if("date"===a){if(!i)return null;const a=Number(i);if(!isNaN(a))return a;const s=e.getAttribute("data-date-part"),r=this._parseDate(i,s);if(!r)return null;const n=this._moment,l=n(r),o=t.domain,d=n();let u=d;if(o&&"range"===o.type){const e=n(o.maxValue);d.isAfter(e)||(u=e)}const p=this.viewModel.getValue(t.name),c=n(null!=p?p:u);return"date"===s?(l.hour(c.hour()),l.minutes(c.minutes()),l.seconds(c.seconds())):(l.date(c.date()),l.month(c.month()),l.year(c.year())),l.valueOf()}return i}_parseDateTimeValue(e,t){const i=e.value,a=t.value;if(!i||!a)return null;const s=this._parseDate(i,"date"),r=this._parseDate(a,"time");if(!s||!r)return null;const n=this._moment(s),l=this._moment(r);return n.hour(l.hour()),n.minutes(l.minutes()),n.seconds(l.seconds()),n.valueOf()}_handleOptionChange(e){this._updateFieldValue(e.target),this.scheduleRender()}_handleGroupClick(e){var t;const i=e.currentTarget["data-group"],a="expanded"===i.state,s="sequential"===this.groupDisplay,r=`.${m.groupHeader}`;if(!(a&&!e.target.closest(r))){if(this._activeInputName=null==(t=this._getFocusableInput("forward",i))?void 0:t.name,s){const t=e.target.closest(r);if(a&&!t)return;this.viewModel.inputFields.forEach((e=>{_(e)&&e!==i&&(e.state="collapsed")}))}i.state=a?"collapsed":"expanded",this._fieldFocusNeeded=s,this.scheduleRender()}}_handleSubmit(e){e.preventDefault()}_handleFormKeyDown(e){"Enter"===e.key&&this.viewModel.submit()}_formatDate(e){if(null==e)return{date:"",time:""};const t=this._moment(e);return{date:t.format(f.datePattern),time:t.format(f.timePattern)}}_parseDate(e,t){if(null==e||""===e)return null;const i=this._moment(e,"date"===t?f.datePattern:f.timePattern,h(),!1);return i.isValid()?i.toDate():null}};e([t("viewModel.description")],g.prototype,"description",void 0),e([t("viewModel.feature")],g.prototype,"feature",void 0),e([t("viewModel.fieldConfig")],g.prototype,"fieldConfig",void 0),e([t("viewModel.formTemplate")],g.prototype,"formTemplate",void 0),e([i()],g.prototype,"groupDisplay",void 0),e([i()],g.prototype,"headingLevel",void 0),e([i({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],g.prototype,"label",void 0),e([t("viewModel.layer")],g.prototype,"layer",void 0),e([i(),u("esri/widgets/FeatureForm/t9n/FeatureForm")],g.prototype,"messages",void 0),e([t("viewModel.strict")],g.prototype,"strict",void 0),e([t("viewModel.title")],g.prototype,"title",void 0),e([i(),p(["value-change","submit"])],g.prototype,"viewModel",void 0),e([t("viewModel.getValues")],g.prototype,"getValues",null),e([t("viewModel.submit")],g.prototype,"submit",null),g=e([a("esri.widgets.FeatureForm")],g);var v=g;export default v;
