/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../../../core/Error.js";import{throwIfAborted as a}from"../../../core/promiseUtils.js";import{isTiledLayer as t}from"../../../layers/support/layerUtils.js";import{checkIfTileInfoSupportedForView as i}from"../../../views/3d/terrain/terrainUtils.js";import r from"../../../views/3d/terrain/TilingScheme.js";import{isSpatialReferenceSupported as n}from"../../../views/support/spatialReferenceSupport.js";async function o(e,t={}){await p(e,t),a(t)}async function s(e,i={}){const{basemap:r,view:n}=e;if(await r.load(i),a(i),0===r.baseLayers.length)return;const o=r.baseLayers.getItemAt(0);if(!t(o))return;if(r.spatialReference){if(n.spatialReference.equals(r.spatialReference))return;l()}await o.load(i),a(i);const s=(o.get("supportedSpatialReferences")||[o.get("tileInfo.spatialReference")]).filter(Boolean);0!==s.length&&s.every((e=>!n.spatialReference.equals(e)))&&l()}function l(){throw new e("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}async function p(a,t){const{basemap:i,view:r}=a;if(await i.load(t),0===i.baseLayers.length)return;const n=c(i.baseLayers.concat(i.referenceLayers));if(n.length)throw n[0];const o=i.baseLayers.getItemAt(0);try{await o.load(t)}catch(s){const a="basemap-compatibility:unknown-error",t="Unknown basemap compatibility error",{name:i=a,message:r=t,details:n}=s;throw new e(i,r,n)}m(o,r)}function c(a){const t=["ArcGISTiledImageServiceLayer","ArcGISTiledMapServiceLayer","OpenStreetMap","VectorTileLayer","WebTiledLayer"];return a.toArray().filter((e=>-1===t.indexOf(e.operationalLayerType))).map((a=>new e("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:a,operationalLayerType:a.operationalLayerType||"unknown"})))}function m(a,t){const o=a.tileInfo;if(!o)return;const s=t.viewingMode;if(!s)return;if(!n(o.spatialReference,s))throw new e(`basemapgalleryitem:spatial-reference-unsupported-${s}`,`Basemap spatial reference is unsupported in ${s} mode`);if("global"===s){let t=i(o,a.fullExtent,null,1);if(t&&a.compatibleTileInfo256&&!i(a.compatibleTileInfo256,a.fullExtent,null,1)&&(t=null),t){const a=o.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new e(`basemapgalleryitem:tiling-scheme-unsupported-${a}-global`,"Basemap tiling scheme is unsupported in global mode",{error:t})}}else if(r.checkUnsupported(o))throw new e("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const l=t.get("basemapTerrain.tilingScheme");if(l&&!l.compatibleWith(o)&&(!a.compatibleTileInfo256||!l.compatibleWith(a.compatibleTileInfo256)))throw new e("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}export{s as default2DCompatibility,o as default3DCompatibility};
