/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Color.js";import i from"../../core/Accessor.js";import"../../core/has.js";import s from"../../core/Handles.js";import{abortMaybe as r,destroyMaybe as o,isSome as a,unwrapOr as n,isNone as l,mapOr as u,applySome as c}from"../../core/maybe.js";import{createTask as d,after as p,throwIfAborted as h}from"../../core/promiseUtils.js";import{createScreenPointArray as m,createRenderScreenPointArray as f}from"../../core/screenUtils.js";import{convertTime as _,offsetDateUTC as w}from"../../core/timeUtils.js";import{property as v}from"../../core/accessorSupport/decorators/property.js";import"../../core/accessorSupport/ensureType.js";import"../../core/Logger.js";import{subclass as y}from"../../core/accessorSupport/decorators/subclass.js";import{reactionInit as g,autorun as T}from"../../core/accessorSupport/trackingUtils.js";import{c as P}from"../../chunks/vec3f64.js";import{longitudeToTimezone as b}from"../../views/3d/support/earthUtils.js";import{computeDirectionsOverTime as O}from"../../views/3d/support/sunUtils.js";import D from"./DiscreteOptions.js";import A from"./DurationOptions.js";import{ShadowTooltipViewModel as C}from"./ShadowTooltipViewModel.js";import U from"./ThresholdOptions.js";import{breadthFirstBinaryPartitioning as j}from"../support/traversalUtils.js";const V=[],z=P(),S=[],R=255,E=_(1,"hours","milliseconds"),k=300;let x=class extends i{constructor(e){super(e),this.view=null,this.tooltip=new C({getDuration:(e,t)=>this.getDuration(e,t)}),this.startTimeOfDay=_(10,"hours","milliseconds"),this.endTimeOfDay=_(16,"hours","milliseconds"),this.visualizationType="threshold",this.thresholdOptions=new U,this.durationOptions=new A,this.discreteOptions=new D,this._running=!0,this._handles=new s,this._stopPreviewingTask=null,this._forcePreview=null,this._autoRestoreForcePreviewEnabled=!0,this._utcOffset=null,this.date=new Date}initialize(){this._handles.add([g((()=>({view:this.view,tooltipEnabled:this._tooltipEnabled})),(({view:e,tooltipEnabled:t})=>{this.tooltip.view=e,this.tooltip.enabled=t})),g((()=>this._getForcePreviewDependencies()),(()=>{r(this._stopPreviewingTask),this._forcePreview=!0,this._autoRestoreForcePreviewEnabled&&(this._stopPreviewingTask=d((async e=>{await p(k,e),h(e),this._forcePreview=!1})))})),T((()=>this._updateVisualizationParameters())),T((()=>this._setShadowAccumulationParameters({lightDirections:this._lightDirections}))),T((()=>this._setShadowAccumulationParameters({enabled:this._running}))),T((()=>this._setShadowAccumulationParameters({previewing:this._previewing})))])}destroy(){this.stop(),this._handles=o(this._handles),o(this.tooltip)}get state(){return a(this.view)&&this.view.ready&&a(this._referencePosition)?"ready":"disabled"}set date(e){const t=new Date(e);t.setHours(0,0,0,0),this._set("date",t)}get utcOffset(){return n(this._utcOffset,this._utcOffsetAuto)}set utcOffset(e){this._utcOffset=e}get testData(){return{setAutoRestoreForcedPreviewEnabled:e=>{this._autoRestoreForcePreviewEnabled=e},setForcedPreview:e=>{this._forcePreview=e},isPreviewing:()=>this._previewing}}get _previewing(){const{view:e}=this;return!(!l(e)&&!l(e.allLayerViews))||(this._forcePreview||!e.stationary||e.allLayerViews.some((e=>F(e)&&e.updating)))}get _utcOffsetAuto(){const e=this._referencePosition;return u(e,0,(e=>b(e[0],!1)))}get _dateUTCOffset(){let e=this.date;return e=w(e,-e.getTimezoneOffset(),"minutes"),e=w(e,-this.utcOffset,"hours"),e}get _startDateTimeUTC(){return w(this._dateUTCOffset,this.startTimeOfDay)}get _endDateTimeUTC(){return w(this._dateUTCOffset,this.endTimeOfDay)}get _referencePosition(){return c(this.view,(e=>c(e.environmentManager,(e=>e.referencePositionWGS84Comparable))))}get _sampleCount(){switch(this.visualizationType){case"threshold":case"duration":return R;case"discrete":{const e=this.discreteOptions.interval;return e>0?Math.floor(this._duration/e):R}}}get _duration(){return this.endTimeOfDay-this.startTimeOfDay}get _lightDirections(){const{view:e}=this;if(l(e))return V;const t="global"===e.viewingMode?z:this._referencePosition;if(l(t))return V;const i=this._sampleCount,s=new Array(i);for(let a=0;a<i;++a)s[a]=P();O(this._startDateTimeUTC,this._endDateTimeUTC,t,e.viewingMode,s),S.length=0;const r=j(0,i,S),o=new Array(i);for(let a=0;a<i;++a)o[a]=s[r[a]];return o}get _tooltipEnabled(){return"ready"===this.state&&"discrete"!==this.visualizationType&&this._running&&!this._previewing}start(){this._running=!0}stop(){this._running=!1}setRunning(e){this._running=e}async getDuration(e,t){const{view:i,_renderView:s}=this;if(l(i)||l(s))return 0;const r=i.state.camera.screenToRender(m(e.x,e.y),f()),o=s.readAccumulatedShadow(r),a=this._sampleCount;if(0===a)return 0;return o*a*(this._duration/a)}_setShadowAccumulationParameters(e){const t=this._renderView;l(t)||t.setRenderParameters({shadowAccumulationOptions:e})}_updateVisualizationParameters(){if(this._running)switch(this.visualizationType){case"threshold":this._updateThresholdVisualizationParameters();break;case"duration":this._updateDurationVisualizationParameters();break;case"discrete":this._updateDiscreteVisualizationParameters()}}_updateThresholdVisualizationParameters(){const{value:e,color:i}=this.thresholdOptions,s=this._duration,r=i,o=r.clone();o.a=0,this._setShadowAccumulationParameters({visualization:1,thresholdColors:[t.toUnitRGBA(o),t.toUnitRGBA(r)],threshold:s>0?e/this._duration:0})}_updateDurationVisualizationParameters(){const{color:e,mode:t}=this.durationOptions;this._updateGradientColorRamp(e);const i=this._duration,s=i>0&&"hourly"===t?E/i:0;this._setShadowAccumulationParameters({visualization:0,bandsEnabled:s>0,bandSize:s})}_updateDiscreteVisualizationParameters(){this._updateGradientColorRamp(this.discreteOptions.color),this._setShadowAccumulationParameters({visualization:0,bandsEnabled:!1,bandSize:0})}_updateGradientColorRamp(e){const i=e,s=i.clone();s.a=0;const r=[t.toUnitRGBA(s),t.toUnitRGBA(i)];this._setShadowAccumulationParameters({gradientColorRamp:r})}get _renderView(){const{view:e}=this;if(l(e))return null;const t=e._stage;return l(t)?null:t.renderView}_getForcePreviewDependencies(){const{view:e}=this;if(l(e))return null;const t=e.slicePlane,i=e.allLayerViews.toArray().filter(F),s=i.map((e=>e.layer)).filter(a),r=i.map((e=>e.visible)),o=s.map((e=>e.visible)),n=s.map((e=>e.opacity)),u=s.filter((function(e){return"definitionExpression"in e})).map((e=>e.definitionExpression)),c=i.filter((function(e){return"filter"in e})).map((e=>e.filter));return{slicePlane:t,startDateUTC:this._startDateTimeUTC,endDateUTC:this._endDateTimeUTC,layerViewVisibilities:r,layerVisibilities:o,layerOpacities:n,filters:c,definitionExpressions:u}}};function F(e){if(e.suspended)return!1;switch(e.type){case"building-scene-3d":case"csv-3d":case"elevation-3d":case"feature-3d":case"geojson-3d":case"graphics-3d":case"integrated-mesh-3d":case"ogc-feature-3d":case"scene-layer-3d":case"scene-layer-graphics-3d":case"slice-3d":case"stream-3d":case"wms-3d":return!0;case"area-measurement-3d":case"base-dynamic-3d":case"direct-line-measurement-3d":case"imagery-3d":case"imagery-tile-3d":case"line-of-sight-3d":case"map-image-3d":case"point-cloud-3d":case"tile-3d":case"vector-tile-3d":case"voxel-3d":case"wfs-3d":case"wmts-3d":case"voxel-3d":return!1;case"group":return e.layerViews.toArray().some((e=>F(e)));default:return!1}}e([v()],x.prototype,"state",null),e([v()],x.prototype,"view",void 0),e([v()],x.prototype,"tooltip",void 0),e([v({nonNullable:!0})],x.prototype,"date",null),e([v({nonNullable:!0})],x.prototype,"utcOffset",null),e([v({nonNullable:!0})],x.prototype,"startTimeOfDay",void 0),e([v({nonNullable:!0})],x.prototype,"endTimeOfDay",void 0),e([v({nonNullable:!0})],x.prototype,"visualizationType",void 0),e([v({type:U,nonNullable:!0})],x.prototype,"thresholdOptions",void 0),e([v({type:A,nonNullable:!0})],x.prototype,"durationOptions",void 0),e([v({type:D,nonNullable:!0})],x.prototype,"discreteOptions",void 0),e([v()],x.prototype,"_running",void 0),e([v()],x.prototype,"_handles",void 0),e([v()],x.prototype,"_stopPreviewingTask",void 0),e([v()],x.prototype,"_forcePreview",void 0),e([v()],x.prototype,"_autoRestoreForcePreviewEnabled",void 0),e([v()],x.prototype,"_previewing",null),e([v()],x.prototype,"_utcOffset",void 0),e([v()],x.prototype,"_utcOffsetAuto",null),e([v()],x.prototype,"_dateUTCOffset",null),e([v()],x.prototype,"_startDateTimeUTC",null),e([v()],x.prototype,"_endDateTimeUTC",null),e([v()],x.prototype,"_referencePosition",null),e([v()],x.prototype,"_sampleCount",null),e([v()],x.prototype,"_duration",null),e([v()],x.prototype,"_lightDirections",null),e([v()],x.prototype,"_tooltipEnabled",null),x=e([y("esri.widgets.ShadowAccumulation.ShadowAccumulationViewModel")],x);var G=x;export default G;
