/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import t from"./clock.js";import n from"./Error.js";import{once as e}from"./events.js";import r from"./Logger.js";import{isSome as o,isNone as i,removeMaybe as u,assumeNonNull as c}from"./maybe.js";function s(t){return Promise.all(t)}function f(t,n){const e=t.slice();return Promise.all(t.map(((t,e)=>n(t,e)))).then((t=>e.filter(((n,e)=>t[e]))))}function l(t){return new Promise(((n,e)=>{try{t(n,e)}catch(r){Promise.resolve().then((()=>e(r)))}}))}function m(t="Aborted"){return new n("AbortError",t)}function h(){return new AbortController}function a(t,n="Aborted"){if(b(t))throw m(n)}function p(t){return o(t)?"aborted"in t?t:t.signal:t}function b(t){const n=p(t);return o(n)&&n.aborted}function w(t){if(g(t))throw t}function j(t){if(!g(t))throw t}function v(t,n){const r=p(t);if(!i(r)){if(!r.aborted)return e(r,"abort",(()=>n()));n()}}function P(t,n){const r=p(t);if(!i(r))return a(r),e(r,"abort",(()=>n(m())))}function d(t,n){const e=p(n);return i(e)?t:new Promise(((e,r)=>{let o=v(n,(()=>r(m())));const i=()=>o=u(o);t.then(i,i),t.then(e,r)}))}function g(t){return t&&"AbortError"===t.name}function y(t){return t.catch((t=>{if(!g(t))throw t}))}function T(t,n=r.getLogger("esri")){return t.catch((t=>{g(t)||n.error(t)}))}function E(){let t=null;const n=new Promise(((n,e)=>{t={promise:void 0,resolve:n,reject:e}}));return t.promise=n,t}function A(t){if(!t)return;if("function"!=typeof t.forEach){const n=Object.keys(t);return A(n.map((n=>t[n]))).then((t=>{const e={};return n.forEach(((n,r)=>e[n]=t[r])),e}))}const n=t;return l((t=>{const e=[];let r=n.length;0===r&&t(e),n.forEach((n=>{const o={promise:n||Promise.resolve(n)};e.push(o),o.promise.then((t=>{o.value=t})).catch((t=>{o.error=t})).then((()=>{--r,0===r&&t(e)}))}))}))}function k(t){return A(t).then((t=>t.filter((t=>!!t.value)).map((t=>t.value))))}function L(t){return Promise.reject(t)}function x(t){return Promise.resolve(t)}function C(t,n,e){const r=h();return v(e,(()=>r.abort())),new Promise(((e,o)=>{let i=setTimeout((()=>{i=0,e(n)}),t);v(r,(()=>{i&&(clearTimeout(i),o(m()))}))}))}function O(t,e,r,o){const i=r&&"abort"in r?r:null;null!=o||i||(o=r);let u=setTimeout((()=>{u=0,i&&i.abort()}),e);const c=()=>{throw o||new n("promiseUtils:timeout","The wrapped promise did not resolve within "+e+" ms")};return t.then((t=>{if(0===u)throw c();return clearTimeout(u),t}),(t=>{throw clearTimeout(u),0===u?c():t}))}function U(t){return t&&"function"==typeof t.then}function q(t){return z(t)?t:Promise.resolve(t)}function z(t){return t&&"object"==typeof t&&"then"in t&&"function"==typeof t.then}function B(t,n=-1){let e,r,o,i,u=null;const s=(...f)=>{if(e){r=f,i&&i.reject(m()),i=E();const t=c(i.promise);if(u){const t=u;u=null,t.abort()}return t}if(o=i||E(),i=null,n>0){const r=h();e=q(t(...f,r.signal));const o=e;C(n).then((()=>{e===o&&(i?r.abort():u=r)}))}else e=1,e=q(t(...f));const l=()=>{const t=r;r=o=e=u=null,null!=t&&s(...t)},a=e,p=o;return a.then(l,l),a.then(p.resolve,p.reject),c(p.promise)};return s}function D(){let n,e;const r=new Promise(((t,r)=>{n=t,e=r})),o=t=>{n(t)};return o.resolve=t=>n(t),o.reject=t=>e(t),o.timeout=(n,e)=>t.setTimeout((()=>o.reject(e)),n),o.promise=r,o}function F(t,n){return t.then(n,n)}function G(t){let n=h();const e=t(n.signal);let r={promise:e,finished:!1,abort:()=>{n&&(n.abort(),n=null)}};const o=()=>{r&&(r.finished=!0,r=null),n=null};return e.then(o,o),r}export{C as after,s as all,F as always,l as create,h as createAbortController,m as createAbortError,E as createDeferred,D as createResolver,G as createTask,B as debounce,A as eachAlways,k as eachAlwaysValues,f as filter,y as ignoreAbortErrors,g as isAbortError,b as isAborted,z as isPromise,U as isPromiseLike,T as logOnError,v as onAbort,P as onAbortOrThrow,L as reject,x as resolve,w as throwIfAbortError,a as throwIfAborted,j as throwIfNotAbortError,O as timeout,q as when,d as whenOrAbort};
