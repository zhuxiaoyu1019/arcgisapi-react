/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../global.js";import t from"./RemoteClient.js";import{MessageType as r,receiveMessage as s}from"./utils.js";class n{constructor(){const e=document.createDocumentFragment();["addEventListener","dispatchEvent","removeEventListener"].forEach((t=>{this[t]=(...r)=>e[t](...r)}))}}const o=e.MutationObserver||e.WebKitMutationObserver,a=function(){let t;if(e.process&&e.process.nextTick)t=t=>{e.process.nextTick(t)};else if(e.Promise)t=t=>{e.Promise.resolve().then(t)};else if(o){const e=[],r=document.createElement("div");new o((()=>{for(;e.length>0;)e.shift()()})).observe(r,{attributes:!0}),t=t=>{e.push(t),r.setAttribute("queueStatus","1")}}return t}(),i=(()=>{const t=e.MessageEvent;try{new t("message",{data:null})}catch{return(e,t={})=>{const{data:r,bubbles:s=!1,cancelable:n=!1}=t,o=document.createEvent("Event");return o.initEvent(e,s,n),o.data=r,o}}return(e,r)=>new t(e,r)})();class d{constructor(){this._dispatcher=new n,this._workerPostMessage({type:r.HANDSHAKE})}terminate(){}get onmessage(){return this._onmessageHandler}set onmessage(e){this._onmessageHandler&&this.removeEventListener("message",this._onmessageHandler),this._onmessageHandler=e,e&&this.addEventListener("message",e)}get onmessageerror(){return this._onmessageerrorHandler}set onmessageerror(e){this._onmessageerrorHandler&&this.removeEventListener("messageerror",this._onmessageerrorHandler),this._onmessageerrorHandler=e,e&&this.addEventListener("messageerror",e)}get onerror(){return this._onerrorHandler}set onerror(e){this._onerrorHandler&&this.removeEventListener("error",this._onerrorHandler),this._onerrorHandler=e,e&&this.addEventListener("error",e)}postMessage(e){a((()=>{this._workerMessageHandler(i("message",{data:e}))}))}dispatchEvent(e){return this._dispatcher.dispatchEvent(e)}addEventListener(e,t,r){this._dispatcher.addEventListener(e,t,r)}removeEventListener(e,t,r){this._dispatcher.removeEventListener(e,t,r)}_workerPostMessage(e){a((()=>{this.dispatchEvent(i("message",{data:e}))}))}async _workerMessageHandler(e){const n=s(e);if(n&&n.type===r.OPEN){const{modulePath:e,jobId:s}=n;let o=await t.loadWorker(e);o||(o=await import(
/* @vite-ignore */
/* webpackIgnore: true */
e));const a=t.connect(o);this._workerPostMessage({type:r.OPENED,jobId:s,data:a})}}}export default d;
