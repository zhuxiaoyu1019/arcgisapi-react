/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../../Basemap.js";import t from"../../Ground.js";import r from"../../WebScene.js";import"../../core/has.js";import{Integer as n,isLongFormType as a}from"../../core/accessorSupport/ensureType.js";import{isCollection as s}from"../../core/accessorSupport/extensions/serializableProperty/type.js";import p from"../../layers/GroupLayer.js";import y from"../../layers/KMLLayer.js";import{typeModuleMap as o}from"../../layers/mixins/operationalLayerModuleMap.js";import{supportedTypes as u}from"../../layers/mixins/operationalLayers.js";import i from"../../layers/support/Sublayer.js";import{JoinTableDataSource as l,DataLayerSource as c}from"../../layers/support/source/DataLayerSource.js";import{MapLayerSource as m}from"../../layers/support/source/MapLayerSource.js";import{ScanContext as f}from"./utils.js";async function d(e){return L(null,{typeName:"json",type:e},new f)}async function b(e,t,r){switch(t.typeName){case"array":await j(e,t,r);break;case"union":await S(e,t,r);break;case"json":await L(e,t,r);break;case"native":await w(e,t,r);break;case"enum":await N(e,t,r)}}async function w(e,t,r){r.addProperty({name:e,type:C(t),default:t.default})}function g(e){const t=e.slice();return t.sort(),t}async function N(e,t,r){const n=t.values.slice();t.nullable&&n.push(null),r.currentClass&&r.currentClass.typeValue&&"type"===e?r.addProperty({name:e,type:"string",enum:`"${r.currentClass.typeValue}"`}):r.addProperty({name:e,type:C(t),enum:g(n).map((e=>"string"==typeof e?`"${e}"`:`${e}`)).join("|"),default:t.default})}async function j(e,t,r){await b(`${e}[]`,t.elementType,r)}function v(e,t){if("json"===e.typeName){const t=e.type.__accessorMetadata__,r=t&&t.properties&&t.properties&&t.properties.type,n=r&&z(r),a=n&&n.type,s=a||r&&r.type;if(s&&Array.isArray(s)&&1===s.length&&"string"==typeof s[0])return a?s[0]:I(r,s[0])}return t}async function S(e,t,r){const n=[];for(const a of t.types)if("native"!==a.type.typeName&&t.key){const t=`${e}<${v(a.type,a.value)}>`;await b(t,a.type,r)}else n.push(a.type);if(n.length){const a=n.map(C);t.nullable&&a.push("null"),a.sort(),r.addProperty({type:a.join("|"),name:e,default:t.default})}}async function k(n,a){return n.type===r&&"layers"===a?P("web-scene/operational-layers"):n.type!==e||"baseLayers"!==a&&"baseMapLayers"!==a?n.type===e&&"elevationLayers"===a||n.type===t&&"layers"===a?P("web-scene/ground"):n.type===p&&"layers"===a?P("web-scene/operational-layers",(e=>e!==p)):n.type!==l||"leftTableSource"!==a&&"rightTableSource"!==a?"definitionExpression"===a&&-1!==["esri.layers.SceneLayer","esri.layers.FeatureLayer","esri.layers.ImageryLayer","esri.layers.support.Sublayer","esri.layers.buildingSublayers.BuildingComponentSublayer","esri.layers.CSVLayer"].indexOf(n.type.prototype.declaredClass)?{typeName:"union",key:"type",nullable:!0,types:[{type:{typeName:"native",type:String},value:"string"}]}:null:x({key:"type",base:null,typeMap:{"data-layer":c,"map-layer":m}}):P("web-scene/basemap")}async function h(e,t,r){const n=await k(e,t);return n||A(r)}function T(e){return e.prototype.declaredClass.replace(/\./g,"/")}async function L(e,t,r){const n=t.type.__accessorMetadata__,a=T(t.type),s=n&&n.properties;if(!s)return e&&r.addProperty({name:e,type:"unknown"}),null;let p=a,y=null;const o=e&&e.match(/<([^>]+)>$/);o&&(p+=`--${o[1]}`,y=o[1]),t.type===i&&(p+=`--${r.currentClass.name}`,y=r.currentClass.name);const u=r.seen.get(p);if(u&&e)return r.addProperty({name:e,type:u}),u;const l={type:t.type,name:a,id:p,properties:[]};e&&(r.addProperty({name:e,type:l}),l.typeValue=y),r.push(e,l);for(const c in s){const e=s[c],n=D(e);if(!n||!n.enabled)continue;if(t.type===i){const e="esri/layers/TileLayer"===r.stack[r.stack.length-2].klass.name;if(e&&i.test.isMapImageLayerOverridePolicy(n.overridePolicy)||!e&&i.test.isTileImageLayerOverridePolicy(n.overridePolicy))continue}const a=n.target;if("string"==typeof a||null==a){const n=await h(t,c,e);if(!n)continue;await b("string"==typeof a?a:c,n,r)}else await M(t,a,r)}return r.pop()}async function M(e,t,r){for(const n in t){let a=await k(e,n);if(!a){const e=t[n];a=e.types?x(e.types):G(e.type),a.default=e.default,a=$(a)}await b(n,a,r)}}async function P(e,t){const r={typeName:"union",key:"layerType",types:[]};for(const n in u[e]){if("web-scene/operational-layers"===e&&"ArcGISTiledElevationServiceLayer"===n)continue;const a=await o[n]();a&&(t&&!t(a)||a!==y&&r.types.push({type:{typeName:"json",type:a},value:n}))}if(0===r.types.length)return null;return{typeName:"array",elementType:1===r.types.length?r.types[0].type:r}}function C(e){switch(e.typeName){case"array":return`${C(e.elementType)}[]`;case"union":{const t=e.types.map((e=>C(e.type)));return e.nullable&&t.push("null"),t.sort(),`${t.join(" | ")}`}case"native":switch(e.type){case Number:return"number";case n:return"integer";case String:return"string";case Boolean:return"boolean";case Object:return"object";default:return"unknown"}case"json":return e.type.prototype.declaredClass;case"enum":return"string";default:return}}function _(e){const t=e.prototype.itemType&&e.prototype.itemType.Type;if(!t)return{typeName:"array",elementType:{typeName:"native",type:null}};if("function"==typeof t)return{typeName:"array",elementType:G(t)};if(t.typeMap){const e=[];for(const r in t.typeMap){const n=t.typeMap[r];e.push({type:G(n),value:W(n)?null:r})}return{typeName:"array",elementType:{typeName:"union",key:"string"==typeof t.key?t.key:"type",types:e}}}}function O(e){if("json"!==e.typeName)return null;const t=e.type.__accessorMetadata__,r=t&&t.properties&&t.properties.type,n=r&&z(r),a=n&&n.type,s=a||r&&r.type;return s&&Array.isArray(s)&&"string"==typeof s[0]?a||r.type.map((e=>I(r,e))):null}function $(e){if("array"===e.typeName)return e.elementType=$(e.elementType),e;const t=O(e);return t?{typeName:"union",key:"type",types:t.map((t=>({value:t,type:e})))}:e}function A(e){const t=z(e);return t.types?x(t.types):!t.type&&e.types?x(e.types):$(V(e))}function x(e){if(Array.isArray(e))return{typeName:"array",elementType:x(e[0])};const t=[];for(const r in e.typeMap){const n=e.typeMap[r];t.push({type:G(n),value:W(n)?null:r})}return{typeName:"union",key:"string"==typeof e.key?e.key:"type",types:t}}function B(e){return null!=e&&e.isJSONMapWriter}function I(e,t){const r=D(e);if(B(r.writer)){const e={value:""};return r.writer(t,e,"value"),e.value}return t}function V(e){const t=z(e),r=D(e),n=G(t&&t.type||e.type);return t&&void 0!==t.default&&"function"!=typeof t.default&&(n.default=I(e,t.default)),r.allowNull&&(n.nullable=!0),n}function G(e){return e?a(e)?J(e):Array.isArray(e)?"string"==typeof e[0]||"number"==typeof e[0]?{typeName:"enum",values:e}:e.length>1?{typeName:"union",key:null,types:e.map((e=>({type:G(e),value:null})))}:{typeName:"array",elementType:G(e[0])}:s(e)?_(e):W(e)?{typeName:"native",type:e}:E(e)?{typeName:"json",type:e}:{typeName:"native",type:null}:{typeName:"native",type:null}}function J(e){switch(e.type){case"native":return{typeName:"native",type:e.value};case"array":return{typeName:"array",elementType:G(e.value)};case"one-of":return{typeName:"union",key:null,types:e.values.map((e=>({type:J(e),value:null})))};default:return}}function E(e){let t=e;for(;t;){if(t.prototype&&("esri.core.JSONSupport"===t.prototype.declaredClass||"esri.core.MultiOriginJSONSupport"===t.prototype.declaredClass))return!0;t=Object.getPrototypeOf(t)}return!1}function W(e){return e===String||e===Boolean||e===Number||e===n||e===Object}function z(e){if(!e.json)return null;const t=e.json.origins,r=e.json,n=t&&t["web-scene"],a=t&&t["web-document"];return n||a||r||null}function D(e){if(!e.json)return null;const t=e.json.origins,r=e.json.write,n=t&&t["web-scene"]&&t["web-scene"].write,a=t&&t["web-document"]&&t["web-document"].write;return n||a||r||null}export{d as scan};
