/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{assert as t}from"./assert.js";import{ErrorHandler as e}from"./error-handler.js";import{Messages as s}from"./messages.js";import{Literal as i,Identifier as n,ArrayExpression as r,FunctionExpression as a,AssignmentPattern as o,Property as h,ObjectExpression as c,TemplateElement as l,TemplateLiteral as p,SequenceExpression as m,StaticMemberExpression as d,CallExpression as x,ComputedMemberExpression as u,UpdateExpression as f,UnaryExpression as k,BinaryExpression as g,ConditionalExpression as w,AssignmentExpression as y,BlockStatement as E,VariableDeclarator as v,ArrayPattern as T,ObjectPattern as S,VariableDeclaration as b,EmptyStatement as I,ExpressionStatement as N,IfStatement as P,ForStatement as A,ForInStatement as z,ContinueStatement as C,BreakStatement as U,ReturnStatement as L,FunctionDeclaration as B,Script as M}from"./nodes.js";import{Scanner as R}from"./scanner.js";import{Syntax as G}from"./syntax.js";import{TokenName as F}from"./token.js";const O="ArrowParameterPlaceHolder";class j{constructor(t,s={},i){this.config={range:"boolean"==typeof s.range&&s.range,loc:"boolean"==typeof s.loc&&s.loc,source:null,tokens:"boolean"==typeof s.tokens&&s.tokens,comment:"boolean"==typeof s.comment&&s.comment,tolerant:"boolean"==typeof s.tolerant&&s.tolerant},this.config.loc&&s.source&&null!==s.source&&(this.config.source=String(s.source)),this.delegate=i,this.errorHandler=new e,this.errorHandler.tolerant=this.config.tolerant,this.scanner=new R(t,this.errorHandler),this.scanner.trackComment=this.config.comment,this.operatorPrecedence={")":0,";":0,",":0,"=":0,"]":0,"||":1,"&&":2,"|":3,"^":4,"&":5,"==":6,"!=":6,"===":6,"!==":6,"<":7,">":7,"<=":7,">=":7,"<<":8,">>":8,">>>":8,"+":9,"-":9,"*":11,"/":11,"%":11},this.lookahead={type:2,value:"",lineNumber:this.scanner.lineNumber,lineStart:0,start:0,end:0},this.hasLineTerminator=!1,this.context={isModule:!1,allowIn:!0,allowStrictDirective:!0,firstCoverInitializedNameError:null,isAssignmentTarget:!1,isBindingElement:!1,inFunctionBody:!1,inIteration:!1,inSwitch:!1,labelSet:{},strict:!1},this.tokens=[],this.startMarker={index:0,line:this.scanner.lineNumber,column:0},this.lastMarker={index:0,line:this.scanner.lineNumber,column:0},this.nextToken(),this.lastMarker={index:this.scanner.index,line:this.scanner.lineNumber,column:this.scanner.index-this.scanner.lineStart}}throwError(e,...s){const i=s.slice(),n=e.replace(/%(\d)/g,((e,s)=>(t(s<i.length,"Message reference must be in range"),i[s]))),r=this.lastMarker.index,a=this.lastMarker.line,o=this.lastMarker.column+1;throw this.errorHandler.createError(r,a,o,n)}tolerateError(e,...s){const i=s.slice(),n=e.replace(/%(\d)/g,((e,s)=>(t(s<i.length,"Message reference must be in range"),i[s]))),r=this.lastMarker.index,a=this.scanner.lineNumber,o=this.lastMarker.column+1;this.errorHandler.tolerateError(r,a,o,n)}unexpectedTokenError(t,e){let i,n=e||s.UnexpectedToken;if(t?(e||(n=2===t.type?s.UnexpectedEOS:3===t.type?s.UnexpectedIdentifier:6===t.type?s.UnexpectedNumber:8===t.type?s.UnexpectedString:10===t.type?s.UnexpectedTemplate:s.UnexpectedToken,4===t.type&&(this.scanner.isFutureReservedWord(t.value)?n=s.UnexpectedReserved:this.context.strict&&this.scanner.isStrictModeReservedWord(t.value)&&(n=s.StrictReservedWord))),i=t.value):i="ILLEGAL",n=n.replace("%0",i),t&&"number"==typeof t.lineNumber){const e=t.start,s=t.lineNumber,i=this.lastMarker.index-this.lastMarker.column,r=t.start-i+1;return this.errorHandler.createError(e,s,r,n)}{const t=this.lastMarker.index,e=this.lastMarker.line,s=this.lastMarker.column+1;return this.errorHandler.createError(t,e,s,n)}}throwUnexpectedToken(t,e){throw this.unexpectedTokenError(t,e)}tolerateUnexpectedToken(t,e){this.errorHandler.tolerate(this.unexpectedTokenError(t,e))}collectComments(){if(this.config.comment){const t=this.scanner.scanComments();if(t.length>0&&this.delegate)for(let e=0;e<t.length;++e){const s=t[e],i={type:s.multiLine?"BlockComment":"LineComment",value:this.scanner.source.slice(s.slice[0],s.slice[1])};this.config.range&&(i.range=s.range),this.config.loc&&(i.loc=s.loc);const n={start:{line:s.loc.start.line,column:s.loc.start.column,offset:s.range[0]},end:{line:s.loc.end.line,column:s.loc.end.column,offset:s.range[1]}};this.delegate(i,n)}}else this.scanner.scanComments()}getTokenRaw(t){return this.scanner.source.slice(t.start,t.end)}convertToken(t){const e={type:F[t.type],value:this.getTokenRaw(t)};if(this.config.range&&(e.range=[t.start,t.end]),this.config.loc&&(e.loc={start:{line:this.startMarker.line,column:this.startMarker.column},end:{line:this.scanner.lineNumber,column:this.scanner.index-this.scanner.lineStart}}),9===t.type){const s=t.pattern,i=t.flags;e.regex={pattern:s,flags:i}}return e}nextToken(){const t=this.lookahead;this.lastMarker.index=this.scanner.index,this.lastMarker.line=this.scanner.lineNumber,this.lastMarker.column=this.scanner.index-this.scanner.lineStart,this.collectComments(),this.scanner.index!==this.startMarker.index&&(this.startMarker.index=this.scanner.index,this.startMarker.line=this.scanner.lineNumber,this.startMarker.column=this.scanner.index-this.scanner.lineStart);const e=this.scanner.lex();return this.hasLineTerminator=t.lineNumber!==e.lineNumber,e&&this.context.strict&&3===e.type&&this.scanner.isStrictModeReservedWord(e.value)&&(e.type=4),this.lookahead=e,this.config.tokens&&2!==e.type&&this.tokens.push(this.convertToken(e)),t}nextRegexToken(){this.collectComments();const t=this.scanner.scanRegExp();return this.config.tokens&&(this.tokens.pop(),this.tokens.push(this.convertToken(t))),this.lookahead=t,this.nextToken(),t}createNode(){return{index:this.startMarker.index,line:this.startMarker.line,column:this.startMarker.column}}startNode(t,e=0){let s=t.start-t.lineStart,i=t.lineNumber;return s<0&&(s+=e,i--),{index:t.start,line:i,column:s}}finalize(t,e){if(this.config.range&&(e.range=[t.index,this.lastMarker.index]),this.config.loc&&(e.loc={start:{line:t.line,column:t.column},end:{line:this.lastMarker.line,column:this.lastMarker.column}},this.config.source&&(e.loc.source=this.config.source)),this.delegate){const s={start:{line:t.line,column:t.column,offset:t.index},end:{line:this.lastMarker.line,column:this.lastMarker.column,offset:this.lastMarker.index}};this.delegate(e,s)}return e}expect(t){const e=this.nextToken();7===e.type&&e.value===t||this.throwUnexpectedToken(e)}expectCommaSeparator(){if(this.config.tolerant){const t=this.lookahead;7===t.type&&","===t.value?this.nextToken():7===t.type&&";"===t.value?(this.nextToken(),this.tolerateUnexpectedToken(t)):this.tolerateUnexpectedToken(t,s.UnexpectedToken)}else this.expect(",")}expectKeyword(t){const e=this.nextToken();4===e.type&&e.value.toLowerCase()===t.toLowerCase()||this.throwUnexpectedToken(e)}match(t){return 7===this.lookahead.type&&this.lookahead.value===t}matchKeyword(t){return 4===this.lookahead.type&&this.lookahead.value.toLowerCase()===t.toLowerCase()}matchContextualKeyword(t){return 3===this.lookahead.type&&this.lookahead.value===t}matchAssign(){if(7!==this.lookahead.type)return!1;const t=this.lookahead.value;return"="===t||"*="===t||"**="===t||"/="===t||"%="===t||"+="===t||"-="===t||"<<="===t||">>="===t||">>>="===t||"&="===t||"^="===t||"|="===t}isolateCoverGrammar(t){const e=this.context.isBindingElement,s=this.context.isAssignmentTarget,i=this.context.firstCoverInitializedNameError;this.context.isBindingElement=!0,this.context.isAssignmentTarget=!0,this.context.firstCoverInitializedNameError=null;const n=t.call(this);return null!==this.context.firstCoverInitializedNameError&&this.throwUnexpectedToken(this.context.firstCoverInitializedNameError),this.context.isBindingElement=e,this.context.isAssignmentTarget=s,this.context.firstCoverInitializedNameError=i,n}inheritCoverGrammar(t){const e=this.context.isBindingElement,s=this.context.isAssignmentTarget,i=this.context.firstCoverInitializedNameError;this.context.isBindingElement=!0,this.context.isAssignmentTarget=!0,this.context.firstCoverInitializedNameError=null;const n=t.call(this);return this.context.isBindingElement=this.context.isBindingElement&&e,this.context.isAssignmentTarget=this.context.isAssignmentTarget&&s,this.context.firstCoverInitializedNameError=i||this.context.firstCoverInitializedNameError,n}consumeSemicolon(){this.match(";")?this.nextToken():this.hasLineTerminator||(2===this.lookahead.type||this.match("}")||this.throwUnexpectedToken(this.lookahead),this.lastMarker.index=this.startMarker.index,this.lastMarker.line=this.startMarker.line,this.lastMarker.column=this.startMarker.column)}parsePrimaryExpression(){const t=this.createNode();let e,r,a;switch(this.lookahead.type){case 3:e=this.finalize(t,new n(this.nextToken().value));break;case 6:case 8:this.context.strict&&this.lookahead.octal&&this.tolerateUnexpectedToken(this.lookahead,s.StrictOctalLiteral),this.context.isAssignmentTarget=!1,this.context.isBindingElement=!1,r=this.nextToken(),a=this.getTokenRaw(r),e=this.finalize(t,new i(r.value,a));break;case 1:this.context.isAssignmentTarget=!1,this.context.isBindingElement=!1,r=this.nextToken(),a=this.getTokenRaw(r),e=this.finalize(t,new i("true"===r.value.toLowerCase(),a));break;case 5:this.context.isAssignmentTarget=!1,this.context.isBindingElement=!1,r=this.nextToken(),a=this.getTokenRaw(r),e=this.finalize(t,new i(null,a));break;case 10:e=this.parseTemplateLiteral();break;case 7:switch(this.lookahead.value){case"(":this.context.isBindingElement=!1,e=this.inheritCoverGrammar(this.parseGroupExpression);break;case"[":e=this.inheritCoverGrammar(this.parseArrayInitializer);break;case"{":e=this.inheritCoverGrammar(this.parseObjectInitializer);break;default:e=this.throwUnexpectedToken(this.nextToken())}break;case 4:this.context.isAssignmentTarget=!1,this.context.isBindingElement=!1,e=this.matchKeyword("function")?this.parseFunctionExpression():this.throwUnexpectedToken(this.nextToken());break;default:e=this.throwUnexpectedToken(this.nextToken())}return e}parseArrayInitializer(){const t=this.createNode(),e=[];for(this.expect("[");!this.match("]");)this.match(",")?(this.nextToken(),e.push(null)):(e.push(this.inheritCoverGrammar(this.parseAssignmentExpression)),this.match("]")||this.expect(","));return this.expect("]"),this.finalize(t,new r(e))}parsePropertyMethod(t){this.context.isAssignmentTarget=!1,this.context.isBindingElement=!1;const e=this.context.strict,s=this.context.allowStrictDirective;this.context.allowStrictDirective=t.simple;const i=this.isolateCoverGrammar(this.parseFunctionSourceElements);return this.context.strict&&t.firstRestricted&&this.tolerateUnexpectedToken(t.firstRestricted,t.message),this.context.strict&&t.stricted&&this.tolerateUnexpectedToken(t.stricted,t.message),this.context.strict=e,this.context.allowStrictDirective=s,i}parsePropertyMethodFunction(){const t=!1,e=this.createNode(),s=this.parseFormalParameters(),i=this.parsePropertyMethod(s);return this.finalize(e,new a(null,s.params,i,t))}parseObjectPropertyKey(){const t=this.createNode(),e=this.nextToken();let r;switch(e.type){case 8:case 6:{this.context.strict&&e.octal&&this.tolerateUnexpectedToken(e,s.StrictOctalLiteral);const n=this.getTokenRaw(e);r=this.finalize(t,new i(e.value,n));break}case 3:case 1:case 5:case 4:r=this.finalize(t,new n(e.value));break;case 7:"["===e.value?(r=this.isolateCoverGrammar(this.parseAssignmentExpression),this.expect("]")):r=this.throwUnexpectedToken(e);break;default:r=this.throwUnexpectedToken(e)}return r}isPropertyKey(t,e){return t.type===G.Identifier&&t.name===e||t.type===G.Literal&&t.value===e}parseObjectProperty(t){const e=this.createNode(),i=this.lookahead;let r,a=null,c=null,l=!1,p=!1,m=!1,d=!1;if(3===i.type){const t=i.value;this.nextToken(),l=this.match("["),d=!(this.hasLineTerminator||"async"!==t||this.match(":")||this.match("(")||this.match("*")||this.match(",")),a=d?this.parseObjectPropertyKey():this.finalize(e,new n(t))}else this.match("*")?this.nextToken():(l=this.match("["),a=this.parseObjectPropertyKey());if(a||this.throwUnexpectedToken(this.lookahead),r="init",this.match(":")&&!d)!l&&this.isPropertyKey(a,"__proto__")&&(t.value&&this.tolerateError(s.DuplicateProtoProperty),t.value=!0),this.nextToken(),c=this.inheritCoverGrammar(this.parseAssignmentExpression);else if(this.match("("))c=this.parsePropertyMethodFunction(),p=!0;else if(3===i.type){const t=this.finalize(e,new n(i.value));if(this.match("=")){this.context.firstCoverInitializedNameError=this.lookahead,this.nextToken(),m=!0;const s=this.isolateCoverGrammar(this.parseAssignmentExpression);c=this.finalize(e,new o(t,s))}else m=!0,c=t}else this.throwUnexpectedToken(this.nextToken());return this.finalize(e,new h(r,a,l,c,p,m))}parseObjectInitializer(){const t=this.createNode();this.expect("{");const e=[],s={value:!1};for(;!this.match("}");)e.push(this.parseObjectProperty(s)),this.match("}")||this.expectCommaSeparator();return this.expect("}"),this.finalize(t,new c(e))}parseTemplateHead(){t(this.lookahead.head,"Template literal must start with a template head");const e=this.createNode(),s=this.nextToken(),i=s.value,n=s.cooked;return this.finalize(e,new l({raw:i,cooked:n},s.tail))}parseTemplateElement(){10!==this.lookahead.type&&this.throwUnexpectedToken();const t=this.createNode(),e=this.nextToken(),s=e.value,i=e.cooked;return this.finalize(t,new l({raw:s,cooked:i},e.tail))}parseTemplateLiteral(){const t=this.createNode(),e=[],s=[];let i=this.parseTemplateHead();for(s.push(i);!i.tail;)e.push(this.parseExpression()),i=this.parseTemplateElement(),s.push(i);return this.finalize(t,new p(s,e))}reinterpretExpressionAsPattern(t){switch(t.type){case G.Identifier:case G.MemberExpression:case G.AssignmentPattern:break;case G.ArrayExpression:t.type=G.ArrayPattern;for(let e=0;e<t.elements.length;e++)null!==t.elements[e]&&this.reinterpretExpressionAsPattern(t.elements[e]);break;case G.ObjectExpression:t.type=G.ObjectPattern;for(let e=0;e<t.properties.length;e++){const s=t.properties[e];this.reinterpretExpressionAsPattern(s.value)}break;case G.AssignmentExpression:t.type=G.AssignmentPattern,delete t.operator,this.reinterpretExpressionAsPattern(t.left)}}parseGroupExpression(){let t;if(this.expect("("),this.match(")"))this.nextToken(),this.match("=>")||this.expect("=>"),t={type:O,params:[],async:!1};else{const e=this.lookahead;let s=!1;if(this.context.isBindingElement=!0,t=this.inheritCoverGrammar(this.parseAssignmentExpression),this.match(",")){const i=[];for(this.context.isAssignmentTarget=!1,i.push(t);2!==this.lookahead.type&&this.match(",");){if(this.nextToken(),this.match(")")){this.nextToken();for(let t=0;t<i.length;t++)this.reinterpretExpressionAsPattern(i[t]);s=!0,t={type:O,params:i,async:!1}}else i.push(this.inheritCoverGrammar(this.parseAssignmentExpression));if(s)break}s||(t=this.finalize(this.startNode(e),new m(i)))}if(!s){if(this.expect(")"),this.match("=>")&&(t.type===G.Identifier&&"yield"===t.name&&(s=!0,t={type:O,params:[t],async:!1}),!s)){if(this.context.isBindingElement||this.throwUnexpectedToken(this.lookahead),t.type===G.SequenceExpression)for(let s=0;s<t.expressions.length;s++)this.reinterpretExpressionAsPattern(t.expressions[s]);else this.reinterpretExpressionAsPattern(t);const e=t.type===G.SequenceExpression?t.expressions:[t];t={type:O,params:e,async:!1}}this.context.isBindingElement=!1}}return t}parseArguments(){this.expect("(");const t=[];if(!this.match(")"))for(;;){const e=this.isolateCoverGrammar(this.parseAssignmentExpression);if(t.push(e),this.match(")"))break;if(this.expectCommaSeparator(),this.match(")"))break}return this.expect(")"),t}isIdentifierName(t){return 3===t.type||4===t.type||1===t.type||5===t.type}parseIdentifierName(){const t=this.createNode(),e=this.nextToken();return this.isIdentifierName(e)||this.throwUnexpectedToken(e),this.finalize(t,new n(e.value))}parseLeftHandSideExpressionAllowCall(){const t=this.lookahead,e=this.context.allowIn;let s;for(this.context.allowIn=!0,s=this.inheritCoverGrammar(this.parsePrimaryExpression);;)if(this.match(".")){this.context.isBindingElement=!1,this.context.isAssignmentTarget=!0,this.expect(".");const e=this.parseIdentifierName();s=this.finalize(this.startNode(t),new d(s,e))}else if(this.match("(")){this.context.isBindingElement=!1,this.context.isAssignmentTarget=!1;const e=this.parseArguments();s=this.finalize(this.startNode(t),new x(s,e))}else{if(!this.match("["))break;{this.context.isBindingElement=!1,this.context.isAssignmentTarget=!0,this.expect("[");const e=this.isolateCoverGrammar(this.parseExpression);this.expect("]"),s=this.finalize(this.startNode(t),new u(s,e))}}return this.context.allowIn=e,s}parseLeftHandSideExpression(){t(this.context.allowIn,"callee of new expression always allow in keyword.");const e=this.startNode(this.lookahead);let s=this.inheritCoverGrammar(this.parsePrimaryExpression);for(;;)if(this.match("[")){this.context.isBindingElement=!1,this.context.isAssignmentTarget=!0,this.expect("[");const t=this.isolateCoverGrammar(this.parseExpression);this.expect("]"),s=this.finalize(e,new u(s,t))}else{if(!this.match("."))break;{this.context.isBindingElement=!1,this.context.isAssignmentTarget=!0,this.expect(".");const t=this.parseIdentifierName();s=this.finalize(e,new d(s,t))}}return s}parseUpdateExpression(){let t;const e=this.lookahead;if(this.match("++")||this.match("--")){const i=this.startNode(e),n=this.nextToken();t=this.inheritCoverGrammar(this.parseUnaryExpression),this.context.strict&&t.type===G.Identifier&&this.scanner.isRestrictedWord(t.name)&&this.tolerateError(s.StrictLHSPrefix),this.context.isAssignmentTarget||this.tolerateError(s.InvalidLHSInAssignment);const r=!0;t=this.finalize(i,new f(n.value,t,r)),this.context.isAssignmentTarget=!1,this.context.isBindingElement=!1}else if(t=this.inheritCoverGrammar(this.parseLeftHandSideExpressionAllowCall),!this.hasLineTerminator&&7===this.lookahead.type&&(this.match("++")||this.match("--"))){this.context.strict&&t.type===G.Identifier&&this.scanner.isRestrictedWord(t.name)&&this.tolerateError(s.StrictLHSPostfix),this.context.isAssignmentTarget||this.tolerateError(s.InvalidLHSInAssignment),this.context.isAssignmentTarget=!1,this.context.isBindingElement=!1;const i=this.nextToken().value,n=!1;t=this.finalize(this.startNode(e),new f(i,t,n))}return t}parseUnaryExpression(){let t;if(this.match("+")||this.match("-")||this.match("~")||this.match("!")||this.matchKeyword("delete")||this.matchKeyword("void")||this.matchKeyword("typeof")){const e=this.startNode(this.lookahead),i=this.nextToken();t=this.inheritCoverGrammar(this.parseUnaryExpression),t=this.finalize(e,new k(i.value,t)),this.context.strict&&"delete"===t.operator&&t.argument.type===G.Identifier&&this.tolerateError(s.StrictDelete),this.context.isAssignmentTarget=!1,this.context.isBindingElement=!1}else t=this.parseUpdateExpression();return t}parseExponentiationExpression(){const t=this.lookahead;let e=this.inheritCoverGrammar(this.parseUnaryExpression);if(e.type!==G.UnaryExpression&&this.match("**")){this.nextToken(),this.context.isAssignmentTarget=!1,this.context.isBindingElement=!1;const s=e,i=this.isolateCoverGrammar(this.parseExponentiationExpression);e=this.finalize(this.startNode(t),new g("**",s,i))}return e}binaryPrecedence(t){const e=t.value;let s;return s=7===t.type?this.operatorPrecedence[e]||0:4===t.type&&("instanceof"===e||this.context.allowIn&&"in"===e)?7:0,s}parseBinaryExpression(){const t=this.lookahead;let e=this.inheritCoverGrammar(this.parseExponentiationExpression);const s=this.lookahead;let i=this.binaryPrecedence(s);if(i>0){this.nextToken(),this.context.isAssignmentTarget=!1,this.context.isBindingElement=!1;const n=[t,this.lookahead];let r=e,a=this.isolateCoverGrammar(this.parseExponentiationExpression);const o=[r,s.value,a],h=[i];for(;i=this.binaryPrecedence(this.lookahead),!(i<=0);){for(;o.length>2&&i<=h[h.length-1];){a=o.pop();const t=o.pop();h.pop(),r=o.pop(),n.pop();const e=n[n.length-1],s=this.startNode(e,e.lineStart);o.push(this.finalize(s,new g(t,r,a)))}o.push(this.nextToken().value),h.push(i),n.push(this.lookahead),o.push(this.isolateCoverGrammar(this.parseExponentiationExpression))}let c=o.length-1;e=o[c];let l=n.pop();for(;c>1;){const t=n.pop(),s=l&&l.lineStart,i=this.startNode(t,s),r=o[c-1];e=this.finalize(i,new g(r,o[c-2],e)),c-=2,l=t}}return e}parseConditionalExpression(){const t=this.lookahead;let e=this.inheritCoverGrammar(this.parseBinaryExpression);if(this.match("?")){this.nextToken();const s=this.context.allowIn;this.context.allowIn=!0;const i=this.isolateCoverGrammar(this.parseAssignmentExpression);this.context.allowIn=s,this.expect(":");const n=this.isolateCoverGrammar(this.parseAssignmentExpression);e=this.finalize(this.startNode(t),new w(e,i,n)),this.context.isAssignmentTarget=!1,this.context.isBindingElement=!1}return e}checkPatternParam(t,e){switch(e.type){case G.Identifier:this.validateParam(t,e,e.name);break;case G.AssignmentPattern:this.checkPatternParam(t,e.left);break;case G.ArrayPattern:for(let s=0;s<e.elements.length;s++)null!==e.elements[s]&&this.checkPatternParam(t,e.elements[s]);break;case G.ObjectPattern:for(let s=0;s<e.properties.length;s++){const i=e.properties[s];this.checkPatternParam(t,i.value)}}t.simple=t.simple&&e instanceof n}reinterpretAsCoverFormalsList(t){const e=[t],i={simple:!0,paramSet:{}};switch(t.type){case G.Identifier:break;default:return null}for(let s=0;s<e.length;++s){const t=e[s];this.checkPatternParam(i,t),e[s]=t}if(i.message===s.StrictParamDupe){const t=this.context.strict?i.stricted:i.firstRestricted;this.throwUnexpectedToken(t,i.message)}return{simple:i.simple,params:e,stricted:i.stricted,firstRestricted:i.firstRestricted,message:i.message}}parseAssignmentExpression(){let t;const e=this.lookahead;let i=e;if(t=this.parseConditionalExpression(),this.matchAssign()){if(this.context.isAssignmentTarget||this.tolerateError(s.InvalidLHSInAssignment),this.context.strict&&t.type===G.Identifier){const e=t;this.scanner.isRestrictedWord(e.name)&&this.tolerateUnexpectedToken(i,s.StrictLHSAssignment),this.scanner.isStrictModeReservedWord(e.name)&&this.tolerateUnexpectedToken(i,s.StrictReservedWord)}this.match("=")?this.reinterpretExpressionAsPattern(t):(this.context.isAssignmentTarget=!1,this.context.isBindingElement=!1),i=this.nextToken();const n=i.value,r=this.isolateCoverGrammar(this.parseAssignmentExpression);t=this.finalize(this.startNode(e),new y(n,t,r)),this.context.firstCoverInitializedNameError=null}return t}parseExpression(){const t=this.lookahead;let e=this.isolateCoverGrammar(this.parseAssignmentExpression);if(this.match(",")){const s=[];for(s.push(e);2!==this.lookahead.type&&this.match(",");)this.nextToken(),s.push(this.isolateCoverGrammar(this.parseAssignmentExpression));e=this.finalize(this.startNode(t),new m(s))}return e}parseStatementListItem(){let t;if(this.context.isAssignmentTarget=!0,this.context.isBindingElement=!0,4===this.lookahead.type)switch(this.lookahead.value){case"function":t=this.parseFunctionDeclaration();break;default:t=this.parseStatement()}else t=this.parseStatement();return t}parseBlock(){const t=this.createNode();this.expect("{");const e=[];for(;!this.match("}");)e.push(this.parseStatementListItem());return this.expect("}"),this.finalize(t,new E(e))}parseBlockOrObjectInitialiser(){const t=this.createNode();if(this.expect("{"),3===this.lookahead.type||8===this.lookahead.type){const e=this.scanner.saveState();this.scanner.scanComments();const s=this.scanner.lex();if(this.scanner.restoreState(e),7===s.type&&":"===s.value){const e=[],s={value:!1};for(;!this.match("}");)e.push(this.parseObjectProperty(s)),this.match("}")||this.expectCommaSeparator();return this.expect("}"),this.finalize(t,new c(e))}}const e=[];for(;!this.match("}");)e.push(this.parseStatementListItem());return this.expect("}"),this.finalize(t,new E(e))}parseLexicalBinding(t,e){const i=this.createNode(),n=[],r=this.parsePattern(n,t);this.context.strict&&r.type===G.Identifier&&this.scanner.isRestrictedWord(r.name)&&this.tolerateError(s.StrictVarName);let a=null;return(!e.inFor&&r.type!==G.Identifier||this.match("="))&&(this.expect("="),a=this.isolateCoverGrammar(this.parseAssignmentExpression)),this.finalize(i,new v(r,a))}parseBindingList(t,e){const s=[this.parseLexicalBinding(t,e)];for(;this.match(",");)this.nextToken(),s.push(this.parseLexicalBinding(t,e));return s}parseArrayPattern(t,e){const s=this.createNode();this.expect("[");const i=[];for(;!this.match("]");)this.match(",")?(this.nextToken(),i.push(null)):(i.push(this.parsePatternWithDefault(t,e)),this.match("]")||this.expect(","));return this.expect("]"),this.finalize(s,new T(i))}parsePropertyPattern(t,e){const s=this.createNode();let i=!1,r=!1;const a=!1;let c,l;if(3===this.lookahead.type){const i=this.lookahead;c=this.parseVariableIdentifier();const a=this.finalize(s,new n(i.value));if(this.match("=")){t.push(i),r=!0,this.nextToken();const e=this.parseAssignmentExpression();l=this.finalize(this.startNode(i),new o(a,e))}else this.match(":")?(this.expect(":"),l=this.parsePatternWithDefault(t,e)):(t.push(i),r=!0,l=a)}else i=this.match("["),c=this.parseObjectPropertyKey(),this.expect(":"),l=this.parsePatternWithDefault(t,e);return this.finalize(s,new h("init",c,i,l,a,r))}parseObjectPattern(t,e){const s=this.createNode(),i=[];for(this.expect("{");!this.match("}");)i.push(this.parsePropertyPattern(t,e)),this.match("}")||this.expect(",");return this.expect("}"),this.finalize(s,new S(i))}parsePattern(t,e){let i;return this.match("[")?i=this.parseArrayPattern(t,e):this.match("{")?i=this.parseObjectPattern(t,e):(!this.matchKeyword("let")||"const"!==e&&"let"!==e||this.tolerateUnexpectedToken(this.lookahead,s.LetInLexicalBinding),t.push(this.lookahead),i=this.parseVariableIdentifier(e)),i}parsePatternWithDefault(t,e){const s=this.lookahead;let i=this.parsePattern(t,e);if(this.match("=")){this.nextToken();const t=this.isolateCoverGrammar(this.parseAssignmentExpression);i=this.finalize(this.startNode(s),new o(i,t))}return i}parseVariableIdentifier(t){const e=this.createNode(),i=this.nextToken();return 3!==i.type&&(this.context.strict&&4===i.type&&this.scanner.isStrictModeReservedWord(i.value)?this.tolerateUnexpectedToken(i,s.StrictReservedWord):(this.context.strict||"let"!==i.value||"var"!==t)&&this.throwUnexpectedToken(i)),this.finalize(e,new n(i.value))}parseVariableDeclaration(t){const e=this.createNode(),i=[],n=this.parsePattern(i,"var");this.context.strict&&n.type===G.Identifier&&this.scanner.isRestrictedWord(n.name)&&this.tolerateError(s.StrictVarName);let r=null;return this.match("=")?(this.nextToken(),r=this.isolateCoverGrammar(this.parseAssignmentExpression)):n.type===G.Identifier||t.inFor||this.expect("="),this.finalize(e,new v(n,r))}parseVariableDeclarationList(t){const e={inFor:t.inFor},s=[];for(s.push(this.parseVariableDeclaration(e));this.match(",");)this.nextToken(),s.push(this.parseVariableDeclaration(e));return s}parseVariableStatement(){const t=this.createNode();this.expectKeyword("var");const e=this.parseVariableDeclarationList({inFor:!1});return this.consumeSemicolon(),this.finalize(t,new b(e,"var"))}parseEmptyStatement(){const t=this.createNode();return this.expect(";"),this.finalize(t,new I)}parseExpressionStatement(){const t=this.createNode(),e=this.parseExpression();return this.consumeSemicolon(),this.finalize(t,new N(e))}parseIfClause(){return this.context.strict&&this.matchKeyword("function")&&this.tolerateError(s.StrictFunction),this.parseStatement(!0)}parseIfStatement(){const t=this.createNode();let e,s=null;this.expectKeyword("if"),this.expect("(");const i=this.parseExpression();return!this.match(")")&&this.config.tolerant?(this.tolerateUnexpectedToken(this.nextToken()),e=this.finalize(this.createNode(),new I)):(this.expect(")"),e=this.parseIfClause(),this.matchKeyword("else")&&(this.nextToken(),s=this.parseIfClause())),this.finalize(t,new P(i,e,s))}parseForStatement(){let t,e,i=null,n=null,r=null;const a=this.createNode();if(this.expectKeyword("for"),this.expect("("),this.match(";"))this.nextToken();else if(this.matchKeyword("var")){i=this.createNode(),this.nextToken();const n=this.context.allowIn;this.context.allowIn=!1;const r=this.parseVariableDeclarationList({inFor:!0});if(this.context.allowIn=n,1===r.length&&this.matchKeyword("in")){const n=r[0];n.init&&(n.id.type===G.ArrayPattern||n.id.type===G.ObjectPattern||this.context.strict)&&this.tolerateError(s.ForInOfLoopInitializer,"for-in"),i=this.finalize(i,new b(r,"var")),this.nextToken(),t=i,e=this.parseExpression(),i=null}else 1===r.length&&null===r[0].init&&this.matchContextualKeyword("of")?(i=this.finalize(i,new b(r,"var")),this.nextToken(),t=i,e=this.parseAssignmentExpression(),i=null):(i=this.finalize(i,new b(r,"var")),this.expect(";"))}else{const n=this.lookahead,r=this.context.isBindingElement,a=this.context.isAssignmentTarget,o=this.context.firstCoverInitializedNameError,h=this.context.allowIn;if(this.context.allowIn=!1,i=this.inheritCoverGrammar(this.parseAssignmentExpression),this.context.allowIn=h,this.matchKeyword("in"))this.context.isAssignmentTarget&&i.type!==G.AssignmentExpression||this.tolerateError(s.InvalidLHSInForIn),this.nextToken(),this.reinterpretExpressionAsPattern(i),t=i,e=this.parseExpression(),i=null;else{if(this.context.isBindingElement=r,this.context.isAssignmentTarget=a,this.context.firstCoverInitializedNameError=o,this.match(",")){const t=[i];for(;this.match(",");)this.nextToken(),t.push(this.isolateCoverGrammar(this.parseAssignmentExpression));i=this.finalize(this.startNode(n),new m(t))}this.expect(";")}}let o;if(void 0===t&&(this.match(";")||(n=this.isolateCoverGrammar(this.parseExpression)),this.expect(";"),this.match(")")||(r=this.isolateCoverGrammar(this.parseExpression))),!this.match(")")&&this.config.tolerant)this.tolerateUnexpectedToken(this.nextToken()),o=this.finalize(this.createNode(),new I);else{this.expect(")");const t=this.context.inIteration;this.context.inIteration=!0,o=this.isolateCoverGrammar(this.parseStatementBlockAllowed),this.context.inIteration=t}return void 0===t?this.finalize(a,new A(i,n,r,o)):this.finalize(a,new z(t,e,o))}parseContinueStatement(){const t=this.createNode();this.expectKeyword("continue");let e=null;if(3===this.lookahead.type&&!this.hasLineTerminator){const t=this.parseVariableIdentifier();e=t;const i="$"+t.name;Object.prototype.hasOwnProperty.call(this.context.labelSet,i)||this.throwError(s.UnknownLabel,t.name)}return this.consumeSemicolon(),null!==e||this.context.inIteration||this.throwError(s.IllegalContinue),this.finalize(t,new C(e))}parseBreakStatement(){const t=this.createNode();this.expectKeyword("break");let e=null;if(3===this.lookahead.type&&!this.hasLineTerminator){const t=this.parseVariableIdentifier(),i="$"+t.name;Object.prototype.hasOwnProperty.call(this.context.labelSet,i)||this.throwError(s.UnknownLabel,t.name),e=t}return this.consumeSemicolon(),null!==e||this.context.inIteration||this.context.inSwitch||this.throwError(s.IllegalBreak),this.finalize(t,new U(e))}parseReturnStatement(){this.context.inFunctionBody||this.tolerateError(s.IllegalReturn);const t=this.createNode();this.expectKeyword("return");const e=!this.match(";")&&!this.match("}")&&!this.hasLineTerminator&&2!==this.lookahead.type||8===this.lookahead.type||10===this.lookahead.type?this.parseExpression():null;return this.consumeSemicolon(),this.finalize(t,new L(e))}parseLabelledStatement(){const t=this.createNode(),e=this.parseExpression();let s;return this.consumeSemicolon(),s=new N(e),this.finalize(t,s)}parseStatementBlockAllowed(){return this.parseStatement(!0)}parseStatement(t=!1){let e;switch(this.lookahead.type){case 1:case 5:case 6:case 8:case 10:case 9:e=this.parseExpressionStatement();break;case 7:{const s=this.lookahead.value;e="{"===s?t?this.parseBlockOrObjectInitialiser():this.parseObjectInitializer():"("===s?this.parseExpressionStatement():";"===s?this.parseEmptyStatement():this.parseExpressionStatement();break}case 3:e=this.parseLabelledStatement();break;case 4:switch(this.lookahead.value.toLowerCase()){case"break":e=this.parseBreakStatement();break;case"continue":e=this.parseContinueStatement();break;case"for":e=this.parseForStatement();break;case"function":e=this.parseFunctionDeclaration();break;case"if":e=this.parseIfStatement();break;case"return":e=this.parseReturnStatement();break;case"var":e=this.parseVariableStatement();break;default:e=this.parseExpressionStatement()}break;default:e=this.throwUnexpectedToken(this.lookahead)}return e}parseFunctionSourceElements(){const t=this.createNode();this.expect("{");const e=[],s=this.context.labelSet,i=this.context.inIteration,n=this.context.inSwitch,r=this.context.inFunctionBody;for(this.context.labelSet={},this.context.inIteration=!1,this.context.inSwitch=!1,this.context.inFunctionBody=!0;2!==this.lookahead.type&&!this.match("}");)e.push(this.parseStatementListItem());return this.expect("}"),this.context.labelSet=s,this.context.inIteration=i,this.context.inSwitch=n,this.context.inFunctionBody=r,this.finalize(t,new E(e))}validateParam(t,e,i){const n="$"+i;this.context.strict?(this.scanner.isRestrictedWord(i)&&(t.stricted=e,t.message=s.StrictParamName),Object.prototype.hasOwnProperty.call(t.paramSet,n)&&(t.stricted=e,t.message=s.StrictParamDupe)):t.firstRestricted||(this.scanner.isRestrictedWord(i)?(t.firstRestricted=e,t.message=s.StrictParamName):this.scanner.isStrictModeReservedWord(i)?(t.firstRestricted=e,t.message=s.StrictReservedWord):Object.prototype.hasOwnProperty.call(t.paramSet,n)&&(t.stricted=e,t.message=s.StrictParamDupe)),"function"==typeof Object.defineProperty?Object.defineProperty(t.paramSet,n,{value:!0,enumerable:!0,writable:!0,configurable:!0}):t.paramSet[n]=!0}parseFormalParameter(t){const e=[],s=this.parsePatternWithDefault(e);for(let i=0;i<e.length;i++)this.validateParam(t,e[i],e[i].value);t.simple=t.simple&&s instanceof n,t.params.push(s)}parseFormalParameters(t){const e={simple:!0,params:[],firstRestricted:t};if(this.expect("("),!this.match(")"))for(e.paramSet={};2!==this.lookahead.type&&(this.parseFormalParameter(e),!this.match(")"))&&(this.expect(","),!this.match(")")););return this.expect(")"),{simple:e.simple,params:e.params,stricted:e.stricted,firstRestricted:e.firstRestricted,message:e.message}}parseFunctionDeclaration(t){const e=this.createNode();let i;this.expectKeyword("function");let n=null,r=null;if(!t||!this.match("(")){const t=this.lookahead;n=this.parseVariableIdentifier(),this.context.strict?this.scanner.isRestrictedWord(t.value)&&this.tolerateUnexpectedToken(t,s.StrictFunctionName):this.scanner.isRestrictedWord(t.value)?(r=t,i=s.StrictFunctionName):this.scanner.isStrictModeReservedWord(t.value)&&(r=t,i=s.StrictReservedWord)}const a=this.parseFormalParameters(r),o=a.params,h=a.stricted;r=a.firstRestricted,a.message&&(i=a.message);const c=this.context.strict,l=this.context.allowStrictDirective;this.context.allowStrictDirective=a.simple;const p=this.parseFunctionSourceElements();return this.context.strict&&r&&this.throwUnexpectedToken(r,i),this.context.strict&&h&&this.tolerateUnexpectedToken(h,i),this.context.strict=c,this.context.allowStrictDirective=l,this.finalize(e,new B(n,o,p,!1))}parseFunctionExpression(){const t=this.createNode();let e;this.expectKeyword("function");let i,n=null;if(!this.match("(")){const t=this.lookahead;n=this.parseVariableIdentifier(),this.context.strict?this.scanner.isRestrictedWord(t.value)&&this.tolerateUnexpectedToken(t,s.StrictFunctionName):this.scanner.isRestrictedWord(t.value)?(i=t,e=s.StrictFunctionName):this.scanner.isStrictModeReservedWord(t.value)&&(i=t,e=s.StrictReservedWord)}const r=this.parseFormalParameters(i),o=r.params,h=r.stricted;i=r.firstRestricted,r.message&&(e=r.message);const c=this.context.strict,l=this.context.allowStrictDirective;this.context.allowStrictDirective=r.simple;const p=this.parseFunctionSourceElements();return this.context.strict&&i&&this.throwUnexpectedToken(i,e),this.context.strict&&h&&this.tolerateUnexpectedToken(h,e),this.context.strict=c,this.context.allowStrictDirective=l,this.finalize(t,new a(n,o,p,!1))}qualifiedPropertyName(t){switch(t.type){case 3:case 8:case 1:case 5:case 6:case 4:return!0;case 7:return"["===t.value}return!1}isStartOfExpression(){let t=!0;const e=this.lookahead.value;switch(this.lookahead.type){case 7:t="["===e||"("===e||"{"===e||"+"===e||"-"===e||"!"===e||"~"===e||"++"===e||"--"===e||"/"===e||"/="===e;break;case 4:t="class"===e||"delete"===e||"function"===e||"let"===e||"new"===e||"super"===e||"this"===e||"typeof"===e||"void"===e||"yield"===e}return t}parseScript(){const t=this.createNode(),e=[];for(;2!==this.lookahead.type;)e.push(this.parseStatementListItem());return this.finalize(t,new M(e))}}export{j as Parser};
