/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{isFinite as e}from"../../../core/mathUtils.js";import{loadArcade as t}from"../../../support/arcadeOnDemand.js";function n(t,n=!0,i=!0){return e(t)&&(n||0!==t)&&(i||t>=0)}async function i(e){const{features:i,attributes:s,includeZeros:o,includeNegatives:c,view:l}=e;let a=0,r=0,f=1/0,u=-1/0,p=null;const d=new Map;for(let n=0;n<s.length;n++){const{valueExpression:e}=s[n];if(e){if(!p){const{arcadeUtils:e}=await t();p=e}d.set(n,p.createFunction(e))}}const g=l&&p&&p.getViewInfo({viewingMode:"2d"===l.type?"map":l.viewingMode,scale:l.scale,spatialReference:l.spatialReference});for(const t of i){const e=t.geometry,i=t.attributes;if(e){const l=e.extent;if(l){const e=l.width*l.height;if(e>0){let l=0;const m=p&&p.createExecContext(t,g);for(let e=0;e<s.length;e++){const{field:t,valueExpression:a}=s[e];let r=null;if(t)r=i[t];else if(a){const t=d.get(e);r=p.executeFunction(t,m)}n(r,o,c)&&(l+=r||0)}if(n(l,o,c)){const t=l/e;++a,r+=t,t<f&&(f=t),t>u&&(u=t)}}}}}return{minDensity:f!==1/0?f:null,maxDensity:u!==-1/0?u:null,avgDensity:a?r/a:null}}export default i;
