/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import i from"../../core/Error.js";import{isSome as e}from"../../core/maybe.js";import{isDateField as r,numericTypes as s}from"../../layers/support/fieldUtils.js";import{verifyBasicFieldValidity as a,verifyFieldType as o}from"./support/utils.js";import{getNormalizationType as t,getFieldsList as n}from"../support/utils.js";import{createLayerAdapter as l,getLayerTypeLabels as p}from"../support/adapters/support/layerUtils.js";const m=["date",...s];async function d(s){if(!(s&&s.layer&&(s.field||s.valueExpression||s.sqlExpression)))throw new i("histogram:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(s.valueExpression&&!s.sqlExpression&&!s.view)throw new i("histogram:missing-parameters","View is required when 'valueExpression' is specified");const d=[0,2,1,3,4,5],{layer:f,...h}=s,u=l(f,d),w={layerAdapter:u,...h};if(w.normalizationType=t(w),!u)throw new i("histogram:invalid-parameters","'layer' must be one of these types: "+p(d).join(", "));const c=e(w.signal)?{signal:w.signal}:null;await u.load(c);const v=w.valueExpression||w.sqlExpression,g=w.field,x=g?u.getField(g):null,E=!w.classificationMethod||"equal-interval"===w.classificationMethod,y=await n({field:g,normalizationField:w.normalizationField,valueExpression:w.valueExpression}),q=a(u,y,"histogram:invalid-parameters");if(q)throw q;if(x){const e=o(u,x,"histogram:invalid-parameters",m);if(e)throw e;if(r(x)){if(w.normalizationType)throw new i("histogram:invalid-parameters","Normalization is not allowed for date fields");if(!E)throw new i("histogram:invalid-parameters","'classificationMethod' other than 'equal-interval' is not allowed for date fields")}}else if(v){if(w.normalizationType)throw new i("histogram:invalid-parameters","Normalization is not allowed when 'valueExpression' or 'sqlExpression' is specified");if(!E)throw new i("histogram:invalid-parameters","'classificationMethod' other than 'equal-interval' is not allowed when 'valueExpression' or 'sqlExpression' is specified")}return w}async function f(i){const{layerAdapter:e,...r}=await d(i);return e.histogram(r)}export default f;
