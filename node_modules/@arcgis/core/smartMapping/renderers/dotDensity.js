/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/DictionaryRenderer.js";import e from"../../renderers/DotDensityRenderer.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../renderers/support/jsonUtils.js";import t from"../../core/Error.js";import{isSome as r}from"../../core/maybe.js";import{getResolutionForScale as i}from"../../geometry/support/scaleUtils.js";import a from"../../renderers/support/AuthoringInfo.js";import s from"../heuristics/outline.js";import{roundValue as n}from"./support/dotDensityUtils.js";import{createColors as l,getSymbolOutlineFromScheme as o,getBasemapInfo as d}from"./support/utils.js";import m from"../statistics/spatialStatistics.js";import u from"../statistics/summaryStatisticsForAttributes.js";import p from"../statistics/support/attributeDensity.js";import{getFieldsList as c}from"../support/utils.js";import{createLayerAdapter as y,getLayerTypeLabels as f}from"../support/adapters/support/layerUtils.js";import{c as b,g}from"../../chunks/dotDensity.js";const w=500;async function v(e){if(!(e&&e.layer&&e.view&&e.attributes&&e.attributes.length))throw new t("dot-density-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(e.attributes.length>8)throw new t("dot-density-renderer:invalid-parameters","Dot density renderer does not support more than 8 attributes");const i={...e},a=[2,1,5],s=y(i.layer,a);if(i.layer=s,i.dotBlendingEnabled=null==i.dotBlendingEnabled||i.dotBlendingEnabled,i.dotValueOptimizationEnabled=null==i.dotValueOptimizationEnabled||i.dotValueOptimizationEnabled,!s)throw new t("dot-density-renderer:invalid-parameters","'layer' must be one of these types: "+f(a).join(", "));const n=r(i.signal)?{signal:i.signal}:null;await Promise.all([i.view.when(),s.load(n)]);if("polygon"!==s.geometryType)throw new t("dot-density-renderer:not-supported","Dot density renderer is supported for polygon layers only");return i}async function h(e){let t=e.dotDensityScheme,i=null,a=null;const s=await d(e.basemap,e.view);if(i=r(s.basemapId)?s.basemapId:null,a=r(s.basemapTheme)?s.basemapTheme:null,t)return{scheme:b(t),basemapId:i,basemapTheme:a};const n=g({basemap:i,numColors:e.attributes.length,basemapTheme:a});return n&&(t=n.primaryScheme,i=n.basemapId,a=n.basemapTheme),{scheme:t,basemapId:i,basemapTheme:a}}async function S(e){const{view:r,layer:a,attributes:s,signal:l}=e,o=await a.getSampleFeatures({view:r,sampleSize:w,returnGeometry:!0,signal:l}),[d,p]=await Promise.all([m({features:o,geometryType:a.geometryType}),u({layer:a,attributes:s,includeZeros:!1,includeNegatives:!1,view:r,signal:l})]),c="avgSize"in d&&d.avgSize,y=p.avg;if(!c)throw new t("dot-density-renderer:insufficient-info","Average polygon size is invalid");if(!y)throw new t("dot-density-renderer:insufficient-info","Average attribute value is invalid");const f=i(r.scale,r.spatialReference);return{dotValue:n(y/(c*c/(f*f)*.1))||1,referenceScale:r.scale,minSliderValue:1,maxSliderValue:n(y)}}async function j(e){const{view:r,layer:a,attributes:s,signal:l}=e,o=[];for(const t of s){const e=await c({field:t.field,valueExpression:t.valueExpression});o.push(...e)}const d=await a.getSampleFeatures({view:r,sampleSize:w,requiredFields:o,returnGeometry:!0,signal:l}),m=await p({features:d,attributes:s,includeZeros:!1,includeNegatives:!1,view:r});if(!m.avgDensity||!m.minDensity||!m.maxDensity)throw new t("dot-density-renderer:insufficient-info","Invalid density values");const u=i(r.scale,r.spatialReference),y=u*u,f=n(m.minDensity*y),b=n(m.maxDensity*y),g=10;let v=n(m.avgDensity*y*g)||1;return v>b&&(v=b),{dotValue:v,referenceScale:r.scale,minSliderValue:f,maxSliderValue:b}}async function V(r){const i=await v(r),n=i.layer,d=n.geometryType,m=await h(i),u=m&&m.scheme;if(!u)throw new t("dot-density-renderer:insufficient-info","Unable to find dot-density scheme");const p={layer:n,view:i.view,attributes:i.attributes,signal:i.signal},c={layer:i.layer,view:i.view,signal:i.signal},[y,f]=await Promise.all([i.trueDensity?j(p):S(p),i.outlineOptimizationEnabled?s(c):null]),{dotValue:b,referenceScale:g,minSliderValue:w,maxSliderValue:V}=y,D=l(u.colors,i.attributes.length),E=i.attributes.map(((e,t)=>({field:e.field,valueExpression:e.valueExpression,label:e.label,valueExpressionTitle:e.valueExpressionTitle,color:D[t]}))),T=new e({attributes:E,dotBlendingEnabled:i.dotBlendingEnabled,outline:f?o(u,d,f.opacity):null,dotValue:b,referenceScale:i.dotValueOptimizationEnabled?g:null,legendOptions:i.legendOptions});return f&&f.visualVariables&&f.visualVariables.length&&(T.visualVariables=f.visualVariables.map((e=>e.clone()))),T.authoringInfo=new a({type:"dot-density",minSliderValue:w,maxSliderValue:V}),{renderer:T,dotDensityScheme:u,basemapId:m.basemapId,basemapTheme:m.basemapTheme}}export{V as createRenderer};
