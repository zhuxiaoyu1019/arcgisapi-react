/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../../core/Error.js";import{isSome as i}from"../../core/maybe.js";import o from"../../renderers/support/AuthoringInfo.js";import a from"../../renderers/support/ClassBreakInfo.js";import s from"../../renderers/visualVariables/support/SizeStop.js";import{getSize as l}from"../../renderers/visualVariables/support/visualVariableUtils.js";import{createVisualVariable as n}from"./color.js";import{createVisualVariables as t,createContinuousRenderer as r}from"./size.js";import{verifyBasicFieldValidity as u,createStopValuesForAboveBelow as m,clampAboveAndBelowStopValues as p,createDefaultStopValues as c}from"./support/utils.js";import{getFieldsList as d}from"../support/utils.js";import{createLayerAdapter as v,getLayerTypeLabels as b}from"../support/adapters/support/layerUtils.js";import{getAboveAndBelowSymbols as f}from"../symbology/support/aboveAndBelowUtils.js";import{applyCIMSymbolColor as y}from"../../symbols/support/cimSymbolUtils.js";import w from"../../symbols/support/Symbol3DMaterial.js";const h=2**53-1;async function z(o){var a,s;if(!(o&&o.layer&&(o.field||o.valueExpression||o.sqlExpression)))throw new e("univariate-colorsize-visual-variables:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(o.valueExpression&&!o.sqlExpression&&!o.view)throw new e("univariate-colorsize-visual-variables:missing-parameters","View is required when 'valueExpression' is specified");if("above-and-below"===o.theme&&null!=(a=o.sizeOptions)&&a.sizeOptimizationEnabled)throw new e("univariate-colorsize-visual-variables:invalid-parameters","sizeOptimizationEnabled cannot be true for 'above-and-below' theme");const l={...o},n=[0,2,1,3,5],t=v(l.layer,n);if(l.layer=t,l.theme=l.theme||null!=(s=l.colorOptions)&&s.theme?l.theme:"high-to-low","90-10"===l.theme)throw new e("univariate-colorsize-visual-variables:not-supported","Only 'high-to-low', 'above-and-below', 'above', 'below' themes are supported.");if(!t)throw new e("univariate-colorsize-visual-variables:invalid-parameters","'layer' must be one of these types: "+b(n).join(", "));const r=i(l.signal)?{signal:l.signal}:null;await t.load(r);const m=await d({field:l.field,normalizationField:l.normalizationField,valueExpression:l.valueExpression}),p=u(t,m,"univariate-colorsize-visual-variables:invalid-parameters");if(p)throw p;return l}function V(e,i){var o;const a={...e},{sizeOptions:s,theme:l}=a,n=a.legendOptions||(null==(o=a.sizeOptions)?void 0:o.legendOptions);return delete a.sizeOptions,delete a.colorOptions,{...a,...s,statistics:i||a.statistics,theme:"above-and-below"===l?null:l,legendOptions:n}}function g(e,i){var o;const a={...e},s=a.colorOptions,l=a.theme||(null==s?void 0:s.theme),n=a.legendOptions||(null==(o=a.colorOptions)?void 0:o.legendOptions);return delete a.sizeOptions,delete a.colorOptions,{...a,...s,statistics:i||a.statistics,theme:l,legendOptions:n}}async function O(o){var a;if(!(o&&o.layer&&(o.field||o.valueExpression||o.sqlExpression)))throw new e("univariate-colorsize-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(o.valueExpression&&!o.sqlExpression&&!o.view)throw new e("univariate-colorsize-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");const s={...o};s.symbolType=s.symbolType||"2d",s.colorOptions||(s.colorOptions={}),s.colorOptions.isContinuous=null!=(a=s.colorOptions.isContinuous)&&a;const l=[0,2,1,3,5],n=v(s.layer,l);if(s.layer=n,!n)throw new e("univariate-colorsize-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+b(l).join(", "));const t=i(s.signal)?{signal:s.signal}:null;if(await n.load(t),"above-and-below"===s.theme&&s.symbolOptions){if(s.symbolType.indexOf("3d-volumetric")>-1)throw new e("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' is applicable for '2d' and '3d-flat' 'symbolType' only");if("point"!==n.geometryType&&"polygon"!==n.geometryType)throw new e("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' only apply to layers with 'point' or 'polygon' geometryType")}const r=await d({field:s.field,normalizationField:s.normalizationField,valueExpression:s.valueExpression}),m=u(n,r,"univariate-colorsize-continuous-renderer:invalid-parameters");if(m)throw m;return s}function x(e){const i={...e},o={...i.sizeOptions};return delete i.sizeOptions,delete i.colorOptions,delete o.sizeOptimizationEnabled,{...i,...o}}function E(e,i){if("type"in e&&"cim"===e.type)y(e,i);else if("type"in e&&e.type.indexOf("3d")>-1){e.symbolLayers.forEach((e=>{"material"in e&&"color"in e.material&&(e.material?e.material.color=i:e.material=new w({color:i}))}))}else"color"in e&&(e.color=i)}function S(e,i,o){if((null!=i&&i.symbolStyle||null!=i&&i.symbols)&&("point"===o||"polygon"===o))return i.symbols||f(i.symbolStyle);const a=e.classBreakInfos[0].symbol;return{above:a.clone(),below:a.clone()}}function j(e,i,o){var s;const l=o.symbolOptions,n=o.layer,t=null!=l&&l.symbols?"custom":null==l?void 0:l.symbolStyle,r=null==(s=o.colorOptions)?void 0:s.isContinuous;if(T(e,i,r),t||!r){const{stops:o}=i.size.visualVariables[0],{above:s,below:u}=S(e,l,n.geometryType);if(!r){const e=i.color.colorScheme.colors,o=e[0];E(s,e[e.length-1]),E(u,o)}e.classBreakInfos=[new a({minValue:-h,maxValue:o[2].value,symbol:u}),new a({minValue:o[2].value,maxValue:h,symbol:s})],t&&(e.authoringInfo.univariateSymbolStyle=t)}}function T(e,i,o=!0){var a;const s=null==i||null==(a=i.authoringInfo)?void 0:a.clone(),l=i.size.visualVariables.map((e=>e.clone()));o?l.push(i.color.visualVariable.clone()):s.visualVariables=s.visualVariables.filter((e=>"size"===e.type)),l.push(...e.visualVariables.filter((e=>"target"in e&&"outline"===e.target)).map((e=>e.clone()))),e.authoringInfo=s,e.visualVariables=l}function I(e){const i={...e},o=i.symbolType,a=o.indexOf("3d-volumetric")>-1;delete i.symbolType,delete i.defaultSymbolEnabled;const s=i;return s.worldScale=a,a&&(s.sizeOptions={...s.sizeOptions},s.sizeOptions.axis="3d-volumetric-uniform"===o?"all":"height"),s}async function q(e,i,o,a){const n=i[0],t=i[1],r=Math.round((t-n)/2)+n,u=e.clone();u.stops=[new s({value:o[0],size:t}),new s({value:o[1],size:r}),new s({value:o[2],size:n}),new s({value:o[3],size:r}),new s({value:o[4],size:t})],e.stops=[new s({value:a[0],size:l(u,a[0])}),new s({value:a[1],size:l(u,a[1])}),new s({value:a[2],size:l(u,a[2])}),new s({value:a[3],size:l(u,a[3])}),new s({value:a[4],size:l(u,a[4])})]}async function D(e,i,o,a){const s=e.filter((e=>"width-and-depth"!==e.axis&&!e.target))[0],l="number"==typeof(null==s?void 0:s.minSize)?null==s?void 0:s.minSize:null,n="number"==typeof(null==s?void 0:s.maxSize)?null==s?void 0:s.maxSize:null;if(null!=(null==s?void 0:s.minDataValue)&&null!=l&&null!=n)if(a)if("above-and-below"===a){s.minDataValue=null,s.maxDataValue=null,s.minSize=null,s.maxSize=null;const e=m(o),a=p(e,o);await q(s,[l,n],e,a),i.stops.forEach(((e,i)=>e.value=a[i]))}else{const{minDataValue:e,maxDataValue:o}=s,a=c(e,o,5);i.stops.forEach(((e,i)=>e.value=a[i])),s.minDataValue=a[0],s.maxDataValue=a[a.length-1]}else s.minDataValue=i.stops[0].value,s.maxDataValue=i.stops[i.stops.length-1].value}function U(e,i,a){const{theme:s,minValue:l,maxValue:n}=e,t=i.authoringInfo.visualVariables[0].clone(),r=a.authoringInfo.visualVariables[0].clone();if("above-and-below"===s){const e=i.visualVariable.stops;t.minSliderValue=r.minSliderValue=null!=l?l:e[0].value,t.maxSliderValue=r.maxSliderValue=null!=n?n:e[e.length-1].value,r.theme="above-and-below"}return new o({type:"univariate-color-size",univariateTheme:s,visualVariables:[t,r]})}async function C(e){const i=await z(e),o=await n(g(i)),{visualVariable:a,statistics:s}=o,l=await t(V(i,s)),r=l.visualVariables;return await D(r,a,s,i.theme),{basemapId:l.basemapId,basemapTheme:l.basemapTheme,statistics:s,defaultValuesUsed:o.defaultValuesUsed,color:{visualVariable:a,colorScheme:o.colorScheme},size:{visualVariables:r,sizeScheme:l.sizeScheme},authoringInfo:U(i,o,l)}}async function B(e){return F(e)}async function F(e){var i;const o=await O(e),{renderer:a,statistics:s,defaultValuesUsed:l}=await r(x(o)),n=I(o);n.statistics=s;const t=await C(n);return"above-and-below"===o.theme?j(a,t,o):T(a,t),{renderer:a,statistics:s,defaultValuesUsed:l,color:null!=(i=o.colorOptions)&&i.isContinuous||"above-and-below"!==o.theme?t.color:null,size:t.size,basemapId:t.basemapId,basemapTheme:t.basemapTheme}}export{B as createContinuousRenderer,F as createRenderer,C as createVisualVariables};
