/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../request.js";import r from"../core/Error.js";import{isSome as t}from"../core/maybe.js";import{getDeepValue as o}from"../core/object.js";import{removeTrailingSlash as s}from"../core/urlUtils.js";import{asValidOptions as a,parseUrl as l}from"./utils.js";import n from"./support/NetworkServiceDescription.js";import i from"./support/RouteResultsContainer.js";function u(e,r,t,o){o[t]=[r.length,r.length+e.length],e.forEach((e=>{r.push(e.geometry)}))}function p(e,r){for(let t=0;t<r.length;t++){const o=e[r[t]];if(o&&o.length)for(const e of o)e.z=void 0}console.log("The remote Network Analysis service is powered by a network dataset which is not Z-aware.\nZ-coordinates of the input geometry are ignored.")}function f(e){const r=[],t=[],{directions:o=[],routes:{features:s=[],spatialReference:a=null}={},stops:{features:l=[],spatialReference:n=null}={},barriers:u,polygonBarriers:p,polylineBarriers:f,messages:d}=e.data,c="esri.tasks.RouteTask.NULL_ROUTE_NAME";let v,m,h=!0;const T=s&&a||l&&n||u&&u.spatialReference||p&&p.spatialReference||f&&f.spatialReference;o.forEach((e=>{r.push(v=e.routeName),t[v]={directions:e}})),s.forEach((e=>{-1===r.indexOf(v=e.attributes.Name)&&(r.push(v),t[v]={}),e.geometry&&(e.geometry.spatialReference=T),t[v].route=e})),l.forEach((e=>{m=e.attributes,-1===r.indexOf(v=m.RouteName||c)&&(r.push(v),t[v]={}),v!==c&&(h=!1),e.geometry&&(e.geometry.spatialReference=T),null==t[v].stops&&(t[v].stops=[]),t[v].stops.push(e)})),l.length>0&&!0===h&&(t[r[0]].stops=t[c].stops,delete t[c],r.splice(r.indexOf(c),1));const g=r.map((e=>(t[e].routeName=e===c?null:e,t[e])));return i.fromJSON({routeResults:g,pointBarriers:u,polygonBarriers:p,polylineBarriers:f,messages:d})}function d(e,r){for(let o=0;o<r.length;o++){const s=e[r[o]];if(s&&s.length)for(const e of s)if(t(e)&&e.hasZ)return!0}return!1}async function c(t,o,s){if(!t)throw new r("network-service:missing-url","Url to Network service is missing");const l=a({f:"json",token:o},s),{data:i}=await e(t,l);i.supportedTravelModes||(i.supportedTravelModes=[]);for(let e=0;e<i.supportedTravelModes.length;e++)i.supportedTravelModes[e].id||(i.supportedTravelModes[e].id=i.supportedTravelModes[e].itemId);const u=i.currentVersion>=10.4?m(t,o,s):v(t,s),{defaultTravelMode:p,supportedTravelModes:f}=await u;return i.defaultTravelMode=p,i.supportedTravelModes=f,n.fromJSON(i)}async function v(r,t){var n,i;const u=a({f:"json"},t),{data:p}=await e(r.replace(/\/rest\/.*$/i,"/info"),u);if(!p||!p.owningSystemUrl)return{supportedTravelModes:[],defaultTravelMode:null};const{owningSystemUrl:f}=p,d=s(f)+"/sharing/rest/portals/self",{data:c}=await e(d,u),v=o("helperServices.routingUtilities.url",c);if(!v)return{supportedTravelModes:[],defaultTravelMode:null};const m=l(f),h=/\/solve$/i.test(m.path)?"Route":/\/solveclosestfacility$/i.test(m.path)?"ClosestFacility":"ServiceAreas",T=a({f:"json",serviceName:h},t),g=s(v)+"/GetTravelModes/execute",M=await e(g,T),w=[];let y=null;if(null!=M&&null!=(n=M.data)&&null!=(i=n.results)&&i.length){const e=M.data.results;for(const r of e){var N;if("supportedTravelModes"===r.paramName){if(null!=(N=r.value)&&N.features)for(const{attributes:e}of r.value.features)if(e){const r=JSON.parse(e.TravelMode);w.push(r)}}else"defaultTravelMode"===r.paramName&&(y=r.value)}}return{supportedTravelModes:w,defaultTravelMode:y}}async function m(t,o,l){try{const r=a({f:"json",token:o},l),n=s(t)+"/retrieveTravelModes",{data:{supportedTravelModes:i,defaultTravelMode:u}}=await e(n,r);return{supportedTravelModes:i,defaultTravelMode:u}}catch(n){throw new r("network-service:retrieveTravelModes","Could not get to the NAServer's retrieveTravelModes.",{error:n})}}export{u as collectGeometries,p as dropZValuesOffInputGeometry,c as fetchServiceDescription,f as handleSolveResponse,d as isInputGeometryZAware};
