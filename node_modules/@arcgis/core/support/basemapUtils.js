/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../Basemap.js";import r from"../core/Collection.js";import n from"../core/Logger.js";import{normalize as t,Url as a,makeAbsolute as l}from"../core/urlUtils.js";import{ensureType as s}from"../core/accessorSupport/ensureType.js";import{esriBasemapDefinitions as i}from"./basemapDefinitions.js";const o=n.getLogger("esri.support.basemapUtils");function c(){return{}}function u(e){for(const r in e){const n=e[r];!1===(null==n?void 0:n.destroyed)&&n.destroy(),delete e[r]}}function f(r,n){var t;let a;if("string"==typeof r){if(!(r in i)){const e=Object.keys(i).map((e=>`"${e}"`)).join(", ");return o.warn(`Unable to find basemap definition for: ${r}. Try one of these: ${e}`),null}n&&(a=n[r]),a||(a=e.fromId(r),n&&(n[r]=a))}else a=s(e,r);return null!=(t=a)&&t.destroyed&&(o.warn("The provided basemap is already destroyed",{basemap:a}),a=null),a}function y(r,n=null){const t=f(r);if(!t)return null;const a=new e({id:t.id,title:t.title,baseLayers:t.baseLayers.slice(),referenceLayers:t.referenceLayers.slice()});return n&&(a.baseLayers=b(a.baseLayers,n.baseLayers),a.referenceLayers=b(a.referenceLayers,n.referenceLayers)),a.load().catch((()=>{})),a.portalItem=t.portalItem,a}function m(e){let r=null;const n=v(e),t=!n.baseLayers.length;for(const a in i){const e=w(n,x(i[a]),{mustMatchReferences:t});if("equal"===e){r=a;break}"base-layers-equal"===e&&(r=a)}return r}function p(e,r){if(e===r)return!0;return"equal"===w(v(e),v(r),{mustMatchReferences:!0})}function b(e,n){const t=new r;return e.forEach((e=>{const r=n.find((r=>I(g(e),g(r))))||e;t.some((e=>e===r))?t.push(e):t.push(r)})),t}function L(e){return!(null==e||!e.baseLayers.concat(e.referenceLayers).some(d))}function d(e){if(h(e.url))return!0;if("vector-tile"===e.type)for(const r in e.sourceNameToSource){const n=e.sourceNameToSource[r];if(h(null==n?void 0:n.sourceUrl))return!0}return!1}const S=/^(basemaps|ibasemaps).*-api\.arcgis\.com$/i;function h(e){if(!e)return!1;const r=new a(l(e));return S.test(r.authority)}function v(e){return e?!e.loaded&&e.resourceInfo?x(e.resourceInfo.data):{baseLayers:T(e.baseLayers),referenceLayers:T(e.referenceLayers)}:null}function T(e){return(r.isCollection(e)?e.toArray():e).map(g)}function g(e){return{type:e.type,url:M("urlTemplate"in e&&e.urlTemplate||e.url||"styleUrl"in e&&e.styleUrl),minScale:"minScale"in e&&null!=e.minScale?e.minScale:0,maxScale:"maxScale"in e&&null!=e.maxScale?e.maxScale:0,opacity:null!=e.opacity?e.opacity:1,visible:null==e.visible||!!e.visible}}function x(e){return e?{baseLayers:q(e.baseMapLayers.filter((e=>!e.isReference))),referenceLayers:q(e.baseMapLayers.filter((e=>e.isReference)))}:null}function q(e){return e.map((e=>j(e)))}function j(e){let r;switch(e.layerType){case"VectorTileLayer":r="vector-tile";break;case"ArcGISTiledMapServiceLayer":r="tile";break;default:r="unknown"}return{type:r,url:M(e.templateUrl||e.urlTemplate||e.styleUrl||e.url),minScale:null!=e.minScale?e.minScale:0,maxScale:null!=e.maxScale?e.maxScale:0,opacity:null!=e.opacity?e.opacity:1,visible:null==e.visibility||!!e.visibility}}function w(e,r,n){if(null!=e!=(null!=r))return"not-equal";if(!e)return"equal";if(!U(e.baseLayers,r.baseLayers))return"not-equal";return U(e.referenceLayers,r.referenceLayers)?"equal":n.mustMatchReferences?"not-equal":"base-layers-equal"}function U(e,r){if(e.length!==r.length)return!1;for(let n=0;n<e.length;n++)if(!I(e[n],r[n]))return!1;return!0}function I(e,r){return e.type===r.type&&e.url===r.url&&e.minScale===r.minScale&&e.maxScale===r.maxScale&&e.visible===r.visible&&e.opacity===r.opacity}function M(e){return e?t(e).replace(/^\s*https?:/i,"").toLowerCase():""}export{y as clonePreservingTiledLayers,p as contentEquals,c as createCache,u as destroyCache,f as ensureType,m as getWellKnownBasemapId,L as hasDeveloperBasemapLayer,d as isDeveloperBasemapLayer};
